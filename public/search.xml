<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ã€Œ18ã€GPM åˆè¯†/è®¾è®¡</title>
    <url>/archives/b885f9f7.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å­¦goæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œæœ€è¿‘æ€»æ„Ÿè§‰å¿™ç¢Œæ— ä¸ºï¼Œä¹Ÿè¯¥æ€»ç»“ä¸‹å‰æ®µæ—¶é—´è¯»æºç çš„ä¸€äº›å¿ƒå¾—å’Œä½“ä¼šäº†ã€‚</p>
<p>GPMè°ƒåº¦ç®—æ˜¯åœ¨Goä¸­æ¯”è¾ƒç»å…¸çš„äº†ï¼Œæœ‰å¿…è¦æ·±å…¥å­¦ä¹ ä¸‹ã€‚</p>
<blockquote>
<p><a href="https://golang.org/s/go11sched">Go GPMè®¾è®¡æ–‡æ¡£</a></p>
</blockquote>
<h3 id="GPMè®¾è®¡çš„ç”±æ¥"><a class="header-anchor" href="#GPMè®¾è®¡çš„ç”±æ¥">Â¶</a>GPMè®¾è®¡çš„ç”±æ¥</h3>
<p>ä¸€ä¸ªå¥½çš„è®¾è®¡ï¼Œæ€»ä¼šä¼´éšå‘ç°ç°æœ‰çš„é—®é¢˜ï¼Œåœ¨è§£å†³çš„åŸºç¡€ä¸Šè€ƒè™‘åœºæ™¯å¹¶æé«˜æ‰©å±•æ€§ï¼Œå…ˆæ¥äº†è§£ä¸‹Goä¸ºä½•è¦é‡æ–°è®¾è®¡GPMè¿™ä¸ªæ¨¡å‹ï¼š</p>
<a id="more"></a>
<h4 id="ç°æœ‰çš„é—®é¢˜ï¼š"><a class="header-anchor" href="#ç°æœ‰çš„é—®é¢˜ï¼š">Â¶</a>ç°æœ‰çš„é—®é¢˜ï¼š</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. Single global mutex (Sched.Lock) and centralized state. The mutex protects all goroutine-related operations (creation, completion, rescheduling, etc).</span><br><span class="line">2. Goroutine (G) hand-off (G.nextg). Worker threads (M&#39;s) frequently hand-off runnable goroutines between each other, this may lead to increased latencies and additional overheads. Every M must be able to execute any runnable G, in particular the M that just created the G.</span><br><span class="line">3. Per-M memory cache (M.mcache). Memory cache and other caches (stack alloc) are associated with all M&#39;s, while they need to be associated only with M&#39;s running Go code (an M blocked inside of syscall does not need mcache). A ratio between M&#39;s running Go code and all M&#39;s can be as high as 1:100. This leads to excessive resource consumption (each MCache can suck up up to 2M) and poor data locality.</span><br><span class="line">4. Aggressive thread blocking&#x2F;unblocking. In presence of syscalls worker threads are frequently blocked and unblocked. This adds a lot of overhead.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€å•ä¸€çš„å…¨å±€é”å’Œé›†ä¸­çš„çŠ¶æ€.æ­¤é”æ‰€æœ‰gçš„æ“ä½œã€‚</span><br><span class="line">2ã€gé€€å‡ºã€‚å·¥ä½œä¸­çš„Mé¢‘ç¹çš„äº¤å‡ºæ­£åœ¨runningçš„gï¼Œå¯¼è‡´å»¶è¿Ÿå¢åŠ å’Œé¢å¤–çš„è´Ÿè½½ã€‚æ¯ä¸ªMæ‰§è¡Œä»»ä½•gï¼Œå°¤å…¶æ˜¯Mè‡ªèº«åˆ›å»ºçš„gã€‚</span><br><span class="line">3ã€Mçš„å†…å­˜ç¼“å­˜é—®é¢˜ã€‚   å†…å­˜ç¼“å­˜å’Œå…¶å®ƒçš„ç¼“å­˜å…³è”è¿™æ‰€æœ‰çš„Mï¼Œå½“ä»–ä»¬éœ€è¦å…³è”Mæ¥running codeæ—¶ã€‚æ¯”ç‡æ˜¾ç¤ºMè¿è¡Œçš„codeå’Œæ‰€æœ‰Mçš„å‘ˆ1:100ã€‚å¯¼è‡´å¾ˆå¤šèµ„æºçš„æµªè´¹å’Œå†…å­˜çš„è´«ç˜ ã€‚</span><br><span class="line">4ã€ä¾µç•¥æ€§çš„åŠ é”ï¼Œåœ¨ç³»ç»Ÿçº¿ç¨‹é¢‘ç¹çš„åŠ é”å’Œè§£é”ã€‚è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„è´Ÿè½½ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="è®¾è®¡æ”¹å˜"><a class="header-anchor" href="#è®¾è®¡æ”¹å˜">Â¶</a>è®¾è®¡æ”¹å˜</h3>
<blockquote>
<p>ä»¥å‰çš„è®¾è®¡ï¼š<br>
<img src="https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-1.png" alt=""></p>
</blockquote>
<blockquote>
<p>æ–°å¢Processor</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-2.png" alt=""></p>
<h3 id="å®ç°è®¡åˆ’"><a class="header-anchor" href="#å®ç°è®¡åˆ’">Â¶</a>å®ç°è®¡åˆ’</h3>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. Introduce the P struct (empty for now); implement allp&#x2F;idlep containers (idlep is mutex-protected for starters); associate a P with M running Go code. Global mutex and atomic state is still preserved.</span><br><span class="line">2. Move G freelist to P.</span><br><span class="line">3. Move mcache to P.</span><br><span class="line">4. Move stackalloc to P.</span><br><span class="line">5. Move ncgocall&#x2F;gcstats to P.</span><br><span class="line">&#x2F;&#x2F; work-stealå·¥ä½œçªƒå–æ¨¡å¼,ä»ç„¶åœ¨å…¨å±€é”ä¸‹ã€‚</span><br><span class="line">6. Decentralize run queue, implement work-stealing. Eliminate G hand off. Still under global mutex.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç§»é™¤å…¨å±€é”ï¼Œå®ç°åˆ†æ•£çš„æ£€æµ‹ã€‚</span><br><span class="line">7. Remove global mutex, implement distributed termination detection, LockOSThread.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å®ç°è‡ªæ—‹æ›¿ä»£æç¤ºé”ã€Œæ™®é€šé”ã€ã€‚</span><br><span class="line">8. Implement spinning instead of prompt blocking&#x2F;unblocking.</span><br><span class="line">The plan may turn out to not work, there are a lot of unexplored details.</span><br></pre></td></tr></table></figure>
<h3 id="Potential-Improvement"><a class="header-anchor" href="#Potential-Improvement">Â¶</a>Potential Improvement</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># åè¿›å…ˆå‡ºè®¡åˆ’ã€‚æä¾›å…¬å¹³å’Œä¼˜é›…çš„å¤„ç†gã€‚</span><br><span class="line">1. Try out LIFO scheduling, this will improve locality. However, it still must provide some degree of fairness and gracefully handle yielding goroutines.</span><br><span class="line"></span><br><span class="line"># ä¸åˆ†é…å†…å­˜å’Œæ ˆç©ºé—´ï¼Œç›´åˆ°gè·‘èµ·æ¥ã€‚å¯¹äºä¸€ä¸ªæ–°åˆ›å»ºçš„gï¼Œéœ€è¦ä¸‹é¢å‡ ä¸ªå‡½æ•°ã€‚ è¿™å°†åˆ›å»ºtoå®Œæˆä¼´éšç€è¾ƒä½å†…å­˜çš„è´Ÿè½½ã€‚</span><br><span class="line">2. Do not allocate G and stack until the goroutine first runs. For a newly created goroutine we need just callerpc, fn, narg, nret and args, that is, about 6 words. This will allow to create a lot of running-to-completion goroutines with significantly lower memory overhead.</span><br><span class="line"></span><br><span class="line"># æ›´å¥½çš„G-Pã€‚å°è¯•å…¥é˜Ÿæœªé”å®šçš„Gåˆ°Pï¼Œä»ä¸Šä¸€æ¬¡è¿è¡Œã€‚</span><br><span class="line">4. Better locality of G-to-P. Try to enqueue an unblocked G to a P on which it was last running.</span><br><span class="line"></span><br><span class="line"># æ›´å¥½çš„P-Mã€‚å°è¯•æ‰§è¡Œpï¼Œåœ¨åŒæ ·çš„Mæœ€åä¸€æ¬¡è¿è¡Œã€‚</span><br><span class="line">5. Better locality of P-to-M. Try to execute P on the same M it was last running.</span><br><span class="line"></span><br><span class="line"># Mé™æµåˆ›å»ºã€‚è°ƒåº¦å™¨åˆ›å»ºä¸Šåƒå“¥Måœ¨æ¯«ç§’ä¹‹é—´ï¼Œç›´åˆ°OSæ‹’ç»åˆ›å»ºæ›´å¤šçš„threadã€‚Må¿…é¡»ç«‹åˆ»åˆ›å»ºï¼Œæœ€å¤šåˆ›å»ºk*GOMAXPROCS,åç»­æ–°çš„Mä¼šé€šè¿‡å®šæ—¶å™¨åˆ›å»ºã€‚</span><br><span class="line">6. Throttling of M creation. The scheduler can be easily forced to create thousands of M&#39;s per second until OS refuses to create more threads. Mâ€™s must be created promptly up to k*GOMAXPROCS, after that new Mâ€™s may added by a timer.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒï¼š"><a class="header-anchor" href="#å‚è€ƒï¼š">Â¶</a>å‚è€ƒï¼š</h3>
<ul>
<li>
<p><a href="https://golang.org/s/go11scheds">GPM g11è®¾è®¡æ–‡æ¡£</a></p>
</li>
<li>
<p><a href="http://supertech.csail.mit.edu/papers/steal.pdf">work stealæ¨¡å¼</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ33ã€Float IEEEæ ‡å‡†</title>
    <url>/archives/257c4ce2.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å‰å‡ å¤©è¸©å‘Floatç±»å‹çš„è®¡ç®—é—®é¢˜,ä»Šå¤©æ¥ç³»ç»Ÿçš„æ€»ç»“ä¸‹floatç›¸å…³çš„çŸ¥è¯†ç‚¹.</p>
<h3 id="æŒæ¡å…³é”®ç‚¹"><a class="header-anchor" href="#æŒæ¡å…³é”®ç‚¹">Â¶</a>æŒæ¡å…³é”®ç‚¹:</h3>
<ul>
<li>floatçš„æ ‡å‡†æ˜¯ä»€ä¹ˆ?</li>
<li>floatçš„ä½è®¡ç®—è§„åˆ™</li>
<li>floatåœºæ™¯</li>
<li>floatè®¡ç®—æ”¹è¿›</li>
</ul>
<a id="more"></a>
<h3 id="Floatçš„æ ‡å‡†"><a class="header-anchor" href="#Floatçš„æ ‡å‡†">Â¶</a>Floatçš„æ ‡å‡†?</h3>
<h4 id="å›½é™…ç»„ç»‡å®šä¹‰"><a class="header-anchor" href="#å›½é™…ç»„ç»‡å®šä¹‰">Â¶</a>å›½é™…ç»„ç»‡å®šä¹‰</h4>
<p><a href="https://zh.wikipedia.org/wiki/IEEE_754">wikiâ€“&gt;floatå®šä¹‰</a></p>
<h4 id="è¡¨ç¤ºæ–¹æ³•"><a class="header-anchor" href="#è¡¨ç¤ºæ–¹æ³•">Â¶</a>è¡¨ç¤ºæ–¹æ³•</h4>
<p style=""><img src="https://math.now.sh?from=value%20%3D%20%20sign%20*%20exponent%20*%20fraction%20%0A" /></p><ul>
<li>value: å®é™…å€¼</li>
<li>sign bit: ç¬¦å·ä½</li>
<li>exponent bit: æŒ‡æ•°ä¾¿å®œä½</li>
<li>fraction: åˆ†æ•°å€¼</li>
</ul>
<p>å…·ä½“è¡¨ç¤º:</p>
<p><img src="https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_104959.webp" alt=""></p>
<h4 id="å•ç²¾åº¦å’ŒåŒç²¾åº¦"><a class="header-anchor" href="#å•ç²¾åº¦å’ŒåŒç²¾åº¦">Â¶</a>å•ç²¾åº¦å’ŒåŒç²¾åº¦</h4>
<p><img src="https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_110116.png" alt=""></p>
<h4 id="ç‰¹æ®Šå€¼"><a class="header-anchor" href="#ç‰¹æ®Šå€¼">Â¶</a>ç‰¹æ®Šå€¼:</h4>
<ul>
<li>æ— ç©·: Inf</li>
<li>éæ•°å€¼: NaN</li>
</ul>
<h3 id="Floatä½è®¡ç®—è§„åˆ™"><a class="header-anchor" href="#Floatä½è®¡ç®—è§„åˆ™">Â¶</a>Floatä½è®¡ç®—è§„åˆ™</h3>
<h4 id="åŸç "><a class="header-anchor" href="#åŸç ">Â¶</a>åŸç </h4>
<ul>
<li>é«˜ä½è¡¨ç¤ºç¬¦å·ä½,å…¶ä½™ä¸ºå€¼; âš ï¸:ä¸èƒ½ç›´æ¥å‚ä¸è®¡ç®—</li>
</ul>
<h4 id="åç "><a class="header-anchor" href="#åç ">Â¶</a>åç </h4>
<ul>
<li>æ­£æ•°åç ä¸ºæœ¬èº«</li>
<li>è´Ÿæ•°ä¿ç•™ç¬¦å·ä½,å…¶å®ƒä½æŒ‰ä½å–å.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä¾‹å¦‚ :</span><br><span class="line">[+7]åŸ &#x3D; 00000111 [+7]å &#x3D; 00000111 </span><br><span class="line">[-7]åŸ &#x3D; 10000111 [-7]å &#x3D; 11111000</span><br></pre></td></tr></table></figure>
<h4 id="è¡¥ç "><a class="header-anchor" href="#è¡¥ç ">Â¶</a>è¡¥ç </h4>
<ul>
<li>æ­£æ•°çš„è¡¥ç ==åŸç ==è¡¥ç </li>
<li>è´Ÿæ•°è¡¥ç =åç +1</li>
</ul>
<h4 id="è®¡ç®—å½¢å¼"><a class="header-anchor" href="#è®¡ç®—å½¢å¼">Â¶</a>è®¡ç®—å½¢å¼:</h4>
<p style=""><img src="https://math.now.sh?from=v%20%3D%20%28-1%29%5Es%20*%20M%20*%202%5EE%20%0A" /></p><h5 id="è¯´æ˜"><a class="header-anchor" href="#è¯´æ˜">Â¶</a>è¯´æ˜:</h5>
<ul>
<li><img src="https://math.now.sh?inline=%28-1%29%5Es" style="display:inline-block;margin: 0;"/>è¡¨ç¤ºç¬¦å·ä½</li>
<li>Mè¡¨ç¤ºæœ‰æ•ˆæ•°å­—</li>
<li><img src="https://math.now.sh?inline=2%5EE" style="display:inline-block;margin: 0;"/>è¡¨ç¤ºæŒ‡æ•°ä½</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">eg:</span><br><span class="line"><span class="number">-0.5</span> =&gt; <span class="number">-0.1</span>[äºŒè¿›åˆ¶]</span><br><span class="line">=&gt; <span class="number">-1.0</span> * <span class="number">2</span>^<span class="number">-1</span></span><br><span class="line">=&gt; (<span class="number">-1</span>)^<span class="number">1</span> * <span class="number">1.0</span> * <span class="number">2</span>^<span class="number">-1</span></span><br><span class="line">=&gt; s=<span class="number">1</span>ï¼ŒM=<span class="number">1.0</span>ï¼ŒE=<span class="number">-1</span></span><br></pre></td></tr></table></figure>
<h4 id="floatç±»å‹çš„åŠ æ³•"><a class="header-anchor" href="#floatç±»å‹çš„åŠ æ³•">Â¶</a>floatç±»å‹çš„åŠ æ³•:</h4>
<ul>
<li>å¯¹é˜¶</li>
<li>å°¾æ•°</li>
<li>è§„æ ¼åŒ–</li>
<li>èˆå…¥å¤„ç†</li>
<li>æº¢å‡ºåˆ¤æ–­</li>
</ul>
<h4 id="0-3-1-6"><a class="header-anchor" href="#0-3-1-6">Â¶</a><img src="https://math.now.sh?inline=0.3%2B1.6%3D%3F" style="display:inline-block;margin: 0;"/></h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a&#x3D;(0.3)10&#x3D;(0011 1110 1001 1001 1001 1001 1001 1010)2    Sa&#x3D;0    Ea&#x3D;011 1110 1    Ma&#x3D;1.001 1001 1001 1001 1001 1010</span><br><span class="line"></span><br><span class="line">b&#x3D;(1.6)10&#x3D;(0011 1111 1100 1100 1100 1100 1100 1101)2      Sb&#x3D;0    Eb&#x3D;011 1111 1     Mb&#x3D;1.100 1100 1100 1100 1100 1101</span><br></pre></td></tr></table></figure>
<h5 id="å¯¹é˜¶"><a class="header-anchor" href="#å¯¹é˜¶">Â¶</a>å¯¹é˜¶</h5>
<blockquote>
<p>ç®€å•çš„è¯´å°±æ˜¯éœ€è¦é˜¶ç å¯¹é½,ä½¿å…¶å°¾æ•°å¯ä»¥è¿›è¡ŒåŠ å‡è¿ç®—,å³:</p>
</blockquote>
<p>$ âŠ¿E = E_b -E_a $</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">Ea&lt;Eb   Eb-Ea=<span class="number">2</span></span><br><span class="line"></span><br><span class="line">Maè¦è°ƒæ•´ä¸º <span class="number">0.0</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">10</span>       <span class="number">10</span></span><br><span class="line"></span><br><span class="line">E=<span class="number">011</span> <span class="number">1111</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h5 id="å°¾æ•°"><a class="header-anchor" href="#å°¾æ•°">Â¶</a>å°¾æ•°</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="number">0.01001100110011001100110</span></span><br><span class="line">+ <span class="number">1.10011001100110011001101</span></span><br><span class="line">----------------------------</span><br><span class="line">  <span class="number">1.11100110011001100110011</span></span><br></pre></td></tr></table></figure>
<h5 id="è§„æ ¼åŒ–"><a class="header-anchor" href="#è§„æ ¼åŒ–">Â¶</a>è§„æ ¼åŒ–</h5>
<p>å°¾æ•°çš„æ ¼å¼ $ 1.M $,å°¾æ•°å¯èƒ½æ˜¯éè§„æ ¼åŒ–çš„,æ‰€ä»¥éœ€è¦å·¦è§„å’Œå³è§„æ“ä½œ:</p>
<ul>
<li>å·¦è§„æ“ä½œ: å°¾æ•°å·¦ç§»,é˜¶ç å‡å€¼</li>
<li>å³è§„æ“ä½œ: å°¾æ•°å³ç§»,é˜¶ç +å€¼</li>
</ul>
<p>$ ç›®çš„: 1 \leq M &lt; 2 $</p>
<ul>
<li><input type="checkbox" id="checkbox0" checked="true"><label for="checkbox0">1.11100110011001100110011â€¬</label></li>
</ul>
<h5 id="èˆå…¥å¤„ç†"><a class="header-anchor" href="#èˆå…¥å¤„ç†">Â¶</a>èˆå…¥å¤„ç†</h5>
<blockquote>
<p>å››ç§èˆå…¥æ–¹å¼:</p>
</blockquote>
<ul>
<li>å°±è¿‘èˆå…¥: å››èˆäº”å…¥</li>
<li>æœ+âˆèˆå…¥</li>
<li>æœ-âˆèˆå…¥</li>
<li>æœ0èˆå…¥</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">åœ¨å¯¹é˜¶æ—¶ï¼ŒMaæœ‰å³ç§»ï¼Œä¸”ç¬¬ä¸€æ¬¡æœ€é«˜ä¸º<span class="number">1</span>ï¼Œç¬¬äºŒæ¬¡ä¸º<span class="number">0</span>ï¼Œ</span><br><span class="line">æ‰€ä»¥æŒ‰<span class="string">&quot;0èˆ1å…¥&quot;</span>ï¼Œ ==&gt; ç²¾åº¦ä¸¢å¤±çš„å…³é”®, </span><br><span class="line">å°¾æ•°è¿ç®—ç»“æœè°ƒæ•´ä¸º <span class="number">1.11100110011001100110100</span></span><br></pre></td></tr></table></figure>
<h5 id="æº¢å‡ºåˆ¤æ–­"><a class="header-anchor" href="#æº¢å‡ºåˆ¤æ–­">Â¶</a>æº¢å‡ºåˆ¤æ–­</h5>
<blockquote>
<p>åˆ¤æ–­ç»“æœæ ‡å‡†: è¿ç®—ç»“æœçš„é˜¶ç </p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">a+b=(<span class="number">0</span>  <span class="number">01111111</span>  <span class="number">11100110011001100110100</span>)<span class="number">2</span></span><br><span class="line">=(<span class="number">0011</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">0011</span> <span class="number">0011</span> <span class="number">0011</span> <span class="number">0011</span> <span class="number">0100</span>)<span class="number">2</span>=(<span class="number">3</span>FF33334)<span class="number">16</span></span><br><span class="line"></span><br><span class="line">è½¬ä¸º<span class="number">10</span>è¿›åˆ¶</span><br><span class="line"></span><br><span class="line">a+b=<span class="number">1.90000010</span></span><br></pre></td></tr></table></figure>
<h3 id="floatè®¡ç®—æ”¹è¿›"><a class="header-anchor" href="#floatè®¡ç®—æ”¹è¿›">Â¶</a>floatè®¡ç®—æ”¹è¿›</h3>
<h4 id="å°½é‡é¿å…ä½¿ç”¨é«˜ç²¾åº¦ä¸”é‡è¦çš„æ•°æ®è®¡ç®—-å¦‚-Â¥"><a class="header-anchor" href="#å°½é‡é¿å…ä½¿ç”¨é«˜ç²¾åº¦ä¸”é‡è¦çš„æ•°æ®è®¡ç®—-å¦‚-Â¥">Â¶</a>å°½é‡é¿å…ä½¿ç”¨é«˜ç²¾åº¦ä¸”é‡è¦çš„æ•°æ®è®¡ç®—: å¦‚: Â¥</h4>
<h4 id="ç»Ÿä¸€å–èˆä½æ•°"><a class="header-anchor" href="#ç»Ÿä¸€å–èˆä½æ•°">Â¶</a>ç»Ÿä¸€å–èˆä½æ•°</h4>
<ul>
<li>ç»Ÿä¸€ä¿ç•™</li>
<li>ç»Ÿä¸€å–èˆç®—æ³•</li>
</ul>
<h4 id="å»ºè®®ç”¨int-stringç±»å‹"><a class="header-anchor" href="#å»ºè®®ç”¨int-stringç±»å‹">Â¶</a>å»ºè®®ç”¨int/stringç±»å‹</h4>
<ul>
<li>ç¼ºç‚¹:
<ul>
<li>ç‰ºç‰²æ€§èƒ½</li>
<li>è½¬æ¢å¤æ‚</li>
</ul>
</li>
<li>ä¼˜ç‚¹:
<ul>
<li>æé«˜å‡†ç¡®åº¦</li>
<li>å¤„ç†å¯å¤šå…ƒåŒ–</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Float</tag>
        <tag>IEEE</tag>
        <tag>ä½è¿ç®—</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ32ã€Go  Ticker å†…å­˜æ³„éœ²</title>
    <url>/archives/53e1932f.html</url>
    <content><![CDATA[<h3 id="å‰åºï¼š"><a class="header-anchor" href="#å‰åºï¼š">Â¶</a>å‰åºï¼š</h3>
<p>ä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰ç»å†è¿‡è¿™ç§æƒ…å†µï¼š</p>
<blockquote>
<p>æµ‹è¯•ç¤ºä¾‹å›¾ç‰‡ï¼š</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp" alt=""></p>
<a id="more"></a>
<blockquote>
<p>è¯´çš„ç®€å•ç‚¹ï¼šå†…å­˜ç‚¸äº†å‘—â€¦OOM</p>
</blockquote>
<h3 id="å¼•è¨€"><a class="header-anchor" href="#å¼•è¨€">Â¶</a>å¼•è¨€</h3>
<blockquote>
<p>go version go1.14.14 darwin/amd64</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">æœ€è¿‘çš„å‘æ˜¯çœŸçš„å¤šï¼Œå½“ç„¶è¿™ç§å‘åœ¨å¤§é¡¹ç›®ä¸­ï¼Œä¸€ä¸å°å¿ƒå°±å†™å‡ºæ¥äº†,</span><br><span class="line"></span><br><span class="line">äººå¤šï¼Œé¡¹ç›®å¤§ï¼Œå„ç§å„æ ·çš„èŠ±å¼æ“ä½œéƒ½å‡ºæ¥äº†,åœ¨æ‰€éš¾å…ï¼Œ</span><br><span class="line">èƒ½åšçš„å°±æ˜¯åˆ†æé—®é¢˜ï¼Œæ€»ç»“ï¼Œè®°å½•ï¼Œé˜²æ­¢ä¸‹æ¬¡è‡ªå·±çŠ¯é”™ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åŠ æ·±ç†è§£ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="èµ·å› ï¼š"><a class="header-anchor" href="#èµ·å› ï¼š">Â¶</a>èµ·å› ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">XXX</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡ä»£ç  å‡ åè¡Œ...</span></span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">100000</span>;i++&#123;</span><br><span class="line">	    ticker := time.NewTicker(<span class="number">10</span> * time.Second)</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">//æ¨¡æ‹Ÿä¸šåŠ¡ä»£ç </span></span><br><span class="line">			fmt.Println(<span class="string">&quot;defer close&quot;</span>)</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span> &#123;</span><br><span class="line">                <span class="keyword">select</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">                <span class="comment">// ä¸šåŠ¡ä»£ç .....</span></span><br><span class="line">                    fmt.Println(<span class="string">&quot;time 5&quot;</span>)</span><br><span class="line">                <span class="keyword">case</span> &lt;-doneChan:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡ä»£ç  å‡ åè¡Œ...</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ">Â¶</a>å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h4>
<blockquote>
<p>ä¸Šé¢çš„ä»£ç ï¼Œä¸æ™“å¾—çœ‹å‡ºæ¥ä»€ä¹ˆé—®é¢˜äº†ä¹ˆâ€¦</p>
</blockquote>
<h3 id="å…³é”®ç‚¹ï¼š"><a class="header-anchor" href="#å…³é”®ç‚¹ï¼š">Â¶</a>å…³é”®ç‚¹ï¼š</h3>
<p>tickeræ²¡æœ‰stop</p>
<p><a href="https://github.com/golang/go/blob/master/src/time/tick.go#L62">å®˜æ–¹è§£é‡Š</a></p>
<h4 id="Tickerä¸èƒ½è¢«å›æ”¶å¯¼è‡´"><a class="header-anchor" href="#Tickerä¸èƒ½è¢«å›æ”¶å¯¼è‡´">Â¶</a>Tickerä¸èƒ½è¢«å›æ”¶å¯¼è‡´</h4>
<p><img src="https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_053201.webp" alt=""></p>
<h4 id="ä¸ºä½•ä¸èƒ½è¢«å›æ”¶ï¼Ÿ"><a class="header-anchor" href="#ä¸ºä½•ä¸èƒ½è¢«å›æ”¶ï¼Ÿ">Â¶</a>ä¸ºä½•ä¸èƒ½è¢«å›æ”¶ï¼Ÿ</h4>
<h5 id="NewTickerå®ç°ï¼š"><a class="header-anchor" href="#NewTickerå®ç°ï¼š">Â¶</a>NewTickerå®ç°ï¼š</h5>
<p><a href="https://github.com/golang/go/blob/master/src/time/tick.go#L39">NewTickerå®˜æ–¹å®ç°</a></p>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203">startTimeråº•å±‚å®ç°</a></p>
<h6 id="addtimer"><a class="header-anchor" href="#addtimer">Â¶</a>addtimer</h6>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// addtimer adds a timer to the current P.</span></span><br><span class="line"><span class="comment">// This should only be called with a newly created timer.</span></span><br><span class="line"><span class="comment">// That avoids the risk of changing the when field of a timer in some P&#x27;s heap,</span></span><br><span class="line"><span class="comment">// which could cause the heap to become unsorted.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addtimer</span><span class="params">(t *timer)</span></span> &#123;</span><br><span class="line">	<span class="comment">// when must never be negative; otherwise runtimer will overflow</span></span><br><span class="line">	<span class="comment">// during its delta calculation and never expire other runtime timers.</span></span><br><span class="line">	<span class="keyword">if</span> t.when &lt; <span class="number">0</span> &#123;</span><br><span class="line">		t.when = maxWhen</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> t.status != timerNoStatus &#123;</span><br><span class="line">		throw(<span class="string">&quot;addtimer called with initialized timer&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.status = timerWaiting</span><br><span class="line"></span><br><span class="line">	when := t.when</span><br><span class="line"></span><br><span class="line">	pp := getg().m.p.ptr() <span class="comment">// è·å–å½“å‰çš„P</span></span><br><span class="line">	lock(&amp;pp.timersLock) <span class="comment">// åŠ é”</span></span><br><span class="line">	cleantimers(pp) <span class="comment">// è°ƒæ•´p.timersæ ˆé¡¶å…ƒç´ </span></span><br><span class="line">	doaddtimer(pp, t) <span class="comment">// tç»‘å®šä¸‹p</span></span><br><span class="line">	unlock(&amp;pp.timersLock) </span><br><span class="line"></span><br><span class="line">	wakeNetPoller(when)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="doaddtimer"><a class="header-anchor" href="#doaddtimer">Â¶</a>doaddtimer</h6>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// doaddtimer adds t to the current P&#x27;s heap.</span></span><br><span class="line"><span class="comment">// The caller must have locked the timers for pp.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doaddtimer</span><span class="params">(pp *p, t *timer)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Timers rely on the network poller, so make sure the poller</span></span><br><span class="line">	<span class="comment">// has started.</span></span><br><span class="line">	<span class="keyword">if</span> netpollInited == <span class="number">0</span> &#123;</span><br><span class="line">		netpollGenericInit()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> t.pp != <span class="number">0</span> &#123;</span><br><span class="line">		throw(<span class="string">&quot;doaddtimer: P already set in timer&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.pp.set(pp)</span><br><span class="line">	i := <span class="built_in">len</span>(pp.timers)</span><br><span class="line">	pp.timers = <span class="built_in">append</span>(pp.timers, t) <span class="comment">// pä¸Šæ·»åŠ ä¸€ä¸ªtimer</span></span><br><span class="line">	siftupTimer(pp.timers, i) <span class="comment">// å †è°ƒæ•´ç®—æ³•</span></span><br><span class="line">	<span class="keyword">if</span> t == pp.timers[<span class="number">0</span>] &#123;</span><br><span class="line">		atomic.Store64(&amp;pp.timer0When, <span class="keyword">uint64</span>(t.when))</span><br><span class="line">	&#125;</span><br><span class="line">	atomic.Xadd(&amp;pp.numTimers, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‹“å±•ï¼š"><a class="header-anchor" href="#æ‹“å±•ï¼š">Â¶</a>æ‹“å±•ï¼š</h3>
<h4 id="cleantimersè¿‡ç¨‹ï¼š"><a class="header-anchor" href="#cleantimersè¿‡ç¨‹ï¼š">Â¶</a>cleantimersè¿‡ç¨‹ï¼š</h4>
<ul>
<li>åˆ¤æ–­é•¿åº¦</li>
<li>åˆ¤æ–­ä¸Šä¸€ä¸ªtimerçŠ¶æ€</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// cleantimers cleans up the head of the timer queue. This speeds up</span></span><br><span class="line"><span class="comment">// programs that create and delete timers; leaving them in the heap</span></span><br><span class="line"><span class="comment">// slows down addtimer. Reports whether no timer problems were found.</span></span><br><span class="line"><span class="comment">// The caller must have locked the timers for pp.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cleantimers</span><span class="params">(pp *p)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(pp.timers) == <span class="number">0</span> &#123; <span class="comment">// åˆ¤æ–­é•¿åº¦</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		t := pp.timers[<span class="number">0</span>] <span class="comment">//å–ç¬¬ä¸€ä¸ª</span></span><br><span class="line">		<span class="keyword">if</span> t.pp.ptr() != pp &#123;</span><br><span class="line">			throw(<span class="string">&quot;cleantimers: bad p&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> s := atomic.Load(&amp;t.status); s &#123; <span class="comment">//éœ€è¦åˆ¤æ–­çŠ¶æ€</span></span><br><span class="line">		<span class="keyword">case</span> timerDeleted:</span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, s, timerRemoving) &#123; <span class="comment">//éåˆ é™¤ä¸­</span></span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			dodeltimer0(pp) <span class="comment">//ç§»é™¤timer0</span></span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, timerRemoving, timerRemoved) &#123;</span><br><span class="line">				badTimer()</span><br><span class="line">			&#125;</span><br><span class="line">			atomic.Xadd(&amp;pp.deletedTimers, <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">case</span> timerModifiedEarlier, timerModifiedLater: <span class="comment">// ä¿®æ”¹å‰æˆ–è€…ä¿®æ”¹åçš„çŠ¶æ€</span></span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, s, timerMoving) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Now we can change the when field.</span></span><br><span class="line">			t.when = t.nextwhen <span class="comment">// æŒ‡é’ˆåç§»</span></span><br><span class="line">			<span class="comment">// Move t to the right position.</span></span><br><span class="line">			dodeltimer0(pp) <span class="comment">// åˆ é™¤æœ€åº•ä¸‹çš„å…ƒç´ </span></span><br><span class="line">			doaddtimer(pp, t) <span class="comment">// é‡æ–°ç»‘å®šPå’Œtçš„å…³ç³»</span></span><br><span class="line">			<span class="keyword">if</span> s == timerModifiedEarlier &#123;</span><br><span class="line">				atomic.Xadd(&amp;pp.adjustTimers, <span class="number">-1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, timerMoving, timerWaiting) &#123;</span><br><span class="line">				badTimer()</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">// Head of timers does not need adjustment.</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="dodeltimer0"><a class="header-anchor" href="#dodeltimer0">Â¶</a>dodeltimer0</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dodeltimer0 removes timer 0 from the current P&#x27;s heap.</span></span><br><span class="line"><span class="comment">// We are locked on the P when this is called.</span></span><br><span class="line"><span class="comment">// It reports whether it saw no problems due to races.</span></span><br><span class="line"><span class="comment">// The caller must have locked the timers for pp.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dodeltimer0</span><span class="params">(pp *p)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> t := pp.timers[<span class="number">0</span>]; t.pp.ptr() != pp &#123;</span><br><span class="line">		throw(<span class="string">&quot;dodeltimer0: wrong P&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		t.pp = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	last := <span class="built_in">len</span>(pp.timers) - <span class="number">1</span> <span class="comment">// è·å–ç¬¬ä¸€ä¸ªtimers</span></span><br><span class="line">	<span class="keyword">if</span> last &gt; <span class="number">0</span> &#123;</span><br><span class="line">		pp.timers[<span class="number">0</span>] = pp.timers[last] <span class="comment">// æ ˆåº•---&gt;æ ˆé¡¶</span></span><br><span class="line">	&#125;</span><br><span class="line">	pp.timers[last] = <span class="literal">nil</span> <span class="comment">// ç½®ç©º</span></span><br><span class="line">	pp.timers = pp.timers[:last] <span class="comment">//é‡æ–°èµ‹å€¼</span></span><br><span class="line">	<span class="keyword">if</span> last &gt; <span class="number">0</span> &#123;</span><br><span class="line">		siftdownTimer(pp.timers, <span class="number">0</span>)  <span class="comment">// é‡æ–°æ’åº</span></span><br><span class="line">	&#125;</span><br><span class="line">	updateTimer0When(pp) <span class="comment">// æ›´æ–°Pä¸­çš„when</span></span><br><span class="line">	atomic.Xadd(&amp;pp.numTimers, <span class="number">-1</span>) <span class="comment">// æ›´æ–°æ•°é‡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a class="header-anchor" href="#å‚è€ƒ">Â¶</a>å‚è€ƒ</h3>
<ul>
<li>
<p><a href="https://github.com/golang/go/blob/master/src/time/tick.go#L39">NewTickerå®˜æ–¹å®ç°</a></p>
</li>
<li>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203">StartTimeråº•å±‚å®ç°</a></p>
</li>
<li>
<p>atomic</p>
<ul>
<li>atomic.Store64</li>
<li>atomic.Xadd</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>ticker</tag>
        <tag>defer</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ31ã€Floatç±»å‹æ˜“è¸©çš„å‘</title>
    <url>/archives/cb90ed2a.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>æœ€è¿‘å¿«è¿‡å¹´äº†å§ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šéœ€æ±‚è¦æï¼Œï¼Œï¼Œï¼Œ</p>
<p>çªç„¶æ¥äº†ä¸ªé”…ï¼Œè¢«äººæŠ•è¯‰è¯´æ•°æ®ç»Ÿè®¡çš„æœ‰é—®é¢˜ï¼Œæ‰“å¼€ç”µè„‘ä¸€çœ‹ï¼Œfloatç±»å‹çš„ç»Ÿè®¡ï¼Œã€Œæˆ‘æ…Œäº†ï¼Œfloatåœ¨ç»Ÿè®¡ä¸­ä¸€ç›´éƒ½å¾ˆå¤´ç–¼ã€‚ã€</p>
<h3 id="è§¦å‘ç‚¹"><a class="header-anchor" href="#è§¦å‘ç‚¹">Â¶</a>è§¦å‘ç‚¹</h3>
<h4 id="å…ˆæ¥çœ‹é—®é¢˜å§ã€Œå†™äº†ä¸ªä¾‹å­ã€ï¼š"><a class="header-anchor" href="#å…ˆæ¥çœ‹é—®é¢˜å§ã€Œå†™äº†ä¸ªä¾‹å­ã€ï¼š">Â¶</a>å…ˆæ¥çœ‹é—®é¢˜å§ã€Œå†™äº†ä¸ªä¾‹å­ã€ï¼š</h4>
<blockquote>
<p>ä¸‹é¢çš„ç»“æœï¼Œaåº”è¯¥æ˜¯ä»€ä¹ˆå€¼ï¼Ÿwhyï¼Ÿ</p>
</blockquote>
<a id="more"></a>
<blockquote>
<p>go version go1.14.14 darwin/amd64</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> floatNumber <span class="keyword">float64</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	a := floatNumber / <span class="number">0</span></span><br><span class="line">	fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºç»“æœï¼š"><a class="header-anchor" href="#è¾“å‡ºç»“æœï¼š">Â¶</a>è¾“å‡ºç»“æœï¼š</h5>
<p>NAN</p>
<h5 id="why-ã€Œç©¶å…¶æ ¹æºã€"><a class="header-anchor" href="#why-ã€Œç©¶å…¶æ ¹æºã€">Â¶</a>why?ã€Œç©¶å…¶æ ¹æºã€</h5>
<p><a href="https://golang.google.cn/ref/spec#Representability">å®˜æ–¹è§£é‡Š</a></p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210204_030335.png" alt=""></p>
<blockquote>
<p>ç®€å•çš„è¯´å°±æ˜¯ 0/0 ä¸ºè´Ÿæ— ç©·å¤§ï¼Œæ‰€ä»¥ä¸º NAN.</p>
</blockquote>
<h3 id="å¦‚ä½•è§„é¿ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•è§„é¿ï¼Ÿ">Â¶</a>å¦‚ä½•è§„é¿ï¼Ÿ</h3>
<ul>
<li>æå‰åˆ¤æ–­åˆ†æ¯ï¼Œä¸º0ï¼Œä¸è®¡ç®—ã€Œæ ¹æºè§£å†³ã€</li>
<li>åˆ©ç”¨math.IsNaN(xxx)ï¼Œé€‰æ‹©æ€§è·³è¿‡ã€‚ ã€Œæ²»æ ‡ã€</li>
</ul>
<h3 id="æ‹“å±•ï¼š"><a class="header-anchor" href="#æ‹“å±•ï¼š">Â¶</a>æ‹“å±•ï¼š</h3>
<h4 id="ä¸‹é¢è¿™ä¸ªè¾“å‡ºä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#ä¸‹é¢è¿™ä¸ªè¾“å‡ºä»€ä¹ˆï¼Ÿ">Â¶</a>ä¸‹é¢è¿™ä¸ªè¾“å‡ºä»€ä¹ˆï¼Ÿ</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> number <span class="keyword">int</span></span><br><span class="line">	fmt.Println(number / <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºç»“æœï¼š-v2"><a class="header-anchor" href="#è¾“å‡ºç»“æœï¼š-v2">Â¶</a>è¾“å‡ºç»“æœï¼š</h5>
<blockquote>
<p>division by zero</p>
</blockquote>
<h5 id="why"><a class="header-anchor" href="#why">Â¶</a>why?</h5>
<ul>
<li>é™¤æ•°ä¸èƒ½ä¸º0.</li>
</ul>
<h4 id="å…³äºfloatç±»å‹"><a class="header-anchor" href="#å…³äºfloatç±»å‹">Â¶</a>å…³äºfloatç±»å‹</h4>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">è¿™ä¹ˆç®€å•ï¼Œä¼°è®¡ä¼šè¢«è¯´å¾ˆèœï¼Œï¼Œï¼Œï¼Œ</span><br><span class="line"></span><br><span class="line">å…³äºfloatç±»å‹çš„ä½¿ç”¨å’Œæ³¨æ„äº‹é¡¹ã€Œå’Œè¯­è¨€æ— å…³ã€ï¼Œä¸€ç›´éƒ½å¾ˆé›¶æ•£ï¼Œä¸‹æ¥æ•´ç†ä¸‹ï¼Œç³»ç»Ÿæ€§çš„å­¦ä¹ å­¦ä¹ ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
<p>å¿«è¿‡å¹´äº†ï¼Œæå‰é¢„ç¥å¤§å®¶æ–°å¹´å¿«ä¹ã€‚ã€‚ã€‚ã€‚</p>
<p>ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨</p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Golang</tag>
        <tag>Float</tag>
        <tag>IEEE</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ30ã€redis rdbæºç -1</title>
    <url>/archives/44b34745.html</url>
    <content><![CDATA[<blockquote>
<p>RDBå’ŒAOFå¸¸å¸¸è¢«æèµ·,å¥½å¥‡RDBè¿™ä¸ªåˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„,è¿™æ ·æ‰èƒ½è¿ç”¨çš„æ›´åŠ çµæ´»å’Œç²¾å‡†.</p>
</blockquote>
<h3 id="å­¦å®Œé¢„æœŸçš„ç›®æ ‡"><a class="header-anchor" href="#å­¦å®Œé¢„æœŸçš„ç›®æ ‡">Â¶</a>å­¦å®Œé¢„æœŸçš„ç›®æ ‡:</h3>
<ul>
<li>å­¦ä¹ æ•°æ®å¼‚æ­¥å¤„ç†æµç¨‹</li>
<li>RDBæŒä¹…åŒ–æ•°æ®çš„å…³é”®è¿‡ç¨‹</li>
<li>RDBçš„ç¼ºç‚¹</li>
<li>RDBé€‚ç”¨çš„åœºæ™¯</li>
<li>RDBæ”¹è¿›ç‚¹æˆ–bug?</li>
<li>æ•°æ®æŒä¹…åŒ–,åº”è¯¥æ˜¯ä¸ªä»€ä¹ˆè¿‡ç¨‹?</li>
</ul>
<a id="more"></a>
<h3 id="å®ç°æµç¨‹"><a class="header-anchor" href="#å®ç°æµç¨‹">Â¶</a>å®ç°æµç¨‹:</h3>
<ul>
<li>è¿™é‡Œç½—åˆ—äº†å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„è¿‡ç¨‹:</li>
</ul>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/redis-rdb-1.png" alt=""></p>
<h3 id="rdbSaveKeyValuePairã€Œ2021-01-31-22-57-28ã€"><a class="header-anchor" href="#rdbSaveKeyValuePairã€Œ2021-01-31-22-57-28ã€">Â¶</a>rdbSaveKeyValuePairã€Œ2021-01-31 22:57:28ã€</h3>
<ul>
<li>é”™è¯¯è¿”å›-1,æ­£å¸¸è¿”å›1,å…¶å®ƒè¿”å›0</li>
<li>ä¸»é€»è¾‘åªéœ€è´Ÿè´£å…¥å‚å’Œè¿”å›å€¼ã€ŒæŠ½è±¡ã€</li>
<li>ä¼˜å…ˆçº§: expire &gt; lru &gt; lfu &gt; [&lt;key,values&gt;]</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Save a key-value pair, with expire time, type, key, value.</span></span><br><span class="line"><span class="comment"> * On error -1 is returned.</span></span><br><span class="line"><span class="comment"> * On success if the key was actually saved 1 is returned, otherwise 0</span></span><br><span class="line"><span class="comment"> * is returned (the key was already expired). */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveKeyValuePair</span><span class="params">(rio *rdb, robj *key, robj *val, <span class="keyword">long</span> <span class="keyword">long</span> expiretime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> savelru = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LRU;</span><br><span class="line">    <span class="keyword">int</span> savelfu = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ä¿å­˜è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="comment">/* Save the expire time */</span></span><br><span class="line">    <span class="keyword">if</span> (expiretime != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveMillisecondTime(rdb,expiretime) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LRUæ–¹å¼ä¿å­˜</span></span><br><span class="line">    <span class="comment">/* Save the LRU info. */</span></span><br><span class="line">    <span class="keyword">if</span> (savelru) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> idletime = estimateObjectIdleTime(val);</span><br><span class="line">        idletime /= <span class="number">1000</span>; <span class="comment">/* Using seconds is enough and requires less space.*/</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_IDLE) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,idletime) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LFUæ–¹å¼ä¿å­˜</span></span><br><span class="line">    <span class="comment">/* Save the LFU info. */</span></span><br><span class="line">    <span class="keyword">if</span> (savelfu) &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span> buf[<span class="number">1</span>];</span><br><span class="line">        buf[<span class="number">0</span>] = LFUDecrAndReturn(val);</span><br><span class="line">        <span class="comment">/* We can encode this in exactly two bytes: the opcode and an 8</span></span><br><span class="line"><span class="comment">         * bit counter, since the frequency is logarithmic with a 0-255 range.</span></span><br><span class="line"><span class="comment">         * Note that we do not store the halving time because to reset it</span></span><br><span class="line"><span class="comment">         * a single time when loading does not affect the frequency much. */</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_FREQ) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,<span class="number">1</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜ç±»å‹ã€keyã€valueç­‰</span></span><br><span class="line">    <span class="comment">/* Save type, key, value */</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveObjectType(rdb,val) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveStringObject(rdb,key) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveObject(rdb,val,key) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»¶è¿Ÿè¯·æ±‚</span></span><br><span class="line">    <span class="comment">/* Delay return if required (for testing) */</span></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_key_save_delay)</span><br><span class="line">        usleep(server.rdb_key_save_delay);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å¾…æ›´ingâ€¦"><a class="header-anchor" href="#å¾…æ›´ingâ€¦">Â¶</a>å¾…æ›´ingâ€¦</h3>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>Redis</tag>
        <tag>RDB</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ29ã€map delete Memä¸é‡Šæ”¾é—®é¢˜</title>
    <url>/archives/2de36dd7.html</url>
    <content><![CDATA[<h3 id="Go-version"><a class="header-anchor" href="#Go-version">Â¶</a>Go version:</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">7384</span> â—¯  <span class="keyword">go</span> version</span><br><span class="line"><span class="keyword">go</span> version go1<span class="number">.14</span><span class="number">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="æœ€è¿‘æœ‰è¿™ä¹ˆä¸ªå‘"><a class="header-anchor" href="#æœ€è¿‘æœ‰è¿™ä¹ˆä¸ªå‘">Â¶</a>æœ€è¿‘æœ‰è¿™ä¹ˆä¸ªå‘:</h3>
<blockquote>
<p>ç¢°åˆ°å†…å­˜æ³„éœ²é—®é¢˜ï¼Œå¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p>
</blockquote>
<ul>
<li>1ã€å®šä¹‰ä¸€ä¸ªå…¨å±€map</li>
<li>2ã€ç»™é‡Œé¢æ”¾å€¼</li>
<li>3ã€ç”¨å®Œä¹‹ååˆ é™¤Key/value</li>
</ul>
<h3 id="é—®é¢˜ï¼šmapåˆ é™¤å®Œkeyåï¼ŒMemæœ‰æ²¡æœ‰è¢«é‡Šæ”¾ï¼Ÿ"><a class="header-anchor" href="#é—®é¢˜ï¼šmapåˆ é™¤å®Œkeyåï¼ŒMemæœ‰æ²¡æœ‰è¢«é‡Šæ”¾ï¼Ÿ">Â¶</a>é—®é¢˜ï¼šmapåˆ é™¤å®Œkeyåï¼ŒMemæœ‰æ²¡æœ‰è¢«é‡Šæ”¾ï¼Ÿ</h3>
<a id="more"></a>
<h3 id="è§‚å¯Ÿå†…å­˜å˜åŒ–ï¼š"><a class="header-anchor" href="#è§‚å¯Ÿå†…å­˜å˜åŒ–ï¼š">Â¶</a>è§‚å¯Ÿå†…å­˜å˜åŒ–ï¼š</h3>
<h4 id="æƒ…æ™¯1-åªåˆ é™¤Mapçš„k-v"><a class="header-anchor" href="#æƒ…æ™¯1-åªåˆ é™¤Mapçš„k-v">Â¶</a>æƒ…æ™¯1: åªåˆ é™¤Mapçš„k/v</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	<span class="comment">//intMap = nil</span></span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š"><a class="header-anchor" href="#è¾“å‡ºï¼š">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">162</span> TotalAlloc = <span class="number">162</span> Sys = <span class="number">69714</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">487</span> Sys = <span class="number">70290</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">473</span> TotalAlloc = <span class="number">490</span> Sys = <span class="number">70610</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">475</span> TotalAlloc = <span class="number">494</span> Sys = <span class="number">70610</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯2-åˆ é™¤mapçš„k-v-å¹¶ç½®mapä¸ºnil"><a class="header-anchor" href="#æƒ…æ™¯2-åˆ é™¤mapçš„k-v-å¹¶ç½®mapä¸ºnil">Â¶</a>æƒ…æ™¯2: åˆ é™¤mapçš„k/v,å¹¶ç½®mapä¸ºnil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	intMap = <span class="literal">nil</span></span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v2"><a class="header-anchor" href="#è¾“å‡ºï¼š-v2">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69714</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">71696</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">71760</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">160</span> TotalAlloc = <span class="number">492</span> Sys = <span class="number">71760</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯3-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-ä¸ç½®nil"><a class="header-anchor" href="#æƒ…æ™¯3-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-ä¸ç½®nil">Â¶</a>æƒ…æ™¯3: mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k/v,ä¸ç½®nil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	other()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">other</span><span class="params">()</span></span>&#123;</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	<span class="comment">//intMap = nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v3"><a class="header-anchor" href="#è¾“å‡ºï¼š-v3">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69458</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">71440</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">71504</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">473</span> TotalAlloc = <span class="number">492</span> Sys = <span class="number">71504</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯4-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-mapç½®ä¸ºnil"><a class="header-anchor" href="#æƒ…æ™¯4-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-mapç½®ä¸ºnil">Â¶</a>æƒ…æ™¯4: mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k/v,mapç½®ä¸ºnil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	other()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">other</span><span class="params">()</span></span>&#123;</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	intMap = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v4"><a class="header-anchor" href="#è¾“å‡ºï¼š-v4">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69714</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">70034</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">70098</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">160</span> TotalAlloc = <span class="number">492</span> Sys = <span class="number">70098</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯5-mapå®šä¹‰æ”¾åœ¨å±€éƒ¨å˜é‡ä¸­ï¼š"><a class="header-anchor" href="#æƒ…æ™¯5-mapå®šä¹‰æ”¾åœ¨å±€éƒ¨å˜é‡ä¸­ï¼š">Â¶</a>æƒ…æ™¯5: mapå®šä¹‰æ”¾åœ¨å±€éƒ¨å˜é‡ä¸­ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	other()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">other</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line">	intMap = initMap(intMap)</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	<span class="comment">//intMap = nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">(intMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span> <span class="title">map</span>[<span class="title">int</span>]<span class="title">int</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> intMap</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v5"><a class="header-anchor" href="#è¾“å‡ºï¼š-v5">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69458</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">71440</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">158</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">71504</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">160</span> TotalAlloc = <span class="number">491</span> Sys = <span class="number">71504</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h5 id="æ±‡ç¼–è¾“å‡ºï¼š"><a class="header-anchor" href="#æ±‡ç¼–è¾“å‡ºï¼š">Â¶</a>æ±‡ç¼–è¾“å‡ºï¼š</h5>
<p>æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€è¡Œï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_051000.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">XORL å¼‚æˆ–è¿ç®—ç¬¦ </span><br><span class="line"></span><br><span class="line">XORL AX,AX ---&gt;å°†AXç½®0å€¼</span><br></pre></td></tr></table></figure>
<h4 id="deleteå‡½æ•°ï¼š"><a class="header-anchor" href="#deleteå‡½æ•°ï¼š">Â¶</a>deleteå‡½æ•°ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0125</span> <span class="number">00293</span> (../<span class="number">1126</span>/main.<span class="keyword">go</span>:<span class="number">26</span>)	CALL	runtime.mapdelete_fast64(SB)</span><br></pre></td></tr></table></figure>
<h5 id="mapdelete-fast64å‡½æ•°ä½œç”¨ï¼š"><a class="header-anchor" href="#mapdelete-fast64å‡½æ•°ä½œç”¨ï¼š">Â¶</a>mapdelete_fast64å‡½æ•°ä½œç”¨ï¼š</h5>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/map_fast64.go#L272">ç‚¹å‡»GithubæŸ¥çœ‹</a></p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_052140.png" alt=""></p>
<blockquote>
<p>æœ‰æ„æ€çš„æ˜¯ï¼šmapçš„è®¾è®¡å°±æ˜¯è¿™æ ·ï¼Œåˆ é™¤keyï¼Œåªæ˜¯æŠŠè¿™ä¸ªæ§½ä½ç½®emptyï¼Œå¹¶æ²¡æœ‰é‡Šæ”¾å†…å­˜.</p>
</blockquote>
<h3 id="Others"><a class="header-anchor" href="#Others">Â¶</a>Others:</h3>
<h4 id="å…¶å®ƒåœºæ™¯ï¼š"><a class="header-anchor" href="#å…¶å®ƒåœºæ™¯ï¼š">Â¶</a>å…¶å®ƒåœºæ™¯ï¼š</h4>
<blockquote>
<p>åœºæ™¯æœ‰å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯é€»åˆ—æœ€ç®€å•çš„ï¼Œè‡³äºç”¨æŒ‡é’ˆä¹‹ç±»çš„ï¼Œæœ‰å…´è¶£äº†å†ç ”ç©¶ç ”ç©¶ï¼Œæ–¹æ³•éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
</blockquote>
<h4 id="æ±‡ç¼–ä»£ç ç”Ÿæˆ"><a class="header-anchor" href="#æ±‡ç¼–ä»£ç ç”Ÿæˆ">Â¶</a>æ±‡ç¼–ä»£ç ç”Ÿæˆ</h4>
<ul>
<li>è¯¦ç»†è§æ­¤æ–‡ï¼š<a href="https://blog.imrcrab.com/archives/2ce846ed.html">ã€Œ15ã€Plan9 æ±‡ç¼–å°è®°</a></li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Map</tag>
        <tag>Hash</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ28ã€sync-mutexä¼ å‚å¤åˆ¶é—®é¢˜</title>
    <url>/archives/a82ae489.html</url>
    <content><![CDATA[<h3 id="Go-version"><a class="header-anchor" href="#Go-version">Â¶</a>Go version:</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">7384</span> â—¯  <span class="keyword">go</span> version</span><br><span class="line"><span class="keyword">go</span> version go1<span class="number">.14</span><span class="number">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="èµ·å› "><a class="header-anchor" href="#èµ·å› ">Â¶</a>èµ·å› :</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sync.Mutexå½“å‚æ•°,å€¼ä¼ é€’åå‡ºé”™.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ç°è±¡"><a class="header-anchor" href="#ç°è±¡">Â¶</a>ç°è±¡:</h3>
<blockquote>
<p>ä¸åºŸè¯,ä¸Šä»£ç :</p>
</blockquote>
<a id="more"></a>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> age <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	mux sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span> <span class="title">AddAge</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> wg.Done()</span><br><span class="line">	p.mux.Lock()</span><br><span class="line">	age++</span><br><span class="line">	<span class="keyword">defer</span> p.mux.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	p1 := Person&#123;</span><br><span class="line">		mux: sync.Mutex&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Add(<span class="number">100</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> p1.AddAge()</span><br><span class="line">	&#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    </span><br><span class="line">	fmt.Println(age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="è¿™ä¸ªageçš„è¾“å‡ºåº”è¯¥æ˜¯å¤šå°‘"><a class="header-anchor" href="#è¿™ä¸ªageçš„è¾“å‡ºåº”è¯¥æ˜¯å¤šå°‘">Â¶</a>è¿™ä¸ªageçš„è¾“å‡ºåº”è¯¥æ˜¯å¤šå°‘?</h4>
<h4 id="ä¸å¦¨å¯ä»¥å¤šå°è¯•å‡ æ¬¡-ç»“æœ"><a class="header-anchor" href="#ä¸å¦¨å¯ä»¥å¤šå°è¯•å‡ æ¬¡-ç»“æœ">Â¶</a>ä¸å¦¨å¯ä»¥å¤šå°è¯•å‡ æ¬¡,ç»“æœ:</h4>
<blockquote>
<p>100/99/98éƒ½æœ‰å¯èƒ½.</p>
</blockquote>
<h3 id="What-Lockéš¾é“ä¸æ˜¯åŠ é”çš„ä¹ˆ"><a class="header-anchor" href="#What-Lockéš¾é“ä¸æ˜¯åŠ é”çš„ä¹ˆ">Â¶</a>What? Lockéš¾é“ä¸æ˜¯åŠ é”çš„ä¹ˆ</h3>
<blockquote>
<p>LockåŠ é”éš¾é“ä¸æ˜¯è¿™ä¹ˆç”¨çš„ä¹ˆ,é¢ è¦†è®¤çŸ¥!</p>
</blockquote>
<h4 id="Lockæºç "><a class="header-anchor" href="#Lockæºç ">Â¶</a>Lockæºç :</h4>
<p><em>A Mutex must not be copied after first use</em></p>
<h3 id="æ ¹æº"><a class="header-anchor" href="#æ ¹æº">Â¶</a>æ ¹æº:</h3>
<ul>
<li>Goå‚æ•°ä¼ é€’å±äºå€¼ä¼ é€’</li>
<li>Mutexå¤åˆ¶åä¸­çš„stateå±äºå‰ä¸€çŠ¶æ€,æ²¡æœ‰æ”¹å˜</li>
<li>Mutexä¸­çš„Lockå’ŒUnlockã€Œæ–¹æ³•ã€å±äºæŒ‡é’ˆç±»å‹<sup>å›¾1</sup></li>
</ul>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210102_102753.png" alt=""><br>
<strong><center>å›¾<sup>1</sup></center></strong></p>
<h3 id="è§£å†³åŠæ³•"><a class="header-anchor" href="#è§£å†³åŠæ³•">Â¶</a>è§£å†³åŠæ³•</h3>
<ul>
<li>å½“ç„¶æ˜¯å‚è€ƒæºç ,ã€Œå›¾1ã€</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ç¼ºç‚¹:</span><br><span class="line">    æ¯æ¬¡ä½¿ç”¨ä¹‹å‰éœ€è¦åˆå§‹åŒ–,æ¯•ç«Ÿæ˜¯æŒ‡é’ˆç±»å‹çš„</span><br><span class="line"></span><br><span class="line">ä¼˜ç‚¹:</span><br><span class="line">    è®¾è®¡æºäºæºç ,è¿½éšGoçš„è®¾è®¡.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>åŠ é”çš„åœ°æ–¹å°½é‡æ˜¯å…¨å±€çš„</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">è¿™ä¸ªå°±ä¸åˆ†æäº†,æ¯•ç«Ÿä¸é€‚ç”¨æ‰€æœ‰åœºæ™¯.</span><br><span class="line"></span><br><span class="line">ä¸é€‚ç”¨çš„åœºæ™¯:</span><br><span class="line">    ä¸´æ—¶çš„Mapéœ€è¦åŠ é”,å¦‚æœç”¨å…¨å±€é”,åˆ™æ•ˆç‡é™ä½.</span><br></pre></td></tr></table></figure>
<h3 id="SyncåŒ…ä¸å¯å¤åˆ¶æ€§"><a class="header-anchor" href="#SyncåŒ…ä¸å¯å¤åˆ¶æ€§">Â¶</a>SyncåŒ…ä¸å¯å¤åˆ¶æ€§</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨syncåŒ…ä¸‹çš„åŠŸèƒ½,å¯èƒ½å¾—æ³¨æ„äº†,éƒ½æ˜¯ä¸å¯å¤åˆ¶çš„.</span><br></pre></td></tr></table></figure>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
<blockquote>
<p>æ¯æ¬¡çœ‹æºç ,éƒ½ä¼šæœ‰ä¸ä¸€æ ·çš„æ”¶è·.ã€Œä¹Ÿè®¸æ˜¯æˆ‘ç†è§£èƒ½åŠ›å·®å“ˆã€</p>
</blockquote>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>sync</tag>
        <tag>Mutex</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ27ã€Time Zoneæ—¶åŒºè¯¦è§£</title>
    <url>/archives/513dbeba.html</url>
    <content><![CDATA[<p>æ—¶åŒºï¼Œæ— å…³è¯­è¨€ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç³»ç»Ÿä¸­éƒ½ä¼šç”¨åˆ°ï¼š</p>
<ul>
<li>timeã€Œæ—¶é—´ã€</li>
<li>timeIDã€Œæ—¶é—´ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€</li>
<li>time to unix</li>
<li>unix to time string</li>
<li>â€¦</li>
</ul>
<blockquote>
<p>å¾ˆå¤šåœºæ™¯éƒ½ä¼šçœ‹åˆ°è¿™ä¸ªæ—¶é—´çš„é‡è¦æ€§ï¼Œè¿™æ¬¡çœ‹åˆ°16çš„ç‰¹æ€§ä¸­æœ‰ä¸€ä¸ªä¿®æ”¹é¡¹ï¼Œè§‰å¾—è‡ªå·±å¯¹timeå’Œzoneäº†è§£çš„å¤ªå°‘äº†ï¼Œä»¥æ­¤è®°å½•ï¼Œä»¥ä¾¿ç§¯ç´¯ã€‚</p>
</blockquote>
<a id="more"></a>
<h3 id="Go-version"><a class="header-anchor" href="#Go-version">Â¶</a>Go version:</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">7384</span> â—¯  <span class="keyword">go</span> version</span><br><span class="line"><span class="keyword">go</span> version go1<span class="number">.14</span><span class="number">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="æ—¶åŒº-UTC-GMT-MDT-CST"><a class="header-anchor" href="#æ—¶åŒº-UTC-GMT-MDT-CST">Â¶</a>æ—¶åŒº UTC\GMT\MDT\CST</h3>
<blockquote>
<p>è¯´åˆ°æ—¶é—´ï¼Œè‚¯å®šå¾—æƒ³åˆ°æ—¶åŒºé—®é¢˜ï¼Œå’±ä»¬å›½å®¶è¿˜å¥½ï¼Œåªæœ‰ä¸€ä¸ªBeijingæ—¶åŒºï¼Œç¾å›½æœ¬åœŸã€‚ã€‚ã€‚ã€‚å››ä¸ªæ—¶åŒºã€Œæ™•äº†ã€</p>
</blockquote>
<p>Ps: <a href="https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E6%99%82%E5%8D%80">ç‚¹å‡»æŸ¥çœ‹å››ä¸ªæ—¶åŒº</a></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">GMT (Greenwich Mean Time)çš„ç¼©å†™ï¼ŒæŒ‡çš„æ˜¯çš‡å®¶æ ¼æ—å¨æ²»å¤©æ–‡å°çš„æ ‡å‡†æ—¶é—´ï¼Œç§°ä½œæ ¼æ—å¨æ²»æ—¶é—´ï¼Œå› ä¸ºæœ¬åˆå­åˆçº¿é€šè¿‡æ­¤åœ°åŒºï¼Œå› æ­¤ä¹Ÿç§°ä¸ºä¸–ç•Œæ ‡å‡†æ—¶é—´ã€‚ç„¶è€Œåœ°çƒçš„è‡ªè½¬ä¸æ˜¯å®Œå…¨è§„å¾‹çš„ï¼Œè€Œä¸”æ­£é€æ¸å‡æ…¢ï¼Œå› æ­¤è‡ª1924å¹´å¼€å§‹ï¼Œæ ¼æ—å¨æ²»æ—¶é—´(GMT)å·²ç»ä¸å†è¢«è§†ä¸ºæ ‡å‡†æ—¶é—´ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯&quot;ä¸–ç•Œåè°ƒæ—¶é—´&quot; (UTC: Coordinated Universal Time)</span><br><span class="line"></span><br><span class="line">UTC åè°ƒä¸–ç•Œæ—¶ï¼ˆCoordinated Universal Timeï¼‰æ˜¯æœ€ä¸»è¦çš„ä¸–ç•Œæ—¶é—´æ ‡å‡†ï¼Œå…¶ä»¥åŸå­æ—¶ç§’é•¿ä¸ºåŸºç¡€ï¼Œåœ¨æ—¶åˆ»ä¸Šå°½é‡æ¥è¿‘äºæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ã€‚UTC æ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ—¶åŒº</span><br><span class="line"></span><br><span class="line">CST</span><br><span class="line">â€ƒåŒ—äº¬æ—¶é—´ï¼ŒChina Standard Timeï¼Œä¸­å›½æ ‡å‡†æ—¶é—´ï¼Œæ˜¯ä¸­å›½çš„æ ‡å‡†æ—¶é—´ã€‚åœ¨æ—¶åŒºåˆ’åˆ†ä¸Šï¼Œå±ä¸œå…«åŒºï¼Œæ¯”åè°ƒä¸–ç•Œæ—¶æ—©8å°æ—¶ï¼Œè®°ä¸ºUTC+8</span><br></pre></td></tr></table></figure>
<h3 id="Goä¸­çš„æ—¶åŒºé—®é¢˜"><a class="header-anchor" href="#Goä¸­çš„æ—¶åŒºé—®é¢˜">Â¶</a>Goä¸­çš„æ—¶åŒºé—®é¢˜</h3>
<p>æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥è¯´æ˜è¿™ä¸ªæ—¶åŒºé—®é¢˜ï¼š</p>
<ul>
<li>time.LoadLocation</li>
</ul>
<blockquote>
<p>å¦‚æœä½ æŸ¥æŸ¥æºç ï¼Œå°±ä¼šå‘ç°è¿™ä¸ªå‡½æ•°ä¸Šé¢å†™ç€æ—¶åŒºçš„é—®é¢˜ï¼Œä¹Ÿè·Ÿä¸ç”¨ç™¾åº¦æ—¶åŒºï¼Œæœ‰çš„è‡ªç„¶æ”¯æŒï¼Œæ²¡æœ‰çš„å†™äº†å°±æ˜¯ä¹±å†™äº†ã€‚</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112003.png" alt=""></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">æŸ¥è¯¢çš„æ—¶åŒºä¸€ç›´å°±åœ¨ä½ gorootè·¯å¾„ä¸‹çš„ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä¸­ã€‚</span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„æœ‰å…´è¶£å¯ä»¥å»çœ‹çœ‹æ‰€æœ‰çš„æ—¶åŒºï¼Œåç»­ä¹Ÿå°±æœ‰ä¸€ä¸ªå…¨é¢çš„äº†è§£äº†ï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112408.png" alt=""></p>
<h3 id="Go-ä¸­å¯¹äºæ—¶é—´çš„ä½¿ç”¨"><a class="header-anchor" href="#Go-ä¸­å¯¹äºæ—¶é—´çš„ä½¿ç”¨">Â¶</a>Go ä¸­å¯¹äºæ—¶é—´çš„ä½¿ç”¨</h3>
<blockquote>
<p>å¾…æ›´æ–°â€¦</p>
</blockquote>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>time</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ26ã€Go 1.16 ç‰¹æ€§</title>
    <url>/archives/4f05d45d.html</url>
    <content><![CDATA[<p>Go 1.16ç‰¹æ€§ï¼š</p>
<a id="more"></a>
<h2 id="jsonè‡ªå®šä¹‰ã€Œissues-5901ã€"><a class="header-anchor" href="#jsonè‡ªå®šä¹‰ã€Œissues-5901ã€">Â¶</a>jsonè‡ªå®šä¹‰<a href="https://github.com/golang/go/issues/5901">ã€Œissues 5901ã€</a></h2>
<h3 id="ã€ŒFeatã€"><a class="header-anchor" href="#ã€ŒFeatã€">Â¶</a>ã€ŒFeatã€</h3>
<h3 id="èµ·æºï¼š"><a class="header-anchor" href="#èµ·æºï¼š">Â¶</a>èµ·æºï¼š</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">For example, if a user wants to marshal net.IP with custom code, we should provide a way</span><br><span class="line">to do that, probably a method on *Encoder. Similarly for *Decoder.</span><br><span class="line"></span><br><span class="line">Same for encoding&#x2F;xml</span><br></pre></td></tr></table></figure>
<h3 id="å˜æ›´ï¼š"><a class="header-anchor" href="#å˜æ›´ï¼š">Â¶</a>å˜æ›´ï¼š</h3>
<p><a href="https://go-review.googlesource.com/c/go/+/31091">coding:</a></p>
<h3 id="ä½¿ç”¨æ•™ç¨‹ï¼š"><a class="header-anchor" href="#ä½¿ç”¨æ•™ç¨‹ï¼š">Â¶</a><a href="https://github.com/golang/go/issues/5901#issuecomment-566269861">ä½¿ç”¨æ•™ç¨‹ï¼š</a></h3>
<h2 id="GMTå’ŒMDTæ—¶åŒºé—®é¢˜ã€Œissues-43354ã€"><a class="header-anchor" href="#GMTå’ŒMDTæ—¶åŒºé—®é¢˜ã€Œissues-43354ã€">Â¶</a>GMTå’ŒMDTæ—¶åŒºé—®é¢˜<a href="https://github.com/golang/go/issues/43354">ã€Œissues 43354ã€</a></h2>
<h3 id="ã€ŒFixã€"><a class="header-anchor" href="#ã€ŒFixã€">Â¶</a>ã€ŒFixã€</h3>
<h3 id="é—®é¢˜ï¼š"><a class="header-anchor" href="#é—®é¢˜ï¼š">Â¶</a>é—®é¢˜ï¼š</h3>
<blockquote>
<p>ä¸»è¦ä¿®å¤ä¸€ä¸ªæ—¶åŒºé—®é¢˜ MDT or GMT ï¼Ÿ</p>
</blockquote>
<p><a href="https://github.com/golang/go/issues/43354#issuecomment-750490418">å®˜æ–¹reply</a><br>
<a href="https://go-review.googlesource.com/c/go/+/280072/">go-review</a></p>
<h2 id="go-get-dã€Œissues-43131ã€"><a class="header-anchor" href="#go-get-dã€Œissues-43131ã€">Â¶</a>go get -d<a href="https://github.com/golang/go/issues/43131">ã€Œissues 43131ã€</a></h2>
<h3 id="ã€ŒFeatã€-v2"><a class="header-anchor" href="#ã€ŒFeatã€-v2">Â¶</a>ã€ŒFeatã€</h3>
<h3 id="å˜æ›´ï¼š-v2"><a class="header-anchor" href="#å˜æ›´ï¼š-v2">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">cmd/<span class="keyword">go</span>æ–°å¢ï¼šã€Œä»…ä¸‹è½½ï¼Œä¸ä½¿ç”¨æ­¤ä¾èµ–ã€</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> get -d</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="go-mod-downloadæ— æ³•æŒ‡å®šç‰ˆæœ¬ã€Œissues-42524ã€"><a class="header-anchor" href="#go-mod-downloadæ— æ³•æŒ‡å®šç‰ˆæœ¬ã€Œissues-42524ã€">Â¶</a>go mod downloadæ— æ³•æŒ‡å®šç‰ˆæœ¬<a href="https://github.com/golang/go/issues/42524">ã€Œissues 42524ã€</a></h2>
<h3 id="ã€ŒFixã€-v2"><a class="header-anchor" href="#ã€ŒFixã€-v2">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´ï¼š-v3"><a class="header-anchor" href="#å˜æ›´ï¼š-v3">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">modify æŒ‡å®šç‰ˆæœ¬å¯ä»¥download</span><br></pre></td></tr></table></figure>
<h3 id="review"><a class="header-anchor" href="#review">Â¶</a><a href="https://go-review.googlesource.com/c/go/+/270520/">review</a></h3>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_011910.png" alt=""></p>
<h2 id="ParseDir-æŒ‡å®š-goä½œä¸ºåç¼€çš„bugã€Œissues-42951ã€"><a class="header-anchor" href="#ParseDir-æŒ‡å®š-goä½œä¸ºåç¼€çš„bugã€Œissues-42951ã€">Â¶</a>ParseDir æŒ‡å®š.goä½œä¸ºåç¼€çš„bug<a href="https://github.com/golang/go/issues/42951">ã€Œissues 42951ã€</a></h2>
<h3 id="ã€ŒFixã€-v3"><a class="header-anchor" href="#ã€ŒFixã€-v3">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´ï¼š-v4"><a class="header-anchor" href="#å˜æ›´ï¼š-v4">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ä»¥.<span class="keyword">go</span>ç»“å°¾çš„æ–‡ä»¶å¤¹ï¼ŒParseDiræ— æ³•è½¬æ¢</span><br></pre></td></tr></table></figure>
<h3 id="review-v2"><a class="header-anchor" href="#review-v2">Â¶</a><a href="https://github.com/golang/go/commit/48838c35dc7c8e938a83db66faabf3a51f4adc3d">review</a></h3>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_013355.png" alt=""></p>
<h2 id="strconv-ParseComplexæœªå¤„ç†32ä½æ•°å­—ã€Œissues-40706ã€"><a class="header-anchor" href="#strconv-ParseComplexæœªå¤„ç†32ä½æ•°å­—ã€Œissues-40706ã€">Â¶</a>strconv:ParseComplexæœªå¤„ç†32ä½æ•°å­—<a href="https://github.com/golang/go/issues/40706">ã€Œissues 40706ã€</a></h2>
<h3 id="ã€ŒFixã€-v4"><a class="header-anchor" href="#ã€ŒFixã€-v4">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´ï¼š-v5"><a class="header-anchor" href="#å˜æ›´ï¼š-v5">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">å¤„ç†<span class="number">32</span>bitsizeï¼Œéœ€è¦è¿”å›errorã€‚</span><br></pre></td></tr></table></figure>
<h3 id="review-v3"><a class="header-anchor" href="#review-v3">Â¶</a><a href="https://go-review.googlesource.com/c/go/+/248219/">review</a></h3>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_051536.png" alt=""></p>
<h2 id="runtime-getMcache-ã€Œissues-42339ã€"><a class="header-anchor" href="#runtime-getMcache-ã€Œissues-42339ã€">Â¶</a>runtime {getMcache} <a href="https://github.com/golang/go/issues/42339">ã€Œissues 42339ã€</a></h2>
<h3 id="ã€ŒFixã€-v5"><a class="header-anchor" href="#ã€ŒFixã€-v5">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´"><a class="header-anchor" href="#å˜æ›´">Â¶</a>å˜æ›´</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">runtime: <span class="built_in">make</span> getMCache inlineable</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="review-v4"><a class="header-anchor" href="#review-v4">Â¶</a>review</h3>
<ul>
<li>
<p><a href="https://go-review.googlesource.com/c/go/+/267158/">runtime: decouple consistent stats from mcache and allow P-less update</a></p>
</li>
<li>
<p><a href="https://go-review.googlesource.com/c/go/+/267157/">runtime: make getMCache inlineable</a></p>
</li>
</ul>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_081048.png" alt=""></p>
<h3 id="æŒç»­æ›´â€¦"><a class="header-anchor" href="#æŒç»­æ›´â€¦">Â¶</a>æŒç»­æ›´â€¦</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>v1.16</tag>
        <tag>encoding/json</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ25ã€GPM sysmonå‡½æ•°</title>
    <url>/archives/c770fe49.html</url>
    <content><![CDATA[<p>å‰é¢ä¸»è¦æ˜¯äº†è§£newmçš„å…¨è¿‡ç¨‹å’Œå…¶ä¸­éš¾è¿‡ä¸€äº›ç»†èŠ‚é€»è¾‘ï¼Œï¼Œï¼Œ<br>
å¦‚æœæ²¡äº†è§£çš„ï¼Œå»ºè®®å…ˆå»çœ‹ä¸‹å¤§æ¦‚çš„è¿‡ç¨‹ï¼Œè™½ç„¶ä¸æ˜¯éå¸¸è¯¦ç»†ï¼Œ<br>
æœ€èµ·ç å¾—çŸ¥é“newmè¿‡ç¨‹ï¼Œä¸»è¦å®Œæˆäº†ä»€ä¹ˆæ“ä½œï¼Œæœ‰åˆ©äºåç»­ç†è§£ã€‚</p>
<p>è¿™æ¬¡ä¸»è¦æ˜¯æ¥å­¦å­¦è¿™ä¸ªsysmonï¼Œç³»ç»Ÿç›‘æ§è°ƒåº¦çš„é€»è¾‘ã€‚</p>
<a id="more"></a>
<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>åœ¨æ·±å…¥ä¹‹å‰å‘¢ï¼Œå…ˆå¯¹ä¸‹é¢è¿™äº›å˜é‡æœ‰ä¸ªæ¦‚å¿µï¼Œåç»­æåˆ°ä¹Ÿå°±ä¸é™Œç”Ÿäº†ã€‚ã€Œæ‘˜æŠ„è‡ªsysmonå‡½æ•°ã€</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	allglen    <span class="keyword">uintptr</span> <span class="comment">//g</span></span><br><span class="line">	allm       *m      <span class="comment">//m</span></span><br><span class="line">	allp       []*p  <span class="comment">// p     len(allp) == gomaxprocs; may change at safe points, otherwise immutable</span></span><br><span class="line">	allpLock   mutex <span class="comment">// å…¨å±€lockã€‚   Protects P-less reads of allp and all writes</span></span><br><span class="line">	gomaxprocs <span class="keyword">int32</span> <span class="comment">//æœ€å¤§processæ•°é‡</span></span><br><span class="line">	ncpu       <span class="keyword">int32</span> <span class="comment">//cpuä¸ªæ•°</span></span><br><span class="line">	forcegc    forcegcstate <span class="comment">//å¼ºåˆ¶GC</span></span><br><span class="line">	sched      schedt <span class="comment">//é¢„åˆ†é…çš„ä¸€äº›å˜é‡å€¼</span></span><br><span class="line">	newprocs   <span class="keyword">int32</span>  <span class="comment">//æ–°çš„process</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Information about what cpu features are available.</span></span><br><span class="line">	<span class="comment">// Packages outside the runtime should not use these</span></span><br><span class="line">	<span class="comment">// as they are not an external api.</span></span><br><span class="line">	<span class="comment">// Set on startup in asm_&#123;386,amd64&#125;.s</span></span><br><span class="line">	processorVersionInfo <span class="keyword">uint32</span></span><br><span class="line">	isIntel              <span class="keyword">bool</span></span><br><span class="line">	lfenceBeforeRdtsc    <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	goarm                <span class="keyword">uint8</span> <span class="comment">// set by cmd/link on arm systems</span></span><br><span class="line">	framepointer_enabled <span class="keyword">bool</span>  <span class="comment">// set by cmd/link</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="sysmonå‡½æ•°"><a class="header-anchor" href="#sysmonå‡½æ•°">Â¶</a>sysmonå‡½æ•°</h3>
<h4 id="æ¦‚è§ˆ"><a class="header-anchor" href="#æ¦‚è§ˆ">Â¶</a>æ¦‚è§ˆ</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysmon</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lock(&amp;sched.lock)<span class="comment">//åŠ é”</span></span><br><span class="line">	sched.nmsys++ <span class="comment">//æ•°é‡+1</span></span><br><span class="line">	checkdead() <span class="comment">//æ£€æŸ¥æ˜¯å¦dead</span></span><br><span class="line">	unlock(&amp;sched.lock) <span class="comment">//é‡Šæ”¾lock</span></span><br><span class="line"></span><br><span class="line">	lasttrace := <span class="keyword">int64</span>(<span class="number">0</span>)</span><br><span class="line">	idle := <span class="number">0</span> <span class="comment">// how many cycles in succession we had not wokeup somebody</span></span><br><span class="line">	delay := <span class="keyword">uint32</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span>&#123;</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-sysmon-1.png" alt=""></p>
<h3 id="å¾ªç¯å¹²ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#å¾ªç¯å¹²ä»€ä¹ˆï¼Ÿ">Â¶</a>å¾ªç¯å¹²ä»€ä¹ˆï¼Ÿ</h3>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201206_085755.png" alt=""></p>
<blockquote>
<p>ä¸€ä¸ªä¸ªè¿‡å§</p>
</blockquote>
<h4 id="è·å–ç³»ç»Ÿçš„çº³ç§’æ—¶é—´"><a class="header-anchor" href="#è·å–ç³»ç»Ÿçš„çº³ç§’æ—¶é—´">Â¶</a>è·å–ç³»ç»Ÿçš„çº³ç§’æ—¶é—´</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">now := nanotime()</span><br></pre></td></tr></table></figure>
<h4 id="timeSleepUntil"><a class="header-anchor" href="#timeSleepUntil">Â¶</a>timeSleepUntil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// timeSleepUntil returns the time when the next timer should fire,</span></span><br><span class="line"><span class="comment">// and the P that holds the timer heap that that timer is on.</span></span><br><span class="line"><span class="comment">// This is only called by sysmon and checkdead.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeSleepUntil</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, *p)</span></span> &#123;</span><br><span class="line">	next := <span class="keyword">int64</span>(maxWhen)</span><br><span class="line">	<span class="keyword">var</span> pret *p</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Prevent allp slice changes. This is like retake.</span></span><br><span class="line">	lock(&amp;allpLock)</span><br><span class="line">	<span class="keyword">for</span> _, pp := <span class="keyword">range</span> allp &#123;</span><br><span class="line">		<span class="keyword">if</span> pp == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// This can happen if procresize has grown</span></span><br><span class="line">			<span class="comment">// allp but not yet created new Ps.</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c := atomic.Load(&amp;pp.adjustTimers)</span><br><span class="line">		<span class="keyword">if</span> c == <span class="number">0</span> &#123;</span><br><span class="line">			w := <span class="keyword">int64</span>(atomic.Load64(&amp;pp.timer0When))</span><br><span class="line">			<span class="comment">//åˆ’é‡ç‚¹</span></span><br><span class="line">			<span class="keyword">if</span> w != <span class="number">0</span> &amp;&amp; w &lt; next &#123;</span><br><span class="line">				next = w</span><br><span class="line">				pret = pp</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		lock(&amp;pp.timersLock)</span><br><span class="line">		<span class="keyword">for</span> _, t := <span class="keyword">range</span> pp.timers &#123;</span><br><span class="line">			<span class="comment">//åˆ’é‡ç‚¹</span></span><br><span class="line">			<span class="keyword">switch</span> s := atomic.Load(&amp;t.status); s &#123;</span><br><span class="line">			<span class="keyword">case</span> timerWaiting:</span><br><span class="line">				<span class="keyword">if</span> t.when &lt; next &#123;</span><br><span class="line">					next = t.when</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">case</span> timerModifiedEarlier, timerModifiedLater:</span><br><span class="line">				<span class="keyword">if</span> t.nextwhen &lt; next &#123;</span><br><span class="line">					next = t.nextwhen</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> s == timerModifiedEarlier &#123;</span><br><span class="line">					c--</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// The timers are sorted, so we only have to check</span></span><br><span class="line">			<span class="comment">// the first timer for each P, unless there are</span></span><br><span class="line">			<span class="comment">// some timerModifiedEarlier timers. The number</span></span><br><span class="line">			<span class="comment">// of timerModifiedEarlier timers is in the adjustTimers</span></span><br><span class="line">			<span class="comment">// field, used to initialize c, above.</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="comment">// We don&#x27;t worry about cases like timerModifying.</span></span><br><span class="line">			<span class="comment">// New timers can show up at any time,</span></span><br><span class="line">			<span class="comment">// so this function is necessarily imprecise.</span></span><br><span class="line">			<span class="comment">// Do a signed check here since we aren&#x27;t</span></span><br><span class="line">			<span class="comment">// synchronizing the read of pp.adjustTimers</span></span><br><span class="line">			<span class="comment">// with the check of a timer status.</span></span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">int32</span>(c) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;pp.timersLock)</span><br><span class="line">	&#125;</span><br><span class="line">	unlock(&amp;allpLock)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> next, pret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="schedå’Œgomaxprocsåˆ¤æ–­ã€Œsleep-wakeupè¿‡ç¨‹ã€"><a class="header-anchor" href="#schedå’Œgomaxprocsåˆ¤æ–­ã€Œsleep-wakeupè¿‡ç¨‹ã€">Â¶</a>schedå’Œgomaxprocsåˆ¤æ–­ã€Œsleep&amp;wakeupè¿‡ç¨‹ã€</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åŒå±‚åˆ¤æ–­ï¼Œé˜²æ­¢åœ¨åŠ é”è¿™æ®µæ—¶é—´å€¼å‘ç”Ÿå˜åŒ–</span></span><br><span class="line"><span class="keyword">if</span> debug.schedtrace &lt;= <span class="number">0</span> &amp;&amp; (sched.gcwaiting != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="keyword">uint32</span>(gomaxprocs)) &#123;</span><br><span class="line">			lock(&amp;sched.lock)</span><br><span class="line">			<span class="keyword">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="keyword">uint32</span>(gomaxprocs) &#123;</span><br><span class="line">				<span class="keyword">if</span> next &gt; now &#123;</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">1</span>)</span><br><span class="line">					unlock(&amp;sched.lock)</span><br><span class="line">					<span class="comment">// Make wake-up period small enough</span></span><br><span class="line">					<span class="comment">// for the sampling to be correct.</span></span><br><span class="line">					sleep := forcegcperiod / <span class="number">2</span></span><br><span class="line">					<span class="keyword">if</span> next-now &lt; sleep &#123;</span><br><span class="line">						sleep = next - now</span><br><span class="line">					&#125;</span><br><span class="line">					shouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">true</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					notetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">false</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					now = nanotime()</span><br><span class="line">					next, _ = timeSleepUntil()</span><br><span class="line">					lock(&amp;sched.lock)</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">0</span>)</span><br><span class="line">					noteclear(&amp;sched.sysmonnote)</span><br><span class="line">				&#125;</span><br><span class="line">				idle = <span class="number">0</span></span><br><span class="line">				delay = <span class="number">20</span></span><br><span class="line">			&#125;</span><br><span class="line">			unlock(&amp;sched.lock)</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h4 id="poll-network"><a class="header-anchor" href="#poll-network">Â¶</a>poll network</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// poll network if not polled for more than 10ms</span></span><br><span class="line">lastpoll := <span class="keyword">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class="line"><span class="keyword">if</span> netpollinited() &amp;&amp; lastpoll != <span class="number">0</span> &amp;&amp; lastpoll+<span class="number">10</span>*<span class="number">1000</span>*<span class="number">1000</span> &lt; now &#123;</span><br><span class="line">	atomic.Cas64(&amp;sched.lastpoll, <span class="keyword">uint64</span>(lastpoll), <span class="keyword">uint64</span>(now))</span><br><span class="line">	list := netpoll(<span class="number">0</span>) <span class="comment">// non-blocking - returns list of goroutines</span></span><br><span class="line">	<span class="keyword">if</span> !list.empty() &#123;</span><br><span class="line">		<span class="comment">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class="line">		<span class="comment">// (pretending that one more is running) before injectglist.</span></span><br><span class="line">		<span class="comment">// Otherwise it can lead to the following situation:</span></span><br><span class="line">		<span class="comment">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class="line">		<span class="comment">// another M returns from syscall, finishes running its G,</span></span><br><span class="line">		<span class="comment">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class="line">		<span class="comment">// and reports deadlock.</span></span><br><span class="line">		incidlelocked(<span class="number">-1</span>)</span><br><span class="line">		injectglist(&amp;list)</span><br><span class="line">		incidlelocked(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> next &lt; now &#123;</span><br><span class="line">	<span class="comment">// There are timers that should have already run,</span></span><br><span class="line">	<span class="comment">// perhaps because there is an unpreemptible P.</span></span><br><span class="line">	<span class="comment">// Try to start an M to run them.</span></span><br><span class="line">	<span class="comment">//åˆ’é‡ç‚¹</span></span><br><span class="line">	startm(<span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="wakeScavenger"><a class="header-anchor" href="#wakeScavenger">Â¶</a>wakeScavenger</h4>
<blockquote>
<p>åˆ¤æ–­éœ€è¦å”¤é†’è¯·æ±‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class="number">0</span> &#123;</span><br><span class="line">	<span class="comment">// Kick the scavenger awake if someone requested it.</span></span><br><span class="line">	wakeScavenger()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// wakeScavenger immediately unparks the scavenger if necessary.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// May run without a P, but it may allocate, so it must not be called</span></span><br><span class="line"><span class="comment">// on any allocation path.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// mheap_.lock, scavenge.lock, and sched.lock must not be held.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wakeScavenger</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lock(&amp;scavenge.lock)</span><br><span class="line">	<span class="keyword">if</span> scavenge.parked &#123;</span><br><span class="line">		<span class="comment">// Notify sysmon that it shouldn&#x27;t bother waking up the scavenger.</span></span><br><span class="line">		atomic.Store(&amp;scavenge.sysmonWake, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Try to stop the timer but we don&#x27;t really care if we succeed.</span></span><br><span class="line">		<span class="comment">// It&#x27;s possible that either a timer was never started, or that</span></span><br><span class="line">		<span class="comment">// we&#x27;re racing with it.</span></span><br><span class="line">		<span class="comment">// In the case that we&#x27;re racing with there&#x27;s the low chance that</span></span><br><span class="line">		<span class="comment">// we experience a spurious wake-up of the scavenger, but that&#x27;s</span></span><br><span class="line">		<span class="comment">// totally safe.</span></span><br><span class="line">		stopTimer(scavenge.timer)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Unpark the goroutine and tell it that there may have been a pacing</span></span><br><span class="line">		<span class="comment">// change. Note that we skip the scheduler&#x27;s runnext slot because we</span></span><br><span class="line">		<span class="comment">// want to avoid having the scavenger interfere with the fair</span></span><br><span class="line">		<span class="comment">// scheduling of user goroutines. In effect, this schedules the</span></span><br><span class="line">		<span class="comment">// scavenger at a &quot;lower priority&quot; but that&#x27;s OK because it&#x27;ll</span></span><br><span class="line">		<span class="comment">// catch up on the work it missed when it does get scheduled.</span></span><br><span class="line">		scavenge.parked = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ready the goroutine by injecting it. We use injectglist instead</span></span><br><span class="line">		<span class="comment">// of ready or goready in order to allow us to run this function</span></span><br><span class="line">		<span class="comment">// without a P. injectglist also avoids placing the goroutine in</span></span><br><span class="line">		<span class="comment">// the current P&#x27;s runnext slot, which is desireable to prevent</span></span><br><span class="line">		<span class="comment">// the scavenger from interfering with user goroutine scheduling</span></span><br><span class="line">		<span class="comment">// too much.</span></span><br><span class="line">		<span class="keyword">var</span> list gList</span><br><span class="line">		list.push(scavenge.g)</span><br><span class="line">		injectglist(&amp;list)</span><br><span class="line">	&#125;</span><br><span class="line">	unlock(&amp;scavenge.lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="retakeå¤ºå–"><a class="header-anchor" href="#retakeå¤ºå–">Â¶</a>retakeå¤ºå–</h4>
<blockquote>
<p>å¤ºå–ç©ºé—²çš„P</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// retake P&#x27;s blocked in syscalls</span></span><br><span class="line"><span class="comment">// and preempt long running G&#x27;s</span></span><br><span class="line"><span class="keyword">if</span> retake(now) != <span class="number">0</span> &#123;</span><br><span class="line">	idle = <span class="number">0</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	idle++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GC-åˆ¤æ–­"><a class="header-anchor" href="#GC-åˆ¤æ–­">Â¶</a>GC åˆ¤æ–­</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// check if we need to force a GC</span></span><br><span class="line"><span class="comment">//åˆ’é‡ç‚¹ t.test()</span></span><br><span class="line"><span class="keyword">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class="number">0</span> &#123;</span><br><span class="line">	lock(&amp;forcegc.lock)</span><br><span class="line">	forcegc.idle = <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> list gList</span><br><span class="line">	list.push(forcegc.g)</span><br><span class="line">	injectglist(&amp;list)</span><br><span class="line">	unlock(&amp;forcegc.lock)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¾…ç»­â€¦"><a class="header-anchor" href="#å¾…ç»­â€¦">Â¶</a>å¾…ç»­â€¦</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ24ã€GPM newmå‡½æ•°</title>
    <url>/archives/b4edbd7.html</url>
    <content><![CDATA[<p>ä¸ŠèŠ‚çœ‹äº†goçš„å…¥å£å‡½æ•°ï¼Œï¼Œï¼Œä¹Ÿå°±æ˜¯ä½ æ‰§è¡Œmainå‡½æ•°å‰åæ‰€åšçš„å‡†å¤‡å·¥ä½œã€‚</p>
<p>ç»§ç»­æ·±å…¥å­¦ä¹ ã€‚ã€Œnewmã€ç¬¬ä¸€ä¸ªMï¼Œåˆ°åº•æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ</p>
<a id="more"></a>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h3 id="å…¥å£"><a class="header-anchor" href="#å…¥å£">Â¶</a>å…¥å£</h3>
<p>å…ˆçœ‹ä¸‹ä¸»ä½“ï¼Œä¸»è¦åœ¨Måˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œå¹²äº†whatï¼Œï¼Œï¼Œï¼Œï¼Œã€ŒPS : å…³é”®çœ‹å€¼å¾—å­¦ä¹ çš„ç‚¹ã€</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class="line"><span class="comment">// fn needs to be static and not a heap allocated closure.</span></span><br><span class="line"><span class="comment">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newm</span><span class="params">(fn <span class="keyword">func</span>()</span>, _<span class="title">p_</span> *<span class="title">p</span>)</span> &#123;</span><br><span class="line">  <span class="comment">//åˆ†é…å†…å­˜</span></span><br><span class="line">	mp := allocm(_p_, fn)</span><br><span class="line">  <span class="comment">//è®¾ç½®p</span></span><br><span class="line">	mp.nextp.set(_p_)</span><br><span class="line">  <span class="comment">//åˆå§‹åŒ–ä¿¡å·é‡</span></span><br><span class="line">	mp.sigmask = initSigmask</span><br><span class="line">  <span class="comment">//è·å–åˆ°gpåï¼Œåˆ¤æ–­M&amp;ï¼ˆç³»ç»Ÿé”å®šï½œï½œcgoæ‰§è¡Œä¸­ï¼‰ï¼›ï¼›ï¼›plan9çš„ç³»ç»Ÿè·³è¿‡ä¸‹é¢æ“ä½œ....</span></span><br><span class="line">	<span class="keyword">if</span> gp := getg(); gp != <span class="literal">nil</span> &amp;&amp; gp.m != <span class="literal">nil</span> &amp;&amp; (gp.m.lockedExt != <span class="number">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class="string">&quot;plan9&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class="line">		<span class="comment">// started by C. The kernel state of this thread may</span></span><br><span class="line">		<span class="comment">// be strange (the user may have locked it for that</span></span><br><span class="line">		<span class="comment">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class="line">		<span class="comment">// thread. Instead, ask a known-good thread to create</span></span><br><span class="line">		<span class="comment">// the thread for us.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class="line">		<span class="comment">// doesn&#x27;t model thread creation off fork.</span></span><br><span class="line">		lock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.haveTemplateThread == <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		mp.schedlink = newmHandoff.newm</span><br><span class="line">		newmHandoff.newm.set(mp)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.waiting &#123;</span><br><span class="line">			newmHandoff.waiting = <span class="literal">false</span></span><br><span class="line">			notewakeup(&amp;newmHandoff.wake)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//new m1æŒ‡ç¬¬ä¸€ä¸ªMçš„åˆ›å»ºè¿‡ç¨‹.</span></span><br><span class="line">	newm1(mp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="newm1"><a class="header-anchor" href="#newm1">Â¶</a>newm1</h3>
<blockquote>
<p>go to ã€Œnewm1ã€</p>
</blockquote>
<p>çœ‹èµ·æ¥å¾ˆç®€çŸ­</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newm1</span><span class="params">(mp *m)</span></span> &#123;</span><br><span class="line">  <span class="comment">//cgoç¨‹åºæ‰§è¡Œä¸­?</span></span><br><span class="line">	<span class="keyword">if</span> iscgo &#123;</span><br><span class="line">		<span class="keyword">var</span> ts cgothreadstart</span><br><span class="line">		<span class="keyword">if</span> _cgo_thread_start == <span class="literal">nil</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		ts.g.set(mp.g0)</span><br><span class="line">		ts.tls = (*<span class="keyword">uint64</span>)(unsafe.Pointer(&amp;mp.tls[<span class="number">0</span>]))</span><br><span class="line">		ts.fn = unsafe.Pointer(funcPC(mstart))</span><br><span class="line">		<span class="keyword">if</span> msanenabled &#123;</span><br><span class="line">			msanwrite(unsafe.Pointer(&amp;ts), unsafe.Sizeof(ts))</span><br><span class="line">		&#125;</span><br><span class="line">		execLock.rlock() <span class="comment">// Prevent process clone.</span></span><br><span class="line">		asmcgocall(_cgo_thread_start, unsafe.Pointer(&amp;ts))</span><br><span class="line">		execLock.runlock()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	execLock.rlock() <span class="comment">// Prevent process clone.</span></span><br><span class="line">  <span class="comment">//æ¶‰åŠåˆ°ç³»ç»Ÿè¿›ç¨‹åˆ›å»º</span></span><br><span class="line">	newosproc(mp)</span><br><span class="line">	execLock.runlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="newosproc"><a class="header-anchor" href="#newosproc">Â¶</a>newosproc</h3>
<blockquote>
<p>Måˆ›å»ºä¹‹å‰ï¼Œç³»ç»Ÿçš„æ“ä½œå’Œç›¸å…³åœ°å€çš„å˜åŒ–</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newosproc</span><span class="params">(mp *m)</span></span> &#123;</span><br><span class="line"><span class="comment">//è¿™ä¸ªstkæ“ä½œå¾ˆå¥‡æ€ªï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸‹....[çœ‹èµ·æ¥å•¥ä¹Ÿæ²¡å¹²é‚£]</span></span><br><span class="line">	stk := unsafe.Pointer(mp.g0.stack.hi)</span><br><span class="line">	<span class="keyword">if</span> <span class="literal">false</span> &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;newosproc stk=&quot;</span>, stk, <span class="string">&quot; m=&quot;</span>, mp, <span class="string">&quot; g=&quot;</span>, mp.g0, <span class="string">&quot; id=&quot;</span>, mp.id, <span class="string">&quot; ostk=&quot;</span>, &amp;mp, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize an attribute object.</span></span><br><span class="line">	<span class="keyword">var</span> attr pthreadattr</span><br><span class="line">	<span class="keyword">var</span> err <span class="keyword">int32</span></span><br><span class="line">  <span class="comment">//æ±‡ç¼–ï¼Œå˜é‡åˆå§‹åŒ–</span></span><br><span class="line">	err = pthread_attr_init(&amp;attr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="keyword">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find out OS stack size for our own stack guard.</span></span><br><span class="line">	<span class="keyword">var</span> stacksize <span class="keyword">uintptr</span></span><br><span class="line">	<span class="keyword">if</span> pthread_attr_getstacksize(&amp;attr, &amp;stacksize) != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="keyword">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//Må¯¹åº”çš„g0çš„é«˜ä½ç©ºé—´æ ˆåœ°å€</span></span><br><span class="line">	mp.g0.stack.hi = stacksize <span class="comment">// for mstart</span></span><br><span class="line">	<span class="comment">//mSysStatInc(&amp;memstats.stacks_sys, stacksize) //<span class="doctag">TODO:</span> do this?</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tell the pthread library we won&#x27;t join with this thread.</span></span><br><span class="line">	<span class="keyword">if</span> pthread_attr_setdetachstate(&amp;attr, _PTHREAD_CREATE_DETACHED) != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="keyword">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Finally, create the thread. It starts at mstart_stub, which does some low-level</span></span><br><span class="line">	<span class="comment">// setup and then calls mstart.</span></span><br><span class="line">	<span class="keyword">var</span> oset sigset</span><br><span class="line">  <span class="comment">//æ‰€æœ‰çš„maskåˆå§‹åŒ–</span></span><br><span class="line">	sigprocmask(_SIG_SETMASK, &amp;sigset_all, &amp;oset)</span><br><span class="line">	err = pthread_create(&amp;attr, funcPC(mstart_stub), unsafe.Pointer(mp))</span><br><span class="line">  <span class="comment">// osetåœ°å€ç½®nil</span></span><br><span class="line">	sigprocmask(_SIG_SETMASK, &amp;oset, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="keyword">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pthread-attr-initç»†èŠ‚"><a class="header-anchor" href="#pthread-attr-initç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L402">pthread_attr_initç»†èŠ‚</a></h4>
<blockquote>
<p>æ±‡ç¼–ä»£ç ï¼š</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TEXT runtimeÂ·pthread_attr_init_trampoline(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	MOVD	<span class="number">0</span>(R0), R0	<span class="comment">// arg 1 attr</span></span><br><span class="line">	BL	libc_pthread_attr_init(SB)</span><br><span class="line">	RET</span><br></pre></td></tr></table></figure>
<h4 id="pthread-attr-getstacksizeç»†èŠ‚"><a class="header-anchor" href="#pthread-attr-getstacksizeç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L407">pthread_attr_getstacksizeç»†èŠ‚</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TEXT runtimeÂ·pthread_attr_getstacksize_trampoline(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	MOVD	<span class="number">8</span>(R0), R1	<span class="comment">// arg 2 size</span></span><br><span class="line">	MOVD	<span class="number">0</span>(R0), R0	<span class="comment">// arg 1 attr</span></span><br><span class="line">	BL	libc_pthread_attr_getstacksize(SB)</span><br><span class="line">	RET</span><br></pre></td></tr></table></figure>
<h4 id="sigprocmask-trampolineç»†èŠ‚"><a class="header-anchor" href="#sigprocmask-trampolineç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L266">sigprocmask_trampolineç»†èŠ‚</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TEXT runtimeÂ·sigprocmask_trampoline(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	MOVD	<span class="number">8</span>(R0), R1	<span class="comment">// arg 2 new</span></span><br><span class="line">	MOVD	<span class="number">16</span>(R0), R2	<span class="comment">// arg 3 old</span></span><br><span class="line">	MOVW	<span class="number">0</span>(R0), R0	<span class="comment">// arg 1 how</span></span><br><span class="line">	BL	libc_pthread_sigmask(SB)</span><br><span class="line">	CMP	$<span class="number">0</span>, R0</span><br><span class="line">	BEQ	<span class="number">2</span>(PC)</span><br><span class="line">	BL	notok&lt;&gt;(SB)</span><br><span class="line">	RET</span><br></pre></td></tr></table></figure>
<h4 id="pthread-createç»†èŠ‚"><a class="header-anchor" href="#pthread-createç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L342">pthread_createç»†èŠ‚</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mstart_stub is the first function executed on a new thread started by pthread_create.</span></span><br><span class="line"><span class="comment">// It just does some low-level setup and then calls mstart.</span></span><br><span class="line"><span class="comment">// Note: called with the C calling convention.</span></span><br><span class="line">TEXT runtimeÂ·mstart_stub(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	<span class="comment">// DI points to the m.</span></span><br><span class="line">	<span class="comment">// We are already on m&#x27;s g0 stack.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save callee-save registers.</span></span><br><span class="line">	SUBQ	$<span class="number">40</span>, SP</span><br><span class="line">	MOVQ	BX, <span class="number">0</span>(SP)</span><br><span class="line">	MOVQ	R12, <span class="number">8</span>(SP)</span><br><span class="line">	MOVQ	R13, <span class="number">16</span>(SP)</span><br><span class="line">	MOVQ	R14, <span class="number">24</span>(SP)</span><br><span class="line">	MOVQ	R15, <span class="number">32</span>(SP)</span><br><span class="line"></span><br><span class="line">	MOVQ	m_g0(DI), DX <span class="comment">// g</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize TLS entry.</span></span><br><span class="line">	<span class="comment">// See cmd/link/internal/ld/sym.go:computeTLSOffset.</span></span><br><span class="line">	MOVQ	DX, <span class="number">0x30</span>(GS)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Someday the convention will be D is always cleared.</span></span><br><span class="line">	CLD</span><br><span class="line"></span><br><span class="line">	CALL	runtimeÂ·mstart(SB)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Restore callee-save registers.</span></span><br><span class="line">	MOVQ	<span class="number">0</span>(SP), BX</span><br><span class="line">	MOVQ	<span class="number">8</span>(SP), R12</span><br><span class="line">	MOVQ	<span class="number">16</span>(SP), R13</span><br><span class="line">	MOVQ	<span class="number">24</span>(SP), R14</span><br><span class="line">	MOVQ	<span class="number">32</span>(SP), R15</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Go is all done with this OS thread.</span></span><br><span class="line">	<span class="comment">// Tell pthread everything is ok (we never join with this thread, so</span></span><br><span class="line">	<span class="comment">// the value here doesn&#x27;t really matter).</span></span><br><span class="line">	XORL	AX, AX</span><br><span class="line"></span><br><span class="line">	ADDQ	$<span class="number">40</span>, SP</span><br><span class="line">	RET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="execLock-rlock"><a class="header-anchor" href="#execLock-rlock">Â¶</a>execLock.rlock()</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// rlock locks rw for reading.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *rwmutex)</span> <span class="title">rlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// The reader must not be allowed to lose its P or else other</span></span><br><span class="line">	<span class="comment">// things blocking on the lock may consume all of the Ps and</span></span><br><span class="line">	<span class="comment">// deadlock (issue #20903). Alternatively, we could drop the P</span></span><br><span class="line">	<span class="comment">// while sleeping.</span></span><br><span class="line">	acquirem()</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class="number">1</span>)) &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// A writer is pending. Park on the reader queue.</span></span><br><span class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			lockWithRank(&amp;rw.rLock, lockRankRwmutexR)</span><br><span class="line">			<span class="keyword">if</span> rw.readerPass &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// Writer finished.</span></span><br><span class="line">				rw.readerPass -= <span class="number">1</span></span><br><span class="line">				unlock(&amp;rw.rLock)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Queue this reader to be woken by</span></span><br><span class="line">				<span class="comment">// the writer.</span></span><br><span class="line">				m := getg().m</span><br><span class="line">				m.schedlink = rw.readers</span><br><span class="line">				rw.readers.set(m)</span><br><span class="line">				unlock(&amp;rw.rLock)</span><br><span class="line">				notesleep(&amp;m.park)</span><br><span class="line">				noteclear(&amp;m.park)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="acquirem"><a class="header-anchor" href="#acquirem">Â¶</a>acquirem()</h4>
<blockquote>
<p>åŠ é”è·å–M</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">acquirem</span><span class="params">()</span> *<span class="title">m</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line">	_g_.m.locks++</span><br><span class="line">	<span class="keyword">return</span> _g_.m</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="notesleep"><a class="header-anchor" href="#notesleep">Â¶</a>notesleep()</h4>
<blockquote>
<p>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯sleepæ˜¯ç”¨é˜Ÿåˆ—å®ç°,å‰ååŠ é”</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">notesleep</span><span class="params">(n *note)</span></span> &#123;</span><br><span class="line">	gp := getg()</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// Queued. Sleep.</span></span><br><span class="line">	gp.m.blocked = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">if</span> *cgo_yield == <span class="literal">nil</span> &#123;</span><br><span class="line">		semasleep(<span class="number">-1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.</span></span><br><span class="line">		<span class="keyword">const</span> ns = <span class="number">10e6</span></span><br><span class="line">		<span class="keyword">for</span> atomic.Loaduintptr(&amp;n.key) == <span class="number">0</span> &#123;</span><br><span class="line">			semasleep(ns)</span><br><span class="line">			asmcgocall(*cgo_yield, <span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	gp.m.blocked = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="execLock-runlock"><a class="header-anchor" href="#execLock-runlock">Â¶</a>execLock.runlock()</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// runlock undoes a single rlock call on rw.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *rwmutex)</span> <span class="title">runlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r := <span class="keyword">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class="number">-1</span>)); r &lt; <span class="number">0</span> &#123;</span><br><span class="line">		....</span><br><span class="line">	&#125;</span><br><span class="line">	releasem(getg().m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="releasem"><a class="header-anchor" href="#releasem">Â¶</a>releasem</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="comment">//lockæ•°é‡â–1ï¼Œæ¢å¤åˆ°preemptçš„çŠ¶æ€.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">releasem</span><span class="params">(mp *m)</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line">	mp.locks--</span><br><span class="line">	<span class="keyword">if</span> mp.locks == <span class="number">0</span> &amp;&amp; _g_.preempt &#123;</span><br><span class="line">		<span class="comment">// restore the preemption request in case we&#x27;ve cleared it in newstack</span></span><br><span class="line">		_g_.stackguard0 = stackPreempt</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆåˆ†æåˆ°è¿™å„¿å§â€¦å…³äºè¿™ä¸€èŠ‚çš„æµç¨‹å›¾ï¼Œä¼šæ•´ç†å‡ºæ¥çš„ï¼Œï¼Œï¼Œï¼Œ</p>
<p>ä¸ç„¶å°±ç™½åˆ†æè¿™ä¹ˆå¤šäº†ï¼ŒåŠæ—¶å­¦ä¹ ï¼ŒåŠæ—¶æ€»ç»“ã€‚</p>
<p>æ™šå®‰ğŸ˜´â€¦</p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ23ã€GPM mainå…¥å£å‡½æ•°</title>
    <url>/archives/9bb71eca.html</url>
    <content><![CDATA[<p>å‰é¢g0å’Œm0çæ‰¯äº†éƒ¨åˆ†çš„å…¥å£å’Œä¸€äº›å…³é”®çš„ç‚¹ã€‚</p>
<p>æœ¬æ¥åº”è¯¥æ‰¯æ‰¯sheduleè°ƒåº¦æ–¹é¢çš„çŸ¥è¯†ï¼Œä½†æ˜¯è¿™ä¸ªå…ˆå¾€åæ”¾ä¸€èŠ‚å§ï¼Œ</p>
<p>å…ˆå­¦ä¹ ä¸‹è¿™ä¸ªã€Œå…¥å£å‡½æ•°ã€ï¼Œæ¯•ç«Ÿå¯¹äºæ¯ä¸€ä¸ªé¡¹ç›®éƒ½ä¼šæœ‰ä¸€ä¸ªå…¥å£çš„ç›¸å…³é€»è¾‘ï¼Œé‚£ä¹ˆgoæºç æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</p>
<p>æœ‰æ²¡æœ‰ä»€ä¹ˆå¯ä»¥å€Ÿé‰´çš„å˜ï¼Ÿï¼</p>
<a id="more"></a>
<p>æ¥ä¸‹æ¥è¯¥åˆ°mainå‡½æ•°çš„ç›¸å…³å¤„ç†ã€‚</p>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h3 id="codeåˆ†æ"><a class="header-anchor" href="#codeåˆ†æ">Â¶</a>codeåˆ†æ</h3>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L113">mainå‡½æ•°å…¥å£</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// The main goroutine.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	g := getg()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.</span></span><br><span class="line">	<span class="comment">// It must not be used for anything else.</span></span><br><span class="line">	g.m.g0.racectx = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.</span></span><br><span class="line">	<span class="comment">// Using decimal instead of binary GB and MB because</span></span><br><span class="line">    <span class="comment">// they look nicer in the stack overflow failure message.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æœ€å¤§æ ˆç©ºé—´é™åˆ¶</span></span><br><span class="line">	<span class="keyword">if</span> sys.PtrSize == <span class="number">8</span> &#123;</span><br><span class="line">		maxstacksize = <span class="number">1000000000</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		maxstacksize = <span class="number">250000000</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow newproc to start new Ms.</span></span><br><span class="line">	mainStarted = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯wasmï¼Œå°±ä¸è¦è°ƒåº¦ç¨‹åºäº†.</span></span><br><span class="line">    <span class="keyword">if</span> GOARCH != <span class="string">&quot;wasm&quot;</span> &#123; <span class="comment">// no threads on wasm yet, so no sysmon</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//ç³»ç»Ÿæ ˆè°ƒç”¨</span></span><br><span class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// newmçš„å›è°ƒå‡½æ•°ï¼Œï¼Œï¼Œä¸€ä¸ªMä¸€ä¸ªsysmon P</span></span><br><span class="line">			newm(sysmon, <span class="literal">nil</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Lock the main goroutine onto this, the main OS thread,</span></span><br><span class="line">	<span class="comment">// during initialization. Most programs won&#x27;t care, but a few</span></span><br><span class="line">	<span class="comment">// do require certain calls to be made by the main thread.</span></span><br><span class="line">	<span class="comment">// Those can arrange for main.main to run in the main thread</span></span><br><span class="line">	<span class="comment">// by calling runtime.LockOSThread during initialization</span></span><br><span class="line">	<span class="comment">// to preserve the lock.</span></span><br><span class="line">	lockOSThread()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> g.m != &amp;m0 &#123;</span><br><span class="line">		throw(<span class="string">&quot;runtime.main not on m0&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	doInit(&amp;runtime_inittask) <span class="comment">// must be before defer</span></span><br><span class="line">	<span class="keyword">if</span> nanotime() == <span class="number">0</span> &#123;</span><br><span class="line">		throw(<span class="string">&quot;nanotime returning zero&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Defer unlock so that runtime.Goexit during init does the unlock too.</span></span><br><span class="line">	needUnlock := <span class="literal">true</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> needUnlock &#123;</span><br><span class="line">			unlockOSThread()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Record when the world started.</span></span><br><span class="line">	runtimeInitTime = nanotime()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨GC</span></span><br><span class="line">	gcenable()</span><br><span class="line"></span><br><span class="line">	main_init_done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">	<span class="keyword">if</span> iscgo &#123;</span><br><span class="line">		<span class="keyword">if</span> _cgo_thread_start == <span class="literal">nil</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> GOOS != <span class="string">&quot;windows&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> _cgo_setenv == <span class="literal">nil</span> &#123;</span><br><span class="line">				throw(<span class="string">&quot;_cgo_setenv missing&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> _cgo_unsetenv == <span class="literal">nil</span> &#123;</span><br><span class="line">				throw(<span class="string">&quot;_cgo_unsetenv missing&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> _cgo_notify_runtime_init_done == <span class="literal">nil</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;_cgo_notify_runtime_init_done missing&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Start the template thread in case we enter Go from</span></span><br><span class="line">		<span class="comment">// a C-created thread and need to create a new thread.</span></span><br><span class="line">		startTemplateThread()</span><br><span class="line">		cgocall(_cgo_notify_runtime_init_done, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	doInit(&amp;main_inittask)</span><br><span class="line"></span><br><span class="line">	<span class="built_in">close</span>(main_init_done)</span><br><span class="line"></span><br><span class="line">	needUnlock = <span class="literal">false</span></span><br><span class="line">	unlockOSThread()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isarchive || islibrary &#123;</span><br><span class="line">		<span class="comment">// A program compiled with -buildmode=c-archive or c-shared</span></span><br><span class="line">		<span class="comment">// has a main, but it is not executed.</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¯¹äºmainå‡½æ•°çš„å›è°ƒï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·å†™çš„mainç¨‹åº</span></span><br><span class="line">	fn := main_main <span class="comment">// make an indirect call, as the linker doesn&#x27;t know the address of the main package when laying down the runtime</span></span><br><span class="line">	fn()</span><br><span class="line">	<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">		racefini()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make racy client program work: if panicking on</span></span><br><span class="line">	<span class="comment">// another goroutine at the same time as main returns,</span></span><br><span class="line">	<span class="comment">// let the other goroutine finish printing the panic trace.</span></span><br><span class="line">    <span class="comment">// Once it does, it will exit. See issues 3934 and 20018.</span></span><br><span class="line">    <span class="comment">//åˆ¤æ–­panicDeferå‡½æ•°ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œ</span></span><br><span class="line">	<span class="keyword">if</span> atomic.Load(&amp;runningPanicDefers) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Running deferred functions should not take long.</span></span><br><span class="line">		<span class="keyword">for</span> c := <span class="number">0</span>; c &lt; <span class="number">1000</span>; c++ &#123;</span><br><span class="line">			<span class="keyword">if</span> atomic.Load(&amp;runningPanicDefers) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			Gosched()</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­panic</span></span><br><span class="line">	<span class="keyword">if</span> atomic.Load(&amp;panicking) != <span class="number">0</span> &#123;</span><br><span class="line">		gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonPanicWait, traceEvGoStop, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//æ­£å¸¸é€€å‡ºäº†é‚£.....</span></span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> x *<span class="keyword">int32</span></span><br><span class="line">		*x = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="systemstack"><a class="header-anchor" href="#systemstack">Â¶</a>systemstack</h3>
<blockquote>
<p>è¿™ä¸ªå‡½æ•°ï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿä¸­è¾ƒä¸ºé‡è¦ï¼Œæ¥çœ‹çœ‹å®˜æ–¹è¯´æ˜</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// systemstack runs fn on a system stack.</span></span><br><span class="line"><span class="comment">// If systemstack is called from the per-OS-thread (g0) stack, or</span></span><br><span class="line"><span class="comment">// if systemstack is called from the signal handling (gsignal) stack,</span></span><br><span class="line"><span class="comment">// systemstack calls fn directly and returns.</span></span><br><span class="line"><span class="comment">//g0 stackæˆ–è€…ä¿¡å·å¤„ç†çš„ï¼Œå°±ç›´æ¥è°ƒç”¨å¹¶è¿”å›ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Otherwise, systemstack is being called from the limited stack</span></span><br><span class="line"><span class="comment">// of an ordinary goroutine. In this case, systemstack switches</span></span><br><span class="line"><span class="comment">// to the per-OS-thread stack, calls fn, and switches back.</span></span><br><span class="line"><span class="comment">// It is common to use a func literal as the argument, in order</span></span><br><span class="line"><span class="comment">// to share inputs and outputs with the code around the call</span></span><br><span class="line"><span class="comment">// to system stack:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	... set up y ...</span></span><br><span class="line"><span class="comment">//	systemstack(func() &#123;</span></span><br><span class="line"><span class="comment">//		x = bigcall(y)</span></span><br><span class="line"><span class="comment">//	&#125;)</span></span><br><span class="line"><span class="comment">//	... use x ...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:noescape</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">systemstack</span><span class="params">(fn <span class="keyword">func</span>()</span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="newm"><a class="header-anchor" href="#newm">Â¶</a>newm</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class="line"><span class="comment">// fn needs to be static and not a heap allocated closure.</span></span><br><span class="line"><span class="comment">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨äºåˆ›å»ºæ–°çš„Mï¼Œfn:sysmonå‡½æ•°ï¼Œç±»ä¼¼äºäº‹ä»¶é©±åŠ¨ç±»å‹çš„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newm</span><span class="params">(fn <span class="keyword">func</span>()</span>, _<span class="title">p_</span> *<span class="title">p</span>)</span> &#123;</span><br><span class="line">	<span class="comment">//åˆ†é…å†…å­˜</span></span><br><span class="line">	mp := allocm(_p_, fn)</span><br><span class="line">	mp.nextp.set(_p_)</span><br><span class="line">	mp.sigmask = initSigmask</span><br><span class="line">	<span class="keyword">if</span> gp := getg(); gp != <span class="literal">nil</span> &amp;&amp; gp.m != <span class="literal">nil</span> &amp;&amp; (gp.m.lockedExt != <span class="number">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class="string">&quot;plan9&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class="line">		<span class="comment">// started by C. The kernel state of this thread may</span></span><br><span class="line">		<span class="comment">// be strange (the user may have locked it for that</span></span><br><span class="line">		<span class="comment">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class="line">		<span class="comment">// thread. Instead, ask a known-good thread to create</span></span><br><span class="line">		<span class="comment">// the thread for us.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class="line">		<span class="comment">// doesn&#x27;t model thread creation off fork.</span></span><br><span class="line">		lock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.haveTemplateThread == <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		mp.schedlink = newmHandoff.newm</span><br><span class="line">		newmHandoff.newm.set(mp)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.waiting &#123;</span><br><span class="line">			newmHandoff.waiting = <span class="literal">false</span></span><br><span class="line">			notewakeup(&amp;newmHandoff.wake)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	newm1(mp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªå‡½æ•°ï¼š</p>
</blockquote>
<ul>
<li>allocm</li>
<li>notewakeup</li>
<li>newm1</li>
</ul>
<h3 id="sysmon"><a class="header-anchor" href="#sysmon">Â¶</a>sysmon</h3>
<p>å­¦ä¹ ç³»ç»Ÿç›‘æ§ä¹‹å‰ï¼Œå…ˆå­¦ä¸‹éƒ¨åˆ†å‡½æ•°çš„ä½¿ç”¨å’Œå…¶å¤§æ¦‚å«ä¹‰ï¼š</p>
<ul>
<li>checkdead</li>
<li>usleep</li>
<li>timeSleepUntil</li>
<li>nanotime</li>
<li>netpollinited</li>
<li>startm</li>
<li>retake</li>
<li>gcTrigger</li>
<li>injectglist</li>
</ul>
<blockquote>
<p>å…ˆçœ‹ä¸‹ä¸»ä½“æµç¨‹</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Always runs without a P, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysmon</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lock(&amp;sched.lock)</span><br><span class="line">	sched.nmsys++</span><br><span class="line">	<span class="comment">//åŸºäºrunningä¸­çš„Mï¼Œæ£€æŸ¥æ­»é”ï¼Œï¼Œï¼Œï¼Œ</span></span><br><span class="line">	checkdead()</span><br><span class="line">	unlock(&amp;sched.lock)</span><br><span class="line"></span><br><span class="line">	lasttrace := <span class="keyword">int64</span>(<span class="number">0</span>)</span><br><span class="line">	idle := <span class="number">0</span> <span class="comment">// how many cycles in succession we had not wokeup somebody</span></span><br><span class="line">	delay := <span class="keyword">uint32</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> idle == <span class="number">0</span> &#123; <span class="comment">// start with 20us sleep...</span></span><br><span class="line">			delay = <span class="number">20</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> idle &gt; <span class="number">50</span> &#123; <span class="comment">// start doubling the sleep after 1ms...</span></span><br><span class="line">			delay *= <span class="number">2</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> delay &gt; <span class="number">10</span>*<span class="number">1000</span> &#123; <span class="comment">// up to 10ms</span></span><br><span class="line">			delay = <span class="number">10</span> * <span class="number">1000</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//ä¼‘çœ æ—¶é—´</span></span><br><span class="line">		usleep(delay)</span><br><span class="line">		<span class="comment">//è·å–æ—¶é—´</span></span><br><span class="line">		now := nanotime()</span><br><span class="line">		<span class="comment">// ä¼‘çœ ç­‰å¾…å”¤é†’ä¿¡å·</span></span><br><span class="line">		next, _ := timeSleepUntil()</span><br><span class="line">		<span class="keyword">if</span> debug.schedtrace &lt;= <span class="number">0</span> &amp;&amp; (sched.gcwaiting != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="keyword">uint32</span>(gomaxprocs)) &#123;</span><br><span class="line">			lock(&amp;sched.lock)</span><br><span class="line">			<span class="keyword">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="keyword">uint32</span>(gomaxprocs) &#123;</span><br><span class="line">				<span class="keyword">if</span> next &gt; now &#123;</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">1</span>)</span><br><span class="line">					unlock(&amp;sched.lock)</span><br><span class="line">					<span class="comment">// Make wake-up period small enough</span></span><br><span class="line">					<span class="comment">// for the sampling to be correct.</span></span><br><span class="line">					sleep := forcegcperiod / <span class="number">2</span></span><br><span class="line">					<span class="keyword">if</span> next-now &lt; sleep &#123;</span><br><span class="line">						sleep = next - now</span><br><span class="line">					&#125;</span><br><span class="line">					shouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">true</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					notetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">false</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					now = nanotime()</span><br><span class="line">					next, _ = timeSleepUntil()</span><br><span class="line">					lock(&amp;sched.lock)</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">0</span>)</span><br><span class="line">					noteclear(&amp;sched.sysmonnote)</span><br><span class="line">				&#125;</span><br><span class="line">				idle = <span class="number">0</span></span><br><span class="line">				delay = <span class="number">20</span></span><br><span class="line">			&#125;</span><br><span class="line">			unlock(&amp;sched.lock)</span><br><span class="line">		&#125;</span><br><span class="line">		lock(&amp;sched.sysmonlock)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If we spent a long time blocked on sysmonlock</span></span><br><span class="line">			<span class="comment">// then we want to update now and next since it&#x27;s</span></span><br><span class="line">			<span class="comment">// likely stale.</span></span><br><span class="line">			now1 := nanotime()</span><br><span class="line">			<span class="keyword">if</span> now1-now &gt; <span class="number">50</span>*<span class="number">1000</span> <span class="comment">/* 50Âµs */</span> &#123;</span><br><span class="line">				next, _ = timeSleepUntil()</span><br><span class="line">			&#125;</span><br><span class="line">			now = now1</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// trigger libc interceptors if needed</span></span><br><span class="line">		<span class="keyword">if</span> *cgo_yield != <span class="literal">nil</span> &#123;</span><br><span class="line">			asmcgocall(*cgo_yield, <span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// poll network if not polled for more than 10ms</span></span><br><span class="line">		<span class="comment">//åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦è¶…è¿‡10msï¼Œå°±ç»™äº¤ç»™globalæŠ¢æ¸¡äº†</span></span><br><span class="line">		lastpoll := <span class="keyword">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class="line">		<span class="keyword">if</span> netpollinited() &amp;&amp; lastpoll != <span class="number">0</span> &amp;&amp; lastpoll+<span class="number">10</span>*<span class="number">1000</span>*<span class="number">1000</span> &lt; now &#123;</span><br><span class="line">			atomic.Cas64(&amp;sched.lastpoll, <span class="keyword">uint64</span>(lastpoll), <span class="keyword">uint64</span>(now))</span><br><span class="line">			list := netpoll(<span class="number">0</span>) <span class="comment">// non-blocking - returns list of goroutines</span></span><br><span class="line">			<span class="keyword">if</span> !list.empty() &#123;</span><br><span class="line">				<span class="comment">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class="line">				<span class="comment">// (pretending that one more is running) before injectglist.</span></span><br><span class="line">				<span class="comment">// Otherwise it can lead to the following situation:</span></span><br><span class="line">				<span class="comment">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class="line">				<span class="comment">// another M returns from syscall, finishes running its G,</span></span><br><span class="line">				<span class="comment">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class="line">				<span class="comment">// and reports deadlock.</span></span><br><span class="line">				incidlelocked(<span class="number">-1</span>)</span><br><span class="line">				<span class="comment">//æ³¨å…¥å…¨å±€gé˜Ÿåˆ—ä¸­</span></span><br><span class="line">				injectglist(&amp;list)</span><br><span class="line">				incidlelocked(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> next &lt; now &#123;</span><br><span class="line">			<span class="comment">// There are timers that should have already run,</span></span><br><span class="line">			<span class="comment">// perhaps because there is an unpreemptible P.</span></span><br><span class="line">			<span class="comment">// Try to start an M to run them.</span></span><br><span class="line">			<span class="comment">//éœ€è¦ä¸€ä¸ªæ–°çš„Mæ¥è·‘Pä¸Šé¢çš„Gã€‚</span></span><br><span class="line">			startm(<span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">// Kick the scavenger awake if someone requested it.</span></span><br><span class="line">			wakeScavenger()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// retake P&#x27;s blocked in syscalls</span></span><br><span class="line">		<span class="comment">// and preempt long running G&#x27;s</span></span><br><span class="line">		<span class="comment">// å¾ªç¯æ‰€æœ‰çš„allpï¼Œè¿›è¡ŒæŠ¢å¤ºã€‚</span></span><br><span class="line">		<span class="keyword">if</span> retake(now) != <span class="number">0</span> &#123;</span><br><span class="line">			idle = <span class="number">0</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			idle++</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// check if we need to force a GC</span></span><br><span class="line">		<span class="comment">//å¼ºè¡ŒGC</span></span><br><span class="line">		<span class="keyword">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class="number">0</span> &#123;</span><br><span class="line">			lock(&amp;forcegc.lock)</span><br><span class="line">			forcegc.idle = <span class="number">0</span></span><br><span class="line">			<span class="keyword">var</span> list gList</span><br><span class="line">			list.push(forcegc.g)</span><br><span class="line">			injectglist(&amp;list)</span><br><span class="line">			unlock(&amp;forcegc.lock)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> debug.schedtrace &gt; <span class="number">0</span> &amp;&amp; lasttrace+<span class="keyword">int64</span>(debug.schedtrace)*<span class="number">1000000</span> &lt;= now &#123;</span><br><span class="line">			lasttrace = now</span><br><span class="line">			schedtrace(debug.scheddetail &gt; <span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;sched.sysmonlock)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="doInit"><a class="header-anchor" href="#doInit">Â¶</a>doInit</h3>
<blockquote>
<p>è¿™ä¸€éƒ¨åˆ†åœ¨æºç çœ‹æ¥ï¼Œæ²¡æœ‰å…·ä½“çš„ä½œç”¨ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œtodoæ ‡ç­¾å§ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doInit</span><span class="params">(t *initTask)</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> t.state &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// fully initialized</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// initialization in progress</span></span><br><span class="line">		throw(<span class="string">&quot;recursive call during initialization - linker skew&quot;</span>)</span><br><span class="line">	<span class="keyword">default</span>: <span class="comment">// not initialized yet</span></span><br><span class="line">		t.state = <span class="number">1</span> <span class="comment">// initialization in progress</span></span><br><span class="line">		<span class="keyword">for</span> i := <span class="keyword">uintptr</span>(<span class="number">0</span>); i &lt; t.ndeps; i++ &#123;</span><br><span class="line">			p := add(unsafe.Pointer(t), (<span class="number">3</span>+i)*sys.PtrSize)</span><br><span class="line">			t2 := *(**initTask)(p)</span><br><span class="line">			doInit(t2)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="keyword">uintptr</span>(<span class="number">0</span>); i &lt; t.nfns; i++ &#123;</span><br><span class="line">			p := add(unsafe.Pointer(t), (<span class="number">3</span>+t.ndeps+i)*sys.PtrSize)</span><br><span class="line">			f := *(*<span class="function"><span class="keyword">func</span><span class="params">()</span>)<span class="params">(unsafe.Pointer(&amp;p)</span>)</span></span><br><span class="line">			f()</span><br><span class="line">		&#125;</span><br><span class="line">		t.state = <span class="number">2</span> <span class="comment">// initialization done</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gcenable"><a class="header-anchor" href="#gcenable">Â¶</a>gcenable</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gcenable is called after the bulk of the runtime initialization,</span></span><br><span class="line"><span class="comment">// just before we&#x27;re about to start letting user code run.</span></span><br><span class="line"><span class="comment">// It kicks off the background sweeper goroutine, the background</span></span><br><span class="line"><span class="comment">// scavenger goroutine, and enables GC.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gcenable</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Kick off sweeping and scavenging.</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> bgsweep(c)</span><br><span class="line">	<span class="keyword">go</span> bgscavenge(c)</span><br><span class="line">	&lt;-c</span><br><span class="line">	&lt;-c</span><br><span class="line">	memstats.enablegc = <span class="literal">true</span> <span class="comment">// now that runtime is initialized, GC is okay</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Gosched"><a class="header-anchor" href="#Gosched">Â¶</a>Gosched</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Gosched yields the processor, allowing other goroutines to run. It does not</span></span><br><span class="line"><span class="comment">// suspend the current goroutine, so execution resumes automatically.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Gosched</span><span class="params">()</span></span> &#123;</span><br><span class="line">	checkTimeouts()</span><br><span class="line">	mcall(gosched_m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gopark"><a class="header-anchor" href="#gopark">Â¶</a>gopark</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Puts the current goroutine into a waiting state and calls unlockf.</span></span><br><span class="line"><span class="comment">// If unlockf returns false, the goroutine is resumed.</span></span><br><span class="line"><span class="comment">// unlockf must not access this G&#x27;s stack, as it may be moved between</span></span><br><span class="line"><span class="comment">// the call to gopark and the call to unlockf.</span></span><br><span class="line"><span class="comment">// Reason explains why the goroutine has been parked.</span></span><br><span class="line"><span class="comment">// It is displayed in stack traces and heap dumps.</span></span><br><span class="line"><span class="comment">// Reasons should be unique and descriptive.</span></span><br><span class="line"><span class="comment">// Do not re-use reasons, add new ones.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gopark</span><span class="params">(unlockf <span class="keyword">func</span>(*g, unsafe.Pointer)</span> <span class="title">bool</span>, <span class="title">lock</span> <span class="title">unsafe</span>.<span class="title">Pointer</span>, <span class="title">reason</span> <span class="title">waitReason</span>, <span class="title">traceEv</span> <span class="title">byte</span>, <span class="title">traceskip</span> <span class="title">int</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> reason != waitReasonSleep &#123;</span><br><span class="line">		checkTimeouts() <span class="comment">// timeouts may expire while two goroutines keep the scheduler busy</span></span><br><span class="line">	&#125;</span><br><span class="line">	mp := acquirem()</span><br><span class="line">	gp := mp.curg</span><br><span class="line">	status := readgstatus(gp)</span><br><span class="line">	<span class="keyword">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;</span><br><span class="line">		throw(<span class="string">&quot;gopark: bad g status&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	mp.waitlock = lock</span><br><span class="line">	mp.waitunlockf = unlockf</span><br><span class="line">	gp.waitreason = reason</span><br><span class="line">	mp.waittraceev = traceEv</span><br><span class="line">	mp.waittraceskip = traceskip</span><br><span class="line">	<span class="comment">//mpè§£ç»‘</span></span><br><span class="line">	releasem(mp)</span><br><span class="line">	<span class="comment">// can&#x27;t do anything that might move the G between Ms here.</span></span><br><span class="line">	mcall(park_m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åç»­"><a class="header-anchor" href="#åç»­">Â¶</a>åç»­</h3>
<blockquote>
<p>å…³äºé‡Œé¢çš„é‡è¦éƒ¨åˆ†å®ç°ç»†èŠ‚ï¼Œä¸æ˜¯æœ¬æ¬¡å…³æ³¨çš„é‡ç‚¹ï¼Œï¼Œï¼Œï¼Œ</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">è¿™æ¬¡ä¸»è¦çœ‹åˆ°çš„æ˜¯Goå›´ç»•mainå‡½æ•°ï¼Œä¸ºäº†ç¨‹åºçš„æ­£å¸¸å¯åŠ¨ï¼Œæ‰€åšçš„å·¥ä½œ.</span><br><span class="line"></span><br><span class="line">æ— è®ºæ˜¯gçš„å¯åŠ¨è¿˜æ˜¯è°ƒåº¦ç›‘æ§æ–¹é¢ï¼Œä¹Ÿå°±æ˜¯ä»æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥è€ƒè™‘ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯å…³äºpanicçš„å¤„ç†ï¼Œé‡‡ç”¨äº‹ä»¶é©±åŠ¨çš„æ–¹å¼ï¼Œå¾ˆå¥½çš„è·å–åˆ°panic,è¿›è¡Œåç»­çš„å¤„ç†ã€‚</span><br><span class="line"></span><br><span class="line">æœ€åè¿˜æœ‰ä¸€ä¸ªå…³äºå…¨å±€locktrheadï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œç²’åº¦å°½é‡ç»†å°ï¼Œæœ‰åˆ©äºæé«˜æ€§èƒ½ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ22ã€GPM g0å’Œm0</title>
    <url>/archives/392d66f0.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>GPMç®—æ˜¯ç»å…¸çš„è°ƒåº¦æ¨¡å‹ï¼Œä½†æ˜¯æ¯ä¸ªç¨‹åºéƒ½éœ€è¦ä¸€ä¸ªå¯åŠ¨çš„å‡½æ•°æˆ–è€…å…¥å£ï¼›<br>
GPMä¹Ÿä¸ä¾‹å¤–ã€‚<br>
ç›´æ¥åˆ†ææºç ï¼Œæ˜¾å¾—å¾ˆæ¯ç‡¥ï¼Œå¦‚æœè¯´è¦ä½ è®¾è®¡GPMä¸­çš„Gå’ŒMçš„æ‰§è¡Œå…³ç³»ï¼Œä½ åº”è¯¥æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿ</p>
<a id="more"></a>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h3 id="å°è¯•è®¾è®¡"><a class="header-anchor" href="#å°è¯•è®¾è®¡">Â¶</a>å°è¯•è®¾è®¡</h3>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182201.png" alt=""><br>
å¦‚æœåªæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£æ€»ä½“çš„Gå’ŒMæ˜¯å¦éœ€è¦ç®¡ç†è€…ï¼Œæ¯•ç«Ÿåœ¨1.1ç‰ˆæœ¬ä¹‹å‰åªæœ‰GMæ¨¡å‹ï¼Œï¼Œï¼Œ<br>
é‚£ä¹ˆä¸ºäº†å¥½ç®¡ç†Må’ŒGï¼Œå°±éœ€è¦ç¬¬ä¸€ä¸ªMå’ŒGæˆä¸ºç®¡ç†è€…ï¼Œç±»ä¼¼äºå¤§æ€»ç®¡è¿™æ ·çš„å­˜åœ¨ã€‚</p>
<h3 id="å†æ¬¡è®¾è®¡"><a class="header-anchor" href="#å†æ¬¡è®¾è®¡">Â¶</a>å†æ¬¡è®¾è®¡</h3>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182219.png" alt=""></p>
<h3 id="å…³é”®ç‚¹ï¼š"><a class="header-anchor" href="#å…³é”®ç‚¹ï¼š">Â¶</a>å…³é”®ç‚¹ï¼š</h3>
<ul>
<li>på…ˆå¯åŠ¨</li>
<li>g0çš„åˆ›å»ºï¼›ç”¨äºåˆ›å»ºæ–°çš„G</li>
<li>m0çš„åˆ›å»ºï¼›ç”¨äºåˆ›å»ºæ–°çš„M</li>
<li>å¯åŠ¨mainè°ƒåº¦æ•´ä¸ªç³»ç»Ÿ</li>
</ul>
<blockquote>
<p>ä¸Šè¿°è¿™æ ·æ¯”è¾ƒåˆç†ç‚¹ã€‚</p>
</blockquote>
<h3 id="Goæºç çš„å¦‚ä½•å®ç°ï¼Ÿ"><a class="header-anchor" href="#Goæºç çš„å¦‚ä½•å®ç°ï¼Ÿ">Â¶</a>Goæºç çš„å¦‚ä½•å®ç°ï¼Ÿ</h3>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L524">bootstrap sequence</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The bootstrap sequence is:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	call osinit</span></span><br><span class="line"><span class="comment">//	call schedinit</span></span><br><span class="line"><span class="comment">//	make &amp; queue new G</span></span><br><span class="line"><span class="comment">//	call runtimeÂ·mstart</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The new G calls runtimeÂ·main.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L194">g0å’Œm0åˆå§‹åŒ–è¿‡ç¨‹</a></p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="comment">// set the per-goroutine and per-mach &quot;registers&quot;</span></span><br><span class="line">	get_tls(BX)</span><br><span class="line">	LEAQ	runtimeÂ·g0(SB), CX</span><br><span class="line">	MOVQ	CX, g(BX)</span><br><span class="line">	LEAQ	runtimeÂ·m0(SB), AX</span><br><span class="line"></span><br><span class="line">	<span class="comment">// save m-&gt;g0 = g0</span></span><br><span class="line">	MOVQ	CX, m_g0(AX)</span><br><span class="line">	<span class="comment">// save m0 to g0-&gt;m</span></span><br><span class="line">	MOVQ	AX, g_m(CX)</span><br><span class="line"></span><br><span class="line">	CLD				<span class="comment">// convention is D is always left cleared</span></span><br><span class="line">	CALL	runtimeÂ·check(SB)</span><br><span class="line"></span><br><span class="line">	MOVL	<span class="number">16</span>(SP), AX		<span class="comment">// copy argc</span></span><br><span class="line">	MOVL	AX, <span class="number">0</span>(SP)</span><br><span class="line">	MOVQ	<span class="number">24</span>(SP), AX		<span class="comment">// copy argv</span></span><br><span class="line">	MOVQ	AX, <span class="number">8</span>(SP)</span><br><span class="line">	CALL	runtimeÂ·args(SB)</span><br><span class="line">	CALL	runtimeÂ·osinit(SB)</span><br><span class="line">	CALL	runtimeÂ·schedinit(SB)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create a new goroutine to start program</span></span><br><span class="line">	MOVQ	$runtimeÂ·mainPC(SB), AX		<span class="comment">// entry</span></span><br><span class="line">	PUSHQ	AX</span><br><span class="line">	PUSHQ	$<span class="number">0</span>			<span class="comment">// arg size</span></span><br><span class="line">	CALL	runtimeÂ·newproc(SB)</span><br><span class="line">	POPQ	AX</span><br><span class="line">	POPQ	AX</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start this M</span></span><br><span class="line">	CALL	runtimeÂ·mstart(SB)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åˆ°è¿™é‡Œäº†ï¼Œåˆå§‹åŒ–æ€è·¯åŸºæœ¬ç¡®å®šäº†</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€initP</span><br><span class="line">2ã€m0å’Œg0çš„ç»‘å®š</span><br><span class="line">3ã€new groutine for mainä¸»çº¿ç¨‹å¯åŠ¨</span><br><span class="line">4ã€mstart</span><br></pre></td></tr></table></figure>
<h3 id="m-initæ¶‰åŠåˆ°çš„å‡½æ•°"><a class="header-anchor" href="#m-initæ¶‰åŠåˆ°çš„å‡½æ•°">Â¶</a>m initæ¶‰åŠåˆ°çš„å‡½æ•°</h3>
<ul>
<li>mstart</li>
<li>mstart1</li>
<li>mstartm0</li>
</ul>
<h4 id="mstart"><a class="header-anchor" href="#mstart">Â¶</a>mstart</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mstart is the entry-point for new Ms.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This must not split the stack because we may not even have stack</span></span><br><span class="line"><span class="comment">// bounds set up yet.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// May run during STW (because it doesn&#x27;t have a P yet), so write</span></span><br><span class="line"><span class="comment">// barriers are not allowed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mstart</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä½ä½åˆ¤æ–­</span></span><br><span class="line">	osStack := _g_.stack.lo == <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> osStack &#123;</span><br><span class="line">		<span class="comment">// Initialize stack bounds from system stack.</span></span><br><span class="line">		<span class="comment">// Cgo may have left stack size in stack.hi.</span></span><br><span class="line">		<span class="comment">// minit may update the stack bounds.</span></span><br><span class="line">		size := _g_.stack.hi</span><br><span class="line">		<span class="keyword">if</span> size == <span class="number">0</span> &#123;</span><br><span class="line">			size = <span class="number">8192</span> * sys.StackGuardMultiplier</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//g0çš„stackç©ºé—´æ˜¯çœŸçš„å¤§</span></span><br><span class="line">		_g_.stack.hi = <span class="keyword">uintptr</span>(noescape(unsafe.Pointer(&amp;size)))</span><br><span class="line">		_g_.stack.lo = _g_.stack.hi - size + <span class="number">1024</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Initialize stack guard so that we can start calling regular</span></span><br><span class="line">	<span class="comment">// Go code.</span></span><br><span class="line">	_g_.stackguard0 = _g_.stack.lo + _StackGuard</span><br><span class="line">	<span class="comment">// This is the g0, so we can also call go:systemstack</span></span><br><span class="line">	<span class="comment">// functions, which check stackguard1.</span></span><br><span class="line">	_g_.stackguard1 = _g_.stackguard0</span><br><span class="line">	mstart1()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Exit this thread.</span></span><br><span class="line">	<span class="keyword">switch</span> GOOS &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;windows&quot;</span>, <span class="string">&quot;solaris&quot;</span>, <span class="string">&quot;illumos&quot;</span>, <span class="string">&quot;plan9&quot;</span>, <span class="string">&quot;darwin&quot;</span>, <span class="string">&quot;aix&quot;</span>:</span><br><span class="line">		<span class="comment">// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate</span></span><br><span class="line">		<span class="comment">// the stack, but put it in _g_.stack before mstart,</span></span><br><span class="line">		<span class="comment">// so the logic above hasn&#x27;t set osStack yet.</span></span><br><span class="line">		osStack = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	mexit(osStack)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mstart1"><a class="header-anchor" href="#mstart1">Â¶</a>mstart1</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mstart1</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨ég0å°±å´©ç›˜äº†</span></span><br><span class="line">	<span class="keyword">if</span> _g_ != _g_.m.g0 &#123;</span><br><span class="line">		throw(<span class="string">&quot;bad runtimeÂ·mstart&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	<span class="comment">// Record the caller for use as the top of stack in mcall and</span></span><br><span class="line">	<span class="comment">// for terminating the thread.</span></span><br><span class="line">	<span class="comment">// We&#x27;re never coming back to mstart1 after we call schedule,</span></span><br><span class="line">	<span class="comment">// so other calls can reuse the current frame.</span></span><br><span class="line">	save(getcallerpc(), getcallersp())</span><br><span class="line">	asminit()</span><br><span class="line">	minit()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Install signal handlers; after minit so that minit can</span></span><br><span class="line">    <span class="comment">// prepare the thread to be able to handle the signals.</span></span><br><span class="line">    <span class="comment">//m0å¯åŠ¨</span></span><br><span class="line">	<span class="keyword">if</span> _g_.m == &amp;m0 &#123;</span><br><span class="line">		mstartm0()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> fn := _g_.m.mstartfn; fn != <span class="literal">nil</span> &#123;</span><br><span class="line">		fn()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _g_.m != &amp;m0 &#123;</span><br><span class="line">		acquirep(_g_.m.nextp.ptr())</span><br><span class="line">		_g_.m.nextp = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¼€å§‹è°ƒåº¦</span></span><br><span class="line">	schedule()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mstartm0"><a class="header-anchor" href="#mstartm0">Â¶</a>mstartm0</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mstart1çš„å…·ä½“å®ç°ï¼Œä»…runåœ¨m0ä¸Š</span></span><br><span class="line"><span class="comment">// mstartm0 implements part of mstart1 that only runs on the m0.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Write barriers are allowed here because we know the GC can&#x27;t be</span></span><br><span class="line"><span class="comment">// running yet, so they&#x27;ll be no-ops.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:yeswritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mstartm0</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create an extra M for callbacks on threads not created by Go.</span></span><br><span class="line">	<span class="comment">// An extra M is also needed on Windows for callbacks created by</span></span><br><span class="line">    <span class="comment">// syscall.NewCallback. See issue #6751 for details.</span></span><br><span class="line">    <span class="comment">//windowsä¸‹éœ€è¦ä¸€ä¸ªé¢å¤–çš„M</span></span><br><span class="line">	<span class="keyword">if</span> (iscgo || GOOS == <span class="string">&quot;windows&quot;</span>) &amp;&amp; !cgoHasExtraM &#123;</span><br><span class="line">		cgoHasExtraM = <span class="literal">true</span></span><br><span class="line">		newextram()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ä¿¡å·é‡,ç”¨äºåç»­è°ƒåº¦</span></span><br><span class="line">	initsig(<span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åç»­scheduleå‡½æ•°"><a class="header-anchor" href="#åç»­scheduleå‡½æ•°">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L1119">åç»­scheduleå‡½æ•°</a></h4>
<blockquote>
<p>ç®¡å®¶æœ‰äº†ï¼Œé‚£ä¹ˆå¼€å§‹è°ƒåº¦å§â€¦ã€‚</p>
</blockquote>
<h3 id="ä¸‹èŠ‚ï¼š"><a class="header-anchor" href="#ä¸‹èŠ‚ï¼š">Â¶</a>ä¸‹èŠ‚ï¼š</h3>
<ul>
<li>schedule</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ21ã€linux selectæºç </title>
    <url>/archives/ba7b70bf.html</url>
    <content><![CDATA[<blockquote>
<p>select poll epollä¸‰ä¸ªè€ç”Ÿé•¿è°ˆçš„é—®é¢˜.è¿™æ¬¡ä¸æ˜¯æ¥è®²åŒºåˆ«çš„ï¼Œåç»­ä¼šæ›´æ–°ä¸€ç¯‡å…³äºä¸‰è€…åŒºåˆ«çš„ã€‚</p>
</blockquote>
<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>selectå±äºlinuxç³»åˆ—çš„æ–‡ä»¶ç³»ç»Ÿã€Œfsã€çš„èŒƒç•´ï¼Œæ¯æ¬¡çš„ç³»ç»Ÿè°ƒç”¨ã€æ‰“å¼€è½¯ä»¶ã€å¯åŠ¨ç¨‹åºç­‰ç­‰éƒ½ä¼šæ¶‰åŠåˆ°æ–‡ä»¶çš„è¯»å†™ï¼Œ<br>
è¿™ä¸ªæ˜¯åœ¨æ‰€éš¾å…çš„ã€‚</p>
<p>é‚£ä¹ˆI/Oäº‹ä»¶çš„åŸºæœ¬æ€è·¯ï¼šæ–‡ä»¶å‡†å¤‡okï¼Œå¼€å§‹è¯»å†™ï¼Œç­‰å‡½æ•°è¿”å›ï¼Œæ ¹æ®ç»“æœç»§ç»­è¿è¡Œ.</p>
<p>å¦‚æœæ˜¯è‡ªå·±å®ç°ï¼Œå¤§ä½“ä¸Šæ— éä»¥ä¸‹æ€è·¯ï¼š</p>
<a id="more"></a>
<ul>
<li>åˆ›å»ºå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹æ¥ç›‘å¬</li>
<li>Non-blockingè¯»å†™ç›‘å¬çš„è½®è¯¢</li>
<li>å¼‚æ­¥I/Oä¸Unix Signaläº‹ä»¶æœºåˆ¶</li>
</ul>
<p>å…ˆæ¥å­¦ä¹ ä¸‹linuxæºç æ˜¯æ€ä¹ˆå¤„ç†selectæœºåˆ¶çš„ï¼š</p>
<blockquote>
<p>linux version: 5.10-r5</p>
</blockquote>
<h3 id="æ¦‚è§ˆå›¾"><a class="header-anchor" href="#æ¦‚è§ˆå›¾">Â¶</a>æ¦‚è§ˆå›¾</h3>
<p>æ¢³ç†äº†ä¸‹ï¼Œå¤§æ¦‚æ•´ç†æˆäº†æµç¨‹å›¾ï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/linux%E6%BA%90%E7%A0%81-select-1.png" alt=""></p>
<h3 id="selectåˆ‡å…¥ç‚¹"><a class="header-anchor" href="#selectåˆ‡å…¥ç‚¹">Â¶</a>selectåˆ‡å…¥ç‚¹</h3>
<p>æ—¢ç„¶çŸ¥é“äº†selectå±äºfsç³»åˆ—çš„ï¼Œé‚£å°±å¾ˆå®¹æ˜“æ‰¾åˆ°:[fs/select.c]</p>
<p>æŸ¥çœ‹selectå‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">man 2 select</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ¥è§£è¯»ï¼Œä¸€èµ·å­¦ä¹ ï¼š</p>
<ul>
<li>å…¥å£ SYSCALL_DEFINE5</li>
<li>æ ¸å¿ƒå‡½æ•° do_select</li>
<li>è®¾å¤‡é©±åŠ¨çš„æ“ä½œå‡½æ•°</li>
<li>poll_waitä¸è®¾å¤‡çš„ç­‰å¾…é˜Ÿåˆ—</li>
<li>fdæ•°é‡é™åˆ¶ã€Œwhyã€</li>
<li>selectä¸poll</li>
</ul>
<h3 id="SYSCALL-DEFINE5"><a class="header-anchor" href="#SYSCALL-DEFINE5">Â¶</a>SYSCALL_DEFINE5</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE5(select, <span class="keyword">int</span>, n, fd_set __user *, inp, fd_set __user *, outp,</span><br><span class="line">		fd_set __user *, <span class="built_in">exp</span>, struct __kernel_old_timeval __user *, tvp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> kern_select(n, inp, outp, <span class="built_in">exp</span>, tvp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å‡½æ•°ï¼šcore_sys_selectä¸­ä¸»è¦çš„do_selectå¤„ç†å…¶ä¸­çš„é€»è¾‘</p>
<h3 id="do-select"><a class="header-anchor" href="#do-select">Â¶</a>do_select</h3>
<p>å…³é”®æ€§çš„ç»“æ„ä½“</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *in, *out, *ex; <span class="comment">//è¾“å‡º ã€è¾“å…¥ã€å¼‚å¸¸</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *res_in, *res_out, *res_ex;</span><br><span class="line">&#125; fd_set_bits;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_select</span><span class="params">(<span class="keyword">int</span> n, fd_set_bits *fds, struct timespec64 *end_time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">ktime_t</span> expire, *to = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">poll_wqueues</span> <span class="title">table</span>;</span></span><br><span class="line">	poll_table *wait;</span><br><span class="line">	<span class="keyword">int</span> retval, i, timed_out = <span class="number">0</span>;</span><br><span class="line">	u64 slack = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">__poll_t</span> busy_flag = net_busy_loop_on() ? POLL_BUSY_LOOP : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> busy_start = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">    <span class="comment">//æ‰¾å‡ºæ–‡ä»¶çš„æœ€å¤§æè¿°ç¬¦</span></span><br><span class="line">	retval = max_select_fd(n, fds);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	n = retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	poll_initwait(&amp;table);</span><br><span class="line">	wait = &amp;table.pt;</span><br><span class="line">	<span class="keyword">if</span> (end_time &amp;&amp; !end_time-&gt;tv_sec &amp;&amp; !end_time-&gt;tv_nsec) &#123;</span><br><span class="line">		wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">		timed_out = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (end_time &amp;&amp; !timed_out)</span><br><span class="line">		slack = select_estimate_accuracy(end_time);</span><br><span class="line"></span><br><span class="line">	retval = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> *rinp, *routp, *rexp, *inp, *outp, *<span class="built_in">exp</span>;</span><br><span class="line">		<span class="keyword">bool</span> can_busy_loop = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		inp = fds-&gt;in; outp = fds-&gt;out; <span class="built_in">exp</span> = fds-&gt;ex;</span><br><span class="line">		rinp = fds-&gt;res_in; routp = fds-&gt;res_out; rexp = fds-&gt;res_ex;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//éå†æ‰€æœ‰çš„fd.......åŒæ­¥ç­‰.....</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; ++rinp, ++routp, ++rexp) &#123;</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> in, out, ex, all_bits, <span class="built_in">bit</span> = <span class="number">1</span>, j;</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> res_in = <span class="number">0</span>, res_out = <span class="number">0</span>, res_ex = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">__poll_t</span> mask;</span><br><span class="line"></span><br><span class="line">			in = *inp++; out = *outp++; ex = *<span class="built_in">exp</span>++;</span><br><span class="line">			all_bits = in | out | ex;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰ä»»ä½•æ³¨å†Œäº‹ä»¶</span></span><br><span class="line">			<span class="keyword">if</span> (all_bits == <span class="number">0</span>) &#123;</span><br><span class="line">				i += BITS_PER_LONG;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; BITS_PER_LONG; ++j, ++i, <span class="built_in">bit</span> &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line">				<span class="keyword">if</span> (i &gt;= n)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//è·³è¿‡æœªæ³¨å†Œçš„</span></span><br><span class="line">				<span class="keyword">if</span> (!(<span class="built_in">bit</span> &amp; all_bits))</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				f = fdget(i);</span><br><span class="line">				<span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">					wait_key_set(wait, in, out, <span class="built_in">bit</span>,</span><br><span class="line">						     busy_flag);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//å¯¹æ¯ä¸€ä¸ªfdè¿›è¡Œæ£€æµ‹</span></span><br><span class="line">					mask = vfs_poll(f.file, wait);</span><br><span class="line"></span><br><span class="line">					fdput(f);</span><br><span class="line">					<span class="keyword">if</span> ((mask &amp; POLLIN_SET) &amp;&amp; (in &amp; <span class="built_in">bit</span>)) &#123;</span><br><span class="line">						res_in |= <span class="built_in">bit</span>;</span><br><span class="line">						retval++;</span><br><span class="line">						wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> ((mask &amp; POLLOUT_SET) &amp;&amp; (out &amp; <span class="built_in">bit</span>)) &#123;</span><br><span class="line">						res_out |= <span class="built_in">bit</span>;</span><br><span class="line">						retval++;</span><br><span class="line">						wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> ((mask &amp; POLLEX_SET) &amp;&amp; (ex &amp; <span class="built_in">bit</span>)) &#123;</span><br><span class="line">						res_ex |= <span class="built_in">bit</span>;</span><br><span class="line">						retval++;</span><br><span class="line">						wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">/* got something, stop busy polling */</span></span><br><span class="line">					<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">						can_busy_loop = <span class="literal">false</span>;</span><br><span class="line">						busy_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">/*</span></span><br><span class="line"><span class="comment">					 * only remember a returned</span></span><br><span class="line"><span class="comment">					 * POLL_BUSY_LOOP if we asked for it</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (busy_flag &amp; mask)</span><br><span class="line">						can_busy_loop = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (res_in)</span><br><span class="line">				*rinp = res_in;</span><br><span class="line">			<span class="keyword">if</span> (res_out)</span><br><span class="line">				*routp = res_out;</span><br><span class="line">			<span class="keyword">if</span> (res_ex)</span><br><span class="line">				*rexp = res_ex;</span><br><span class="line">			cond_resched();</span><br><span class="line">		&#125;</span><br><span class="line">		wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é€€å‡ºå¾ªç¯ï¼Œæ¡ä»¶ï¼š äº‹ä»¶å°±ç»ª/è¶…æ—¶/æ”¶åˆ°ä¿¡å·</span></span><br><span class="line">		<span class="keyword">if</span> (retval || timed_out || signal_pending(current))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (table.error) &#123;</span><br><span class="line">			retval = table.error;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* only if found POLL_BUSY_LOOP sockets &amp;&amp; not out of time */</span></span><br><span class="line">		<span class="keyword">if</span> (can_busy_loop &amp;&amp; !need_resched()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!busy_start) &#123;</span><br><span class="line">				busy_start = busy_loop_current_time();</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!busy_loop_timeout(busy_start))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		busy_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If this is the first loop and we have a timeout</span></span><br><span class="line"><span class="comment">		 * given, then we convert to ktime_t and set the to</span></span><br><span class="line"><span class="comment">		 * pointer to the expiry value.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (end_time &amp;&amp; !to) &#123;</span><br><span class="line">			expire = timespec64_to_ktime(*end_time);</span><br><span class="line">			to = &amp;expire;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¶…æ—¶å°±ä¼‘çœ ä¸€ä¼šå„¿ã€Œä¸­æ–­ä¼šå„¿ã€</span></span><br><span class="line">		<span class="keyword">if</span> (!poll_schedule_timeout(&amp;table, TASK_INTERRUPTIBLE,</span><br><span class="line">					   to, slack))</span><br><span class="line">			timed_out = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	poll_freewait(&amp;table);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">poll_schedule_timeout</span><span class="params">(struct poll_wqueues *pwq, <span class="keyword">int</span> state,</span></span></span><br><span class="line"><span class="function"><span class="params">			  <span class="keyword">ktime_t</span> *expires, <span class="keyword">unsigned</span> <span class="keyword">long</span> slack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc = -EINTR;</span><br><span class="line"></span><br><span class="line">	set_current_state(state);</span><br><span class="line">	<span class="keyword">if</span> (!pwq-&gt;triggered)</span><br><span class="line">		rc = schedule_hrtimeout_range(expires, slack, HRTIMER_MODE_ABS);</span><br><span class="line">	__set_current_state(TASK_RUNNING);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Prepare for the next iteration.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The following smp_store_mb() serves two purposes.  First, it&#x27;s</span></span><br><span class="line"><span class="comment">	 * the counterpart rmb of the wmb in pollwake() such that data</span></span><br><span class="line"><span class="comment">	 * written before wake up is always visible after wake up.</span></span><br><span class="line"><span class="comment">	 * Second, the full barrier guarantees that triggered clearing</span></span><br><span class="line"><span class="comment">	 * doesn&#x27;t pass event check of the next iteration.  Note that</span></span><br><span class="line"><span class="comment">	 * this problem doesn&#x27;t exist for the first iteration as</span></span><br><span class="line"><span class="comment">	 * add_wait_queue() has full barrier semantics.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	smp_store_mb(pwq-&gt;triggered, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="poll-wait"><a class="header-anchor" href="#poll-wait">Â¶</a>poll_wait</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * structures and helpers for f_op-&gt;poll implementations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">//ç±»ä¼¼ä¸€ä¸ªå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*poll_queue_proc)</span><span class="params">(struct file *, <span class="keyword">wait_queue_head_t</span> *, struct poll_table_struct *)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">poll_table_struct</span> &#123;</span></span><br><span class="line">	poll_queue_proc _qproc; <span class="comment">//callbackæœºåˆ¶</span></span><br><span class="line">	<span class="keyword">__poll_t</span> _key;</span><br><span class="line">&#125; poll_table;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">poll_wait</span><span class="params">(struct file * filp, <span class="keyword">wait_queue_head_t</span> * wait_address, poll_table *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (p &amp;&amp; p-&gt;_qproc &amp;&amp; wait_address)</span><br><span class="line">		p-&gt;_qproc(filp, wait_address, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="fdæ•°é‡é—®é¢˜"><a class="header-anchor" href="#fdæ•°é‡é—®é¢˜">Â¶</a>fdæ•°é‡é—®é¢˜</h3>
<blockquote>
<p>include/uapi/linux/posix_types.h</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __FD_SETSIZE	1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="comment">//__FD_SETSIZEå½“ä¸‹æ ‡ä½¿ï¼Ÿï¼Ÿï¼Ÿwhatï¼</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> fds_bits[__FD_SETSIZE / (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">long</span>))];</span><br><span class="line">&#125; __kernel_fd_set;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä»ä¸Šé¢çœ‹æ¥æ–‡ä»¶æè¿°ç¬¦åªæ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç”¨æ¥æ“ä½œä¸‹æ ‡çš„ï¼Œä¸»è¦æ˜¯æ¯ä¸€ä¸ªè¿›ç¨‹fileæ•°ç»„çš„ä¸‹æ ‡ã€‚ç†è§£do_selectæ˜¯æ ¸å¿ƒã€‚</p>
</blockquote>
<h3 id="select-ä¸poll"><a class="header-anchor" href="#select-ä¸poll">Â¶</a>select ä¸poll</h3>
<blockquote>
<p>pollå–æ¶ˆäº†æœ€å¤§æ•°é‡çš„é™åˆ¶,è¿”å›ç»“æœè¿˜æ˜¯éœ€è¦è½®è¯¢æ¥è·å–å°±ç»ªçš„æè¿°ç¬¦ã€‚</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">short</span> events; <span class="comment">//request</span></span><br><span class="line">	<span class="keyword">short</span> revents; <span class="comment">// return</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“è§åç»­æ›´æ–°ã€Œpollæºç ã€</p>
<h3 id="å‚è€ƒ"><a class="header-anchor" href="#å‚è€ƒ">Â¶</a>å‚è€ƒ</h3>
<p><a href="https://www.oreilly.com/openbook/linuxdrive3/book/">Linux Device Drivers, Third Edition</a><br>
<a href="https://stackoverflow.com/questions/11496059/how-do-system-calls-like-select-or-poll-work-under-the-hood">How do system calls like select() or poll() work under the hood?</a></p>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ20ã€åšå®¢è¯¡å¼‚äº‹ä»¶</title>
    <url>/archives/5ce14ff5.html</url>
    <content><![CDATA[<h3 id="åšå®¢CI-CDå´©äº†"><a class="header-anchor" href="#åšå®¢CI-CDå´©äº†">Â¶</a>åšå®¢CI CDå´©äº†</h3>
<blockquote>
<p>å°±åœ¨åˆšæ‰ä¿®æ”¹äº†éƒ¨åˆ†çš„configé…ç½®ï¼Œåæ‰“äº†tag pushäº†ä¸Šå»,</p>
</blockquote>
<blockquote>
<p>ohâ€¦GGäº†</p>
</blockquote>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">err: FATAL Something&#39;s wrong. Maybe you can find the solution here: https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</span><br><span class="line">err: TypeError: Cannot read property &#39;enable&#39; of undefined</span><br><span class="line">err:     at ***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;filters&#x2F;comment&#x2F;disqus.js:11:21</span><br><span class="line">err:     at Filter.execSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;extend&#x2F;filter.js:74:28)</span><br><span class="line">err:     at Hexo.execFilterSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:432:29)</span><br><span class="line">err:     at module.exports (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;lib&#x2F;injects.js:58:8)</span><br><span class="line">err:     at Hexo.&lt;anonymous&gt; (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;index.js:9:27)</span><br><span class="line">err:     at Hexo.emit (events.js:314:20)</span><br><span class="line">err:     at Hexo._generate (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:399:8)</span><br><span class="line">err:     at &#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:249:***</span><br><span class="line">err:     at tryCatcher (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;util.js:16:23)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:547:31)</span><br><span class="line">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:604:18)</span><br><span class="line">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class="line">err:     at PromiseArray._resolve (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:127:19)</span><br><span class="line">err:     at PromiseArray._promiseFulfilled (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:145:14)</span><br><span class="line">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:609:26)</span><br><span class="line">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class="line">err:     at Promise._resolveCallback (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:466:57)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:559:17)</span><br><span class="line">out: INFO  Start processing</span><br><span class="line">err: FATAL Something&#39;s wrong. Maybe you can find the solution here: https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</span><br><span class="line">err: TypeError: Cannot read property &#39;enable&#39; of undefined</span><br><span class="line">err:     at ***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;filters&#x2F;comment&#x2F;disqus.js:11:21</span><br><span class="line">err:     at Filter.execSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;extend&#x2F;filter.js:74:28)</span><br><span class="line">err:     at Hexo.execFilterSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:432:29)</span><br><span class="line">err:     at module.exports (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;lib&#x2F;injects.js:58:8)</span><br><span class="line">err:     at Hexo.&lt;anonymous&gt; (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;index.js:9:27)</span><br><span class="line">err:     at Hexo.emit (events.js:314:20)</span><br><span class="line">err:     at Hexo._generate (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:399:8)</span><br><span class="line">err:     at &#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:249:***</span><br><span class="line">err:     at tryCatcher (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;util.js:16:23)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:547:31)</span><br><span class="line">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:604:18)</span><br><span class="line">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class="line">err:     at PromiseArray._resolve (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:127:19)</span><br><span class="line">err:     at PromiseArray._promiseFulfilled (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:145:14)</span><br><span class="line">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:609:26)</span><br><span class="line">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class="line">err:     at Promise._resolveCallback (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:466:57)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:559:17)</span><br></pre></td></tr></table></figure>
<p>ç®€å•ç‚¹ï¼Œæ˜¾ç¤ºæ²¡æœ‰enableè¿™ä¸ªå±æ€§ï¼Œï¼Œï¼Œï¼Œæˆ‘æ‡µäº†ï¼Œè¿™éƒ¨ç½²äº†å¤šå°‘æ¬¡äº†ï¼Œæ²¡æœ‰å‡ºç°è¿™ä¹ˆä¸ªé”™è¯¯å•Šã€‚</p>
<p>å…ˆåˆ äº†jsï¼Œæœ¬åœ°è·‘okäº†ï¼Œè¿œç«¯æŒ‚äº†ï¼Œåˆæç¤ºå¦ä¸€ä¸ªjsé”™è¯¯ã€‚<br>
å†åˆ ä¸€ä¸ªé”™è¯¯çš„js,å†è·‘â€¦åˆæŒ‚äº†!</p>
<h3 id="æ’æŸ¥â€¦"><a class="header-anchor" href="#æ’æŸ¥â€¦">Â¶</a>æ’æŸ¥â€¦</h3>
<blockquote>
<p>åˆæ­¥å®šä½ä¸ºæ–‡ä»¶æ²¡æœ‰æ›´åˆ°æœ€æ–°</p>
</blockquote>
<p>æœ¬åœ°ok,æœåŠ¡å™¨éƒ¨ç½²ä¸èµ·æ¥â€¦</p>
<p>æŸ¥ä¸‹æ–‡ä»¶scp copyçš„å·¥ä½œæµ</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-000817@2x.png" alt=""></p>
<p>çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆå¥½ç”¨ï¼Œä½†æ˜¯å‘¢ï¼Œå¤§å‘æ¥äº†â€¦<br>
å½“æ—¶æ²¡æœ‰é€‰æ‹©æ˜¯å¦é€‰æ‹©è¦†ç›–æ–‡ä»¶ï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-001054@2x.png" alt=""></p>
<h3 id="é—®é¢˜ç‚¹"><a class="header-anchor" href="#é—®é¢˜ç‚¹">Â¶</a>é—®é¢˜ç‚¹</h3>
<p>æ²¡æœ‰è¦†ç›–é…ç½®æ–‡ä»¶ï¼Œå¯¼è‡´æ®‹ç•™æˆ–è€…ä¿®æ”¹ä¸å½»åº•ï¼ŒåŒåçš„å§‹ç»ˆä¸ä¿®æ”¹ï¼Œå¯¼è‡´çš„é—®é¢˜ã€‚</p>
<p>PSï¼šèŠ±äº†åŠä¸ªå°æ—¶å®šä½è¿™ä¹ˆä¸ªrewriteçš„é—®é¢˜ï¼ è®°ç€å§ï¼Œæé†’è‡ªå·±â€¦</p>
<h3 id="å‚è€ƒï¼š"><a class="header-anchor" href="#å‚è€ƒï¼š">Â¶</a>å‚è€ƒï¼š</h3>
<p><a href="https://github.com/appleboy/scp-action/blob/master/action.yml#L44">copy workflow Github</a><br>
<a href="https://github.com/marketplace/actions/scp-files">scp copy workflow</a></p>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>åšå®¢</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ19ã€GPM è°ƒåº¦æµç¨‹</title>
    <url>/archives/5c6a362f.html</url>
    <content><![CDATA[<p>å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆçŸ¥å…¶æ‰€ä»¥ç„¶â€¦<br>
å­¦ä¹ GPMè°ƒåº¦ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹æºç éƒ¨åˆ†çš„å‡†å¤‡å·¥ä½œå§ï¼Œä¸ç„¶ä¸€è„¸èŒ«ç„¶çš„çœ‹æºç ï¼ŒåŸºæœ¬ä¸ä¼šæœ‰å¤ªå¤šçš„æ”¶è·.</p>
<h3 id="å‡½æ•°-å˜é‡åˆè¯†"><a class="header-anchor" href="#å‡½æ•°-å˜é‡åˆè¯†">Â¶</a>å‡½æ•°&amp; å˜é‡åˆè¯†</h3>
<blockquote></blockquote>
<a id="more"></a>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h4 id="å‡½æ•°"><a class="header-anchor" href="#å‡½æ•°">Â¶</a>å‡½æ•°</h4>
<blockquote>
<p>/proc.go</p>
</blockquote>
<ul>
<li>main</li>
<li>sysmon</li>
<li>findrunnable</li>
<li>goparkã€Œ1.1ã€</li>
<li>gosched ã€Œ1.2ã€</li>
<li>mstart</li>
<li>wakep</li>
<li>schedule</li>
<li>cpuinit</li>
<li>schedinit</li>
<li>ready</li>
<li>readgstatus</li>
<li>startm</li>
<li>pollWork</li>
<li>injectglist</li>
<li>park_m</li>
<li>goyield</li>
<li>retake</li>
<li>globrunqput</li>
<li>globrunqputbatch</li>
<li>globrunqputhead</li>
</ul>
<h4 id="å˜é‡"><a class="header-anchor" href="#å˜é‡">Â¶</a>å˜é‡</h4>
<blockquote>
<p>/proc.go</p>
</blockquote>
<ul>
<li>m0</li>
<li>g0</li>
<li>allgs</li>
<li>allglock</li>
</ul>
<blockquote>
<p>/runtime2.go</p>
</blockquote>
<ul>
<li>g</li>
<li>p</li>
<li>m</li>
<li>allglen</li>
<li>allm</li>
<li>allp</li>
<li>allpLock</li>
<li>gomaxprocs</li>
<li>sched</li>
</ul>
<blockquote>
<p>/runtime2.go å¸¸é‡</p>
</blockquote>
<ul>
<li>_Grunnable/_Grunning/_Gwaitingâ€¦</li>
</ul>
<h3 id="ä¸Šè¿°è¿™äº›å‡½æ•°-å˜é‡-å¸¸é‡-whatï¼Ÿ"><a class="header-anchor" href="#ä¸Šè¿°è¿™äº›å‡½æ•°-å˜é‡-å¸¸é‡-whatï¼Ÿ">Â¶</a>ä¸Šè¿°è¿™äº›å‡½æ•°/å˜é‡/å¸¸é‡ whatï¼Ÿ</h3>
<p>å†™è¿™ä¹ˆå¤šï¼Œè‚¯å®šä¸æ˜¯ç®€å•çš„ä»æºç ä»“åº“é‡Œé¢è¶…å‡ºæ¥ï¼Œè¿™äº›æ˜¯ä¸€äº›æ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šæ²¡æœ‰ç½—åˆ—ï¼Œè¿™é‡Œä¸»è¦æƒ³è®°å½•ï¼Œä¹Ÿæ˜¯æ€è€ƒçš„ç‚¹ï¼š</p>
<ul>
<li>GPMä¸ºä½•ä¼šæœ‰è¿™ä¹ˆå¤šçš„çŠ¶æ€</li>
<li>è¿™äº›çŠ¶æ€ä¹‹é—´æ˜¯å¦‚ä½•é…åˆå’Œåè°ƒçš„</li>
<li>è‘—åçš„å·¥ä½œå·å–ã€ŒPã€æ˜¯æ€ä¹ˆæ“ä½œçš„</li>
<li>å¦‚æœè®©ä½ è®¾è®¡ï¼Œä½ åº”è¯¥ä¼šæ€ä¹ˆè®¾è®¡GPMè¿™ä¸ªè°ƒåº¦çš„è¿‡ç¨‹ã€ŒğŸé‡ç‚¹ã€</li>
</ul>
<h3 id="åˆ‡å…¥ç‚¹"><a class="header-anchor" href="#åˆ‡å…¥ç‚¹">Â¶</a>åˆ‡å…¥ç‚¹</h3>
<ul>
<li>main:å…¥å£å‡½æ•°</li>
<li>sysmonï¼šç›‘æ§è°ƒåº¦çº¿ç¨‹</li>
<li>scheduleï¼šçœŸå®çš„è°ƒåº¦å™¨é€»è¾‘</li>
<li>m0/g0ï¼šç‰¹æ®Šçš„å­˜åœ¨ä½“</li>
</ul>
<h3 id="å¦‚ä½•å¼€å§‹ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å¼€å§‹ï¼Ÿ">Â¶</a>å¦‚ä½•å¼€å§‹ï¼Ÿ</h3>
<blockquote>
<p>ç®€å•ç‚¹ï¼Œä»mainå¼€å§‹.</p>
</blockquote>
<h3 id="çæ‰¯"><a class="header-anchor" href="#çæ‰¯">Â¶</a>çæ‰¯</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">çœ‹äº†å¾ˆé•¿æ—¶é—´çš„goæºç äº†ï¼Œè§‰å¾—ä¸€ä¸ªå¥½çš„è®¾è®¡ï¼Œä»æ¥ä¸æ˜¯ç®€å•çš„å­¦ä¹ åˆ«äººçš„æºç ï¼Œ</span><br><span class="line">æ›´å¤šçš„æ˜¯å­¦ä¹ æºç çš„è®¾è®¡æ€è·¯å’Œå½“æ—¶è®¾è®¡æ—¶æ˜¯åŸºäºå“ªç§åœºæ™¯ä¸‹çš„ã€‚</span><br><span class="line"></span><br><span class="line">è€ƒè™‘æ›´å¤šçš„åœºæ™¯ï¼Œæœ‰æ²¡æœ‰å…¶å®ƒçš„è®¾è®¡æ€è·¯ï¼Œå¯èƒ½æ²¡æœ‰ç°æœ‰çš„è®¾è®¡æ›´å‡ºè‰²ï¼Œä½†æ›´åŠ é€‚åˆåˆ«çš„åœºæ™¯ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="æœªå®Œå¾…ç»­"><a class="header-anchor" href="#æœªå®Œå¾…ç»­">Â¶</a>æœªå®Œå¾…ç»­.</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ17ã€chrome headlessã€Œæˆªå›¾/PDF/DOM...ã€</title>
    <url>/archives/5544baea.html</url>
    <content><![CDATA[<blockquote>
<p>æœ€è¿‘åœ¨æä¸€ä¸ªéœ€æ±‚ï¼šhtmlã€Œæ–‡ä»¶ã€æ¸²æŸ“æˆpng/jpgï¼›chromeä¸èƒ½è£…åœ¨æœåŠ¡å™¨ä¸­ï¼Œå¯ä»¥æ‰“æˆdockeré•œåƒã€‚<br>
è¯´åˆ°è¿™ä¸ªï¼Œå¾ˆå¤šäººè‚¯å®šè¯´å¾ˆå®¹æ˜“å•Šï¼Œchrome headlessæœ‰ç°æˆçš„ï¼Œç›´æ¥ç”¨ï¼Œå®ƒæ˜¯ä¸é¦™ä¹ˆã€‚<br>
ç„¶è€Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼›</p>
</blockquote>
<h3 id="éš¾ç‚¹ï¼š"><a class="header-anchor" href="#éš¾ç‚¹ï¼š">Â¶</a>éš¾ç‚¹ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€æœåŠ¡å™¨ä¸­ä¸èƒ½è£…chrome</span><br><span class="line"><span class="number">2</span>ã€chromeå¿…é¡»æ‰“åœ¨dockeré‡Œé¢</span><br><span class="line"><span class="number">3</span>ã€æ¸²æŸ“æ•ˆæœè¦å’Œåœ¨æœ¬åœ°æ•ˆæœä¸€æ ·ï¼šå›¾ç‰‡ä¸èƒ½ä¸¢å¤±å­—ä½“ï¼Œä¸èƒ½å¤±çœŸã€‚</span><br><span class="line"><span class="number">4</span>ã€ä¸èƒ½å¯åŠ¨æ–°çš„æœåŠ¡</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="åˆ‡å…¥ç‚¹ï¼š"><a class="header-anchor" href="#åˆ‡å…¥ç‚¹ï¼š">Â¶</a>åˆ‡å…¥ç‚¹ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">docker &amp;&amp; chrome</span><br></pre></td></tr></table></figure>
<blockquote>
<p>soå…ˆå»æœä¸€æŠŠæœ‰æ²¡æœ‰ç°æˆçš„å¯ç”¨ï¼Ÿ</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-193745.png" alt=""></p>
<p>åˆ†æåˆ†æå§ï¼š</p>
<ul>
<li><a href="https://github.com/browserless/chrome">browserless</a></li>
<li><a href="https://github.com/puppeteer/puppeteer">puppeteer</a></li>
<li><a href="https://github.com/prisma-archive/chromeless">prisma-archive</a><br>
â€¦
<ul>
<li>é€‚åˆå¯åŠ¨æœåŠ¡ï¼Œç„¶åè¿›è¡Œæµ‹è¯•æˆ–è€…è·‘æœåŠ¡</li>
<li>å…¥å‚æ•°ä¸ºurl</li>
</ul>
</li>
</ul>
<blockquote>
<p>æ‰€ä»¥ä¸Šè¿°çš„åŸºæœ¬ä¸ç¬¦åˆéœ€æ±‚ï¼Œå†å¯»æ‰¾â€¦</p>
</blockquote>
<h3 id="Zenika-alpine-chrome"><a class="header-anchor" href="#Zenika-alpine-chrome">Â¶</a><a href="https://github.com/Zenika/alpine-chrome">Zenika/alpine-chrome</a></h3>
<blockquote>
<p>çœ‹èµ·æ¥å¯è¡Œï¼š</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194452.png" alt=""></p>
<p>è¿™ä¸ªç»è¿‡éªŒè¯æ€»ä¼šæœ‰ä¸€ä¸ªé”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[1110&#x2F;031547.366909:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket &#x2F;var&#x2F;run&#x2F;dbus&#x2F;system_bus_socket: No such file or directory</span><br><span class="line">[1110&#x2F;031547.367451:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class="line">[1110&#x2F;031547.437879:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class="line">[1110&#x2F;031549.073431:ERROR:headless_shell.cc(591)] Writing to file code&#x2F;ss.png was unsuccessful, could not open file: FILE_ERROR_ACCESS_DENIED</span><br></pre></td></tr></table></figure>
<p>æ–‡ä»¶æ²¡æƒé™å“¦ï¼Œå°´å°¬äº†,å†ä¿®æ­£ï¼š</p>
<blockquote>
<p>å‘ç°æºç æœ‰ä¸€æ®µæ·»åŠ äº†ç”¨æˆ·ï¼Œæ±—ï¼Œå¤ªæäº†.</p>
</blockquote>
<p><a href="https://github.com/Zenika/alpine-chrome/blob/master/Dockerfile#L38">ç‚¹å‡»æŸ¥çœ‹</a></p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194711.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¾ˆéƒé—·è¿™ä¸ªchromeç”¨æˆ·å¹²å˜›çš„ï¼Œå¦‚æœçœŸç”¨è¿™ä¸ªï¼Œé‚£å¾—ç¡®å®šä½ è·‘çš„ç¯å¢ƒè¦å…è®¸ä½ æ·»åŠ ä¸€ä¸ªuserå‡ºæ¥ï¼Œå¾ˆæ˜æ˜¾ä¸è¡Œ,</span><br><span class="line">è¿™æ ·å¯¼è‡´æ•´ä¸ªalpine-chromeæœåŠ¡æƒé™éƒ½æ˜¯ä¹±çš„ã€Œchromeç”¨æˆ·çš„ã€,æœ€æ˜æ˜¾çš„æ˜¯æ— æ³•è¯»å†™æ–‡ä»¶ï¼Œå› ä¸ºä½ è¿™ä¸ªadd chromeæ²¡æƒé™ã€‚</span><br><span class="line"></span><br><span class="line">æœ€ç›´æ¥çš„ï¼Œå»æ‰å°±å¥½äº†ã€‚</span><br><span class="line"></span><br><span class="line">æœç„¶å»æ‰åï¼Œè·‘dockerå°±å¯ä»¥äº†</span><br></pre></td></tr></table></figure>
<p><a href="https://hub.docker.com/r/zenika/alpine-chrome">dockeré•œåƒåœ°å€</a></p>
<p>è¿™ä¸ªæ˜¯å¯ä»¥äº†ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå›¾åƒå¤±çœŸäº†ï¼Œå†å»æŸ¥githubæºç ï¼Œå‘é‚£ï¼Œå‹æ ¹æ²¡æœ‰è£…å…¨æ–‡å­—åº“ï¼Œåªç®€å•è£…äº†lib***çš„åº“ã€‚</p>
<h3 id="å†å°è¯•ã€Œè‡ªå·±æä¸ªdocker-imagesã€"><a class="header-anchor" href="#å†å°è¯•ã€Œè‡ªå·±æä¸ªdocker-imagesã€">Â¶</a>å†å°è¯•ã€Œè‡ªå·±æä¸ªdocker imagesã€</h3>
<blockquote>
<p>åˆ«äººéƒ½èƒ½æï¼Œä¸ºä½•æˆ‘ä¸å¯ä»¥å‹’</p>
</blockquote>
<h3 id="åˆ†æï¼š"><a class="header-anchor" href="#åˆ†æï¼š">Â¶</a>åˆ†æï¼š</h3>
<ul>
<li>æœ¬åœ°è·‘è¿™ä¸ªæœåŠ¡æ˜¯okçš„ï¼Œé‚£chromeå°±æ˜¯ä¾èµ–macos/linuxç³»ç»Ÿçš„</li>
<li>é‚£å¯ä»¥æä¸ªlinuxç³»ç»Ÿï¼Œå†è£…ä¸ªchrome</li>
<li>æœ€åæŠŠå­—ä½“è£…å®Œå°±okäº†</li>
<li>æœ€åçš„æœ€åï¼Œæƒ³åŠæ³•ç›´æ¥å¯ä»¥ç”¨è¿™ä¸ªdockerï¼Œä¸ç”¨å¯åŠ¨æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´docker runä¹‹åæœ‰äº†ç»“æœï¼Œç›´æ¥rmæ‰ã€‚</li>
</ul>
<h3 id="æ€è·¯ï¼š"><a class="header-anchor" href="#æ€è·¯ï¼š">Â¶</a>æ€è·¯ï¼š</h3>
<ul>
<li>1ã€æä¸ªdocker debainç³»ç»Ÿ</li>
<li>2ã€æƒ³åŠæ³•æŠŠchromeè£…ä¸Š</li>
<li>3ã€åœ¨é‡Œé¢è·‘ä¸€ä¸ªæµ‹è¯•ï¼Œçœ‹èƒ½å¦ç”Ÿæˆå›¾ç‰‡</li>
<li>4ã€å®‰è£…ç¼ºå¤±çš„å­—ä½“</li>
<li>5ã€containerè·‘èµ·æ¥</li>
<li>6ã€å¯¼å‡ºcontainerï¼Œå†å¯¼å…¥åˆ°æœ¬åœ°çš„imagesï¼›è®©containerå˜æˆimages</li>
<li>7ã€è‡ªå·±æä¸ªDockerfileï¼ŒæŠŠã€ŒRUNã€æ¥å£ç•™å‡ºæ¥ï¼Œæ–¹ä¾¿å¯ä»¥ç›´æ¥è·‘èµ·æ¥</li>
<li>8ã€å†æŠŠæå¥½çš„imageså¯¼å‡ºæ¥ç”¨å°±å¯ä»¥äº†ã€‚</li>
</ul>
<h3 id="æ­¥éª¤ï¼š"><a class="header-anchor" href="#æ­¥éª¤ï¼š">Â¶</a>æ­¥éª¤ï¼š</h3>
<h4 id="1"><a class="header-anchor" href="#1">Â¶</a>1</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull debian</span><br></pre></td></tr></table></figure>
<h4 id="2-3-4-5"><a class="header-anchor" href="#2-3-4-5">Â¶</a>2/3/4/5</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€è¿›å…¥ç³»ç»Ÿ</span><br><span class="line">docker exec -it XXXXX &#x2F;bin&#x2F;bash</span><br><span class="line">2ã€æ›´æ–°æº</span><br><span class="line">apt-get update</span><br><span class="line">3ã€ä¸‹è½½wget</span><br><span class="line">apt-get install wget</span><br><span class="line">4ã€ä¸‹è½½chrome linuxç‰ˆæœ¬çš„</span><br><span class="line">wget https:&#x2F;&#x2F;dl.google.com&#x2F;linux&#x2F;direct&#x2F;google-chrome-stable_current_amd64.deb</span><br><span class="line">5ã€å®‰è£…chrome</span><br><span class="line"> dpkg -i ******.deb</span><br><span class="line"> è§£å†³ä¾èµ–å…³ç³»ï¼š</span><br><span class="line">    apt-get -f install</span><br><span class="line">6ã€è·‘ä¸€æŠŠå‘ç°æ±‰å­—å˜é—®å¥½ã€Œï¼Ÿã€äº†</span><br><span class="line">7ã€å®‰è£…ç¼ºå¤±çš„å­—ä½“</span><br><span class="line">apt-get install ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br></pre></td></tr></table></figure>
<h4 id="6å¯¼å‡ºcontainer"><a class="header-anchor" href="#6å¯¼å‡ºcontainer">Â¶</a>6å¯¼å‡ºcontainer</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€å¯¼å‡ºcontainer</span><br><span class="line">docker export container_name &gt; chrome.tar</span><br><span class="line">2ã€å¯¼å…¥åˆ°imagesä¸­</span><br><span class="line">docker load &lt; chrome.tar</span><br></pre></td></tr></table></figure>
<h4 id="7è‡ªå·±æDockerfile-é¢„ç•™ã€ŒRUNã€æ¥å£"><a class="header-anchor" href="#7è‡ªå·±æDockerfile-é¢„ç•™ã€ŒRUNã€æ¥å£">Â¶</a>7è‡ªå·±æDockerfile,é¢„ç•™ã€ŒRUNã€æ¥å£</h4>
<p>Dockerfileæ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#è¿™ä¸ªæ˜¯ä¸Šä¸€æ­¥å¯¼å…¥çš„images</span><br><span class="line">FROM gogoowang&#x2F;chrome:v1</span><br><span class="line">RUN mkdir -p &#x2F;home</span><br><span class="line">WORKDIR &#x2F;home</span><br><span class="line">ENTRYPOINT [&quot;chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ„å»ºæˆé•œåƒï¼šdocker build -t gogoo/chrome:v2 .</p>
</blockquote>
<p>PS:ã€Œ/homeã€çš„å«ä¹‰å°±æ˜¯è¿™ä¸ªimagesçš„å·¥ä½œç›®å½•æ˜¯/homeæ–‡ä»¶å¤¹ä¸‹é¢</p>
<h4 id="8è·‘ä¸€æŠŠï¼Œæ”¶å·¥"><a class="header-anchor" href="#8è·‘ä¸€æŠŠï¼Œæ”¶å·¥">Â¶</a>8è·‘ä¸€æŠŠï¼Œæ”¶å·¥</h4>
<h3 id="æ³¨æ„ç‚¹ï¼š"><a class="header-anchor" href="#æ³¨æ„ç‚¹ï¼š">Â¶</a>æ³¨æ„ç‚¹ï¼š</h3>
<h4 id="PS-1"><a class="header-anchor" href="#PS-1">Â¶</a>PS-1</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€é”™è¯¯âŒ</span><br><span class="line">docker container run -it --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class="line">2ã€æ­£ç¡®</span><br><span class="line">docker container run -i --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot&#x3D;&#x2F;home&#x2F;xx.png --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class="line"></span><br><span class="line">å°‘ä¸€ä¸ª -tï¼Œè¿™ä¸ª -tï¼šå†æä¸€ä¸ªä¸´æ—¶çš„TTyæ¥è·‘ç¨‹åºï¼Œæ—¢ç„¶æ˜¯åå°è·‘çš„ï¼Œé‚£å°±æ²¡å¿…è¦äº†</span><br></pre></td></tr></table></figure>
<h4 id="PS-2"><a class="header-anchor" href="#PS-2">Â¶</a>PS-2</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker container run -i --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot&#x3D;&#x2F;home&#x2F;xx.png --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class="line"></span><br><span class="line">1ã€å…³äºè¿™ä¸ª-vçš„é—®é¢˜,åé¢å°±å›ºå®šäº†ï¼Œå…·ä½“è§Dockerfileä¸­</span><br><span class="line">2ã€--screenshotè·¯å¾„é—®é¢˜ï¼Œæ—¢ç„¶æ˜¯dockeré•œåƒï¼Œé‚£å°±å¾—å¡«ä¸ªdockeré•œåƒä¸­çš„åœ°å€ï¼Œé‚£å°±æ˜¯&#x2F;homeä¸‹é¢äº†</span><br></pre></td></tr></table></figure>
<h3 id="ä¼˜åŒ–åä¸€é”®è„šæœ¬"><a class="header-anchor" href="#ä¼˜åŒ–åä¸€é”®è„šæœ¬">Â¶</a>ä¼˜åŒ–åä¸€é”®è„šæœ¬</h3>
<p>Dockerfileæ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM debian</span><br><span class="line">RUN apt-get update </span><br><span class="line">RUN apt-get install -y wget </span><br><span class="line">RUN wget https:&#x2F;&#x2F;dl.google.com&#x2F;linux&#x2F;direct&#x2F;google-chrome-stable_current_amd64.deb </span><br><span class="line">RUN dpkg -i google-chrome-stable_current_amd64.deb || true</span><br><span class="line">RUN apt-get -f -y install</span><br><span class="line">RUN apt-get install -y ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br><span class="line">RUN mkdir -p &#x2F;home</span><br><span class="line">WORKDIR &#x2F;home</span><br><span class="line">ENTRYPOINT [&quot;&#x2F;opt&#x2F;google&#x2F;chrome&#x2F;chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>
<p>æ„å»ºï¼š</p>
<blockquote>
<p>docker build -t google-chrome:latest .</p>
</blockquote>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ16ã€goæºç wordså½’çº³</title>
    <url>/archives/425d5e80.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å¥½ä¹…æ²¡æœ‰æ›´æ–°äº†ï¼Œä¸æ˜¯ä¸æ›´æ–°ï¼Œæœ€è¿‘æ„Ÿå†’ä¸¥é‡ï¼Œä¸€ç›´æ²¡å¥½ï¼Œå¤ªå½±å“èº«ä½“äº†â€¦ã€Œèº«ä½“è¿˜æ˜¯å¾ˆé‡è¦çš„!ã€</p>
<p>å½“ç„¶äº†ï¼Œåœ¨ç”Ÿç—…æœŸé—´ä¹Ÿçœ‹äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ›´å¤šçš„æ€è€ƒäº†è®¸å¤šï¼šäººç”Ÿè§„åˆ’çš„ã€å¦‚ä½•å­¦ä¹ æŠ€æœ¯ã€åç»­çš„ç”Ÿæ¶¯å‘å±•ä¹‹ç±»çš„ã€‚ã€Œæ€è€ƒçš„æ–¹å¼å¾ˆå¤šç§ï¼Œä¸å»ºè®®å»ç”Ÿç—…äº†æ‰å»æ€è€ƒ.ã€</p>
<blockquote>
<p>åç»­ä¼šæ›´æ–°ä¸€ç¯‡ï¼Œä¸»è¦æ˜¯ç»“åˆä¹‹å‰çš„æˆé•¿å’ŒæŠ€æœ¯çš„å£å’æ¥è¯´è¯´åç»­æƒ³æ€ä¹ˆå­¦ï¼Œæ€ä¹ˆå‘å±•ï¼Œç”Ÿæ¶¯è§„åˆ’å§ã€‚</p>
</blockquote>
<p>ä¸æ‰¯äº†ï¼Œè¿™ç¯‡ä¸»è¦æƒ³è®°å½•ä¸€äº›è¯æ±‡ï¼Œä¸»è¦è¿˜æ˜¯åœ¨é˜…è¯»Goæºç ä¸­çš„ä¸€äº›è¯æ±‡ï¼Œæ¯•ç«Ÿè‹±æ–‡æœ‰ç‚¹å·®ï¼Œå†ä¸ç§¯ç´¯å°±æ›´å·®äº†ã€‚</p>
<h3 id="Words"><a class="header-anchor" href="#Words">Â¶</a>Words</h3>
<h4 id="å…¨ç§°"><a class="header-anchor" href="#å…¨ç§°">Â¶</a>å…¨ç§°</h4>
<a id="more"></a>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ã€Œ<span class="number">11</span>/<span class="number">3</span>ã€</span><br><span class="line">Preempt  v æŠ¢å ã€æ å¤º                                   --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">retake   v é‡æ–°è·å–ã€Œé‡æ–°åˆ†é…ã€                           --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">syscall  v ç³»ç»Ÿè°ƒç”¨                                     --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">decrement v é€’å‡                                       --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">pretending  v å‡è£…ã€ä¼ªè£…                                --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">contended  v ç«äº‰                                      --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">procresize  v æ‰©å¤§                                     --&gt; /proc.<span class="keyword">go</span> </span><br><span class="line">corruption  n è…è´¥ï¼Œè¯‘ï¼šæŸå</span><br><span class="line">infinite  adj æ— é™çš„  </span><br><span class="line">reproduce v  å¤åˆ¶</span><br><span class="line">consists  v ç»„æˆ</span><br><span class="line">reproducer  v å¤åˆ¶</span><br><span class="line">allocating v åˆ†é…</span><br><span class="line">embed   v åµŒå…¥ </span><br><span class="line"></span><br><span class="line">ã€Œ<span class="number">11</span>/<span class="number">5</span>ã€</span><br><span class="line">assembly  n  è£…é…                                      --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">amortizes  v  ç¼“å†²                                     --&gt; /proc.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line">ã€Œ<span class="number">11</span>/<span class="number">25</span>ã€</span><br><span class="line">guard  v. çœ‹å®ˆ																				 --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">Alternatively  æˆ–è€…																		--&gt;  /runtime/rwmutex.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line">ã€Œlaterã€</span><br><span class="line">demonstrate  v æ¼”ç¤º</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ç®€å†™"><a class="header-anchor" href="#ç®€å†™">Â¶</a>ç®€å†™</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ã€Œ<span class="number">11</span>/<span class="number">3</span>ã€</span><br><span class="line">sysmon -&gt; system monitor ç³»ç»Ÿç›‘æ§                                               /proc.<span class="keyword">go</span></span><br><span class="line">incidlelocked  --&gt; increment idle locked   å¢åŠ ç©ºé—²é”                           /proc.<span class="keyword">go</span></span><br><span class="line">sysmontick  --&gt; system monitor ticket   ç³»ç»Ÿç›‘æ§æ•°é‡                            /proc.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<h3 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ15ã€Plan9 æ±‡ç¼–å°è®°</title>
    <url>/archives/2ce846ed.html</url>
    <content><![CDATA[<h4 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h4>
<blockquote>
<p>å¹³å¸¸codingæ—¶ï¼Œå¶å°”ä¼šæŸ¥çœ‹è®¡ç®—æœºçš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼Œé‚£æœ€åŸºæœ¬çš„å°±æ˜¯æ±‡ç¼–äº†ï¼Œäº†è§£æ±‡ç¼–æ˜¯è°ƒè¯•è¿‡ç¨‹ä¸­å¿…ä¸å¯å°‘çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›ç»†èŠ‚çš„å¤„ç†æ–¹é¢.Goçš„æ±‡ç¼–æ˜¯Plan 9(è´å°”å®éªŒå®¤çš„äº§ç‰©)ï¼Œå’Œæ±‡ç¼–å¾ˆç±»ä¼¼ã€‚</p>
</blockquote>
<h4 id="å¦‚ä½•å¾—åˆ°æ±‡ç¼–ç»“æœï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å¾—åˆ°æ±‡ç¼–ç»“æœï¼Ÿ">Â¶</a>å¦‚ä½•å¾—åˆ°æ±‡ç¼–ç»“æœï¼Ÿ</h4>
<ul>
<li>å®˜ç½‘æ–‡æ¡£</li>
<li>Google</li>
</ul>
<h5 id="3ç§æ–¹å¼ï¼š"><a class="header-anchor" href="#3ç§æ–¹å¼ï¼š">Â¶</a>3ç§æ–¹å¼ï¼š</h5>
<blockquote>
<p>ç¬¬ä¸€ç§</p>
</blockquote>
<a id="more"></a>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> tool compile -N -l -S ***.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç¬¬äºŒç§</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€å…ˆç¼–è¯‘ï¼š</span><br><span class="line">    <span class="keyword">go</span> tool compile -N -l ***.<span class="keyword">go</span></span><br><span class="line"><span class="number">2</span>ã€å†åç¼–è¯‘ï¼š</span><br><span class="line">    <span class="keyword">go</span> tool objdump ***.o</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç¬¬ä¸‰ç§</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> build -gcflags -S ***.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<h4 id="å¸¸ç”¨å¯„å­˜å™¨"><a class="header-anchor" href="#å¸¸ç”¨å¯„å­˜å™¨">Â¶</a>å¸¸ç”¨å¯„å­˜å™¨</h4>
<h5 id="AX-BX-CX-DX-BP-SI-SP-IP"><a class="header-anchor" href="#AX-BX-CX-DX-BP-SI-SP-IP">Â¶</a>AX BX CX DX BP SI SP IP</h5>
<table>
<thead>
<tr>
<th style="text-align:left">å¯„å­˜å™¨</th>
<th style="text-align:left">16ä½</th>
<th style="text-align:left">32ä½</th>
<th style="text-align:left">64ä½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ç´¯åŠ å¯„å­˜å™¨</td>
<td style="text-align:left">AX</td>
<td style="text-align:left">EAX</td>
<td style="text-align:left">RAX</td>
</tr>
<tr>
<td style="text-align:left">åŸºå€å¯„å­˜å™¨</td>
<td style="text-align:left">BX</td>
<td style="text-align:left">EBX</td>
<td style="text-align:left">RBX</td>
</tr>
<tr>
<td style="text-align:left">è®¡æ•°å¯„å­˜å™¨</td>
<td style="text-align:left">CX</td>
<td style="text-align:left">ECX</td>
<td style="text-align:left">RCX</td>
</tr>
<tr>
<td style="text-align:left">æ•°æ®å¯„å­˜å™¨</td>
<td style="text-align:left">DX</td>
<td style="text-align:left">EDX</td>
<td style="text-align:left">RDX</td>
</tr>
<tr>
<td style="text-align:left">å †æ ˆåŸºæŒ‡é’ˆ</td>
<td style="text-align:left">BP</td>
<td style="text-align:left">EBP</td>
<td style="text-align:left">RBP</td>
</tr>
<tr>
<td style="text-align:left">å˜å€å¯„å­˜å™¨</td>
<td style="text-align:left">SI</td>
<td style="text-align:left">ESI</td>
<td style="text-align:left">RSI</td>
</tr>
<tr>
<td style="text-align:left">å †æ ˆé¡¶æŒ‡é’ˆ</td>
<td style="text-align:left">SP</td>
<td style="text-align:left">ESP</td>
<td style="text-align:left">RSP</td>
</tr>
<tr>
<td style="text-align:left">æŒ‡ä»¤å¯„å­˜å™¨</td>
<td style="text-align:left">IP</td>
<td style="text-align:left">EIP</td>
<td style="text-align:left">RIP</td>
</tr>
</tbody>
</table>
<h5 id="MOV"><a class="header-anchor" href="#MOV">Â¶</a>MOV</h5>
<blockquote>
<p>movbï¼ˆ8ä½ï¼‰ã€movwï¼ˆ16ä½ï¼‰ã€movlï¼ˆ32ä½ï¼‰ã€movqï¼ˆ64ä½ï¼‰</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">MOVSS: ç§»åŠ¨å•ç²¾åº¦æµ®ç‚¹æ•°</span><br></pre></td></tr></table></figure>
<h4 id="æŸ¥è¯¢åœ°å€"><a class="header-anchor" href="#æŸ¥è¯¢åœ°å€">Â¶</a>æŸ¥è¯¢åœ°å€</h4>
<p><a href="https://c9x.me/x86/html/file_module_x86_id_205.html">MOVSS</a><br>
<a href="https://www.felixcloutier.com/x86/index.html">Intelæ±‡ç¼–æŒ‡ä»¤æŸ¥è¯¢</a><br>
<a href="https://plan9.io/sources/contrib/ericvh/go-plan9/src/pkg/runtime/slice.c">Plan9æŸ¥è¯¢</a></p>
<h4 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h4>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Plan9</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ14ã€hexo-å®‰è£…&amp;æ’ä»¶</title>
    <url>/archives/ae4aba0d.html</url>
    <content><![CDATA[<p>hexoå®‰è£…åŠå…¶ç¬¬ä¸‰æ–¹æ’ä»¶åŒ…ä¸‹è½½æ€»ç»“ï¼Œä»¥ä¾¿åç»­CIä¸€æ¬¡åˆ°ä½ã€‚</p>
<a id="more"></a>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"> npm install -g hexo-cli</span><br><span class="line"> npm install hexo-renderer-sass --save</span><br><span class="line"> npm install hexo-generator-searchdb --save</span><br><span class="line"> npm install hexo-generator-sitemap --save</span><br><span class="line"> npm install hexo-generator-baidu-sitemap --save</span><br><span class="line"> npm install request --save</span><br><span class="line"> npm install xml-parser --save</span><br><span class="line"> npm install yamljs --save</span><br><span class="line"> npm install md5 --save</span><br><span class="line"> npm install request --save</span><br><span class="line"> npm install xml-parser --save</span><br><span class="line"> npm install yamljs --save</span><br><span class="line"> npm install cheerio --save</span><br><span class="line"> npm install blueimp-md5 --save</span><br><span class="line"> npm install hexo-abbrlink --save</span><br><span class="line"> npm audit fix</span><br><span class="line"></span><br><span class="line"> npm uninstall hexo-generator-index --save</span><br><span class="line"> npm install hexo-generator-index-pin-top --save</span><br><span class="line"> npm audit fix</span><br><span class="line"> </span><br><span class="line"> npm install hexo-neat --save</span><br><span class="line"> npm audit fix</span><br><span class="line"> npm install --save hexo-admin</span><br><span class="line"> npm audit fix</span><br><span class="line"> npm install hexo-deployer-git --save</span><br><span class="line"> npm audit fix</span><br><span class="line"></span><br><span class="line"> sudo npm install hexo-toc --save</span><br><span class="line"> npm audit fix</span><br><span class="line"></span><br><span class="line"><span class="comment">//çŒ«å’ªæ¨¡å‹</span></span><br><span class="line"> sudo npm install --save hexo-helper-live2d </span><br><span class="line"> npm audit fix</span><br><span class="line"> sudo npm install --save live2d-widget-model-z16</span><br></pre></td></tr></table></figure>
<blockquote>
<p>update: 2021-02-05 19:25:42</p>
</blockquote>
<p>hexo nextè§£ææ’ä»¶æ›´æ¢ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">npm un hexo-renderer-marked -S</span><br><span class="line"></span><br><span class="line"> npm uninstall hexo-renderer-marked --save</span><br><span class="line"></span><br><span class="line">å†å®‰è£…ä¸‹é¢æ’ä»¶ï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">npm install --save markdown-it-abbr</span><br><span class="line">npm install --save markdown-it-footnote</span><br><span class="line">npm install --save markdown-it-ins</span><br><span class="line">npm install --save markdown-it-sub</span><br><span class="line">npm install --save markdown-it-sup</span><br><span class="line">npm install --save markdown-it-anchor</span><br><span class="line">npm install --save markdown-it-deflist</span><br><span class="line">npm install --save markdown-it-mark</span><br><span class="line">npm install --save markdown-it-container</span><br><span class="line"></span><br><span class="line">npm install --save markdown-it-emoji</span><br><span class="line">npm install --save markdown-it-attrs</span><br><span class="line">npm install --save markdown-it-task-lists</span><br><span class="line">npm install --save markdown-it<span class="number">-68</span>tygbv </span><br><span class="line"></span><br><span class="line">npm install markdown-it-mathjax --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm i markdown-it-latex2img --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install markdown-it-texmath</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br><span class="line">æœ€åæ›´æ–°ä¸‹hexoæ›´ç›®å½•ä¸‹çš„_config.yaml</span><br><span class="line"></span><br><span class="line"># Markdown-it config</span><br><span class="line">## Docs: https:<span class="comment">//github.com/celsomiranda/hexo-renderer-markdown-it/wiki</span></span><br><span class="line">markdown:</span><br><span class="line">  render:</span><br><span class="line">    # Enable HTML tags in source</span><br><span class="line">    html: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    # Use <span class="string">&#x27;/&#x27;</span> to <span class="built_in">close</span> single tags (&lt;br /&gt;). This is only <span class="keyword">for</span> full CommonMark compatibility.</span><br><span class="line">    xhtmlOut: <span class="literal">true</span>        </span><br><span class="line"></span><br><span class="line">    # Convert <span class="string">&#x27;\n&#x27;</span> in paragraphs into &lt;br&gt; </span><br><span class="line">    breaks: <span class="literal">true</span>      </span><br><span class="line"></span><br><span class="line">    # CSS language prefix <span class="keyword">for</span> fenced blocks. Can be useful <span class="keyword">for</span> external highlighters.</span><br><span class="line">    langPrefix: <span class="string">&#x27;language-&#x27;</span>  </span><br><span class="line"></span><br><span class="line">    # Autoconvert URL-like text to links </span><br><span class="line">    linkify: <span class="literal">true</span>        </span><br><span class="line"></span><br><span class="line">    # Enable some language-neutral replacement + quotes beautification</span><br><span class="line">    typographer: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    # Double + single quotes replacement pairs, when typographer enabled,</span><br><span class="line">    # and smartquotes on. Could be either a String or an Array.</span><br><span class="line">    #</span><br><span class="line">    # For example, you can use <span class="string">&#x27;Â«Â»â€â€œ&#x27;</span> <span class="keyword">for</span> Russian, <span class="string">&#x27;â€â€œâ€šâ€˜&#x27;</span> <span class="keyword">for</span> German,</span><br><span class="line">    # and [<span class="string">&#x27;Â«\xA0&#x27;</span>, <span class="string">&#x27;\xA0Â»&#x27;</span>, <span class="string">&#x27;â€¹\xA0&#x27;</span>, <span class="string">&#x27;\xA0â€º&#x27;</span>] <span class="keyword">for</span> French (including nbsp).</span><br><span class="line">    quotes: <span class="string">&#x27;â€œâ€â€˜â€™&#x27;</span></span><br><span class="line"></span><br><span class="line">  # Plugins</span><br><span class="line">  plugins:</span><br><span class="line">    - markdown-it-abbr</span><br><span class="line">    - markdown-it-footnote</span><br><span class="line">    - markdown-it-ins</span><br><span class="line">    - markdown-it-sub</span><br><span class="line">    - markdown-it-sup</span><br><span class="line">    - markdown-it-anchor</span><br><span class="line">    - markdown-it-deflist</span><br><span class="line">    - markdown-it-mark</span><br><span class="line">    - markdown-it-container</span><br><span class="line"></span><br><span class="line">    - markdown-it-emoji</span><br><span class="line">    - markdown-it-named-headings</span><br><span class="line">    - markdown-it-toc</span><br><span class="line">    - markdown-it-attrs</span><br><span class="line">    - name: markdown-it-task-lists</span><br><span class="line">      options:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">        label: <span class="literal">true</span></span><br><span class="line">        labelAfter: <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  # Automatic Headline ID<span class="string">&#x27;s</span></span><br><span class="line"><span class="string">  anchors:</span></span><br><span class="line"><span class="string">    # Minimum level for ID creation. (Ex. h2 to h6)</span></span><br><span class="line"><span class="string">    level: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # A suffix that is prepended to the number given if the ID is repeated.</span></span><br><span class="line"><span class="string">    collisionSuffix: &#x27;</span>v<span class="string">&#x27;           </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # If `true`, creates an anchor tag with a permalink besides the heading.</span></span><br><span class="line"><span class="string">    permalink: false              </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Class used for the permalink anchor tag.</span></span><br><span class="line"><span class="string">    permalinkClass: header-anchor </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # The symbol used to make the permalink</span></span><br><span class="line"><span class="string">    permalinkSymbol: Â¶</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>hexo gulpå…¼å®¹es5:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install gulp --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-minify-css --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-uglify --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-htmlmin --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-htmlclean --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-imagemin --save</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br><span class="line">npm install babel-core@6.26.3 --save</span><br><span class="line">npm install gulp-babel@7.0.1 --save</span><br><span class="line">npm install babel-preset-es2015@6.24.1 --save</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æœªå®Œå¾…ç»­â€¦</p>
</blockquote>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ13ã€Linux è¿›ç¨‹</title>
    <url>/archives/ba455c1d.html</url>
    <content><![CDATA[<p>è¿›ç¨‹è¿™æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œå½“ç„¶æˆ‘ä¸æ˜¯é‚£ä¸ªè€ç”Ÿï¼Œæˆ‘åªæ˜¯ä¸ªloserã€‚</p>
<p>ä»Šå¤©ç”¨chromeï¼Œå ç”¨å¾ˆå¤šçš„å†…å­˜å’Œèµ„æºï¼ŒæŸ¥äº†æŸ¥ï¼Œè¯´chromeæ˜¯å¤šè¿›ç¨‹çš„ï¼Œäºæ˜¯å°±æƒ³äº†è§£ä¸‹è¿›ç¨‹ä¸€äº›ç›¸å…³çš„å†…å®¹ã€‚<br>
ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦äº†è§£ä¸‹è¿›ç¨‹ï¼š</p>
<ul>
<li>æ¥æº</li>
<li>å®šä¹‰</li>
<li>ç‰¹å¾</li>
<li>å¤šè¿›ç¨‹å¦‚ä½•å·¥ä½œï¼Ÿ</li>
<li>é€šä¿¡</li>
</ul>
<a id="more"></a>
<h3 id="æ¥æº"><a class="header-anchor" href="#æ¥æº">Â¶</a>æ¥æº</h3>
<p>æŠ½è±¡æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œæˆ–è€…è¯´æ˜¯å¯¹è®¡ç®—æœºç³»ç»Ÿå­˜å‚¨å™¨çš„è°ƒåº¦å’Œç®¡ç†ã€‚</p>
<h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰">Â¶</a>å®šä¹‰</h3>
<p>è¿›ç¨‹ï¼šå¹¶å‘ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­èµ„æºåˆ†é…å’Œç®¡ç†çš„æœ€åŸºæœ¬çš„å•å…ƒï¼ˆèµ„æºåˆ†é…çš„æœ€å°å•å…ƒï¼Œæ‰§è¡Œçš„æœ€å°å•å…ƒï¼‰ã€‚ä¸€ä¸ªç¨‹åºä¸€æ—¦å¼€å§‹æ‰§è¡Œï¼Œå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´ï¼Œç³»ç»Ÿä¼šåˆ†é…ä¸€å®šçš„åœ°å€ç©ºé—´å’Œå®Œæ•´çš„æ•°æ®æ®µç©ºé—´ã€‚</p>
<p>ps:[çº¿ç¨‹ï¼šç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½ã€‚]</p>
<p>ç»„æˆï¼šç¨‹åºã€æ•°æ®ã€æ§åˆ¶å—ç»„æˆã€‚</p>
<h3 id="ç‰¹å¾"><a class="header-anchor" href="#ç‰¹å¾">Â¶</a>ç‰¹å¾</h3>
<ul>
<li>åŠ¨æ€æ€§ ï¼š å¤šä¸ªç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿›ç¨‹æ˜¯åŠ¨æ€äº§ç”Ÿï¼ŒåŠ¨æ€é”€æ¯çš„ã€‚</li>
<li>å¹¶å‘æ€§ ï¼š ä»»ä½•è¿›ç¨‹å¯ä»¥å’Œå…¶å®ƒè¿›ç¨‹å¹¶å‘æ‰§è¡Œã€‚</li>
<li>ç‹¬ç«‹æ€§ ï¼š æ˜¯ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•å…ƒï¼Œä¹Ÿæ˜¯èµ„æºåˆ†é…å’Œè°ƒåº¦çš„ç‹¬ç«‹å•å…ƒã€‚</li>
<li>å¼‚æ­¥æ€§ ï¼š ç”±äºè¿›ç¨‹é—´çš„ç›¸äº’åˆ¶çº¦ï¼Œè¿›ç¨‹é—´æ˜¯å„è‡ªç‹¬ç«‹ï¼Œå„è‡ªå‘å‰ã€‚</li>
</ul>
<h3 id="å¤šè¿›ç¨‹å·¥ä½œï¼š"><a class="header-anchor" href="#å¤šè¿›ç¨‹å·¥ä½œï¼š">Â¶</a>å¤šè¿›ç¨‹å·¥ä½œï¼š</h3>
<h4 id="è¿›ç¨‹çš„çŠ¶æ€ï¼š"><a class="header-anchor" href="#è¿›ç¨‹çš„çŠ¶æ€ï¼š">Â¶</a>è¿›ç¨‹çš„çŠ¶æ€ï¼š</h4>
<blockquote>
<p>3ç§çŠ¶æ€ï¼š</p>
</blockquote>
<ul>
<li>å°±ç»ª</li>
<li>è¿è¡Œ</li>
<li>é˜»å¡</li>
</ul>
<h5 id="3æ€å›¾ï¼š"><a class="header-anchor" href="#3æ€å›¾ï¼š">Â¶</a>3æ€å›¾ï¼š</h5>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_3.1.png" alt=""></p>
<h5 id="5æ€å›¾ï¼š"><a class="header-anchor" href="#5æ€å›¾ï¼š">Â¶</a>5æ€å›¾ï¼š</h5>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/linux_p3.png" alt=""></p>
<h5 id="7æ€å›¾ï¼š"><a class="header-anchor" href="#7æ€å›¾ï¼š">Â¶</a>7æ€å›¾ï¼š</h5>
<p>æ–°å¢ä¸¤ç§çŠ¶æ€ï¼š</p>
<ul>
<li>æŒ‚èµ·å°±ç»ªçŠ¶æ€ï¼šè¡¨æ˜è¿›ç¨‹å…·å¤‡äº†è¿è¡Œçš„æ¡ä»¶ï¼Œç›®å‰åœ¨äºŒçº§å­˜å‚¨å™¨é‡Œé¢ã€‚</li>
<li>æŒ‚èµ·ç­‰å¾…çŠ¶æ€ï¼šè¡¨æ˜è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸€ä¸ªäº‹ä»¶çš„ç»“æŸä¸”ç›®å‰åœ¨äºŒçº§å­˜å‚¨å™¨é‡Œé¢ã€‚</li>
</ul>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_7.png" alt=""></p>
<h3 id="è¿›ç¨‹é—´é€šä¿¡"><a class="header-anchor" href="#è¿›ç¨‹é—´é€šä¿¡">Â¶</a>è¿›ç¨‹é—´é€šä¿¡</h3>
<h4 id="å…±äº«å†…å­˜"><a class="header-anchor" href="#å…±äº«å†…å­˜">Â¶</a>å…±äº«å†…å­˜</h4>
<p>æ˜ å°„ä¸€æ®µèƒ½è¢«å…¶å®ƒè¿›ç¨‹è®¿é—®çš„å†…å­˜ï¼Œä¸€ä¸ªè¿›ç¨‹åˆ›å»ºï¼Œå…¶å®ƒè¿›ç¨‹å¯è®¿é—®ã€‚å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„IPCæ–¹å¼ï¼Œå¾€å¾€å’Œä¿¡å·é‡ä¸€èµ·ä½¿ç”¨ï¼Œè¾¾åˆ°è¿›ç¨‹é—´çš„åŒæ­¥å’Œäº’æ–¥ã€‚</p>
<h4 id="ç®¡é“"><a class="header-anchor" href="#ç®¡é“">Â¶</a>ç®¡é“</h4>
<p>å®è´¨å°±æ˜¯ä¸€ä¸ªç¼“å†²åŒºã€‚<br>
ç®¡é“é™åˆ¶ï¼š</p>
<ul>
<li>åŠåŒå·¥</li>
<li>åªèƒ½åœ¨äº²ç¼˜è¿›ç¨‹é—´é€šä¿¡</li>
</ul>
<p><strong>ç‰¹ç‚¹:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å†™æ»¡æ—¶ï¼Œä¸èƒ½å†å†™ï¼Œè¯»ç©ºæ—¶ï¼Œä¸èƒ½å†è¯»</span><br><span class="line">æ²¡å†™æ»¡ï¼Œä¸èƒ½è¯»ï¼Œæ²¡è¯»ç©ºï¼Œä¸èƒ½å†™</span><br></pre></td></tr></table></figure>
<h4 id="æ¶ˆæ¯é˜Ÿåˆ—"><a class="header-anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—">Â¶</a>æ¶ˆæ¯é˜Ÿåˆ—</h4>
<p>æ˜¯ä¸€ç§æ¶ˆæ¯çš„é“¾è¡¨ï¼Œè§£å†³äº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµåŠç®¡é“å¤§å°é™åˆ¶çš„ç¼ºç‚¹ã€‚</p>
<h4 id="ä¿¡å·"><a class="header-anchor" href="#ä¿¡å·">Â¶</a>ä¿¡å·</h4>
<p>é€šçŸ¥å’Œæ¥å—è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿäº†çš„ã€‚</p>
<h4 id="ä¿¡å·é‡"><a class="header-anchor" href="#ä¿¡å·é‡">Â¶</a>ä¿¡å·é‡</h4>
<p>å®è´¨ä¸Šå°±æ˜¯ä¸ªè®¡æ•°å™¨ï¼Œç”¨æ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹äºå…±äº«èµ„æºçš„è®¿é—®æƒ…å†µã€‚</p>
<h4 id="å¥—æ¥å­—ï¼ˆSocketï¼‰"><a class="header-anchor" href="#å¥—æ¥å­—ï¼ˆSocketï¼‰">Â¶</a>å¥—æ¥å­—ï¼ˆSocketï¼‰</h4>
<p>è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æœºåˆ¶ï¼Œå¤šç”¨äºä¸åŒæœºå™¨è¿›ç¨‹é—´çš„é€šä¿¡ã€‚</p>
<h4 id="ä¼˜ç¼ºç‚¹ï¼š"><a class="header-anchor" href="#ä¼˜ç¼ºç‚¹ï¼š">Â¶</a>ä¼˜ç¼ºç‚¹ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€ç®¡é“ï¼šé€Ÿåº¦æ…¢ï¼Œå®¹é‡æœ‰é™ï¼Œåªæœ‰çˆ¶å­è¿›ç¨‹èƒ½é€šè®¯.</span><br><span class="line"><span class="number">2</span>ã€FIFOï¼šä»»ä½•è¿›ç¨‹é—´éƒ½èƒ½é€šè®¯ï¼Œä½†é€Ÿåº¦æ…¢.</span><br><span class="line"><span class="number">3</span>ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼šå®¹é‡å—åˆ°ç³»ç»Ÿé™åˆ¶ï¼Œä¸”è¦æ³¨æ„ç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™ï¼Œè¦è€ƒè™‘ä¸Šä¸€æ¬¡æ²¡æœ‰è¯»å®Œæ•°æ®çš„é—®é¢˜.</span><br><span class="line"><span class="number">4</span>ã€ä¿¡å·é‡ï¼šä¸èƒ½ä¼ é€’å¤æ‚æ¶ˆæ¯ï¼Œåªèƒ½ç”¨æ¥åŒæ­¥.</span><br><span class="line"><span class="number">5</span>ã€å…±äº«å†…å­˜åŒºï¼šèƒ½å¤Ÿå¾ˆå®¹æ˜“æ§åˆ¶å®¹é‡ï¼Œé€Ÿåº¦å¿«ï¼Œä½†è¦ä¿æŒåŒæ­¥ï¼Œæ¯”å¦‚ä¸€ä¸ªè¿›ç¨‹åœ¨å†™çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹è¦æ³¨æ„è¯»å†™çš„é—®é¢˜ï¼Œç›¸å½“äºçº¿ç¨‹ä¸­çš„çº¿ç¨‹å®‰å…¨ï¼Œå½“ç„¶ï¼Œå…±äº«å†…å­˜åŒºåŒæ ·å¯ä»¥ç”¨ä½œçº¿ç¨‹é—´é€šè®¯ï¼Œä¸è¿‡æ²¡è¿™ä¸ªå¿…è¦ï¼Œçº¿ç¨‹é—´æœ¬æ¥å°±å·²ç»å…±äº«äº†åŒä¸€è¿›ç¨‹å†…çš„ä¸€å—å†…å­˜.</span><br></pre></td></tr></table></figure>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>è¿›ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ12ã€go æŒ‡é’ˆå’Œå¼•ç”¨</title>
    <url>/archives/1191d613.html</url>
    <content><![CDATA[<p>ä»Šå†™ä»£ç æ—¶ï¼Œä¼ å‡½æ•°æ— æ„é—´æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œsliceé€šè¿‡å‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œä¸ºä½•å¯ä»¥æ”¹å˜å…·ä½“çš„å€¼å‘¢ï¼Ÿ</p>
<p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</p>
<ul>
<li>å®˜æ–¹æŸ¥æ–‡æ¡£</li>
<li>çœ‹æºç </li>
<li>googleçœ‹çœ‹æœ‰æ²¡æœ‰å¥½çš„è§è§£</li>
<li>æ€è€ƒğŸ¤”+å†¥æƒ³ğŸ§˜â€â™‚ï¸</li>
</ul>
<p>ï¼ˆps:è§£å†³é—®é¢˜ï¼Œä¸»è¦ä¸æ˜¯çœ‹ç»“æœæ˜¯æ€ä¹ˆæ ·çš„ï¼Œä¸»è¦æ˜¯è€ƒè™‘é—®é¢˜çš„è§’åº¦ï¼‰</p>
<a id="more"></a>
<h3 id="æŸ¥èµ„æ–™"><a class="header-anchor" href="#æŸ¥èµ„æ–™">Â¶</a>æŸ¥èµ„æ–™</h3>
<p><a href="https://golang.google.cn/doc/effective_go.html#slices">å®˜ç½‘æŒ‡å—ä¹‹Slice</a><br>
æœ‰ä¸€æ®µæ˜¯è¿™ä¹ˆæè¿°ï¼š<br>
<em>Slices hold references to an underlying array, and if you assign one slice to another, both refer to the same array.</em></p>
<h3 id="æŸ¥æºç "><a class="header-anchor" href="#æŸ¥æºç ">Â¶</a>æŸ¥æºç </h3>
<h4 id="src-runtime-slice-go"><a class="header-anchor" href="#src-runtime-slice-go">Â¶</a>/src/runtime/slice.go</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">	array unsafe.Pointer  <span class="comment">//æŒ‡é’ˆç±»å‹å“¦</span></span><br><span class="line">	<span class="built_in">len</span>   <span class="keyword">int</span></span><br><span class="line">	<span class="built_in">cap</span>   <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€è€ƒ"><a class="header-anchor" href="#æ€è€ƒ">Â¶</a>æ€è€ƒ</h3>
<blockquote>
<p>åŸæ¥ä¸‹å±‚æ˜¯ç”¨è¿‡arrayè¿™ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å…·ä½“çš„æ•°æ®çš„</p>
</blockquote>
<blockquote>
<p>é‚£ä¹ˆå…¶ä»–çš„å¼•ç”¨ç±»å‹å‘¢ï¼Ÿ</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Map?</span><br><span class="line">chan?</span><br><span class="line">interface?</span><br><span class="line">&#x2F;&#x2F;Slice?</span><br></pre></td></tr></table></figure>
<h3 id="å¼•ç”¨ç±»å‹ä¹‹Map"><a class="header-anchor" href="#å¼•ç”¨ç±»å‹ä¹‹Map">Â¶</a>å¼•ç”¨ç±»å‹ä¹‹Map</h3>
<h4 id="çœ‹æºç -src-runtime-map-goï¼š"><a class="header-anchor" href="#çœ‹æºç -src-runtime-map-goï¼š">Â¶</a>çœ‹æºç  /src/runtime/map.goï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// A header for a Go map.</span></span><br><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span></span><br><span class="line">	<span class="comment">// Make sure this stays in sync with the compiler&#x27;s definition.</span></span><br><span class="line">	count     <span class="keyword">int</span> <span class="comment">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class="line">	flags     <span class="keyword">uint8</span></span><br><span class="line">	B         <span class="keyword">uint8</span>  <span class="comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class="line">	noverflow <span class="keyword">uint16</span> <span class="comment">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class="line">	hash0     <span class="keyword">uint32</span> <span class="comment">// hash seed</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡æ­¤æŒ‡é’ˆç±»å‹</span></span><br><span class="line">	buckets    unsafe.Pointer <span class="comment">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class="line">	oldbuckets unsafe.Pointer <span class="comment">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class="line">	nevacuate  <span class="keyword">uintptr</span>        <span class="comment">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class="line"></span><br><span class="line">	extra *mapextra <span class="comment">// optional fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼•ç”¨ç±»å‹ä¹‹Chan"><a class="header-anchor" href="#å¼•ç”¨ç±»å‹ä¹‹Chan">Â¶</a>å¼•ç”¨ç±»å‹ä¹‹Chan</h3>
<h4 id="æºç -src-runtime-chan-go"><a class="header-anchor" href="#æºç -src-runtime-chan-go">Â¶</a>æºç :/src/runtime/chan.go</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">	qcount   <span class="keyword">uint</span>           <span class="comment">// total data in the queue</span></span><br><span class="line">    dataqsiz <span class="keyword">uint</span>           <span class="comment">// size of the circular queue</span></span><br><span class="line">    <span class="comment">//é€šè¿‡æ­¤æŒ‡é’ˆç±»å‹æ¥å¤„ç†</span></span><br><span class="line">	buf      unsafe.Pointer <span class="comment">// points to an array of dataqsiz elements</span></span><br><span class="line">	elemsize <span class="keyword">uint16</span></span><br><span class="line">	closed   <span class="keyword">uint32</span></span><br><span class="line">	elemtype *_type <span class="comment">// element type</span></span><br><span class="line">	sendx    <span class="keyword">uint</span>   <span class="comment">// send index</span></span><br><span class="line">	recvx    <span class="keyword">uint</span>   <span class="comment">// receive index</span></span><br><span class="line">	recvq    waitq  <span class="comment">// list of recv waiters</span></span><br><span class="line">	sendq    waitq  <span class="comment">// list of send waiters</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// lock protects all fields in hchan, as well as several</span></span><br><span class="line">	<span class="comment">// fields in sudogs blocked on this channel.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Do not change another G&#x27;s status while holding this lock</span></span><br><span class="line">	<span class="comment">// (in particular, do not ready a G), as this can deadlock</span></span><br><span class="line">	<span class="comment">// with stack shrinking.</span></span><br><span class="line">	lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼•ç”¨ç±»å‹ä¹‹Interface"><a class="header-anchor" href="#å¼•ç”¨ç±»å‹ä¹‹Interface">Â¶</a>å¼•ç”¨ç±»å‹ä¹‹Interface</h3>
<h4 id="æºç -src-runtime-runtime2-go"><a class="header-anchor" href="#æºç -src-runtime-runtime2-go">Â¶</a>æºç /src/runtime/runtime2.go</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> iface <span class="keyword">struct</span> &#123;</span><br><span class="line">    tab  *itab</span><br><span class="line">    <span class="comment">//æŒ‡é’ˆç±»å‹</span></span><br><span class="line">	data unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> eface <span class="keyword">struct</span> &#123;</span><br><span class="line">    _type *_type</span><br><span class="line">    <span class="comment">//æŒ‡é’ˆç±»å‹</span></span><br><span class="line">	data  unsafe.Pointer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç»“è®ºï¼Ÿé€šè¿‡æŒ‡é’ˆï¼Ÿ"><a class="header-anchor" href="#ç»“è®ºï¼Ÿé€šè¿‡æŒ‡é’ˆï¼Ÿ">Â¶</a>ç»“è®ºï¼Ÿé€šè¿‡æŒ‡é’ˆï¼Ÿ</h3>
<p>ä»ä¸Šè¿°æºç çœ‹æ¥ï¼Œå†…éƒ¨ç»“æ„ä¸­éƒ½æ˜¯ç”¨æŒ‡é’ˆç±»å‹æ¥æŒ‡å‘å…·ä½“çš„å€¼ï¼Œ</p>
<blockquote>
<p>Soï¼šå½¢åŒè¿™ç±»çš„ç»“æ„ï¼Œè‚¯å®šæ˜¯å¼•ç”¨ç±»å‹çš„ï¼Œå…·ä½“æ˜¯æŒ‡é’ˆæŒ‡å‘åˆ«çš„åœ°å€ï¼Œä»è€Œæ¥å¼•ç”¨å€¼ã€‚</p>
</blockquote>
<p>å…¶å®è¿™ä¸ªç‰¹æ€§å¾ˆæ—©å°±æ™“å¾—äº†ï¼Œåªæ˜¯ä»Šå¤©åˆçœ‹åˆ°äº†ï¼Œè§‰å¾—è¿˜æ˜¯è®°å½•ç€å§ï¼Œä¹Ÿè®¸åç»­å“ªä¸€å¤©å°±æœ‰äº†åˆ›æ–°çš„çµæ„Ÿæ¥ç€~~.</p>
<p>[ç¡è§‰äº†ï½æœ€è¿‘æœ‰ç‚¹ä¹ï½ZZzzzâ€¦]</p>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Go Package</tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ11ã€hexo ä¸»é¢˜&amp;è¯„è®º&amp;è¿›åº¦æ¡&amp;èƒŒæ™¯æ•ˆæœ</title>
    <url>/archives/e18c94ab.html</url>
    <content><![CDATA[<p>æ™šä¸ŠæŠ˜è…¾äº†ä¸‹åšå®¢ï¼Œç¨å¾®è£…é¥°äº†ä¸‹ï¼Œä¸»è¦è¿˜æ˜¯åŠ äº†ä¸ªè¯„è®ºå§ï¼Œå…¶å®ƒéå¸¸ç§€çš„æ’ä»¶å°±æ²¡æœ‰æ¥å…¥äº†ï¼Œæ‡’å¾—æŠ˜è…¾ï¼Œå¥½å¥½å†™åšå®¢ï¼Œå†…å®¹æ‰æ˜¯ç²¾åã€‚<br>
è®°å½•ä¸‹æŠ˜è…¾å²ï¼š</p>
<h3 id="gitalkè¯„è®ºæ’ä»¶"><a class="header-anchor" href="#gitalkè¯„è®ºæ’ä»¶">Â¶</a>gitalkè¯„è®ºæ’ä»¶</h3>
<h4 id="æ­¥éª¤ï¼š"><a class="header-anchor" href="#æ­¥éª¤ï¼š">Â¶</a>æ­¥éª¤ï¼š</h4>
<h5 id="ç”³è¯·idå’Œsecret"><a class="header-anchor" href="#ç”³è¯·idå’Œsecret">Â¶</a>ç”³è¯·idå’Œsecret</h5>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png" alt=""></p>
<a id="more"></a>
<h4 id="é…ç½®æ–‡ä»¶ï¼š"><a class="header-anchor" href="#é…ç½®æ–‡ä»¶ï¼š">Â¶</a>é…ç½®æ–‡ä»¶ï¼š</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gitalk:</span><br><span class="line">  enable: true</span><br><span class="line">  github_id: crab21 # GitHub repo owner</span><br><span class="line">  repo: blog # Repository name to store issues</span><br><span class="line">  client_id: XXX # GitHub Application Client ID</span><br><span class="line">  client_secret: XXX # GitHub Application Client Secret</span><br><span class="line">  admin_user: crab21 # GitHub repo owner and collaborators, only these guys can initialize gitHub issues</span><br><span class="line">  distraction_free_mode: true # Facebook-like distraction free mode</span><br><span class="line">  perPage: 15 #æ¯é¡µå¤šå°‘ä¸ªè¯„è®º</span><br><span class="line">  pagerDirection: last  #æ’åºæ–¹å¼æ˜¯ä»æ—§åˆ°æ–°ï¼ˆfirstï¼‰è¿˜æ˜¯ä»æ–°åˆ°æ—§ï¼ˆlastï¼‰</span><br><span class="line">  createIssueManually: true #å¦‚æœå½“å‰é¡µé¢æ²¡æœ‰ç›¸åº”çš„ isssue ï¼Œä¸”ç™»å½•çš„ç”¨æˆ·å±äº adminï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»º issueã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™æ˜¾ç¤ºä¸€ä¸ªåˆå§‹åŒ–é¡µé¢ï¼Œåˆ›å»º issue éœ€è¦ç‚¹å‡» init æŒ‰é’®ã€‚</span><br><span class="line">  distractionFreeMode: true #æ˜¯å¦å¯ç”¨å¿«æ·é”®(cmd|ctrl + enter) æäº¤è¯„è®º.</span><br><span class="line"></span><br><span class="line">  # Gitalk&#39;s display language depends on user&#39;s browser or system environment</span><br><span class="line">  # If you want everyone visiting your site to see a uniform language, you can set a force language value</span><br><span class="line">  # Available values: en | es-ES | fr | ru | zh-CN | zh-TW</span><br><span class="line">  language:</span><br></pre></td></tr></table></figure>
<h3 id="pacé˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”"><a class="header-anchor" href="#pacé˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”">Â¶</a>pacé˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”</h3>
<p>1ã€githubåœ°å€ï¼š https://github.com/HubSpot/paceï¼Œå¯ä»¥çœ‹ä¸‹ä»‹ç»<br>
2ã€ä¿®æ”¹å€¼ï¼š<br>
ä¿®æ”¹ä¸»é¢˜ä¸‹é¢çš„_config.ymlï¼š<br>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pace:</span><br><span class="line">    enable: <span class="literal">true</span></span><br><span class="line">    # Themes list:</span><br><span class="line">    # big-counter | bounce | barber-shop | center-atom | center-circle | center-radar | center-simple</span><br><span class="line">    # corner-indicator | fill-left | flat-top | flash | loading-bar | mac-osx | material | minimal</span><br><span class="line">    theme: minimal</span><br></pre></td></tr></table></figure></p>
<h3 id="reading-progress"><a class="header-anchor" href="#reading-progress">Â¶</a>reading_progress</h3>
<p>githubåœ°å€ï¼šhttps://github.com/theme-next/theme-next-reading-progress</p>
<p>åŒ…å«ä½¿ç”¨è¯´æ˜å’Œå…·ä½“çš„æ­¥éª¤ï¼Œå°±ä¸æ¬è¿äº†ï¼ŒåŠæ—¶è°ƒæ•´ã€‚</p>
<h3 id="æ–‡ç« å­—æ•°å’Œé˜…è¯»æ—¶é—´ç»Ÿè®¡ï¼š"><a class="header-anchor" href="#æ–‡ç« å­—æ•°å’Œé˜…è¯»æ—¶é—´ç»Ÿè®¡ï¼š">Â¶</a>æ–‡ç« å­—æ•°å’Œé˜…è¯»æ—¶é—´ç»Ÿè®¡ï¼š</h3>
<p>hexoé…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ï¼š<br>
<code>symbols_count_time</code> ä¸ºtrue.</p>
<h3 id="back2top"><a class="header-anchor" href="#back2top">Â¶</a>back2top</h3>
<p>å¼€å¯æ¨¡å¼</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">back2top:</span><br><span class="line">  enable: true</span><br><span class="line">  # Back to top in sidebar.</span><br><span class="line">  sidebar: true</span><br><span class="line">  # Scroll percent label in b2t button.</span><br><span class="line">  scrollpercent: true</span><br></pre></td></tr></table></figure>
<h3 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h3>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>hexo</tag>
        <tag>hexoæ’ä»¶</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ10ã€go mutexè§£è¯»</title>
    <url>/archives/ff0d6c2b.html</url>
    <content><![CDATA[<p>ä¸Šæ¬¡è¯´åˆ°rwmutexè¯»å†™é”ï¼Œå…¶å®å°±æ˜¯åŠ å¼ºäº†é”çš„ç²’åº¦ï¼ŒåŒºåˆ†è¯»å’Œå†™æ—¶ä¸åŒçš„æƒ…å†µï¼Œæ ¸å¿ƒæ€æƒ³ï¼šå†™ä¼˜å…ˆäºè¯»ã€‚<br>
è¿™æ¬¡æ¥çœ‹çœ‹mutexï¼Œgoä¸­çš„é”æ˜¯å¦‚ä½•å®ç°çš„ï¼Œç”¨ä¸€å¼ å›¾æ¥æ¦‚æ‹¬æ•´ä¸ªæµç¨‹ï¼š</p>
<a id="more"></a>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/mutex.png" alt=""></p>
<blockquote>
<p>æ ¸å¿ƒæ€æƒ³ï¼šé¥¥é¥¿å’Œé˜Ÿåˆ—ï¼Œæ­£å¸¸æµç¨‹éƒ½æ˜¯åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´é™åˆ¶åˆ™åŠ å…¥åˆ°é˜Ÿåˆ—å¤´éƒ¨ã€‚</p>
</blockquote>
<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<blockquote>
<p>å¼€å§‹çœ‹ä»£ç æˆ–è€…åˆ†æä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹æ–‡æ¡£è¯´æ˜åŠå…¶ç›¸å…³çš„èµ„æ–™ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">â—¯  go version</span><br><span class="line">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>
<h3 id="src-sync-mutex-go"><a class="header-anchor" href="#src-sync-mutex-go">Â¶</a>src/sync/mutex.go</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	mutexLocked = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span> <span class="comment">// mutex is locked      state &amp; mutexLocked 1==åŠ é”  0==æœªåŠ é”</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	mutexWoken                                      <span class="comment">//state &amp; mutexWoken 1==å”¤é†’  0==æœªå”¤é†’</span></span><br><span class="line">	mutexStarving                                   <span class="comment">// state &amp; mutexStarving 1==é¥¥é¥¿çŠ¶æ€   0==æ­£å¸¸çŠ¶æ€</span></span><br><span class="line">	mutexWaiterShift = <span class="literal">iota</span>                         <span class="comment">// state &gt;&gt; mutexWaiterShiftå¾—åˆ°å½“å‰çš„goroutineæ•°é‡</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Mutex fairness.</span></span><br><span class="line">	<span class="comment">// ä¸¤ç§æ¨¡å¼ï¼šæ­£å¸¸æˆ–é¥¥é¥¿</span></span><br><span class="line">    <span class="comment">// Mutex can be in 2 modes of operations: normal and starvation.</span></span><br><span class="line">    <span class="comment">//  æ­£å¸¸æ¨¡å¼å°±æ˜¯FIFOé˜Ÿåˆ—ã€‚</span></span><br><span class="line">	<span class="comment">// In normal mode waiters are queued in FIFO order, but a woken up waiter</span></span><br><span class="line">	<span class="comment">// does not own the mutex and competes with new arriving goroutines over</span></span><br><span class="line">	<span class="comment">// the ownership. New arriving goroutines have an advantage -- they are</span></span><br><span class="line">	<span class="comment">// already running on CPU and there can be lots of them, so a woken up</span></span><br><span class="line">	<span class="comment">// waiter has good chances of losing. In such case it is queued at front</span></span><br><span class="line">	<span class="comment">// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,  //è·å–é”çš„æ—¶é—´è¶…è¿‡1msï¼Œåˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">	<span class="comment">// it switches mutex to the starvation mode.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// In starvation mode ownership of the mutex is directly handed off from        //é¥¥é¥¿æ¨¡å¼ä¸‹é”çš„æ‰€æœ‰æƒç›´æ¥ä»è§£é”goroutineçš„waiteræ‰‹ä¸­ç§»äº¤åˆ°é˜Ÿåˆ—çš„å‰é¢ã€‚</span></span><br><span class="line">	<span class="comment">// the unlocking goroutine to the waiter at the front of the queue.</span></span><br><span class="line">	<span class="comment">// New arriving goroutines don&#x27;t try to acquire the mutex even if it appears</span></span><br><span class="line">	<span class="comment">// to be unlocked, and don&#x27;t try to spin. Instead they queue themselves at</span></span><br><span class="line">	<span class="comment">// the tail of the wait queue.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// If a waiter receives ownership of the mutex and sees that either         //å¦‚æœä¸€ä¸ªé”çš„æ‰€æœ‰æƒçš„ç­‰å¾…è€…æ˜¯ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€çš„ï¼š1ã€å¤„äºé˜Ÿåˆ—çš„æœ€åä¸€ä¸ª2ã€ç­‰å¾…æ—¶é—´å°‘äº1msï¼Œåˆ™åˆ‡æ¢åˆ°æ­£å¸¸æ¨¡å¼</span></span><br><span class="line">	<span class="comment">// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,</span></span><br><span class="line">	<span class="comment">// it switches mutex back to normal operation mode.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Normal mode has considerably better performance as a goroutine can acquire</span></span><br><span class="line">	<span class="comment">// a mutex several times in a row even if there are blocked waiters.</span></span><br><span class="line">	<span class="comment">// Starvation mode is important to prevent pathological cases of tail latency.</span></span><br><span class="line">	starvationThresholdNs = <span class="number">1e6</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="åŠ é”æµç¨‹"><a class="header-anchor" href="#åŠ é”æµç¨‹">Â¶</a>åŠ é”æµç¨‹</h3>
<blockquote>
<p>åŠ é”è¿‡ç¨‹å›¾å¦‚ä¸Šå›¾æåˆ°çš„æµç¨‹ã€‚</p>
</blockquote>
<blockquote>
<p>åŠ é”ä»£ç å…·ä½“æµç¨‹ï¼š</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Fast path: grab unlocked mutex.</span></span><br><span class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</span><br><span class="line">		<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">			race.Acquire(unsafe.Pointer(m))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Slow path (outlined so that the fast path can be inlined)</span></span><br><span class="line">	m.lockSlow()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">lockSlow</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> waitStartTime <span class="keyword">int64</span> <span class="comment">//ç­‰å¾…æ—¶é—´</span></span><br><span class="line">	starving := <span class="literal">false</span>       <span class="comment">//æ˜¯å¦å¤„äºé¥¥é¥¿çŠ¶æ€</span></span><br><span class="line">	awoke := <span class="literal">false</span>          <span class="comment">//å”¤é†’çŠ¶æ€</span></span><br><span class="line">	iter := <span class="number">0</span>               <span class="comment">//è‡ªæ—‹æ¬¡æ•°</span></span><br><span class="line">	old := m.state          <span class="comment">//å½“å‰çŠ¶æ€copy</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// Don&#x27;t spin in starvation mode, ownership is handed off to waiters</span></span><br><span class="line">        <span class="comment">// so we won&#x27;t be able to acquire the mutex anyway.</span></span><br><span class="line">        <span class="comment">//åŠ é”ä¸”èƒ½å¤Ÿè‡ªæ—‹</span></span><br><span class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</span><br><span class="line">			<span class="comment">// Active spinning makes sense.</span></span><br><span class="line">			<span class="comment">// Try to set mutexWoken flag to inform Unlock</span></span><br><span class="line">            <span class="comment">// to not wake other blocked goroutines.</span></span><br><span class="line">            <span class="comment">//è‡ªæ—‹è¿‡ç¨‹å‘ç°æ²¡æœ‰è¢«ç½®wokenæ ‡è¯†ï¼Œè®¾ç½®æ ‡è¯†ï¼Œå°†è‡ªå·±ç½®ä¸ºå”¤é†’</span></span><br><span class="line">			<span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</span><br><span class="line">				atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</span><br><span class="line">				awoke = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			runtime_doSpin()    <span class="comment">//è‡ªæ—‹</span></span><br><span class="line">			iter++              </span><br><span class="line">			old = m.state       <span class="comment">//çŠ¶æ€é‡ç½®</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ›´æ–°çŠ¶æ€</span></span><br><span class="line">		<span class="built_in">new</span> := old</span><br><span class="line">        <span class="comment">// Don&#x27;t try to acquire starving mutex, new arriving goroutines must queue.</span></span><br><span class="line">        <span class="comment">//éé¥¥é¥¿æ¨¡å¼ï¼Œåˆ™ç½®é”</span></span><br><span class="line">		<span class="keyword">if</span> old&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">new</span> |= mutexLocked</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œæ–°æ¥çš„goroutineè¿›å…¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">new</span> += <span class="number">1</span> &lt;&lt; mutexWaiterShift</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// The current goroutine switches mutex to starvation mode.</span></span><br><span class="line">		<span class="comment">// But if the mutex is currently unlocked, don&#x27;t do the switch.</span></span><br><span class="line">		<span class="comment">// Unlock expects that starving mutex has waiters, which will not</span></span><br><span class="line">        <span class="comment">// be true in this case.</span></span><br><span class="line">        <span class="comment">//åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ä¸‹</span></span><br><span class="line">		<span class="keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">new</span> |= mutexStarving</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å½“å‰å¤„äºå”¤é†’çŠ¶æ€ï¼Œåˆ™é‡ç½®æ¸…é™¤å”¤é†’çŠ¶æ€ã€‚</span></span><br><span class="line">		<span class="keyword">if</span> awoke &#123;</span><br><span class="line">			<span class="comment">// The goroutine has been woken from sleep,</span></span><br><span class="line">			<span class="comment">// so we need to reset the flag in either case.</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</span><br><span class="line">				throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">new</span> &amp;^= mutexWoken</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//CASæ›´æ–°çŠ¶æ€ã€‚</span></span><br><span class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line">            <span class="comment">//è·å–åˆ°é”</span></span><br><span class="line">			<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">break</span> <span class="comment">// locked the mutex with CAS</span></span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// If we were already waiting before, queue at the front of the queue.</span></span><br><span class="line">            <span class="comment">//ç­‰å¾…é˜Ÿåˆ—çš„æ—¶é—´</span></span><br><span class="line">			queueLifo := waitStartTime != <span class="number">0</span></span><br><span class="line">			<span class="keyword">if</span> waitStartTime == <span class="number">0</span> &#123;</span><br><span class="line">				waitStartTime = runtime_nanotime()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//acquireé˜»å¡é˜Ÿåˆ—....</span></span><br><span class="line">            <span class="comment">// æ–°æ¥çš„ goroutine, queueLifo=false, åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œè€å¿ƒç­‰å¾…</span></span><br><span class="line">            <span class="comment">// å”¤é†’çš„ goroutine, queueLifo=true, åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å¤´éƒ¨</span></span><br><span class="line">			runtime_SemacquireMutex(&amp;m.sema, queueLifo, <span class="number">1</span>)</span><br><span class="line">			starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</span><br><span class="line">            old = m.state</span><br><span class="line">            <span class="comment">//å¤„äºé¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">			<span class="keyword">if</span> old&amp;mutexStarving != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// If this goroutine was woken and mutex is in starvation mode,</span></span><br><span class="line">				<span class="comment">// ownership was handed off to us but mutex is in somewhat</span></span><br><span class="line">				<span class="comment">// inconsistent state: mutexLocked is not set and we are still</span></span><br><span class="line">				<span class="comment">// accounted as waiter. Fix that.</span></span><br><span class="line">				<span class="keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="number">0</span> &#123;</span><br><span class="line">					throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ç­‰å¾…çš„goroutine-1</span></span><br><span class="line">                delta := <span class="keyword">int32</span>(mutexLocked - <span class="number">1</span>&lt;&lt;mutexWaiterShift)</span><br><span class="line">                <span class="comment">// å¤„äºé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæˆ–è€…è¯·æ±‚é”çš„æ—¶é—´æœªè¶…è¿‡starvationThresholdNsï¼Œåˆ™å›é€€åˆ°æ­£å¸¸æ¨¡å¼ã€‚</span></span><br><span class="line">				<span class="keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="number">1</span> &#123;</span><br><span class="line">					<span class="comment">// Exit starvation mode.</span></span><br><span class="line">					<span class="comment">// Critical to do it here and consider wait time.</span></span><br><span class="line">					<span class="comment">// Starvation mode is so inefficient, that two goroutines</span></span><br><span class="line">					<span class="comment">// can go lock-step infinitely once they switch mutex</span></span><br><span class="line">					<span class="comment">// to starvation mode.</span></span><br><span class="line">					delta -= mutexStarving</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//æ›´æ–°çŠ¶æ€</span></span><br><span class="line">				atomic.AddInt32(&amp;m.state, delta)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é‡ç½®è¿­ä»£å™¨å’Œå”¤é†’è¡¨ç¤ºï¼Œç»§ç»­è·å–é”</span></span><br><span class="line">			awoke = <span class="literal">true</span></span><br><span class="line">			iter = <span class="number">0</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//CASå¤±è´¥ï¼Œåˆ™æ›´æ–°çŠ¶æ€ï¼Œç»§ç»­è·å–ã€‚</span></span><br><span class="line">			old = m.state</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Acquire(unsafe.Pointer(m))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="è§£é”è¿‡ç¨‹"><a class="header-anchor" href="#è§£é”è¿‡ç¨‹">Â¶</a>è§£é”è¿‡ç¨‹</h3>
<p>ç”¨ä¸€ä¸ªæµç¨‹å›¾æ¥è¡¨ç¤ºè§£é”è¿‡ç¨‹ï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/mutex-unlock.png" alt=""></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//state ä¸æ˜¯å¤„äºé”çš„çŠ¶æ€, é‚£ä¹ˆå°±æ˜¯ Unlock æ ¹æœ¬æ²¡æœ‰åŠ é”çš„ mutex, panic</span></span><br><span class="line">    <span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123;</span><br><span class="line">        throw(<span class="string">&quot;sync: unlock of unlocked mutex&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”ï¼Œå¹¶é€šçŸ¥å…¶å®ƒç­‰å¾…è€…</span></span><br><span class="line">    <span class="comment">// é”å¦‚æœå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œç›´æ¥äº¤ç»™ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª, å”¤é†’å®ƒï¼Œè®©å®ƒå»è·å–é”</span></span><br><span class="line">    <span class="comment">// mutex æ­£å¸¸æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line">        old := <span class="built_in">new</span></span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰ç­‰å¾…è€…ï¼Œæˆ–è€…å·²ç»å­˜åœ¨ä¸€ä¸ª goroutine è¢«å”¤é†’æˆ–å¾—åˆ°é”ã€æˆ–å¤„äºé¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">            <span class="comment">// ç›´æ¥è¿”å›.</span></span><br><span class="line">            <span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†ç­‰å¾…çš„ goroutine-1ï¼Œå¹¶è®¾ç½® woken æ ‡è¯†</span></span><br><span class="line">            <span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</span><br><span class="line">            <span class="comment">// è®¾ç½®æ–°çš„ state, è¿™é‡Œé€šè¿‡ä¿¡å·é‡ä¼šå”¤é†’ä¸€ä¸ªé˜»å¡çš„ goroutine å»è·å–é”.</span></span><br><span class="line">            <span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line">                runtime_Semrelease(&amp;m.sema, <span class="literal">false</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            old = m.state</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// mutex é¥¥é¥¿æ¨¡å¼ï¼Œç›´æ¥å°† mutex æ‹¥æœ‰æƒç§»äº¤ç»™ç­‰å¾…é˜Ÿåˆ—æœ€å‰ç«¯çš„ goroutine</span></span><br><span class="line">        <span class="comment">// æ³¨æ„æ­¤æ—¶ state çš„ mutex è¿˜æ²¡æœ‰åŠ é”ï¼Œå”¤é†’çš„ goroutine ä¼šè®¾ç½®å®ƒã€‚</span></span><br><span class="line">        <span class="comment">// åœ¨æ­¤æœŸé—´ï¼Œå¦‚æœæœ‰æ–°çš„ goroutine æ¥è¯·æ±‚é”ï¼Œ å› ä¸º mutex å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œ mutex è¿˜æ˜¯è¢«è®¤ä¸ºå¤„äºé”çŠ¶æ€ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ–°æ¥çš„ goroutine ä¸ä¼šæŠŠé”æŠ¢è¿‡å».</span></span><br><span class="line">        runtime_Semrelease(&amp;m.sema, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å…³é”®ç‚¹"><a class="header-anchor" href="#å…³é”®ç‚¹">Â¶</a>å…³é”®ç‚¹</h3>
<ul>
<li>ä¸è¦é‡å¤é”å®šäº’æ–¥é”</li>
<li>ä¸è¦å¿˜è®°è§£é”äº’æ–¥é”</li>
<li>ä¸è¦åœ¨å¤šä¸ªå‡½æ•°ä¹‹é—´ç›´æ¥ä¼ é€’äº’æ–¥é”</li>
</ul>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Go Package</tag>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ9ã€Go reflect ~ DeepEqual</title>
    <url>/archives/e2e7cc4e.html</url>
    <content><![CDATA[<p>ä»Šå¤©æ— æ„ä¸­çœ‹åˆ°Go101å‘äº†ä¸€ä¸ªæ¨ç‰¹:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">p</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">  fmt.Print(<span class="string">&quot;:&quot;</span>, reflect.DeepEqual(a, b))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  a := [<span class="number">1</span>]<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;&#125;&#125;</span><br><span class="line">  p(a, a)</span><br><span class="line">  p(a[:], a[:])</span><br><span class="line">  b := a</span><br><span class="line">  p(a[:], b[:])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¾“å‡ºç»“æœï¼Ÿï¼Ÿ :true:true:false</p>
</blockquote>
<a id="more"></a>
<blockquote>
<p>æ­£ç¡®ç­”æ¡ˆ :false:true:false</p>
</blockquote>
<h3 id="é”™è¯¯æ¥æº"><a class="header-anchor" href="#é”™è¯¯æ¥æº">Â¶</a>é”™è¯¯æ¥æº</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç¬¬ä¸€ä¸ªä¸ºå•¥æƒ³ç€ä¸ºtrue,ç¬¬ä¸€çœ¼çœ‹è¿‡å»ï¼Œæ¯”è¾ƒä¸¤ä¸ªaçš„å‡½æ•°ï¼Œé‚£ä¸¤ä¸ªå‡½æ•°è‚¯å®šæ˜¯ç›¸ç­‰çš„ï¼Œè¿™æ˜¯ç¬¬ä¸€ç›´è§‰(ç‹—å±ç›´è§‰).</span><br><span class="line">ç¬¬äºŒä¸ªä¸¤ä¸ªéƒ½ä¸ºniläº†ï¼Œè¿™ä¸ªæ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¸¤ä¸ªnilè‚¯å®šæ˜¯deepç›¸ç­‰çš„ã€‚</span><br><span class="line">ç¬¬ä¸‰ä¸ªè™½ç„¶æ˜¯é‡æ–°åˆå§‹åŒ–äº†ï¼Œæ‰€ä»¥ä¸¤ä¸ªè‚¯å®šä¸æ˜¯deepç›¸ç­‰çš„ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="æ€è·¯æ¯”å¯¹ï¼ˆé”™åœ¨å“ªé‡Œï¼‰"><a class="header-anchor" href="#æ€è·¯æ¯”å¯¹ï¼ˆé”™åœ¨å“ªé‡Œï¼‰">Â¶</a>æ€è·¯æ¯”å¯¹ï¼ˆé”™åœ¨å“ªé‡Œï¼‰</h3>
<p>æŸ¥é˜…æ–‡æ¡£ä¹‹åï¼Œå‘ç°ç†è§£é”™äº†ï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200918-124746.png" alt=""></p>
<h3 id="DeepEqualæ­£ç¡®ç†è§£"><a class="header-anchor" href="#DeepEqualæ­£ç¡®ç†è§£">Â¶</a>DeepEqualæ­£ç¡®ç†è§£</h3>
<blockquote>
<p>æºç ä¹Ÿå¾ˆç®€æ´ï¼š</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeepEqual</span><span class="params">(x, y <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">  <span class="comment">//åŒnil</span></span><br><span class="line">	<span class="keyword">if</span> x == <span class="literal">nil</span> || y == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> x == y</span><br><span class="line">	&#125;</span><br><span class="line">	v1 := ValueOf(x)</span><br><span class="line">  v2 := ValueOf(y)</span><br><span class="line">  <span class="comment">//å±äºåŒä¸€ç±»å‹</span></span><br><span class="line">	<span class="keyword">if</span> v1.Type() != v2.Type() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> deepValueEqual(v1, v2, <span class="built_in">make</span>(<span class="keyword">map</span>[visit]<span class="keyword">bool</span>), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™¤äº†ä¸Šé¢çœ‹æºç ï¼Œä¸»è¦è¿˜æ˜¯è¦çœ‹å®˜æ–¹çš„æ–‡æ¡£å’Œè¯´æ˜æ€§çš„ï¼Œè¿™ä¸ªç®—æ˜¯ç†è§£æºç çš„å‰ææŠŠï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DeepEqual reports whether x and y are ``deeply equal,&#x27;&#x27; defined as follows.</span></span><br><span class="line"><span class="comment">// Two values of identical type are deeply equal if one of the following cases applies.</span></span><br><span class="line"><span class="comment">// Values of distinct types are never deeply equal.</span></span><br><span class="line"><span class="comment">//  æ¡ä»¶ï¼šæ•°ç»„æ·±åº¦ç›¸ç­‰ï¼Œç›¸åº”çš„å…ƒç´ éƒ½æ˜¯ç›¸ç­‰çš„ã€‚</span></span><br><span class="line"><span class="comment">// Array values are deeply equal when their corresponding elements are deeply equal.</span></span><br><span class="line"><span class="comment">//  æ¡ä»¶ï¼šç»“æ„ä½“ç›¸å¯¹åº”çš„å­—æ®µéƒ½æ˜¯ç›¸ç­‰çš„ã€‚</span></span><br><span class="line"><span class="comment">// Struct values are deeply equal if their corresponding fields,</span></span><br><span class="line"><span class="comment">// both exported and unexported, are deeply equal.</span></span><br><span class="line"><span class="comment">// æ¡ä»¶ï¼šå‡½æ•°éƒ½æ˜¯nilï¼Œåˆ™ä¸ºæ·±åº¦ç›¸ç­‰ï¼Œå…¶å®ƒæƒ…å†µä¸‹éƒ½æ˜¯ä¸ç›¸ç­‰çš„ã€‚</span></span><br><span class="line"><span class="comment">// Func values are deeply equal if both are nil; otherwise they are not deeply equal.</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// æ¡ä»¶ï¼šä¸¤ä¸ªinterfaceæŒæœ‰æ·±åº¦ç›¸åŒçš„å€¼ã€‚</span></span><br><span class="line"><span class="comment">// Interface values are deeply equal if they hold deeply equal concrete values.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    æ¡ä»¶ï¼šä¸‹é¢æ¡ä»¶ä¸º<span class="literal">true</span>ï¼Œåˆ™æ·±åº¦ç›¸ç­‰ï¼š</span><br><span class="line">    ä¸¤ä¸ªå…¨æ˜¯<span class="literal">nil</span>ï¼Œæˆ–è€…å…¨non-<span class="literal">nil</span>ï¼Œæœ‰ç›¸åŒçš„é•¿åº¦å¹¶ä¸”æœ‰ç›¸åŒçš„å¯¹è±¡/keyå¯¹åº”çš„å€¼æ˜¯ç›¸ç­‰çš„ã€‚</span><br><span class="line"><span class="comment">// Map values are deeply equal when all of the following are true:</span></span><br><span class="line"><span class="comment">// they are both nil or both non-nil, they have the same length,</span></span><br><span class="line"><span class="comment">// and either they are the same map object or their corresponding keys</span></span><br><span class="line"><span class="comment">// (matched using Go equality) map to deeply equal values.</span></span><br><span class="line">    æ¡ä»¶ï¼šç”¨ == æ¯”è¾ƒæˆ–è€… pointçš„</span><br><span class="line"><span class="comment">// Pointer values are deeply equal if they are equal using Go&#x27;s == operator</span></span><br><span class="line"><span class="comment">// or if they point to deeply equal values.</span></span><br><span class="line">    æ¡ä»¶ï¼šä¸‹é¢æ¡ä»¶ä¸º<span class="literal">true</span>ï¼Œåˆ™æ·±åº¦ç›¸ç­‰ï¼š</span><br><span class="line">    ä¸¤ä¸ªå…¨æ˜¯<span class="literal">nil</span>ï¼Œæˆ–è€…å…¨non-<span class="literal">nil</span>ï¼Œæœ‰ç›¸åŒçš„é•¿åº¦ï¼ŒæŒ‡å‘ç›¸åŒçš„åˆå§‹åŒ–èŠ‚ç‚¹ï¼ˆå³ï¼šç›¸åŒçš„æ•°ç»„ï¼‰æˆ–ç›¸åŒçš„å…ƒç´ æ·±åº¦ç›¸ç­‰ã€‚</span><br><span class="line">    æ³¨æ„ï¼šemptyå’Œ<span class="literal">nil</span> sliceä¸æ˜¯æ·±åº¦ç›¸ç­‰çš„ã€‚</span><br><span class="line"><span class="comment">// Slice values are deeply equal when all of the following are true:</span></span><br><span class="line"><span class="comment">// they are both nil or both non-nil, they have the same length,</span></span><br><span class="line"><span class="comment">// and either they point to the same initial entry of the same underlying array</span></span><br><span class="line"><span class="comment">// (that is, &amp;x[0] == &amp;y[0]) or their corresponding elements (up to length) are deeply equal.</span></span><br><span class="line"><span class="comment">// Note that a non-nil empty slice and a nil slice (for example, []byte&#123;&#125; and []byte(nil))</span></span><br><span class="line"><span class="comment">// are not deeply equal.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Other values - numbers, bools, strings, and channels - are deeply equal</span></span><br><span class="line"><span class="comment">// if they are equal using Go&#x27;s == operator.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In general DeepEqual is a recursive relaxation of Go&#x27;s == operator.</span></span><br><span class="line"><span class="comment">// However, this idea is impossible to implement without some inconsistency.</span></span><br><span class="line"><span class="comment">// Specifically, it is possible for a value to be unequal to itself,</span></span><br><span class="line"><span class="comment">// either because it is of func type (uncomparable in general)</span></span><br><span class="line"><span class="comment">// or because it is a floating-point NaN value (not equal to itself in floating-point comparison),</span></span><br><span class="line"><span class="comment">// or because it is an array, struct, or interface containing</span></span><br><span class="line"><span class="comment">// such a value.</span></span><br><span class="line"><span class="comment">// On the other hand, pointer values are always equal to themselves,</span></span><br><span class="line"><span class="comment">// even if they point at or contain such problematic values,</span></span><br><span class="line"><span class="comment">// because they compare equal using Go&#x27;s == operator, and that</span></span><br><span class="line"><span class="comment">// is a sufficient condition to be deeply equal, regardless of content.</span></span><br><span class="line"><span class="comment">// DeepEqual has been defined so that the same short-cut applies</span></span><br><span class="line"><span class="comment">// to slices and maps: if x and y are the same slice or the same map,</span></span><br><span class="line"><span class="comment">// they are deeply equal regardless of content.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// As DeepEqual traverses the data values it may find a cycle. The</span></span><br><span class="line"><span class="comment">// second and subsequent times that DeepEqual compares two pointer</span></span><br><span class="line"><span class="comment">// values that have been compared before, it treats the values as</span></span><br><span class="line"><span class="comment">// equal rather than examining the values to which they point.</span></span><br><span class="line"><span class="comment">// This ensures that DeepEqual terminates.</span></span><br></pre></td></tr></table></figure>
<p>å†çœ‹çœ‹è¯¦ç»†çš„deepValueEqual,å¤§è‡´çš„è¿‡ç¨‹ï¼š<br>
<img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200920-103516@2x.png" alt=""></p>
<blockquote>
<p>å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹ï¼š</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€åˆ¤æ–­ç±»å‹å’Œå€¼</span><br><span class="line">2ã€hardå›è°ƒ</span><br><span class="line">3ã€æŒ‰ç…§kindåˆ†ç±»å¤„ç†</span><br></pre></td></tr></table></figure>
<h4 id="æ•°ç»„ï¼š"><a class="header-anchor" href="#æ•°ç»„ï¼š">Â¶</a>æ•°ç»„ï¼š</h4>
<p>æ¯”è¾ƒæ¯ä¸€ä¸ªå…ƒç´ </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class="line">	<span class="keyword">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Slice"><a class="header-anchor" href="#Slice">Â¶</a>Slice</h4>
<ul>
<li>æ¯”è¾ƒä¸ºnil</li>
<li>æ¯”è¾ƒé•¿åº¦</li>
<li>æ¯”è¾ƒåœ°å€</li>
<li>æ¯”è¾ƒæ¯ä¸€ä¸ªå…ƒç´ </li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Len() != v2.Len() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class="line">	<span class="keyword">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Interface"><a class="header-anchor" href="#Interface">Â¶</a>Interface</h4>
<ul>
<li>æ¯”è¾ƒnil</li>
<li>é€’å½’æ¯”è¾ƒ</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() || v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> v1.IsNil() == v2.IsNil()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Ptr"><a class="header-anchor" href="#Ptr">Â¶</a>Ptr</h4>
<ul>
<li>åœ°å€</li>
<li>é€’å½’æ¯”è¾ƒ</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h4 id="struct"><a class="header-anchor" href="#struct">Â¶</a>struct</h4>
<ul>
<li>æ¯”è¾ƒæ¯ä¸€ä¸ªå…ƒç´ </li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">for</span> i, n := <span class="number">0</span>, v1.NumField(); i &lt; n; i++ &#123;</span><br><span class="line">	<span class="keyword">if</span> !deepValueEqual(v1.Field(i), v2.Field(i), visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Map"><a class="header-anchor" href="#Map">Â¶</a>Map</h4>
<ul>
<li>æ¯”è¾ƒNil</li>
<li>æ¯”è¾ƒé•¿åº¦</li>
<li>åœ°å€æ¯”è¾ƒ</li>
<li>æ¯ä¸€ä¸ªkeyå¯¹åº”çš„value</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Len() != v2.Len() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, k := <span class="keyword">range</span> v1.MapKeys() &#123;</span><br><span class="line">	val1 := v1.MapIndex(k)</span><br><span class="line">	val2 := v2.MapIndex(k)</span><br><span class="line">	<span class="keyword">if</span> !val1.IsValid() || !val2.IsValid() || !deepValueEqual(val1, val2, visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Func"><a class="header-anchor" href="#Func">Â¶</a>Func</h4>
<ul>
<li>énilï¼Œä¸ºä¸ç­‰ã€‚</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() &amp;&amp; v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Can&#x27;t do better than this:</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="paincæ³¨æ„ç‚¹ï¼š"><a class="header-anchor" href="#paincæ³¨æ„ç‚¹ï¼š">Â¶</a>paincæ³¨æ„ç‚¹ï¼š</h3>
<p>deepValueEqualå‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"> .....</span><br><span class="line"> ....</span><br><span class="line"> ...</span><br><span class="line"> ..</span><br><span class="line"> .</span><br><span class="line"> é€’å½’æ¬¡æ•°è¶…è¿‡<span class="number">10</span>æ¬¡åˆ™ä¼špainc....</span><br><span class="line"> <span class="comment">// if depth &gt; 10 &#123; panic(&quot;deepValueEqual&quot;) &#125;	// for debugging</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We want to avoid putting more in the visited map than we need to.</span></span><br><span class="line"><span class="comment">// For any possible reference cycle that might be encountered,</span></span><br><span class="line"><span class="comment">// hard(v1, v2) needs to return true for at least one of the types in the cycle,</span></span><br><span class="line"><span class="comment">// and it&#x27;s safe and valid to get Value&#x27;s internal pointer.</span></span><br><span class="line">hard := <span class="function"><span class="keyword">func</span><span class="params">(v1, v2 Value)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> v1.Kind() &#123;</span><br><span class="line">	<span class="keyword">case</span> Map, Slice, Ptr, Interface:</span><br><span class="line">		<span class="comment">// Nil pointers cannot be cyclic. Avoid putting them in the visited map.</span></span><br><span class="line">		<span class="keyword">return</span> !v1.IsNil() &amp;&amp; !v2.IsNil()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"> &#125;</span><br><span class="line"> .</span><br><span class="line"> ..</span><br><span class="line"> ...</span><br><span class="line"> ....</span><br><span class="line"> .....</span><br><span class="line"> ......</span><br></pre></td></tr></table></figure>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Go Package</tag>
        <tag>Day</tag>
        <tag>Go reflect</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ8ã€go rwmutexè§£è¯»</title>
    <url>/archives/3038b6c3.html</url>
    <content><![CDATA[<pre><code>å¥½ä¹…æ²¡æœ‰æ›´æ–°æ–‡ç« äº†ï¼Œè¡¨è¾¾èƒ½åŠ›ç”Ÿç–äº†è®¸å¤šğŸ˜„....
ä»Šå¤©æ‰¯æ‰¯:rwmutex è¢«ç§°ä¸ºè¯»å†™é”ã€‚ä¸€è¯´åˆ°ã€é”ã€‘æœ€ç›´æ¥çš„è”æƒ³å¯èƒ½å°±æ˜¯lock()ã€Rlock()ã€unlock()ã€Runlock()ä¹‹ç±»çš„ï¼Œä½†æ˜¯ä½œä¸ºç¨‹åºçŒ¿ï¼Œè¿˜æ˜¯è¦äº†è§£ä¸‹åº•å±‚çš„è®¾è®¡å’Œç›¸å…³çš„é€»è¾‘å®ç°ï¼Œä»¥ä¾¿äºæŠŠè¿™ç§é”çš„è®¾è®¡æ€æƒ³åº”ç”¨åˆ°å…¶å®ƒåœºæ™¯ä¸­ï¼Œå¥½äº†ï¼Œä¸åºŸè¯äº†ï¼Œå¼€é¢˜å§ã€‚
ä»é”çš„ç»“æ„è®¾è®¡--&gt;åŠ é”çš„è¿‡ç¨‹---&gt;åŠ é”çš„ç²’åº¦----&gt;è§£é”é‡Šæ”¾ï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥çœ‹rwmutexçš„å…·ä½“å®ç°ã€‚
</code></pre>
<a id="more"></a>
<h3 id="ç‰ˆæœ¬"><a class="header-anchor" href="#ç‰ˆæœ¬">Â¶</a>ç‰ˆæœ¬</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">â—¯  go version</span><br><span class="line">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>
<h3 id="åŒå‘å¯¹æ¯”rwmutexé”çš„è®¾è®¡"><a class="header-anchor" href="#åŒå‘å¯¹æ¯”rwmutexé”çš„è®¾è®¡">Â¶</a>åŒå‘å¯¹æ¯”rwmutexé”çš„è®¾è®¡</h3>
<pre><code>javaå®ç°ï¼šAQS(AbstractQueuedSynchronizer)
</code></pre>
<h3 id="ç»“æ„è®¾è®¡"><a class="header-anchor" href="#ç»“æ„è®¾è®¡">Â¶</a>ç»“æ„è®¾è®¡</h3>
<blockquote>
<p>åŸåˆ™ï¼šè¯»å†™äº’æ–¥ï¼Œä¼˜å…ˆå†™ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> RWMutex <span class="keyword">struct</span> &#123;</span><br><span class="line">	w           Mutex  <span class="comment">// held if there are pending writers</span></span><br><span class="line">	writerSem   <span class="keyword">uint32</span> <span class="comment">// semaphore for writers to wait for completing readers  å†™ä¿¡å·é‡</span></span><br><span class="line">	readerSem   <span class="keyword">uint32</span> <span class="comment">// semaphore for readers to wait for completing writers  è¯»ä¿¡å·é‡</span></span><br><span class="line">	readerCount <span class="keyword">int32</span>  <span class="comment">// number of pending readers è¯»è®¡æ•°</span></span><br><span class="line">	readerWait  <span class="keyword">int32</span>  <span class="comment">// number of departing readers   è¯»ç­‰å¾…ï¼ˆwriteè¿›è¡Œï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rwmutexMaxReaders = <span class="number">1</span> &lt;&lt; <span class="number">30</span>   <span class="comment">//æœ€å¤§è¯»é”çš„ä¸ªæ•°</span></span><br></pre></td></tr></table></figure>
<p>å…¶å®ƒå†åˆ†ç±»å°±æ˜¯å››ä¸ªä¸»è¦çš„å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RLock</span><br><span class="line">RUnLock</span><br><span class="line">Lock</span><br><span class="line">UnLock</span><br></pre></td></tr></table></figure>
<h3 id="åŠ é”è¿‡ç¨‹"><a class="header-anchor" href="#åŠ é”è¿‡ç¨‹">Â¶</a>åŠ é”è¿‡ç¨‹</h3>
<h4 id="RLockè¿‡ç¨‹"><a class="header-anchor" href="#RLockè¿‡ç¨‹">Â¶</a>RLockè¿‡ç¨‹</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">RLock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.Disable()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœå†™é”è¢«è·å–çš„ï¼Œåˆ™readerCount&lt;0çš„ï¼Œé˜»å¡çŠ¶æ€</span></span><br><span class="line">    <span class="comment">//å¦‚æœå†™é”æ²¡æœ‰è¢«è·å–ï¼Œåˆ™readerCount &gt;0çš„ï¼Œè·å–è¯»é”ï¼Œä¸é˜»å¡</span></span><br><span class="line">	<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="number">1</span>) &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// A writer is pending, wait for it. </span></span><br><span class="line">        <span class="comment">//å†™é”è¢«è·å–äº†ï¼ŒåŠ åˆ°Gé˜Ÿåˆ—åé¢ï¼ŒæŒ‚èµ·ã€‚</span></span><br><span class="line">		runtime_SemacquireMutex(&amp;rw.readerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Lockè¿‡ç¨‹"><a class="header-anchor" href="#Lockè¿‡ç¨‹">Â¶</a>Lockè¿‡ç¨‹</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Lock locks rw for writing.</span></span><br><span class="line"><span class="comment">// If the lock is already locked for reading or writing,</span></span><br><span class="line"><span class="comment">// Lock blocks until the lock is available.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.Disable()</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// First, resolve competition with other writers.</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨mutexé”</span></span><br><span class="line">	rw.w.Lock()</span><br><span class="line">	<span class="comment">// Announce to readers there is a pending writer.</span></span><br><span class="line">	r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</span><br><span class="line">	<span class="comment">// Wait for active readers.</span></span><br><span class="line">	<span class="keyword">if</span> r != <span class="number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">//ç­‰å¾…æ´»è·ƒçš„readerç»“æŸåï¼Œå†ç»™ä¸€ä¸ªå†™çš„ä¿¡å·é‡ï¼Œä¿è¯æ­¤åˆ»ä¹‹åçš„readeræŒ‚èµ·ã€‚</span></span><br><span class="line">		runtime_SemacquireMutex(&amp;rw.writerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">		race.Acquire(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åŠ é”çš„ç²’åº¦"><a class="header-anchor" href="#åŠ é”çš„ç²’åº¦">Â¶</a>åŠ é”çš„ç²’åº¦</h3>
<blockquote>
<p>è¯» &amp; å†™ äº’ä¸å¹²æ‰°.</p>
</blockquote>
<h3 id="è§£é”é‡Šæ”¾"><a class="header-anchor" href="#è§£é”é‡Šæ”¾">Â¶</a>è§£é”é‡Šæ”¾</h3>
<h4 id="RUnLock"><a class="header-anchor" href="#RUnLock">Â¶</a>RUnLock</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">RUnlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.ReleaseMerge(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class="line">		race.Disable()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†™é”ç­‰å¾…çŠ¶æ€ï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦å¯ä»¥è¿›è¡Œè·å–</span></span><br><span class="line">	<span class="keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="number">-1</span>); r &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Outlined slow-path to allow the fast-path to be inlined</span></span><br><span class="line">		rw.rUnlockSlow(r)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">rUnlockSlow</span><span class="params">(r <span class="keyword">int32</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// r + 1 == 0è¡¨ç¤ºç›´æ¥æ‰§è¡ŒRUnlock()</span></span><br><span class="line">	<span class="comment">// r + 1 == -rwmutexMaxReadersè¡¨ç¤ºæ‰§è¡ŒLock()å†æ‰§è¡ŒRUnlock()</span></span><br><span class="line">	<span class="keyword">if</span> r+<span class="number">1</span> == <span class="number">0</span> || r+<span class="number">1</span> == -rwmutexMaxReaders &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		throw(<span class="string">&quot;sync: RUnlock of unlocked RWMutex&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// A writer is pending.</span></span><br><span class="line">    <span class="comment">// å½“è¯»é”é‡Šæ”¾å®Œæ¯•åï¼Œé€šçŸ¥å†™é”</span></span><br><span class="line">	<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="number">-1</span>) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// The last reader unblocks the writer.</span></span><br><span class="line">		runtime_Semrelease(&amp;rw.writerSem, <span class="literal">false</span>, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="UnLock"><a class="header-anchor" href="#UnLock">Â¶</a>UnLock</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.Release(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">		race.Disable()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Announce to readers there is no active writer.</span></span><br><span class="line">    r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</span><br><span class="line">    <span class="comment">//è¯´æ˜è¿™ä¸ªæ²¡æœ‰æ·é”ï¼Œæ²¡æ³•å†æ¬¡é‡Šæ”¾</span></span><br><span class="line">	<span class="keyword">if</span> r &gt;= rwmutexMaxReaders &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		throw(<span class="string">&quot;sync: Unlock of unlocked RWMutex&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// Unblock blocked readers, if any.</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾æ‰€æœ‰çš„é”ã€‚</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(r); i++ &#123;</span><br><span class="line">		runtime_Semrelease(&amp;rw.readerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Allow other writers to proceed.</span></span><br><span class="line">	rw.w.Unlock()</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“">Â¶</a>æ€»ç»“</h3>
<blockquote>
<p>è¯»&amp;å†™ï¼Œäº’ä¸å¹²æ‰°ã€‚</p>
</blockquote>
<ul>
<li>
<p>è¯»é”ä¸èƒ½é˜»å¡è¯»é”ï¼Œå¼•å…¥readerCount.</p>
</li>
<li>
<p>è¯»é”éœ€è¦é˜»å¡å†™é”ï¼Œç›´åˆ°æ‰€ä»¥è¯»é”éƒ½é‡Šæ”¾ï¼Œå¼•å…¥readerSem.</p>
</li>
<li>
<p>å†™é”éœ€è¦é˜»å¡è¯»é”ï¼Œç›´åˆ°æ‰€ä»¥å†™é”éƒ½é‡Šæ”¾ï¼Œå¼•å…¥wirterSem.</p>
</li>
<li>
<p>å†™é”éœ€è¦é˜»å¡å†™é”ï¼Œå¼•å…¥Metux.</p>
</li>
</ul>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Go Package</tag>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ7ã€Go ContextåŒ…ä½¿ç”¨</title>
    <url>/archives/410dfaec.html</url>
    <content><![CDATA[<h3 id="ç‰ˆæœ¬"><a class="header-anchor" href="#ç‰ˆæœ¬">Â¶</a>ç‰ˆæœ¬</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">â—¯  go version</span><br><span class="line">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>
<h3 id="ç”¨Goçš„éƒ½ç¦»ä¸å¼€Contextï¼Œå¼•ç”¨å®˜ç½‘çš„ä¸€å¥è¯æ¥æè¿°ContextåŒ…ï¼š"><a class="header-anchor" href="#ç”¨Goçš„éƒ½ç¦»ä¸å¼€Contextï¼Œå¼•ç”¨å®˜ç½‘çš„ä¸€å¥è¯æ¥æè¿°ContextåŒ…ï¼š">Â¶</a>ç”¨Goçš„éƒ½ç¦»ä¸å¼€Contextï¼Œå¼•ç”¨å®˜ç½‘çš„ä¸€å¥è¯æ¥æè¿°ContextåŒ…ï¼š</h3>
<blockquote>
<p>Package context defines the Context type, which carries deadlines, cancellation signals, and other request-scoped values across API boundaries and between processes.</p>
</blockquote>
<p>ä¸»è¦æŒæ¡å››ä¸ªæ–¹æ³•çš„ä½¿ç”¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WithCancel</span><br><span class="line">WithDeadline</span><br><span class="line">WithTimeout</span><br><span class="line">WithValue</span><br></pre></td></tr></table></figure>
<h3 id="å‰æœŸready"><a class="header-anchor" href="#å‰æœŸready">Â¶</a>å‰æœŸready</h3>
<p>è¦ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼Œå…ˆäº†è§£ä¸‹éƒ¨åˆ†ç»“æ„å’Œé€»è¾‘ï¼š</p>
<blockquote>
<p>æ—¢ç„¶contextå…¨éƒ¨éƒ½æ˜¯å’Œå–æ¶ˆç›¸å…³çš„ï¼Œæœ€èµ·ç Goåœ¨è®¾è®¡æ—¶ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªç»“æ„ã€‚</p>
</blockquote>
<a id="more"></a>
<blockquote>
<p>å…·ä½“çš„å–æ¶ˆè®¾è®¡ç»“æ„</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">type cancelCtx struct &#123;</span><br><span class="line">	Context</span><br><span class="line"></span><br><span class="line">	mu       sync.Mutex            &#x2F;&#x2F; protects following fields  åŠ é”ç”¨</span><br><span class="line">	done     chan struct&#123;&#125;         &#x2F;&#x2F; created lazily, closed by first cancel call   æ§åˆ¶channel</span><br><span class="line">	children map[canceler]struct&#123;&#125; &#x2F;&#x2F; set to nil by the first cancel call  cancelå‡½æ•°è°ƒç”¨åï¼Œé‡Šæ”¾å­ç±»</span><br><span class="line">	err      error                 &#x2F;&#x2F; set to non-nil by the first cancel call</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>timeræ§åˆ¶æ­»é”æ—¶é—´ç»“æ„ï¼š</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; A timerCtx carries a timer and a deadline. It embeds a cancelCtx to</span><br><span class="line">&#x2F;&#x2F; implement Done and Err. It implements cancel by stopping its timer then</span><br><span class="line">&#x2F;&#x2F; delegating to cancelCtx.cancel.</span><br><span class="line"></span><br><span class="line">type timerCtx struct &#123;</span><br><span class="line">	cancelCtx  </span><br><span class="line">	timer *time.Timer &#x2F;&#x2F; Under cancelCtx.mu.</span><br><span class="line"></span><br><span class="line">	deadline time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WithCancel"><a class="header-anchor" href="#WithCancel">Â¶</a>WithCancel</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func WithCancel(parent Context) (ctx Context, cancel CancelFunc) &#123;</span><br><span class="line">    if parent &#x3D;&#x3D; nil &#123;  &#x2F;&#x2F;æ—¥å¸¸åˆ¤ç©º</span><br><span class="line">		panic(&quot;cannot create context from nil parent&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	c :&#x3D; newCancelCtx(parent) &#x2F;&#x2F;cancelCtx new</span><br><span class="line">	propagateCancel(parent, &amp;c)  &#x2F;&#x2F;å¾ªç¯ä¼ æ’­å–æ¶ˆå‡½æ•°for ctx</span><br><span class="line">	return &amp;c, func() &#123; c.cancel(true, Canceled) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>çœ‹ä¼¼å¾ˆç®€å•ï¼Œå››è¡Œè§£å†³ï¼Œä½†æ˜¯æ›´é‡è¦çš„æ˜¯å­¦ä¼šçœ‹æ³¨é‡Šè¯´æ˜å’Œç›¸å…³çš„è®¾è®¡æ€è·¯ï¼š<br>
TODO</p>
</blockquote>
<p>å¼•ç”¨å®˜æ–¹çš„è¯­è¨€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; WithCancel returns a copy of parent with a new Done channel. The returned</span><br><span class="line">&#x2F;&#x2F; context&#39;s Done channel is closed when the returned cancel function is called</span><br><span class="line">&#x2F;&#x2F; or when the parent context&#39;s Done channel is closed, whichever happens first.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; Canceling this context releases resources associated with it, so code should</span><br><span class="line">&#x2F;&#x2F; call cancel as soon as the operations running in this Context complete.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Withcancel è¿”å›çš„æ˜¯ä¸€ä¸ªparentçš„é•œåƒ&#x2F;å¤åˆ¶ï¼Œä¼´éšä¸€ä¸ªDone channelé€šé“ã€‚</span><br><span class="line">Doneå…³é—­çŠ¶æ€å–å†³äº</span><br><span class="line">1ã€è¿”å›çš„cancelå‡½æ•°ã€‚</span><br><span class="line">2ã€parentçš„Done Channelå…³é—­ã€‚</span><br><span class="line">è¿™ä¸¤ä¸ªå“ªä¸ªå…ˆç¬¦åˆæ¡ä»¶äº†ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="WithDeadline-WithTimeout"><a class="header-anchor" href="#WithDeadline-WithTimeout">Â¶</a>WithDeadline/WithTimeout</h3>
<p>è‡ªå·±æ¢³ç†çš„é€»è¾‘æ‰§è¡Œé¡ºåºï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200907-152032.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Deadline&#x2F;WithTimeoutåŒºåˆ«ï¼š</span><br><span class="line"></span><br><span class="line">* deadline:çš„å…¥å‚æ˜¯ä¸€ä¸ªå…·ä½“çš„æˆªæ­¢æ—¶é—´ï¼šTime.time</span><br><span class="line">* withTimeout:å…¥å‚æ˜¯ä¸€ä¸ªå¤šå°‘æ—¶é—´åè¶…æ—¶ï¼šTime.Duration</span><br></pre></td></tr></table></figure>
<h3 id="WithValue"><a class="header-anchor" href="#WithValue">Â¶</a>WithValue</h3>
<blockquote>
<p>Withvalueå’Œvalueæ˜¯æˆå¯¹å‡ºç°çš„:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€ç»™ctxè®¾ç½®k,vï¼šwithvalue(ctx,k,v)</span><br><span class="line">2ã€è·å–ctxä¸­kçš„å€¼value(ctx,k)</span><br></pre></td></tr></table></figure>
<h3 id="TODO"><a class="header-anchor" href="#TODO">Â¶</a>TODO</h3>
<h4 id="timerCtxè¯¦ç»†çš„è®¾è®¡æ€è·¯å’Œç»“æ„æ–‡æ¡£"><a class="header-anchor" href="#timerCtxè¯¦ç»†çš„è®¾è®¡æ€è·¯å’Œç»“æ„æ–‡æ¡£">Â¶</a>timerCtxè¯¦ç»†çš„è®¾è®¡æ€è·¯å’Œç»“æ„æ–‡æ¡£</h4>
<h4 id="æ¡†æ¶å›¾æ•´ç†"><a class="header-anchor" href="#æ¡†æ¶å›¾æ•´ç†">Â¶</a>æ¡†æ¶å›¾æ•´ç†</h4>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Go Package</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ6ã€git åˆé˜¶:å®‰è£…é…ç½® ï½1</title>
    <url>/archives/bddc30f6.html</url>
    <content><![CDATA[<blockquote>
<p>è‡ªç›˜å¤å¼€å¤©è¾Ÿåœ°ï½ï½ï½ï½<br>
æ‰¯è¿œäº†â€¦<br>
å®Œæ•´çš„åˆ†äº«ä¸‹Gitçš„ä½¿ç”¨å’Œå­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œä¹‹å‰ç« èŠ‚ä¸­çš„<a href="http://blog.imrcrab.com/2020/09/01/Git%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/">Gitå¸¸ç”¨æŠ€å·§</a>æ˜¯æˆ‘ä¹‹å‰éƒ¨åˆ†å¿«é€Ÿä½¿ç”¨çš„åœºæ™¯ï¼Œé€‚åˆäºæœ‰ç»éªŒçš„å¼€å‘è€…ï¼Œç°åœ¨æ¥ç³»ç»Ÿçš„åˆ†äº«ä¸‹å¯¹äºGitçš„ç†è§£ï¼Œä¹Ÿç®—æ˜¯è‡ªå·±å­¦ä¹ çš„è®°å½•ã€‚</p>
</blockquote>
<h2 id="å‰æ™¯"><a class="header-anchor" href="#å‰æ™¯">Â¶</a>å‰æ™¯</h2>
<p>SVNä¼°è®¡æ˜¯å®¶å–»æˆ·æ™“äº†ï¼Œä¸€ç›´è¢«ç”¨ä½œ<code>'ç‰ˆæœ¬ç®¡ç†'</code>å’Œ<code>ä»£ç ä»“åº“</code>ã€‚ï¼ˆps:ä¸ç®—æ˜¯å®Œæ•´çš„<code>ç‰ˆæœ¬ç®¡ç†</code>.ï¼‰<br>
Gitçš„å‡ºç°ï¼Œæ˜¯linusä¹‹çˆ¶ä¼‘å‡æ—¶äº§å‡ºçš„â€œä½œå“â€,<code>ç‰ˆæœ¬ç®¡ç†</code> &amp; <code>ä»£ç ä»“åº“</code>çš„ä½œç”¨ã€‚æ€»è€Œè¨€ä¹‹ï¼Œç”¨ç†Ÿç»ƒGitäº†ï¼Œå°±å†ä¹Ÿå›ä¸å»äº†ã€‚</p>
<a id="more"></a>
<h2 id="ç›®æ ‡ï¼š"><a class="header-anchor" href="#ç›®æ ‡ï¼š">Â¶</a>ç›®æ ‡ï¼š</h2>
<blockquote>
<p>æœ€ç»ˆå¯ä»¥é¡ºåˆ©çš„æäº¤ä»£ç å³å¯ã€‚</p>
</blockquote>
<h2 id="æ­¤ç¯‡åªåˆ†äº«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š"><a class="header-anchor" href="#æ­¤ç¯‡åªåˆ†äº«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š">Â¶</a>æ­¤ç¯‡åªåˆ†äº«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š</h2>
<blockquote>
<p>å®‰è£…Gitå’ŒGitåŸºæœ¬é…ç½®</p>
</blockquote>
<h3 id="Gitå®‰è£…"><a class="header-anchor" href="#Gitå®‰è£…">Â¶</a>Gitå®‰è£…</h3>
<p>è¯´å®‰è£…å…¶å®å°±æ˜¯å»å®˜ç½‘ä¸‹è½½è½¯ä»¶ï¼Œå®‰è£…åˆ°ä½ é€‰å®šåœ°æ–¹å³å¯ã€‚</p>
<p>åœ¨æ­¤é™„ä¸Šå®˜ç½‘çš„ä¸‹è½½é“¾æ¥ï¼š <a href="https://git-scm.com/download/">ç‚¹å‡»è¿›å…¥</a></p>
<p>é€‰æ‹©å¯¹åº”å¹³å°windows?linux?macos?</p>
<p>ps:åˆ«é€‰é”™äº†ï¼Œé‚£å°±veryå°´å°¬äº†ã€‚</p>
<h3 id="åŸºæœ¬é…ç½®"><a class="header-anchor" href="#åŸºæœ¬é…ç½®">Â¶</a>åŸºæœ¬é…ç½®</h3>
<p>è¯´åˆ°åŸºæœ¬é…ç½®ï¼Œå¤§å¤šæ•°éƒ½ä¼šæœ‰ï¼Œæ›´ä½•å†µæ˜¯å¦‚æ­¤å¼ºå¤§çš„ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶ã€‚</p>
<h4 id="å‰æœŸåŸºæœ¬é…ç½®"><a class="header-anchor" href="#å‰æœŸåŸºæœ¬é…ç½®">Â¶</a>å‰æœŸåŸºæœ¬é…ç½®</h4>
<p>ä¸»è¦åˆ†ä¸‰ä¸ªåœ°æ–¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€&#x2F;etc&#x2F;gitconfig æ–‡ä»¶: ç³»ç»Ÿä¸Šæ¯ä¸€ä¸ªç”¨æˆ·åŠå…¶ä»–ä»¬çš„ä»“åº“é…ç½®æ–‡ä»¶ã€‚</span><br><span class="line">2ã€~&#x2F;.gitconfig æˆ– ~&#x2F;.config&#x2F;git&#x2F;config æ–‡ä»¶ï¼š åªé’ˆå¯¹å½“å‰ç”¨æˆ·ç”Ÿæ•ˆã€‚ [globalé…ç½®]</span><br><span class="line">3ã€å½“å‰ä½¿ç”¨ä»“åº“çš„Gité…ç½®ï¼š .git&#x2F;configæ–‡ä»¶ï¼Œä»…ä»…å¯¹å½“å‰ä»“åº“é…ç½®ç”Ÿæ•ˆã€‚    [localé…ç½®]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ps: ä¼˜å…ˆæœºåˆ¶ï¼š3 &gt; 2 &gt; 1  [.git/configè¦†ç›–~/.gitconfigã€  ~/.gitconfigè¦†ç›–/etc/gitconfig]</p>
</blockquote>
<h5 id="æ³¨æ„ï¼š"><a class="header-anchor" href="#æ³¨æ„ï¼š">Â¶</a>æ³¨æ„ï¼š</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">windowsä¸‹çš„~&#x2F;.gitconfigè·¯å¾„ä¸ºï¼šC:\Users\$USERä¸‹ï¼›$USERæŒ‡å½“å‰ç”µè„‘ç”¨æˆ·åç§°</span><br></pre></td></tr></table></figure>
<h5 id="æŸ¥çœ‹æ‰€æœ‰é…ç½®å‘½ä»¤"><a class="header-anchor" href="#æŸ¥çœ‹æ‰€æœ‰é…ç½®å‘½ä»¤">Â¶</a>æŸ¥çœ‹æ‰€æœ‰é…ç½®å‘½ä»¤</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --list --show-origin</span><br></pre></td></tr></table></figure>
<h4 id="ç”Ÿæˆå¯†é’¥-å…³è”Github-Gitlab"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥-å…³è”Github-Gitlab">Â¶</a>ç”Ÿæˆå¯†é’¥&amp;å…³è”Github/Gitlab</h4>
<h5 id="ç”Ÿæˆå¯†é’¥"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥">Â¶</a>ç”Ÿæˆå¯†é’¥</h5>
<blockquote>
<p>æ ¹æ®é‚®ç®±ï¼Œä¼šè¦æ±‚è¾“å…¥å¯†ç ï¼Œè¿ç»­3ä¸ªå›è½¦å³å¯ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;è¿™é‡Œæ¢ä¸Šä½ çš„é‚®ç®±&quot;</span><br></pre></td></tr></table></figure>
<p>æœ€åå¾—åˆ°id_rsaå’Œid_rsa.pubä¸¤ä¸ªæ–‡ä»¶ã€‚</p>
<p>è¿™é‡Œç”¨åˆ°çš„æ˜¯ä½ çš„ å…¬é’¥<code>id_rsa.pub</code>æ–‡ä»¶ï¼Œå¤åˆ¶æ–‡ä»¶é‡Œé¢çš„å†…å®¹åˆ°githubå¯†é’¥çš„ç•Œé¢ï¼š</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902075825.png" alt=""></p>
<p>æ·»åŠ SSHå®Œäº†ä¹‹åï¼Œå°±ç»‘å®šäº†ä½ æœ¬æœºå™¨å’Œgithubçš„å…³è”å…³ç³»ï¼Œç›¸å½“äºæˆæƒæˆåŠŸã€‚</p>
<h5 id="æ‹“å±•"><a class="header-anchor" href="#æ‹“å±•">Â¶</a>æ‹“å±•</h5>
<blockquote>
<p>ä¸Šè¿°ç”Ÿæˆå¯†é’¥æ—¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ–‡ä»¶åç§°.æ­¤ç§æƒ…å†µé’ˆå¯¹ä½ æœ‰å¤šä¸ªgithubè´¦å·æ—¶ï¼Œæäº¤å…¬é’¥æ–‡ä»¶æ—¶ï¼Œæ‰¾å‡ºè‡ªå®šä¹‰åç§°çš„æ–‡ä»¶å³å¯ã€‚ï¼ˆä¸‹å›¾è‡ªå®šä¹‰ç”Ÿæˆæ–‡ä»¶åç§°pywang112,åˆ™å…¬é’¥ä¸ºpywang112.pubï¼Œçœ‹å¥½ä½ ç”Ÿæˆçš„è·¯å¾„å“¦ï¼‰</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902080130.png" alt=""></p>
<h4 id="globalé…ç½®ï¼ˆå…¨å±€é…ç½®ï¼‰æˆ–-localé…ç½®ï¼ˆå½“å‰ä»“åº“é…ç½®ï¼‰"><a class="header-anchor" href="#globalé…ç½®ï¼ˆå…¨å±€é…ç½®ï¼‰æˆ–-localé…ç½®ï¼ˆå½“å‰ä»“åº“é…ç½®ï¼‰">Â¶</a>globalé…ç½®ï¼ˆå…¨å±€é…ç½®ï¼‰æˆ– localé…ç½®ï¼ˆå½“å‰ä»“åº“é…ç½®ï¼‰</h4>
<h5 id="globalé…ç½®ï¼ˆé’ˆå¯¹ä½ åªæœ‰ä¸€ä¸ªgitè´¦æˆ·çš„æƒ…å†µï¼‰"><a class="header-anchor" href="#globalé…ç½®ï¼ˆé’ˆå¯¹ä½ åªæœ‰ä¸€ä¸ªgitè´¦æˆ·çš„æƒ…å†µï¼‰">Â¶</a>globalé…ç½®ï¼ˆé’ˆå¯¹ä½ åªæœ‰ä¸€ä¸ªgitè´¦æˆ·çš„æƒ…å†µï¼‰</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å‘½ä»¤ï¼š</span><br><span class="line">git config --global --list</span><br><span class="line"></span><br><span class="line">å…¨å±€é…ç½®ï¼š</span><br><span class="line"></span><br><span class="line">git config --global user.name &quot;crab&quot;</span><br><span class="line">git config --global user.email &quot;imrcrab@163.com&quot;</span><br><span class="line"></span><br><span class="line">ä»£ç†é…ç½®ï¼ˆæŒ‰éœ€å¯é€‰ï¼‰</span><br><span class="line"># http</span><br><span class="line">git config --global https.proxy http:&#x2F;&#x2F;127.0.0.1:1080 </span><br><span class="line"># sock</span><br><span class="line">git config --global http.proxy &#39;socks5:&#x2F;&#x2F;127.0.0.1:1080&#39; </span><br><span class="line"></span><br><span class="line">å–æ¶ˆä»£ç†ï¼š</span><br><span class="line">git config --global --unset http.proxy</span><br></pre></td></tr></table></figure>
<h5 id="localé…ç½®-å»ºè®®æœ¬åœ°ä»“åº“é…ç½®ï¼Œè¿™æ ·æ¯”è¾ƒçµæ´»"><a class="header-anchor" href="#localé…ç½®-å»ºè®®æœ¬åœ°ä»“åº“é…ç½®ï¼Œè¿™æ ·æ¯”è¾ƒçµæ´»">Â¶</a>localé…ç½® (å»ºè®®æœ¬åœ°ä»“åº“é…ç½®ï¼Œè¿™æ ·æ¯”è¾ƒçµæ´»)</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å‘½ä»¤ï¼š</span><br><span class="line">git config --local --list</span><br><span class="line"></span><br><span class="line">å…¨å±€é…ç½®ï¼š</span><br><span class="line"></span><br><span class="line">git config --local user.name &quot;crab&quot;</span><br><span class="line">git config --local user.email &quot;imrcrab@163.com&quot;</span><br><span class="line"></span><br><span class="line">ä»£ç†é…ç½®ï¼ˆæŒ‰éœ€å¯é€‰ï¼‰</span><br><span class="line"># http</span><br><span class="line">git config --local https.proxy http:&#x2F;&#x2F;127.0.0.1:1080 </span><br><span class="line"># sock</span><br><span class="line">git config --local http.proxy &#39;socks5:&#x2F;&#x2F;127.0.0.1:1080&#39; </span><br><span class="line"></span><br><span class="line">å–æ¶ˆä»£ç†ï¼š</span><br><span class="line">git config --local --unset http.proxy</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®å®Œæˆï¼Œclone-commitä»£ç "><a class="header-anchor" href="#é…ç½®å®Œæˆï¼Œclone-commitä»£ç ">Â¶</a>é…ç½®å®Œæˆï¼Œclone/commitä»£ç </h4>
<h5 id="cloneä»“åº“ä»£ç "><a class="header-anchor" href="#cloneä»“åº“ä»£ç ">Â¶</a>cloneä»“åº“ä»£ç </h5>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902081306.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;crab21&#x2F;blog.git</span><br></pre></td></tr></table></figure>
<h5 id="commitä»£ç "><a class="header-anchor" href="#commitä»£ç ">Â¶</a>commitä»£ç </h5>
<blockquote>
<p>æŒ‰ç…§å¦‚ä¸Šé…ç½®å®Œæˆåï¼Œå°±å¯ä»¥å®ŒæˆåŸºæœ¬çš„pushå’Œpullä»“åº“ä»£ç äº†ã€‚</p>
</blockquote>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ5ã€Git GPGç­¾ç½²å·¥ä½œ</title>
    <url>/archives/580377d0.html</url>
    <content><![CDATA[<h3 id="GPGåœºæ™¯"><a class="header-anchor" href="#GPGåœºæ™¯">Â¶</a>GPGåœºæ™¯</h3>
<p>Git è™½ç„¶æ˜¯å¯†ç çº§å®‰å…¨çš„ï¼Œä½†å®ƒä¸æ˜¯ä¸‡æ— ä¸€å¤±çš„ã€‚ å¦‚æœä½ ä»å› ç‰¹ç½‘ä¸Šçš„å…¶ä»–äººé‚£é‡Œæ‹¿å–å·¥ä½œï¼Œå¹¶ä¸”æƒ³è¦éªŒè¯æäº¤æ˜¯ä¸æ˜¯çœŸæ­£åœ°æ¥è‡ªäºå¯ä¿¡æ¥æºï¼Œ Git æä¾›äº†å‡ ç§é€šè¿‡ GPG æ¥ç­¾ç½²å’ŒéªŒè¯å·¥ä½œçš„æ–¹å¼ã€‚</p>
<p>æœ€ç»ˆæ•ˆæœï¼šå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png" alt=""></p>
<h3 id="å®‰è£…è¿‡ç¨‹"><a class="header-anchor" href="#å®‰è£…è¿‡ç¨‹">Â¶</a>å®‰è£…è¿‡ç¨‹</h3>
<p>windowså®‰è£…åœ°å€ï¼š <a href="https://www.gnupg.org/">ç‚¹å‡»ä¸‹è½½</a></p>
<p>mac osä¸ºä¾‹ï¼š</p>
<a id="more"></a>
<h4 id="å®‰è£…GPG"><a class="header-anchor" href="#å®‰è£…GPG">Â¶</a>å®‰è£…GPG</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install gpg</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹ç»“æœï¼š</span><br><span class="line">Â± gpg --version                                                                                                                                                                                                                                     â</span><br><span class="line"></span><br><span class="line">gpg (GnuPG) 2.2.22</span><br><span class="line">libgcrypt 1.8.6</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;https:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">Home: &#x2F;Users&#x2F;gogoowang&#x2F;.gnupg</span><br><span class="line">æ”¯æŒçš„ç®—æ³•ï¼š</span><br><span class="line">å…¬é’¥ï¼š RSA, ELG, DSA, ECDH, ECDSA, EDDSA</span><br><span class="line">å¯†æ–‡ï¼š IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,</span><br><span class="line">    CAMELLIA128, CAMELLIA192, CAMELLIA256</span><br><span class="line">æ•£åˆ—ï¼š SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224</span><br><span class="line">å‹ç¼©ï¼š  ä¸å‹ç¼©, ZIP, ZLIB, BZIP2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ç”Ÿæˆå¯†é’¥"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥">Â¶</a>ç”Ÿæˆå¯†é’¥</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gpg --full-generate-key</span><br></pre></td></tr></table></figure>
<p>éœ€è¦å¡«å†™çš„åœ°æ–¹ï¼š<br>
<img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123803.png" alt=""></p>
<h4 id="æŸ¥çœ‹å¯†é’¥å®Œæ•´ä¿¡æ¯"><a class="header-anchor" href="#æŸ¥çœ‹å¯†é’¥å®Œæ•´ä¿¡æ¯">Â¶</a>æŸ¥çœ‹å¯†é’¥å®Œæ•´ä¿¡æ¯</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gpg --list-secret-keys --keyid-format LONG</span><br></pre></td></tr></table></figure>
<blockquote>
<p>secret keysï¼ˆçº¢åœˆåœ°æ–¹åç»­ç”¨åˆ°ï¼Œç•™æ„ä¸‹ï¼‰ï¼š</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124016.png" alt=""></p>
<h4 id="æ ¹æ®secret-keysç”ŸæˆPGP"><a class="header-anchor" href="#æ ¹æ®secret-keysç”ŸæˆPGP">Â¶</a>æ ¹æ®secret keysç”ŸæˆPGP</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gpg --armor --export  7BB8CF3593CA174C</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„PGPç»“æœï¼Œåç»­éœ€è¦å°†æ­¤ç»“æœå¯¼å…¥åˆ°Githubè´¦å·çš„é…ç½®ä¿¡æ¯ä¸­<br>
<img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124305.png" alt=""></p>
<h4 id="Githubè´¦å·ä¸­è®¾ç½®"><a class="header-anchor" href="#Githubè´¦å·ä¸­è®¾ç½®">Â¶</a>Githubè´¦å·ä¸­è®¾ç½®</h4>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124443.png" alt=""></p>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124527.png" alt=""></p>
<blockquote>
<p>å°†ä¸Šè¿°ç”Ÿæˆçš„PGPå¡«å…¥ï¼Œç‚¹å‡»[Add GPG Key]å³å¯</p>
</blockquote>
<h4 id="é…ç½®æœ¬åœ°GPGç­¾åä¿¡æ¯"><a class="header-anchor" href="#é…ç½®æœ¬åœ°GPGç­¾åä¿¡æ¯">Â¶</a>é…ç½®æœ¬åœ°GPGç­¾åä¿¡æ¯</h4>
<p>ä¾æ¬¡æ‰§è¡Œä¸‹é¢å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€git config --global user.signingkey 7BB8CF3593CA174C  #æ­¤å¤„çš„7BB8CF3593CA174Cä¸ºç”Ÿæˆçš„secret keys</span><br><span class="line">2ã€git config commit.gpgsign true</span><br><span class="line">3ã€git config --global commit.gpgsign true</span><br></pre></td></tr></table></figure>
<h4 id="Git-PGPç”Ÿæ•ˆ"><a class="header-anchor" href="#Git-PGPç”Ÿæ•ˆ">Â¶</a>Git PGPç”Ÿæ•ˆ</h4>
<blockquote>
<p>å†æ¬¡æäº¤commitå³å¯ç”Ÿæ•ˆã€‚äº§ç”Ÿå¦‚ä¸‹å›¾çš„ç­¾åæ•ˆæœï¼š</p>
</blockquote>
<p><img src="https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png" alt=""></p>
<h4 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h4>
]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ4ã€Gitå¸¸ç”¨æŠ€å·§</title>
    <url>/archives/3c1dd822.html</url>
    <content><![CDATA[<h3 id="å­¦ä¹ æ–¹å¼"><a class="header-anchor" href="#å­¦ä¹ æ–¹å¼">Â¶</a>å­¦ä¹ æ–¹å¼</h3>
<p>å¤šç»ƒå¤šå¾—ï¼Œç›´æ¥å­¦ä¹ <a href="https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6">å®˜ç½‘</a>ç†è§£ã€‚</p>
<p>ä»¥ä¸‹ä»…ä»…æ˜¯éƒ¨åˆ†ç”¨åˆ°çš„åœºæ™¯å’Œéƒ¨åˆ†åœºæ™¯è®°å½•ï¼Œä¸ä»£è¡¨å…¨éƒ¨æƒ…å†µï¼Œå¦‚æœ‰é”™è¯¯ï¼Œè¯·åŠæ—¶æŒ‡æ­£ã€‚</p>
<h3 id="Gitç‰ˆæœ¬ï¼š"><a class="header-anchor" href="#Gitç‰ˆæœ¬ï¼š">Â¶</a>Gitç‰ˆæœ¬ï¼š</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1944 Â± git version </span><br><span class="line">git version 2.28.0</span><br></pre></td></tr></table></figure>
<h3 id="å…ˆè¯´è¯´Gitçš„å¸¸ç”¨å‘½ä»¤ï¼š-å¯è·³è¿‡"><a class="header-anchor" href="#å…ˆè¯´è¯´Gitçš„å¸¸ç”¨å‘½ä»¤ï¼š-å¯è·³è¿‡">Â¶</a>å…ˆè¯´è¯´Gitçš„å¸¸ç”¨å‘½ä»¤ï¼š(å¯è·³è¿‡)</h3>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2081 â—¯  git </span><br><span class="line">ç”¨æ³•ï¼šgit [--version] [--help] [-C &lt;path&gt;] [-c &lt;name&gt;&#x3D;&lt;value&gt;]</span><br><span class="line">           [--exec-path[&#x3D;&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class="line">           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]</span><br><span class="line">           [--git-dir&#x3D;&lt;path&gt;] [--work-tree&#x3D;&lt;path&gt;] [--namespace&#x3D;&lt;name&gt;]</span><br><span class="line">           &lt;command&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">è¿™äº›æ˜¯å„ç§åœºåˆå¸¸è§çš„ Git å‘½ä»¤ï¼š</span><br><span class="line"></span><br><span class="line">å¼€å§‹ä¸€ä¸ªå·¥ä½œåŒºï¼ˆå‚è§ï¼šgit help tutorialï¼‰</span><br><span class="line">   clone             å…‹éš†ä»“åº“åˆ°ä¸€ä¸ªæ–°ç›®å½•</span><br><span class="line">   init              åˆ›å»ºä¸€ä¸ªç©ºçš„ Git ä»“åº“æˆ–é‡æ–°åˆå§‹åŒ–ä¸€ä¸ªå·²å­˜åœ¨çš„ä»“åº“</span><br><span class="line"></span><br><span class="line">åœ¨å½“å‰å˜æ›´ä¸Šå·¥ä½œï¼ˆå‚è§ï¼šgit help everydayï¼‰</span><br><span class="line">   add               æ·»åŠ æ–‡ä»¶å†…å®¹è‡³ç´¢å¼•</span><br><span class="line">   mv                ç§»åŠ¨æˆ–é‡å‘½åä¸€ä¸ªæ–‡ä»¶ã€ç›®å½•æˆ–ç¬¦å·é“¾æ¥</span><br><span class="line">   restore           æ¢å¤å·¥ä½œåŒºæ–‡ä»¶</span><br><span class="line">   rm                ä»å·¥ä½œåŒºå’Œç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶</span><br><span class="line">   sparse-checkout   åˆå§‹åŒ–åŠä¿®æ”¹ç¨€ç–æ£€å‡º</span><br><span class="line"></span><br><span class="line">æ£€æŸ¥å†å²å’ŒçŠ¶æ€ï¼ˆå‚è§ï¼šgit help revisionsï¼‰</span><br><span class="line">   bisect            é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½å¼•å…¥ bug çš„æäº¤</span><br><span class="line">   diff              æ˜¾ç¤ºæäº¤ä¹‹é—´ã€æäº¤å’Œå·¥ä½œåŒºä¹‹é—´ç­‰çš„å·®å¼‚</span><br><span class="line">   grep              è¾“å‡ºå’Œæ¨¡å¼åŒ¹é…çš„è¡Œ</span><br><span class="line">   log               æ˜¾ç¤ºæäº¤æ—¥å¿—</span><br><span class="line">   show              æ˜¾ç¤ºå„ç§ç±»å‹çš„å¯¹è±¡</span><br><span class="line">   status            æ˜¾ç¤ºå·¥ä½œåŒºçŠ¶æ€</span><br><span class="line"></span><br><span class="line">æ‰©å±•ã€æ ‡è®°å’Œè°ƒæ ¡æ‚¨çš„å†å²è®°å½•</span><br><span class="line">   branch            åˆ—å‡ºã€åˆ›å»ºæˆ–åˆ é™¤åˆ†æ”¯</span><br><span class="line">   commit            è®°å½•å˜æ›´åˆ°ä»“åº“</span><br><span class="line">   merge             åˆå¹¶ä¸¤ä¸ªæˆ–æ›´å¤šå¼€å‘å†å²</span><br><span class="line">   rebase            åœ¨å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šé‡æ–°åº”ç”¨æäº¤</span><br><span class="line">   reset             é‡ç½®å½“å‰ HEAD åˆ°æŒ‡å®šçŠ¶æ€</span><br><span class="line">   switch            åˆ‡æ¢åˆ†æ”¯</span><br><span class="line">   tag               åˆ›å»ºã€åˆ—å‡ºã€åˆ é™¤æˆ–æ ¡éªŒä¸€ä¸ª GPG ç­¾åçš„æ ‡ç­¾å¯¹è±¡</span><br><span class="line"></span><br><span class="line">ååŒï¼ˆå‚è§ï¼šgit help workflowsï¼‰</span><br><span class="line">   fetch             ä»å¦å¤–ä¸€ä¸ªä»“åº“ä¸‹è½½å¯¹è±¡å’Œå¼•ç”¨</span><br><span class="line">   pull              è·å–å¹¶æ•´åˆå¦å¤–çš„ä»“åº“æˆ–ä¸€ä¸ªæœ¬åœ°åˆ†æ”¯</span><br><span class="line">   push              æ›´æ–°è¿œç¨‹å¼•ç”¨å’Œç›¸å…³çš„å¯¹è±¡</span><br><span class="line"></span><br><span class="line">å‘½ä»¤ &#39;git help -a&#39; å’Œ &#39;git help -g&#39; æ˜¾ç¤ºå¯ç”¨çš„å­å‘½ä»¤å’Œä¸€äº›æ¦‚å¿µå¸®åŠ©ã€‚</span><br><span class="line">æŸ¥çœ‹ &#39;git help &lt;å‘½ä»¤&gt;&#39; æˆ– &#39;git help &lt;æ¦‚å¿µ&gt;&#39; ä»¥è·å–ç»™å®šå­å‘½ä»¤æˆ–æ¦‚å¿µçš„</span><br><span class="line">å¸®åŠ©ã€‚</span><br><span class="line">æœ‰å…³ç³»ç»Ÿçš„æ¦‚è¿°ï¼ŒæŸ¥çœ‹ &#39;git help git&#39;</span><br></pre></td></tr></table></figure>
<h3 id="Gitä½¿ç”¨ï¼š"><a class="header-anchor" href="#Gitä½¿ç”¨ï¼š">Â¶</a>Gitä½¿ç”¨ï¼š</h3>
<h4 id="ç”Ÿæˆå¯†é’¥"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥">Â¶</a>ç”Ÿæˆå¯†é’¥</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;è¿™é‡Œæ¢ä¸Šä½ çš„é‚®ç®±&quot;</span><br></pre></td></tr></table></figure>
<p>æœ€åå¾—åˆ°<code>id_rsa</code>å’Œ<code>id_rsa.pub</code>ä¸¤ä¸ªæ–‡ä»¶ã€‚</p>
<h4 id="Gité…ç½®ä¿¡æ¯"><a class="header-anchor" href="#Gité…ç½®ä¿¡æ¯">Â¶</a>Gité…ç½®ä¿¡æ¯</h4>
<h5 id="æŸ¥çœ‹é…ç½®ä¿¡æ¯"><a class="header-anchor" href="#æŸ¥çœ‹é…ç½®ä¿¡æ¯">Â¶</a>æŸ¥çœ‹é…ç½®ä¿¡æ¯</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹ç³»ç»Ÿé…ç½®ä¿¡æ¯</span><br><span class="line">* git config --system --list</span><br><span class="line"></span><br><span class="line">å½“å‰ç”¨æˆ·é…ç½®</span><br><span class="line">* git config --global --list</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹å½“å‰ä»“åº“é…ç½®</span><br><span class="line">* git config --local --list</span><br></pre></td></tr></table></figure>
<h5 id="è®¾ç½®ç”¨æˆ·ä¿¡æ¯"><a class="header-anchor" href="#è®¾ç½®ç”¨æˆ·ä¿¡æ¯">Â¶</a>è®¾ç½®ç”¨æˆ·ä¿¡æ¯</h5>
<p>å…¨å±€è®¾ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;crab&quot;</span><br><span class="line">git config --global user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>
<p>å½“å‰ä»“åº“ç”Ÿæ•ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --local user.name &quot;crab&quot;</span><br><span class="line">git config --local user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>
<h4 id="Git-Remote"><a class="header-anchor" href="#Git-Remote">Â¶</a>Git Remote</h4>
<h5 id="æ–°å¢remoteåœ°å€"><a class="header-anchor" href="#æ–°å¢remoteåœ°å€">Â¶</a>æ–°å¢remoteåœ°å€</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git remote add upstream http:&#x2F;&#x2F;github&#x2F;**remote**&#x2F;test.git</span><br><span class="line">git remote -v å¯ä»¥æŸ¥çœ‹å…·ä½“è·¯å¾„</span><br></pre></td></tr></table></figure>
<h5 id="merge-fetchè¿œç¨‹ä»£ç åˆ°XXXåˆ†æ”¯"><a class="header-anchor" href="#merge-fetchè¿œç¨‹ä»£ç åˆ°XXXåˆ†æ”¯">Â¶</a>merge/fetchè¿œç¨‹ä»£ç åˆ°XXXåˆ†æ”¯</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€git fetch upstreamã€‚</span><br><span class="line">2ã€åˆ‡å›åˆ°masteråˆ†æ”¯ã€‚</span><br><span class="line">3ã€git merge upstream&#x2F;master åˆå¹¶è¿œç¨‹upstreamåˆ†æ”¯åˆ°æœ¬åœ°masterã€‚</span><br><span class="line">4ã€è§£å†³å†²çªæˆ–å…¶ä»–é—®é¢˜ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="Git-è¯¯åˆ é™¤æ¢å¤"><a class="header-anchor" href="#Git-è¯¯åˆ é™¤æ¢å¤">Â¶</a>Git è¯¯åˆ é™¤æ¢å¤</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€git  fsck --lost -found :æŸ¥çœ‹æœ€è¿‘ç§»é™¤çš„æ–‡ä»¶.</span><br><span class="line">2ã€git show  &#39;è¯¯åˆ ç¼–å·&#39;ï¼šæŸ¥çœ‹åˆ é™¤æ–‡ä»¶å†…å®¹.</span><br><span class="line">3ã€git merge â€˜è¯¯åˆ ç¼–å·â€™ï¼š æœ¬åœ°åˆå¹¶è¯¯åˆ çš„æ–‡ä»¶å†…å®¹.</span><br></pre></td></tr></table></figure>
<h4 id="Git-resetæ’¤å›æ“ä½œ"><a class="header-anchor" href="#Git-resetæ’¤å›æ“ä½œ">Â¶</a>Git resetæ’¤å›æ“ä½œ</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€git reflog</span><br><span class="line">2ã€git reset COMMITID    å°±å¯ä»¥å›åˆ°COMMITIDé‚£ä¸ªåˆ†æ”¯å’Œç‰ˆæœ¬ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="Gitåˆ†æ”¯"><a class="header-anchor" href="#Gitåˆ†æ”¯">Â¶</a>Gitåˆ†æ”¯</h4>
<h5 id="ç”¨æ³•"><a class="header-anchor" href="#ç”¨æ³•">Â¶</a>ç”¨æ³•</h5>
<blockquote>
<p>è·å–ç”¨æ³•ï¼šGit branch -d --help</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç”¨æ³•ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r | -a] [--merged | --no-merged]</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-l] [-f] &lt;åˆ†æ”¯å&gt; [&lt;èµ·å§‹ç‚¹&gt;]</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r] (-d | -D) &lt;åˆ†æ”¯å&gt;...</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] (-m | -M) [&lt;æ—§åˆ†æ”¯&gt;] &lt;æ–°åˆ†æ”¯&gt;</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] (-c | -C) [&lt;è€åˆ†æ”¯&gt;] &lt;æ–°åˆ†æ”¯&gt;</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r | -a] [--points-at]</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r | -a] [--format]</span><br><span class="line"></span><br><span class="line">é€šç”¨é€‰é¡¹</span><br><span class="line">    -v, --verbose         æ˜¾ç¤ºå“ˆå¸Œå€¼å’Œä¸»é¢˜ï¼Œè‹¥å‚æ•°å‡ºç°ä¸¤æ¬¡åˆ™æ˜¾ç¤ºä¸Šæ¸¸åˆ†æ”¯</span><br><span class="line">    -q, --quiet           ä¸æ˜¾ç¤ºä¿¡æ¯</span><br><span class="line">    -t, --track           è®¾ç½®è·Ÿè¸ªæ¨¡å¼ï¼ˆå‚è§ git-pull(1)ï¼‰</span><br><span class="line">    -u, --set-upstream-to &lt;ä¸Šæ¸¸&gt;</span><br><span class="line">                          æ”¹å˜ä¸Šæ¸¸ä¿¡æ¯</span><br><span class="line">    --unset-upstream      å–æ¶ˆä¸Šæ¸¸ä¿¡æ¯çš„è®¾ç½®</span><br><span class="line">    --color[&#x3D;&lt;ä½•æ—¶&gt;]      ä½¿ç”¨å½©è‰²è¾“å‡º</span><br><span class="line">    -r, --remotes         ä½œç”¨äºè¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</span><br><span class="line">    --contains &lt;æäº¤&gt;     åªæ‰“å°åŒ…å«è¯¥æäº¤çš„åˆ†æ”¯</span><br><span class="line">    --no-contains &lt;æäº¤&gt;  åªæ‰“å°ä¸åŒ…å«è¯¥æäº¤çš„åˆ†æ”¯</span><br><span class="line">    --abbrev[&#x3D;&lt;n&gt;]        ç”¨ &lt;n&gt; ä½æ•°å­—æ˜¾ç¤º SHA-1 å“ˆå¸Œå€¼</span><br><span class="line"></span><br><span class="line">å…·ä½“çš„ git-branch åŠ¨ä½œï¼š</span><br><span class="line">    -a, --all             åˆ—å‡ºè¿œç¨‹è·Ÿè¸ªåŠæœ¬åœ°åˆ†æ”¯</span><br><span class="line">    -d, --delete          åˆ é™¤å®Œå…¨åˆå¹¶çš„åˆ†æ”¯</span><br><span class="line">    -D                    åˆ é™¤åˆ†æ”¯ï¼ˆå³ä½¿æ²¡æœ‰åˆå¹¶ï¼‰</span><br><span class="line">    -m, --move            ç§»åŠ¨&#x2F;é‡å‘½åä¸€ä¸ªåˆ†æ”¯ï¼Œä»¥åŠå®ƒçš„å¼•ç”¨æ—¥å¿—</span><br><span class="line">    -M                    ç§»åŠ¨&#x2F;é‡å‘½åä¸€ä¸ªåˆ†æ”¯ï¼Œå³ä½¿ç›®æ ‡å·²å­˜åœ¨</span><br><span class="line">    -c, --copy            æ‹·è´ä¸€ä¸ªåˆ†æ”¯å’Œå®ƒçš„å¼•ç”¨æ—¥å¿—</span><br><span class="line">    -C                    æ‹·è´ä¸€ä¸ªåˆ†æ”¯ï¼Œå³ä½¿ç›®æ ‡å·²å­˜åœ¨</span><br><span class="line">    -l, --list            åˆ—å‡ºåˆ†æ”¯å</span><br><span class="line">    --show-current        æ˜¾ç¤ºå½“å‰åˆ†æ”¯å</span><br><span class="line">    --create-reflog       åˆ›å»ºåˆ†æ”¯çš„å¼•ç”¨æ—¥å¿—</span><br><span class="line">    --edit-description    æ ‡è®°åˆ†æ”¯çš„æè¿°</span><br><span class="line">    -f, --force           å¼ºåˆ¶åˆ›å»ºã€ç§»åŠ¨&#x2F;é‡å‘½åã€åˆ é™¤</span><br><span class="line">    --merged &lt;æäº¤&gt;       åªæ‰“å°å·²ç»åˆå¹¶çš„åˆ†æ”¯</span><br><span class="line">    --no-merged &lt;æäº¤&gt;    åªæ‰“å°å°šæœªåˆå¹¶çš„åˆ†æ”¯</span><br><span class="line">    --column[&#x3D;&lt;é£æ ¼&gt;]     ä»¥åˆ—çš„æ–¹å¼æ˜¾ç¤ºåˆ†æ”¯</span><br><span class="line">    --sort &lt;key&gt;          æ’åºçš„å­—æ®µå</span><br><span class="line">    --points-at &lt;å¯¹è±¡&gt;    åªæ‰“å°æŒ‡å‘è¯¥å¯¹è±¡çš„åˆ†æ”¯</span><br><span class="line">    -i, --ignore-case     æ’åºå’Œè¿‡æ»¤å±äºå¤§å°å†™ä¸æ•æ„Ÿ</span><br><span class="line">    --format &lt;æ ¼å¼&gt;       è¾“å‡ºæ ¼å¼</span><br></pre></td></tr></table></figure>
<h5 id="è·å–æ‰€æœ‰åˆ†æ”¯"><a class="header-anchor" href="#è·å–æ‰€æœ‰åˆ†æ”¯">Â¶</a>è·å–æ‰€æœ‰åˆ†æ”¯</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git branch -r | grep -v &#39;\-&gt;&#39; | while read remote; do git branch --track &quot;$&#123;remote#origin&#x2F;&#125;&quot; &quot;$remote&quot;; done</span><br><span class="line">git fetch --all</span><br><span class="line">git pull --all</span><br></pre></td></tr></table></figure>
<h5 id="add-removeåˆ†æ”¯"><a class="header-anchor" href="#add-removeåˆ†æ”¯">Â¶</a>add/removeåˆ†æ”¯</h5>
<p>æ–°å»º&amp;åˆ‡æ¢:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git checkout -b iss53</span><br><span class="line"></span><br><span class="line">æ˜¯ä¸‹é¢ä¸¤æ¡çš„ç®€å†™ï¼š</span><br><span class="line">git branch iss53</span><br><span class="line">git checkout iss53</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤åˆ†æ”¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git branch -d iss53</span><br></pre></td></tr></table></figure>
<h4 id="Git-stash"><a class="header-anchor" href="#Git-stash">Â¶</a>Git stash</h4>
<h5 id="å¸¸ç”¨ï¼š"><a class="header-anchor" href="#å¸¸ç”¨ï¼š">Â¶</a>å¸¸ç”¨ï¼š</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ï¼ˆ1ï¼‰git stash save &quot;save message&quot;  : æ‰§è¡Œå­˜å‚¨æ—¶ï¼Œæ·»åŠ å¤‡æ³¨ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ï¼Œåªæœ‰git stash ä¹Ÿè¦å¯ä»¥çš„ï¼Œä½†æŸ¥æ‰¾æ—¶ä¸æ–¹ä¾¿è¯†åˆ«ã€‚</span><br><span class="line">ï¼ˆ2ï¼‰git stash list  ï¼šæŸ¥çœ‹stashäº†å“ªäº›å­˜å‚¨</span><br><span class="line">ï¼ˆ3ï¼‰git stash show ï¼šæ˜¾ç¤ºåšäº†å“ªäº›æ”¹åŠ¨ï¼Œé»˜è®¤showç¬¬ä¸€ä¸ªå­˜å‚¨,å¦‚æœè¦æ˜¾ç¤ºå…¶ä»–å­˜è´®ï¼Œåé¢åŠ stash@&#123;$num&#125;ï¼Œæ¯”å¦‚ç¬¬äºŒä¸ª git stash show stash@&#123;1&#125;</span><br><span class="line">ï¼ˆ4ï¼‰git stash show -p : æ˜¾ç¤ºç¬¬ä¸€ä¸ªå­˜å‚¨çš„æ”¹åŠ¨ï¼Œå¦‚æœæƒ³æ˜¾ç¤ºå…¶ä»–å­˜å­˜å‚¨ï¼Œå‘½ä»¤ï¼šgit stash show  stash@&#123;$num&#125;  -p ï¼Œæ¯”å¦‚ç¬¬äºŒä¸ªï¼šgit stash show  stash@&#123;1&#125;  -p</span><br><span class="line">ï¼ˆ5ï¼‰git stash apply :åº”ç”¨æŸä¸ªå­˜å‚¨,ä½†ä¸ä¼šæŠŠå­˜å‚¨ä»å­˜å‚¨åˆ—è¡¨ä¸­åˆ é™¤ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªå­˜å‚¨,å³stash@&#123;0&#125;ï¼Œå¦‚æœè¦ä½¿ç”¨å…¶ä»–ä¸ªï¼Œgit stash apply stash@&#123;$num&#125; ï¼Œ æ¯”å¦‚ç¬¬äºŒä¸ªï¼šgit stash apply stash@&#123;1&#125; </span><br><span class="line">ï¼ˆ6ï¼‰git stash pop ï¼šå‘½ä»¤æ¢å¤ä¹‹å‰ç¼“å­˜çš„å·¥ä½œç›®å½•ï¼Œå°†ç¼“å­˜å †æ ˆä¸­çš„å¯¹åº”stashåˆ é™¤ï¼Œå¹¶å°†å¯¹åº”ä¿®æ”¹åº”ç”¨åˆ°å½“å‰çš„å·¥ä½œç›®å½•ä¸‹,é»˜è®¤ä¸ºç¬¬ä¸€ä¸ªstash,å³stash@&#123;0&#125;ï¼Œå¦‚æœè¦åº”ç”¨å¹¶åˆ é™¤å…¶ä»–stashï¼Œå‘½ä»¤ï¼šgit stash pop stash@&#123;$num&#125; ï¼Œæ¯”å¦‚åº”ç”¨å¹¶åˆ é™¤ç¬¬äºŒä¸ªï¼šgit stash pop stash@&#123;1&#125;</span><br><span class="line">ï¼ˆ7ï¼‰git stash drop stash@&#123;$num&#125; ï¼šä¸¢å¼ƒstash@&#123;$num&#125;å­˜å‚¨ï¼Œä»åˆ—è¡¨ä¸­åˆ é™¤è¿™ä¸ªå­˜å‚¨</span><br><span class="line">ï¼ˆ8ï¼‰git stash clear ï¼šåˆ é™¤æ‰€æœ‰ç¼“å­˜çš„stash</span><br></pre></td></tr></table></figure>
<h4 id="Git-Tag"><a class="header-anchor" href="#Git-Tag">Â¶</a>Git Tag</h4>
<h5 id="å¸¸ç”¨ï¼š-v2"><a class="header-anchor" href="#å¸¸ç”¨ï¼š-v2">Â¶</a>å¸¸ç”¨ï¼š</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2097 Â± git tag -a --help</span><br><span class="line">ç”¨æ³•ï¼šgit tag [-a | -s | -u &lt;key-id&gt;] [-f] [-m &lt;æ¶ˆæ¯&gt; | -F &lt;æ–‡ä»¶&gt;]</span><br><span class="line">		&lt;æ ‡ç­¾å&gt; [&lt;å¤´&gt;]</span><br><span class="line">  æˆ–ï¼šgit tag -d &lt;æ ‡ç­¾å&gt;...</span><br><span class="line">  æˆ–ï¼šgit tag -l [-n[&lt;æ•°å­—&gt;]] [--contains &lt;æäº¤&gt;] [--no-contains &lt;æäº¤&gt;] [--points-at &lt;å¯¹è±¡&gt;]</span><br><span class="line">		[--format&#x3D;&lt;æ ¼å¼&gt;] [--[no-]merged [&lt;æäº¤&gt;]] [&lt;æ¨¡å¼&gt;...]</span><br><span class="line">  æˆ–ï¼šgit tag -v [--format&#x3D;&lt;æ ¼å¼&gt;] &lt;æ ‡ç­¾å&gt;...</span><br><span class="line"></span><br><span class="line">    -l, --list            åˆ—å‡ºæ ‡ç­¾åç§°</span><br><span class="line">    -n[&lt;n&gt;]               æ¯ä¸ªæ ‡ç­¾ä¿¡æ¯æ‰“å° &lt;n&gt; è¡Œ</span><br><span class="line">    -d, --delete          åˆ é™¤æ ‡ç­¾</span><br><span class="line">    -v, --verify          éªŒè¯æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">æ ‡ç­¾åˆ›å»ºé€‰é¡¹</span><br><span class="line">    -a, --annotate        é™„æ³¨æ ‡ç­¾ï¼Œéœ€è¦ä¸€ä¸ªè¯´æ˜</span><br><span class="line">    -m, --message &lt;è¯´æ˜&gt;  æ ‡ç­¾è¯´æ˜</span><br><span class="line">    -F, --file &lt;æ–‡ä»¶&gt;     ä»æ–‡ä»¶ä¸­è¯»å–æäº¤è¯´æ˜</span><br><span class="line">    -e, --edit            å¼ºåˆ¶ç¼–è¾‘æ ‡ç­¾è¯´æ˜</span><br><span class="line">    -s, --sign            é™„æ³¨å¹¶é™„åŠ  GPG ç­¾åçš„æ ‡ç­¾</span><br><span class="line">    --cleanup &lt;æ¨¡å¼&gt;      è®¾ç½®å¦‚ä½•åˆ é™¤æäº¤è¯´æ˜é‡Œçš„ç©ºæ ¼å’Œ#æ³¨é‡Š</span><br><span class="line">    -u, --local-user &lt;key-id&gt;</span><br><span class="line">                          ä½¿ç”¨å¦å¤–çš„ç§é’¥ç­¾åè¯¥æ ‡ç­¾</span><br><span class="line">    -f, --force           å¦‚æœå­˜åœ¨ï¼Œæ›¿æ¢ç°æœ‰çš„æ ‡ç­¾</span><br><span class="line">    --create-reflog       åˆ›å»ºå¼•ç”¨æ—¥å¿—</span><br><span class="line"></span><br><span class="line">æ ‡ç­¾åˆ—è¡¨é€‰é¡¹</span><br><span class="line">    --column[&#x3D;&lt;é£æ ¼&gt;]     ä»¥åˆ—çš„æ–¹å¼æ˜¾ç¤ºæ ‡ç­¾åˆ—è¡¨</span><br><span class="line">    --contains &lt;æäº¤&gt;     åªæ‰“å°åŒ…å«è¯¥æäº¤çš„æ ‡ç­¾</span><br><span class="line">    --no-contains &lt;æäº¤&gt;  åªæ‰“å°ä¸åŒ…å«è¯¥æäº¤çš„æ ‡ç­¾</span><br><span class="line">    --merged &lt;æäº¤&gt;       åªæ‰“å°å·²ç»åˆå¹¶çš„æ ‡ç­¾</span><br><span class="line">    --no-merged &lt;æäº¤&gt;    åªæ‰“å°å°šæœªåˆå¹¶çš„æ ‡ç­¾</span><br><span class="line">    --sort &lt;key&gt;          æ’åºçš„å­—æ®µå</span><br><span class="line">    --points-at &lt;å¯¹è±¡&gt;    åªæ‰“å°æŒ‡å‘è¯¥å¯¹è±¡çš„æ ‡ç­¾</span><br><span class="line">    --format &lt;æ ¼å¼&gt;       è¾“å‡ºæ ¼å¼</span><br><span class="line">    --color[&#x3D;&lt;ä½•æ—¶&gt;]      éµç…§æ ¼å¼ä¸­çš„é¢œè‰²è¾“å‡º</span><br><span class="line">    -i, --ignore-case     æ’åºå’Œè¿‡æ»¤å±äºå¤§å°å†™ä¸æ•æ„Ÿ</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git tagæŒ‰ç…§versionæ’åºï¼š</span><br><span class="line">git tag -n</span><br><span class="line"></span><br><span class="line">git tagæŒ‰ç…§æ—¶é—´æ’åº</span><br><span class="line">git tag -n --sort&#x3D;taggerdate</span><br></pre></td></tr></table></figure>
<h5 id="æ‰“Tag"><a class="header-anchor" href="#æ‰“Tag">Â¶</a>æ‰“Tag</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git tag -a v0.0.1 -m &quot;V0.0.1&quot; </span><br></pre></td></tr></table></figure>
<h5 id="åˆ é™¤Tag"><a class="header-anchor" href="#åˆ é™¤Tag">Â¶</a>åˆ é™¤Tag</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git tag -d v0.0.1</span><br></pre></td></tr></table></figure>
<h5 id="æ¨é€Tag"><a class="header-anchor" href="#æ¨é€Tag">Â¶</a>æ¨é€Tag</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git push origin master --tags</span><br></pre></td></tr></table></figure>
<h4 id="Git-push"><a class="header-anchor" href="#Git-push">Â¶</a>Git push</h4>
<h5 id="ç”¨æ³•-v2"><a class="header-anchor" href="#ç”¨æ³•-v2">Â¶</a>ç”¨æ³•</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç”¨æ³•ï¼šgit push [&lt;é€‰é¡¹&gt;] [&lt;ä»“åº“&gt; [&lt;å¼•ç”¨è§„æ ¼&gt;...]]</span><br><span class="line"></span><br><span class="line">    -v, --verbose         æ›´åŠ è¯¦ç»†</span><br><span class="line">    -q, --quiet           æ›´åŠ å®‰é™</span><br><span class="line">    --repo &lt;ä»“åº“&gt;         ä»“åº“</span><br><span class="line">    --all                 æ¨é€æ‰€æœ‰å¼•ç”¨</span><br><span class="line">    --mirror              é•œåƒæ‰€æœ‰å¼•ç”¨</span><br><span class="line">    -d, --delete          åˆ é™¤å¼•ç”¨</span><br><span class="line">    --tags                æ¨é€æ ‡ç­¾ï¼ˆä¸èƒ½ä½¿ç”¨ --all or --mirrorï¼‰</span><br><span class="line">    -n, --dry-run         æ¼”ä¹ </span><br><span class="line">    --porcelain           æœºå™¨å¯è¯»çš„è¾“å‡º</span><br><span class="line">    -f, --force           å¼ºåˆ¶æ›´æ–°</span><br><span class="line">    --force-with-lease[&#x3D;&lt;å¼•ç”¨å&gt;:&lt;æœŸæœ›å€¼&gt;]</span><br><span class="line">                          è¦æ±‚å¼•ç”¨æ—§çš„å–å€¼ä¸ºè®¾å®šå€¼</span><br><span class="line">    --recurse-submodules (check|on-demand|no)</span><br><span class="line">                          æ§åˆ¶å­æ¨¡ç»„çš„é€’å½’æ¨é€</span><br><span class="line">    --thin                ä½¿ç”¨ç²¾ç®€æ‰“åŒ…</span><br><span class="line">    --receive-pack &lt;receive-pack&gt;</span><br><span class="line">                          æ¥æ”¶åŒ…ç¨‹åº</span><br><span class="line">    --exec &lt;receive-pack&gt;</span><br><span class="line">                          æ¥æ”¶åŒ…ç¨‹åº</span><br><span class="line">    -u, --set-upstream    è®¾ç½® git pull&#x2F;status çš„ä¸Šæ¸¸</span><br><span class="line">    --progress            å¼ºåˆ¶æ˜¾ç¤ºè¿›åº¦æŠ¥å‘Š</span><br><span class="line">    --prune               æ¸…é™¤æœ¬åœ°åˆ é™¤çš„å¼•ç”¨</span><br><span class="line">    --no-verify           ç»•è¿‡ pre-push é’©å­</span><br><span class="line">    --follow-tags         æ¨é€ç¼ºå¤±ä½†æœ‰å…³çš„æ ‡ç­¾</span><br><span class="line">    --signed[&#x3D;(yes|no|if-asked)]</span><br><span class="line">                          ç”¨ GPG ä¸ºæ¨é€ç­¾å</span><br><span class="line">    --atomic              éœ€è¦è¿œç«¯æ”¯æŒåŸå­äº‹åŠ¡</span><br><span class="line">    -o, --push-option &lt;server-specific&gt;</span><br><span class="line">                          ä¼ è¾“é€‰é¡¹</span><br><span class="line">    -4, --ipv4            åªä½¿ç”¨ IPv4 åœ°å€</span><br><span class="line">    -6, --ipv6            åªä½¿ç”¨ IPv6 åœ°å€</span><br></pre></td></tr></table></figure>
<h4 id="Git-rebase"><a class="header-anchor" href="#Git-rebase">Â¶</a>Git rebase</h4>
<h5 id="å˜åŸºéµå®ˆçš„åŸåˆ™"><a class="header-anchor" href="#å˜åŸºéµå®ˆçš„åŸåˆ™">Â¶</a>å˜åŸºéµå®ˆçš„åŸåˆ™</h5>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¦‚æœæäº¤å­˜åœ¨äºä½ çš„ä»“åº“ä¹‹å¤–ï¼Œè€Œåˆ«äººå¯èƒ½åŸºäºè¿™äº›æäº¤è¿›è¡Œå¼€å‘ï¼Œé‚£ä¹ˆä¸è¦æ‰§è¡Œå˜åŸºã€‚---[å®˜ç½‘å˜åŸº](https:&#x2F;&#x2F;git-scm.com&#x2F;book&#x2F;zh&#x2F;v2&#x2F;Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)</span><br><span class="line"></span><br><span class="line">TODO åç»­æ›´æ–°æ­¤è¿‡ç¨‹</span><br></pre></td></tr></table></figure>
<h5 id="ç»å…¸ç”¨æ³•ï¼š"><a class="header-anchor" href="#ç»å…¸ç”¨æ³•ï¼š">Â¶</a>ç»å…¸ç”¨æ³•ï¼š</h5>
<blockquote>
<p>git rebase --help</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Assume the following history exists and the current branch is &quot;topic&quot;:</span><br><span class="line"></span><br><span class="line">              A---B---C topic</span><br><span class="line">             &#x2F;</span><br><span class="line">        D---E---F---G master</span><br><span class="line">From this point, the result of either of thefollowing </span><br><span class="line"></span><br><span class="line">commands:</span><br><span class="line">    git rebase master</span><br><span class="line">    git rebase master topic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">would be:</span><br><span class="line">                      A&#39;--B&#39;--C&#39; topic</span><br><span class="line">                     &#x2F;</span><br><span class="line">        D---E---F---G master</span><br></pre></td></tr></table></figure>
<h5 id="rebaseåœºæ™¯ï¼š"><a class="header-anchor" href="#rebaseåœºæ™¯ï¼š">Â¶</a>rebaseåœºæ™¯ï¼š</h5>
<p><a href="https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA">å®˜ç½‘ä¾‹å­</a></p>
<h3 id="Git-å¿«é€Ÿåœºæ™¯ï¼š"><a class="header-anchor" href="#Git-å¿«é€Ÿåœºæ™¯ï¼š">Â¶</a>Git å¿«é€Ÿåœºæ™¯ï¼š</h3>
<p>å…¶å®è¿˜æ˜¯å¯¹ä¸Šè¿°å‘½ä»¤çš„æ´»å­¦æ´»ç”¨ã€‚</p>
<h4 id="Git-Resetåœºæ™¯"><a class="header-anchor" href="#Git-Resetåœºæ™¯">Â¶</a>Git Resetåœºæ™¯</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. æœ¬åœ°ä¿®æ”¹äº†ä¸€å †æ–‡ä»¶(å¹¶æ²¡æœ‰ä½¿ç”¨git addåˆ°æš‚å­˜åŒº)ï¼Œæƒ³æ”¾å¼ƒä¿®æ”¹ã€‚</span><br><span class="line">å•ä¸ªæ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git checkout -- filename</span><br><span class="line"></span><br><span class="line">æ‰€æœ‰æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git checkout .</span><br><span class="line"> </span><br><span class="line">2. æœ¬åœ°æ–°å¢äº†ä¸€å †æ–‡ä»¶(å¹¶æ²¡æœ‰git addåˆ°æš‚å­˜åŒº)ï¼Œæƒ³æ”¾å¼ƒä¿®æ”¹ã€‚</span><br><span class="line">å•ä¸ªæ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">$ rm filename &#x2F; rm dir -rf</span><br><span class="line"></span><br><span class="line">æ‰€æœ‰æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">$ git clean -xdf</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åˆ é™¤æ–°å¢çš„æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å·²ç»å·²ç»git addåˆ°æš‚å­˜åŒºï¼Œå¹¶ä¸ä¼šåˆ é™¤ï¼</span><br><span class="line"></span><br><span class="line">3. æœ¬åœ°ä¿®æ”¹&#x2F;æ–°å¢äº†ä¸€å †æ–‡ä»¶ï¼Œå·²ç»git addåˆ°æš‚å­˜åŒºï¼Œæƒ³æ”¾å¼ƒä¿®æ”¹ã€‚</span><br><span class="line">å•ä¸ªæ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git reset HEAD filename</span><br><span class="line"></span><br><span class="line">æ‰€æœ‰æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git reset HEAD .</span><br><span class="line"> </span><br><span class="line">4. æœ¬åœ°é€šè¿‡git add &amp; git commit ä¹‹åï¼Œæƒ³è¦æ’¤é”€æ­¤æ¬¡commitå’Œä»£ç </span><br><span class="line"></span><br><span class="line">git reset commit_id</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªidæ˜¯ä½ æƒ³è¦å›åˆ°çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡git logæŸ¥çœ‹ï¼Œå¯ä»¥åªé€‰å‰6ä½</span><br><span class="line">&#x2F;&#x2F; æ’¤é”€ä¹‹åï¼Œä½ æ‰€åšçš„å·²ç»commitçš„ä¿®æ”¹è¿˜åœ¨å·¥ä½œåŒºï¼</span><br><span class="line"></span><br><span class="line">git reset --hard commit_id</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªidæ˜¯ä½ æƒ³è¦å›åˆ°çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡git logæŸ¥çœ‹ï¼Œå¯ä»¥åªé€‰å‰6ä½</span><br><span class="line">&#x2F;&#x2F; æ’¤é”€ä¹‹åï¼Œä½ æ‰€åšçš„å·²ç»commitçš„ä¿®æ”¹å°†ä¼šæ¸…é™¤ï¼Œä»åœ¨å·¥ä½œåŒº&#x2F;æš‚å­˜åŒºçš„ä»£ç ä¸ä¼šæ¸…é™¤ï¼</span><br><span class="line"></span><br><span class="line">5. git add &amp; git commit æäº¤åï¼Œåªæƒ³å›æ»šcommitï¼š</span><br><span class="line">	git reset --soft HEAD^</span><br><span class="line">	æ³¨æ„è¿™ä»…ä»…æ˜¯å›æ»šäº†ä½ çš„commitï¼Œä»£ç ä¾æ—§åœ¨çš„ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h3>
]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ3ã€git czè§„èŒƒæäº¤</title>
    <url>/archives/458b44c2.html</url>
    <content><![CDATA[<h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰">Â¶</a>å®šä¹‰</h3>
<p><a href="https://github.com/commitizen/cz-cli">å®˜æ–¹ specification</a><br>
ç®€å•çš„è¯´ä¸ºäº†ä»£ç æäº¤æ›´åŠ è§„èŒƒ</p>
<h3 id="åœºæ™¯"><a class="header-anchor" href="#åœºæ™¯">Â¶</a>åœºæ™¯</h3>
<p>git commitä½¿ç”¨<br>
<img src="https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png" alt=""></p>
<h3 id="ä½¿ç”¨æ­¥éª¤"><a class="header-anchor" href="#ä½¿ç”¨æ­¥éª¤">Â¶</a>ä½¿ç”¨æ­¥éª¤</h3>
<ul>
<li>å®‰è£…nodejsï¼Œç‰ˆæœ¬å»ºè®®æœ€æ–°.<a href="https://nodejs.org/zh-cn/">å®˜ç½‘</a></li>
<li>æ‰“å¼€ä½ çš„å‘½ä»¤è¡Œï¼š</li>
</ul>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¾“å…¥ï¼šnpm install -g commitizen</span><br><span class="line">windowsåº”è¯¥æ˜¯cmdå§ã€‚</span><br><span class="line">macç”¨ç»ˆç«¯æˆ–è€…iterm2éƒ½å¯ä»¥ã€‚</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æç¤ºä»¥ä¸‹ä¿¡æ¯å³æˆåŠŸã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-&gt; % sudo npm install -g commitizen</span><br><span class="line">Password:</span><br><span class="line">npm WARN deprecated resolve-url@0.2.1: https:&#x2F;&#x2F;github.com&#x2F;lydell&#x2F;resolve-url#deprecated</span><br><span class="line">npm WARN deprecated urix@0.1.0: Please see https:&#x2F;&#x2F;github.com&#x2F;lydell&#x2F;urix#deprecated</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;cz -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;git-cz</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;git-cz -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;git-cz</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;commitizen -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;commitizen</span><br><span class="line">+ commitizen@4.2.1</span><br><span class="line">updated 1 package in 8.132s</span><br></pre></td></tr></table></figure>
<p>3ã€è¿›å…¥gité¡¹ç›®ä¸­ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤åˆå§‹åŒ–ç¯å¢ƒã€‚<br>
<code>commitizen init cz-conventional-changelog --save --save-exact</code></p>
<p>4ã€åœ¨æäº¤ä»£ç æ—¶ä½¿ç”¨</p>
<blockquote>
<p>git cz æ›¿æ¢ git commitå‘½ä»¤</p>
</blockquote>
<h3 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹">Â¶</a>æ³¨æ„äº‹é¡¹</h3>
<ul>
<li>å®‰è£…æ–¹å¼å¯é€‰æ‹©å…¨å±€å®‰è£…</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g commitizen cz-conventional-changelog</span><br><span class="line">echo &#39;&#123; &quot;path&quot;: &quot;cz-conventional-changelog&quot; &#125;&#39; &gt; ~&#x2F;.czrc</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ2ã€vscode å¸¸è§æ’ä»¶åŠå…¶ä½¿ç”¨</title>
    <url>/archives/8cf3cbca.html</url>
    <content><![CDATA[<blockquote>
<p>vscodeä¸­ä¸€äº›å¸¸è§çš„å‘ç‚¹â€¦</p>
</blockquote>
<h3 id="æ’ä»¶"><a class="header-anchor" href="#æ’ä»¶">Â¶</a>æ’ä»¶</h3>
<h4 id="æ ·å¼æ–¹é¢ï¼š"><a class="header-anchor" href="#æ ·å¼æ–¹é¢ï¼š">Â¶</a>æ ·å¼æ–¹é¢ï¼š</h4>
<ul>
<li>Indent Rainbo</li>
<li>Bracket Pair Colorizer # æ‹¬å·é¢œè‰²</li>
<li>Chinese Language       # æ±‰åŒ–</li>
</ul>
<a id="more"></a>
<h4 id="åŠŸèƒ½æ–¹é¢"><a class="header-anchor" href="#åŠŸèƒ½æ–¹é¢">Â¶</a>åŠŸèƒ½æ–¹é¢</h4>
<ul>
<li>Git Blame              # Gitæäº¤æŸ¥çœ‹</li>
<li>Code Spell Checker     # æ‹¼å†™æ£€æŸ¥</li>
<li>Reload                 # é‡æ–°åŠ è½½</li>
<li>Todo Tree              # ä»£åŠäº‹é¡¹</li>
<li>Settings Sync          # è®¾ç½®åŒæ­¥</li>
</ul>
]]></content>
      <tags>
        <tag>vscode</tag>
        <tag>å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ1ã€é‡æ‹¾é‚£ä»½æŠ˜è…¾ä¹‹å¿ƒï¼Œåšå®šè„šæ­¥</title>
    <url>/archives/640b5696.html</url>
    <content><![CDATA[<pre><code>ä»å‰ï¼Œç°åœ¨ï¼Œå°†æ¥...</code></pre>
]]></content>
      <tags>
        <tag>life</tag>
      </tags>
  </entry>
</search>
