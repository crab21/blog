<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/title.webp"><link rel="icon" type="image/png" sizes="16x16" href="/images/title.webp"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="IjX74irabw9RP2570h6wHZn7wHfXIobMdcU1b1Xcj6U"><meta name="baidu-site-verification" content="Fu7a4NLfPU"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//blog.imrcrab.com/css/robofont.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//blog.imrcrab.com/css/fancybox.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.imrcrab.com",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:"valine",storage:!0,lazyload:!0,nav:null,activeClass:"valine"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!0},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="工欲善其事，必先知其所以然… 学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获. ¶函数&amp; 变量初识"><meta property="og:type" content="article"><meta property="og:title" content="「19」GPM 调度流程"><meta property="og:url" content="https://blog.imrcrab.com/archives/5c6a362f.html"><meta property="og:site_name" content="迷茫的小螃蟹"><meta property="og:description" content="工欲善其事，必先知其所以然… 学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获. ¶函数&amp; 变量初识"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-11-16T13:09:17.000Z"><meta property="article:modified_time" content="2020-11-16T13:09:17.000Z"><meta property="article:author" content="crab"><meta property="article:tag" content="Go"><meta property="article:tag" content="GPM"><meta property="article:tag" content="Go源码"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://blog.imrcrab.com/archives/5c6a362f.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>「19」GPM 调度流程 | 迷茫的小螃蟹</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">迷茫的小螃蟹</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/crab21" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.imrcrab.com/archives/5c6a362f.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="crab"><meta itemprop="description" content="日行一步..."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="迷茫的小螃蟹"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 「19」GPM 调度流程</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-11-16 21:09:17" itemprop="dateCreated datePublished" datetime="2020-11-16T21:09:17+08:00">2020-11-16</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/archives/5c6a362f.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/archives/5c6a362f.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>756</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>工欲善其事，必先知其所以然…<br> 学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获.</p><h3 id="函数-变量初识"><a class="header-anchor" href="#函数-变量初识">¶</a>函数&amp; 变量初识</h3><blockquote></blockquote><a id="more"></a><blockquote><p>go version: 1.14.3</p></blockquote><h4 id="函数"><a class="header-anchor" href="#函数">¶</a>函数</h4><blockquote><p>/proc.go</p></blockquote><ul><li>main</li><li>sysmon</li><li>findrunnable</li><li>gopark「1.1」</li><li>gosched 「1.2」</li><li>mstart</li><li>wakep</li><li>schedule</li><li>cpuinit</li><li>schedinit</li><li>ready</li><li>readgstatus</li><li>startm</li><li>pollWork</li><li>injectglist</li><li>park_m</li><li>goyield</li><li>retake</li><li>globrunqput</li><li>globrunqputbatch</li><li>globrunqputhead</li></ul><h4 id="变量"><a class="header-anchor" href="#变量">¶</a>变量</h4><blockquote><p>/proc.go</p></blockquote><ul><li>m0</li><li>g0</li><li>allgs</li><li>allglock</li></ul><blockquote><p>/runtime2.go</p></blockquote><ul><li>g</li><li>p</li><li>m</li><li>allglen</li><li>allm</li><li>allp</li><li>allpLock</li><li>gomaxprocs</li><li>sched</li></ul><blockquote><p>/runtime2.go 常量</p></blockquote><ul><li>_Grunnable/_Grunning/_Gwaiting…</li></ul><h3 id="上述这些函数-变量-常量-what？"><a class="header-anchor" href="#上述这些函数-变量-常量-what？">¶</a>上述这些函数/变量/常量 what？</h3><p>写这么多，肯定不是简单的从源码仓库里面超出来，这些是一些比较重要的函数，当然还有很多没有罗列，这里主要想记录，也是思考的点：</p><ul><li>GPM为何会有这么多的状态</li><li>这些状态之间是如何配合和协调的</li><li>著名的工作偷取「P」是怎么操作的</li><li>如果让你设计，你应该会怎么设计GPM这个调度的过程「🏁重点」</li></ul><h3 id="切入点"><a class="header-anchor" href="#切入点">¶</a>切入点</h3><ul><li>main:入口函数</li><li>sysmon：监控调度线程</li><li>schedule：真实的调度器逻辑</li><li>m0/g0：特殊的存在体</li></ul><h3 id="如何开始？"><a class="header-anchor" href="#如何开始？">¶</a>如何开始？</h3><blockquote><p>简单点，从main开始.</p></blockquote><h3 id="瞎扯"><a class="header-anchor" href="#瞎扯">¶</a>瞎扯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">看了很长时间的go源码了，觉得一个好的设计，从来不是简单的学习别人的源码，</span><br><span class="line">更多的是学习源码的设计思路和当时设计时是基于哪种场景下的。</span><br><span class="line"></span><br><span class="line">考虑更多的场景，有没有其它的设计思路，可能没有现有的设计更出色，但更加适合别的场景。</span><br></pre></td></tr></table></figure><h3 id="未完待续"><a class="header-anchor" href="#未完待续">¶</a>未完待续.</h3></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/b885f9f7.html" rel="bookmark">「18」GPM 初识/设计</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/c770fe49.html" rel="bookmark">「25」GPM sysmon函数</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/b4edbd7.html" rel="bookmark">「24」GPM newm函数</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/9bb71eca.html" rel="bookmark">「23」GPM main入口函数</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/392d66f0.html" rel="bookmark">「22」GPM g0和m0</a></div></li></ul><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> crab</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://blog.imrcrab.com/archives/5c6a362f.html" title="「19」GPM 调度流程">https://blog.imrcrab.com/archives/5c6a362f.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Go/" rel="tag"><i class="fa fa-tag"></i> Go</a><a href="/tags/GPM/" rel="tag"><i class="fa fa-tag"></i> GPM</a><a href="/tags/Go%E6%BA%90%E7%A0%81/" rel="tag"><i class="fa fa-tag"></i> Go源码</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/b885f9f7.html" rel="prev" title="「18」GPM 初识/设计"><i class="fa fa-chevron-left"></i> 「18」GPM 初识/设计</a></div><div class="post-nav-item"> <a href="/archives/5ce14ff5.html" rel="next" title="「20」博客诡异事件">「20」博客诡异事件<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-%E5%8F%98%E9%87%8F%E5%88%9D%E8%AF%86"><span class="nav-number">1.</span> <span class="nav-text">函数&amp; 变量初识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.</span> <span class="nav-text">函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.</span> <span class="nav-text">变量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8A%E8%BF%B0%E8%BF%99%E4%BA%9B%E5%87%BD%E6%95%B0-%E5%8F%98%E9%87%8F-%E5%B8%B8%E9%87%8F-what%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">上述这些函数&#x2F;变量&#x2F;常量 what？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E5%85%A5%E7%82%B9"><span class="nav-number">3.</span> <span class="nav-text">切入点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%BC%80%E5%A7%8B%EF%BC%9F"><span class="nav-number">4.</span> <span class="nav-text">如何开始？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9E%8E%E6%89%AF"><span class="nav-number">5.</span> <span class="nav-text">瞎扯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AA%E5%AE%8C%E5%BE%85%E7%BB%AD"><span class="nav-number">6.</span> <span class="nav-text">未完待续.</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">crab</p><div class="site-description" itemprop="description">日行一步...</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">33</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/crab21" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;crab21" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:pywang112@gmail.com" title="E-Mail → mailto:pywang112@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2020 – <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">crab</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-chart-area"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">100k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">1:31</span></div><script async src="//blog.imrcrab.com/js/busuanzi.js"></script></div></footer></div><script size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="//blog.imrcrab.com/js/fancybox.js"></script><script src="//blog.imrcrab.com/js/fancybox.mini.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>!function(){var o,n,e=document.getElementsByTagName("link");if(0<e.length)for(i=0;i<e.length;i++)"canonical"==e[i].rel.toLowerCase()&&e[i].href&&(o=e[i].href);n=o?o.split(":")[0]:window.location.protocol.split(":")[0],o||(o=window.location.href),function(){var e=o,i=document.referrer;if(!/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(e)){var t="https"===String(n).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";i?(t+="?r="+encodeURIComponent(document.referrer),e&&(t+="&l="+e)):e&&(t+="?l="+e),(new Image).src=t}}(window)}()</script><script src="/js/local-search.js"></script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//blog.imrcrab.com/js/valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'rSgtfmim6nG8DA8i3gVctzC2-gzGzoHsz',
      appKey     : '9VTNtVhOTowLUAHYs2PJDms4',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!0,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},react:{opacity:.7},log:!1})</script></body></html>