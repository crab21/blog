<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ã€Œ93ã€ebpfä¹‹XDP</title>
    <url>/archives/110bb26b.html</url>
    <content><![CDATA[<p>ä¸€è½¬çœ¼å°±2023äº†,å¥½å¤šæ–‡ç« éƒ½åœ¨2022æ²¡æœ‰å‘å‡ºæ¥,æˆä¸ºäº†Draftsâ€¦</p>
<p>æœ€è¿‘åœ¨æLinux(çæ)çš„iptablesé˜²ç«å¢™,æœ‰ä¸€æ¬¡è¢«tcp attackäº†,å½“æ—¶æƒ³ç€iptablesæ€ä¹ˆéƒ½å¤Ÿäº†,ç»“æœæ²¡æœ‰æƒ³åˆ°çš„æ˜¯:<br>
CPUè¿‘ä¹æ»¡è½½(åæ¨¡æ‹Ÿäº†ä¸‹,æ˜¯cpuè½¯ä¸­æ–­å ç”¨è¿‡é«˜).</p>
<p>è¿˜æœ‰ä¸€æ¬¡è¢«dns udpæŠ•æ¯’äº†æ¶å¿ƒåˆ°äº†,</p>
<p>å¼€é—¨è§å±±å§,cpu è½¯ä¸­æ–­é—®é¢˜,æ˜¯è¿™æ¬¡è‡´å‘½çš„,ç”¨æ›¿ä»£çš„æ–¹æ¡ˆebpfå¯ä»¥æ¯”è¾ƒå¥½çš„è§£å†³(ä¸èƒ½å®Œå…¨é¿å…).</p>
<span id="more"></span>
<h2 id="iptablesåˆ†æ"><a class="header-anchor" href="#iptablesåˆ†æ">Â¶</a>iptablesåˆ†æ</h2>
<h3 id="ä¼˜åŠ¿"><a class="header-anchor" href="#ä¼˜åŠ¿">Â¶</a>ä¼˜åŠ¿:</h3>
<ul>
<li>ç®€æ´</li>
<li>æ˜“ç”¨</li>
<li>è§„åˆ™å¯æŸ¥</li>
<li>å¯éšå¤„google/baidu</li>
</ul>
<h3 id="çŸ­æ¿"><a class="header-anchor" href="#çŸ­æ¿">Â¶</a>çŸ­æ¿</h3>
<p>(å¦‚æœä½ æ˜¯iptablesçš„raw/bpfçº§åˆ«çš„ç”¨æˆ·,å°±åˆ«å¾€ä¸‹çœ‹äº†,ä½ å·²ç»å·…å³°[ç–¯]äº†).</p>
<ul>
<li>æ›´æ–°è§„åˆ™éœ€è¦é‡æ–°reload ALL,æ›´æ–°ååŠ è½½æˆæœ¬å¤ªé«˜è¿‡é«˜(å°¤å…¶æ˜¯è¿‡wçš„è§„åˆ™).</li>
<li>åŒ¹é…æ•ˆç‡O(n),çº¿æ€§çš„.</li>
</ul>
<h2 id="ebpf-æ›¿ä»£-iptables"><a class="header-anchor" href="#ebpf-æ›¿ä»£-iptables">Â¶</a>ebpf æ›¿ä»£ iptables</h2>
<h3 id="ä»‹ç»-ä¸ç¿»è¯‘-è‡ªå·±é£Ÿç”¨â€”-ebpfå®˜ç½‘"><a class="header-anchor" href="#ä»‹ç»-ä¸ç¿»è¯‘-è‡ªå·±é£Ÿç”¨â€”-ebpfå®˜ç½‘">Â¶</a>ä»‹ç»(ä¸ç¿»è¯‘,è‡ªå·±é£Ÿç”¨â€”&gt;<a href="https://ebpf.io/">ebpfå®˜ç½‘</a>):</h3>
<blockquote>
<p>ç®€å•çš„è¯´,codeè¢«JITç¼–è¯‘æˆå­—èŠ‚ç ,é€šè¿‡æŒ‚è½½çš„æ–¹å¼,æŒ‚åˆ°å†…æ ¸æŒ‡å®šåŒºåŸŸ.</p>
</blockquote>
<blockquote>
<p>ç»“æ„å›¾:<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2023-01-31-23-16-16-0e8276bf40a642b19e21f118389b0e3d-202301312316500-6bd787.png" alt=""></p>
</blockquote>
<h3 id="ä¼˜åŠ¿-v2"><a class="header-anchor" href="#ä¼˜åŠ¿-v2">Â¶</a>ä¼˜åŠ¿:</h3>
<ul>
<li>æ€§èƒ½å¥½</li>
<li>å®‰å…¨+æ–¹ä¾¿</li>
<li>å¯ç¼–ç¨‹/å®šåˆ¶åŒ–</li>
<li>å¯è¿½è¸ªèƒ½åŠ›(probe).</li>
</ul>
<h3 id="å‰æœŸå¡ç‚¹"><a class="header-anchor" href="#å‰æœŸå¡ç‚¹">Â¶</a>å‰æœŸå¡ç‚¹:</h3>
<ul>
<li>éœ€è¦å¼€å‘è€…æœ‰ä¸€å®šçš„ç¼–ç¨‹èƒ½åŠ›</li>
<li>å¯¹å†…æ ¸éœ€è¦ä¸€å®šäº†è§£(æ¨èä¸¤ä¸ªè‘—ä½œ)
<ul>
<li><a href="https://book.douban.com/subject/2287506/">æ·±å…¥ç†è§£LINUXå†…æ ¸(ç¬¬ä¸‰ç‰ˆ)</a></li>
<li><a href="https://book.douban.com/subject/4843567/">æ·±å…¥Linuxå†…æ ¸æ¶æ„</a></li>
</ul>
</li>
</ul>
<h2 id="å¼€å‘æµç¨‹"><a class="header-anchor" href="#å¼€å‘æµç¨‹">Â¶</a>å¼€å‘æµç¨‹</h2>
<h3 id="å¼€å‘è¯­è¨€"><a class="header-anchor" href="#å¼€å‘è¯­è¨€">Â¶</a>å¼€å‘è¯­è¨€:</h3>
<blockquote>
<p>æ”¯æŒebpfçš„å³å¯[rust/go/c/c++ç­‰], è¿™é‡Œç”¨çš„æ˜¯rustå®ç°.</p>
</blockquote>
<h3 id="æ¨èåº“"><a class="header-anchor" href="#æ¨èåº“">Â¶</a>æ¨èåº“</h3>
<blockquote>
<p>éšä¾¿å“ªä¸€ä¸ªçš†å¯.</p>
</blockquote>
<ul>
<li><a href="https://github.com/aya-rs/aya">aya</a></li>
<li><a href="https://github.com/foniod/redbpf">readbpf</a></li>
</ul>
<h3 id="å¼€å‘æ¨¡ç‰ˆ"><a class="header-anchor" href="#å¼€å‘æ¨¡ç‰ˆ">Â¶</a>å¼€å‘æ¨¡ç‰ˆ:</h3>
<p>æŒ‰æ•™ç¨‹ç‰ˆæ¥,ä¸€ä¸ªç®€å•çš„bpfç¨‹åºæ²¡ä»€ä¹ˆé—®é¢˜,å¼€å‘è¿‡ç¨‹å°±ä¸è®²äº†,å®Œå…¨çœ‹ç†è§£äº†(ç½‘ç»œæ¨¡å‹/linuxå†…æ ¸/IOæ¨¡å‹/ä¸‰æ€).</p>
<blockquote>
<p>https://aya-rs.dev/book/</p>
</blockquote>
<h2 id="æ€§èƒ½å¯¹æ¯”-ç»ˆæ€"><a class="header-anchor" href="#æ€§èƒ½å¯¹æ¯”-ç»ˆæ€">Â¶</a>æ€§èƒ½å¯¹æ¯”(ç»ˆæ€)</h2>
<p>è¿™æ¬¡å®ç°åŠŸèƒ½æ¯”è¾ƒå¤š:</p>
<ul>
<li>é˜²ddos</li>
<li>é˜²syn flood</li>
<li>ç¦ç”¨icmp</li>
<li>white ip</li>
<li>disable udp/tcp/arpç­‰</li>
<li>å¼€æ”¾æŒ‡å®šç«¯å£</li>
<li>dnsé˜²æŠ•æ¯’</li>
<li>macåœ°å€å¯æ ¡éªŒ</li>
<li>æŒ‡çº¹å­¦ä¹ åŒ¹é…,é˜²sliding window attack(éœ€è¦è·‘ä¸€æ®µæ—¶é—´å­¦ä¹ æŒ‡çº¹)</li>
<li>ç­‰ç­‰(è¿˜åœ¨ç»§ç»­æ·»åŠ ä¸­)</li>
</ul>
<blockquote>
<p>è¿™é‡Œé€šè¿‡: 1ã€å¼€å¯iptables 2ã€å¼€å¯ebpf 3ã€å…³é—­æ‰€æœ‰é˜²æŠ¤(æ²¡æ„ä¹‰,è£¸å¥”æŒ¨æ‰“çš„çŠ¶æ€)<br>
ä¸»è¦æ¯”è¾ƒå‰ä¸¤ç§.</p>
</blockquote>
<h3 id="æµ‹è¯•æ–¹æ³•"><a class="header-anchor" href="#æµ‹è¯•æ–¹æ³•">Â¶</a>æµ‹è¯•æ–¹æ³•</h3>
<ul>
<li>å¼€å¯iptables,å…³é—­ebpf,ä¸¤ä¸ªæœåŠ¡å™¨(Aã€B)å¯¹CæœåŠ¡å™¨è¿›è¡Œhping3æ¨¡æ‹Ÿ.</li>
<li>å…³é—­iptables,å¼€å¯ebpf,ä¸¤ä¸ªæœåŠ¡å™¨(Aã€B)å¯¹CæœåŠ¡å™¨è¿›è¡Œhping3æ¨¡æ‹Ÿ.</li>
</ul>
<blockquote>
<p>ä¸»è¦è§‚å¯Ÿcpuå„ä¸ªçŠ¶æ€.</p>
</blockquote>
<h3 id="å¼€å¯iptables-å…³é—­ebpf"><a class="header-anchor" href="#å¼€å¯iptables-å…³é—­ebpf">Â¶</a>å¼€å¯iptables,å…³é—­ebpf</h3>
<blockquote>
<p>å·¦ä¸Šç”¨mpstatæ˜¾ç¤ºçš„cpuå’ŒIOç­‰ä¿¡æ¯.<br>
å³ä¸Šæ˜¯iptablesä»…å¼€æ”¾2022(sshç«¯å£),å…¶ä½™æ‰€æœ‰éƒ½dropæ‰.<br>
å³ä¸­æ˜¯nloadæ˜¾ç¤ºçš„å®æ—¶å¸¦å®½ä¿¡æ¯.</p>
</blockquote>
<ul>
<li>
<p>å•ä¸ªtcpæ¨¡æ‹Ÿæ”»å‡»:<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2023-02-01-00-37-16-23f522ecaf76a70ceeba2c81accd0b42-1-1-4f84e3.png" alt=""></p>
</li>
<li>
<p>ä¸¤ä¸ªtcpæ¨¡æ‹Ÿæ”»å‡»<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2023-02-01-00-38-09-98a9cabf5c0b54f9f1a307ffcf96a5cf-1-2-bff12b.png" alt=""></p>
</li>
</ul>
<blockquote>
<p>é‡è¦çš„ä¸¤ä¸ªä¿¡æ¯:</p>
</blockquote>
<table>
<thead>
<tr>
<th>attack/percent</th>
<th>cpu è½¯ä¸­æ–­</th>
<th>idle(é—²ç½®)</th>
<th>cpuå ç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•ä¸ª</td>
<td>5.9%</td>
<td>78%</td>
<td>19%</td>
</tr>
<tr>
<td>ä¸¤ä¸ª</td>
<td>14%</td>
<td>68%</td>
<td>32%</td>
</tr>
</tbody>
</table>
<h3 id="å…³é—­iptables-å¼€å¯ebpf"><a class="header-anchor" href="#å…³é—­iptables-å¼€å¯ebpf">Â¶</a>å…³é—­iptables,å¼€å¯ebpf</h3>
<ul>
<li>
<p>å•ä¸ªtcpæ¨¡æ‹Ÿæ”»å‡»:<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2023-02-01-00-38-44-bbd5d271793613f99a812c98fe0c4a4f-2-1-e1561d.png" alt=""></p>
</li>
<li>
<p>ä¸¤ä¸ªtcpæ¨¡æ‹Ÿæ”»å‡»<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2023-02-01-00-38-49-9a2d13c91dc81f6d9ef3779c33f76811-2-2-b37c75.png" alt=""></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>æ¨¡æ‹Ÿæ”»å‡»ä¸ªæ•°/ç™¾åˆ†æ¯”</th>
<th>cpu è½¯ä¸­æ–­</th>
<th>idle(é—²ç½®)</th>
<th>cpuå ç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•ä¸ª</td>
<td>1.08%</td>
<td>87%</td>
<td>15%</td>
</tr>
<tr>
<td>ä¸¤ä¸ª</td>
<td>1.16%</td>
<td>88%</td>
<td>17%</td>
</tr>
</tbody>
</table>
<h3 id="ç»“è®º"><a class="header-anchor" href="#ç»“è®º">Â¶</a>ç»“è®º</h3>
<p>å¯ä»¥çœ‹åˆ°éšç€æ¨¡æ‹Ÿæ”»å‡»serverè¶Šæ¥è¶Šå¤š,è¢«æ”»å‡»çš„æœåŠ¡å™¨cpuå ç”¨è¶Šæ¥è¶Šé«˜,ä¸­æ–­å ç”¨ä¹Ÿè¶Šæ¥è¶Šé«˜,</p>
<p>æœ€åè‚¯å®šä¼šå´©äº†.</p>
<p>å½“ç„¶ebpfè¿˜æœ‰å¾ˆå¤šç”¨å¤„,å¯ä»¥å‚è€ƒå­¦ä¹ <a href="https://arthurchiao.art/blog/bpf-advanced-notes-2-zh/#2-bpf_map_type_percpu_array">bpfè¿›é˜¶ç¬”è®°</a>å’Œ<a href="https://ebpf.io/applications">ebpfå®˜ç½‘ä¾‹å­</a>.</p>
<p>è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®,</p>
<h2 id="Reference"><a class="header-anchor" href="#Reference">Â¶</a>Reference</h2>
<ul>
<li><a href="https://www.kernel.org/doc/htmldocs/kernel-hacking/basics-softirqs.html">soft interrupt</a></li>
<li><a href="https://ebpf.io/">ebpfå®˜æ–¹</a></li>
<li><a href="https://aya-rs.dev/book/aya/aya-tool/#portability-and-different-kernel-versions">aya-rust</a></li>
<li><a href="https://www.techempower.com/benchmarks/#section=data-r21">HTTP SERVERå¤©æ¢¯æ’è¡Œæ¦œ</a></li>
<li><a href="https://wsgzao.github.io/post/mpstat/">mpstatä½¿ç”¨</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md">bccæ‰‹å†Œ</a></li>
<li><a href="https://juejin.cn/post/6993853593476399140">hping3</a></li>
<li><a href="https://www.litreily.top/2018/02/22/ddos-attack/">DDos æ”»å‡»</a></li>
<li><a href="https://www.iovisor.org/technology/xdp">iovisor: XDP</a></li>
<li><a href="https://www.cnblogs.com/poloyy/p/13435519.html">cpuè½¯ä¸­æ–­</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc1323">RFC: timestamps</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc1337.html">RFC: time_wait</a></li>
<li><a href="https://cshihong.github.io/2019/05/14/%E7%BD%91%E7%BB%9C%E5%B1%82-TCP-UDP-%E6%94%BB%E5%87%BB%E4%B8%8E%E9%98%B2%E5%BE%A1%E5%8E%9F%E7%90%86/">tcp/udpæ”»é˜²</a></li>
<li><a href="https://blog.cloudflare.com/zh-cn/how-to-drop-10-million-packets-zh-cn/">Cloudflareæ¯ç§’ä¸¢1000wä¸ªåŒ…</a></li>
<li><a href="https://rexrock.github.io/post/af_xdp1/">åšå®¢: AF_XDP</a></li>
<li><a href="https://arthurchiao.art/blog/bpf-advanced-notes-2-zh/#2-bpf_map_type_percpu_array">åšå®¢: BPFè¿›é˜¶ç¬”è®°</a></li>
<li><a href="https://github.com/DavadDi/bpf_study">Github: bpfå­¦ä¹ </a></li>
<li><a href="https://github.com/shaneutt/ebpf-rust-udp-loadbalancer-demo">Github: lb-demo</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/bpf.h?spm=a2c6h.12873639.article-detail.9.6f07275atwbfFQ&amp;file=bpf.h">Linuxæºç : bpf</a></li>
<li><a href="https://github.com/torvalds/linux/blob/22b8077d0fcec86c6ed0e0fce9f7e7e5a4c2d56a/samples/bpf/xdp_sample.bpf.h#L19">Linuxæºç : xdp_sample</a></li>
<li><a href="https://github.com/torvalds/linux/blob/22b8077d0fcec86c6ed0e0fce9f7e7e5a4c2d56a/include/uapi/linux/in.h#L37">Linuxæºç : uapi/linux/in.h</a></li>
</ul>
]]></content>
      <tags>
        <tag>æºç </tag>
        <tag>linux</tag>
        <tag>ebpf</tag>
        <tag>XDP</tag>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ64ã€RedisåŸºæœ¬ç±»å‹</title>
    <url>/archives/f7742c12.html</url>
    <content><![CDATA[<h2 id="åŸºæœ¬ç±»å‹"><a class="header-anchor" href="#åŸºæœ¬ç±»å‹">Â¶</a>åŸºæœ¬ç±»å‹</h2>
<ul>
<li>string</li>
<li>list</li>
<li>hash</li>
<li>set</li>
<li>zset</li>
</ul>
<blockquote>
<p>é•¿è¯çŸ­è¯´,è¿™é‡Œåªè¯´é‡ç‚¹éƒ¨åˆ†,ç»†èŠ‚å®ç°è¿™é‡Œä¸ç´¯èµ˜.</p>
</blockquote>
<span id="more"></span>
<h3 id="string"><a class="header-anchor" href="#string">Â¶</a>string</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2022-11-15-20-12-49-7438724996b926ca9341f6161343380f-base_string-36ccb9.png" alt=""></p>
<h3 id="list"><a class="header-anchor" href="#list">Â¶</a>list</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2022-11-15-20-12-54-8d3f285372cfa18ad57abee21ccf85b8-redis_base_list-ff378b.png" alt=""></p>
<h3 id="hash"><a class="header-anchor" href="#hash">Â¶</a>hash</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2022-11-15-20-12-54-a2dce150f971ac9f6cd83e0e45f43021-redis_base_hash-9c5eb7.png" alt=""></p>
<h3 id="zset"><a class="header-anchor" href="#zset">Â¶</a>zset</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/2022-11-15-20-12-54-1a22c49d8afa7b6e2de6d5045b8df8b0-redis_base_zset-c97a1b.png" alt=""></p>
]]></content>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Debian å‡çº§kernel</title>
    <url>/archives/2ea02468.html</url>
    <content><![CDATA[<p>å¥½ä¹…éƒ½æ²¡å‡çº§å†…æ ¸äº†ï¼Œæ¥è¯•è¯•å‡çº§ä¸‹ï¼Œå°ä¸‹æ–°ç‰¹æ€§ã€‚<br>
å½“å‰ç³»ç»Ÿï¼šDebian 11<br>
å†…æ ¸ï¼š 5.10<br>
ç›®æ ‡å†…æ ¸ï¼š 5.18ï¼ˆå½“å‰æœ€æ–°çš„ï¼‰</p>
<span id="more"></span>
<h2 id="ä¿®æ”¹æºï¼ˆå›½å¤–æœºå™¨è·³è¿‡ï¼‰"><a class="header-anchor" href="#ä¿®æ”¹æºï¼ˆå›½å¤–æœºå™¨è·³è¿‡ï¼‰">Â¶</a>ä¿®æ”¹æºï¼ˆå›½å¤–æœºå™¨è·³è¿‡ï¼‰</h2>
<blockquote>
<p>/etc/apt/source.list</p>
</blockquote>
<p><a href="https://mirrors.tuna.tsinghua.edu.cn/help/debian/">â†’ æ¸…åæº</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span><br><span class="line"> </span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span><br><span class="line"> </span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span><br><span class="line"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="æ›´æ–°æºå’Œè½¯ä»¶"><a class="header-anchor" href="#æ›´æ–°æºå’Œè½¯ä»¶">Â¶</a>æ›´æ–°æºå’Œè½¯ä»¶</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get dist-upgrade</span><br></pre></td></tr></table></figure>
<h2 id="å®‰è£…å†…æ ¸"><a class="header-anchor" href="#å®‰è£…å†…æ ¸">Â¶</a>å®‰è£…å†…æ ¸</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt -t bullseye-backports install linux-image-amd64</span><br><span class="line">apt -t bullseye-backports install linux-headers-amd64</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h3 id="ç²¾å‡†å®‰è£…"><a class="header-anchor" href="#ç²¾å‡†å®‰è£…">Â¶</a>ç²¾å‡†å®‰è£…</h3>
<p>å…ˆæ‰¾åˆ°æƒ³å®‰è£…çš„ç‰ˆæœ¬ï¼Œå†é‡å¤ã€å®‰è£…å†…æ ¸ã€‘è¿‡ç¨‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt-cache search linux-image </span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/clipboard_20220916_012249.png" alt=""></p>
<h2 id="æ•ˆæœå›¾ï¼š"><a class="header-anchor" href="#æ•ˆæœå›¾ï¼š">Â¶</a>æ•ˆæœå›¾ï¼š</h2>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/clipboard_20220916_012132.png" alt=""></p>
<h2 id="ğŸ”š"><a class="header-anchor" href="#ğŸ”š">Â¶</a>ğŸ”š</h2>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>debian</tag>
        <tag>vps</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ91ã€regex</title>
    <url>/archives/ff6a07f.html</url>
    <content><![CDATA[<h3 id="åœºæ™¯ï¼švscode"><a class="header-anchor" href="#åœºæ™¯ï¼švscode">Â¶</a>åœºæ™¯ï¼švscode</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æœç´¢ç©ºç™½ï¼š</span><br><span class="line">^\s*(?=\r?$)\n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åˆ é™¤æŸäº›å­—ç¬¦æ‰€åœ¨çš„è¡Œï¼š</span><br><span class="line">^.*(string1|string2|string3).*\n</span><br></pre></td></tr></table></figure>
<h3 id="Linux"><a class="header-anchor" href="#Linux">Â¶</a>Linux</h3>
<h4 id="åˆ é™¤æ–‡æœ¬ä¸­çš„ç©ºè¡Œ"><a class="header-anchor" href="#åˆ é™¤æ–‡æœ¬ä¸­çš„ç©ºè¡Œ">Â¶</a>åˆ é™¤æ–‡æœ¬ä¸­çš„ç©ºè¡Œ</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grepå®ç°:</span><br><span class="line"></span><br><span class="line">grep -v &#x27;^\s*$&#x27; test.txt</span><br></pre></td></tr></table></figure>
<h3 id="awk"><a class="header-anchor" href="#awk">Â¶</a>awk</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€æ±‚å’Œ</span><br><span class="line"></span><br><span class="line">cat data|awk &#x27;&#123;sum+=$1&#125; END &#123;print &quot;Sum = &quot;, sum&#125;&#x27;</span><br><span class="line"></span><br><span class="line">2ã€æ±‚å¹³å‡</span><br><span class="line"></span><br><span class="line">cat data|awk &#x27;&#123;sum+=$1&#125; END &#123;print &quot;Average = &quot;, sum/NR&#125;&#x27;</span><br><span class="line"></span><br><span class="line">3ã€æ±‚æœ€å¤§å€¼</span><br><span class="line"></span><br><span class="line">cat data|awk &#x27;BEGIN &#123;max = 0&#125; &#123;if ($1&gt;max) max=$1 fi&#125; END &#123;print &quot;Max=&quot;, max&#125;&#x27;</span><br><span class="line"></span><br><span class="line">4ã€æ±‚æœ€å°å€¼ï¼ˆminçš„åˆå§‹å€¼è®¾ç½®ä¸€ä¸ªè¶…å¤§æ•°å³å¯ï¼‰</span><br><span class="line"></span><br><span class="line">awk &#x27;BEGIN &#123;min = 1999999&#125; &#123;if ($1&lt;min) min=$1 fi&#125; END &#123;print &quot;Min=&quot;, min&#125;&#x27;</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>ã€Œ90ã€kubebuilder</title>
    <url>/archives/675841d.html</url>
    <content><![CDATA[<p>ä½œä¸ºk8s å®˜æ–¹æä¾›çš„æ‰©å±•èƒ½åŠ›ï¼Œä»‹ç»çš„å°±ä¸å¤šè¯´äº†ï¼Œçœ‹è¿™é‡Œ <a href="https://book.kubebuilder.io/quick-start.html"> â˜ Kubebuilder Quick Start</a></p>
<p>å¼€å¹²å§ï¼š</p>
<span id="more"></span>
<h3 id="ä¾èµ–"><a class="header-anchor" href="#ä¾èµ–">Â¶</a>ä¾èµ–</h3>
<h3 id="init-projectåˆå§‹åŒ–"><a class="header-anchor" href="#init-projectåˆå§‹åŒ–">Â¶</a>init projectåˆå§‹åŒ–</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">mkdir project</span><br><span class="line"></span><br><span class="line">cd project</span><br><span class="line"></span><br><span class="line">kubebuilder init --domain imrcrab.com --repo github.com/crab21/k8s-op --skip-<span class="keyword">go</span>-version-check</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®Œæˆåå°±å¯ä»¥çœ‹åˆ°è¿™æ ·çš„ç›®å½•ç»“æ„{å¯èƒ½åç»­ç‰ˆæœ¬å˜åŒ–ï¼Œç»“æ„ä¹Ÿä¼šå˜åŒ–}ï¼š</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># tree -L 10</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ default</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ manager<span class="emphasis">_auth_</span>proxy<span class="emphasis">_patch.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â””â”€â”€ manager_</span>config<span class="emphasis">_patch.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”œâ”€â”€ manager</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ controller_</span>manager<span class="emphasis">_config.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â””â”€â”€ manager.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”œâ”€â”€ prometheus</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â””â”€â”€ monitor.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â””â”€â”€ rbac</span></span><br><span class="line"><span class="emphasis">â”‚       â”œâ”€â”€ auth_</span>proxy<span class="emphasis">_client_</span>clusterrole.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ auth<span class="emphasis">_proxy_</span>role<span class="emphasis">_binding.yaml</span></span><br><span class="line"><span class="emphasis">â”‚       â”œâ”€â”€ auth_</span>proxy<span class="emphasis">_role.yaml</span></span><br><span class="line"><span class="emphasis">â”‚       â”œâ”€â”€ auth_</span>proxy<span class="emphasis">_service.yaml</span></span><br><span class="line"><span class="emphasis">â”‚       â”œâ”€â”€ kustomization.yaml</span></span><br><span class="line"><span class="emphasis">â”‚       â”œâ”€â”€ leader_</span>election<span class="emphasis">_role_</span>binding.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ leader<span class="emphasis">_election_</span>role.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ role<span class="emphasis">_binding.yaml</span></span><br><span class="line"><span class="emphasis">â”‚       â””â”€â”€ service_</span>account.yaml</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚   â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â””â”€â”€ PROJECT</span><br><span class="line"></span><br><span class="line">6 directories, 24 files</span><br></pre></td></tr></table></figure>
<h3 id="create-API"><a class="header-anchor" href="#create-API">Â¶</a>create API</h3>
<blockquote>
<p>åˆ›å»ºä¸€ä¸ªg: batch     v:v1    kind: CronJobçš„API</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">kubebuilder create api --group batch --version v1 --kind CronJob</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®Œæˆåçš„ç›®å½•ç»“æ„{å¯èƒ½ä¼šéšç‰ˆæœ¬å˜åŒ–è€Œå˜åŒ–}</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">â”€# tree -L 10</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ api</span><br><span class="line">â”‚   â””â”€â”€ v1</span><br><span class="line">â”‚       â”œâ”€â”€ cronjob<span class="emphasis">_types.go</span></span><br><span class="line"><span class="emphasis">â”‚       â”œâ”€â”€ groupversion_</span>info.go</span><br><span class="line">â”‚       â””â”€â”€ zz<span class="emphasis">_generated.deepcopy.go</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ bin</span></span><br><span class="line"><span class="emphasis">â”‚   â””â”€â”€ controller-gen</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ config</span></span><br><span class="line"><span class="emphasis">â”‚   â”œâ”€â”€ crd</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ kustomizeconfig.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â””â”€â”€ patches</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚       â”œâ”€â”€ cainjection_</span>in<span class="emphasis">_cronjobs.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚       â””â”€â”€ webhook_</span>in<span class="emphasis">_cronjobs.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”œâ”€â”€ default</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ manager_</span>auth<span class="emphasis">_proxy_</span>patch.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager<span class="emphasis">_config_</span>patch.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ manager</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ controller<span class="emphasis">_manager_</span>config.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ manager.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ prometheus</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ rbac</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ auth<span class="emphasis">_proxy_</span>client<span class="emphasis">_clusterrole.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ auth_</span>proxy<span class="emphasis">_role_</span>binding.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ auth<span class="emphasis">_proxy_</span>role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ auth<span class="emphasis">_proxy_</span>service.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ cronjob<span class="emphasis">_editor_</span>role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ cronjob<span class="emphasis">_viewer_</span>role.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ leader<span class="emphasis">_election_</span>role<span class="emphasis">_binding.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ leader_</span>election<span class="emphasis">_role.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â”‚   â”œâ”€â”€ role_</span>binding.yaml</span><br><span class="line">â”‚   â”‚   â””â”€â”€ service<span class="emphasis">_account.yaml</span></span><br><span class="line"><span class="emphasis">â”‚   â””â”€â”€ samples</span></span><br><span class="line"><span class="emphasis">â”‚       â””â”€â”€ batch_</span>v1<span class="emphasis">_cronjob.yaml</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ controllers</span></span><br><span class="line"><span class="emphasis">â”‚   â”œâ”€â”€ cronjob_</span>controller.go</span><br><span class="line">â”‚   â””â”€â”€ suite<span class="emphasis">_test.go</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ Dockerfile</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ go.mod</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ go.sum</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ hack</span></span><br><span class="line"><span class="emphasis">â”‚   â””â”€â”€ boilerplate.go.txt</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ main.go</span></span><br><span class="line"><span class="emphasis">â”œâ”€â”€ Makefile</span></span><br><span class="line"><span class="emphasis">â””â”€â”€ PROJECT</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">13 directories, 37 files</span></span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>k8s</tag>
        <tag>operator</tag>
        <tag>kubebuilder</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ84ã€tcpdump &amp; wireshark</title>
    <url>/archives/a4b12394.html</url>
    <content><![CDATA[<p><a href="https://zh.wikipedia.org/wiki/Tcpdump">â˜ tcpdumpï¼š</a>å‘½ä»¤è¡Œä¸‹çš„è½¬åŒ…å·¥å…·ã€‚</p>
<span id="more"></span>
<h3 id="å®˜æ–¹å®šä¹‰"><a class="header-anchor" href="#å®˜æ–¹å®šä¹‰">Â¶</a>å®˜æ–¹å®šä¹‰</h3>
<p><a href="https://www.tcpdump.org/">â†’ tcpdumpå®˜ç½‘</a></p>
<h3 id="ä½¿ç”¨åœºæ™¯"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯">Â¶</a>ä½¿ç”¨åœºæ™¯</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"># -s æ•°æ®åŒ…çš„å¤§å° portä»£è¡¨ç«¯å£</span><br><span class="line">tcpdump  -s <span class="number">0</span> port <span class="number">443</span></span><br><span class="line"></span><br><span class="line">tcpdump -vvv -i eth0 </span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/clipboard_20220203_061422.png" alt=""><br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/clipboard_20220203_062657.png" alt=""><br>
â€¦<br>
â€¦<br>
â€¦</p>
<ul>
<li>æŸ¥çœ‹ç«¯å£æµé‡</li>
<li>æŠ“å–æŒ‡å®šç«¯å£æ•°æ®åŒ…ï¼Œå¯ç”¨wiresharkåˆ†æ</li>
<li>icmp/tcp/udpç­‰æŠ“åŒ…åˆ†æ</li>
<li>â€¦</li>
</ul>
<h3 id="åŸºæœ¬ç”¨æ³•"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•">Â¶</a>åŸºæœ¬ç”¨æ³•</h3>
<h4 id="helpç”¨æ³•"><a class="header-anchor" href="#helpç”¨æ³•">Â¶</a>helpç”¨æ³•</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@VM-4-8-debian:~# tcpdump --help</span><br><span class="line">tcpdump version 4.99.0</span><br><span class="line">libpcap version 1.10.0 (with TPACKET_V3)</span><br><span class="line">OpenSSL 1.1.1k  25 Mar 2021</span><br><span class="line">Usage: tcpdump [-AbdDefhHIJKlLnNOpqStuUvxX#] [ -B size ] [ -c count ] [--count]</span><br><span class="line">		[ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]</span><br><span class="line">		[ -i interface ] [ --immediate-mode ] [ -j tstamptype ]</span><br><span class="line">		[ -M secret ] [ --number ] [ --print ] [ -Q in|out|inout ]</span><br><span class="line">		[ -r file ] [ -s snaplen ] [ -T type ] [ --version ]</span><br><span class="line">		[ -V file ] [ -w file ] [ -W filecount ] [ -y datalinktype ]</span><br><span class="line">		[ --time-stamp-precision precision ] [ --micro ] [ --nano ]</span><br><span class="line">		[ -z postrotate-command ] [ -Z user ] [ expression ]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™ä¹ˆå¤šçš„ç”¨æ³•ï¼Œä¸å¯èƒ½ä¸€ä¸ªä¸ªè¯´ï¼Œå¯ä»¥è§åçŸ¥æ„çš„å°±ä¸è§£é‡Šäº†ã€‚</p>
</blockquote>
<p>è¿™é‡Œæœ‰å…¨éƒ¨çš„å‘½ä»¤è¡Œç”¨æ³•ï¼š</p>
<p><a href="https://packetlife.net/media/library/12/tcpdump.pdf">âš¡ï¸ tcpdump library</a></p>
<h4 id="å¸¸è§ä½¿ç”¨"><a class="header-anchor" href="#å¸¸è§ä½¿ç”¨">Â¶</a>å¸¸è§ä½¿ç”¨</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># -e æ‰“å°header</span><br><span class="line">tcpdump -e -i eth0  </span><br><span class="line"></span><br><span class="line"># tcp-ackç±»å‹çš„</span><br><span class="line">tcpdump -vv &#x27;tcp-ack!=0&#x27; </span><br></pre></td></tr></table></figure>
<h4 id="é«˜é˜¶ç”¨æ³•"><a class="header-anchor" href="#é«˜é˜¶ç”¨æ³•">Â¶</a>é«˜é˜¶ç”¨æ³•</h4>
<p><a href="https://blog.wains.be/2007/2007-10-01-tcpdump-advanced-filters/">â˜ tcpdump advanced</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">root@VM-4-8-debian:~# tcpdump -vv &#x27;tcp-ack!=0&#x27;</span><br><span class="line">tcpdump: listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class="line">18:47:10.998761 IP (tos 0x10, ttl 64, id 23027, offset 0, flags [DF], proto TCP (6), length 164)</span><br><span class="line"></span><br><span class="line">    10.0.4.8.ssh &gt; 111.18.5.47.8452: Flags [P.], cksum 0x82df (incorrect -&gt; 0x3eec), seq 96990242:96990366, ack 1856675240, win 83, length 124</span><br><span class="line">18:47:11.032067 IP (tos 0x64, ttl 46, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    111.18.5.47.8452 &gt; 10.0.4.8.ssh: Flags [.], cksum 0x86f1 (correct), seq 1, ack 0, win 32579, length 0</span><br><span class="line">18:47:11.043267 IP (tos 0x1c, ttl 249, id 8009, offset 0, flags [none], proto TCP (6), length 40)</span><br><span class="line">    203.205.249.190.54339 &gt; 10.0.4.8.https: Flags [.], cksum 0xa0b6 (correct), seq 252872041, ack 855940619, win 65535, length 0</span><br><span class="line">18:47:11.043320 IP (tos 0x1c, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.4.8.https &gt; 203.205.249.190.54339: Flags [R], cksum 0x353e (correct), seq 855940619, win 0, length 0</span><br><span class="line">18:47:11.053616 IP (tos 0x64, ttl 46, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    111.18.5.47.8452 &gt; 10.0.4.8.ssh: Flags [.], cksum 0x8676 (correct), seq 1, ack 124, win 32578, length 0</span><br><span class="line">18:47:11.081297 IP (tos 0x10, ttl 64, id 23028, offset 0, flags [DF], proto TCP (6), length 172)</span><br><span class="line">    10.0.4.8.ssh &gt; 111.18.5.47.8452: Flags [P.], cksum 0x82e7 (incorrect -&gt; 0x965f), seq 124:256, ack 1, win 83, length 132</span><br><span class="line">18:47:11.081595 IP (tos 0x0, ttl 64, id 12233, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    10.0.4.8.51812 &gt; 183.60.83.19.domain: [bad udp cksum 0x189b -&gt; 0xd360!] 24857+ PTR? 47.5.18.111.in-addr.arpa. (42)</span><br><span class="line">18:47:11.117741 IP (tos 0x1c, ttl 249, id 57452, offset 0, flags [none], proto TCP (6), length 40)</span><br><span class="line">    203.205.249.190.54340 &gt; 10.0.4.8.https: Flags [.], cksum 0xcd05 (correct), seq 1279984176, ack 855947195, win 65535, length 0</span><br><span class="line">18:47:11.117792 IP (tos 0x1c, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.4.8.https &gt; 203.205.249.190.54340: Flags [R], cksum 0x1b8d (correct), seq 855947195, win 0, length 0</span><br><span class="line">18:47:11.138039 IP (tos 0x64, ttl 46, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    111.18.5.47.8452 &gt; 10.0.4.8.ssh: Flags [.], cksum 0x85f3 (correct), seq 1, ack 256, win 32577, length 0</span><br><span class="line">18:47:11.192735 IP (tos 0x1c, ttl 249, id 22872, offset 0, flags [none], proto TCP (6), length 40)</span><br><span class="line">    203.205.249.190.54341 &gt; 10.0.4.8.https: Flags [.], cksum 0x94a7 (correct), seq 1967847389, ack 855953771, win 65535, length 0</span><br><span class="line">18:47:11.192787 IP (tos 0x1c, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.4.8.https &gt; 203.205.249.190.54341: Flags [R], cksum 0x01dc (correct), seq 855953771, win 0, length 0</span><br><span class="line">18:47:11.268178 IP (tos 0x1c, ttl 249, id 1432, offset 0, flags [none], proto TCP (6), length 40)</span><br><span class="line">    203.205.249.190.54342 &gt; 10.0.4.8.https: Flags [.], cksum 0x7592 (correct), seq 1082733059, ack 855960347, win 65535, length 0</span><br><span class="line">18:47:11.268235 IP (tos 0x1c, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.4.8.https &gt; 203.205.249.190.54342: Flags [R], cksum 0xe82a (correct), seq 855960347, win 0, length 0</span><br><span class="line">18:47:11.342841 IP (tos 0x1c, ttl 249, id 3667, offset 0, flags [none], proto TCP (6), length 40)</span><br><span class="line">    203.205.249.190.54343 &gt; 10.0.4.8.https: Flags [.], cksum 0x39c7 (correct), seq 1302021899, ack 855966923, win 65535, length 0</span><br><span class="line">18:47:11.342894 IP (tos 0x1c, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.4.8.https &gt; 203.205.249.190.54343: Flags [R], cksum 0xce79 (correct), seq 855966923, win 0, length 0</span><br><span class="line">18:47:11.416171 IP (tos 0x1c, ttl 249, id 17285, offset 0, flags [none], proto TCP (6), length 40)</span><br><span class="line">    203.205.249.190.54344 &gt; 10.0.4.8.https: Flags [.], cksum 0x9d47 (correct), seq 473889590, ack 855973499, win 65535, length 0</span><br><span class="line">18:47:11.416224 IP (tos 0x1c, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.4.8.https &gt; 203.205.249.190.54344: Flags [R], cksum 0xb4c8 (correct), seq 855973499, win 0, length 0</span><br><span class="line">18:47:12.184512 IP (tos 0x60, ttl 247, id 56471, offset 0, flags [none], proto TCP (6), length 40)</span><br><span class="line">    203.205.159.40.42283 &gt; 10.0.4.8.https: Flags [.], cksum 0x9787 (correct), seq 2042582601, ack 1236197041, win 65535, length 0</span><br><span class="line">18:47:12.184583 IP (tos 0x60, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 40)</span><br><span class="line">    10.0.4.8.https &gt; 203.205.159.40.42283: Flags [R], cksum 0x679c (correct), seq 1236197041, win 0, length 0</span><br><span class="line">18:47:12.400485 IP (tos 0x0, ttl 64, id 37593, offset 0, flags [DF], proto TCP (6), length 108)</span><br><span class="line">^C    10.0.4.8.ssh &gt; 157.245.69.244.56074: Flags [P.], cksum 0xf24f (incorrect -&gt; 0x79f5), seq 397565160:397565228, ack 201251358, win 84, length 68</span><br><span class="line"></span><br><span class="line">21 packets captured</span><br><span class="line">1061 packets received by filter</span><br><span class="line">961 packets dropped by kernel</span><br></pre></td></tr></table></figure>
<h5 id="ç”¨æ³•æ¥æºï¼š"><a class="header-anchor" href="#ç”¨æ³•æ¥æºï¼š">Â¶</a>ç”¨æ³•æ¥æºï¼š</h5>
<blockquote>
<p>æŒ‰ç…§tcpä¸­åˆ’åˆ†çš„å­—èŠ‚ä½æ¥åˆ’åˆ†</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/clipboard_20220203_065122.png" alt=""></p>
<h4 id="å¯¼å‡ºwiresharkåŒ…ï¼š"><a class="header-anchor" href="#å¯¼å‡ºwiresharkåŒ…ï¼š">Â¶</a>å¯¼å‡ºwiresharkåŒ…ï¼š</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump -i eth0 -w test.cap/test.pcap</span><br></pre></td></tr></table></figure>
<p>å¯¼å‡ºåå¯ä»¥ç›´æ¥ç”¨wiresharkæ‰“å¼€ï¼ŒæŸ¥çœ‹å…·ä½“æƒ…å†µï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/clipboard_20220203_065536.png" alt=""></p>
<h3 id="Reference"><a class="header-anchor" href="#Reference">Â¶</a>Reference</h3>
<ul>
<li><a href="https://www.tcpdump.org/index.html#documentation">â†’ tcpdump official</a></li>
<li><a href="https://wizardzines.com/zines/tcpdump/">â†’ tcpdump learn</a></li>
<li><a href="https://blog.wains.be/2007/2007-10-01-tcpdump-advanced-filters/">â†’ tcpdump cheat sheet</a></li>
<li><a href="https://blog.wains.be/2007/2007-10-01-tcpdump-advanced-filters/">â†’ tcpdump advanced filters</a></li>
</ul>
]]></content>
      <tags>
        <tag>å·¥å…·</tag>
        <tag>ç½‘ç»œ</tag>
        <tag>æŠ“åŒ…</tag>
        <tag>tcpdump</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ83ã€mysqlå°è®°</title>
    <url>/archives/b09eedc6.html</url>
    <content><![CDATA[<p>MySQLå¸¸è§çš„é—®é¢˜ï¼š</p>
<ul>
<li>
<p>select</p>
<ul>
<li>group byã€order byã€having ã€ joinç­‰æ‰§è¡Œé¡ºåº</li>
<li>å…³äº_rowidéšè—åˆ—</li>
<li>group byç”¨æ³•</li>
</ul>
</li>
<li>
<p>MMVC</p>
<ul>
<li>è§£å†³çš„é—®é¢˜</li>
</ul>
</li>
<li>
<p>è¯¯åŒº</p>
<ul>
<li>group byå’Œhaving</li>
</ul>
</li>
<li>
<p>ç´¢å¼•ä¸å‘½ä¸­æƒ…å†µ</p>
</li>
<li>
<p>æ•ˆç‡é—®é¢˜</p>
<ul>
<li>inåé¢æ¥å¤§é‡æ•°æ®æ•ˆç‡ä½é—®é¢˜</li>
</ul>
</li>
<li>
<p>â€¦</p>
</li>
</ul>
<span id="more"></span>
<h3 id="select-é—®é¢˜"><a class="header-anchor" href="#select-é—®é¢˜">Â¶</a>select é—®é¢˜</h3>
<h4 id="group-byã€order-byã€having-ã€-joinç­‰æ‰§è¡Œé¡ºåº"><a class="header-anchor" href="#group-byã€order-byã€having-ã€-joinç­‰æ‰§è¡Œé¡ºåº">Â¶</a>group byã€order byã€having ã€ joinç­‰æ‰§è¡Œé¡ºåº</h4>
<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/select.html">æ‘˜æŠ„è‡ªMySQL â˜ 13.2.10 SELECT Statement</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    [<span class="keyword">ALL</span> <span class="operator">|</span> <span class="keyword">DISTINCT</span> <span class="operator">|</span> DISTINCTROW ]</span><br><span class="line">    [HIGH_PRIORITY]</span><br><span class="line">    [STRAIGHT_JOIN]</span><br><span class="line">    [SQL_SMALL_RESULT] [SQL_BIG_RESULT] [SQL_BUFFER_RESULT]</span><br><span class="line">    [SQL_NO_CACHE] [SQL_CALC_FOUND_ROWS]</span><br><span class="line">    select_expr [, select_expr] ...</span><br><span class="line">    [into_option]</span><br><span class="line">    [<span class="keyword">FROM</span> table_references</span><br><span class="line">      [<span class="keyword">PARTITION</span> partition_list]]</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name <span class="operator">|</span> expr <span class="operator">|</span> position&#125;, ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</span><br><span class="line">    [<span class="keyword">HAVING</span> where_condition]</span><br><span class="line">    [<span class="keyword">WINDOW</span> window_name <span class="keyword">AS</span> (window_spec)</span><br><span class="line">        [, window_name <span class="keyword">AS</span> (window_spec)] ...]</span><br><span class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name <span class="operator">|</span> expr <span class="operator">|</span> position&#125;</span><br><span class="line">      [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>], ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</span><br><span class="line">    [LIMIT &#123;[<span class="keyword">offset</span>,] row_count <span class="operator">|</span> row_count <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</span><br><span class="line">    [into_option]</span><br><span class="line">    [<span class="keyword">FOR</span> &#123;<span class="keyword">UPDATE</span> <span class="operator">|</span> SHARE&#125;</span><br><span class="line">        [<span class="keyword">OF</span> tbl_name [, tbl_name] ...]</span><br><span class="line">        [NOWAIT <span class="operator">|</span> <span class="keyword">SKIP</span> LOCKED]</span><br><span class="line">      <span class="operator">|</span> LOCK <span class="keyword">IN</span> SHARE MODE]</span><br><span class="line">    [into_option]</span><br><span class="line"></span><br><span class="line">into_option: &#123;</span><br><span class="line">    <span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;file_name&#x27;</span></span><br><span class="line">        [<span class="type">CHARACTER</span> <span class="keyword">SET</span> charset_name]</span><br><span class="line">        export_options</span><br><span class="line">  <span class="operator">|</span> <span class="keyword">INTO</span> DUMPFILE <span class="string">&#x27;file_name&#x27;</span></span><br><span class="line">  <span class="operator">|</span> <span class="keyword">INTO</span> var_name [, var_name] ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªçœ‹çœ‹è‡ªç„¶æ˜ç™½ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. å…ˆè¿æ¥fromåçš„æ•°æ®æº(è‹¥æœ‰joinï¼Œåˆ™å…ˆæ‰§è¡Œonåæ¡ä»¶ï¼Œå†è¿æ¥æ•°æ®æº)ã€‚</span><br><span class="line">2. æ‰§è¡Œwhereæ¡ä»¶</span><br><span class="line">3. æ‰§è¡Œgroup by</span><br><span class="line">4. æ‰§è¡Œhaving</span><br><span class="line">5. æ‰§è¡Œorder by</span><br></pre></td></tr></table></figure>
<h4 id="å…³äº-rowidéšè—åˆ—"><a class="header-anchor" href="#å…³äº-rowidéšè—åˆ—">Â¶</a>å…³äº_rowidéšè—åˆ—</h4>
<p>åŒæ ·çš„ï¼Œå…ˆçœ‹<a href="https://dev.mysql.com/doc/refman/8.0/en/create-table.html">â˜å®˜æ–¹èµ„æ–™</a></p>
<blockquote>
<p>ä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
</blockquote>
<blockquote>
<p>If a table has a PRIMARY KEY or UNIQUE NOT NULL index that consists of a single column that has an integer type, you can use _rowid to refer to the indexed column in SELECT statements, as described in <a href="https://dev.mysql.com/doc/refman/8.0/en/create-index.html#create-index-unique">Unique Indexes</a>.</p>
</blockquote>
<h4 id="group-byç”¨æ³•"><a class="header-anchor" href="#group-byç”¨æ³•">Â¶</a>group byç”¨æ³•</h4>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/group-by-handling.html">å®˜æ–¹èµ„æ–™: â˜ GROUP BY</a></p>
<p>æ³¨æ„ç‚¹ï¼š</p>
<blockquote>
<p>Before 5.7.5, MySQL does not detect functional dependency and ONLY_FULL_GROUP_BY is not enabled by default. For a description of pre-5.7.5 behavior, see the MySQL <a href="https://dev.mysql.com/doc/refman/5.6/en/sql-mode.html">5.6 Reference Manual</a>.</p>
</blockquote>
<h3 id="MMVCé—®é¢˜"><a class="header-anchor" href="#MMVCé—®é¢˜">Â¶</a>MMVCé—®é¢˜</h3>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html">â˜å®˜æ–¹èµ„æ–™</a></p>
<p>è¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šäº†ï¼Œå°±æ˜¯ä¸ªé€»è¾‘+é”çš„å®ç°ã€‚</p>
<h3 id="ä½¿ç”¨è¯¯åŒº"><a class="header-anchor" href="#ä½¿ç”¨è¯¯åŒº">Â¶</a>ä½¿ç”¨è¯¯åŒº</h3>
<h4 id="group-byå’Œhaving"><a class="header-anchor" href="#group-byå’Œhaving">Â¶</a>group byå’Œhaving</h4>
<p>group by å’Œhavingçš„é¡ºåºå°é—®é¢˜ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/clipboard_20220129_060235.png" alt=""></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,_rowid <span class="keyword">from</span> test.table_name <span class="keyword">having</span>  id<span class="operator">&gt;</span><span class="number">2</span> <span class="keyword">group</span> <span class="keyword">by</span>  id; â</span><br><span class="line"><span class="keyword">select</span> id,name,_rowid <span class="keyword">from</span> test.table_name  <span class="keyword">group</span> <span class="keyword">by</span>  id <span class="keyword">where</span>  id<span class="operator">&gt;</span><span class="number">2</span>; âˆš</span><br><span class="line"><span class="keyword">select</span> id,name,_rowid <span class="keyword">from</span> test.table_name <span class="keyword">where</span>  id<span class="operator">&gt;</span><span class="number">2</span> <span class="keyword">group</span> <span class="keyword">by</span>  id;  âˆš</span><br></pre></td></tr></table></figure>
<h3 id="ç´¢å¼•ä¸å‘½ä¸­æƒ…å†µ"><a class="header-anchor" href="#ç´¢å¼•ä¸å‘½ä¸­æƒ…å†µ">Â¶</a>ç´¢å¼•ä¸å‘½ä¸­æƒ…å†µ</h3>
<h3 id="æ•ˆç‡é—®é¢˜"><a class="header-anchor" href="#æ•ˆç‡é—®é¢˜">Â¶</a>æ•ˆç‡é—®é¢˜</h3>
<h4 id="IN-å’Œ-Exists"><a class="header-anchor" href="#IN-å’Œ-Exists">Â¶</a>IN å’Œ Exists</h4>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/comparison-operators.html#operator_in">IN</a><br>
<a href="https://dev.mysql.com/doc/refman/8.0/en/exists-and-not-exists-subqueries.html">EXISTS</a></p>
<p>çœ‹å®Œæ€»ç»“ä¸‹ï¼š<br>
inï¼šéœ€è¦éå†åé¢çš„æ•°æ®<br>
exists: éœ€è¦æŸ¥è¯¢æ•°æ®åº“</p>
<p>select * from A where id in(select id from B)<br>
select * from A where exists (select 1 from B where A.id=B.id);</p>
<p>Bè¡¨æ•°æ®å¤§ï¼Œæ¨èç”¨existsã€‚</p>
<h3 id="å·¥å…·ä½¿ç”¨"><a class="header-anchor" href="#å·¥å…·ä½¿ç”¨">Â¶</a>å·¥å…·ä½¿ç”¨</h3>
<h3 id="Reference"><a class="header-anchor" href="#Reference">Â¶</a>Reference</h3>
<ul>
<li><a href="https://segmentfault.com/a/1190000037557620">â˜› MMVC</a></li>
<li><a href="https://www.51cto.com/article/680143.html">â˜› MySQLéšè—åˆ—</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/group-by-handling.html">â˜› 12.20.3 MySQL Handling of GROUP BY</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/exists-and-not-exists-subqueries.html">â˜› 13.2.11.6 Subqueries with EXISTS or NOT EXISTS</a></li>
</ul>
]]></content>
      <tags>
        <tag>MySQL</tag>
        <tag>å°è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ82ã€openwrt æŠ˜è…¾è®°</title>
    <url>/archives/977b6995.html</url>
    <content><![CDATA[<p>æœ€è¿‘ä¹°äº†ä¸ªswitchï¼Œå› æŸäº›éœ€æ±‚ç”¨åˆ°è½¯è·¯ç”±ï¼Œsoâ€¦æ¥æŠ˜è…¾ä¸‹ã€‚</p>
<span id="more"></span>
<h3 id="openwrt-åœ°å€"><a class="header-anchor" href="#openwrt-åœ°å€">Â¶</a>openwrt åœ°å€</h3>
<p><a href="https://drive.google.com/drive/folders/1dqNUrMf9n7i3y1aSh68U5Yf44WQ3KCuh">ğŸ‘‰ğŸ¿ esir GDQç‰ˆæœ¬ :</a></p>
<p>å…·ä½“é€‰æ‹©è§ä¸‹å›¾ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/1161636220122_.pic_hd.jpg" alt=""></p>
<h3 id="é…ç½®é—®é¢˜ï¼š"><a class="header-anchor" href="#é…ç½®é—®é¢˜ï¼š">Â¶</a>é…ç½®é—®é¢˜ï¼š</h3>
<p>æˆ‘è¿™é‡Œé‡‡ç”¨dockerè·‘çš„ç¨‹åºï¼Œsoâ€¦éœ€è¦é•œåƒ<br>
å®¢æˆ·ç«¯ï¼šimrcrab/naive-client:v0.1.95<br>
æœåŠ¡ç«¯ï¼šimrcrab/naive-server:v0.2</p>
<blockquote>
<p>å…·ä½“çš„å¯ä»¥åœ¨hub.docker.comé‡Œé¢æœç´¢ã€‚</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20211107_065042.png" alt=""></p>
<h4 id="æœåŠ¡ç«¯ï¼š"><a class="header-anchor" href="#æœåŠ¡ç«¯ï¼š">Â¶</a>æœåŠ¡ç«¯ï¼š</h4>
<blockquote>
<p>è¿™é‡Œä¸å¤šè¯´ï¼Œå…·ä½“çœ‹æ•™ç¨‹ï¼š<a href="https://hub.docker.com/r/imrcrab/naive-server">Naive serveræ­å»º</a></p>
</blockquote>
<h4 id="å®¢æˆ·ç«¯ï¼š"><a class="header-anchor" href="#å®¢æˆ·ç«¯ï¼š">Â¶</a>å®¢æˆ·ç«¯ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ä¸¤æ­¥ï¼š</span><br><span class="line"><span class="number">1</span>ã€åˆ›å»ºç½‘ç»œ</span><br><span class="line"><span class="number">2</span>ã€docker run.....</span><br></pre></td></tr></table></figure>
<h5 id="ç½‘ç»œåˆ›å»ºæ–¹å¼ï¼š"><a class="header-anchor" href="#ç½‘ç»œåˆ›å»ºæ–¹å¼ï¼š">Â¶</a>ç½‘ç»œåˆ›å»ºæ–¹å¼ï¼š</h5>
<blockquote>
<p>ä¸‰æ­¥å®Œæˆï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20211107_065902.png" alt=""></p>
<h5 id="å…·ä½“å‘½ä»¤"><a class="header-anchor" href="#å…·ä½“å‘½ä»¤">Â¶</a>å…·ä½“å‘½ä»¤</h5>
<p>openwrtè£…å¥½åï¼Œç›´æ¥è·‘dockerå‘½ä»¤å³å¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">docker run -itd --restart=always --network=gogo -m <span class="number">300</span>m --kernel-memory <span class="number">310</span>m --name naive95-client -p <span class="number">10899</span>:<span class="number">10800</span> -v /etc/localtime:/etc/localtime  imrcrab/naive-client:v0<span class="number">.1</span><span class="number">.95</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œæœ‰ä¸€ç‚¹å¾ˆé‡è¦:</span><br><span class="line"><span class="code">    --networkå‚æ•°: ä»£è¡¨éœ€è¦æ¡¥æ¥çš„ç½‘ç»œ,æˆ‘è¿™é‡Œé‡‡ç”¨çš„æ˜¯ä¸Šä¸€æ­¥è‡ªå»ºçš„gogo</span></span><br></pre></td></tr></table></figure>
<h4 id="openwrtè¿æ¥"><a class="header-anchor" href="#openwrtè¿æ¥">Â¶</a>openwrtè¿æ¥</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">æ‰¾ä¸€ä¸ªå¯ä»¥sock5 proxyçš„è½¯ä»¶ï¼Œå¡«ä¸Šä¸Šé¢çš„proxy port: <span class="number">10800</span>ã€‚</span><br><span class="line"></span><br><span class="line">ç¡®è®¤å¥½å³å¯ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="ç›®å‰ç½‘ç»œå›¾ï¼š"><a class="header-anchor" href="#ç›®å‰ç½‘ç»œå›¾ï¼š">Â¶</a>ç›®å‰ç½‘ç»œå›¾ï¼š</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20211107_070906.png" alt=""></p>
<h3 id="è‡´è°¢"><a class="header-anchor" href="#è‡´è°¢">Â¶</a>è‡´è°¢</h3>
<ul>
<li><a href="https://github.com/coolsnowwolf/lede">LEDE</a></li>
<li><a href="https://github.com/esirplayground/AutoBuild-OpenWrt">esirplayground</a></li>
<li><a href="https://github.com/klzgrad/naiveproxy">Naive</a></li>
</ul>
]]></content>
      <tags>
        <tag>openwrt</tag>
        <tag>è½¯è·¯ç”±</tag>
        <tag>ç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ62ã€redis rehashè¿‡ç¨‹</title>
    <url>/archives/f733f408.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<blockquote>
<p>ä¹‹å‰æœ‰æåˆ°è¿‡<a href="https://blog.imrcrab.com/archives/68b4ef49.html#more">ğŸ‘‰ğŸ¿ redis ä¸­hashçš„ä»‹ç»</a>,å¦‚æœä¸äº†è§£å¯ä»¥å…ˆçœ‹çœ‹ çƒ­çƒ­èº«ã€‚</p>
</blockquote>
<h3 id="rehash"><a class="header-anchor" href="#rehash">Â¶</a>rehash</h3>
<h4 id="æ—¶æœºï¼š"><a class="header-anchor" href="#æ—¶æœºï¼š">Â¶</a>æ—¶æœºï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€å®šæ—¶ä»»åŠ¡ã€‚</span><br><span class="line"><span class="number">2</span>ã€å¯¹dictçš„find/<span class="built_in">delete</span>/addç­‰æ“ä½œæ—¶è§¦å‘ã€‚</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210817_115402.png" alt=""></p>
<h4 id="æºç åˆ†æï¼š"><a class="header-anchor" href="#æºç åˆ†æï¼š">Â¶</a>æºç åˆ†æï¼š</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Performs N steps of incremental rehashing. Returns 1 if there are still</span></span><br><span class="line"><span class="comment"> * keys to move from the old to the new hash table, otherwise 0 is returned.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that a rehashing step consists in moving a bucket (that may have more</span></span><br><span class="line"><span class="comment"> * than one key as we use chaining) from the old to the new hash table, however</span></span><br><span class="line"><span class="comment"> * since part of the hash table may be composed of empty spaces, it is not</span></span><br><span class="line"><span class="comment"> * guaranteed that this function will rehash even a single bucket, since it</span></span><br><span class="line"><span class="comment"> * will visit at max N*10 empty buckets in total, otherwise the amount of</span></span><br><span class="line"><span class="comment"> * work it does would be unbound and the function may block for a long time. */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">dictRehash</span><span class="params">(dict *d, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ€å¤§å¯ä»¥æ¥å—çš„ç©ºbucketæ•°é‡</span></span><br><span class="line">    <span class="type">int</span> empty_visits = n*<span class="number">10</span>; <span class="comment">/* Max number of empty buckets to visit. */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">dictIsRehashing</span>(d)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// htç¬¬ä¸€ä¸ªä½ç½®æ”¾çš„æœªrehashã€Œæ²¡æœ‰è½¬ç§»å‰ã€çš„æ•°æ®ï¼Œç¬¬äºŒä¸ªä½ç½®æ”¾çš„rehashåçš„æ•°æ®ã€‚</span></span><br><span class="line">    <span class="keyword">while</span>(n-- &amp;&amp; d-&gt;ht_used[<span class="number">0</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">        dictEntry *de, *nextde;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Note that rehashidx can&#x27;t overflow as we are sure there are more</span></span><br><span class="line"><span class="comment">         * elements because ht[0].used != 0 */</span></span><br><span class="line">         <span class="comment">// rehashidxçš„å€¼ä¸èƒ½è¶…è¿‡æœ€å¤§å€¼ï¼Œå‘ç”Ÿæº¢å‡º</span></span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">DICTHT_SIZE</span>(d-&gt;ht_size_exp[<span class="number">0</span>]) &gt; (<span class="type">unsigned</span> <span class="type">long</span>)d-&gt;rehashidx);</span><br><span class="line">        <span class="keyword">while</span>(d-&gt;ht_table[<span class="number">0</span>][d-&gt;rehashidx] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// è·³è¿‡ç©ºbucket</span></span><br><span class="line">            d-&gt;rehashidx++;</span><br><span class="line">            <span class="keyword">if</span> (--empty_visits == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å–å‡ºæ•°ç»„çš„rehashidxä¸‹æ ‡å¯¹åº”çš„å€¼ï¼Œ</span></span><br><span class="line">        de = d-&gt;ht_table[<span class="number">0</span>][d-&gt;rehashidx];</span><br><span class="line">        <span class="comment">/* Move all the keys in this bucket from the old to the new hash HT */</span></span><br><span class="line">        <span class="keyword">while</span>(de) &#123;</span><br><span class="line">            <span class="type">uint64_t</span> h;</span><br><span class="line"></span><br><span class="line">            nextde = de-&gt;next;</span><br><span class="line">            <span class="comment">/* Get the index in the new hash table */</span></span><br><span class="line">            <span class="comment">// è®¡ç®—hashå€¼</span></span><br><span class="line">            h = <span class="built_in">dictHashKey</span>(d, de-&gt;key) &amp; <span class="built_in">DICTHT_SIZE_MASK</span>(d-&gt;ht_size_exp[<span class="number">1</span>]);</span><br><span class="line">            de-&gt;next = d-&gt;ht_table[<span class="number">1</span>][h];</span><br><span class="line">            d-&gt;ht_table[<span class="number">1</span>][h] = de;</span><br><span class="line">            d-&gt;ht_used[<span class="number">0</span>]--;</span><br><span class="line">            d-&gt;ht_used[<span class="number">1</span>]++;</span><br><span class="line">            <span class="comment">// deæŒ‡å‘ä¸‹ä¸€ä¸ª</span></span><br><span class="line">            de = nextde;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠhtã€0ã€‘ç½®ç©º</span></span><br><span class="line">        d-&gt;ht_table[<span class="number">0</span>][d-&gt;rehashidx] = <span class="literal">NULL</span>;</span><br><span class="line">        d-&gt;rehashidx++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we already rehashed the whole table... */</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht_used[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// chek ht,å¹¶é‡Šæ”¾ï¼Œhtç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºç©ºï¼Œåˆ™æŠŠ ht[0] = ht[1],è¿™ä¸ªæ—¶å€™ht[1]ä¸ºç©ºï¼Œht[0]ä¸ºæ•´ä½“rehashåçš„å€¼</span></span><br><span class="line">        <span class="built_in">zfree</span>(d-&gt;ht_table[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">/* Copy the new ht onto the old one */</span></span><br><span class="line">        d-&gt;ht_table[<span class="number">0</span>] = d-&gt;ht_table[<span class="number">1</span>];</span><br><span class="line">        d-&gt;ht_used[<span class="number">0</span>] = d-&gt;ht_used[<span class="number">1</span>];</span><br><span class="line">        d-&gt;ht_size_exp[<span class="number">0</span>] = d-&gt;ht_size_exp[<span class="number">1</span>];</span><br><span class="line">        _dictReset(d, <span class="number">1</span>);</span><br><span class="line">        d-&gt;rehashidx = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* More to rehash... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="doingâ€¦"><a class="header-anchor" href="#doingâ€¦">Â¶</a>doingâ€¦</h3>
]]></content>
      <tags>
        <tag>Hash</tag>
        <tag>Redis</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>Redisæ–­ç”µæ¢å¤</title>
    <url>/archives/e9e58399.html</url>
    <content><![CDATA[<p>ç»§<a href="https://blog.imrcrab.com/archives/44b34745.html">â†’ 30ç¯‡ RDBæ•°æ®ä¿å­˜</a>çš„é—®é¢˜ï¼Œæ¥ç€è¯´æ–­ç”µæ¢å¤é—®é¢˜,<br>
å…ˆçœ‹ä¸‹ä¸»è¦ç ”ç©¶çš„æ¨¡å—ï¼š</p>
<span id="more"></span>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/redis-%E6%96%AD%E7%94%B5%E6%81%A2%E5%A4%8D-1.png" alt=""></p>
<p>è·Ÿç€æºä»£ç ï¼Œçœ‹ä¸‹å¤§æ¦‚æµç¨‹å§ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/redis%E6%96%AD%E7%94%B5%E6%81%A2%E5%A4%8D-2.png" alt=""></p>
<h2 id="å¾…æ›´"><a class="header-anchor" href="#å¾…æ›´">Â¶</a>å¾…æ›´</h2>
]]></content>
      <tags>
        <tag>Redis</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ61ã€redis hashè§£è¯»</title>
    <url>/archives/68b4ef49.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>hashåœ¨æ—¥å¸¸å¼€å‘ä¸­ä¸Šé•œé¢‘ç‡è¿˜æ˜¯æ¯”è¾ƒé«˜ï¼Œä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€javaä¸­çš„Hashmap...</span><br><span class="line">2ã€Goä¸­çš„Map...</span><br><span class="line">3ã€åˆ†å¸ƒå¼çš„èŠ‚ç‚¹åˆ†å¸ƒ...</span><br><span class="line">3ã€Redisä¸­çš„hash</span><br></pre></td></tr></table></figure>
<h3 id="å¥½å¥‡ç‚¹"><a class="header-anchor" href="#å¥½å¥‡ç‚¹">Â¶</a>å¥½å¥‡ç‚¹</h3>
<ul>
<li>Redisçš„hashç»“æ„åˆ°åº•æ˜¯æ€ä¹ˆå­˜çš„å‘¢ï¼Ÿ</li>
<li>Redis hashå¦‚æœåšåˆ°é«˜æ•ˆçš„ï¼Ÿ</li>
<li>Rehashæ“ä½œï¼Œdo what?</li>
<li>â€œXXâ€ vs htã€Œhashtableã€?Why?</li>
</ul>
<span id="more"></span>
<blockquote>
<p>ä¸€ä¸ªä¸ªæ¥çœ‹å§ï¼š</p>
</blockquote>
<h3 id="hashç»“æ„ï¼š"><a class="header-anchor" href="#hashç»“æ„ï¼š">Â¶</a>hashç»“æ„ï¼š</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dictht</span> &#123;</span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sizemask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> used;</span><br><span class="line">&#125; dictht;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">dict</span> &#123;</span><br><span class="line">    dictType *type;</span><br><span class="line">    <span class="type">void</span> *privdata;</span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    <span class="type">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="type">int16_t</span> pauserehash; <span class="comment">/* If &gt;0 rehashing is paused (&lt;0 indicates coding error) */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç”¨ä¸€å¼ å›¾æ¥æè¿°</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210817_094456.png" alt=""></p>
<h3 id="redisçš„hashä¸ºä½•é«˜æ•ˆï¼Ÿ"><a class="header-anchor" href="#redisçš„hashä¸ºä½•é«˜æ•ˆï¼Ÿ">Â¶</a>redisçš„hashä¸ºä½•é«˜æ•ˆï¼Ÿ</h3>
<blockquote>
<p>è®²é“ç†ï¼Œä¸æ˜¯æœ€é«˜æ•ˆçš„ï¼Œä½†æ˜¯é€‚åˆå¤§ä¼—åœºæ™¯ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">hset hello w <span class="number">1</span></span><br><span class="line">hset hello wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>è¿™2æ¡å‘½ä»¤åœ¨redisä¸­çš„å­˜å‚¨æ–¹å¼å†³å®šäº†æ˜¯å¦é«˜æ•ˆã€‚</p>
<p>å…¶å®Redisæä¾›äº†<a href="https://github.com/redis/redis/blob/6.2/src/server.h#L701">ğŸ‘‰ğŸ»ä¸¤ç§å­˜hashç¼–ç </a>çš„ç»“æ„ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210817_095231.png" alt=""></p>
<h4 id="ç±»å‹è½¬æ¢å…³é”®ç‚¹"><a class="header-anchor" href="#ç±»å‹è½¬æ¢å…³é”®ç‚¹">Â¶</a>ç±»å‹è½¬æ¢å…³é”®ç‚¹</h4>
<ul>
<li>hash_max_ziplist_value <a href="https://github.com/redis/redis/blob/6.2/src/t_hash.c#L47">ğŸ‘‰ğŸ¿ æºç åˆ¤æ–­</a></li>
<li>hash_max_ziplist_entries <a href="https://github.com/redis/redis/blob/6.2/src/t_hash.c#L235">ğŸ‘‰ğŸ¿ æºç åˆ¤æ–­</a></li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€çš„ï¼Œä¼šå°†hashçš„ç±»å‹ä»ziplistè½¬æ¢ä¸ºhashtableã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>ã€å½“hsetçš„valueå¤§å°è¶…è¿‡è®¾ç½®çš„ã€Œhash_max_ziplist_valueã€ï¼Œé»˜è®¤<span class="number">512</span>å­—èŠ‚. </span><br><span class="line"><span class="number">2</span>ã€å½“keyçš„ä¸ªæ•°è¶…è¿‡æŒ‡å®šä¸ªæ•°ï¼šã€Œhash_max_ziplist_entriesã€ï¼Œé»˜è®¤<span class="number">64</span>ä¸ª.</span><br></pre></td></tr></table></figure>
<h3 id="rehash"><a class="header-anchor" href="#rehash">Â¶</a>rehash</h3>
<ul>
<li>äº§ç”ŸåŸå› ï¼š</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">è´Ÿè½½å› å­ä¸åœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´å†…ï¼Œç®€å•çš„è¯´ï¼š</span><br><span class="line"><span class="number">1</span>ã€äº§ç”Ÿhashå†²çª</span><br><span class="line"><span class="number">2</span>ã€å•ä¸ªtableèŠ‚ç‚¹è¿‡é•¿æˆ–è€…åˆ†å¸ƒä¸å‡è¡¡ã€‚</span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210817_104655.png" alt=""></p>
<ul>
<li>è§¦å‘çš„æ—¶æœº</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€å®šæ—¶ä»»åŠ¡ã€‚</span><br><span class="line"><span class="number">2</span>ã€å¯¹dictçš„find/<span class="built_in">delete</span>/addç­‰æ“ä½œæ—¶è§¦å‘ã€‚</span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210817_115402.png" alt=""></p>
<blockquote>
<p>å…·ä½“rehashè¿‡ç¨‹ï¼Œåç»­ä¼šè®²åˆ°ã€‚</p>
</blockquote>
<h3 id="ZIPLIST-VS-HASHTABLE"><a class="header-anchor" href="#ZIPLIST-VS-HASHTABLE">Â¶</a>ZIPLIST VS HASHTABLE</h3>
<p>todo æ•°æ®é‡‡é›†ä¸­â€¦</p>
<p>ç†è®ºä¸Šåˆ†æï¼š</p>
<p>ZIPLIST:   getæ“ä½œæ˜¯ O(N)+1<br>
HASHTABLE: getæ“ä½œæ˜¯ O(1)</p>
]]></content>
      <tags>
        <tag>Hash</tag>
        <tag>Redis</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ60ã€wireshark usage</title>
    <url>/archives/8afe733.html</url>
    <content><![CDATA[<span id="more"></span>
<h2 id="ğŸ‘‰ğŸ¿wiresharkä»‹ç»"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿wiresharkä»‹ç»">Â¶</a><a href="https://baike.baidu.com/item/Wireshark/10876564">ğŸ‘‰ğŸ¿wiresharkä»‹ç»</a></h2>
<h2 id="Modules"><a class="header-anchor" href="#Modules">Â¶</a>Modules</h2>
<h3 id="ğŸ‘‰ğŸ‘‰HTTP"><a class="header-anchor" href="#ğŸ‘‰ğŸ‘‰HTTP">Â¶</a><a href="https://www.wireshark.org/docs/dfref/h/http.html">ğŸ‘‰ğŸ‘‰HTTP</a></h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http.request.method==GET</span><br><span class="line">http.request.method==POST</span><br><span class="line">http.response</span><br><span class="line">http.response.code</span><br><span class="line">http.request.uri</span><br><span class="line">http.request.full_uri</span><br></pre></td></tr></table></figure>
<h3 id="ğŸ‘‰ğŸ‘‰IP"><a class="header-anchor" href="#ğŸ‘‰ğŸ‘‰IP">Â¶</a><a href="https://www.wireshark.org/docs/dfref/i/ip.html">ğŸ‘‰ğŸ‘‰IP</a></h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip.addr</span><br><span class="line">ip.host</span><br><span class="line">ip.proto</span><br><span class="line">ip.version</span><br><span class="line">ip.ttl</span><br></pre></td></tr></table></figure>
<h3 id="ğŸ‘‰ğŸ‘‰TCP"><a class="header-anchor" href="#ğŸ‘‰ğŸ‘‰TCP">Â¶</a><a href="https://www.wireshark.org/docs/dfref/t/tcp.html">ğŸ‘‰ğŸ‘‰TCP</a></h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tcp.dstport</span><br><span class="line">tcp.port</span><br><span class="line">tcp.stream</span><br><span class="line">tls.alert_message</span><br><span class="line">tls.compress_certificate.algorithm</span><br></pre></td></tr></table></figure>
<h3 id="ğŸ‘‰ğŸ‘‰TLS"><a class="header-anchor" href="#ğŸ‘‰ğŸ‘‰TLS">Â¶</a><a href="https://www.wireshark.org/docs/dfref/t/tls.html">ğŸ‘‰ğŸ‘‰TLS</a></h3>
<ul>
<li>
<p><a href="https://datatracker.ietf.org/doc/html/rfc5246#appendix-A.3">ğŸ‘‰ğŸ»ğŸ‘‰ğŸ»tls.alert_message</a></p>
</li>
<li>
<p><a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.4.1">ğŸ‘‰ğŸ»ğŸ‘‰ğŸ»tls.compress_certificate.algorithm</a></p>
</li>
<li>
<p><a href="https://tlsfingerprint.io/top/versions">ğŸ‘‰ğŸ¿ğŸ‘‰ğŸ¿tls.handshake.version</a></p>
</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210720_052921.png" alt=""></p>
<h3 id="ğŸ‘‰ğŸ‘‰JSON"><a class="header-anchor" href="#ğŸ‘‰ğŸ‘‰JSON">Â¶</a><a href="https://www.wireshark.org/docs/dfref/j/json.html">ğŸ‘‰ğŸ‘‰JSON</a></h3>
<blockquote>
<p>å½“Content-Type: application/json  æ—¶å€™å¯ä»¥æŸ¥è¯¢ç›¸åº”çš„keyæˆ–è€…value</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">json.key contains &quot;xxxx&quot;</span><br><span class="line">json.value.string contains &quot;xxxxxxxxxxxxxx&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Scenes"><a class="header-anchor" href="#Scenes">Â¶</a>Scenes</h2>
<h3 id="æŠ“å–GET-POSTè¯·æ±‚"><a class="header-anchor" href="#æŠ“å–GET-POSTè¯·æ±‚">Â¶</a>æŠ“å–GET/POSTè¯·æ±‚</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get:</span><br><span class="line">tcpdump -s 0 -A -vv &#x27;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420&#x27;</span><br><span class="line"></span><br><span class="line">Post:</span><br><span class="line">tcpdump -s 0 -A -vv &#x27;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504f5354&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="HTTPè¯·æ±‚æå–"><a class="header-anchor" href="#HTTPè¯·æ±‚æå–">Â¶</a>HTTPè¯·æ±‚æå–</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€Host/Get/Postæå–ï¼š</span><br><span class="line">tcpdump -s 0 -v -n -l | grep -E &quot;POST /|GET /|Host:&quot;</span><br><span class="line"></span><br><span class="line">2ã€Cookieæå–</span><br><span class="line">tcpdump -nn -A -s0 -l | grep -E &#x27;Set-Cookie|Host:|Cookie:&#x27;</span><br><span class="line"></span><br><span class="line">3ã€User-Agentæå–</span><br><span class="line">tcpdump -nn -A -s1500 -l | grep &quot;User-Agent:&quot;</span><br></pre></td></tr></table></figure>
<h3 id="pcapæ–‡ä»¶åˆ†å‰²"><a class="header-anchor" href="#pcapæ–‡ä»¶åˆ†å‰²">Â¶</a>pcapæ–‡ä»¶åˆ†å‰²</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tcpdump  -w /tmp/capture-%H.pcap -G 3600 -C 100</span><br></pre></td></tr></table></figure>
<h2 id="æŠ“å–k8s-kubernetes-pod-æ•°æ®åŒ…"><a class="header-anchor" href="#æŠ“å–k8s-kubernetes-pod-æ•°æ®åŒ…">Â¶</a>æŠ“å–k8s/kubernetes pod æ•°æ®åŒ…</h2>
<blockquote>
<p>./sniff ns-xxx pod-name-xxxxxxxxxxxx -n -s0</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">set -euxo pipefail</span><br><span class="line"></span><br><span class="line">NAMESPACE=$&#123;1&#125;; shift</span><br><span class="line">POD=$&#123;1&#125;; shift</span><br><span class="line"></span><br><span class="line">eval &quot;$(kubectl get pod \</span><br><span class="line">    --namespace &quot;$&#123;NAMESPACE&#125;&quot; \</span><br><span class="line">    &quot;$&#123;POD&#125;&quot; \</span><br><span class="line">    --output=jsonpath=&quot;&#123;.status.containerStatuses[0].containerID&#125;&#123;\&quot;\\000\&quot;&#125;&#123;.status.hostIP&#125;&quot; \</span><br><span class="line">    | xargs -0 bash -c &#x27;printf &quot;$&#123;@&#125;&quot;&#x27; -- &#x27;CONTAINER_ID=%q\nHOST_IP=%q&#x27;)&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [[ $&#123;CONTAINER_ID&#125; == &#x27;docker://&#x27;* ]]; then</span><br><span class="line">    CONTAINER_ENGINE=docker</span><br><span class="line">    CONTAINER_ID=$&#123;CONTAINER_ID#&#x27;docker://&#x27;&#125;</span><br><span class="line">elif [[ $&#123;CONTAINER_ID&#125; == &#x27;containerd://&#x27;* ]]; then</span><br><span class="line">    CONTAINER_ENGINE=containerd</span><br><span class="line">    CONTAINER_ID=$&#123;CONTAINER_ID#&#x27;containerd://&#x27;&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ -z $(ip address | sed -n &quot;s/inet $&#123;HOST_IP&#125;\//found/p&quot;) ]]; then</span><br><span class="line">    SHELL_COMMAND=&#x27;eval ssh &quot;$&#123;HOST_IP&#125;&quot; bash -euxo pipefail -&#x27;</span><br><span class="line">else</span><br><span class="line">    SHELL_COMMAND=&#x27;source /dev/stdin&#x27;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;SHELL_COMMAND&#125; &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">PATH=\$&#123;PATH&#125;:/usr/local/bin</span><br><span class="line"></span><br><span class="line">if [[ $&#123;CONTAINER_ENGINE@Q&#125; == docker ]]; then</span><br><span class="line">    PID=\$(docker inspect --format &#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27; $&#123;CONTAINER_ID@Q&#125;)</span><br><span class="line">elif [[ $&#123;CONTAINER_ENGINE@Q&#125; == containerd ]]; then</span><br><span class="line">    PID=\$(crictl inspect --output go-template --template &#x27;&#123;&#123;.info.pid&#125;&#125;&#x27; $&#123;CONTAINER_ID@Q&#125;)</span><br><span class="line">fi</span><br><span class="line">IF_NO=\$(&lt;&quot;/proc/\$&#123;PID&#125;/root/sys/class/net/eth0/iflink&quot;)</span><br><span class="line">IF=\$(ip link | sed -n &quot;s/^\$&#123;IF_NO&#125;: \([^@]\+\).*$/\1/p&quot;)</span><br><span class="line"></span><br><span class="line">tcpdump -i &quot;\$&#123;IF&#125;&quot; $&#123;@@Q&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line"></span><br><span class="line">è®¾ç½® Bash çš„ä¸€äº›é€‰é¡¹ï¼ŒåŒ…æ‹¬ -eï¼ˆå¦‚æœå‘½ä»¤è¿”å›éé›¶çŠ¶æ€ï¼Œåˆ™ç«‹å³é€€å‡ºï¼‰ã€-uï¼ˆå¦‚æœå°è¯•ä½¿ç”¨æœªå®šä¹‰çš„å˜é‡ï¼Œåˆ™é€€å‡ºï¼‰ã€-xï¼ˆåœ¨æ‰§è¡Œå‘½ä»¤ä¹‹å‰æ‰“å°æ¯ä¸ªå‘½ä»¤ï¼‰å’Œ -o pipefailï¼ˆå¦‚æœç®¡é“ä¸­çš„ä»»ä½•å‘½ä»¤å¤±è´¥ï¼Œåˆ™é€€å‡ºï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">ä»è„šæœ¬çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸­è·å– Kubernetes å‘½åç©ºé—´ï¼Œå¹¶ä»ç¬¬äºŒä¸ªå‚æ•°ä¸­è·å– Pod çš„åç§°ã€‚</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ kubectl å‘½ä»¤è·å– Pod çš„å®¹å™¨ ID å’Œä¸»æœº IP åœ°å€ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å˜é‡ CONTAINER_ID å’Œ HOST_IP ä¸­ã€‚</span><br><span class="line"></span><br><span class="line">æ ¹æ®å®¹å™¨ ID çš„å‰ç¼€ç¡®å®šå®¹å™¨è¿è¡Œæ—¶ï¼ˆDocker è¿˜æ˜¯ containerdï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">æ£€æŸ¥ä¸»æœº IP åœ°å€æ˜¯å¦åœ¨å½“å‰ä¸»æœºä¸Šï¼Œå¹¶è®¾ç½®ä¸€ä¸ª SHELL_COMMAND å˜é‡ï¼Œè¯¥å˜é‡åŒ…å«ä¸€ä¸ª ssh å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†è¿æ¥åˆ°ä¸»æœº IP åœ°å€å¹¶åœ¨è¿œç¨‹ä¸»æœºä¸Šè¿è¡Œ Bash shellã€‚</span><br><span class="line"></span><br><span class="line">åœ¨ HEREDOC ä¸­è¿è¡Œ Bash å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä½¿ç”¨ tcpdump å‘½ä»¤æ•è·ç½‘ç»œæµé‡ã€‚è¯¥å‘½ä»¤é¦–å…ˆè·å–å®¹å™¨çš„ PIDï¼Œç„¶åä½¿ç”¨è¯¥ PID è·å–å®¹å™¨çš„ç½‘ç»œæ¥å£åç§°ã€‚æœ€åï¼Œå®ƒä½¿ç”¨ tcpdump å‘½ä»¤æ•è·æŒ‡å®šæ¥å£çš„ç½‘ç»œæµé‡ã€‚</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">bash -euxo pipefail - æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªæ–°çš„ Bash shell å¹¶è®¾ç½®ä¸€äº›é€‰é¡¹ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒè®¾ç½®äº†ä»¥ä¸‹é€‰é¡¹ï¼š</span><br><span class="line"></span><br><span class="line">-eï¼šå¦‚æœä»»ä½•å‘½ä»¤è¿”å›éé›¶çŠ¶æ€ï¼Œåˆ™ç«‹å³é€€å‡º shellã€‚</span><br><span class="line">-uï¼šå¦‚æœå°è¯•ä½¿ç”¨æœªå®šä¹‰çš„å˜é‡ï¼Œåˆ™é€€å‡º shellã€‚</span><br><span class="line">-xï¼šåœ¨æ‰§è¡Œå‘½ä»¤ä¹‹å‰æ‰“å°æ¯ä¸ªå‘½ä»¤ã€‚</span><br><span class="line">-o pipefailï¼šå¦‚æœç®¡é“ä¸­çš„ä»»ä½•å‘½ä»¤å¤±è´¥ï¼Œåˆ™é€€å‡º shellã€‚</span><br><span class="line">è¿™äº›é€‰é¡¹å¯ä»¥å¸®åŠ©åœ¨è„šæœ¬ä¸­æ•è·é”™è¯¯å¹¶æé«˜è°ƒè¯•èƒ½åŠ›ã€‚- è¡¨ç¤ºä»æ ‡å‡†è¾“å…¥è¯»å–å‘½ä»¤ï¼Œè¿™æ„å‘³ç€åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ$&#123;SHELL_COMMAND&#125; å˜é‡ä¸­çš„å‘½ä»¤å°†ä½œä¸ºæ ‡å‡†è¾“å…¥ä¼ é€’ç»™æ–°çš„ Bash shellã€‚</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">$&#123;CONTAINER_ID@Q&#125; æ˜¯ Bash shell ä¸­çš„ä¸€ç§å‚æ•°æ‰©å±•è¯­æ³•ï¼Œç”¨äºå°†å˜é‡ CONTAINER_ID çš„å€¼è½¬ä¹‰ä¸ºé€‚åˆåœ¨åŒå¼•å·ä¸­ä½¿ç”¨çš„æ ¼å¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ@Q è¡¨ç¤ºå°†å˜é‡å€¼è½¬ä¹‰ä¸ºå•å¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿å˜é‡å€¼ä¸­çš„ä»»ä½•ç‰¹æ®Šå­—ç¬¦éƒ½ä¸ä¼šè¢«è§£é‡Šä¸º shell å…ƒå­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ CONTAINER_ID çš„å€¼ä¸º docker://my-containerï¼Œ$&#123;CONTAINER_ID@Q&#125; å°†è¿”å› &#x27;docker://my-container&#x27;ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ä½¿ç”¨å˜é‡å€¼æ—¶ä¸ä¼šå‡ºç°æ„å¤–çš„è¡Œä¸ºã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="â€œTCP-segment-of-reassembled-PDUâ€"><a class="header-anchor" href="#â€œTCP-segment-of-reassembled-PDUâ€">Â¶</a>â€œTCP segment of reassembled PDUâ€</h2>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210720_040500.png" alt=""></p>
<blockquote>
<p>å…³äºè¿™ä¸ªç½‘ä¸Šæœ‰å¾ˆå¤šç§è§£é‡Šï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦å‚è€ƒ<a href="https://www.google.com.hk/search?newwindow=1&amp;lei=oHX2YOmaPMiFr7wPj76ViAg&amp;q=tcp%20segment%20of%20a%20reassembled%20pdu%E5%8E%9F%E5%9B%A0&amp;ved=2ahUKEwjp6v7iivHxAhXIwosBHQ9fBYEQsKwBKAF6BAgwEAI&amp;biw=2560&amp;bih=1253">ğŸ‘‰ğŸ¿ğŸ‘‰ğŸ¿ğŸ‘‰ğŸ¿TCP segment of reassembled PDU</a></p>
</blockquote>
<blockquote>
<p>å…³äºè¿™ä¸ªé—®é¢˜ï¼ŒæŠ“åŒ…çœ‹çœ‹ï¼Œackæ˜¯ä¸€æ ·çš„ï¼Œå½“å‰çš„next sequence numberæ˜¯ä¸‹ä¸€ä¸ªçš„sequence number.<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210720_041222.png" alt=""></p>
</blockquote>
<h2 id="æ–‡æ¡£æœç´¢"><a class="header-anchor" href="#æ–‡æ¡£æœç´¢">Â¶</a>æ–‡æ¡£æœç´¢</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://www.wireshark.org/docs/dfref/i/ip.html</span><br><span class="line"></span><br><span class="line">https://www.wireshark.org/docs/dfref/é¦–å­—æ¯/æ¨¡å—åç§°.html</span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2023/2023-03-21-22-24-33-ba663d3325437c7db78b614a272736a1-202303212224542-bfcff9.png" alt=""></p>
<h2 id="Reference"><a class="header-anchor" href="#Reference">Â¶</a>Reference</h2>
<ul>
<li>
<p><a href="https://www.wireshark.org/">â˜ wiresharkå®˜ç½‘</a></p>
</li>
<li>
<p><a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.3">â†’â†’datatracker</a></p>
</li>
<li>
<p><a href="https://techcommunity.microsoft.com/t5/iis-support-blog/ssl-tls-alert-protocol-and-the-alert-codes/ba-p/377132">â†’â†’micrsoft</a></p>
</li>
<li>
<p><a href="https://tlsfingerprint.io/top/versions">â†’â†’tls finger print</a></p>
</li>
<li>
<p><a href="https://tlsfingerprint.io/top/versions">â†’â†’tls version</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers">â†’â†’List of IP protocol numbers</a></p>
</li>
<li>
<p><a href="https://www.wireshark.org/docs/dfref/t/tls.html">ğŸ‘‰ğŸ» module: tls</a></p>
</li>
<li>
<p><a href="https://www.wireshark.org/docs/dfref/i/ip.html">ğŸ‘‰ğŸ» module: IP</a></p>
</li>
<li>
<p><a href="https://www.wireshark.org/docs/dfref/h/http.html">ğŸ‘‰ğŸ» module: HTTP</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/v1vvwv/p/Wireshark-filtering-rules.html">â˜› wireshakè¿‡æ»¤è§„åˆ™</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/d4d7ad6cc95f">â˜› wiresharkåŸºæœ¬ç”¨æ³•åŠè¿‡æ»¤è§„åˆ™</a></p>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>ã€Œ57ã€ç®—æ³•(äºŒ) â†’ é“¾è¡¨</title>
    <url>/archives/afe7994b.html</url>
    <content><![CDATA[<ul>
<li>åè½¬å•å‘é“¾è¡¨
<ul>
<li>åè½¬å•å‘é“¾è¡¨çš„[N,M]</li>
</ul>
</li>
<li>åˆ é™¤é“¾è¡¨é‡å¤å…ƒç´ </li>
<li>åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨</li>
<li>æ—‹è½¬é“¾è¡¨</li>
<li>æ’åºé“¾è¡¨</li>
<li>ä¸¤æ•°ç›¸åŠ <br>
â€¦</li>
</ul>
<span id="more"></span>
<h3 id="åè½¬å•å‘é“¾è¡¨"><a class="header-anchor" href="#åè½¬å•å‘é“¾è¡¨">Â¶</a>åè½¬å•å‘é“¾è¡¨</h3>
<h4 id="è¦æ±‚"><a class="header-anchor" href="#è¦æ±‚">Â¶</a>è¦æ±‚</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ç»™ä½ å•é“¾è¡¨çš„å¤´èŠ‚ç‚¹ head ï¼Œè¯·ä½ åè½¬é“¾è¡¨ï¼Œå¹¶è¿”å›åè½¬åçš„é“¾è¡¨ã€‚</span><br><span class="line">è¾“å…¥ï¼šhead = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">è¾“å‡ºï¼š[<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<h4 id="æ€è·¯åˆ†æï¼š"><a class="header-anchor" href="#æ€è·¯åˆ†æï¼š">Â¶</a>æ€è·¯åˆ†æï¼š</h4>
<h5 id="å˜é‡æš‚å­˜æ›¿æ¢æ³•"><a class="header-anchor" href="#å˜é‡æš‚å­˜æ›¿æ¢æ³•">Â¶</a>å˜é‡æš‚å­˜æ›¿æ¢æ³•</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210528_031731.png" alt=""></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReserveList</span><span class="params">(head *ListNode)</span></span> *ListNode &#123;</span><br><span class="line">	<span class="keyword">if</span> head == <span class="literal">nil</span> || head.next == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> head</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> pre *ListNode</span><br><span class="line">	<span class="keyword">for</span> head != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// ç®€åŒ–ç‰ˆï¼š</span></span><br><span class="line">        <span class="comment">// head, head.next, pre = head.next, pre, head</span></span><br><span class="line">		nextNode := head.next</span><br><span class="line">		head.next = pre</span><br><span class="line">		pre = head</span><br><span class="line">		head = nextNode</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> pre</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="åŒå¤´æŒ‡é’ˆæ³•"><a class="header-anchor" href="#åŒå¤´æŒ‡é’ˆæ³•">Â¶</a>åŒå¤´æŒ‡é’ˆæ³•</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210528_031843.png" alt=""></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210528_031913.png" alt=""></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210528_031933.png" alt=""></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReserveList</span><span class="params">(head *ListNode)</span></span> *ListNode &#123;</span><br><span class="line">	<span class="keyword">if</span> head == <span class="literal">nil</span> || head.next == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> head</span><br><span class="line">	&#125;</span><br><span class="line">	cur := head</span><br><span class="line">	<span class="keyword">for</span> head.next != <span class="literal">nil</span> &#123;</span><br><span class="line">		tmp := head.next.next</span><br><span class="line">		head.next.next = cur</span><br><span class="line">		cur = head.next</span><br><span class="line">		head.next = tmp</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cur</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åè½¬å•å‘é“¾è¡¨å‰Nä¸ª"><a class="header-anchor" href="#åè½¬å•å‘é“¾è¡¨å‰Nä¸ª">Â¶</a>åè½¬å•å‘é“¾è¡¨å‰Nä¸ª</h3>
<h4 id="è¦æ±‚ï¼š"><a class="header-anchor" href="#è¦æ±‚ï¼š">Â¶</a>è¦æ±‚ï¼š</h4>
<h4 id="æ€è·¯ï¼š"><a class="header-anchor" href="#æ€è·¯ï¼š">Â¶</a>æ€è·¯ï¼š</h4>
<h4 id="coding"><a class="header-anchor" href="#coding">Â¶</a>coding:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> nochange *ListNode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReserveListN</span><span class="params">(head *ListNode, n <span class="type">int</span>)</span></span> *ListNode &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> n == <span class="number">1</span> &#123;</span><br><span class="line">		nochange = head.next</span><br><span class="line">		<span class="keyword">return</span> head</span><br><span class="line">	&#125;</span><br><span class="line">	last := ReserveListN(head.next, n<span class="number">-1</span>)</span><br><span class="line">	head.next.next = head</span><br><span class="line">	head.next = nochange</span><br><span class="line">	<span class="keyword">return</span> last</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åè½¬å•å‘é“¾è¡¨N-Mä¹‹é—´çš„"><a class="header-anchor" href="#åè½¬å•å‘é“¾è¡¨N-Mä¹‹é—´çš„">Â¶</a>åè½¬å•å‘é“¾è¡¨N~Mä¹‹é—´çš„</h3>
<h4 id="è¦æ±‚ï¼š-v2"><a class="header-anchor" href="#è¦æ±‚ï¼š-v2">Â¶</a>è¦æ±‚ï¼š</h4>
<h4 id="æ€è·¯ï¼š-v2"><a class="header-anchor" href="#æ€è·¯ï¼š-v2">Â¶</a>æ€è·¯ï¼š</h4>
<h4 id="coding-v2"><a class="header-anchor" href="#coding-v2">Â¶</a>coding:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¿»è½¬[N,M]èŒƒå›´å†…çš„å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReserveListNM</span><span class="params">(head *ListNode, n, m <span class="type">int</span>)</span></span> *ListNode &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> n == <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ReserveListN(head, m)</span><br><span class="line">	&#125;</span><br><span class="line">	head.next = ReserveListNM(head.next, n<span class="number">-1</span>, m<span class="number">-1</span>)</span><br><span class="line">	<span class="keyword">return</span> head</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¾…æ›´æ–°â€¦"><a class="header-anchor" href="#å¾…æ›´æ–°â€¦">Â¶</a>å¾…æ›´æ–°â€¦</h3>
]]></content>
  </entry>
  <entry>
    <title>ã€Œ56ã€List Stack Tree</title>
    <url>/archives/b0be3190.html</url>
    <content><![CDATA[<p>ç®—æ³•ç¯‡ğŸ‘‰ğŸ»[äºŒ]</p>
<h3 id="LinkedList"><a class="header-anchor" href="#LinkedList">Â¶</a>LinkedList</h3>
<h4 id="å®šä¹‰ï¼š"><a class="header-anchor" href="#å®šä¹‰ï¼š">Â¶</a>å®šä¹‰ï¼š</h4>
<p>æ˜¯é“¾è¡¨çš„ä¸€ç§ï¼Œå…¶ç‰¹ç‚¹æ˜¯é“¾è¡¨çš„è¿æ¥æ–¹å‘æ˜¯å•å‘çš„ï¼Œå¯¹é“¾è¡¨çš„è®¿é—®è¦ä»å¤´å¼€å§‹ï¼Œä¾æ¬¡å¾€ä¸‹ã€‚</p>
<h4 id="ç›¸å…³é¢˜ç›®"><a class="header-anchor" href="#ç›¸å…³é¢˜ç›®">Â¶</a>ç›¸å…³é¢˜ç›®</h4>
<ul>
<li>åè½¬å•å‘é“¾è¡¨
<ul>
<li>åè½¬å•å‘é“¾è¡¨çš„[N,M]</li>
</ul>
</li>
<li>åˆ é™¤é“¾è¡¨é‡å¤å…ƒç´ </li>
<li>åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨</li>
<li>æ—‹è½¬é“¾è¡¨</li>
<li>æ’åºé“¾è¡¨</li>
<li>ä¸¤æ•°ç›¸åŠ </li>
</ul>
<h3 id="å¾…ç»­â€¦"><a class="header-anchor" href="#å¾…ç»­â€¦">Â¶</a>å¾…ç»­â€¦</h3>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>ç®—æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ55ã€Go 1.18 pre</title>
    <url>/archives/517e6fa6.html</url>
    <content><![CDATA[<p>æœ€è¿‘çœ‹åˆ°1.18å·²ç»æä¸Šæ—¥ç¨‹äº†ï¼Œè™½ç„¶å¾ˆé¥è¿œï¼Œ<br>
ä½†è¿˜æ˜¯éœ€è¦å…³æ³¨ä¸‹æ”¹å–„ç‚¹å’Œæ–°ç‰¹æ€§ã€‚</p>
<span id="more"></span>
<h3 id="æ”¹å–„ç‚¹ï¼š"><a class="header-anchor" href="#æ”¹å–„ç‚¹ï¼š">Â¶</a>æ”¹å–„ç‚¹ï¼š</h3>
<h4 id="ğŸ‘‰ğŸ»-runtime-helloworld-net-http-asks-700MB-VSS-on-mips32"><a class="header-anchor" href="#ğŸ‘‰ğŸ»-runtime-helloworld-net-http-asks-700MB-VSS-on-mips32">Â¶</a><a href="https://github.com/golang/go/issues/43699">ğŸ‘‰ğŸ» runtime: helloworld net/http asks 700MB VSS on mips32</a></h4>
<h5 id="ç®€è¿°ï¼š"><a class="header-anchor" href="#ç®€è¿°ï¼š">Â¶</a>ç®€è¿°ï¼š</h5>
<blockquote>
<p>ä¸€ä¸ªhelloworld netç¨‹åºè·‘èµ·æ¥å VSS å ç”¨è¿‡é«˜é—®é¢˜</p>
</blockquote>
<h5 id="Depends-on"><a class="header-anchor" href="#Depends-on">Â¶</a>Depends on:</h5>
<p><a href="https://github.com/golang/go/issues/44167">proposal: runtime: GC pacer redesign</a></p>
<h4 id="ğŸ‘‰ğŸ»-runtime-10ms-26ms-latency-from-GC-in-go1-14rc1-possibly-due-to-â€˜GC-idle-â€™-work"><a class="header-anchor" href="#ğŸ‘‰ğŸ»-runtime-10ms-26ms-latency-from-GC-in-go1-14rc1-possibly-due-to-â€˜GC-idle-â€™-work">Â¶</a><a href="https://github.com/golang/go/issues/37116">ğŸ‘‰ğŸ» runtime: 10ms-26ms latency from GC in go1.14rc1, possibly due to â€˜GC (idle)â€™ work</a></h4>
<h5 id="ç®€è¿°ï¼š-v2"><a class="header-anchor" href="#ç®€è¿°ï¼š-v2">Â¶</a>ç®€è¿°ï¼š</h5>
<blockquote>
<p>gc idleç©ºé—²æ—¶é—´è¿‡é•¿é—®é¢˜</p>
</blockquote>
<h5 id="è§£å†³åŠæ³•ï¼š"><a class="header-anchor" href="#è§£å†³åŠæ³•ï¼š">Â¶</a>è§£å†³åŠæ³•ï¼š</h5>
<p><a href="https://github.com/golang/go/issues/44163">ğŸ‘‰ğŸ¿ runtime: remove idle GC workers</a><br>
<a href="https://github.com/golang/go/issues/44167">ğŸ‘‰ğŸ¿ proposal: runtime: GC pacer redesign </a></p>
<h3 id="proposal"><a class="header-anchor" href="#proposal">Â¶</a>proposal</h3>
<h4 id="ğŸ‘‰ğŸ»-GC-Redesign"><a class="header-anchor" href="#ğŸ‘‰ğŸ»-GC-Redesign">Â¶</a><a href="https://github.com/golang/proposal/blob/329650d4723a558c2b76b81b4995fc5c267e6bc1/design/44167-gc-pacer-redesign.md">ğŸ‘‰ğŸ» GC Redesign</a></h4>
<h4 id="ğŸ‘‰-runtime-pprof-NewCPUProfile-cpuProfile-Start-to-allow-profile-configuration"><a class="header-anchor" href="#ğŸ‘‰-runtime-pprof-NewCPUProfile-cpuProfile-Start-to-allow-profile-configuration">Â¶</a><a href="https://github.com/golang/go/issues/42502">ğŸ‘‰ runtime/pprof: NewCPUProfile + cpuProfile.Start to allow profile configuration</a></h4>
<h3 id="Deprecated"><a class="header-anchor" href="#Deprecated">Â¶</a>Deprecated</h3>
<h4 id="ğŸ‘‰ğŸ¿-runtime-deprecate-SetCPUProfileRate-and-replace-body-with-panic"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿-runtime-deprecate-SetCPUProfileRate-and-replace-body-with-panic">Â¶</a><a href="https://github.com/golang/go/issues/40094">ğŸ‘‰ğŸ¿ runtime: deprecate SetCPUProfileRate and replace body with panic</a></h4>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
        <tag>v1.18</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ54ã€GoSchedå‡½æ•°</title>
    <url>/archives/10a41c81.html</url>
    <content><![CDATA[<p>GoSched å¹²å˜›çš„ï¼Ÿ çœ‹çœ‹å®˜æ–¹è¯´æ˜ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210526_051405.png" alt=""></p>
<blockquote>
<p>ä¸¤ç‚¹ï¼š</p>
</blockquote>
<ul>
<li>è®©å‡ºprocessor</li>
<li>å¯ä»¥è‡ªåŠ¨æ¢å¤gï¼Œæ‰§è¡Œä¸­çš„ä»»åŠ¡</li>
</ul>
<span id="more"></span>
<h3 id="ğŸ‘‰ğŸ»-goschedImpl"><a class="header-anchor" href="#ğŸ‘‰ğŸ»-goschedImpl">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L2746">ğŸ‘‰ğŸ» goschedImpl</a></h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">goschedImpl</span><span class="params">(gp *g)</span></span> &#123;</span><br><span class="line">    <span class="comment">// è·å–gçŠ¶æ€</span></span><br><span class="line">	status := readgstatus(gp)</span><br><span class="line">	<span class="keyword">if</span> status&amp;^_Gscan != _Grunning &#123;</span><br><span class="line">        <span class="comment">// éè¿è¡Œä¸­å°±throw</span></span><br><span class="line">		dumpgstatus(gp)</span><br><span class="line">		throw(<span class="string">&quot;bad g status&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//æ”¹å˜GçŠ¶æ€</span></span><br><span class="line">	casgstatus(gp, _Grunning, _Grunnable)</span><br><span class="line">    <span class="comment">//é‡ç½®Må’ŒGçš„çŠ¶æ€</span></span><br><span class="line">	dropg()</span><br><span class="line">	lock(&amp;sched.lock)</span><br><span class="line">    <span class="comment">// å°†Gé‡æ–°æ”¾å›é˜Ÿåˆ—ä¸­</span></span><br><span class="line">	globrunqput(gp)</span><br><span class="line">	unlock(&amp;sched.lock)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­£å¸¸è°ƒåº¦</span></span><br><span class="line">	schedule()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸€ä¸ªä¸ªçœ‹çœ‹ï¼ŒGMPåˆ°åº•å¦‚æœé…åˆè°ƒåº¦çš„?</p>
</blockquote>
<h4 id="ğŸ‘‰ğŸ¿-readgstatus"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿-readgstatus">Â¶</a>ğŸ‘‰ğŸ¿ readgstatus</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// All reads and writes of g&#x27;s status go through readgstatus, casgstatus</span></span><br><span class="line"><span class="comment">// castogscanstatus, casfrom_Gscanstatus.</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readgstatus</span><span class="params">(gp *g)</span></span> <span class="type">uint32</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> atomic.Load(&amp;gp.atomicstatus)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>atomicstatuså˜é‡çš„ä½œç”¨ï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210526_052742.png" alt=""></p>
<h4 id="ğŸ‘‰ğŸ¿-casgstatus"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿-casgstatus">Â¶</a>ğŸ‘‰ğŸ¿ casgstatus</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// If asked to move to or from a Gscanstatus this will throw. Use the castogscanstatus</span></span><br><span class="line"><span class="comment">// and casfrom_Gscanstatus instead.</span></span><br><span class="line"><span class="comment">// casgstatus will loop if the g-&gt;atomicstatus is in a Gscan status until the routine that</span></span><br><span class="line"><span class="comment">// put it in the Gscan state is finished.</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">casgstatus</span><span class="params">(gp *g, oldval, newval <span class="type">uint32</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (oldval&amp;_Gscan != <span class="number">0</span>) || (newval&amp;_Gscan != <span class="number">0</span>) || oldval == newval &#123;</span><br><span class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;runtime: casgstatus: oldval=&quot;</span>, hex(oldval), <span class="string">&quot; newval=&quot;</span>, hex(newval), <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			throw(<span class="string">&quot;casgstatus: bad incoming values&quot;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// See https://golang.org/cl/21503 for justification of the yield delay.</span></span><br><span class="line">	<span class="keyword">const</span> yieldDelay = <span class="number">5</span> * <span class="number">1000</span></span><br><span class="line">	<span class="keyword">var</span> nextYield <span class="type">int64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// loop if gp-&gt;atomicstatus is in a scan state giving</span></span><br><span class="line">	<span class="comment">// GC time to finish and change the state to oldval.</span></span><br><span class="line">	<span class="comment">// ç­‰å¾…GCå®Œæˆåå˜æˆ_Grunningï¼Œç„¶åå†æ”¹å˜å€¼ï¼Œå˜ä¸º_Grunnable</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; !atomic.Cas(&amp;gp.atomicstatus, oldval, newval); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> oldval == _Gwaiting &amp;&amp; gp.atomicstatus == _Grunnable &#123;</span><br><span class="line">			throw(<span class="string">&quot;casgstatus: waiting for Gwaiting but is Grunnable&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">			nextYield = nanotime() + yieldDelay</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> nanotime() &lt; nextYield &#123;</span><br><span class="line">			<span class="keyword">for</span> x := <span class="number">0</span>; x &lt; <span class="number">10</span> &amp;&amp; gp.atomicstatus != oldval; x++ &#123;</span><br><span class="line">				procyield(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			osyield()</span><br><span class="line">			nextYield = nanotime() + yieldDelay/<span class="number">2</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ğŸ‘‰ğŸ¿-dropg"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿-dropg">Â¶</a>ğŸ‘‰ğŸ¿ dropg</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dropg removes the association between m and the current goroutine m-&gt;curg (gp for short).</span></span><br><span class="line"><span class="comment">// Typically a caller sets gp&#x27;s status away from Grunning and then</span></span><br><span class="line"><span class="comment">// immediately calls dropg to finish the job. The caller is also responsible</span></span><br><span class="line"><span class="comment">// for arranging that gp will be restarted using ready at an</span></span><br><span class="line"><span class="comment">// appropriate time. After calling dropg and arranging for gp to be</span></span><br><span class="line"><span class="comment">// readied later, the caller can do other work but eventually should</span></span><br><span class="line"><span class="comment">// call schedule to restart the scheduling of goroutines on this m.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dropg</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è§£ç»‘M</span></span><br><span class="line">	setMNoWB(&amp;_g_.m.curg.m, <span class="literal">nil</span>)</span><br><span class="line">	<span class="comment">// è§£ç»‘G</span></span><br><span class="line">	setGNoWB(&amp;_g_.m.curg, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ğŸ‘‰ğŸ¿-globrunqput"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿-globrunqput">Â¶</a>ğŸ‘‰ğŸ¿ globrunqput</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Put gp on the global runnable queue.</span></span><br><span class="line"><span class="comment">// Sched must be locked.</span></span><br><span class="line"><span class="comment">// May run during STW, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">globrunqput</span><span class="params">(gp *g)</span></span> &#123;</span><br><span class="line">	<span class="comment">//å°†Gæ”¾å›å…¨å±€é˜Ÿåˆ—ä¸­</span></span><br><span class="line">	sched.runq.pushBack(gp)</span><br><span class="line">	sched.runqsize++</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ğŸ‘‰ğŸ¿-schedule"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿-schedule">Â¶</a>ğŸ‘‰ğŸ¿ schedule</h4>
<h5 id="ä½œç”¨ï¼š"><a class="header-anchor" href="#ä½œç”¨ï¼š">Â¶</a>ä½œç”¨ï¼š</h5>
<blockquote>
<p>find a runnable goroutine and execute it.</p>
</blockquote>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ53ã€dfs bfs 01èƒŒåŒ…</title>
    <url>/archives/517092f1.html</url>
    <content><![CDATA[<p>ç®—æ³•ç¯‡ğŸ‘‰ğŸ»[ä¸€]</p>
<span id="more"></span>
<h3 id="DFSé—®é¢˜"><a class="header-anchor" href="#DFSé—®é¢˜">Â¶</a>DFSé—®é¢˜</h3>
<h4 id="æ— é‡å¤æ•°ç»„æ€»å’Œé—®é¢˜ğŸ‘‰ğŸ¿-39"><a class="header-anchor" href="#æ— é‡å¤æ•°ç»„æ€»å’Œé—®é¢˜ğŸ‘‰ğŸ¿-39">Â¶</a>æ— é‡å¤æ•°ç»„æ€»å’Œé—®é¢˜<a href="https://leetcode-cn.com/problems/combination-sum/">ğŸ‘‰ğŸ¿#39</a></h4>
<h5 id="ğŸ‘‰ğŸ¿é—®é¢˜æè¿°ï¼š-39"><a class="header-anchor" href="#ğŸ‘‰ğŸ¿é—®é¢˜æè¿°ï¼š-39">Â¶</a><a href="https://leetcode-cn.com/problems/combination-sum/">ğŸ‘‰ğŸ¿é—®é¢˜æè¿°ï¼š#39</a></h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ç»™å®šä¸€ä¸ªæ— é‡å¤å…ƒç´ çš„æ•°ç»„Â candidatesÂ å’Œä¸€ä¸ªç›®æ ‡æ•°Â targetÂ ï¼Œæ‰¾å‡ºÂ candidatesÂ ä¸­æ‰€æœ‰å¯ä»¥ä½¿æ•°å­—å’Œä¸ºÂ targetÂ çš„ç»„åˆã€‚</span><br><span class="line"></span><br><span class="line">candidatesÂ ä¸­çš„æ•°å­—å¯ä»¥æ— é™åˆ¶é‡å¤è¢«é€‰å–ã€‚</span><br><span class="line"></span><br><span class="line">è¯´æ˜ï¼š</span><br><span class="line"></span><br><span class="line">æ‰€æœ‰æ•°å­—ï¼ˆåŒ…æ‹¬Â targetï¼‰éƒ½æ˜¯æ­£æ•´æ•°ã€‚</span><br><span class="line">è§£é›†ä¸èƒ½åŒ…å«é‡å¤çš„ç»„åˆã€‚Â </span><br><span class="line">ç¤ºä¾‹Â <span class="number">1</span>ï¼š</span><br><span class="line"></span><br><span class="line">è¾“å…¥ï¼šcandidates = [<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">7</span>], target = <span class="number">7</span>,</span><br><span class="line">æ‰€æ±‚è§£é›†ä¸ºï¼š</span><br><span class="line">[</span><br><span class="line">  [<span class="number">7</span>],</span><br><span class="line">  [<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">]</span><br><span class="line">ç¤ºä¾‹Â <span class="number">2</span>ï¼š</span><br><span class="line"></span><br><span class="line">è¾“å…¥ï¼šcandidates = [<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>], target = <span class="number">8</span>,</span><br><span class="line">æ‰€æ±‚è§£é›†ä¸ºï¼š</span><br><span class="line">[</span><br><span class="line">Â  [<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>],</span><br><span class="line">Â  [<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>],</span><br><span class="line">Â  [<span class="number">3</span>,<span class="number">5</span>]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h5 id="è§£å†³æ€è·¯"><a class="header-anchor" href="#è§£å†³æ€è·¯">Â¶</a>è§£å†³æ€è·¯</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210520_113008.png" alt=""></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210520_113224.png" alt=""></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210520_113257.png" alt=""></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210520_113320.png" alt=""></p>
<h5 id="codingï¼š"><a class="header-anchor" href="#codingï¼š">Â¶</a>codingï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	n := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;</span><br><span class="line">	combineDFS(n, <span class="number">16</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res [][]<span class="type">int</span> = <span class="built_in">make</span>([][]<span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">combineDFS</span><span class="params">(num []<span class="type">int</span>, target <span class="type">int</span>)</span></span> (result [][]<span class="type">int</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(num) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dfs(target, <span class="number">0</span>, []<span class="type">int</span>&#123;&#125;, num)</span><br><span class="line">	fmt.Println(res)</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dfs</span><span class="params">(target <span class="type">int</span>, index <span class="type">int</span>, pre []<span class="type">int</span>, num []<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> target == <span class="number">0</span> &#123;</span><br><span class="line">		pp := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(pre))</span><br><span class="line">		<span class="built_in">copy</span>(pp, pre)</span><br><span class="line">		res = <span class="built_in">append</span>(res, pp)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := index; i &lt; <span class="built_in">len</span>(num); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> num[i] &gt; target &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pre = <span class="built_in">append</span>(pre, num[i])</span><br><span class="line">    <span class="comment">// i+1 åˆ™è·³è¿‡é‡å¤çš„å…ƒç´ ä½¿ç”¨çš„æƒ…å†µ</span></span><br><span class="line">		<span class="comment">//dfs(target-num[i], i+1, pre, num)</span></span><br><span class="line">		dfs(target-num[i], i, pre, num)</span><br><span class="line">		pre = pre[:<span class="built_in">len</span>(pre)<span class="number">-1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¾…ç»­â€¦"><a class="header-anchor" href="#å¾…ç»­â€¦">Â¶</a>å¾…ç»­â€¦</h3>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>ç®—æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ52ã€Mysql Top Né—®é¢˜</title>
    <url>/archives/2dfee217.html</url>
    <content><![CDATA[<h3 id="é—®é¢˜æ˜¯è¿™æ ·çš„ï¼š"><a class="header-anchor" href="#é—®é¢˜æ˜¯è¿™æ ·çš„ï¼š">Â¶</a>é—®é¢˜æ˜¯è¿™æ ·çš„ï¼š</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210519_125155.png" alt=""></p>
<blockquote>
<p>æ±‚ä¸åŒçš„ageåˆ†ç»„ï¼ŒæŒ‰ç…§createTimeæ­£åºã€Œä»å°åˆ°å¤§ã€æ’åºçš„å‰Nä¸ªã€‚</p>
</blockquote>
<span id="more"></span>
<h3 id="è§£å†³åŠæ³•ï¼š"><a class="header-anchor" href="#è§£å†³åŠæ³•ï¼š">Â¶</a>è§£å†³åŠæ³•ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">        t1.*</span><br><span class="line">    FROM</span><br><span class="line">    table_a t1</span><br><span class="line">    where (SELECT count(*) + <span class="number">1</span> FROM table_a t2 WHERE t2.age = t1.age AND t2.create_time &gt; t1.create_time ) &lt;=<span class="number">1</span> order by create_time desc</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ç»“æœï¼š"><a class="header-anchor" href="#ç»“æœï¼š">Â¶</a>ç»“æœï¼š</h4>
<blockquote>
<p>æŒ‰ç…§ageåˆ†ç»„ï¼ŒcreateTimeæ­£åºæ’åºçš„Top 2æ•°æ®</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210519_125510.png" alt=""></p>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ51ã€getg()å‡½æ•°å®ç°æºç </title>
    <url>/archives/82f0ffe7.html</url>
    <content><![CDATA[<p>åœ¨å­¦ä¹ <a href="https://blog.imrcrab.com/archives/a90dcb34.html#call-schedinit%E5%87%BD%E6%95%B0">ğŸ‘‰ğŸ¾schedinit()å‡½æ•°</a>è¿‡ç¨‹ä¸­å‘ç°æœ‰è¿™ä¸ªä¹ˆå‡½æ•°ï¼š</p>
<blockquote>
<p>getg()</p>
</blockquote>
<p>å¤šå¤„éƒ½æœ‰ä½¿ç”¨çš„æƒ…å†µï¼Œä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œåˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå¦‚ä½•è·å–çš„Gå‘¢ï¼Ÿ</p>
<span id="more"></span>
<h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰">Â¶</a>å®šä¹‰</h3>
<p>æºç ä¸­çš„å®šä¹‰ï¼š<a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/stubs.go#L18">ğŸ™ŒğŸ½  func getg() *g</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210513_113610.png" alt=""></p>
<h3 id="ä½¿ç”¨ï¼š"><a class="header-anchor" href="#ä½¿ç”¨ï¼š">Â¶</a>ä½¿ç”¨ï¼š</h3>
<p>ä»ä¸Šé¢çš„ç»“æœæ¥çœ‹ï¼Œä¸»è¦from TLS or ç¼–è¯‘å™¨:</p>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/cmd/compile/internal/amd64/ssa.go#L895">ğŸ‘‰ğŸ¾1.14å‘ˆç°ï¼š</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210513_114619.png" alt=""></p>
<blockquote>
<p>æ ¹æ®æ˜¯å¦ä½¿ç”¨TLSåˆ†ä¸¤ç§ï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210513_115015.png" alt=""></p>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ50ã€Map GCé—®é¢˜</title>
    <url>/archives/af25fb6c.html</url>
    <content><![CDATA[<p>é—®é¢˜çš„èµ·å› :<a href="https://blog.imrcrab.com/archives/2de36dd7.html">ã€Œ29ã€map delete Memä¸é‡Šæ”¾é—®é¢˜</a></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥:</p>
<ul>
<li>mapå†…å­˜é‡Šæ”¾çš„æ—¶æœºå‘¢ï¼Ÿ</li>
<li>é‡Šæ”¾å¦‚æœmapè¿‡å¤§ï¼Œé‡Šæ”¾å†…å­˜è¿‡ç¨‹ä¸­ä¼šä¸ä¼šæœ‰GC StopWorldé—®é¢˜?</li>
</ul>
<span id="more"></span>
<h3 id="ä»£ç éƒ¨åˆ†ï¼š"><a class="header-anchor" href="#ä»£ç éƒ¨åˆ†ï¼š">Â¶</a>ä»£ç éƒ¨åˆ†ï¼š</h3>
<h4 id="mapçš„valueä¸åŒ…å«pointerï¼š"><a class="header-anchor" href="#mapçš„valueä¸åŒ…å«pointerï¼š">Â¶</a>mapçš„valueä¸åŒ…å«pointerï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;runtime/trace&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AddMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	now:=time.Now().Unix()</span><br><span class="line">	fmt.Println(now)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">		mmp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line">		<span class="keyword">for</span> ia := <span class="number">0</span>; ia &lt; <span class="number">100000</span>; ia++ &#123;</span><br><span class="line">			v := ia</span><br><span class="line">			mmp[strconv.Itoa(ia)] = v</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(time.Now().Unix()-now)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	trace.Start(os.Stderr)</span><br><span class="line">	<span class="keyword">defer</span> trace.Stop()</span><br><span class="line">	AddMap()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mapçš„valueåŒ…å«pointerï¼š"><a class="header-anchor" href="#mapçš„valueåŒ…å«pointerï¼š">Â¶</a>mapçš„valueåŒ…å«pointerï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;runtime/trace&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AddMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	now:=time.Now().Unix()</span><br><span class="line">	fmt.Println(now)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">		mmp := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*<span class="type">int</span>)</span><br><span class="line">		<span class="keyword">for</span> ia := <span class="number">0</span>; ia &lt; <span class="number">100000</span>; ia++ &#123;</span><br><span class="line">			v := ia</span><br><span class="line">			mmp[strconv.Itoa(ia)] = &amp;v</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(time.Now().Unix()-now)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	trace.Start(os.Stderr)</span><br><span class="line">	<span class="keyword">defer</span> trace.Stop()</span><br><span class="line">	AddMap()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="traceç»“æœï¼š"><a class="header-anchor" href="#traceç»“æœï¼š">Â¶</a>traceç»“æœï¼š</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210512_113756.png" alt=""></p>
<h3 id="åˆæ­¥æ–¹æ¡ˆï¼š"><a class="header-anchor" href="#åˆæ­¥æ–¹æ¡ˆï¼š">Â¶</a>åˆæ­¥æ–¹æ¡ˆï¼š</h3>
<h3 id="Sliceæ›¿ä»£Mapæ–¹æ¡ˆï¼š"><a class="header-anchor" href="#Sliceæ›¿ä»£Mapæ–¹æ¡ˆï¼š">Â¶</a>Sliceæ›¿ä»£Mapæ–¹æ¡ˆï¼š</h3>
<h3 id="Test"><a class="header-anchor" href="#Test">Â¶</a>Test</h3>
<h3 id="benchmark"><a class="header-anchor" href="#benchmark">Â¶</a>benchmark</h3>
<h3 id="å¾…æ›´æ–°"><a class="header-anchor" href="#å¾…æ›´æ–°">Â¶</a>å¾…æ›´æ–°</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
        <tag>Runtime</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ48ã€GMP mainä¹‹G&amp;Måˆ›å»º</title>
    <url>/archives/a90dcb34.html</url>
    <content><![CDATA[<p>å‰é¢è¯´äº†GPMçš„mainå‡½æ•°å¯åŠ¨<a href="https://blog.imrcrab.com/archives/66b6223a.html#more">ã€Œ47ã€GPM mainå¯åŠ¨</a>ï¼Œè¿™æ¬¡çœ‹ä¸‹è¿™ä¸ªå¯åŠ¨è¿‡ç¨‹ä¸­å¦‚ä½•åˆ›å»ºç¬¬ä¸€ä¸ªMå’ŒGçš„æ“ä½œã€‚</p>
<p>åœ¨mainå‡½æ•°æ±‡ç¼–çš„å…¥å£åœ°æ–¹callè¿™ä¹ˆå‡ ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>args å‚æ•°è®¾å®š</li>
<li>osinit osç³»ç»Ÿåˆå§‹åŒ–</li>
<li>schedinit è°ƒåº¦åˆå§‹åŒ–</li>
</ul>
<span id="more"></span>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210506_105845.png" alt=""></p>
<h3 id="call-osinitå‡½æ•°"><a class="header-anchor" href="#call-osinitå‡½æ•°">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/os_plan9.go#L291">call osinitå‡½æ•°</a></h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210506_105719.png" alt=""></p>
<blockquote>
<p>getpid()è·å–å½“å‰çš„procçš„idå·ï¼Œèµ‹å€¼ç»™å½“å‰g-&gt;m.procid</p>
</blockquote>
<h3 id="call-schedinitå‡½æ•°"><a class="header-anchor" href="#call-schedinitå‡½æ•°">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L532">call schedinitå‡½æ•°</a></h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// The bootstrap sequence is:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	call osinit</span></span><br><span class="line"><span class="comment">//	call schedinit</span></span><br><span class="line"><span class="comment">//	make &amp; queue new G</span></span><br><span class="line"><span class="comment">//	call runtimeÂ·mstart</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The new G calls runtimeÂ·main.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">schedinit</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€å¤§å †lockçš„åˆå§‹åŒ–</span></span><br><span class="line">	lockInit(&amp;sched.lock, lockRankSched)</span><br><span class="line">	lockInit(&amp;sched.sysmonlock, lockRankSysmon)</span><br><span class="line">	lockInit(&amp;sched.deferlock, lockRankDefer)</span><br><span class="line">	lockInit(&amp;sched.sudoglock, lockRankSudog)</span><br><span class="line">	lockInit(&amp;deadlock, lockRankDeadlock)</span><br><span class="line">	lockInit(&amp;paniclk, lockRankPanic)</span><br><span class="line">	lockInit(&amp;allglock, lockRankAllg)</span><br><span class="line">	lockInit(&amp;allpLock, lockRankAllp)</span><br><span class="line">	lockInit(&amp;reflectOffs.lock, lockRankReflectOffs)</span><br><span class="line">	lockInit(&amp;finlock, lockRankFin)</span><br><span class="line">	lockInit(&amp;trace.bufLock, lockRankTraceBuf)</span><br><span class="line">	lockInit(&amp;trace.stringsLock, lockRankTraceStrings)</span><br><span class="line">	lockInit(&amp;trace.lock, lockRankTrace)</span><br><span class="line">	lockInit(&amp;cpuprof.lock, lockRankCpuprof)</span><br><span class="line">	lockInit(&amp;trace.stackTab.lock, lockRankTraceStackTab)</span><br><span class="line">	<span class="comment">// Enforce that this lock is always a leaf lock.</span></span><br><span class="line">	<span class="comment">// All of this lock&#x27;s critical sections should be</span></span><br><span class="line">	<span class="comment">// extremely short.</span></span><br><span class="line">	lockInit(&amp;memstats.heapStats.noPLock, lockRankLeafRank)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// raceinit must be the first call to race detector.</span></span><br><span class="line">	<span class="comment">// In particular, it must be done before mallocinit below calls racemapshadow.</span></span><br><span class="line">    <span class="comment">// è·å–å½“å‰çš„g</span></span><br><span class="line">	_g_ := getg()</span><br><span class="line">	<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">		_g_.racectx, raceprocctx0 = raceinit()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€å¤§çš„mä¸º1wä¸ª</span></span><br><span class="line">	sched.maxmcount = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The world starts stopped.</span></span><br><span class="line">	worldStopped()</span><br><span class="line"></span><br><span class="line">	moduledataverify()</span><br><span class="line">    <span class="comment">// stackåˆå§‹åŒ–</span></span><br><span class="line">	stackinit()</span><br><span class="line">    <span class="comment">// å†…å­˜åˆ†é…å™¨åˆå§‹åŒ–</span></span><br><span class="line">	mallocinit()</span><br><span class="line">    <span class="comment">// éšæœºæ•°åˆå§‹åŒ–</span></span><br><span class="line">	fastrandinit() <span class="comment">// must run before mcommoninit</span></span><br><span class="line">    <span class="comment">// idé¢„åˆ†é…</span></span><br><span class="line">	mcommoninit(_g_.m, <span class="number">-1</span>)</span><br><span class="line">	cpuinit()       <span class="comment">// must run before alginit</span></span><br><span class="line">    <span class="comment">// å†…å­˜å †é½åˆå§‹åŒ–</span></span><br><span class="line">	alginit()       <span class="comment">// maps must not be used before this call</span></span><br><span class="line">	modulesinit()   <span class="comment">// provides activeModules</span></span><br><span class="line">	typelinksinit() <span class="comment">// uses maps, activeModules</span></span><br><span class="line">	itabsinit()     <span class="comment">// uses activeModules</span></span><br><span class="line"></span><br><span class="line">	sigsave(&amp;_g_.m.sigmask)</span><br><span class="line">	initSigmask = _g_.m.sigmask</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> offset := unsafe.Offsetof(sched.timeToRun); offset%<span class="number">8</span> != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">println</span>(offset)</span><br><span class="line">		throw(<span class="string">&quot;sched.timeToRun not aligned to 8 bytes&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	goargs()</span><br><span class="line">	goenvs()</span><br><span class="line">	parsedebugvars()</span><br><span class="line">	gcinit()</span><br><span class="line"></span><br><span class="line">	lock(&amp;sched.lock)</span><br><span class="line">	sched.lastpoll = <span class="type">uint64</span>(nanotime())</span><br><span class="line">	procs := ncpu</span><br><span class="line">	<span class="keyword">if</span> n, ok := atoi32(gogetenv(<span class="string">&quot;GOMAXPROCS&quot;</span>)); ok &amp;&amp; n &gt; <span class="number">0</span> &#123;</span><br><span class="line">		procs = n</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> procresize(procs) != <span class="literal">nil</span> &#123;</span><br><span class="line">		throw(<span class="string">&quot;unknown runnable goroutine during bootstrap&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	unlock(&amp;sched.lock)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// World is effectively started now, as P&#x27;s can run.</span></span><br><span class="line">	worldStarted()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// For cgocheck &gt; 1, we turn on the write barrier at all times</span></span><br><span class="line">	<span class="comment">// and check all pointer writes. We can&#x27;t do this until after</span></span><br><span class="line">	<span class="comment">// procresize because the write barrier needs a P.</span></span><br><span class="line">	<span class="keyword">if</span> debug.cgocheck &gt; <span class="number">1</span> &#123;</span><br><span class="line">		writeBarrier.cgo = <span class="literal">true</span></span><br><span class="line">		writeBarrier.enabled = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">for</span> _, p := <span class="keyword">range</span> allp &#123;</span><br><span class="line">			p.wbBuf.reset()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> buildVersion == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// Condition should never trigger. This code just serves</span></span><br><span class="line">		<span class="comment">// to ensure runtimeÂ·buildVersion is kept in the resulting binary.</span></span><br><span class="line">		buildVersion = <span class="string">&quot;unknown&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(modinfo) == <span class="number">1</span> &#123;</span><br><span class="line">		<span class="comment">// Condition should never trigger. This code just serves</span></span><br><span class="line">		<span class="comment">// to ensure runtimeÂ·modinfo is kept in the resulting binary.</span></span><br><span class="line">		modinfo = <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å¤§ä½“æµç¨‹"><a class="header-anchor" href="#å¤§ä½“æµç¨‹">Â¶</a>å¤§ä½“æµç¨‹</h4>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">1ã€lockinit</span><br><span class="line">2ã€g:=getg()</span><br><span class="line">3ã€maxmcount = 10000</span><br><span class="line">4ã€stackinit</span><br><span class="line">5ã€mallocinitã€Œå†…å­˜åˆ†é…å™¨åˆå§‹åŒ–ã€</span><br><span class="line">6ã€éšæœºæ•°</span><br><span class="line">7ã€mcommonå…¬å…¬éƒ¨åˆ†init</span><br><span class="line">8ã€cpuå’Œbyteç­‰åˆå§‹åŒ–ã€‚</span><br><span class="line">9ã€goenvåˆå§‹åŒ–</span><br><span class="line">10ã€gcinit()</span><br><span class="line">11ã€GOMAXPROCSè®¾ç½®</span><br><span class="line">12ã€cgoç­‰åˆå§‹åŒ–</span><br></pre></td></tr></table></figure>
<h4 id="å‡½æ•°åˆ†æ"><a class="header-anchor" href="#å‡½æ•°åˆ†æ">Â¶</a>å‡½æ•°åˆ†æ</h4>
<h5 id="schedinit"><a class="header-anchor" href="#schedinit">Â¶</a>schedinit</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210515_102713.png" alt=""></p>
<h5 id="worldstop"><a class="header-anchor" href="#worldstop">Â¶</a>worldstop</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210515_102811.png" alt=""></p>
<h5 id="stackinit"><a class="header-anchor" href="#stackinit">Â¶</a>stackinit</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210515_102849.png" alt=""></p>
<h5 id="sigsave"><a class="header-anchor" href="#sigsave">Â¶</a>sigsave</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210515_102930.png" alt=""></p>
<h3 id="å…³äºgomaxprocsæœ€å¤§å€¼"><a class="header-anchor" href="#å…³äºgomaxprocsæœ€å¤§å€¼">Â¶</a>å…³äºgomaxprocsæœ€å¤§å€¼</h3>
<h4 id="Go-1-8åŠä»¥å‰"><a class="header-anchor" href="#Go-1-8åŠä»¥å‰">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.8/src/runtime/runtime2.go#L533">Go 1.8åŠä»¥å‰</a></h4>
<blockquote>
<p>æœ€å¤§ä¸º256</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/ico/clipboard_20210507_102912.png" alt=""></p>
<h4 id="Go-1-9ä¸­"><a class="header-anchor" href="#Go-1-9ä¸­">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.9/src/runtime/runtime2.go#L523">Go 1.9ä¸­</a></h4>
<blockquote>
<p>æœ€å¤§ä¸º1024</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210506_115200.png" alt=""></p>
<h4 id="Go-1-9ä»¥åã€Œ1-14ä¸ºä¾‹ã€"><a class="header-anchor" href="#Go-1-9ä»¥åã€Œ1-14ä¸ºä¾‹ã€">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L1018">Go 1.9ä»¥åã€Œ1.14ä¸ºä¾‹ã€</a></h4>
<blockquote>
<p>æœ€å¤§ä¸ºint32çš„æœ€å¤§å€¼ï¼š<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210507_121640.png" alt=""></p>
</blockquote>
<h4 id="å‘ç‚¹ï¼š"><a class="header-anchor" href="#å‘ç‚¹ï¼š">Â¶</a>å‘ç‚¹ï¼š</h4>
<p>Go 1.14ä»¥åçœ‹ä¼¼æœ€å¤§æ˜¯int32æœ€å¤§å€¼ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæ–°é—®é¢˜ï¼ŒçœŸçš„å¯ä»¥è®¾ç½®åˆ°æœ€å¤§å€¼å—ï¼Ÿå®éªŒä¸€æŠŠï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	runtime.GOMAXPROCS(<span class="type">int32</span>(^<span class="type">uint32</span>(<span class="number">0</span>) &gt;&gt; <span class="number">1</span>))</span><br><span class="line">	fmt.Println(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœæŠ¥é”™ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">fatal <span class="type">error</span>: slice bounds out of <span class="keyword">range</span></span><br><span class="line">fatal <span class="type">error</span>: unexpected signal during runtime execution</span><br><span class="line"><span class="built_in">panic</span> during <span class="built_in">panic</span></span><br><span class="line">[signal SIGSEGV: segmentation violation code=<span class="number">0x1</span> addr=<span class="number">0x4</span> pc=<span class="number">0x104098b</span>]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">....</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”æ•°ç»„è¶Šç•Œäº†ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>åˆåå¤çœ‹äº†çœ‹æºç ï¼Œé—®é¢˜æ‰¾å‡ºæ¥äº†ï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210507_122730.png" alt=""></p>
<h5 id="é—®é¢˜çš„å…³é”®"><a class="header-anchor" href="#é—®é¢˜çš„å…³é”®">Â¶</a>é—®é¢˜çš„å…³é”®</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">maskWords := (nprocs + <span class="number">31</span>) / <span class="number">32</span></span><br><span class="line"></span><br><span class="line">å¯¼è‡´ï¼šmaskWordsæ•°å€¼æº¢å‡ºäº†ï¼Œå¯¼è‡´ä¸‹é¢æˆªå–<span class="built_in">panic</span>ã€‚</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> nprocs &lt;= <span class="type">int32</span>(<span class="built_in">cap</span>(allp)) &#123;</span><br><span class="line">	allp = allp[:nprocs]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="GOMAXPROCSæœ€å¤§å€¼ï¼Ÿï¼Ÿ"><a class="header-anchor" href="#GOMAXPROCSæœ€å¤§å€¼ï¼Ÿï¼Ÿ">Â¶</a>GOMAXPROCSæœ€å¤§å€¼ï¼Ÿï¼Ÿ</h3>
<blockquote>
<p>æ‰€ä»¥GOMAXPROCSæœ€å¤§ä¸º: int32(^uint32(0) &gt;&gt; 1)-31</p>
</blockquote>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ49ã€Go runtimeæ“ä½œã€ŒæŒç»­æ›´æ–°ã€</title>
    <url>/archives/3b137bd0.html</url>
    <content><![CDATA[<p>ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>å˜é‡çš„å«ä¹‰å’Œå­˜åœ¨çš„ä½œç”¨</li>
<li>æ–¹æ³•çš„ç”¨é€”</li>
<li>è®¾è®¡æ–¹å¼åˆ†æ</li>
</ul>
<span id="more"></span>
<h3 id="å˜é‡ä½œç”¨ï¼š"><a class="header-anchor" href="#å˜é‡ä½œç”¨ï¼š">Â¶</a>å˜é‡ä½œç”¨ï¼š</h3>
<h4 id="å…¨å±€çš„"><a class="header-anchor" href="#å…¨å±€çš„">Â¶</a>å…¨å±€çš„</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	<span class="comment">// å…¨å±€m</span></span><br><span class="line">	allm       *m</span><br><span class="line">	<span class="comment">// procæœ€å¤§å€¼</span></span><br><span class="line">	gomaxprocs <span class="type">int32</span></span><br><span class="line">	<span class="comment">// cpuæ•°é‡</span></span><br><span class="line">	ncpu       <span class="type">int32</span></span><br><span class="line">	forcegc    forcegcstate</span><br><span class="line">	<span class="comment">// è°ƒåº¦è¿‡ç¨‹ä¸­çš„ç»“æ„ä½“</span></span><br><span class="line">	sched      schedt</span><br><span class="line">	<span class="comment">// gomaxprocsæ•°é‡</span></span><br><span class="line">	newprocs   <span class="type">int32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// allpLock protects P-less reads and size changes of allp, idlepMask,</span></span><br><span class="line">	<span class="comment">// and timerpMask, and all writes to allp.</span></span><br><span class="line">	<span class="comment">// å…¨å±€på¯¹åº”çš„lock</span></span><br><span class="line">	allpLock mutex</span><br><span class="line">	<span class="comment">// len(allp) == gomaxprocs; may change at safe points, otherwise</span></span><br><span class="line">	<span class="comment">// immutable.</span></span><br><span class="line">	<span class="comment">// Pçš„å…¨å±€é˜Ÿåˆ—</span></span><br><span class="line">	allp []*p</span><br><span class="line">	......</span><br><span class="line">	....</span><br><span class="line">	...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="Gçš„çŠ¶æ€ï¼š"><a class="header-anchor" href="#Gçš„çŠ¶æ€ï¼š">Â¶</a>Gçš„çŠ¶æ€ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">_Gidle</span><br><span class="line">_Grunnable</span><br><span class="line">_Grunning</span><br><span class="line">_Gsyscall</span><br><span class="line">_Gwaiting</span><br><span class="line">_Gdead</span><br><span class="line">_Gcopystack</span><br><span class="line">_Gpreempted</span><br><span class="line">_Gscan = <span class="number">0x1000</span></span><br><span class="line">_Gscanrunnable</span><br><span class="line">_Gscansyscall</span><br><span class="line">_Gscanwaiting</span><br><span class="line">_Gscanpreempted</span><br></pre></td></tr></table></figure>
<h4 id="Pçš„çŠ¶æ€ï¼š"><a class="header-anchor" href="#Pçš„çŠ¶æ€ï¼š">Â¶</a>Pçš„çŠ¶æ€ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">_Pidle</span><br><span class="line">_Prunning</span><br><span class="line">_Psyscall</span><br><span class="line">_Pgcstop</span><br><span class="line">_Pdead</span><br></pre></td></tr></table></figure>
<h4 id="sudog"><a class="header-anchor" href="#sudog">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L332">sudog</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// sudog represents a g in a wait list, such as for sending/receiving</span></span><br><span class="line"><span class="comment">// on a channel.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// sudog is necessary because the g â†” synchronization object relation</span></span><br><span class="line"><span class="comment">// is many-to-many. A g can be on many wait lists, so there may be</span></span><br><span class="line"><span class="comment">// many sudogs for one g; and many gs may be waiting on the same</span></span><br><span class="line"><span class="comment">// synchronization object, so there may be many sudogs for one object.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// sudogs are allocated from a special pool. Use acquireSudog and</span></span><br><span class="line"><span class="comment">// releaseSudog to allocate and free them.</span></span><br><span class="line"><span class="keyword">type</span> sudog <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// The following fields are protected by the hchan.lock of the</span></span><br><span class="line">	<span class="comment">// channel this sudog is blocking on. shrinkstack depends on</span></span><br><span class="line">	<span class="comment">// this for sudogs involved in channel ops.</span></span><br><span class="line">	<span class="comment">// å½“å‰å¤„äºgoroutine</span></span><br><span class="line">	g *g </span><br><span class="line"></span><br><span class="line">	<span class="comment">// isSelect indicates g is participating in a select, so</span></span><br><span class="line">	<span class="comment">// g.selectDone must be CAS&#x27;d to win the wake-up race.</span></span><br><span class="line">	<span class="comment">// æ ‡è®°select</span></span><br><span class="line">	isSelect <span class="type">bool</span></span><br><span class="line">	next     *sudog</span><br><span class="line">	prev     *sudog</span><br><span class="line">	elem     unsafe.Pointer <span class="comment">// data element (may point to stack)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The following fields are never accessed concurrently.</span></span><br><span class="line">	<span class="comment">// For channels, waitlink is only accessed by g.</span></span><br><span class="line">	<span class="comment">// For semaphores, all fields (including the ones above)</span></span><br><span class="line">	<span class="comment">// are only accessed when holding a semaRoot lock.</span></span><br><span class="line"></span><br><span class="line">	acquiretime <span class="type">int64</span></span><br><span class="line">	releasetime <span class="type">int64</span></span><br><span class="line">	ticket      <span class="type">uint32</span></span><br><span class="line">	parent      *sudog <span class="comment">// semaRoot binary tree</span></span><br><span class="line">	waitlink    *sudog <span class="comment">// g.waiting list or semaRoot</span></span><br><span class="line">	waittail    *sudog <span class="comment">// semaRoot</span></span><br><span class="line">	c           *hchan <span class="comment">// channel</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="g"><a class="header-anchor" href="#g">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L395">g</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// panicç»“æ„</span></span><br><span class="line">_panic		*_panic</span><br><span class="line"><span class="comment">// deferå‡½æ•°ç»“æ„</span></span><br><span class="line">_defer		*_defer</span><br><span class="line"><span class="comment">// ç»‘å®šçš„m</span></span><br><span class="line">m     		 *m</span><br><span class="line"><span class="comment">// goidåºå·</span></span><br><span class="line">goid		 <span class="type">int64</span></span><br><span class="line"><span class="comment">// æŠ¢å å…³ç³» </span></span><br><span class="line">preempt		 <span class="type">bool</span></span><br><span class="line"><span class="comment">// ç­‰å¾…çš„é˜Ÿåˆ—</span></span><br><span class="line">waiting		 *sudog</span><br><span class="line"><span class="comment">//cached for time.sleep</span></span><br><span class="line">timer		 *timer</span><br><span class="line">.....</span><br><span class="line">....</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="m"><a class="header-anchor" href="#m">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L477">m</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">g0 		*g</span><br><span class="line">currg 	*g</span><br><span class="line">procid  <span class="type">uint64</span></span><br><span class="line"><span class="comment">// è‡ªæ—‹</span></span><br><span class="line">spinning <span class="type">bool</span> </span><br><span class="line"><span class="comment">// éšæœºæ•°</span></span><br><span class="line">fastrand [<span class="number">2</span>]<span class="type">uint32</span></span><br><span class="line"></span><br><span class="line">park     note</span><br><span class="line">alllink *m</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="p"><a class="header-anchor" href="#p">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L556">p</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">id		<span class="type">int32</span></span><br><span class="line">status 	<span class="type">uint32</span></span><br><span class="line">m 		*m</span><br><span class="line"><span class="comment">// timerä½¿ç”¨ç›¸å…³</span></span><br><span class="line">timerslock mutex</span><br><span class="line">timers []*timer</span><br><span class="line">numTimers <span class="type">uint32</span></span><br><span class="line"><span class="comment">// æŠ¢å å…³ç³»</span></span><br><span class="line">preempt <span class="type">bool</span></span><br></pre></td></tr></table></figure>
<h4 id="defer"><a class="header-anchor" href="#defer">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L865">_defer</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">fn        *funcval <span class="comment">// can be nil for open-coded defers</span></span><br><span class="line">_panic    *_panic  <span class="comment">// panic that is running defer</span></span><br><span class="line">link      *_defer</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="panic"><a class="header-anchor" href="#panic">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L903">_panic</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A _panic holds information about an active panic.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A _panic value must only ever live on the stack.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The argp and link fields are stack pointers, but don&#x27;t need special</span></span><br><span class="line"><span class="comment">// handling during stack growth: because they are pointer-typed and</span></span><br><span class="line"><span class="comment">// _panic values only live on the stack, regular stack pointer</span></span><br><span class="line"><span class="comment">// adjustment takes care of them.</span></span><br><span class="line"><span class="keyword">type</span> _panic <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// function</span></span><br><span class="line">	argp      unsafe.Pointer <span class="comment">// pointer to arguments of deferred call run during panic; cannot move - known to liblink</span></span><br><span class="line">	<span class="comment">// å‚æ•°</span></span><br><span class="line">	arg       <span class="keyword">interface</span>&#123;&#125;    <span class="comment">// argument to panic</span></span><br><span class="line">	<span class="comment">// link to _panic</span></span><br><span class="line">	link      *_panic        <span class="comment">// link to earlier panic</span></span><br><span class="line">	pc        <span class="type">uintptr</span>        <span class="comment">// where to return to in runtime if this panic is bypassed</span></span><br><span class="line">	sp        unsafe.Pointer <span class="comment">// where to return to in runtime if this panic is bypassed</span></span><br><span class="line">	<span class="comment">// recoveræ ‡å¿—</span></span><br><span class="line">	recovered <span class="type">bool</span>           <span class="comment">// whether this panic is over</span></span><br><span class="line">	aborted   <span class="type">bool</span>           <span class="comment">// the panic was aborted</span></span><br><span class="line">	goexit    <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
        <tag>Runtime</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ47ã€GPM mainå¯åŠ¨</title>
    <url>/archives/66b6223a.html</url>
    <content><![CDATA[<p>ä¹‹å‰æ‰¯è¿‡GPMçš„<a href="https://blog.imrcrab.com/archives/392d66f0.html">g0å’Œm0å…³ç³»</a>å’Œ<a href="https://blog.imrcrab.com/archives/9bb71eca.html">mainå‡½æ•°å…¥å£</a>çš„ä¸€äº›ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>å¤šæ¬¡çœ‹go mianå‡½æ•°çš„å¯åŠ¨æµç¨‹ï¼Œå¤šæ¬¡åˆ†æï¼Œå¤šæ¬¡ç†è§£ï¼Œå…³æ³¨ç‚¹å’Œç»“è®ºå„æœ‰ä¸åŒï¼Œä»¥æ­¤è®°å½•ã€‚</p>
<h3 id="ğŸ‘‹å…¥å£ï¼š"><a class="header-anchor" href="#ğŸ‘‹å…¥å£ï¼š">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L22">ğŸ‘‹å…¥å£</a>ï¼š</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210505_094951.png" alt=""></p>
<span id="more"></span>
<h3 id="æä¸€ä¸ªç®€å•çš„mainå‡½æ•°çœ‹ä¸‹æ±‡ç¼–ï¼š"><a class="header-anchor" href="#æä¸€ä¸ªç®€å•çš„mainå‡½æ•°çœ‹ä¸‹æ±‡ç¼–ï¼š">Â¶</a>æä¸€ä¸ªç®€å•çš„mainå‡½æ•°çœ‹ä¸‹æ±‡ç¼–ï¼š</h3>
<h4 id="Mainå‡½æ•°"><a class="header-anchor" href="#Mainå‡½æ•°">Â¶</a>Mainå‡½æ•°</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="æ±‡ç¼–ç»“æœ"><a class="header-anchor" href="#æ±‡ç¼–ç»“æœ">Â¶</a>æ±‡ç¼–ç»“æœ</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210506_111747.png" alt=""></p>
<h3 id="å¤§ä½“æµç¨‹ï¼š"><a class="header-anchor" href="#å¤§ä½“æµç¨‹ï¼š">Â¶</a>å¤§ä½“æµç¨‹ï¼š</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210506_013950.png" alt=""></p>
<h3 id="æ±‡ç¼–ä»£ç å®šä¹‰ï¼š"><a class="header-anchor" href="#æ±‡ç¼–ä»£ç å®šä¹‰ï¼š">Â¶</a>æ±‡ç¼–ä»£ç å®šä¹‰ï¼š</h3>
<ul>
<li>å…¨å±€ï¼š<a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L236">ğŸ‘‰ğŸ»</a></li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210506_112649.png" alt=""></p>
<ul>
<li>å…¥å£ï¼š<a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L22">ğŸ‘‰ğŸ»</a></li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210506_122959.png" alt=""></p>
<h3 id="rt0-goå‡½æ•°ï¼š"><a class="header-anchor" href="#rt0-goå‡½æ•°ï¼š">Â¶</a>rt0_goå‡½æ•°ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TEXT runtimeÂ·rt0_go(SB),NOSPLIT|TOPFRAME,$<span class="number">0</span></span><br><span class="line">	<span class="comment">// copy arguments forward on an even stack</span></span><br><span class="line">	MOVQ	DI, AX		<span class="comment">// argc</span></span><br><span class="line">	MOVQ	SI, BX		<span class="comment">// argv</span></span><br><span class="line">	SUBQ	$(<span class="number">4</span>*<span class="number">8</span>+<span class="number">7</span>), SP		<span class="comment">// 2args 2auto</span></span><br><span class="line">	ANDQ	$~<span class="number">15</span>, SP</span><br><span class="line">	MOVQ	AX, <span class="number">16</span>(SP)</span><br><span class="line">	MOVQ	BX, <span class="number">24</span>(SP)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ“ä½œç³»ç»Ÿstack</span></span><br><span class="line">	<span class="comment">// create istack out of the given (operating system) stack.</span></span><br><span class="line">	<span class="comment">// _cgo_init may update stackguard.</span></span><br><span class="line">	MOVQ	$runtimeÂ·g0(SB), DI</span><br><span class="line">	LEAQ	(<span class="number">-64</span>*<span class="number">1024</span>+<span class="number">104</span>)(SP), BX</span><br><span class="line">	MOVQ	BX, g_stackguard0(DI)</span><br><span class="line">	MOVQ	BX, g_stackguard1(DI)</span><br><span class="line">	MOVQ	BX, (g_stack+stack_lo)(DI)</span><br><span class="line">	MOVQ	SP, (g_stack+stack_hi)(DI)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// find out information about the processor we&#x27;re on</span></span><br><span class="line">	MOVL	$<span class="number">0</span>, AX</span><br><span class="line">	CPUID</span><br><span class="line">	MOVL	AX, SI</span><br><span class="line">	CMPL	AX, $<span class="number">0</span></span><br><span class="line">	JE	nocpuinfo</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–é€‰æ‹©</span></span><br><span class="line">	<span class="comment">// Figure out how to serialize RDTSC.</span></span><br><span class="line">	<span class="comment">// On Intel processors LFENCE is enough. AMD requires MFENCE.</span></span><br><span class="line">	<span class="comment">// Don&#x27;t know about the rest, so let&#x27;s do MFENCE.</span></span><br><span class="line">	CMPL	BX, $<span class="number">0x756E6547</span>  <span class="comment">// &quot;Genu&quot;</span></span><br><span class="line">	JNE	notintel</span><br><span class="line">	CMPL	DX, $<span class="number">0x49656E69</span>  <span class="comment">// &quot;ineI&quot;</span></span><br><span class="line">	JNE	notintel</span><br><span class="line">	CMPL	CX, $<span class="number">0x6C65746E</span>  <span class="comment">// &quot;ntel&quot;</span></span><br><span class="line">	JNE	notintel</span><br><span class="line">	MOVB	$<span class="number">1</span>, runtimeÂ·isIntel(SB)</span><br><span class="line">	MOVB	$<span class="number">1</span>, runtimeÂ·lfenceBeforeRdtsc(SB)</span><br><span class="line">notintel:</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Load EAX=1 cpuid flags</span></span><br><span class="line">	MOVL	$<span class="number">1</span>, AX</span><br><span class="line">	CPUID</span><br><span class="line">	MOVL	AX, runtimeÂ·processorVersionInfo(SB)</span><br><span class="line"></span><br><span class="line">nocpuinfo:</span><br><span class="line">	<span class="comment">// if there is an _cgo_init, call it.</span></span><br><span class="line">	MOVQ	_cgo_init(SB), AX</span><br><span class="line">	TESTQ	AX, AX</span><br><span class="line">	JZ	needtls</span><br><span class="line">	<span class="comment">// arg 1: g0, already in DI</span></span><br><span class="line">	MOVQ	$setg_gcc&lt;&gt;(SB), SI <span class="comment">// arg 2: setg_gcc</span></span><br><span class="line">#ifdef GOOS_android</span><br><span class="line">	MOVQ	$runtimeÂ·tls_g(SB), DX 	<span class="comment">// arg 3: &amp;tls_g</span></span><br><span class="line">	<span class="comment">// arg 4: TLS base, stored in slot 0 (Android&#x27;s TLS_SLOT_SELF).</span></span><br><span class="line">	<span class="comment">// Compensate for tls_g (+16).</span></span><br><span class="line">	MOVQ	<span class="number">-16</span>(TLS), CX</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">	MOVQ	$<span class="number">0</span>, DX	<span class="comment">// arg 3, 4: not used when using platform&#x27;s TLS</span></span><br><span class="line">	MOVQ	$<span class="number">0</span>, CX</span><br><span class="line">#endif</span><br><span class="line">#ifdef GOOS_windows</span><br><span class="line">	<span class="comment">// Adjust for the Win64 calling convention.</span></span><br><span class="line">	MOVQ	CX, R9 <span class="comment">// arg 4</span></span><br><span class="line">	MOVQ	DX, R8 <span class="comment">// arg 3</span></span><br><span class="line">	MOVQ	SI, DX <span class="comment">// arg 2</span></span><br><span class="line">	MOVQ	DI, CX <span class="comment">// arg 1</span></span><br><span class="line">#endif</span><br><span class="line">	CALL	AX</span><br><span class="line"></span><br><span class="line">	<span class="comment">// update stackguard after _cgo_init</span></span><br><span class="line">	MOVQ	$runtimeÂ·g0(SB), CX</span><br><span class="line">	MOVQ	(g_stack+stack_lo)(CX), AX</span><br><span class="line">	ADDQ	$const__StackGuard, AX</span><br><span class="line">	MOVQ	AX, g_stackguard0(CX)</span><br><span class="line">	MOVQ	AX, g_stackguard1(CX)</span><br><span class="line"></span><br><span class="line">#ifndef GOOS_windows</span><br><span class="line">	JMP ok</span><br><span class="line">#endif</span><br><span class="line">needtls:</span><br><span class="line">#ifdef GOOS_plan9</span><br><span class="line">	<span class="comment">// skip TLS setup on Plan 9</span></span><br><span class="line">	JMP ok</span><br><span class="line">#endif</span><br><span class="line">#ifdef GOOS_solaris</span><br><span class="line">	<span class="comment">// skip TLS setup on Solaris</span></span><br><span class="line">	JMP ok</span><br><span class="line">#endif</span><br><span class="line">#ifdef GOOS_illumos</span><br><span class="line">	<span class="comment">// skip TLS setup on illumos</span></span><br><span class="line">	JMP ok</span><br><span class="line">#endif</span><br><span class="line">#ifdef GOOS_darwin</span><br><span class="line">	<span class="comment">// skip TLS setup on Darwin</span></span><br><span class="line">	JMP ok</span><br><span class="line">#endif</span><br><span class="line">#ifdef GOOS_openbsd</span><br><span class="line">	<span class="comment">// skip TLS setup on OpenBSD</span></span><br><span class="line">	JMP ok</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	LEAQ	runtimeÂ·m0+m_tls(SB), DI</span><br><span class="line">	CALL	runtimeÂ·settls(SB)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tlsè®¾ç½®</span></span><br><span class="line">	<span class="comment">// store through it, to make sure it works</span></span><br><span class="line">	get_tls(BX)</span><br><span class="line">	MOVQ	$<span class="number">0x123</span>, g(BX)</span><br><span class="line">	MOVQ	runtimeÂ·m0+m_tls(SB), AX</span><br><span class="line">	CMPQ	AX, $<span class="number">0x123</span></span><br><span class="line">	JEQ <span class="number">2</span>(PC)</span><br><span class="line">	CALL	runtimeÂ·abort(SB)</span><br><span class="line">ok:</span><br><span class="line">	<span class="comment">// set the per-goroutine and per-mach &quot;registers&quot;</span></span><br><span class="line">	get_tls(BX)</span><br><span class="line">	LEAQ	runtimeÂ·g0(SB), CX</span><br><span class="line">	MOVQ	CX, g(BX)</span><br><span class="line">	LEAQ	runtimeÂ·m0(SB), AX</span><br><span class="line"></span><br><span class="line">    <span class="comment">// m.g0ç»‘å®šä¸€ä¸ªg0</span></span><br><span class="line">	<span class="comment">// save m-&gt;g0 = g0</span></span><br><span class="line">	MOVQ	CX, m_g0(AX)</span><br><span class="line">    <span class="comment">// g0ç»‘å®šm0</span></span><br><span class="line">	<span class="comment">// save m0 to g0-&gt;m</span></span><br><span class="line">	MOVQ	AX, g_m(CX)</span><br><span class="line"></span><br><span class="line">	CLD				<span class="comment">// convention is D is always left cleared</span></span><br><span class="line">	CALL	runtimeÂ·check(SB)</span><br><span class="line"></span><br><span class="line">	MOVL	<span class="number">16</span>(SP), AX		<span class="comment">// copy argc</span></span><br><span class="line">	MOVL	AX, <span class="number">0</span>(SP)</span><br><span class="line">	MOVQ	<span class="number">24</span>(SP), AX		<span class="comment">// copy argv</span></span><br><span class="line">	MOVQ	AX, <span class="number">8</span>(SP)</span><br><span class="line">    <span class="comment">// å‚æ•°åˆå§‹åŒ–</span></span><br><span class="line">	CALL	runtimeÂ·args(SB)</span><br><span class="line">    <span class="comment">// ç³»ç»Ÿåˆå§‹åŒ–</span></span><br><span class="line">	CALL	runtimeÂ·osinit(SB)</span><br><span class="line">    <span class="comment">// è°ƒåº¦ä»»åŠ¡åˆå§‹åŒ–ï¼Œå…·ä½“é€»è¾‘ä¸‹é¢æœ‰æåˆ°</span></span><br><span class="line">	CALL	runtimeÂ·schedinit(SB)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºç¬¬ä¸€ä¸ªgï¼Œç”¨äºå¯åŠ¨ç¨‹åº</span></span><br><span class="line">	<span class="comment">// create a new goroutine to start program</span></span><br><span class="line">	MOVQ	$runtimeÂ·mainPC(SB), AX		<span class="comment">// entry</span></span><br><span class="line">	PUSHQ	AX</span><br><span class="line">	PUSHQ	$<span class="number">0</span>			<span class="comment">// arg size</span></span><br><span class="line">	CALL	runtimeÂ·newproc(SB)</span><br><span class="line">	POPQ	AX</span><br><span class="line">	POPQ	AX</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start this M</span></span><br><span class="line">    <span class="comment">//  å¯åŠ¨M</span></span><br><span class="line">	CALL	runtimeÂ·mstart(SB)</span><br><span class="line"></span><br><span class="line">	CALL	runtimeÂ·abort(SB)	<span class="comment">// mstart should never return</span></span><br><span class="line">	RET</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Prevent dead-code elimination of debugCallV2, which is</span></span><br><span class="line">	<span class="comment">// intended to be called by debuggers.</span></span><br><span class="line">	MOVQ	$runtimeÂ·debugCallV2&lt;ABIInternal&gt;(SB), AX</span><br><span class="line">	RET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="â¡ï¸â¡ï¸ğŸ‘‹mstartä½œç”¨"><a class="header-anchor" href="#â¡ï¸â¡ï¸ğŸ‘‹mstartä½œç”¨">Â¶</a>â¡ï¸â¡ï¸<a href="https://blog.imrcrab.com/archives/392d66f0.html#mstart">ğŸ‘‹mstartä½œç”¨</a></h3>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ46ã€chanå¸ƒå±€å’Œè®¾è®¡ã€Œæºç ã€</title>
    <url>/archives/a0547b09.html</url>
    <content><![CDATA[<p>chanåœ¨Goä¸­å¾ˆå¸¸ç”¨ï¼Œå¹³æ—¶ç”¨çš„ä¸å°‘ï¼Œä½†æ˜¯æ€»æ˜¯æ²¡ç”¨çš„å®Œæ•´ï¼Œ<br>
ä¸‹æ¥çœ‹äº†å¤šæ¬¡chanæºç ï¼Œæ€»ç»“è®°å½•ä¸‹ï¼š</p>
<h3 id="ç»“æ„æ–¹é¢"><a class="header-anchor" href="#ç»“æ„æ–¹é¢">Â¶</a>ç»“æ„æ–¹é¢</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/Canvas%201.png" alt=""></p>
<span id="more"></span>
<h3 id="makechanæ–¹é¢"><a class="header-anchor" href="#makechanæ–¹é¢">Â¶</a>makechanæ–¹é¢</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/makechan.png" alt=""></p>
<h3 id="chansendã€Œc-â€œaaaâ€ã€æ¶ˆæ¯å‘é€"><a class="header-anchor" href="#chansendã€Œc-â€œaaaâ€ã€æ¶ˆæ¯å‘é€">Â¶</a>chansendã€Œc&lt;-â€œaaaâ€ã€æ¶ˆæ¯å‘é€</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/chansend.png" alt=""></p>
<h3 id="chanrecv-ã€Œ-cã€-æ¶ˆæ¯æ¶ˆè´¹"><a class="header-anchor" href="#chanrecv-ã€Œ-cã€-æ¶ˆæ¯æ¶ˆè´¹">Â¶</a>chanrecv ã€Œ&lt;-cã€ æ¶ˆæ¯æ¶ˆè´¹</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/chanrecv.png" alt=""></p>
<h3 id="closedè¿‡ç¨‹"><a class="header-anchor" href="#closedè¿‡ç¨‹">Â¶</a>closedè¿‡ç¨‹</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/closed.png" alt=""></p>
<h3 id="summary"><a class="header-anchor" href="#summary">Â¶</a>summary</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/summary.png" alt=""></p>
<h3 id="å¾…æ›´â€¦"><a class="header-anchor" href="#å¾…æ›´â€¦">Â¶</a>å¾…æ›´â€¦</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Day</tag>
        <tag>chan</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ45ã€Go 1.17ç‰¹æ€§</title>
    <url>/archives/5549cd1.html</url>
    <content><![CDATA[<p>Go 1.17ç‰¹æ€§ï¼š</p>
<span id="more"></span>
<h2 id="1ã€ã€Œsliceã€-allow-conversion-from-slice-to-array-ptr"><a class="header-anchor" href="#1ã€ã€Œsliceã€-allow-conversion-from-slice-to-array-ptr">Â¶</a>1ã€ã€Œsliceã€ <a href="https://github.com/golang/go/issues/395">allow conversion from slice to array ptr </a></h2>
<blockquote>
<p>commit: <a href="https://github.com/golang/go/commit/760d3b2a16544aab553ca7ec6e6ed3bf4dc9aa3f">reflect: allow conversion from slice to array ptr</a></p>
</blockquote>
<p>å‚è€ƒï¼š<br>
<a href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoConvertSliceToArray">Go 1.17 will allow converting a slice to an array pointer (some of the time)</a></p>
<h2 id="2ã€ã€Œnetã€-add-IP-IsPrivate"><a class="header-anchor" href="#2ã€ã€Œnetã€-add-IP-IsPrivate">Â¶</a>2ã€ã€Œnetã€  add IP.IsPrivate</h2>
<p><a href="https://go-review.googlesource.com/c/go/+/272668/">ğŸ‘‹â¡ï¸review:</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210424_011546.png" alt=""></p>
<h2 id="3ã€ã€ŒTestã€-add-TB-Setenv"><a class="header-anchor" href="#3ã€ã€ŒTestã€-add-TB-Setenv">Â¶</a>3ã€ã€ŒTestã€ <a href="https://github.com/bynov/go/commit/0ca12fa565318f350b927e2ef94f3b4f792c75c2">add TB.Setenv</a></h2>
<blockquote>
<p>æµ‹è¯•åè¿˜åŸenvå˜é‡ï¼Œä¸èƒ½ç”¨äºå¹¶å‘æµ‹è¯•</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210424_012002.png" alt=""></p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Go_1.17</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ44ã€redis-sdsæºç </title>
    <url>/archives/9989a7c4.html</url>
    <content><![CDATA[<blockquote>
<p>SDSåœ¨redisä¸­ä¹Ÿç®—æ˜¯ç”¨æ¥å­˜å‚¨stringé«˜æ•ˆçš„åšæ³•ï¼Œé‡‡ç”¨header+stringçš„å½¢å¼ã€‚</p>
</blockquote>
<h3 id="å­¦å®Œé¢„æœŸçš„ç›®æ ‡"><a class="header-anchor" href="#å­¦å®Œé¢„æœŸçš„ç›®æ ‡">Â¶</a>å­¦å®Œé¢„æœŸçš„ç›®æ ‡:</h3>
<ul>
<li>SDS ç»“æ„ç±»å‹</li>
<li>SDS ç»“æ„ä¸ºä½•é«˜æ•ˆï¼Ÿ</li>
<li>åˆ›å»ºï¼Ÿ</li>
<li>æ‰©å®¹ï¼Ÿ</li>
<li>é‡Šæ”¾ï¼Ÿ</li>
<li>å¤åˆ¶ï¼Ÿ</li>
<li>Joinè¿æ¥ï¼Ÿ</li>
<li>Resize the allocation ï¼Ÿï¼Ÿ</li>
<li>å…¶å®ƒ</li>
</ul>
<span id="more"></span>
<h3 id="SDSç»“æ„"><a class="header-anchor" href="#SDSç»“æ„">Â¶</a>SDSç»“æ„</h3>
<blockquote>
<p><a href="https://github.com/redis/redis/blob/unstable/src/sds.h#L43">â˜â˜ SDSå®˜æ–¹å®šä¹‰</a></p>
</blockquote>
<blockquote>
<p>âš™ï¸ 4ç§å¤§å°çš„å®šä¹‰ï¼Œé€‚é…ä¸åŒçš„åœºæ™¯éœ€æ±‚ã€‚</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210726_112207.png" alt=""></p>
<h3 id="whyé«˜æ•ˆ"><a class="header-anchor" href="#whyé«˜æ•ˆ">Â¶</a>whyé«˜æ•ˆ?</h3>
<h4 id="è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼šO-1"><a class="header-anchor" href="#è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼šO-1">Â¶</a>è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼šO(1)</h4>
<p>sds: O(1)<br>
cå­—ç¬¦ä¸²ï¼š O(N)</p>
<h4 id="é˜²æ­¢å†…å­˜æº¢å‡º"><a class="header-anchor" href="#é˜²æ­¢å†…å­˜æº¢å‡º">Â¶</a>é˜²æ­¢å†…å­˜æº¢å‡º</h4>
<p>sds: å°è£…å¥½çš„å‡½æ•°ï¼Œæ˜“äºæ“ä½œå’Œæ£€æŸ¥<br>
cå­—ç¬¦ä¸²ï¼šæ“ä½œä¸å½“æ˜“å†…å­˜æº¢å‡º</p>
<h4 id="å†…å­˜åˆ†é…"><a class="header-anchor" href="#å†…å­˜åˆ†é…">Â¶</a>å†…å­˜åˆ†é…</h4>
<p>sds: ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§é‡Šæ”¾<br>
cå­—ç¬¦ä¸²ï¼šæ— æ­¤ç‰¹æ€§</p>
<h4 id="äºŒè¿›åˆ¶å®‰å…¨"><a class="header-anchor" href="#äºŒè¿›åˆ¶å®‰å…¨">Â¶</a>äºŒè¿›åˆ¶å®‰å…¨</h4>
<p>sds: æŒ‰ç…§äºŒè¿›åˆ¶æ–¹å¼å¤„ç†ï¼Œå› æ­¤æ— é™åˆ¶<br>
cå­—ç¬¦ä¸²ï¼šå¿…é¡»ç¬¦åˆç¼–ç ï¼ˆasciiï¼‰ï¼Œé™åˆ¶cä¸­ä¸èƒ½ä¿å­˜å›¾ç‰‡å’ŒéŸ³é¢‘ç­‰</p>
<h3 id="SDS-APIåˆ—è¡¨"><a class="header-anchor" href="#SDS-APIåˆ—è¡¨">Â¶</a>SDS APIåˆ—è¡¨</h3>
<blockquote>
<p>å¾…æ›´æ–°â€¦</p>
</blockquote>
<h3 id="Reference"><a class="header-anchor" href="#Reference">Â¶</a>Reference</h3>
<ul>
<li>
<p><a href="https://github.com/redis/redis/blob/unstable/src/sds.h#L43">â˜ SDSå®˜æ–¹å®šä¹‰</a></p>
</li>
<li>
<p><a href="https://github.com/antirez/sds">ğŸ‘‰ğŸ¿ Simple Dynamic Strings</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Redis</tag>
        <tag>SDS</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ43ã€Redis AOFæŒä¹…åŒ–</title>
    <url>/archives/777dd730.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº:</h3>
<p>AOFå¼€å¯çš„é…ç½®:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">appendonly yes</span><br><span class="line">#appendonly no</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯redisæ ¹æ®è¿™é…ç½®åˆ°åº•æ˜¯å¦‚ä½•å®ç° AOFçš„å‘¢?</p>
<span id="more"></span>
<h3 id="appendOnlyèµ·ç‚¹ï¼š"><a class="header-anchor" href="#appendOnlyèµ·ç‚¹ï¼š">Â¶</a>appendOnlyèµ·ç‚¹ï¼š</h3>
<p>é€šè¿‡config.cé…ç½®æ–‡ä»¶å¯ä»¥æŸ¥åˆ°appendOnlyå¯¹åº”çš„å˜é‡ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">createBoolConfig(<span class="string">&quot;appendonly&quot;</span>, NULL, MODIFIABLE_CONFIG, server.aof_enabled, <span class="number">0</span>, NULL, updateAppendonly)</span><br></pre></td></tr></table></figure>
<h4 id="å…³äºaof-enableä½¿ç”¨åœ°æ–¹ï¼š"><a class="header-anchor" href="#å…³äºaof-enableä½¿ç”¨åœ°æ–¹ï¼š">Â¶</a>å…³äºaof_enableä½¿ç”¨åœ°æ–¹ï¼š</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210318_020243.png" alt=""></p>
<h4 id="å†çœ‹ä¸‹aof-stateä½¿ç”¨åœ°æ–¹ï¼š"><a class="header-anchor" href="#å†çœ‹ä¸‹aof-stateä½¿ç”¨åœ°æ–¹ï¼š">Â¶</a>å†çœ‹ä¸‹aof_stateä½¿ç”¨åœ°æ–¹ï¼š</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210318_020100.png" alt=""></p>
<h3 id="ä¸»è¦æ–¹å‘ï¼š"><a class="header-anchor" href="#ä¸»è¦æ–¹å‘ï¼š">Â¶</a>ä¸»è¦æ–¹å‘ï¼š</h3>
<ul>
<li>aofåœ¨å¯åŠ¨æ—¶å€™åŠ è½½é¡ºåº</li>
<li>aofå­˜æ–‡ä»¶å¦‚ä½•è¢«è§¦å‘æ‰§è¡Œçš„</li>
<li>aofä¿å­˜çš„æœºåˆ¶/åŒæ­¥ç­–ç•¥ï¼Ÿ</li>
<li>aofæœºåˆ¶å’Œrdbæ··ç”¨ï¼Ÿ</li>
<li>aofå¦‚ä½•ä¿æŒè¾ƒé«˜çš„æ€§èƒ½ï¼Ÿ</li>
</ul>
<h4 id="serverå¯åŠ¨ï¼Œaofå¼€å¯ï¼ŒåŠ è½½æµç¨‹ï¼š"><a class="header-anchor" href="#serverå¯åŠ¨ï¼Œaofå¼€å¯ï¼ŒåŠ è½½æµç¨‹ï¼š">Â¶</a>serverå¯åŠ¨ï¼Œaofå¼€å¯ï¼ŒåŠ è½½æµç¨‹ï¼š</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Replay the append log file. On success C_OK is returned. On non fatal</span></span><br><span class="line"><span class="comment"> * error (the append only file is zero-length) C_ERR is returned. On</span></span><br><span class="line"><span class="comment"> * fatal error an error message is logged and the program exists. */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">loadAppendOnlyFile</span><span class="params">(<span class="type">char</span> *filename)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">client</span> *fakeClient;</span><br><span class="line">    FILE *fp = <span class="built_in">fopen</span>(filename,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">redis_stat</span> sb;</span><br><span class="line">    <span class="type">int</span> old_aof_state = server.aof_state;</span><br><span class="line">    <span class="type">long</span> loops = <span class="number">0</span>;</span><br><span class="line">    <span class="type">off_t</span> valid_up_to = <span class="number">0</span>; <span class="comment">/* Offset of latest well-formed command loaded. */</span></span><br><span class="line">    <span class="type">off_t</span> valid_before_multi = <span class="number">0</span>; <span class="comment">/* Offset before MULTI command loaded. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Fatal error: can&#x27;t open the append log file for reading: %s&quot;</span>,<span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle a zero-length AOF file as a special case. An empty AOF file</span></span><br><span class="line"><span class="comment">     * is a valid AOF because an empty server with AOF enabled will create</span></span><br><span class="line"><span class="comment">     * a zero length file at startup, that will remain like that if no write</span></span><br><span class="line"><span class="comment">     * operation is received. */</span></span><br><span class="line">    <span class="keyword">if</span> (fp &amp;&amp; <span class="built_in">redis_fstat</span>(<span class="built_in">fileno</span>(fp),&amp;sb) != <span class="number">-1</span> &amp;&amp; sb.st_size == <span class="number">0</span>) &#123;</span><br><span class="line">        server.aof_current_size = <span class="number">0</span>;</span><br><span class="line">        server.aof_fsync_offset = server.aof_current_size;</span><br><span class="line">        <span class="built_in">fclose</span>(fp);</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Temporarily disable AOF, to prevent EXEC from feeding a MULTI</span></span><br><span class="line"><span class="comment">     * to the same file we&#x27;re about to read. */</span></span><br><span class="line">    server.aof_state = AOF_OFF;</span><br><span class="line">    <span class="comment">// åˆ›å»ºaofå®¢æˆ·ç«¯</span></span><br><span class="line">    fakeClient = <span class="built_in">createAOFClient</span>();</span><br><span class="line">    <span class="comment">//åŠ è½½æ–‡ä»¶</span></span><br><span class="line">    <span class="built_in">startLoadingFile</span>(fp, filename, RDBFLAGS_AOF_PREAMBLE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if this AOF file has an RDB preamble. In that case we need to</span></span><br><span class="line"><span class="comment">     * load the RDB file and later continue loading the AOF tail. */</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥aofå¤´éƒ¨æœ‰æ²¡æœ‰rdbæ ¼å¼çš„å†…å®¹ï¼Œå…ˆåŠ è½½rdbå†åŠ è½½aof</span></span><br><span class="line">    <span class="type">char</span> sig[<span class="number">5</span>]; <span class="comment">/* &quot;REDIS&quot; */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fread</span>(sig,<span class="number">1</span>,<span class="number">5</span>,fp) != <span class="number">5</span> || <span class="built_in">memcmp</span>(sig,<span class="string">&quot;REDIS&quot;</span>,<span class="number">5</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* No RDB preamble, seek back at 0 offset. */</span></span><br><span class="line">        <span class="comment">// æ²¡æœ‰rdbæ ¼å¼çš„ï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fseek</span>(fp,<span class="number">0</span>,SEEK_SET) == <span class="number">-1</span>) <span class="keyword">goto</span> readerr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* RDB preamble. Pass loading the RDB functions. */</span></span><br><span class="line">        rio rdb;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">serverLog</span>(LL_NOTICE,<span class="string">&quot;Reading RDB preamble from AOF file...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fseek</span>(fp,<span class="number">0</span>,SEEK_SET) == <span class="number">-1</span>) <span class="keyword">goto</span> readerr;</span><br><span class="line">        <span class="built_in">rioInitWithFile</span>(&amp;rdb,fp);</span><br><span class="line">        <span class="comment">// åŠ è½½rdbæ ¼å¼çš„æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">rdbLoadRio</span>(&amp;rdb,RDBFLAGS_AOF_PREAMBLE,<span class="literal">NULL</span>) != C_OK) &#123;</span><br><span class="line">            <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Error reading the RDB preamble of the AOF file, AOF loading aborted&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> readerr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">serverLog</span>(LL_NOTICE,<span class="string">&quot;Reading the remaining AOF tail...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read the actual AOF file, in REPL format, command by command. */</span></span><br><span class="line">    <span class="comment">// æŒ‰ç…§aofåè®®æ¥è¯»å–/è§£æaofæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> argc, j;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line">        robj **argv;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">        sds argsds;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">redisCommand</span> *cmd;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Serve the clients from time to time */</span></span><br><span class="line">        <span class="keyword">if</span> (!(loops++ % <span class="number">1000</span>)) &#123;</span><br><span class="line">            <span class="built_in">loadingProgress</span>(<span class="built_in">ftello</span>(fp));</span><br><span class="line">            <span class="built_in">processEventsWhileBlocked</span>();</span><br><span class="line">            <span class="built_in">processModuleLoadingProgressEvent</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fgets</span>(buf,<span class="built_in">sizeof</span>(buf),fp) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">feof</span>(fp))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">goto</span> readerr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (buf[<span class="number">0</span>] != <span class="string">&#x27;*&#x27;</span>) <span class="keyword">goto</span> fmterr;</span><br><span class="line">        <span class="keyword">if</span> (buf[<span class="number">1</span>] == <span class="string">&#x27;\0&#x27;</span>) <span class="keyword">goto</span> readerr;</span><br><span class="line">        argc = <span class="built_in">atoi</span>(buf+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (argc &lt; <span class="number">1</span>) <span class="keyword">goto</span> fmterr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Load the next command in the AOF as our fake client</span></span><br><span class="line"><span class="comment">         * argv. */</span></span><br><span class="line">        argv = <span class="built_in">zmalloc</span>(<span class="built_in">sizeof</span>(robj*)*argc);</span><br><span class="line">        fakeClient-&gt;argc = argc;</span><br><span class="line">        fakeClient-&gt;argv = argv;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; argc; j++) &#123;</span><br><span class="line">            <span class="comment">/* Parse the argument len. */</span></span><br><span class="line">            <span class="type">char</span> *readres = <span class="built_in">fgets</span>(buf,<span class="built_in">sizeof</span>(buf),fp);</span><br><span class="line">            <span class="keyword">if</span> (readres == <span class="literal">NULL</span> || buf[<span class="number">0</span>] != <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">                fakeClient-&gt;argc = j; <span class="comment">/* Free up to j-1. */</span></span><br><span class="line">                <span class="built_in">freeFakeClientArgv</span>(fakeClient);</span><br><span class="line">                <span class="keyword">if</span> (readres == <span class="literal">NULL</span>)</span><br><span class="line">                    <span class="keyword">goto</span> readerr;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">goto</span> fmterr;</span><br><span class="line">            &#125;</span><br><span class="line">            len = <span class="built_in">strtol</span>(buf+<span class="number">1</span>,<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Read it into a string object. */</span></span><br><span class="line">            argsds = <span class="built_in">sdsnewlen</span>(SDS_NOINIT,len);</span><br><span class="line">            <span class="keyword">if</span> (len &amp;&amp; <span class="built_in">fread</span>(argsds,len,<span class="number">1</span>,fp) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">sdsfree</span>(argsds);</span><br><span class="line">                fakeClient-&gt;argc = j; <span class="comment">/* Free up to j-1. */</span></span><br><span class="line">                <span class="built_in">freeFakeClientArgv</span>(fakeClient);</span><br><span class="line">                <span class="keyword">goto</span> readerr;</span><br><span class="line">            &#125;</span><br><span class="line">            argv[j] = <span class="built_in">createObject</span>(OBJ_STRING,argsds);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Discard CRLF. */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">fread</span>(buf,<span class="number">2</span>,<span class="number">1</span>,fp) == <span class="number">0</span>) &#123;</span><br><span class="line">                fakeClient-&gt;argc = j+<span class="number">1</span>; <span class="comment">/* Free up to j. */</span></span><br><span class="line">                <span class="built_in">freeFakeClientArgv</span>(fakeClient);</span><br><span class="line">                <span class="keyword">goto</span> readerr;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Command lookup */</span></span><br><span class="line">        cmd = <span class="built_in">lookupCommand</span>(argv[<span class="number">0</span>]-&gt;ptr);</span><br><span class="line">        <span class="comment">// æœªçŸ¥å‘½ä»¤ï¼Œå¯åŠ¨ç›´æ¥é€€å‡ºäº†</span></span><br><span class="line">        <span class="keyword">if</span> (!cmd) &#123;</span><br><span class="line">            <span class="built_in">serverLog</span>(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Unknown command &#x27;%s&#x27; reading the append only file&quot;</span>,</span><br><span class="line">                (<span class="type">char</span>*)argv[<span class="number">0</span>]-&gt;ptr);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmd == server.multiCommand) valid_before_multi = valid_up_to;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Run the command in the context of a fake client */</span></span><br><span class="line">        fakeClient-&gt;cmd = fakeClient-&gt;lastcmd = cmd;</span><br><span class="line">        <span class="keyword">if</span> (fakeClient-&gt;flags &amp; CLIENT_MULTI &amp;&amp;</span><br><span class="line">            fakeClient-&gt;cmd-&gt;proc != execCommand)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">queueMultiCommand</span>(fakeClient);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cmd-&gt;<span class="built_in">proc</span>(fakeClient);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* The fake client should not have a reply */</span></span><br><span class="line">        <span class="built_in">serverAssert</span>(fakeClient-&gt;bufpos == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     <span class="built_in">listLength</span>(fakeClient-&gt;reply) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* The fake client should never get blocked */</span></span><br><span class="line">        <span class="built_in">serverAssert</span>((fakeClient-&gt;flags &amp; CLIENT_BLOCKED) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Clean up. Command code may have changed argv/argc so we use the</span></span><br><span class="line"><span class="comment">         * argv/argc of the client instead of the local variables. */</span></span><br><span class="line">        <span class="built_in">freeFakeClientArgv</span>(fakeClient);</span><br><span class="line">        fakeClient-&gt;cmd = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (server.aof_load_truncated) valid_up_to = <span class="built_in">ftello</span>(fp);</span><br><span class="line">        <span class="keyword">if</span> (server.key_load_delay)</span><br><span class="line">            <span class="built_in">debugDelay</span>(server.key_load_delay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This point can only be reached when EOF is reached without errors.</span></span><br><span class="line"><span class="comment">     * If the client is in the middle of a MULTI/EXEC, handle it as it was</span></span><br><span class="line"><span class="comment">     * a short read, even if technically the protocol is correct: we want</span></span><br><span class="line"><span class="comment">     * to remove the unprocessed tail and continue. */</span></span><br><span class="line">    <span class="keyword">if</span> (fakeClient-&gt;flags &amp; CLIENT_MULTI) &#123;</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Revert incomplete MULTI/EXEC transaction in AOF file&quot;</span>);</span><br><span class="line">        valid_up_to = valid_before_multi;</span><br><span class="line">        <span class="keyword">goto</span> uxeof;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">loaded_ok: <span class="comment">/* DB loaded, cleanup and return C_OK to the caller. */</span></span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    <span class="built_in">freeFakeClient</span>(fakeClient);</span><br><span class="line">    server.aof_state = old_aof_state;</span><br><span class="line">    <span class="built_in">stopLoading</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">aofUpdateCurrentSize</span>();</span><br><span class="line">    server.aof_rewrite_base_size = server.aof_current_size;</span><br><span class="line">    server.aof_fsync_offset = server.aof_current_size;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">readerr: <span class="comment">/* Read error. If feof(fp) is true, fall through to unexpected EOF. */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">feof</span>(fp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fakeClient) <span class="built_in">freeFakeClient</span>(fakeClient); <span class="comment">/* avoid valgrind warning */</span></span><br><span class="line">        <span class="built_in">fclose</span>(fp);</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Unrecoverable error reading the append only file: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">uxeof: <span class="comment">/* Unexpected AOF end of file. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.aof_load_truncated) &#123;</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;!!! Warning: short read while loading the AOF file !!!&quot;</span>);</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;!!! Truncating the AOF at offset %llu !!!&quot;</span>,</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) valid_up_to);</span><br><span class="line">        <span class="keyword">if</span> (valid_up_to == <span class="number">-1</span> || <span class="built_in">truncate</span>(filename,valid_up_to) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (valid_up_to == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Last valid command offset is invalid&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Error truncating the AOF file: %s&quot;</span>,</span><br><span class="line">                    <span class="built_in">strerror</span>(errno));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* Make sure the AOF file descriptor points to the end of the</span></span><br><span class="line"><span class="comment">             * file after the truncate call. */</span></span><br><span class="line">            <span class="keyword">if</span> (server.aof_fd != <span class="number">-1</span> &amp;&amp; <span class="built_in">lseek</span>(server.aof_fd,<span class="number">0</span>,SEEK_END) == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Can&#x27;t seek the end of the AOF file: %s&quot;</span>,</span><br><span class="line">                    <span class="built_in">strerror</span>(errno));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">serverLog</span>(LL_WARNING,</span><br><span class="line">                    <span class="string">&quot;AOF loaded anyway because aof-load-truncated is enabled&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> loaded_ok;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fakeClient) <span class="built_in">freeFakeClient</span>(fakeClient); <span class="comment">/* avoid valgrind warning */</span></span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Unexpected end of file reading the append only file. You can: 1) Make a backup of your AOF file, then use ./redis-check-aof --fix &lt;filename&gt;. 2) Alternatively you can set the &#x27;aof-load-truncated&#x27; configuration option to yes and restart the server.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">fmterr: <span class="comment">/* Format error. */</span></span><br><span class="line">    <span class="keyword">if</span> (fakeClient) <span class="built_in">freeFakeClient</span>(fakeClient); <span class="comment">/* avoid valgrind warning */</span></span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix &lt;filename&gt;&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="æµç¨‹å›¾ï¼š"><a class="header-anchor" href="#æµç¨‹å›¾ï¼š">Â¶</a>æµç¨‹å›¾ï¼š</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210318_032504.png" alt=""></p>
<h4 id="aofè§¦å‘æµç¨‹ï¼š"><a class="header-anchor" href="#aofè§¦å‘æµç¨‹ï¼š">Â¶</a>aofè§¦å‘æµç¨‹ï¼š</h4>
<p>å‚ç…§å‰é¢çš„æ–¹æ³•ï¼Œå…ˆæ‰¾åˆ°appendfsyncå¯¹åº”çš„å˜é‡ï¼Œç„¶åçœ‹ä½¿ç”¨åœºæ™¯ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">createEnumConfig</span>(<span class="string">&quot;appendfsync&quot;</span>, <span class="literal">NULL</span>, MODIFIABLE_CONFIG, aof_fsync_enum, server.aof_fsync, AOF_FSYNC_EVERYSEC, <span class="literal">NULL</span>, <span class="literal">NULL</span>),</span><br></pre></td></tr></table></figure>
<h5 id="appendfsyncå–å€¼"><a class="header-anchor" href="#appendfsyncå–å€¼">Â¶</a>appendfsyncå–å€¼</h5>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">configEnum aof_fsync_enum[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;everysec&quot;</span>, AOF_FSYNC_EVERYSEC&#125;, æ¯ç§’</span><br><span class="line">    &#123;<span class="string">&quot;always&quot;</span>, AOF_FSYNC_ALWAYS&#125;, æ¯ä¸ªæ“ä½œ</span><br><span class="line">    &#123;<span class="string">&quot;no&quot;</span>, AOF_FSYNC_NO&#125;, ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶åŒæ­¥</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="aof-fsync-enumå“ªé‡Œç”¨åˆ°äº†ï¼Ÿ"><a class="header-anchor" href="#aof-fsync-enumå“ªé‡Œç”¨åˆ°äº†ï¼Ÿ">Â¶</a>aof_fsync_enumå“ªé‡Œç”¨åˆ°äº†ï¼Ÿ</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210318_041746.png" alt=""></p>
<h5 id="æµç¨‹å›¾"><a class="header-anchor" href="#æµç¨‹å›¾">Â¶</a>æµç¨‹å›¾:</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/redis-2021-3-18-22-38.png" alt=""></p>
<h4 id="aofå’ŒRDBæ··ç”¨çš„æƒ…å†µ"><a class="header-anchor" href="#aofå’ŒRDBæ··ç”¨çš„æƒ…å†µ">Â¶</a>aofå’ŒRDBæ··ç”¨çš„æƒ…å†µ</h4>
<h5 id="é…ç½®é¡¹"><a class="header-anchor" href="#é…ç½®é¡¹">Â¶</a>é…ç½®é¡¹:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">aof-use-rdb-preamble  <span class="literal">true</span>/<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">config.cé…ç½®:</span><br><span class="line"></span><br><span class="line">createBoolConfig(<span class="string">&quot;aof-use-rdb-preamble&quot;</span>, NULL, MODIFIABLE_CONFIG, server.aof_use_rdb_preamble, <span class="number">1</span>, NULL, NULL),</span><br></pre></td></tr></table></figure>
<h5 id="æµç¨‹å›¾-v2"><a class="header-anchor" href="#æµç¨‹å›¾-v2">Â¶</a>æµç¨‹å›¾:</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/redis-2021-03-21-23-34.png" alt=""></p>
<h4 id="aofæ–‡ä»¶å¦‚ä½•â€œé«˜æ•ˆâ€æŒä¹…åŒ–"><a class="header-anchor" href="#aofæ–‡ä»¶å¦‚ä½•â€œé«˜æ•ˆâ€æŒä¹…åŒ–">Â¶</a>aofæ–‡ä»¶å¦‚ä½•â€œé«˜æ•ˆâ€æŒä¹…åŒ–</h4>
<h5 id="å¦‚ä½•æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Ÿã€ŒflushAppendOnlyFileã€"><a class="header-anchor" href="#å¦‚ä½•æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Ÿã€ŒflushAppendOnlyFileã€">Â¶</a>å¦‚ä½•æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Ÿã€ŒflushAppendOnlyFileã€</h5>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">flushAppendOnlyFileå‡½æ•°</span><br><span class="line"></span><br><span class="line">è¯´æ˜ï¼š</span><br><span class="line"></span><br><span class="line"> Write the append only file buffer on disk.</span><br></pre></td></tr></table></figure>
<h5 id="æµç¨‹å›¾ï¼š-v2"><a class="header-anchor" href="#æµç¨‹å›¾ï¼š-v2">Â¶</a>æµç¨‹å›¾ï¼š</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/acsz8-d5ehw.webp" alt=""></p>
<h4 id="AOF-APPEND-ONLYæ•°æ®é‡è¿‡å¤§"><a class="header-anchor" href="#AOF-APPEND-ONLYæ•°æ®é‡è¿‡å¤§">Â¶</a>AOF APPEND ONLYæ•°æ®é‡è¿‡å¤§</h4>
<blockquote>
<p>é€šè¿‡æºç å…ˆçœ‹çœ‹æµç¨‹ï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/2022/redis-rewriteAppendOnlyfile.png" alt=""></p>
<h3 id="Tips-And-Tricks"><a class="header-anchor" href="#Tips-And-Tricks">Â¶</a>Tips And Tricks</h3>
<h4 id="AOFæ•°æ®é‡è¿‡å¤§é—®é¢˜"><a class="header-anchor" href="#AOFæ•°æ®é‡è¿‡å¤§é—®é¢˜">Â¶</a>AOFæ•°æ®é‡è¿‡å¤§é—®é¢˜</h4>
<h3 id="Todo"><a class="header-anchor" href="#Todo">Â¶</a>Todo</h3>
<ul>
<li><input type="checkbox" id="checkbox0"><label for="checkbox0">[aofå’Œrdbå¤šç»´åº¦æ¯”è¾ƒ]</label></li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1">[AOFæ•°æ®é‡è¿‡å¤§é—®é¢˜]</label></li>
</ul>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ42ã€Git Logå¸¸ç”¨åœºæ™¯</title>
    <url>/archives/a02f04ba.html</url>
    <content><![CDATA[<h2 id="å‰åºï¼š"><a class="header-anchor" href="#å‰åºï¼š">Â¶</a>å‰åºï¼š</h2>
<p>å‰é¢æœ‰æ€»ç»“è¿‡<a href="https://blog.imrcrab.com/archives/3c1dd822.html">Gitå¸¸ç”¨çš„ä¸€äº›æ“ä½œ</a></p>
<p>æœ€è¿‘æœ‰å¾ˆå¤šä½¿ç”¨åˆ°git log â€“ çš„å‘½ä»¤å’Œéœ€æ±‚ï¼Œæ‰€ä»¥æ¥ææè¿™ä¸ªgit logçš„ç”¨æ³•:</p>
<span id="more"></span>
<h2 id="git-logå‘½ä»¤åŸºæœ¬ä½¿ç”¨ï¼š"><a class="header-anchor" href="#git-logå‘½ä»¤åŸºæœ¬ä½¿ç”¨ï¼š">Â¶</a>git logå‘½ä»¤åŸºæœ¬ä½¿ç”¨ï¼š</h2>
<blockquote>
<p>è¿™é‡Œç”¨goä»“åº“çš„logæ¥æ¼”ç¤ºå’Œå­¦ä¹ logç›¸å…³æ“ä½œã€‚</p>
</blockquote>
<h3 id="ç‰ˆæœ¬ï¼š"><a class="header-anchor" href="#ç‰ˆæœ¬ï¼š">Â¶</a>ç‰ˆæœ¬ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">$ git version</span><br><span class="line">git version <span class="number">2.24</span><span class="number">.3</span> (Apple Git<span class="number">-128</span>)</span><br></pre></td></tr></table></figure>
<h3 id="å¸¸ç”¨åŠå±•ç¤ºï¼š"><a class="header-anchor" href="#å¸¸ç”¨åŠå±•ç¤ºï¼š">Â¶</a>å¸¸ç”¨åŠå±•ç¤ºï¼š</h3>
<h4 id="git-log-help"><a class="header-anchor" href="#git-log-help">Â¶</a>git log --help</h4>
<blockquote>
<p>æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•ã€Œåˆ’é‡ç‚¹ã€ï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_010044.png" alt=""></p>
<p><strong>å›¾ä¸­optionåœ°æ–¹ä¸ºå¯é€‰çš„é…ç½®é¡¹</strong></p>
<h4 id="git-log"><a class="header-anchor" href="#git-log">Â¶</a>git log</h4>
<blockquote>
<p>ç»„æˆéƒ¨åˆ†ï¼š</p>
</blockquote>
<ul>
<li>commit ID</li>
<li>author</li>
<li>date</li>
<li>commit message</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_125518.png" alt=""></p>
<h4 id="git-log-s"><a class="header-anchor" href="#git-log-s">Â¶</a>git log --s***</h4>
<blockquote>
<p>git log --s ç„¶åæŒ‰tabå»ºå°±å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„ä¿¡æ¯ï¼Œ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git log --s</span><br><span class="line">--shortstat               -- generate summary diffstat</span><br><span class="line">--show-linear-break       -- show a barrier between commits from different branches</span><br><span class="line">--show-signature          -- validate GPG signature of commit</span><br><span class="line">--simplify-by-decoration  -- show only commits that are referenced by a ref</span><br><span class="line">--simplify-merges         -- milder version of --full-history</span><br><span class="line">--since                   -- show commits more recent than given date</span><br><span class="line">--single-worktree         -- examine the current working tree only</span><br><span class="line">--skip                    -- skip given number of commits before output</span><br><span class="line">--source                  -- show which ref each commit is reached from</span><br><span class="line">--sparse                  -- when paths are given, display only commits that changes any of them</span><br><span class="line">--src-prefix              -- use given prefix for source</span><br><span class="line">--stat                    -- generate diffstat instead of patch</span><br><span class="line">--stdin                   -- additionally read commits from standard input</span><br><span class="line">--submodule               -- select output format for submodule differences</span><br><span class="line">--summary                 -- generate condensed summary of extended header information</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="git-log-stat"><a class="header-anchor" href="#git-log-stat">Â¶</a>git log --stat</h5>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°diffçš„æ–‡ä»¶ä¿¡æ¯<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_010656.png" alt=""></p>
</blockquote>
<h4 id="git-log-pretty"><a class="header-anchor" href="#git-log-pretty">Â¶</a>git log --pretty=?</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¸‹é¢å‘½ä»¤æŒ‰ä¸‹tabè‡ªåŠ¨è¡¥å…¨çš„ä¿¡æ¯ï¼š</span><br><span class="line">$ git log --pretty= </span><br><span class="line">email    -- use email headers like From and Subject</span><br><span class="line">format   -- specify own format</span><br><span class="line">full     -- all parts of commit messages</span><br><span class="line">fuller   -- like full and includes dates</span><br><span class="line">medium   -- most parts of messages</span><br><span class="line">oneline  -- commit-ids and subject of messages</span><br><span class="line">raw      -- the raw commits</span><br><span class="line">short    -- few headers and only subject of messages</span><br></pre></td></tr></table></figure>
<h5 id="git-log-pretty-fuller"><a class="header-anchor" href="#git-log-pretty-fuller">Â¶</a>git log --pretty=fuller</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_011529.png" alt=""></p>
<h4 id="git-log-author"><a class="header-anchor" href="#git-log-author">Â¶</a>git log --author=?</h4>
<blockquote>
<p>git log --author=â€œAlex Brainmanâ€</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_011728.png" alt=""></p>
<h4 id="åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ‰€æœ‰åŸºæœ¬ä¿¡æ¯ï¼š"><a class="header-anchor" href="#åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ‰€æœ‰åŸºæœ¬ä¿¡æ¯ï¼š">Â¶</a>åˆå¹¶åœ¨ä¸€èµ·ï¼Œæ‰€æœ‰åŸºæœ¬ä¿¡æ¯ï¼š</h4>
<blockquote>
<p>git log --author=â€œAlex Brainmanâ€ --stat --graph --tags --pretty=oneline --decorate</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_012016.png" alt=""></p>
<h4 id="æŸä¸ªæ–‡ä»¶çš„log"><a class="header-anchor" href="#æŸä¸ªæ–‡ä»¶çš„log">Â¶</a>æŸä¸ªæ–‡ä»¶çš„log</h4>
<blockquote>
<p>æŸ¥çœ‹æ‰€æœ‰src/runtimeæ–‡ä»¶å¤¹çš„å…·ä½“æäº¤ä¿¡æ¯</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log  --stat --graph --tags --pretty=oneline --decorate src/runtime/</span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_012342.png" alt=""></p>
<h5 id="pretty-fullerå’Œpretty-onelineçš„åŒºåˆ«ï¼š"><a class="header-anchor" href="#pretty-fullerå’Œpretty-onelineçš„åŒºåˆ«ï¼š">Â¶</a>pretty=fullerå’Œpretty=onelineçš„åŒºåˆ«ï¼š</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_012556.png" alt=""></p>
<h4 id="git-log-before-after"><a class="header-anchor" href="#git-log-before-after">Â¶</a>git log --before=*** --after=***</h4>
<blockquote>
<p>pretty: oneline VS fuller</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log  --stat --graph --tags --pretty=oneline --before=&quot;2021-03-09&quot; --after=&quot;2020-03-10&quot;  --decorate src/runtime/</span><br><span class="line"></span><br><span class="line">git log  --stat --graph --tags --pretty=fuller --before=&quot;2021-03-09&quot; --after=&quot;2020-03-10&quot; --decorate src/runtime/</span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210309_013157.png" alt=""></p>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Git</tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ41ã€å…³äºgoä¸­ _ [å¿½ç•¥]çš„ä½¿ç”¨</title>
    <url>/archives/9af9679c.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº:</h3>
<ul>
<li>å‰æ®µæ—¶é—´çœ‹äº†è¿™ä¹ˆä¸ªé—®é¢˜,è¾“å‡ºæ˜¯what?:</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="built_in">println</span>(fff(<span class="number">1</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fff</span><span class="params">(x <span class="type">int</span>)</span></span> (_, __ <span class="type">int</span>) &#123;</span><br><span class="line">	_, __ = x, x</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="ç»“æœåˆ†æ"><a class="header-anchor" href="#ç»“æœåˆ†æ">Â¶</a>ç»“æœåˆ†æ</h3>
<h4 id="outpus"><a class="header-anchor" href="#outpus">Â¶</a>outpus:</h4>
<blockquote>
<p>0 1</p>
</blockquote>
<h4 id="æ±‡ç¼–åˆ†æ"><a class="header-anchor" href="#æ±‡ç¼–åˆ†æ">Â¶</a>æ±‡ç¼–åˆ†æ:</h4>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line">â–¶ go tool compile -N -l -S signore.go </span><br><span class="line"><span class="string">&quot;&quot;</span>.main STEXT size=<span class="number">158</span> args=<span class="number">0x0</span> locals=<span class="number">0x40</span> funcid=<span class="number">0x0</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (signore.go:<span class="number">3</span>)     TEXT    <span class="string">&quot;&quot;</span>.main(SB), ABIInternal, $<span class="number">64</span><span class="number">-0</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (signore.go:<span class="number">3</span>)     MOVQ    (TLS), CX</span><br><span class="line">        <span class="number">0x0009</span> <span class="number">00009</span> (signore.go:<span class="number">3</span>)     CMPQ    SP, <span class="number">16</span>(CX)</span><br><span class="line">        <span class="number">0x000d</span> <span class="number">00013</span> (signore.go:<span class="number">3</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-2</span></span><br><span class="line">        <span class="number">0x000d</span> <span class="number">00013</span> (signore.go:<span class="number">3</span>)     JLS     <span class="number">148</span></span><br><span class="line">        <span class="number">0x0013</span> <span class="number">00019</span> (signore.go:<span class="number">3</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x0013</span> <span class="number">00019</span> (signore.go:<span class="number">3</span>)     SUBQ    $<span class="number">64</span>, SP</span><br><span class="line">        <span class="number">0x0017</span> <span class="number">00023</span> (signore.go:<span class="number">3</span>)     MOVQ    BP, <span class="number">56</span>(SP)</span><br><span class="line">        <span class="number">0x001c</span> <span class="number">00028</span> (signore.go:<span class="number">3</span>)     LEAQ    <span class="number">56</span>(SP), BP</span><br><span class="line">        <span class="number">0x0021</span> <span class="number">00033</span> (signore.go:<span class="number">3</span>)     FUNCDATA        $<span class="number">0</span>, gclocalsÂ·<span class="number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)</span><br><span class="line">        <span class="number">0x0021</span> <span class="number">00033</span> (signore.go:<span class="number">3</span>)     FUNCDATA        $<span class="number">1</span>, gclocalsÂ·<span class="number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)</span><br><span class="line">        <span class="number">0x0021</span> <span class="number">00033</span> (signore.go:<span class="number">4</span>)     MOVQ    $<span class="number">1</span>, (SP)</span><br><span class="line">        <span class="number">0x0029</span> <span class="number">00041</span> (signore.go:<span class="number">4</span>)     PCDATA  $<span class="number">1</span>, $<span class="number">0</span></span><br><span class="line">        <span class="number">0x0029</span> <span class="number">00041</span> (signore.go:<span class="number">4</span>)     CALL    <span class="string">&quot;&quot;</span>.fff(SB)</span><br><span class="line">        <span class="number">0x002e</span> <span class="number">00046</span> (signore.go:<span class="number">4</span>)     MOVQ    <span class="number">8</span>(SP), AX</span><br><span class="line">        <span class="number">0x0033</span> <span class="number">00051</span> (signore.go:<span class="number">4</span>)     MOVQ    <span class="number">16</span>(SP), CX</span><br><span class="line">        <span class="number">0x0038</span> <span class="number">00056</span> (signore.go:<span class="number">4</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_2+<span class="number">32</span>(SP)</span><br><span class="line">        <span class="number">0x003d</span> <span class="number">00061</span> (signore.go:<span class="number">4</span>)     MOVQ    CX, <span class="string">&quot;&quot;</span>..autotmp_3+<span class="number">24</span>(SP)</span><br><span class="line">        <span class="number">0x0042</span> <span class="number">00066</span> (signore.go:<span class="number">4</span>)     MOVQ    <span class="string">&quot;&quot;</span>..autotmp_2+<span class="number">32</span>(SP), AX</span><br><span class="line">        <span class="number">0x0047</span> <span class="number">00071</span> (signore.go:<span class="number">4</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_0+<span class="number">48</span>(SP)</span><br><span class="line">        <span class="number">0x004c</span> <span class="number">00076</span> (signore.go:<span class="number">4</span>)     MOVQ    <span class="string">&quot;&quot;</span>..autotmp_3+<span class="number">24</span>(SP), AX</span><br><span class="line">        <span class="number">0x0051</span> <span class="number">00081</span> (signore.go:<span class="number">4</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_1+<span class="number">40</span>(SP)</span><br><span class="line">        <span class="number">0x0056</span> <span class="number">00086</span> (signore.go:<span class="number">4</span>)     CALL    runtime.printlock(SB)</span><br><span class="line">        <span class="number">0x005b</span> <span class="number">00091</span> (signore.go:<span class="number">4</span>)     MOVQ    <span class="string">&quot;&quot;</span>..autotmp_0+<span class="number">48</span>(SP), AX</span><br><span class="line">        <span class="number">0x0060</span> <span class="number">00096</span> (signore.go:<span class="number">4</span>)     MOVQ    AX, (SP)</span><br><span class="line">        <span class="number">0x0064</span> <span class="number">00100</span> (signore.go:<span class="number">4</span>)     CALL    runtime.printint(SB)</span><br><span class="line">        <span class="number">0x0069</span> <span class="number">00105</span> (signore.go:<span class="number">4</span>)     CALL    runtime.printsp(SB)</span><br><span class="line">        <span class="number">0x006e</span> <span class="number">00110</span> (signore.go:<span class="number">4</span>)     MOVQ    <span class="string">&quot;&quot;</span>..autotmp_1+<span class="number">40</span>(SP), AX</span><br><span class="line">        <span class="number">0x0073</span> <span class="number">00115</span> (signore.go:<span class="number">4</span>)     MOVQ    AX, (SP)</span><br><span class="line">        <span class="number">0x0077</span> <span class="number">00119</span> (signore.go:<span class="number">4</span>)     CALL    runtime.printint(SB)</span><br><span class="line">        <span class="number">0x007c</span> <span class="number">00124</span> (signore.go:<span class="number">4</span>)     NOP</span><br><span class="line">        <span class="number">0x0080</span> <span class="number">00128</span> (signore.go:<span class="number">4</span>)     CALL    runtime.printnl(SB)</span><br><span class="line">        <span class="number">0x0085</span> <span class="number">00133</span> (signore.go:<span class="number">4</span>)     CALL    runtime.printunlock(SB)</span><br><span class="line">        <span class="number">0x008a</span> <span class="number">00138</span> (signore.go:<span class="number">5</span>)     MOVQ    <span class="number">56</span>(SP), BP</span><br><span class="line">        <span class="number">0x008f</span> <span class="number">00143</span> (signore.go:<span class="number">5</span>)     ADDQ    $<span class="number">64</span>, SP</span><br><span class="line">        <span class="number">0x0093</span> <span class="number">00147</span> (signore.go:<span class="number">5</span>)     RET</span><br><span class="line">        <span class="number">0x0094</span> <span class="number">00148</span> (signore.go:<span class="number">5</span>)     NOP</span><br><span class="line">        <span class="number">0x0094</span> <span class="number">00148</span> (signore.go:<span class="number">3</span>)     PCDATA  $<span class="number">1</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x0094</span> <span class="number">00148</span> (signore.go:<span class="number">3</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-2</span></span><br><span class="line">        <span class="number">0x0094</span> <span class="number">00148</span> (signore.go:<span class="number">3</span>)     CALL    runtime.morestack_noctxt(SB)</span><br><span class="line">        <span class="number">0x0099</span> <span class="number">00153</span> (signore.go:<span class="number">3</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x0099</span> <span class="number">00153</span> (signore.go:<span class="number">3</span>)     JMP     <span class="number">0</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">65</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">0</span>c <span class="number">25</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">3b</span> <span class="number">61</span> <span class="number">10</span> <span class="number">0f</span> <span class="number">86</span> <span class="number">81</span>  eH..%....H;a....</span><br><span class="line">        <span class="number">0x0010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">83</span> ec <span class="number">40</span> <span class="number">48</span> <span class="number">89</span> <span class="number">6</span>c <span class="number">24</span> <span class="number">38</span> <span class="number">48</span> <span class="number">8</span>d <span class="number">6</span>c <span class="number">24</span>  ...H..@H.l$<span class="number">8</span>H.l$</span><br><span class="line">        <span class="number">0x0020</span> <span class="number">38</span> <span class="number">48</span> c7 <span class="number">04</span> <span class="number">24</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">8b</span>  <span class="number">8</span>H..$.........H.</span><br><span class="line">        <span class="number">0x0030</span> <span class="number">44</span> <span class="number">24</span> <span class="number">08</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">4</span>c <span class="number">24</span> <span class="number">10</span> <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">20</span> <span class="number">48</span> <span class="number">89</span> <span class="number">4</span>c  D$.H.L$.H.D$ H.L</span><br><span class="line">        <span class="number">0x0040</span> <span class="number">24</span> <span class="number">18</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">44</span> <span class="number">24</span> <span class="number">20</span> <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">30</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">44</span> <span class="number">24</span>  $.H.D$ H.D$<span class="number">0</span>H.D$</span><br><span class="line">        <span class="number">0x0050</span> <span class="number">18</span> <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">28</span> e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">44</span> <span class="number">24</span> <span class="number">30</span>  .H.D$(.....H.D$<span class="number">0</span></span><br><span class="line">        <span class="number">0x0060</span> <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">24</span> e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">8b</span>  H..$..........H.</span><br><span class="line">        <span class="number">0x0070</span> <span class="number">44</span> <span class="number">24</span> <span class="number">28</span> <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">24</span> e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0f</span> <span class="number">1f</span> <span class="number">40</span> <span class="number">00</span>  D$(H..$.......@.</span><br><span class="line">        <span class="number">0x0080</span> e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">6</span>c <span class="number">24</span> <span class="number">38</span> <span class="number">48</span>  ..........H.l$<span class="number">8</span>H</span><br><span class="line">        <span class="number">0x0090</span> <span class="number">83</span> c4 <span class="number">40</span> c3 e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> e9 <span class="number">62</span> ff ff ff        ..@.......b...</span><br><span class="line">        rel <span class="number">5</span>+<span class="number">4</span> t=<span class="number">17</span> TLS+<span class="number">0</span></span><br><span class="line">        rel <span class="number">42</span>+<span class="number">4</span> t=<span class="number">8</span> <span class="string">&quot;&quot;</span>.fff+<span class="number">0</span></span><br><span class="line">        rel <span class="number">87</span>+<span class="number">4</span> t=<span class="number">8</span> runtime.printlock+<span class="number">0</span></span><br><span class="line">        rel <span class="number">101</span>+<span class="number">4</span> t=<span class="number">8</span> runtime.printint+<span class="number">0</span></span><br><span class="line">        rel <span class="number">106</span>+<span class="number">4</span> t=<span class="number">8</span> runtime.printsp+<span class="number">0</span></span><br><span class="line">        rel <span class="number">120</span>+<span class="number">4</span> t=<span class="number">8</span> runtime.printint+<span class="number">0</span></span><br><span class="line">        rel <span class="number">129</span>+<span class="number">4</span> t=<span class="number">8</span> runtime.printnl+<span class="number">0</span></span><br><span class="line">        rel <span class="number">134</span>+<span class="number">4</span> t=<span class="number">8</span> runtime.printunlock+<span class="number">0</span></span><br><span class="line">        rel <span class="number">149</span>+<span class="number">4</span> t=<span class="number">8</span> runtime.morestack_noctxt+<span class="number">0</span></span><br><span class="line"><span class="string">&quot;&quot;</span>.fff STEXT nosplit size=<span class="number">29</span> args=<span class="number">0x18</span> locals=<span class="number">0x0</span> funcid=<span class="number">0x0</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (signore.go:<span class="number">7</span>)     TEXT    <span class="string">&quot;&quot;</span>.fff(SB), NOSPLIT|ABIInternal, $<span class="number">0</span><span class="number">-24</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (signore.go:<span class="number">7</span>)     FUNCDATA        $<span class="number">0</span>, gclocalsÂ·<span class="number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)</span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (signore.go:<span class="number">7</span>)     FUNCDATA        $<span class="number">1</span>, gclocalsÂ·<span class="number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)</span><br><span class="line">        <span class="comment">// ***è¿™ä¸ª [~b]å¾ˆå…³é”®,åˆ’é‡ç‚¹</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (signore.go:<span class="number">7</span>)     MOVQ    $<span class="number">0</span>, <span class="string">&quot;&quot;</span>.~b1+<span class="number">16</span>(SP) </span><br><span class="line">        <span class="number">0x0009</span> <span class="number">00009</span> (signore.go:<span class="number">7</span>)     MOVQ    $<span class="number">0</span>, <span class="string">&quot;&quot;</span>.__+<span class="number">24</span>(SP)</span><br><span class="line">        <span class="number">0x0012</span> <span class="number">00018</span> (signore.go:<span class="number">8</span>)     MOVQ    <span class="string">&quot;&quot;</span>.x+<span class="number">8</span>(SP), AX</span><br><span class="line">        <span class="number">0x0017</span> <span class="number">00023</span> (signore.go:<span class="number">8</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>.__+<span class="number">24</span>(SP)</span><br><span class="line">        <span class="number">0x001c</span> <span class="number">00028</span> (signore.go:<span class="number">9</span>)     RET</span><br><span class="line">        <span class="number">0x0000</span> <span class="number">48</span> c7 <span class="number">44</span> <span class="number">24</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> c7 <span class="number">44</span> <span class="number">24</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span>  H.D$.....H.D$...</span><br><span class="line">        <span class="number">0x0010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">44</span> <span class="number">24</span> <span class="number">08</span> <span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">18</span> c3           ..H.D$.H.D$..</span><br><span class="line">go.cuinfo.packagename. SDWARFCUINFO dupok size=<span class="number">0</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">6</span>d <span class="number">61</span> <span class="number">69</span> <span class="number">6</span>e                                      main</span><br><span class="line"><span class="string">&quot;&quot;</span>..inittask SNOPTRDATA size=<span class="number">24</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ................</span><br><span class="line">        <span class="number">0x0010</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                          ........</span><br><span class="line">gclocalsÂ·<span class="number">33</span>cdeccccebe80329f1fdbee7f5874cb SRODATA dupok size=<span class="number">8</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                          ........</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ä¸ºä½•-å°±å¯ä»¥å¿½ç•¥è¿”å›å€¼å‘¢"><a class="header-anchor" href="#ä¸ºä½•-å°±å¯ä»¥å¿½ç•¥è¿”å›å€¼å‘¢">Â¶</a>ä¸ºä½• _ å°±å¯ä»¥å¿½ç•¥è¿”å›å€¼å‘¢?</h4>
<blockquote>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/cmd/compile/internal/gc/dcl.go#L426">å®˜æ–¹æ–‡æ¡£</a></p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210302_095628.png" alt=""></p>
<h4 id="è°ƒç”¨æ–¹"><a class="header-anchor" href="#è°ƒç”¨æ–¹">Â¶</a>è°ƒç”¨æ–¹:</h4>
<ul>
<li>dcl ã€Œå‚æ•°ã€</li>
<li>import ã€Œå¯¼å…¥ã€</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210302_100643.png" alt=""></p>
<h5 id="å†å‘ä¸Š"><a class="header-anchor" href="#å†å‘ä¸Š">Â¶</a>å†å‘ä¸Š:</h5>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/cmd/compile/internal/gc/reflect.go#L1290">â€“&gt;genhash</a></p>
<h5 id="å†å‘ä¸Š-v2"><a class="header-anchor" href="#å†å‘ä¸Š-v2">Â¶</a>å†å‘ä¸Š:</h5>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/cmd/compile/internal/gc/pgen.go#L228">â€”&gt;compile</a></p>
<h5 id="start"><a class="header-anchor" href="#start">Â¶</a>start:</h5>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/cmd/compile/internal/gc/main.go#L714">â€”&gt;gc.main</a></p>
<blockquote>
<p>æœ‰æ„æ€çš„ç‚¹: gc.mainéœ€è¦9æ­¥,ç¼–è¯‘åœ¨ç¬¬8æ­¥äº†,å‰é¢çš„æœ‰å…´è¶£å¯è‡ªå·±çœ‹çœ‹.</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210302_101636.png" alt=""></p>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ40ã€Quick Sort Plusä¹‹é€šç”¨æ¨¡ç‰ˆ</title>
    <url>/archives/359bb4b6.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº:</h3>
<p><a href="https://blog.imrcrab.com/archives/aa75061e.html">ã€Œ37ã€Quick Sortå¿«é€Ÿæ’åº</a>åˆ†æè¿‡å¿«é€Ÿæ’åº,ä¹‹å‰æœ‰ä¸ªé—®é¢˜ä¸€ç›´æ˜¯ä¸ªç—›ç‚¹:<br>
è‡ªå®šä¹‰ç»“æ„ä½“æ’åºè¿‡ç¨‹ä¸­,è¿˜æ˜¯è¦å†™ä¸å°‘é€»è¾‘åˆ¤æ–­ä»£ç ,å¯ä»¥å†æŠ½è±¡ç‚¹ä¹ˆ?<br>
ç”¨æœ€å°‘çš„ä»£ç ,å®Œå…¨å®ç°ç»“æ„ä½“æŒ‰ç…§ä¸é€šçš„å­—æ®µè¿›è¡Œæ’åº.</p>
<span id="more"></span>
<p><a href="https://blog.imrcrab.com/archives/aa75061e.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%E5%81%9A%E6%B3%95%EF%BC%9A">ã€Œ37èŠ‚ã€è‡ªå®šä¹‰æ’åºåšæ³•:</a></p>
<h3 id="æ–¹æ¡ˆè®¾æƒ³"><a class="header-anchor" href="#æ–¹æ¡ˆè®¾æƒ³">Â¶</a>æ–¹æ¡ˆè®¾æƒ³:</h3>
<ul>
<li>1ã€åˆ©ç”¨reflectåå°„,ä¼ å…¥å¤šä¸ªå­—æ®µçš„åç§°,</li>
<li>2ã€æ¯ä¸ªå­—æ®µæŒ‡å®šå‡åºæˆ–è€…é™åº.</li>
<li>3ã€æä¾›å‡åºæˆ–è€…é™åº.</li>
</ul>
<h4 id="coding"><a class="header-anchor" href="#coding">Â¶</a>coding:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QuickSortAll</span><span class="params">(a []<span class="keyword">interface</span>&#123;&#125;, left, right <span class="type">int</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) []<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">if</span> left &lt; right &#123;</span><br><span class="line">		mid := partitionAll(a, left, right, By)</span><br><span class="line">		QuickSortAll(a, left, mid<span class="number">-1</span>, By)</span><br><span class="line">		QuickSortAll(a, mid+<span class="number">1</span>, right, By)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">partitionAll</span><span class="params">(a []<span class="keyword">interface</span>&#123;&#125;, left <span class="type">int</span>, right <span class="type">int</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) <span class="type">int</span> &#123;</span><br><span class="line">	pivot := a[left]</span><br><span class="line">	<span class="keyword">for</span> ; left &lt; right; &#123;</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[right] &gt;= pivot; &#123;</span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; By(a[right], pivot); &#123;</span><br><span class="line">			right--</span><br><span class="line">		&#125;</span><br><span class="line">		a[left] = a[right]</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[left] &lt;= pivot; &#123;</span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; By(pivot, a[left]); &#123;</span><br><span class="line">			left++</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		a[right] = a[left]</span><br><span class="line">	&#125;</span><br><span class="line">	a[left] = pivot</span><br><span class="line">	<span class="keyword">return</span> left</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="type">string</span></span><br><span class="line">	Age   <span class="type">int</span></span><br><span class="line">	Count <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counter = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„éƒ¨åˆ†</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	flagResult = <span class="literal">false</span></span><br><span class="line">	SortLow    = - <span class="number">1</span></span><br><span class="line">	SortEquals = <span class="number">0</span></span><br><span class="line">	SortHigh   = <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ’åºè§„åˆ™,æ¥æºå¯ä»¥è‡ªå®šä¹‰</span></span><br><span class="line"><span class="comment">// K: æ’åºå­—æ®µ &quot;Count&quot;  v: true--&gt; å°--&gt;å¤§    false--&gt; å¤§--&gt;å°</span></span><br><span class="line"><span class="comment">// æ”¯æŒå¤šä¸ªkeyï¼Œå½“keyå¯¹åº”çš„å€¼ç›¸ç­‰æ—¶å€™ï¼Œåˆ™æ’åºå–å†³äºç¬¬äºŒä¸ªkeyè‡ªå®šä¹‰çš„æ’åºè§„åˆ™ã€‚</span></span><br><span class="line"><span class="comment">// eg: æŒ‰ç…§Nameå‡åº</span></span><br><span class="line"><span class="keyword">var</span> SortingRules = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span>&#123;<span class="string">&quot;Name&quot;</span>: <span class="literal">true</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// eg: æŒ‰ç…§Nameå‡åº,nameç›¸åŒæ—¶å€™,æŒ‰ç…§ageé™åº.</span></span><br><span class="line"><span class="comment">// var SortingRules = map[string]bool&#123;&quot;Name&quot;: true,&quot;Age&quot; : false&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	isp := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, counter)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; counter; i++ &#123;</span><br><span class="line">		isp = <span class="built_in">append</span>(isp, User&#123;</span><br><span class="line">			Name:  strconv.Itoa(rand.Intn(counter)),</span><br><span class="line">			Age:   i,</span><br><span class="line">			Count: rand.Intn(counter),</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="comment">//isp = append(isp, strconv.Itoa(rand.Intn(counter))+&quot;===&quot;)</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(isp)</span><br><span class="line">	t := time.Now().Unix()</span><br><span class="line">	<span class="comment">// ä¸»è¦çš„æ’åºè¿‡ç¨‹</span></span><br><span class="line">	num := QuickSortAll(isp, <span class="number">0</span>, <span class="built_in">len</span>(isp)<span class="number">-1</span>, <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="comment">// ç±»å‹ä¸åŒ¹é…åˆ™è¿”å›trueï¼Œæ— æ³•ä¿è¯é¡ºåº</span></span><br><span class="line">		<span class="keyword">if</span> reflect.ValueOf(a).Kind() != reflect.ValueOf(b).Kind() &#123;</span><br><span class="line">			<span class="keyword">return</span> !flagResult</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sortByRules(a, b, SortingRules)</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">	fmt.Println(num)</span><br><span class="line">	fmt.Println(<span class="string">&quot;è€—æ—¶ï¼š&quot;</span>,time.Now().Unix() - t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sortByRules è‡ªå®šä¹‰æ’åºè§„åˆ™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sortByRules</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;, sortingRules <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	ofType := reflect.ValueOf(a).Kind()</span><br><span class="line">	va := reflect.ValueOf(a)</span><br><span class="line">	vb := reflect.ValueOf(b)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> v, k := <span class="keyword">range</span> sortingRules &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ofType != reflect.Struct &#123;</span><br><span class="line">			<span class="comment">//éç»“æ„ä½“ï¼Œå¸¸ç”¨çš„ç±»å‹</span></span><br><span class="line">			result := typeChooseOfReflect(va, vb, k)</span><br><span class="line">			<span class="keyword">if</span> result == SortEquals &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> result &lt; SortEquals &#123;</span><br><span class="line">				<span class="keyword">return</span> flagResult</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> !flagResult</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> ofType == reflect.Struct &#123;</span><br><span class="line">			<span class="comment">// ç»“æ„ä½“æ¯”è¾ƒ</span></span><br><span class="line">			of := va.FieldByName(v)</span><br><span class="line">			ofb := vb.FieldByName(v)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> of.Kind() == reflect.Struct || ofb.Kind() == reflect.Struct &#123;</span><br><span class="line">				<span class="keyword">return</span> !flagResult</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> !of.IsValid() || !ofb.IsValid() &#123;</span><br><span class="line">				<span class="keyword">return</span> !flagResult</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			result := typeChooseOfReflect(of, ofb, k)</span><br><span class="line">			<span class="keyword">if</span> result == SortEquals &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> result &lt; SortEquals &#123;</span><br><span class="line">				<span class="keyword">return</span> flagResult</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> !flagResult</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> !flagResult</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// typeChooseOfReflect ç±»å‹é€‰æ‹©æ˜ å°„</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">typeChooseOfReflect</span><span class="params">(valueOfA, valueOfB reflect.Value, flag <span class="type">bool</span>)</span></span> <span class="type">int8</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> flag &#123;</span><br><span class="line">		valueOfA, valueOfB = valueOfB, valueOfA</span><br><span class="line">	&#125;</span><br><span class="line">	kind := valueOfA.Type().Kind()</span><br><span class="line">	<span class="keyword">switch</span> kind &#123;</span><br><span class="line">	<span class="keyword">case</span> reflect.Bool:</span><br><span class="line">		<span class="keyword">return</span> SortHigh</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">		<span class="keyword">if</span> valueOfA.Int() &lt; valueOfB.Int() &#123;</span><br><span class="line">			<span class="keyword">return</span> SortHigh</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> valueOfA.Int() == valueOfB.Int() &#123;</span><br><span class="line">			<span class="keyword">return</span> SortEquals</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">		<span class="keyword">if</span> valueOfA.Uint() &lt; valueOfB.Uint() &#123;</span><br><span class="line">			<span class="keyword">return</span> SortHigh</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> valueOfA.Uint() == valueOfB.Uint() &#123;</span><br><span class="line">			<span class="keyword">return</span> SortEquals</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> reflect.Float32, reflect.Float64:</span><br><span class="line">		<span class="keyword">if</span> valueOfA.Float() &lt; valueOfB.Float() &#123;</span><br><span class="line">			<span class="keyword">return</span> SortHigh</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> valueOfA.Float() == valueOfB.Float() &#123;</span><br><span class="line">			<span class="keyword">return</span> SortEquals</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> reflect.String:</span><br><span class="line">		<span class="keyword">return</span> -<span class="type">int8</span>(strings.Compare(valueOfA.String(), valueOfB.String()))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> SortLow</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="outputs"><a class="header-anchor" href="#outputs">Â¶</a>outputs:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="number">1</span> <span class="number">0</span> <span class="number">7</span>&#125; &#123;<span class="number">7</span> <span class="number">1</span> <span class="number">9</span>&#125; &#123;<span class="number">1</span> <span class="number">2</span> <span class="number">8</span>&#125; &#123;<span class="number">5</span> <span class="number">3</span> <span class="number">0</span>&#125; &#123;<span class="number">6</span> <span class="number">4</span> <span class="number">0</span>&#125; &#123;<span class="number">4</span> <span class="number">5</span> <span class="number">1</span>&#125; &#123;<span class="number">2</span> <span class="number">6</span> <span class="number">9</span>&#125; &#123;<span class="number">8</span> <span class="number">7</span> <span class="number">4</span>&#125; &#123;<span class="number">1</span> <span class="number">8</span> <span class="number">5</span>&#125; &#123;<span class="number">7</span> <span class="number">9</span> <span class="number">6</span>&#125;]</span><br><span class="line">[&#123;<span class="number">1</span> <span class="number">0</span> <span class="number">7</span>&#125; &#123;<span class="number">1</span> <span class="number">8</span> <span class="number">5</span>&#125; &#123;<span class="number">1</span> <span class="number">2</span> <span class="number">8</span>&#125; &#123;<span class="number">2</span> <span class="number">6</span> <span class="number">9</span>&#125; &#123;<span class="number">4</span> <span class="number">5</span> <span class="number">1</span>&#125; &#123;<span class="number">5</span> <span class="number">3</span> <span class="number">0</span>&#125; &#123;<span class="number">6</span> <span class="number">4</span> <span class="number">0</span>&#125; &#123;<span class="number">7</span> <span class="number">1</span> <span class="number">9</span>&#125; &#123;<span class="number">7</span> <span class="number">9</span> <span class="number">6</span>&#125; &#123;<span class="number">8</span> <span class="number">7</span> <span class="number">4</span>&#125;]</span><br><span class="line">è€—æ—¶ï¼š <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ä¿®æ”¹è‡ªå®šä¹‰è§„åˆ™"><a class="header-anchor" href="#ä¿®æ”¹è‡ªå®šä¹‰è§„åˆ™">Â¶</a>ä¿®æ”¹è‡ªå®šä¹‰è§„åˆ™:</h4>
<h5 id="å¤šä¸ªè§„åˆ™æ’åº"><a class="header-anchor" href="#å¤šä¸ªè§„åˆ™æ’åº">Â¶</a>å¤šä¸ªè§„åˆ™æ’åº</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// eg: æŒ‰ç…§Nameå‡åº,nameç›¸åŒæ—¶å€™,æŒ‰ç…§ageé™åº.</span></span><br><span class="line"><span class="comment">// var SortingRules = map[string]bool&#123;&quot;Name&quot;: true,&quot;Age&quot; : false&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="outputs-v2"><a class="header-anchor" href="#outputs-v2">Â¶</a>outputs:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="number">1</span> <span class="number">0</span> <span class="number">7</span>&#125; &#123;<span class="number">7</span> <span class="number">1</span> <span class="number">9</span>&#125; &#123;<span class="number">1</span> <span class="number">2</span> <span class="number">8</span>&#125; &#123;<span class="number">5</span> <span class="number">3</span> <span class="number">0</span>&#125; &#123;<span class="number">6</span> <span class="number">4</span> <span class="number">0</span>&#125; &#123;<span class="number">4</span> <span class="number">5</span> <span class="number">1</span>&#125; &#123;<span class="number">2</span> <span class="number">6</span> <span class="number">9</span>&#125; &#123;<span class="number">8</span> <span class="number">7</span> <span class="number">4</span>&#125; &#123;<span class="number">1</span> <span class="number">8</span> <span class="number">5</span>&#125; &#123;<span class="number">7</span> <span class="number">9</span> <span class="number">6</span>&#125;]</span><br><span class="line">[&#123;<span class="number">1</span> <span class="number">8</span> <span class="number">5</span>&#125; &#123;<span class="number">1</span> <span class="number">2</span> <span class="number">8</span>&#125; &#123;<span class="number">1</span> <span class="number">0</span> <span class="number">7</span>&#125; &#123;<span class="number">2</span> <span class="number">6</span> <span class="number">9</span>&#125; &#123;<span class="number">4</span> <span class="number">5</span> <span class="number">1</span>&#125; &#123;<span class="number">5</span> <span class="number">3</span> <span class="number">0</span>&#125; &#123;<span class="number">6</span> <span class="number">4</span> <span class="number">0</span>&#125; &#123;<span class="number">7</span> <span class="number">9</span> <span class="number">6</span>&#125; &#123;<span class="number">7</span> <span class="number">1</span> <span class="number">9</span>&#125; &#123;<span class="number">8</span> <span class="number">7</span> <span class="number">4</span>&#125;]</span><br><span class="line">è€—æ—¶ï¼š <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h5 id="å¸¸è§ç±»å‹æ’åº"><a class="header-anchor" href="#å¸¸è§ç±»å‹æ’åº">Â¶</a>å¸¸è§ç±»å‹æ’åº:</h5>
<p>ä¿®æ”¹é‡è¦éƒ¨åˆ†:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// K: æ’åºå­—æ®µ &quot;Count&quot;  v: true--&gt; å°--&gt;å¤§    false--&gt; å¤§--&gt;å°</span></span><br><span class="line"><span class="comment">// æ”¯æŒå¤šä¸ªkeyï¼Œå½“keyå¯¹åº”çš„å€¼ç›¸ç­‰æ—¶å€™ï¼Œåˆ™æ’åºå–å†³äºç¬¬äºŒä¸ªkeyè‡ªå®šä¹‰çš„æ’åºè§„åˆ™.(å¤šä¸ªkvä»¥ç¬¬ä¸€ä¸ªä¸ºå‡†ã€Œä»…åœ¨åŸºæœ¬ç±»å‹ä¸‹æœ‰æ•ˆã€)</span></span><br><span class="line"><span class="comment">// eg: stringç±»å‹æ’åº,åˆ™keyå€¼ä¸ºä»»æ„,valueå€¼å†³å®šæ’åºè§„åˆ™,</span></span><br><span class="line"><span class="keyword">var</span> SortingRules = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span>&#123;<span class="string">&quot;&quot;</span>: <span class="literal">true</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	isp := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, counter)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; counter; i++ &#123;</span><br><span class="line">		<span class="comment">/*isp = append(isp, User&#123;</span></span><br><span class="line"><span class="comment">			Name:  strconv.Itoa(rand.Intn(counter)),</span></span><br><span class="line"><span class="comment">			Age:   i,</span></span><br><span class="line"><span class="comment">			Count: rand.Intn(counter),</span></span><br><span class="line"><span class="comment">		&#125;)*/</span></span><br><span class="line">        <span class="comment">//***** stringç±»å‹æ’åº *****</span></span><br><span class="line">		isp = <span class="built_in">append</span>(isp, strconv.Itoa(rand.Intn(counter))+<span class="string">&quot;===&quot;</span>)</span><br><span class="line">        <span class="comment">//***** intç±»å‹æ’åº *****</span></span><br><span class="line">		<span class="comment">// isp = append(isp, rand.Intn(counter))</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(isp)</span><br><span class="line">	t := time.Now().Unix()</span><br><span class="line">	<span class="comment">// ä¸»è¦çš„æ’åºè¿‡ç¨‹</span></span><br><span class="line">	num := QuickSortAll(isp, <span class="number">0</span>, <span class="built_in">len</span>(isp)<span class="number">-1</span>, <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="comment">// ç±»å‹ä¸åŒ¹é…åˆ™è¿”å›trueï¼Œæ— æ³•ä¿è¯é¡ºåº</span></span><br><span class="line">		<span class="keyword">if</span> reflect.ValueOf(a).Kind() != reflect.ValueOf(b).Kind() &#123;</span><br><span class="line">			<span class="keyword">return</span> !flagResult</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sortByRules(a, b, SortingRules)</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">	fmt.Println(num)</span><br><span class="line">	fmt.Println(<span class="string">&quot;è€—æ—¶ï¼š&quot;</span>,time.Now().Unix() - t)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="outputs-v3"><a class="header-anchor" href="#outputs-v3">Â¶</a>outputs:</h5>
<ul>
<li>stringç±»å‹:</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">[<span class="number">1</span>=== <span class="number">7</span>=== <span class="number">7</span>=== <span class="number">9</span>=== <span class="number">1</span>=== <span class="number">8</span>=== <span class="number">5</span>=== <span class="number">0</span>=== <span class="number">6</span>=== <span class="number">0</span>===]</span><br><span class="line">[<span class="number">0</span>=== <span class="number">0</span>=== <span class="number">1</span>=== <span class="number">1</span>=== <span class="number">5</span>=== <span class="number">6</span>=== <span class="number">7</span>=== <span class="number">7</span>=== <span class="number">8</span>=== <span class="number">9</span>===]</span><br><span class="line">è€—æ—¶ï¼š <span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>intç±»å‹</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">[<span class="number">1</span> <span class="number">7</span> <span class="number">7</span> <span class="number">9</span> <span class="number">1</span> <span class="number">8</span> <span class="number">5</span> <span class="number">0</span> <span class="number">6</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span>]</span><br><span class="line">è€—æ—¶ï¼š <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“">Â¶</a>æ€»ç»“:</h3>
<p>åˆ°è¿™é‡Œä¹Ÿå°±å·®ä¸å¤šè¯¥ç»“æŸäº†,åŸºæœ¬å’Œå¸¸ç”¨çš„å°±è¿™ä¹ˆå¤šäº†,å…¶å®ƒéœ€è¦æ‰©å……çš„åç»­å†è¡¥å…….</p>
<ul>
<li>ä¼˜åŒ–ç‚¹:
<ul>
<li>å­—æ®µåç§°ä¸åŒºåˆ†å¤§å°å†™</li>
</ul>
</li>
</ul>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Sort</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ39ã€Go selectæºç å®ç°åˆ†æ</title>
    <url>/archives/e1051649.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å…³äºGoä¸­selectçš„ç‰¹æ€§ï¼Œå¾ˆå¤šå‘ï¼Œä¹Ÿå®¹æ˜“æ ½ã€‚</p>
<p>å¥½å¥‡åº•å±‚ åˆ°è®¡ç®—æœºå±‚é¢åˆ°åº•æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿï¼</p>
<p>å¦‚æœæœ‰Goçš„ç›¸å…³ç»éªŒï¼Œå°±æ™“å¾—selectç»å¸¸æ€§é…åˆchanä¸€èµ·æ¥ä½¿ç”¨ï¼Œ<br>
æœ‰ä¸ªé—®é¢˜ï¼šçº¿ç¨‹å®‰å…¨å—ï¼Ÿ å¤šä¸ªcaseåˆ°åº•æ˜¯å¦‚ä½•é€‰æ‹©çš„ï¼Ÿ éšæœºä¹ˆï¼Ÿwhy?</p>
<span id="more"></span>
<h3 id="version"><a class="header-anchor" href="#version">Â¶</a>version</h3>
<blockquote>
<p>go version 1.14</p>
</blockquote>
<h3 id="ç®€å•ä½¿ç”¨"><a class="header-anchor" href="#ç®€å•ä½¿ç”¨">Â¶</a>ç®€å•ä½¿ç”¨</h3>
<blockquote>
<p>ä¾‹1:</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SelectGo</span><span class="params">(cc, end <span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">	x, y := <span class="number">-1</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> cc &lt;- x:</span><br><span class="line">			x, y = y, x+y</span><br><span class="line">		<span class="keyword">case</span> &lt;-end:</span><br><span class="line">			fmt.Println(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šé¢çš„ç»“æ„ä¼šç­‰å¾… cc &lt;- xæˆ–è€… &lt;-endä¸¤ä¸ªä»»æ„ä¸€ä¸ªè¿”å›ï¼Œæ— è®ºå“ªä¸ªè¡¨è¾¾å¼è¿”å›éƒ½ä¼šç«‹åˆ»æ‰§è¡Œcaseçš„ä»£ç å—ã€‚</p>
</blockquote>
<blockquote>
<p>å½“selectä¸­çš„ä¸¤ä¸ªcaseéƒ½æ»¡è¶³æ¡ä»¶ï¼Œé‚£å°±éšæœºè§¦å‘å…¶ä¸­ä¸€ä¸ªã€‚</p>
</blockquote>
<h4 id="æ±‡ç¼–å®ç°ï¼š"><a class="header-anchor" href="#æ±‡ç¼–å®ç°ï¼š">Â¶</a>æ±‡ç¼–å®ç°ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">$ <span class="keyword">go</span> tool compile -N -l -S sselect.<span class="keyword">go</span> </span><br><span class="line"><span class="string">&quot;&quot;</span>.SelectGo STEXT size=<span class="number">490</span> args=<span class="number">0x10</span> locals=<span class="number">0xf0</span> funcid=<span class="number">0x0</span> </span><br><span class="line">        <span class="comment">// SelectGo å‡½æ•°</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     TEXT    <span class="string">&quot;&quot;</span>.SelectGo(SB), ABIInternal, $<span class="number">240</span><span class="number">-16</span></span><br><span class="line">        <span class="number">0x0000</span> <span class="number">00000</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     MOVQ    (TLS), CX</span><br><span class="line">        <span class="number">0x0009</span> <span class="number">00009</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     LEAQ    <span class="number">-112</span>(SP), AX</span><br><span class="line">        <span class="number">0x000e</span> <span class="number">00014</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     CMPQ    AX, <span class="number">16</span>(CX)</span><br><span class="line">        <span class="number">0x0012</span> <span class="number">00018</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-2</span></span><br><span class="line">        <span class="number">0x0012</span> <span class="number">00018</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     JLS     <span class="number">480</span></span><br><span class="line">        <span class="number">0x0018</span> <span class="number">00024</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x0018</span> <span class="number">00024</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     SUBQ    $<span class="number">240</span>, SP</span><br><span class="line">        <span class="number">0x001f</span> <span class="number">00031</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     MOVQ    BP, <span class="number">232</span>(SP)</span><br><span class="line">        <span class="number">0x0027</span> <span class="number">00039</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     LEAQ    <span class="number">232</span>(SP), BP</span><br><span class="line">        <span class="number">0x002f</span> <span class="number">00047</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     FUNCDATA        $<span class="number">0</span>, gclocalsÂ·dc9b0298814590ca3ffc3a889546fc8b(SB)</span><br><span class="line">        <span class="number">0x002f</span> <span class="number">00047</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     FUNCDATA        $<span class="number">1</span>, gclocalsÂ·<span class="number">90105</span>ebf2cf472b05305b6351ad183b7(SB)</span><br><span class="line">        <span class="number">0x002f</span> <span class="number">00047</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     FUNCDATA        $<span class="number">2</span>, <span class="string">&quot;&quot;</span>.SelectGo.stkobj(SB)</span><br><span class="line">        <span class="number">0x002f</span> <span class="number">00047</span> (sselect.<span class="keyword">go</span>:<span class="number">6</span>)     MOVQ    $<span class="number">0</span>, <span class="string">&quot;&quot;</span>.x+<span class="number">80</span>(SP)</span><br><span class="line">        <span class="number">0x0038</span> <span class="number">00056</span> (sselect.<span class="keyword">go</span>:<span class="number">6</span>)     MOVQ    $<span class="number">1</span>, <span class="string">&quot;&quot;</span>.y+<span class="number">72</span>(SP)</span><br><span class="line">        <span class="number">0x0041</span> <span class="number">00065</span> (sselect.<span class="keyword">go</span>:<span class="number">7</span>)     JMP     <span class="number">67</span></span><br><span class="line">        <span class="number">0x0043</span> <span class="number">00067</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     JMP     <span class="number">69</span></span><br><span class="line">        <span class="number">0x0045</span> <span class="number">00069</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     MOVQ    <span class="string">&quot;&quot;</span>.c+<span class="number">248</span>(SP), AX</span><br><span class="line">        <span class="number">0x004d</span> <span class="number">00077</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_4+<span class="number">128</span>(SP)</span><br><span class="line">        <span class="number">0x0055</span> <span class="number">00085</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     MOVQ    <span class="string">&quot;&quot;</span>.x+<span class="number">80</span>(SP), AX</span><br><span class="line">        <span class="number">0x005a</span> <span class="number">00090</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_5+<span class="number">96</span>(SP)</span><br><span class="line">        <span class="number">0x005f</span> <span class="number">00095</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    MOVQ    <span class="string">&quot;&quot;</span>.quit+<span class="number">256</span>(SP), AX</span><br><span class="line">        <span class="number">0x0067</span> <span class="number">00103</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_6+<span class="number">120</span>(SP)</span><br><span class="line">        <span class="number">0x006c</span> <span class="number">00108</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     XORPS   X0, X0</span><br><span class="line">        <span class="number">0x006f</span> <span class="number">00111</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVUPS  X0, <span class="string">&quot;&quot;</span>..autotmp_8+<span class="number">200</span>(SP)</span><br><span class="line">        <span class="number">0x0077</span> <span class="number">00119</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVUPS  X0, <span class="string">&quot;&quot;</span>..autotmp_8+<span class="number">216</span>(SP)</span><br><span class="line">        <span class="number">0x007f</span> <span class="number">00127</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     MOVQ    <span class="string">&quot;&quot;</span>..autotmp_4+<span class="number">128</span>(SP), AX</span><br><span class="line">        <span class="number">0x0087</span> <span class="number">00135</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_8+<span class="number">200</span>(SP)</span><br><span class="line">        <span class="number">0x008f</span> <span class="number">00143</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     LEAQ    <span class="string">&quot;&quot;</span>..autotmp_5+<span class="number">96</span>(SP), AX</span><br><span class="line">        <span class="number">0x0094</span> <span class="number">00148</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_8+<span class="number">208</span>(SP)</span><br><span class="line">        <span class="number">0x009c</span> <span class="number">00156</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    MOVQ    <span class="string">&quot;&quot;</span>..autotmp_6+<span class="number">120</span>(SP), AX</span><br><span class="line">        <span class="number">0x00a1</span> <span class="number">00161</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_8+<span class="number">216</span>(SP)</span><br><span class="line">        <span class="number">0x00a9</span> <span class="number">00169</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     LEAQ    <span class="string">&quot;&quot;</span>..autotmp_8+<span class="number">200</span>(SP), AX</span><br><span class="line">        <span class="number">0x00b1</span> <span class="number">00177</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_12+<span class="number">152</span>(SP)</span><br><span class="line">        <span class="number">0x00b9</span> <span class="number">00185</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     LEAQ    <span class="string">&quot;&quot;</span>..autotmp_9+<span class="number">88</span>(SP), AX</span><br><span class="line">        <span class="number">0x00be</span> <span class="number">00190</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_13+<span class="number">144</span>(SP)</span><br><span class="line">        <span class="number">0x00c6</span> <span class="number">00198</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    <span class="string">&quot;&quot;</span>..autotmp_12+<span class="number">152</span>(SP), CX</span><br><span class="line">        <span class="number">0x00ce</span> <span class="number">00206</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    CX, (SP)</span><br><span class="line">        <span class="number">0x00d2</span> <span class="number">00210</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    AX, <span class="number">8</span>(SP)</span><br><span class="line">        <span class="number">0x00d7</span> <span class="number">00215</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    $<span class="number">0</span>, <span class="number">16</span>(SP)</span><br><span class="line">        <span class="number">0x00e0</span> <span class="number">00224</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    $<span class="number">1</span>, <span class="number">24</span>(SP)</span><br><span class="line">        <span class="number">0x00e9</span> <span class="number">00233</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    $<span class="number">1</span>, <span class="number">32</span>(SP)</span><br><span class="line">        <span class="number">0x00f2</span> <span class="number">00242</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVB    $<span class="number">1</span>, <span class="number">40</span>(SP)</span><br><span class="line">        <span class="number">0x00f7</span> <span class="number">00247</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     PCDATA  $<span class="number">1</span>, $<span class="number">0</span></span><br><span class="line">        <span class="number">0x00f7</span> <span class="number">00247</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     CALL    runtime.selectgo(SB)</span><br><span class="line">        <span class="number">0x00fc</span> <span class="number">00252</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    <span class="number">48</span>(SP), AX</span><br><span class="line">        <span class="number">0x0101</span> <span class="number">00257</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVBLZX <span class="number">56</span>(SP), CX</span><br><span class="line">        <span class="number">0x0106</span> <span class="number">00262</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_10+<span class="number">112</span>(SP)</span><br><span class="line">        <span class="number">0x010b</span> <span class="number">00267</span> (sselect.<span class="keyword">go</span>:<span class="number">8</span>)     MOVB    CL, <span class="string">&quot;&quot;</span>..autotmp_11+<span class="number">71</span>(SP)</span><br><span class="line">        <span class="number">0x010f</span> <span class="number">00271</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     CMPQ    <span class="string">&quot;&quot;</span>..autotmp_10+<span class="number">112</span>(SP), $<span class="number">0</span></span><br><span class="line">        <span class="number">0x0115</span> <span class="number">00277</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     JEQ     <span class="number">281</span></span><br><span class="line">        <span class="number">0x0117</span> <span class="number">00279</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     JMP     <span class="number">327</span></span><br><span class="line">        <span class="number">0x0119</span> <span class="number">00281</span> (sselect.<span class="keyword">go</span>:<span class="number">10</span>)    MOVQ    <span class="string">&quot;&quot;</span>.x+<span class="number">80</span>(SP), AX</span><br><span class="line">        <span class="number">0x011e</span> <span class="number">00286</span> (sselect.<span class="keyword">go</span>:<span class="number">10</span>)    ADDQ    <span class="string">&quot;&quot;</span>.y+<span class="number">72</span>(SP), AX</span><br><span class="line">        <span class="number">0x0123</span> <span class="number">00291</span> (sselect.<span class="keyword">go</span>:<span class="number">10</span>)    MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_14+<span class="number">104</span>(SP)</span><br><span class="line">        <span class="number">0x0128</span> <span class="number">00296</span> (sselect.<span class="keyword">go</span>:<span class="number">10</span>)    MOVQ    <span class="string">&quot;&quot;</span>.y+<span class="number">72</span>(SP), AX</span><br><span class="line">        <span class="number">0x012d</span> <span class="number">00301</span> (sselect.<span class="keyword">go</span>:<span class="number">10</span>)    MOVQ    AX, <span class="string">&quot;&quot;</span>.x+<span class="number">80</span>(SP)</span><br><span class="line">        <span class="number">0x0132</span> <span class="number">00306</span> (sselect.<span class="keyword">go</span>:<span class="number">10</span>)    MOVQ    <span class="string">&quot;&quot;</span>..autotmp_14+<span class="number">104</span>(SP), AX</span><br><span class="line">        <span class="number">0x0137</span> <span class="number">00311</span> (sselect.<span class="keyword">go</span>:<span class="number">10</span>)    MOVQ    AX, <span class="string">&quot;&quot;</span>.y+<span class="number">72</span>(SP)</span><br><span class="line">        <span class="number">0x013c</span> <span class="number">00316</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     JMP     <span class="number">318</span></span><br><span class="line">        <span class="number">0x013e</span> <span class="number">00318</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     PCDATA  $<span class="number">1</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x013e</span> <span class="number">00318</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     NOP</span><br><span class="line">        <span class="number">0x0140</span> <span class="number">00320</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     JMP     <span class="number">322</span></span><br><span class="line">        <span class="number">0x0142</span> <span class="number">00322</span> (sselect.<span class="keyword">go</span>:<span class="number">9</span>)     JMP     <span class="number">67</span></span><br><span class="line">        <span class="number">0x0147</span> <span class="number">00327</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    CMPQ    <span class="string">&quot;&quot;</span>..autotmp_10+<span class="number">112</span>(SP), $<span class="number">1</span></span><br><span class="line">        <span class="number">0x014d</span> <span class="number">00333</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    JEQ     <span class="number">340</span></span><br><span class="line">        <span class="number">0x014f</span> <span class="number">00335</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    JMP     <span class="number">478</span></span><br><span class="line">        <span class="number">0x0154</span> <span class="number">00340</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    XORPS   X0, X0</span><br><span class="line">        <span class="number">0x0157</span> <span class="number">00343</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVUPS  X0, <span class="string">&quot;&quot;</span>..autotmp_7+<span class="number">160</span>(SP)</span><br><span class="line">        <span class="number">0x015f</span> <span class="number">00351</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    LEAQ    <span class="string">&quot;&quot;</span>..autotmp_7+<span class="number">160</span>(SP), AX</span><br><span class="line">        <span class="number">0x0167</span> <span class="number">00359</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_16+<span class="number">136</span>(SP)</span><br><span class="line">        <span class="number">0x016f</span> <span class="number">00367</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    TESTB   AL, (AX)</span><br><span class="line">        <span class="number">0x0171</span> <span class="number">00369</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    LEAQ    <span class="keyword">type</span>.<span class="type">string</span>(SB), CX</span><br><span class="line">        <span class="number">0x0178</span> <span class="number">00376</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    CX, <span class="string">&quot;&quot;</span>..autotmp_7+<span class="number">160</span>(SP)</span><br><span class="line">        <span class="number">0x0180</span> <span class="number">00384</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    LEAQ    <span class="string">&quot;&quot;</span>..stmp_0(SB), CX</span><br><span class="line">        <span class="number">0x0187</span> <span class="number">00391</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    CX, <span class="string">&quot;&quot;</span>..autotmp_7+<span class="number">168</span>(SP)</span><br><span class="line">        <span class="number">0x018f</span> <span class="number">00399</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    TESTB   AL, (AX)</span><br><span class="line">        <span class="number">0x0191</span> <span class="number">00401</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    JMP     <span class="number">403</span></span><br><span class="line">        <span class="number">0x0193</span> <span class="number">00403</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_15+<span class="number">176</span>(SP)</span><br><span class="line">        <span class="number">0x019b</span> <span class="number">00411</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    $<span class="number">1</span>, <span class="string">&quot;&quot;</span>..autotmp_15+<span class="number">184</span>(SP)</span><br><span class="line">        <span class="number">0x01a7</span> <span class="number">00423</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    $<span class="number">1</span>, <span class="string">&quot;&quot;</span>..autotmp_15+<span class="number">192</span>(SP)</span><br><span class="line">        <span class="number">0x01b3</span> <span class="number">00435</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    AX, (SP)</span><br><span class="line">        <span class="number">0x01b7</span> <span class="number">00439</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    $<span class="number">1</span>, <span class="number">8</span>(SP)</span><br><span class="line">        <span class="number">0x01c0</span> <span class="number">00448</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    MOVQ    $<span class="number">1</span>, <span class="number">16</span>(SP)</span><br><span class="line">        <span class="number">0x01c9</span> <span class="number">00457</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    PCDATA  $<span class="number">1</span>, $<span class="number">1</span></span><br><span class="line">        <span class="number">0x01c9</span> <span class="number">00457</span> (sselect.<span class="keyword">go</span>:<span class="number">12</span>)    CALL    fmt.Println(SB)</span><br><span class="line">        <span class="number">0x01ce</span> <span class="number">00462</span> (sselect.<span class="keyword">go</span>:<span class="number">13</span>)    MOVQ    <span class="number">232</span>(SP), BP</span><br><span class="line">        <span class="number">0x01d6</span> <span class="number">00470</span> (sselect.<span class="keyword">go</span>:<span class="number">13</span>)    ADDQ    $<span class="number">240</span>, SP</span><br><span class="line">        <span class="number">0x01dd</span> <span class="number">00477</span> (sselect.<span class="keyword">go</span>:<span class="number">13</span>)    RET</span><br><span class="line">        <span class="number">0x01de</span> <span class="number">00478</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    PCDATA  $<span class="number">1</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x01de</span> <span class="number">00478</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    XCHGL   AX, AX</span><br><span class="line">        <span class="number">0x01df</span> <span class="number">00479</span> (sselect.<span class="keyword">go</span>:<span class="number">11</span>)    NOP</span><br><span class="line">        <span class="number">0x01df</span> <span class="number">00479</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     PCDATA  $<span class="number">1</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x01df</span> <span class="number">00479</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-2</span></span><br><span class="line">        <span class="number">0x01df</span> <span class="number">00479</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     NOP</span><br><span class="line">        <span class="number">0x01e0</span> <span class="number">00480</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     CALL    runtime.morestack_noctxt(SB)</span><br><span class="line">        <span class="number">0x01e5</span> <span class="number">00485</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     PCDATA  $<span class="number">0</span>, $<span class="number">-1</span></span><br><span class="line">        <span class="number">0x01e5</span> <span class="number">00485</span> (sselect.<span class="keyword">go</span>:<span class="number">5</span>)     JMP     <span class="number">0</span></span><br><span class="line">        ......</span><br><span class="line">        ....</span><br><span class="line">        ...</span><br><span class="line">        ..</span><br><span class="line">        .</span><br></pre></td></tr></table></figure>
<h3 id="åœºæ™¯"><a class="header-anchor" href="#åœºæ™¯">Â¶</a>åœºæ™¯</h3>
<h4 id="éé˜»å¡å¼ï¼š"><a class="header-anchor" href="#éé˜»å¡å¼ï¼š">Â¶</a>éé˜»å¡å¼ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> i := &lt;-ch:</span><br><span class="line">		<span class="built_in">println</span>(i)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">println</span>(<span class="string">&quot;default&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">go</span> run main.<span class="keyword">go</span></span><br><span class="line"><span class="keyword">default</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>selectåŒæ—¶ç›‘å¬å¤šä¸ªcaseæ˜¯å¦å¯æ‰§è¡Œï¼Œå¦‚æœå¤šä¸ªcaseä¸å¯æ‰§è¡Œï¼Œæœ‰defaultå°±æ‰§è¡Œã€‚</p>
</blockquote>
<h4 id="éšæœºæ‰§è¡Œ"><a class="header-anchor" href="#éšæœºæ‰§è¡Œ">Â¶</a>éšæœºæ‰§è¡Œ</h4>
<blockquote>
<p>å…³äºä¸‹é¢çš„ç¨‹åºåˆ°åº•æ˜¯æ‰“å°ä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> <span class="keyword">range</span> time.Tick(<span class="number">1</span> * time.Second) &#123;</span><br><span class="line">			ch &lt;- <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ch:</span><br><span class="line">			<span class="built_in">println</span>(<span class="string">&quot;case1&quot;</span>)</span><br><span class="line">		<span class="keyword">case</span> &lt;-ch:</span><br><span class="line">			<span class="built_in">println</span>(<span class="string">&quot;case2&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="outputs"><a class="header-anchor" href="#outputs">Â¶</a>outputs:</h5>
<ul>
<li>éšæœºæ€§</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">case1</span><br><span class="line">case2</span><br><span class="line">case1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="æ­£é¢˜ï¼šä¸ºä½•æ˜¯éšæœºï¼Ÿ"><a class="header-anchor" href="#æ­£é¢˜ï¼šä¸ºä½•æ˜¯éšæœºï¼Ÿ">Â¶</a>æ­£é¢˜ï¼šä¸ºä½•æ˜¯éšæœºï¼Ÿ</h3>
<h4 id="select-caseçš„ç»“æ„"><a class="header-anchor" href="#select-caseçš„ç»“æ„">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/select.go#L29">select caseçš„ç»“æ„</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> scase <span class="keyword">struct</span> &#123;</span><br><span class="line">	c           *hchan         <span class="comment">// chan</span></span><br><span class="line">	elem        unsafe.Pointer <span class="comment">// data element</span></span><br><span class="line">	kind        <span class="type">uint16</span></span><br><span class="line">	pc          <span class="type">uintptr</span> <span class="comment">// race pc (for race detector / msan)</span></span><br><span class="line">	releasetime <span class="type">int64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®ç°åŸç†"><a class="header-anchor" href="#å®ç°åŸç†">Â¶</a>å®ç°åŸç†</h4>
<ul>
<li>goå¯¹äºä¸­é—´ä»£ç ä¼šæœ‰éƒ¨åˆ†çš„ä¼˜åŒ–ï¼š <a href="https://github.com/golang/go/blob/release-branch.go1.14/src/cmd/compile/internal/gc/select.go#L108">walkselectcases</a></li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">walkselectcases</span><span class="params">(cases *Nodes)</span></span> []*Node &#123;</span><br><span class="line">	ncas := cases.Len()</span><br><span class="line">	sellineno := lineno</span><br><span class="line"></span><br><span class="line">	<span class="comment">// optimization: zero-case select æ²¡æœ‰caseçš„æƒ…å†µ</span></span><br><span class="line">	<span class="keyword">if</span> ncas == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []*Node&#123;mkcall(<span class="string">&quot;block&quot;</span>, <span class="literal">nil</span>, <span class="literal">nil</span>)&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// optimization: one-case select: single op.</span></span><br><span class="line">	<span class="keyword">if</span> ncas == <span class="number">1</span> &#123;</span><br><span class="line">        ..........</span><br><span class="line">        ........</span><br><span class="line">        ......</span><br><span class="line">        ...</span><br><span class="line">        ..</span><br><span class="line">        .</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="éšæœºåŒ–åŸå› ï¼Ÿ"><a class="header-anchor" href="#éšæœºåŒ–åŸå› ï¼Ÿ">Â¶</a>éšæœºåŒ–åŸå› ï¼Ÿ</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210223_052947.png" alt=""></p>
<ul>
<li>å…³äºfastrandnåé¢å•ç‹¬åˆ†æå§ï¼Œè¿˜æŒºæœ‰æ„æ€çš„ã€‚</li>
</ul>
<h5 id="æ²¡æœ‰case-å•å•ä¸€ä¸ªselectæƒ…å†µ"><a class="header-anchor" href="#æ²¡æœ‰case-å•å•ä¸€ä¸ªselectæƒ…å†µ">Â¶</a>æ²¡æœ‰case,å•å•ä¸€ä¸ªselectæƒ…å†µ:</h5>
<blockquote>
<p>å‰å‡ è¡Œå°±å†™çš„å¾ˆæ¸…æ¥šäº†ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">block</span><span class="params">()</span></span> &#123;</span><br><span class="line">	gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonSelectNoCases, traceEvGoStop, <span class="number">1</span>) <span class="comment">// forever</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="å¤šçœ‹ä¸€æ­¥ï¼š"><a class="header-anchor" href="#å¤šçœ‹ä¸€æ­¥ï¼š">Â¶</a>å¤šçœ‹ä¸€æ­¥ï¼š</h6>
<ul>
<li>waitReasonSelectNoCaseså¹²å˜›çš„ï¼Ÿ</li>
</ul>
<p>è¿™é‡Œé€»åˆ—äº†g waitçš„æ‰€æœ‰æƒ…å†µï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Œä¸æ˜¯è¿™æ¬¡ç ”ç©¶çš„é‡ç‚¹ï¼<br>
æœ‰å…´è¶£å¯ä»¥ä¸‹æ¥æŸ¥æŸ¥ï¼Œçœ‹çœ‹å“ªé‡Œéƒ½ç”¨åˆ°äº†ã€‚<br>
<a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L948">é“¾æ¥ğŸ”—</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	waitReasonZero                  waitReason = <span class="literal">iota</span> <span class="comment">// &quot;&quot;</span></span><br><span class="line">	waitReasonGCAssistMarking                         <span class="comment">// &quot;GC assist marking&quot;</span></span><br><span class="line">	waitReasonIOWait                                  <span class="comment">// &quot;IO wait&quot;</span></span><br><span class="line">	waitReasonChanReceiveNilChan                      <span class="comment">// &quot;chan receive (nil chan)&quot;</span></span><br><span class="line">	waitReasonChanSendNilChan                         <span class="comment">// &quot;chan send (nil chan)&quot;</span></span><br><span class="line">	waitReasonDumpingHeap                             <span class="comment">// &quot;dumping heap&quot;</span></span><br><span class="line">	waitReasonGarbageCollection                       <span class="comment">// &quot;garbage collection&quot;</span></span><br><span class="line">	waitReasonGarbageCollectionScan                   <span class="comment">// &quot;garbage collection scan&quot;</span></span><br><span class="line">	waitReasonPanicWait                               <span class="comment">// &quot;panicwait&quot;</span></span><br><span class="line">	waitReasonSelect                                  <span class="comment">// &quot;select&quot;</span></span><br><span class="line">	waitReasonSelectNoCases                           <span class="comment">// &quot;select (no cases)&quot;</span></span><br><span class="line">	waitReasonGCAssistWait                            <span class="comment">// &quot;GC assist wait&quot;</span></span><br><span class="line">	waitReasonGCSweepWait                             <span class="comment">// &quot;GC sweep wait&quot;</span></span><br><span class="line">	waitReasonGCScavengeWait                          <span class="comment">// &quot;GC scavenge wait&quot;</span></span><br><span class="line">	waitReasonChanReceive                             <span class="comment">// &quot;chan receive&quot;</span></span><br><span class="line">	waitReasonChanSend                                <span class="comment">// &quot;chan send&quot;</span></span><br><span class="line">	waitReasonFinalizerWait                           <span class="comment">// &quot;finalizer wait&quot;</span></span><br><span class="line">	waitReasonForceGGIdle                             <span class="comment">// &quot;force gc (idle)&quot;</span></span><br><span class="line">	waitReasonSemacquire                              <span class="comment">// &quot;semacquire&quot;</span></span><br><span class="line">	waitReasonSleep                                   <span class="comment">// &quot;sleep&quot;</span></span><br><span class="line">	waitReasonSyncCondWait                            <span class="comment">// &quot;sync.Cond.Wait&quot;</span></span><br><span class="line">	waitReasonTimerGoroutineIdle                      <span class="comment">// &quot;timer goroutine (idle)&quot;</span></span><br><span class="line">	waitReasonTraceReaderBlocked                      <span class="comment">// &quot;trace reader (blocked)&quot;</span></span><br><span class="line">	waitReasonWaitForGCCycle                          <span class="comment">// &quot;wait for GC cycle&quot;</span></span><br><span class="line">	waitReasonGCWorkerIdle                            <span class="comment">// &quot;GC worker (idle)&quot;</span></span><br><span class="line">	waitReasonPreempted                               <span class="comment">// &quot;preempted&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h5 id="éé˜»å¡çš„æ“ä½œ"><a class="header-anchor" href="#éé˜»å¡çš„æ“ä½œ">Â¶</a>éé˜»å¡çš„æ“ä½œ</h5>
<p>åƒä¾‹å­1é‚£æ ·ï¼Œå¦‚æœä¸¤ä¸ªcaseï¼ŒåŒ…å«ä¸€ä¸ªdefaultï¼Œåˆ™ä¸ºéé˜»å¡çš„æ“ä½œã€‚<br>
<a href="https://github.com/golang/go/blob/release-branch.go1.14/src/cmd/compile/internal/gc/select.go#L108">walkselectcases</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">walkselectcases</span><span class="params">(cases *Nodes)</span></span> []*Node &#123;</span><br><span class="line">	ncas := cases.Len()</span><br><span class="line">	sellineno := lineno</span><br><span class="line"></span><br><span class="line">	<span class="comment">// optimization: zero-case select</span></span><br><span class="line">	<span class="keyword">if</span> ncas == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []*Node&#123;mkcall(<span class="string">&quot;block&quot;</span>, <span class="literal">nil</span>, <span class="literal">nil</span>)&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// optimization: one-case select: single op.</span></span><br><span class="line">	<span class="keyword">if</span> ncas == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="comment">// åŒ…å«defaultçš„æƒ…å†µ</span></span><br><span class="line">		cas := cases.First()</span><br><span class="line">		setlineno(cas)</span><br><span class="line">		l := cas.Ninit.Slice()</span><br><span class="line">		<span class="keyword">if</span> cas.Left != <span class="literal">nil</span> &#123; <span class="comment">// not default:</span></span><br><span class="line">			n := cas.Left</span><br><span class="line">			l = <span class="built_in">append</span>(l, n.Ninit.Slice()...)</span><br><span class="line">			n.Ninit.Set(<span class="literal">nil</span>)</span><br><span class="line">			<span class="keyword">switch</span> n.Op &#123;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				Fatalf(<span class="string">&quot;select %v&quot;</span>, n.Op)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> OSEND:</span><br><span class="line">				<span class="comment">// already ok</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> OSELRECV, OSELRECV2:</span><br><span class="line">				<span class="keyword">if</span> n.Op == OSELRECV || n.List.Len() == <span class="number">0</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> n.Left == <span class="literal">nil</span> &#123;</span><br><span class="line">						n = n.Right</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						n.Op = OAS</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> n.Left == <span class="literal">nil</span> &#123;</span><br><span class="line">					nblank = typecheck(nblank, ctxExpr|ctxAssign)</span><br><span class="line">					n.Left = nblank</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				n.Op = OAS2</span><br><span class="line">				n.List.Prepend(n.Left)</span><br><span class="line">				n.Rlist.Set1(n.Right)</span><br><span class="line">				n.Right = <span class="literal">nil</span></span><br><span class="line">				n.Left = <span class="literal">nil</span></span><br><span class="line">				n.SetTypecheck(<span class="number">0</span>)</span><br><span class="line">				n = typecheck(n, ctxStmt)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			l = <span class="built_in">append</span>(l, n)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		l = <span class="built_in">append</span>(l, cas.Nbody.Slice()...)</span><br><span class="line">		l = <span class="built_in">append</span>(l, nod(OBREAK, <span class="literal">nil</span>, <span class="literal">nil</span>))</span><br><span class="line">		<span class="keyword">return</span> l</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="æµç¨‹åŒ–é—®é¢˜"><a class="header-anchor" href="#æµç¨‹åŒ–é—®é¢˜">Â¶</a>æµç¨‹åŒ–é—®é¢˜</h4>
<ul>
<li>1ã€å°†æ‰€æœ‰çš„caseè½¬æ¢æˆåŒ…å«channelç­‰ä¿¡æ¯çš„<a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/select.go#L29">runtime.scaseç»“æ„</a></li>
<li>2ã€è°ƒç”¨è¿è¡Œæ—¶å‡½æ•°selectgoä»å¤šä¸ªå°±ç»ªçš„channelä¸­é€‰æ‹©ä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„scaseç»“æ„ä½“ã€‚</li>
<li>3ã€forå¾ªç¯ç”Ÿæˆä¸€ç»„ifè¯­å¥ï¼Œåˆ¤æ–­caseæ˜¯å¦è¢«é€‰ä¸­ã€‚</li>
</ul>
<h5 id="caseè½¬æ¢ä¸ºifçš„æƒ…å†µï¼š"><a class="header-anchor" href="#caseè½¬æ¢ä¸ºifçš„æƒ…å†µï¼š">Â¶</a>caseè½¬æ¢ä¸ºifçš„æƒ…å†µï¼š</h5>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/select.go#L542">reflect_rselectğŸ”—</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:linkname reflect_rselect reflect.rselect</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflect_rselect</span><span class="params">(cases []runtimeSelect)</span></span> (<span class="type">int</span>, <span class="type">bool</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cases) == <span class="number">0</span> &#123;</span><br><span class="line">		block()</span><br><span class="line">	&#125;</span><br><span class="line">	sel := <span class="built_in">make</span>([]scase, <span class="built_in">len</span>(cases)) <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">	orig := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(cases))</span><br><span class="line">	nsends, nrecvs := <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">	dflt := <span class="number">-1</span></span><br><span class="line">	<span class="keyword">for</span> i, rc := <span class="keyword">range</span> cases &#123;</span><br><span class="line">		<span class="keyword">var</span> j <span class="type">int</span></span><br><span class="line">		<span class="keyword">switch</span> rc.dir &#123;</span><br><span class="line">		<span class="keyword">case</span> selectDefault:</span><br><span class="line">			dflt = i</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">case</span> selectSend:</span><br><span class="line">			j = nsends</span><br><span class="line">			nsends++</span><br><span class="line">		<span class="keyword">case</span> selectRecv:</span><br><span class="line">			nrecvs++</span><br><span class="line">			j = <span class="built_in">len</span>(cases) - nrecvs</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		sel[j] = scase&#123;c: rc.ch, elem: rc.val&#125;</span><br><span class="line">		orig[j] = i</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Only a default case. åªæœ‰defaultçš„æƒ…å†µ</span></span><br><span class="line">	<span class="keyword">if</span> nsends+nrecvs == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> dflt, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compact sel and orig if necessary.</span></span><br><span class="line">	<span class="keyword">if</span> nsends+nrecvs &lt; <span class="built_in">len</span>(cases) &#123;</span><br><span class="line">		<span class="built_in">copy</span>(sel[nsends:], sel[<span class="built_in">len</span>(cases)-nrecvs:])</span><br><span class="line">		<span class="built_in">copy</span>(orig[nsends:], orig[<span class="built_in">len</span>(cases)-nrecvs:])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	order := <span class="built_in">make</span>([]<span class="type">uint16</span>, <span class="number">2</span>*(nsends+nrecvs))</span><br><span class="line">	<span class="keyword">var</span> pc0 *<span class="type">uintptr</span></span><br><span class="line">	<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">		pcs := <span class="built_in">make</span>([]<span class="type">uintptr</span>, nsends+nrecvs)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> pcs &#123;</span><br><span class="line">			selectsetpc(&amp;pcs[i])</span><br><span class="line">		&#125;</span><br><span class="line">		pc0 = &amp;pcs[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//è°ƒç”¨selectgoè·å–ç»“æœ</span></span><br><span class="line">	chosen, recvOK := selectgo(&amp;sel[<span class="number">0</span>], &amp;order[<span class="number">0</span>], pc0, nsends, nrecvs, dflt == <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Translate chosen back to caller&#x27;s ordering.</span></span><br><span class="line">	<span class="keyword">if</span> chosen &lt; <span class="number">0</span> &#123;</span><br><span class="line">		chosen = dflt</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		chosen = orig[chosen]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> chosen, recvOK</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="selectgoä¸»å¾ªç¯"><a class="header-anchor" href="#selectgoä¸»å¾ªç¯">Â¶</a>selectgoä¸»å¾ªç¯</h4>
<blockquote>
<p>selectgoä¼šæ ¹æ®ä¸é€šçš„é€»è¾‘åˆ¤æ–­,è·³è½¬åˆ°ä¸é€šçš„é€»è¾‘ä¸­,ä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ éƒ¨åˆ†:</p>
</blockquote>
<ul>
<li>bufrecv å¯ä»¥ä»ç¼“å­˜åŒºè¯»å–æ•°æ®</li>
<li>bufsend å¯ä»¥å‘ç¼“å­˜åŒºå†™å…¥æ•°æ®</li>
<li>recv å¯ä»¥ä»ä¼‘çœ çš„å‘é€æ–¹è·å–æ•°æ®</li>
<li>send å¯ä»¥å‘ä¼‘çœ çš„æ¥æ”¶æ–¹å‘é€æ•°æ®</li>
<li>rclose å¯ä»¥ä»å…³é—­çš„channelè¯»å–EOF</li>
<li>sclose å¯ä»¥å‘å…³é—­çš„channelå‘é€æ•°æ®</li>
<li>retc ç»“æŸè°ƒç”¨å¹¶è¿”å›</li>
</ul>
<h5 id="send-recvåˆ†æ"><a class="header-anchor" href="#send-recvåˆ†æ">Â¶</a>send &amp; recvåˆ†æ</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">..</span><br><span class="line">...</span><br><span class="line">....</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line">	<span class="comment">// pass 1 - look for something already waiting</span></span><br><span class="line">	<span class="keyword">var</span> dfli <span class="type">int</span></span><br><span class="line">	<span class="keyword">var</span> dfl *scase</span><br><span class="line">	<span class="keyword">var</span> casi <span class="type">int</span></span><br><span class="line">	<span class="keyword">var</span> cas *scase</span><br><span class="line">	<span class="keyword">var</span> recvOK <span class="type">bool</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; ncases; i++ &#123;</span><br><span class="line">		casi = <span class="type">int</span>(pollorder[i])</span><br><span class="line">		cas = &amp;scases[casi]</span><br><span class="line">		c = cas.c</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> cas.kind &#123;</span><br><span class="line">		<span class="keyword">case</span> caseNil:</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> caseRecv:</span><br><span class="line">			sg = c.sendq.dequeue()</span><br><span class="line">			<span class="keyword">if</span> sg != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">goto</span> recv</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">//ç¼“å­˜åŒºtotal&gt;0</span></span><br><span class="line">				<span class="keyword">goto</span> bufrecv</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// chanå·²ç»å…³é—­</span></span><br><span class="line">				<span class="keyword">goto</span> rclose</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> caseSend:</span><br><span class="line">			<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">				racereadpc(c.raceaddr(), cas.pc, chansendpc)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// channelå…³é—­äº†,ä½†æ˜¯å‘å…¶å‘é€æ¶ˆæ¯</span></span><br><span class="line">				<span class="keyword">goto</span> sclose</span><br><span class="line">			&#125;</span><br><span class="line">			sg = c.recvq.dequeue()</span><br><span class="line">			<span class="keyword">if</span> sg != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="comment">// å‘å‡ºé˜Ÿçš„channelå‘é€æ¶ˆæ¯</span></span><br><span class="line">				<span class="keyword">goto</span> send</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">goto</span> bufsend</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> caseDefault:</span><br><span class="line">			dfli = casi</span><br><span class="line">			dfl = cas</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">.....</span><br><span class="line">....</span><br><span class="line">...</span><br><span class="line">..</span><br><span class="line">.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™é‡Œå¯èƒ½è¦æ¸©ä¹ ä¸‹hchanç»“æ„:</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">	qcount   <span class="type">uint</span>           <span class="comment">// total data in the queue</span></span><br><span class="line">	dataqsiz <span class="type">uint</span>           <span class="comment">// size of the circular queue</span></span><br><span class="line">	buf      unsafe.Pointer <span class="comment">// points to an array of dataqsiz elements</span></span><br><span class="line">	elemsize <span class="type">uint16</span></span><br><span class="line">	closed   <span class="type">uint32</span></span><br><span class="line">	elemtype *_type <span class="comment">// element type</span></span><br><span class="line">	sendx    <span class="type">uint</span>   <span class="comment">// send index</span></span><br><span class="line">	recvx    <span class="type">uint</span>   <span class="comment">// receive index</span></span><br><span class="line">	recvq    waitq  <span class="comment">// list of recv waiters</span></span><br><span class="line">	sendq    waitq  <span class="comment">// list of send waiters</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// lock protects all fields in hchan, as well as several</span></span><br><span class="line">	<span class="comment">// fields in sudogs blocked on this channel.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Do not change another G&#x27;s status while holding this lock</span></span><br><span class="line">	<span class="comment">// (in particular, do not ready a G), as this can deadlock</span></span><br><span class="line">	<span class="comment">// with stack shrinking.</span></span><br><span class="line">	lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="bufrecv"><a class="header-anchor" href="#bufrecv">Â¶</a>bufrecv:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">bufrecv:</span><br><span class="line">	<span class="comment">// can receive from buffer</span></span><br><span class="line">	<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">		<span class="keyword">if</span> cas.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">			raceWriteObjectPC(c.elemtype, cas.elem, cas.pc, chanrecvpc)</span><br><span class="line">		&#125;</span><br><span class="line">		raceacquire(chanbuf(c, c.recvx))</span><br><span class="line">		racerelease(chanbuf(c, c.recvx))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> msanenabled &amp;&amp; cas.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">		msanwrite(cas.elem, c.elemtype.size)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// recv èµ‹å€¼</span></span><br><span class="line">	recvOK = <span class="literal">true</span></span><br><span class="line">	qp = chanbuf(c, c.recvx) <span class="comment">// chanæŒ‡é’ˆæŒ‡å‘</span></span><br><span class="line">	<span class="keyword">if</span> cas.elem != <span class="literal">nil</span> &#123; </span><br><span class="line">		typedmemmove(c.elemtype, cas.elem, qp)</span><br><span class="line">	&#125;</span><br><span class="line">	typedmemclr(c.elemtype, qp)</span><br><span class="line">	c.recvx++</span><br><span class="line">	<span class="keyword">if</span> c.recvx == c.dataqsiz &#123;</span><br><span class="line">		c.recvx = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.qcount--</span><br><span class="line">	selunlock(scases, lockorder)</span><br><span class="line">	<span class="keyword">goto</span> retc</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="bufsend"><a class="header-anchor" href="#bufsend">Â¶</a>bufsend:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">bufsend:</span><br><span class="line">	<span class="comment">// can send to buffer</span></span><br><span class="line">	<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">		raceacquire(chanbuf(c, c.sendx))</span><br><span class="line">		racerelease(chanbuf(c, c.sendx))</span><br><span class="line">		raceReadObjectPC(c.elemtype, cas.elem, cas.pc, chansendpc)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> msanenabled &#123;</span><br><span class="line">		msanread(cas.elem, c.elemtype.size)</span><br><span class="line">	&#125;</span><br><span class="line">	typedmemmove(c.elemtype, chanbuf(c, c.sendx), cas.elem)</span><br><span class="line">	c.sendx++</span><br><span class="line">	<span class="keyword">if</span> c.sendx == c.dataqsiz &#123; <span class="comment">// ç¼“å­˜åŒºæ»¡äº†</span></span><br><span class="line">		c.sendx = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.qcount++</span><br><span class="line">	selunlock(scases, lockorder)</span><br><span class="line">	<span class="keyword">goto</span> retc</span><br></pre></td></tr></table></figure>
<h5 id="recv"><a class="header-anchor" href="#recv">Â¶</a>recv:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">recv:</span><br><span class="line">	<span class="comment">// can receive from sleeping sender (sg)</span></span><br><span class="line">	recv(c, sg, cas.elem, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; selunlock(scases, lockorder) &#125;, <span class="number">2</span>)</span><br><span class="line">	<span class="keyword">if</span> debugSelect &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;syncrecv: cas0=&quot;</span>, cas0, <span class="string">&quot; c=&quot;</span>, c, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	recvOK = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">goto</span> retc</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="rclose"><a class="header-anchor" href="#rclose">Â¶</a>rclose:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// read at end of closed channel</span></span><br><span class="line">selunlock(scases, lockorder)</span><br><span class="line">recvOK = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> cas.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">	typedmemclr(c.elemtype, cas.elem)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">	raceacquire(c.raceaddr())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> retc</span><br></pre></td></tr></table></figure>
<h5 id="send"><a class="header-anchor" href="#send">Â¶</a>send:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">send:</span><br><span class="line">	<span class="comment">// can send to a sleeping receiver (sg)</span></span><br><span class="line">	<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">		raceReadObjectPC(c.elemtype, cas.elem, cas.pc, chansendpc)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> msanenabled &#123;</span><br><span class="line">		msanread(cas.elem, c.elemtype.size)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// sendå‡½æ•°</span></span><br><span class="line">	send(c, sg, cas.elem, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; selunlock(scases, lockorder) &#125;, <span class="number">2</span>)</span><br><span class="line">	<span class="keyword">if</span> debugSelect &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;syncsend: cas0=&quot;</span>, cas0, <span class="string">&quot; c=&quot;</span>, c, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">goto</span> retc</span><br></pre></td></tr></table></figure>
<h5 id="sclose"><a class="header-anchor" href="#sclose">Â¶</a>sclose:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">sclose:</span><br><span class="line">	<span class="comment">// send on closed channel</span></span><br><span class="line">	selunlock(scases, lockorder)</span><br><span class="line">	<span class="comment">// å‘ä¸€ä¸ªcloseçš„channelå‘é€æ¶ˆæ¯,å°±å‘ç”Ÿpanic</span></span><br><span class="line">	<span class="built_in">panic</span>(plainError(<span class="string">&quot;send on closed channel&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="retc"><a class="header-anchor" href="#retc">Â¶</a>retc:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">retc:</span><br><span class="line">	<span class="keyword">if</span> cas.releasetime &gt; <span class="number">0</span> &#123;</span><br><span class="line">		blockevent(cas.releasetime-t0, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> casi, recvOK</span><br></pre></td></tr></table></figure>
<h4 id="channelçš„recvå’Œsendæ–¹å¼"><a class="header-anchor" href="#channelçš„recvå’Œsendæ–¹å¼">Â¶</a>channelçš„recvå’Œsendæ–¹å¼:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">1</span>ã€å½“ <span class="keyword">case</span> ä¸åŒ…å« Channel æ—¶ï¼›</span><br><span class="line">    è¿™ç§ <span class="keyword">case</span> ä¼šè¢«è·³è¿‡ï¼›</span><br><span class="line"><span class="number">2</span>ã€å½“ <span class="keyword">case</span> ä¼šä» Channel ä¸­recvæ•°æ®æ—¶ï¼›</span><br><span class="line">    å¦‚æœå½“å‰ Channel çš„ sendq ä¸Šæœ‰ç­‰å¾…çš„ Goroutineï¼Œå°±ä¼šè·³åˆ° recv æ ‡ç­¾å¹¶ä»ç¼“å†²åŒºè¯»å–æ•°æ®åå°†ç­‰å¾… Goroutine ä¸­çš„æ•°æ®æ”¾å…¥åˆ°ç¼“å†²åŒºä¸­ç›¸åŒçš„ä½ç½®ï¼›</span><br><span class="line">    å¦‚æœå½“å‰ Channel çš„ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œå°±ä¼šè·³åˆ° bufrecv æ ‡ç­¾å¤„ä»ç¼“å†²åŒºè·å–æ•°æ®ï¼›</span><br><span class="line">    å¦‚æœå½“å‰ Channel å·²ç»è¢«å…³é—­ï¼Œå°±ä¼šè·³åˆ° rclose åšä¸€äº›æ¸…é™¤çš„æ”¶å°¾å·¥ä½œï¼›</span><br><span class="line"><span class="number">3</span>ã€å½“ <span class="keyword">case</span> ä¼šå‘ Channel sendæ•°æ®æ—¶ï¼›</span><br><span class="line">    å¦‚æœå½“å‰ Channel å·²ç»è¢«å…³ï¼Œé—­å°±ä¼šç›´æ¥è·³åˆ° sclose æ ‡ç­¾ï¼Œè§¦å‘ <span class="built_in">panic</span> å°è¯•ä¸­æ­¢ç¨‹åºï¼›</span><br><span class="line">    å¦‚æœå½“å‰ Channel çš„ recvq ä¸Šæœ‰ç­‰å¾…çš„ Goroutineï¼Œå°±ä¼šè·³åˆ° send æ ‡ç­¾å‘ Channel å‘é€æ•°æ®ï¼›</span><br><span class="line">    å¦‚æœå½“å‰ Channel çš„ç¼“å†²åŒºå­˜åœ¨ç©ºé—²ä½ç½®ï¼Œå°±ä¼šå°†å¾…å‘é€çš„æ•°æ®å­˜å…¥ç¼“å†²åŒºï¼›</span><br><span class="line"><span class="number">4</span>ã€å½“ <span class="keyword">select</span> è¯­å¥ä¸­åŒ…å« <span class="keyword">default</span> æ—¶ï¼›</span><br><span class="line">    è¡¨ç¤ºå‰é¢çš„æ‰€æœ‰ <span class="keyword">case</span> éƒ½æ²¡æœ‰è¢«æ‰§è¡Œï¼Œè¿™é‡Œä¼šè§£é”æ‰€æœ‰ Channel å¹¶è¿”å›ï¼Œæ„å‘³ç€å½“å‰ <span class="keyword">select</span> ç»“æ„ä¸­çš„æ”¶å‘éƒ½æ˜¯éé˜»å¡çš„ï¼›</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ38ã€ä¸Šäº¿æ•°æ®çš„å¿«é€Ÿæ’åº</title>
    <url>/archives/26af015.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å‰é¢è¯´åˆ°äº†å¿«é€Ÿæ’åºçš„è‡ªå®šä¹‰é€šç”¨æ–¹æ¡ˆ:</p>
<p><a href="https://blog.imrcrab.com/archives/aa75061e.html#more">ã€Œ37ã€Quick Sortå¿«é€Ÿæ’åº</a></p>
<blockquote>
<p>ä½†æ˜¯åˆæœ‰ä¸€ä¸ªæ–°æƒ³æ³•: 1äº¿æ¡æ•°æ®,100Må†…å­˜,æ€ä¹ˆæ?</p>
</blockquote>
<span id="more"></span>
<h3 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h3>
<h4 id="é—®é¢˜"><a class="header-anchor" href="#é—®é¢˜">Â¶</a>é—®é¢˜</h4>
<ul>
<li>å†…å­˜ä¸è¶³ä»¥æ”¾1äº¿æ¡æ•°æ®</li>
<li>å³ä½¿å¤Ÿç”¨,ä¸€æ¬¡æŠŠ1äº¿æ¡æ•°æ®æ”¾å…¥å†…å­˜,å¦‚æœè¯´é«˜å¹¶å‘ä¸‹,æ¯æ¬¡éƒ½æ˜¯1äº¿,æ¶ˆè€—è¿‡å¤§!</li>
</ul>
<h4 id="è§£å†³æ€è·¯"><a class="header-anchor" href="#è§£å†³æ€è·¯">Â¶</a>è§£å†³æ€è·¯:</h4>
<p>å¤§åŒ–å°,å°å½’å¤§ã€Œå½’å¹¶ç®—æ³•çš„æ€æƒ³ã€,åˆ©ç”¨ç£ç›˜æ–‡ä»¶å½¢å¼è¿›è¡Œå­˜å‚¨,æ¯”è¾ƒ,å†å­˜å‚¨â€¦</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/sort_1.png" alt=""></p>
<h4 id="ä»£ç éƒ¨åˆ†ã€Œå…¶å®ƒè¯­è¨€ç±»ä¼¼ã€"><a class="header-anchor" href="#ä»£ç éƒ¨åˆ†ã€Œå…¶å®ƒè¯­è¨€ç±»ä¼¼ã€">Â¶</a>ä»£ç éƒ¨åˆ†ã€Œå…¶å®ƒè¯­è¨€ç±»ä¼¼ã€:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="type">string</span></span><br><span class="line">	Age   <span class="type">int</span></span><br><span class="line">	Count <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = <span class="number">100000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> SplitNum = Counter / <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QuickSortAll</span><span class="params">(a []<span class="keyword">interface</span>&#123;&#125;, left, right <span class="type">int</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) []<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">if</span> left &lt; right &#123;</span><br><span class="line">		mid := partitionAll(a, left, right, By)</span><br><span class="line">		QuickSortAll(a, left, mid<span class="number">-1</span>, By)</span><br><span class="line">		QuickSortAll(a, mid+<span class="number">1</span>, right, By)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">partitionAll</span><span class="params">(a []<span class="keyword">interface</span>&#123;&#125;, left <span class="type">int</span>, right <span class="type">int</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) <span class="type">int</span> &#123;</span><br><span class="line">	pivot := a[left]</span><br><span class="line">	<span class="keyword">for</span> ; left &lt; right; &#123;</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[right] &gt;= pivot; &#123;</span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; By(a[right], pivot); &#123;</span><br><span class="line">			right--</span><br><span class="line">		&#125;</span><br><span class="line">		a[left] = a[right]</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[left] &lt;= pivot; &#123;</span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; By(pivot, a[left]); &#123;</span><br><span class="line">			left++</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		a[right] = a[left]</span><br><span class="line">	&#125;</span><br><span class="line">	a[left] = pivot</span><br><span class="line">	<span class="keyword">return</span> left</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartSort</span><span class="params">(dirName <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> lock sync.Mutex</span><br><span class="line">	resultPaths := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line">	group, _ := errgroup.WithContext(context.TODO())</span><br><span class="line">	<span class="keyword">for</span> ia := <span class="number">0</span>; ia &lt; Counter; ia += SplitNum * <span class="number">2</span> &#123;</span><br><span class="line">		i := ia</span><br><span class="line">		<span class="comment">//group.Go(func() error &#123;</span></span><br><span class="line">		Mem(<span class="string">&quot;compareTwoFileObject&quot;</span>)</span><br><span class="line">		filePath, _ := compareTwoFileObject(dirName+<span class="string">&quot;/&quot;</span>+strconv.Itoa(i)+<span class="string">&quot;_split_quicksort.txt&quot;</span>,</span><br><span class="line">			dirName+<span class="string">&quot;/&quot;</span>+strconv.Itoa(i+SplitNum)+<span class="string">&quot;_split_quicksort.txt&quot;</span>, dirName, SortBy)</span><br><span class="line">		lock.Lock()</span><br><span class="line"></span><br><span class="line">		resultPaths = <span class="built_in">append</span>(resultPaths, filePath)</span><br><span class="line">		lock.Unlock()</span><br><span class="line">		<span class="comment">//return nil</span></span><br><span class="line">		<span class="comment">//&#125;)</span></span><br><span class="line">	&#125;</span><br><span class="line">	group.Wait()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> recursionDeal(resultPaths, dirName, lock)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recursionDeal</span><span class="params">(paths []<span class="type">string</span>, dirName <span class="type">string</span>, lock sync.Mutex)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	tmpPaths := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(paths) == <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> paths[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	group, _ := errgroup.WithContext(context.TODO())</span><br><span class="line">	<span class="keyword">for</span> ia := <span class="number">0</span>; ia &lt; <span class="built_in">len</span>(paths); ia += <span class="number">2</span> &#123;</span><br><span class="line">		i := ia</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(paths)%<span class="number">2</span> != <span class="number">0</span> &amp;&amp; i == <span class="built_in">len</span>(paths)<span class="number">-1</span> &#123;</span><br><span class="line">			lock.Lock()</span><br><span class="line">			tmpPaths = <span class="built_in">append</span>(tmpPaths, paths[i])</span><br><span class="line">			lock.Unlock()</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//group.Go(func() error &#123;</span></span><br><span class="line">		filePath, _ := compareTwoFileObjectForRecursion(dirName+<span class="string">&quot;/&quot;</span>+paths[i], dirName+<span class="string">&quot;/&quot;</span>+paths[i+<span class="number">1</span>], dirName, SortBy)</span><br><span class="line">		lock.Lock()</span><br><span class="line">		tmpPaths = <span class="built_in">append</span>(tmpPaths, filePath)</span><br><span class="line">		lock.Unlock()</span><br><span class="line">		Mem(<span class="string">&quot;recursionDealï¼š&quot;</span> + filePath)</span><br><span class="line">		<span class="comment">//return nil</span></span><br><span class="line">		<span class="comment">//&#125;)</span></span><br><span class="line">	&#125;</span><br><span class="line">	_ = group.Wait()</span><br><span class="line">	<span class="keyword">return</span> recursionDeal(tmpPaths, dirName, lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compareTwoFileObject</span><span class="params">(filePathBefore, filePathAfter, dirName <span class="type">string</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) (resultFilePath <span class="type">string</span>, errRet <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		os.Remove(filePathBefore)</span><br><span class="line">		os.Remove(filePathAfter)</span><br><span class="line">	&#125;()</span><br><span class="line">	fileBefore, _ := readObjectFromFile(filePathBefore)</span><br><span class="line">	fileAfter, _ := readObjectFromFile(filePathAfter)</span><br><span class="line">	resultFilePath = sha1s(strconv.Itoa(<span class="type">int</span>(time.Now().UnixNano()))) + <span class="string">&quot;_split_quicksort.txt&quot;</span></span><br><span class="line">	f, _ := os.OpenFile(dirName+<span class="string">&quot;/&quot;</span>+resultFilePath, os.O_CREATE|os.O_RDWR|os.O_APPEND, os.ModeAppend|os.ModePerm)</span><br><span class="line"></span><br><span class="line">	flag := <span class="number">0</span></span><br><span class="line">	flagResultAfter := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(fileBefore); i++ &#123;</span><br><span class="line">		tmp := fileBefore[i]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> ai := flag; ai &lt; <span class="built_in">len</span>(fileAfter); ai++ &#123;</span><br><span class="line">			<span class="keyword">if</span> flag+<span class="number">1</span> == <span class="built_in">len</span>(fileAfter) &#123;</span><br><span class="line">				<span class="comment">// fileAfteréå†å®Œäº†</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(fileAfter) == ai+<span class="number">1</span> &#123;</span><br><span class="line">				<span class="comment">// æœ€åèµ‹å€¼</span></span><br><span class="line">				flag = ai</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> By(tmp, fileAfter[ai]) &#123;</span><br><span class="line">				tmpJson, _ := json.Marshal(fileAfter[ai])</span><br><span class="line">				f.WriteString(<span class="type">string</span>(tmpJson) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">				flagResultAfter = ai</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			flag = ai</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tmpJson, _ := json.Marshal(tmp)</span><br><span class="line">		f.WriteString(<span class="type">string</span>(tmpJson) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> fileAfter == <span class="literal">nil</span> &#123;</span><br><span class="line">		f.Close()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> flagResultAfter &lt; <span class="built_in">len</span>(fileAfter) &#123;</span><br><span class="line">		flagResultAfter++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fileAfter = fileAfter[flagResultAfter:]</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> fileAfter &#123;</span><br><span class="line">		tmpJson, _ := json.Marshal(v)</span><br><span class="line">		f.WriteString(<span class="type">string</span>(tmpJson) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	f.Close()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®,ç”¨äºæ’åº</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readObjectFromFile</span><span class="params">(filePath <span class="type">string</span>)</span></span> (users []<span class="keyword">interface</span>&#123;&#125;, errRet <span class="type">error</span>) &#123;</span><br><span class="line">	fileBefore, err := os.Open(filePath)</span><br><span class="line">	<span class="keyword">defer</span> fileBefore.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errRet = err</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	brBefore := bufio.NewReader(fileBefore)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		a, _, c := brBefore.ReadLine()</span><br><span class="line">		<span class="keyword">if</span> c == io.EOF &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(a) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		users = <span class="built_in">append</span>(users, resolveObject(a))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(users) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	QuickSortAll(users, <span class="number">0</span>, <span class="built_in">len</span>(users)<span class="number">-1</span>, SortBy)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Mem</span><span class="params">(msg <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	fmt.Println(msg, <span class="string">&quot;ç³»ç»Ÿå†…å­˜ï¼š&quot;</span>, m.Sys, <span class="string">&quot;   å¸¸é©»å†…å­˜ï¼š&quot;</span>, m.HeapInuse, <span class="string">&quot;    å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š &quot;</span>, m.HeapAlloc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹äºä¸¤ä¸ªæ’åºå¥½çš„æ–‡ä»¶,è¿›è¡Œæ¯”è¾ƒå¹¶å­˜å‚¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compareTwoFileObjectForRecursion</span><span class="params">(filePathBefore, filePathAfter, dirName <span class="type">string</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) (resultFilePath <span class="type">string</span>, errRet <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	resultFilePath = sha1s(strconv.Itoa(<span class="type">int</span>(time.Now().UnixNano()))) + <span class="string">&quot;_split_quicksort.txt&quot;</span></span><br><span class="line">	f, _ := os.OpenFile(dirName+<span class="string">&quot;/&quot;</span>+resultFilePath, os.O_CREATE|os.O_RDWR|os.O_APPEND, os.ModeAppend|os.ModePerm)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		os.Remove(filePathBefore)</span><br><span class="line">		os.Remove(filePathAfter)</span><br><span class="line">	&#125;()</span><br><span class="line">	fileBefore, err := os.Open(filePathBefore)</span><br><span class="line">	<span class="keyword">defer</span> fileBefore.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errRet = err</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	brBefore := bufio.NewReader(fileBefore)</span><br><span class="line"></span><br><span class="line">	fileAfter, err := os.Open(filePathAfter)</span><br><span class="line">	<span class="keyword">defer</span> fileAfter.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errRet = err</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	brAfter := bufio.NewReader(fileAfter)</span><br><span class="line"></span><br><span class="line">	fa := <span class="literal">true</span></span><br><span class="line">	fb := <span class="literal">true</span></span><br><span class="line">	<span class="keyword">var</span> va, vb []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> ca, cb <span class="type">error</span></span><br><span class="line">		<span class="keyword">if</span> fa &#123;</span><br><span class="line">			a, _, cae := brBefore.ReadLine()</span><br><span class="line">			va = a</span><br><span class="line">			ca = cae</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> fb &#123;</span><br><span class="line">			b, _, cbe := brAfter.ReadLine()</span><br><span class="line">			vb = b</span><br><span class="line">			cb = cbe</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ca == io.EOF || cb == io.EOF &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(va) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(vb) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		bUser := User&#123;&#125;</span><br><span class="line">		_ = json.Unmarshal(vb, &amp;bUser)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> By(resolveObject(va), resolveObject(vb)) &#123;</span><br><span class="line"></span><br><span class="line">			f.WriteString(<span class="type">string</span>(vb) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			fb = <span class="literal">true</span></span><br><span class="line">			fa = <span class="literal">false</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">			f.WriteString(<span class="type">string</span>(va) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			fa = <span class="literal">true</span></span><br><span class="line">			fb = <span class="literal">false</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		a, _, ca := brBefore.ReadLine()</span><br><span class="line">		<span class="keyword">if</span> ca == io.EOF &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		f.WriteString(<span class="type">string</span>(a) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		b, _, ca := brBefore.ReadLine()</span><br><span class="line">		<span class="keyword">if</span> ca == io.EOF &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		f.WriteString(<span class="type">string</span>(b) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Mem(filePathBefore + <span class="string">&quot;=====&gt;&quot;</span> + filePathAfter)</span><br><span class="line"></span><br><span class="line">	f.Close()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰åºåˆ—åŒ–å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resolveObject</span><span class="params">(a []<span class="type">byte</span>)</span></span> User &#123;</span><br><span class="line">	user := User&#123;&#125;</span><br><span class="line">	_ = json.Unmarshal(a, &amp;user)</span><br><span class="line">	<span class="keyword">return</span> user</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ’åº</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SortBy</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a.(User).Age &lt;= b.(User).Age <span class="comment">//æŒ‰ç…§countæ’åº</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sha1s</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	r := sha1.Sum([]<span class="type">byte</span>(s))</span><br><span class="line">	<span class="keyword">return</span> hex.EncodeToString(r[:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹">Â¶</a>æ³¨æ„äº‹é¡¹:</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210221_110111.png" alt=""></p>
<blockquote>
<p>ä¸»å‡½æ•°,è¿™æ¬¡çš„æ•°æ®éƒ½æ˜¯è‡ªå·±é€ çš„,å®æ™¯å°±æŒ‰ç…§æŸæŸæŸæ¥æºæ¥æ“ä½œæŠŠ.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dirName := <span class="string">&quot;tmp_quick_sort&quot;</span> + time.Now().Format(<span class="string">&quot;2006_01_02_15_04_05&quot;</span>)</span><br><span class="line">	err2 := os.Mkdir(dirName, os.ModeAppend|os.ModePerm)</span><br><span class="line">	<span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	f, err := os.OpenFile(dirName+<span class="string">&quot;/0_split_quicksort.txt&quot;</span>, os.O_CREATE|os.O_RDWR|os.O_APPEND, os.ModeAppend|os.ModePerm)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(f)</span><br><span class="line">	&#125;</span><br><span class="line">	t := time.Now().Unix()</span><br><span class="line">	Mem(<span class="string">&quot;before write file&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; quicksort.Counter; i++ &#123;</span><br><span class="line">		auser := quicksort.User&#123;</span><br><span class="line">			Name:  strconv.Itoa(i),</span><br><span class="line">			Age:   i,</span><br><span class="line">			Count: rand.Intn(quicksort.Counter),</span><br><span class="line">		&#125;</span><br><span class="line">		marshal, _ := json.Marshal(auser)</span><br><span class="line"></span><br><span class="line">		f.Write(marshal)</span><br><span class="line">		f.Write([]<span class="type">byte</span>(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">		<span class="keyword">if</span> i%quicksort.SplitNum == <span class="number">0</span> &#123;</span><br><span class="line">			f.Close()</span><br><span class="line">			Mem(strconv.Itoa(i) + <span class="string">&quot;after write file&quot;</span>)</span><br><span class="line">			f, err = os.OpenFile(dirName+<span class="string">&quot;/&quot;</span>+strconv.Itoa(i)+<span class="string">&quot;_split_quicksort.txt&quot;</span>, os.O_CREATE|os.O_RDWR|os.O_APPEND, os.ModeAppend|os.ModePerm)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	f.Close()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	Mem(<span class="string">&quot;after write file&quot;</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;filename: &quot;</span>, quicksort.StartSort(dirName))</span><br><span class="line"></span><br><span class="line">	fmt.Println(time.Now().Unix() - t)</span><br><span class="line">	Mem(<span class="string">&quot;last msg&quot;</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Println(unsafe.Sizeof([<span class="number">100000</span>]quicksort.User&#123;&#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ç»“æœåˆ°åº•æ˜¯å¦å¦‚è®¾è®¡çš„é‚£æ ·å¯è¡Œå‘¢"><a class="header-anchor" href="#ç»“æœåˆ°åº•æ˜¯å¦å¦‚è®¾è®¡çš„é‚£æ ·å¯è¡Œå‘¢">Â¶</a>ç»“æœåˆ°åº•æ˜¯å¦å¦‚è®¾è®¡çš„é‚£æ ·å¯è¡Œå‘¢?</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210221_102841.png" alt=""></p>
<h5 id="å†…å­˜æ‰“å°çš„å®é™…æƒ…å†µ"><a class="header-anchor" href="#å†…å­˜æ‰“å°çš„å®é™…æƒ…å†µ">Â¶</a>å†…å­˜æ‰“å°çš„å®é™…æƒ…å†µ</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210221_103339.png" alt=""></p>
<h3 id="åç»­æ”¹è¿›"><a class="header-anchor" href="#åç»­æ”¹è¿›">Â¶</a>åç»­æ”¹è¿›</h3>
<h4 id="ç—›ç‚¹"><a class="header-anchor" href="#ç—›ç‚¹">Â¶</a>ç—›ç‚¹:</h4>
<ul>
<li>å•ä¸ªæœåŠ¡å™¨,é€Ÿåº¦å¤ªæ…¢</li>
<li>å•çº¿ç¨‹,æœ‰ç‚¹æ…¢ã€Œç£ç›˜è¯»å†™é€Ÿåº¦ä¸å¿«çš„,å»ºè®®å°±ä½¿ç”¨å•çº¿ç¨‹ã€</li>
<li>æ²¡æœ‰æ–­ç‚¹ã€Œç”µã€ç»§ç»­çš„æœºåˆ¶.</li>
</ul>
<h4 id="æ”¹è¿›æ–¹æ³•"><a class="header-anchor" href="#æ”¹è¿›æ–¹æ³•">Â¶</a>æ”¹è¿›æ–¹æ³•:</h4>
<ul>
<li>å¤šæœåŠ¡å™¨è®¡ç®—</li>
<li>æ”¹è¿›æ’åº,å•æœåŠ¡å™¨å¯ä»¥åˆ†å·¦å³ä¸¤éƒ¨åˆ†</li>
<li>å¢åŠ ä»»åŠ¡è®°å½•æœºåˆ¶,ç”¨äºæ–­ç‚¹ç»§ç»­ä»»åŠ¡.</li>
</ul>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Sort</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ37ã€Quick Sortå¿«é€Ÿæ’åº</title>
    <url>/archives/aa75061e.html</url>
    <content><![CDATA[<!-- toc -->
<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>æœ€è¿‘åœ¨æƒ³ä¸€ä¸ªé—®é¢˜ï¼šGoé‡Œé¢çš„sortåŒ…åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œï¼Œï¼Œï¼Œ<br>
æƒ³ç€æƒ³ç€å°±æƒ³åˆ°äº†å¿«é€Ÿæ’åºï¼Œå°±è¯•ç€æ‰‹æ’•äº†ä¸€ä¸ªï¼Œ</p>
<p>æœ‰ä¸ªå…³é”®é—®é¢˜ï¼Œæ‰€æœ‰çš„éƒ½æ˜¯é’ˆå¯¹intæˆ–è€…å…¶å®ƒç‰¹å®šçš„ç±»å‹ï¼Œ</p>
<p><em>é‚£å¦‚ä½•è®©æ’åºç®—æ³•é€šç”¨æ€§å‘¢ï¼Œ</em></p>
<span id="more"></span>
<h3 id="å¿«é€Ÿæ’åº"><a class="header-anchor" href="#å¿«é€Ÿæ’åº">Â¶</a>å¿«é€Ÿæ’åº</h3>
<p>ä¸åºŸè¯ï¼Œå…ˆæä¸€ä¸ªæ’åºçš„ä»£ç æ¥ï¼Œå†åˆ†æã€Œéµå¾ªå…ˆç”¨ååˆ†æçš„åŸåˆ™ã€</p>
<blockquote>
<p>é»˜è®¤ä»å¤§â€“&gt;å°ï¼Œæ³¨é‡Šçš„é‚£è¡Œæ”¾å¼€å°±æ˜¯ ä»å°â€“&gt;å¤§</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QuickSort</span><span class="params">(a []<span class="type">int</span>, left, right <span class="type">int</span>)</span></span> []<span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> left &lt; right &#123;</span><br><span class="line">		mid := partition(a, left, right)</span><br><span class="line">		QuickSort(a, left, mid<span class="number">-1</span>)</span><br><span class="line">		QuickSort(a, mid+<span class="number">1</span>, right)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">partition</span><span class="params">(a []<span class="type">int</span>, left <span class="type">int</span>, right <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	pivot := a[left] <span class="comment">//åŸºç‚¹</span></span><br><span class="line">	<span class="keyword">for</span> ; left &lt; right; &#123;</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[right] &gt;= pivot; &#123; </span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; a[right] &lt;= pivot; &#123;</span><br><span class="line">			right--</span><br><span class="line">		&#125;</span><br><span class="line">		a[left] = a[right]</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[left] &lt;= pivot; &#123;</span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; a[left] &gt;= pivot; &#123;</span><br><span class="line">			left++</span><br><span class="line">		&#125;</span><br><span class="line">		a[right] = a[left]</span><br><span class="line">	&#125;</span><br><span class="line">	a[left] = pivot</span><br><span class="line">	<span class="keyword">return</span> left</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="è°ƒç”¨åˆ†æ"><a class="header-anchor" href="#è°ƒç”¨åˆ†æ">Â¶</a>è°ƒç”¨åˆ†æ</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">	num :=QuickSort(s, <span class="number">0</span>, <span class="built_in">len</span>(s)<span class="number">-1</span>)</span><br><span class="line">	fmt.Println(num)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Outputs"><a class="header-anchor" href="#Outputs">Â¶</a>Outputs:</h5>
<blockquote>
<p>[7 6 5 4 3 2 1]</p>
</blockquote>
<h4 id="ä¸è¶³ç‚¹ï¼š"><a class="header-anchor" href="#ä¸è¶³ç‚¹ï¼š">Â¶</a>ä¸è¶³ç‚¹ï¼š</h4>
<ul>
<li>åªèƒ½ç”¨åœ¨intå‹æˆ–è€…æŒ‡å®šçš„ç±»å‹ï¼Œã€Œä¸çˆ½ğŸ˜•ã€</li>
<li>åŸºç‚¹åœ¨æœ€å·¦è¾¹ã€Œåé¢åˆ†æä¸ºä½•ä¸å¥½ã€</li>
</ul>
<h5 id="æ”¹è¿›ç‚¹ï¼š"><a class="header-anchor" href="#æ”¹è¿›ç‚¹ï¼š">Â¶</a>æ”¹è¿›ç‚¹ï¼š</h5>
<blockquote>
<p>æ—¢ç„¶æ˜¯éœ€è¦æ”¹è¿›ï¼Œé‚£å°±æœç€ä¸Šé¢çš„ä¸è¶³ç‚¹æ¥æã€‚</p>
</blockquote>
<ul>
<li>é€šç”¨ç±»å‹çš„è®¾è®¡ï¼Œã€Œç”¨goçš„æ–­è¨€ï¼šinterfaceæ¥åšã€</li>
<li>åŸºç‚¹çš„é€‰å–å°½é‡å‡è¡¡ã€Œå¯é€‰é¡¹ã€</li>
</ul>
<h4 id="Just-do-it"><a class="header-anchor" href="#Just-do-it">Â¶</a>Just do it</h4>
<h5 id="è‡ªå®šä¹‰æ’åºè§„åˆ™åšæ³•ï¼š"><a class="header-anchor" href="#è‡ªå®šä¹‰æ’åºè§„åˆ™åšæ³•ï¼š">Â¶</a>è‡ªå®šä¹‰æ’åºè§„åˆ™åšæ³•ï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QuickSortAll</span><span class="params">(a []<span class="keyword">interface</span>&#123;&#125;, left, right <span class="type">int</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) []<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">if</span> left &lt; right &#123;</span><br><span class="line">		mid := partitionAll(a, left, right, By)</span><br><span class="line">		QuickSortAll(a, left, mid<span class="number">-1</span>, By)</span><br><span class="line">		QuickSortAll(a, mid+<span class="number">1</span>, right, By)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">partitionAll</span><span class="params">(a []<span class="keyword">interface</span>&#123;&#125;, left <span class="type">int</span>, right <span class="type">int</span>, By <span class="keyword">func</span>(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) <span class="type">int</span> &#123;</span><br><span class="line">	pivot := a[left]</span><br><span class="line">	<span class="keyword">for</span> ; left &lt; right; &#123;</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[right] &gt;= pivot; &#123;</span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; By(a[right], pivot); &#123;</span><br><span class="line">			right--</span><br><span class="line">		&#125;</span><br><span class="line">		a[left] = a[right]</span><br><span class="line">		<span class="comment">//for ; left &lt; right &amp;&amp; a[left] &lt;= pivot; &#123;</span></span><br><span class="line">		<span class="keyword">for</span> ; left &lt; right &amp;&amp; By(pivot, a[left]); &#123;</span><br><span class="line">			left++</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		a[right] = a[left]</span><br><span class="line">	&#125;</span><br><span class="line">	a[left] = pivot</span><br><span class="line">	<span class="keyword">return</span> left</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="type">string</span></span><br><span class="line">	Age   <span class="type">int</span></span><br><span class="line">	Count <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counter = <span class="number">100000000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	isp := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, counter)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; counter; i++ &#123;</span><br><span class="line">		isp = <span class="built_in">append</span>(isp, User&#123;</span><br><span class="line">			Name:  strconv.Itoa(i),</span><br><span class="line">			Age:   i,</span><br><span class="line">			Count: rand.Intn(counter),</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	t := time.Now().Unix()</span><br><span class="line"></span><br><span class="line">	_ = QuickSortAll(isp, <span class="number">0</span>, <span class="built_in">len</span>(isp)<span class="number">-1</span>, <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="comment">// return a.(User).Count &gt;= b.(User).Count //æŒ‰ç…§countæ’åº ä»å°åˆ°å¤§</span></span><br><span class="line">        <span class="keyword">return</span> a.(User).Count &lt;= b.(User).Count <span class="comment">//æŒ‰ç…§countæ’åº  ä»å¤§åˆ°å°</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">//fmt.Println(num)</span></span><br><span class="line">	fmt.Println(time.Now().Unix() - t)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Outputsï¼š"><a class="header-anchor" href="#Outputsï¼š">Â¶</a>Outputsï¼š</h6>
<blockquote>
<p>91</p>
</blockquote>
<h5 id="è·‘ä¸ªbenchmarkçœ‹çœ‹"><a class="header-anchor" href="#è·‘ä¸ªbenchmarkçœ‹çœ‹">Â¶</a>è·‘ä¸ªbenchmarkçœ‹çœ‹</h5>
<blockquote>
<p>ä¸Šé¢çš„å˜é‡counter=10000000</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">goos: darwin</span><br><span class="line">goarch: amd64</span><br><span class="line">cpu: Intel(R) Core(TM) i7<span class="number">-9750</span>H CPU @ <span class="number">2.60</span>GHz</span><br><span class="line">BenchmarkQuickSortAll</span><br><span class="line">BenchmarkQuickSortAll<span class="number">-12</span>    	       <span class="number">1</span>	<span class="number">6287198265</span> ns/op</span><br><span class="line">PASS</span><br></pre></td></tr></table></figure>
<h4 id="å†…å­˜å ç”¨åˆ†æ"><a class="header-anchor" href="#å†…å­˜å ç”¨åˆ†æ">Â¶</a>å†…å­˜å ç”¨åˆ†æ</h4>
<blockquote>
<p>æ”¹é€ ä¸‹æ‰§è¡Œå‡½æ•°,åŠ ä¸Šæ‰“å°å†…å­˜æƒ…å†µ:</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for start&quot;</span>))</span><br><span class="line">	isp := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, counter)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; counter; i++ &#123;</span><br><span class="line">		isp = <span class="built_in">append</span>(isp, User&#123;</span><br><span class="line">			Name:  strconv.Itoa(i),</span><br><span class="line">			Age:   i,</span><br><span class="line">			Sage:  i,</span><br><span class="line">			Count: rand.Intn(counter),</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(unsafe.Sizeof(isp))</span><br><span class="line">	fmt.Println(unsafe.Sizeof([counter]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;))</span><br><span class="line">	t := time.Now().Unix()</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for all slice&quot;</span>))</span><br><span class="line">	_ = QuickSortAll(isp, <span class="number">0</span>, <span class="built_in">len</span>(isp)<span class="number">-1</span>, <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="comment">// return a.(User).Count &gt;= b.(User).Count //æŒ‰ç…§countæ’åº ä»å°åˆ°å¤§</span></span><br><span class="line">		<span class="keyword">return</span> a.(User).Count &lt;= b.(User).Count <span class="comment">//æŒ‰ç…§countæ’åº  ä»å¤§åˆ°å°</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">//fmt.Println(num)</span></span><br><span class="line">	fmt.Println(time.Now().Unix() - t)</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for all end&quot;</span>))</span><br><span class="line"></span><br><span class="line">	i := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> i &gt; <span class="number">10</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		runtime.GC()</span><br><span class="line">		Mem(fmt.Sprintf(<span class="string">&quot;for gc end&quot;</span>))</span><br><span class="line">		time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">		i++</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Mem</span><span class="params">(msg <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	fmt.Println(msg, <span class="string">&quot;ç³»ç»Ÿå†…å­˜&quot;</span>, m.Sys, <span class="string">&quot; å¸¸é©»å†…å­˜ï¼š&quot;</span>, m.HeapInuse, <span class="string">&quot;å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š &quot;</span>, m.HeapAlloc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="Outputs-v2"><a class="header-anchor" href="#Outputs-v2">Â¶</a>Outputs:</h5>
<blockquote>
<p>ä¸åŒçš„ç³»ç»Ÿå¯èƒ½ä¼šæœ‰äº›è®¸åå·®,å…³é”®ç‚¹ä¸åœ¨äºæ•°å€¼å¤§å°,<br>
å…³é”®ç‚¹åœ¨äº: å‘ç³»ç»Ÿç”³è¯·çš„å¤§å†…å­˜,æ²¡æœ‰å½’è¿˜ç»™ç³»ç»Ÿ,å¦‚æœè¯´è¦é¢‘ç¹çš„ç”³è¯·å¤§å†…å­˜ç­‰æ“ä½œ,<br>
æœ€å¥½è¿˜æ˜¯æä¸€ä¸ªpoolæ± å­,ä¸ç„¶å®¹æ˜“å†…å­˜æš´å¢æš´è·Œ.</p>
</blockquote>
<ul>
<li>æ­¤å¤„ <em>counter=10000000</em></li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> start ç³»ç»Ÿå†…å­˜ï¼š <span class="number">71388176</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">450560</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">130808</span></span><br><span class="line">ispå ç”¨çš„å­—èŠ‚å¤§å°ï¼šã€Œispç»“æ„å ç”¨ã€ <span class="number">24</span></span><br><span class="line">counterçš„åˆ‡ç‰‡å ç”¨çš„å­—èŠ‚å¤§å°ï¼š <span class="number">160000000</span></span><br><span class="line"><span class="keyword">for</span> all slice ç³»ç»Ÿå†…å­˜ï¼š <span class="number">784408744</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">722001920</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">719855360</span></span><br><span class="line">è€—æ—¶ï¼š  <span class="number">10</span>  S</span><br><span class="line"><span class="keyword">for</span> all end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">784408744</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">722010112</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">719855616</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131608</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131416</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131656</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131672</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131456</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131792</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131680</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131696</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131472</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131696</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">785326248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">417792</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131696</span></span><br></pre></td></tr></table></figure>
<h4 id="åç»­ä¼˜åŒ–ç‚¹"><a class="header-anchor" href="#åç»­ä¼˜åŒ–ç‚¹">Â¶</a>åç»­ä¼˜åŒ–ç‚¹:</h4>
<ul>
<li>å¦‚æœæ•°é‡è¿‡å¤§,å¯ä»¥æä¸ªå†…å­˜æ± </li>
<li>å¦‚æœæ•°é‡åºå¤§,å»ºè®®åˆ†æ²»,å¤šæ¬¡æ’åºã€Œè¿™ä¸ªæ•°æ®é‡ä¸€èˆ¬åœ¨G/Tçº§åˆ«ã€</li>
</ul>
<h5 id="æ•°é‡å¤§çš„å®éªŒ-å‡½æ•°å†…éƒ¨å¤ç”¨"><a class="header-anchor" href="#æ•°é‡å¤§çš„å®éªŒ-å‡½æ•°å†…éƒ¨å¤ç”¨">Â¶</a>æ•°é‡å¤§çš„å®éªŒ,å‡½æ•°å†…éƒ¨å¤ç”¨:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for start&quot;</span>))</span><br><span class="line">	isp := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, counter)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; counter; i++ &#123;</span><br><span class="line">		ssUser := User&#123;</span><br><span class="line">			Name:  strconv.Itoa(i),</span><br><span class="line">			Age:   i,</span><br><span class="line">			Sage:  i,</span><br><span class="line">			Count: rand.Intn(counter),</span><br><span class="line">		&#125;</span><br><span class="line">		isp = <span class="built_in">append</span>(isp,ssUser)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;ispå ç”¨çš„å­—èŠ‚å¤§å°ï¼šã€Œispç»“æ„å ç”¨ã€&quot;</span>, unsafe.Sizeof(isp))</span><br><span class="line">	fmt.Println(<span class="string">&quot;counterçš„åˆ‡ç‰‡å ç”¨çš„å­—èŠ‚å¤§å°ï¼š&quot;</span>, unsafe.Sizeof([counter]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;))</span><br><span class="line">	t := time.Now().Unix()</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for all slice&quot;</span>))</span><br><span class="line">	_ = QuickSortAll(isp, <span class="number">0</span>, <span class="built_in">len</span>(isp)<span class="number">-1</span>, <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="comment">// return a.(User).Count &gt;= b.(User).Count //æŒ‰ç…§countæ’åº ä»å°åˆ°å¤§</span></span><br><span class="line">		<span class="keyword">return</span> a.(User).Count &lt;= b.(User).Count <span class="comment">//æŒ‰ç…§countæ’åº  ä»å¤§åˆ°å°</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">//fmt.Println(num)</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;è€—æ—¶ï¼š &quot;</span>, time.Now().Unix()-t, <span class="string">&quot; S&quot;</span>)</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for all end&quot;</span>))</span><br><span class="line"></span><br><span class="line">	i := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> i &gt; <span class="number">3</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		runtime.GC()</span><br><span class="line">		Mem(fmt.Sprintf(<span class="string">&quot;for gc end&quot;</span>))</span><br><span class="line">		time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">		i++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//é‡Šæ”¾å†…å­˜,æ–­å¼€å¼•ç”¨</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> isp &#123;</span><br><span class="line">		isp[i] = <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	isp = isp[:<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	runtime.GC()</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;gc before new start %d&quot;</span>, i))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; counter; i++ &#123;</span><br><span class="line">		stmp := User&#123;&#125;</span><br><span class="line">		stmp.Name = strconv.Itoa(i)</span><br><span class="line">		stmp.Age = i</span><br><span class="line">		stmp.Sage = i</span><br><span class="line">		stmp.Count = rand.Intn(counter)</span><br><span class="line">		isp = <span class="built_in">append</span>(isp, stmp)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> i%<span class="number">1000000</span> == <span class="number">0</span> &#123;</span><br><span class="line">			Mem(fmt.Sprintf(<span class="string">&quot;slice %d&quot;</span>, i))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//fmt.Println(isp)</span></span><br><span class="line">	<span class="comment">// ******å…³é”®ç‚¹åœ¨äºè¿™ä¸ªåœ°æ–¹çš„å†…å­˜ä¼šä¸ä¼šæ˜¯å‰é¢åŒæ ·æ‰“å°å¤„çš„å€æ•°???</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;ispå ç”¨çš„å­—èŠ‚å¤§å°ï¼šã€Œispç»“æ„å ç”¨ã€&quot;</span>, unsafe.Sizeof(isp))</span><br><span class="line">	<span class="comment">//fmt.Println(&quot;counterçš„åˆ‡ç‰‡å ç”¨çš„å­—èŠ‚å¤§å°ï¼š&quot;, unsafe.Sizeof([counter]interface&#123;&#125;&#123;&#125;))</span></span><br><span class="line">	ts := time.Now().Unix()</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for all slice&quot;</span>))</span><br><span class="line">	_ = QuickSortAll(isp, <span class="number">0</span>, <span class="built_in">len</span>(isp)<span class="number">-1</span>, <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">		<span class="comment">// return a.(User).Count &gt;= b.(User).Count //æŒ‰ç…§countæ’åº ä»å°åˆ°å¤§</span></span><br><span class="line">		<span class="keyword">return</span> a.(User).Count &lt;= b.(User).Count <span class="comment">//æŒ‰ç…§countæ’åº  ä»å¤§åˆ°å°</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">//fmt.Println(num)</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;è€—æ—¶ï¼š &quot;</span>, time.Now().Unix()-ts, <span class="string">&quot; S&quot;</span>)</span><br><span class="line">	Mem(fmt.Sprintf(<span class="string">&quot;for all end&quot;</span>))</span><br><span class="line"></span><br><span class="line">	ia := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ia &gt; <span class="number">10</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		runtime.GC()</span><br><span class="line">		Mem(fmt.Sprintf(<span class="string">&quot;for gc end&quot;</span>))</span><br><span class="line">		time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">		ia++</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Mem</span><span class="params">(msg <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	fmt.Println(msg, <span class="string">&quot;ç³»ç»Ÿå†…å­˜ï¼š&quot;</span>, m.Sys, <span class="string">&quot;   å¸¸é©»å†…å­˜ï¼š&quot;</span>, m.HeapInuse, <span class="string">&quot;    å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š &quot;</span>, m.HeapAlloc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="Outputs-v3"><a class="header-anchor" href="#Outputs-v3">Â¶</a>Outputs:</h6>
<blockquote>
<p>è¿˜æ˜¯åŒæ ·çš„,å†…å­˜çš„å¤§å°ä¸é‡è¦,é‡è¦çš„æ˜¯çœ‹åˆ†å¸ƒ:</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">GOROOT=/usr/local/<span class="keyword">go</span> #gosetup</span><br><span class="line">GOPATH=/Users/k/<span class="keyword">go</span> #gosetup</span><br><span class="line">/usr/local/<span class="keyword">go</span>/bin/<span class="keyword">go</span> build -o /private/<span class="keyword">var</span>/folders/b0/hs49sy5x5qs1sw7cjxfm8gkm0000gn/T/___go_build_quicksort_go /Users/k/learn/<span class="keyword">go</span>-memory/src/main/quicksort.<span class="keyword">go</span> #gosetup</span><br><span class="line">/private/<span class="keyword">var</span>/folders/b0/hs49sy5x5qs1sw7cjxfm8gkm0000gn/T/___go_build_quicksort_go</span><br><span class="line"><span class="keyword">for</span> start ç³»ç»Ÿå†…å­˜ï¼š <span class="number">71388176</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">344064</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">130600</span></span><br><span class="line">ispå ç”¨çš„å­—èŠ‚å¤§å°ï¼šã€Œispç»“æ„å ç”¨ã€ <span class="number">24</span></span><br><span class="line">counterçš„åˆ‡ç‰‡å ç”¨çš„å­—èŠ‚å¤§å°ï¼š <span class="number">1600000000</span></span><br><span class="line"><span class="keyword">for</span> all slice ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7651851800</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218954240</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199851600</span></span><br><span class="line">è€—æ—¶ï¼š  <span class="number">168</span>  S</span><br><span class="line"><span class="keyword">for</span> all end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7664827928</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218962432</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199852696</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218962432</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199853016</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218962432</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199853040</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218962432</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199853048</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218962432</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199853048</span></span><br><span class="line">gc before <span class="built_in">new</span> start <span class="number">4</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1600421888</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1600134128</span></span><br><span class="line">slice <span class="number">0</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1600430080</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1600134560</span></span><br><span class="line">slice <span class="number">1000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1656332288</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1655853536</span></span><br><span class="line">slice <span class="number">2000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1712513024</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1711853840</span></span><br><span class="line">slice <span class="number">3000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1768710144</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1767854128</span></span><br><span class="line">slice <span class="number">4000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1824890880</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1823854192</span></span><br><span class="line">slice <span class="number">5000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1881079808</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1879854256</span></span><br><span class="line">slice <span class="number">6000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1937276928</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1935854336</span></span><br><span class="line">slice <span class="number">7000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">1993457664</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">1991854400</span></span><br><span class="line">slice <span class="number">8000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2049662976</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2047854704</span></span><br><span class="line">slice <span class="number">9000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2105835520</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2103854992</span></span><br><span class="line">slice <span class="number">10000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2162024448</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2159855056</span></span><br><span class="line">slice <span class="number">11000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2218205184</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2215855120</span></span><br><span class="line">slice <span class="number">12000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2274410496</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2271855200</span></span><br><span class="line">slice <span class="number">13000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2330591232</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2327855264</span></span><br><span class="line">slice <span class="number">14000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2386771968</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2383855328</span></span><br><span class="line">slice <span class="number">15000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2442969088</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2439855392</span></span><br><span class="line">slice <span class="number">16000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2499149824</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2495855456</span></span><br><span class="line">slice <span class="number">17000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2555346944</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2551855520</span></span><br><span class="line">slice <span class="number">18000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2611544064</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2607855824</span></span><br><span class="line">slice <span class="number">19000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2667716608</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2663856112</span></span><br><span class="line">slice <span class="number">20000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2723921920</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2719856192</span></span><br><span class="line">slice <span class="number">21000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2780102656</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2775856256</span></span><br><span class="line">slice <span class="number">22000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2836283392</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2831856320</span></span><br><span class="line">slice <span class="number">23000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7665745432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2892472320</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2887856384</span></span><br><span class="line">slice <span class="number">24000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7666073112</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">2948661248</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2943856448</span></span><br><span class="line">slice <span class="number">25000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7666466328</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3004841984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">2999856512</span></span><br><span class="line">slice <span class="number">26000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7666859544</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3061039104</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3055856576</span></span><br><span class="line">slice <span class="number">27000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667252760</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3117228032</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3111856640</span></span><br><span class="line">slice <span class="number">28000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3173433344</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3167859936</span></span><br><span class="line">slice <span class="number">29000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3229614080</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3223857088</span></span><br><span class="line">slice <span class="number">30000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3285794816</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3279857376</span></span><br><span class="line">slice <span class="number">31000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3341983744</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3335857440</span></span><br><span class="line">slice <span class="number">32000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3398172672</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3391857504</span></span><br><span class="line">slice <span class="number">33000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3454361600</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3447857568</span></span><br><span class="line">slice <span class="number">34000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3510550528</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3503857632</span></span><br><span class="line">slice <span class="number">35000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3566739456</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3559857696</span></span><br><span class="line">slice <span class="number">36000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3622936576</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3615858000</span></span><br><span class="line">slice <span class="number">37000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3679117312</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3671858288</span></span><br><span class="line">slice <span class="number">38000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3735306240</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3727858352</span></span><br><span class="line">slice <span class="number">39000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3791495168</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3783858656</span></span><br><span class="line">slice <span class="number">40000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3847684096</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3839858960</span></span><br><span class="line">slice <span class="number">41000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3903864832</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3895859024</span></span><br><span class="line">slice <span class="number">42000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">3960061952</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">3951859328</span></span><br><span class="line">slice <span class="number">43000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4016250880</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4007859616</span></span><br><span class="line">slice <span class="number">44000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4072431616</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4063859680</span></span><br><span class="line">slice <span class="number">45000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4128620544</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4119859744</span></span><br><span class="line">slice <span class="number">46000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4184809472</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4175859808</span></span><br><span class="line">slice <span class="number">47000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4240998400</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4231859872</span></span><br><span class="line">slice <span class="number">48000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4297179136</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4287859936</span></span><br><span class="line">slice <span class="number">49000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4353376256</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4343860000</span></span><br><span class="line">slice <span class="number">50000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4409565184</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4399860064</span></span><br><span class="line">slice <span class="number">51000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4465770496</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4455860368</span></span><br><span class="line">slice <span class="number">52000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4521943040</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4511860656</span></span><br><span class="line">slice <span class="number">53000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4578140160</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4567860720</span></span><br><span class="line">slice <span class="number">54000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4634320896</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4623860784</span></span><br><span class="line">slice <span class="number">55000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4690509824</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4679860848</span></span><br><span class="line">slice <span class="number">56000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4746690560</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4735860912</span></span><br><span class="line">slice <span class="number">57000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4802887680</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4791860976</span></span><br><span class="line">slice <span class="number">58000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4859068416</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4847861040</span></span><br><span class="line">slice <span class="number">59000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4915257344</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4903861104</span></span><br><span class="line">slice <span class="number">60000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">4971446272</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">4959861168</span></span><br><span class="line">slice <span class="number">61000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5027635200</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5015861232</span></span><br><span class="line">slice <span class="number">62000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667318296</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5083815936</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5071861296</span></span><br><span class="line">slice <span class="number">63000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667449368</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5140013056</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5127861360</span></span><br><span class="line">slice <span class="number">64000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7667842584</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5196201984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5183861424</span></span><br><span class="line">slice <span class="number">65000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7668235800</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5252382720</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5239861488</span></span><br><span class="line">slice <span class="number">66000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7668629016</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5308579840</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5295861552</span></span><br><span class="line">slice <span class="number">67000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7669087768</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5364760576</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5351861616</span></span><br><span class="line">slice <span class="number">68000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7669480984</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5420957696</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5407861680</span></span><br><span class="line">slice <span class="number">69000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7669874200</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5477138432</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5463861744</span></span><br><span class="line">slice <span class="number">70000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7670267416</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5533327360</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5519861808</span></span><br><span class="line">slice <span class="number">71000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7670660632</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5589516288</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5575861872</span></span><br><span class="line">slice <span class="number">72000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7671119384</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5645705216</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5631861936</span></span><br><span class="line">slice <span class="number">73000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7671512600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5701894144</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5687862000</span></span><br><span class="line">slice <span class="number">74000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7671905816</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5758083072</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5743862064</span></span><br><span class="line">slice <span class="number">75000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7672299032</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5814280192</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5799862144</span></span><br><span class="line">slice <span class="number">76000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7672692248</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5870460928</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5855862224</span></span><br><span class="line">slice <span class="number">77000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7673151000</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5926649856</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5911862288</span></span><br><span class="line">slice <span class="number">78000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7673544216</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">5982846976</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">5967862352</span></span><br><span class="line">slice <span class="number">79000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7673937432</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6039019520</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6023862416</span></span><br><span class="line">slice <span class="number">80000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7674330648</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6095216640</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6079862480</span></span><br><span class="line">slice <span class="number">81000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7674789400</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6151397376</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6135862544</span></span><br><span class="line">slice <span class="number">82000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675182616</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6207594496</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6191862624</span></span><br><span class="line">slice <span class="number">83000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675379224</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6263808000</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6247863760</span></span><br><span class="line">slice <span class="number">84000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675379224</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6319964160</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6303863824</span></span><br><span class="line">slice <span class="number">85000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675379224</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6376177664</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6359864144</span></span><br><span class="line">slice <span class="number">86000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675379224</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6432358400</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6415864432</span></span><br><span class="line">slice <span class="number">87000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675379224</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6488530944</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6471858816</span></span><br><span class="line">slice <span class="number">88000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675379224</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6544711680</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6527859104</span></span><br><span class="line">slice <span class="number">89000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675379224</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6600892416</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6583859168</span></span><br><span class="line">slice <span class="number">90000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7675575832</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6657081344</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6639859232</span></span><br><span class="line">slice <span class="number">91000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7676034584</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6713278464</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6695859296</span></span><br><span class="line">slice <span class="number">92000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7676427800</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6769459200</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6751859360</span></span><br><span class="line">slice <span class="number">93000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7676821016</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6825648128</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6807859424</span></span><br><span class="line">slice <span class="number">94000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7677214232</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6881837056</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6863859488</span></span><br><span class="line">slice <span class="number">95000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7677672984</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6938025984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6919859552</span></span><br><span class="line">slice <span class="number">96000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7678066200</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">6994206720</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">6975859616</span></span><br><span class="line">slice <span class="number">97000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7678459416</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7050403840</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7031859680</span></span><br><span class="line">slice <span class="number">98000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7678852632</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7106592768</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7087859744</span></span><br><span class="line">slice <span class="number">99000000</span> ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679245848</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7162773504</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7143859808</span></span><br><span class="line">ispå ç”¨çš„å­—èŠ‚å¤§å°ï¼šã€Œispç»“æ„å ç”¨ã€ <span class="number">24</span></span><br><span class="line"><span class="keyword">for</span> all slice ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218970624</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199859808</span></span><br><span class="line">è€—æ—¶ï¼š  <span class="number">187</span>  S</span><br><span class="line"><span class="keyword">for</span> all end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">7218970624</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">7199857304</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">434176</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131752</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131752</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131984</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131992</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131768</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131992</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131992</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131768</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131992</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131992</span></span><br><span class="line"><span class="keyword">for</span> gc end ç³»ç»Ÿå†…å­˜ï¼š <span class="number">7679704600</span>    å¸¸é©»å†…å­˜ï¼š <span class="number">425984</span>     å †ä¸Šåˆ†é…çš„ï¼Œgcåä¼šå½’è¿˜ï¼š  <span class="number">131992</span></span><br></pre></td></tr></table></figure>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Sort</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ36ã€defer panicæºç åˆ†æ</title>
    <url>/archives/b630d910.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p><a href="https://blog.imrcrab.com/archives/d586b949.html#more">ã€Œ35ã€runtime:recover not correctly recover from panic</a>è¯´åˆ°äº†v1.16ä¿®å¤çš„ä¸€ä¸ªpanicé—®é¢˜,è¿™æ¬¡é¡ºå¸¦çœ‹çœ‹åº•å±‚å…³äºdeferçš„å¤„ç†.</p>
<span id="more"></span>
<h3 id="version"><a class="header-anchor" href="#version">Â¶</a>version</h3>
<blockquote>
<p>go version go1.14.14 darwin/amd64</p>
</blockquote>
<h3 id="deferå¤„ç†"><a class="header-anchor" href="#deferå¤„ç†">Â¶</a>deferå¤„ç†</h3>
<h4 id="ç¨‹åº"><a class="header-anchor" href="#ç¨‹åº">Â¶</a>ç¨‹åº</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	f()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> sum(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="æ±‡ç¼–è¡¨ç¤º-ã€Œå…³äºæ±‡ç¼–çš„å‚è€ƒPlan-9æ±‡ç¼–ç›¸å…³ã€"><a class="header-anchor" href="#æ±‡ç¼–è¡¨ç¤º-ã€Œå…³äºæ±‡ç¼–çš„å‚è€ƒPlan-9æ±‡ç¼–ç›¸å…³ã€">Â¶</a>æ±‡ç¼–è¡¨ç¤º:ã€Œå…³äºæ±‡ç¼–çš„å‚è€ƒ<a href="https://blog.imrcrab.com/archives/2ce846ed.html">Plan 9æ±‡ç¼–ç›¸å…³</a>ã€</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0000</span> <span class="number">00000</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        TEXT    <span class="string">&quot;&quot;</span>.f(SB), ABIInternal, $<span class="number">128</span><span class="number">-0</span></span><br><span class="line"><span class="number">0x0000</span> <span class="number">00000</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        MOVQ    (TLS), CX</span><br><span class="line"><span class="number">0x0009</span> <span class="number">00009</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        CMPQ    SP, <span class="number">16</span>(CX)</span><br><span class="line"><span class="number">0x000d</span> <span class="number">00013</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        PCDATA  $<span class="number">0</span>, $<span class="number">-2</span></span><br><span class="line"><span class="number">0x000d</span> <span class="number">00013</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        JLS     <span class="number">119</span></span><br><span class="line"><span class="number">0x000f</span> <span class="number">00015</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        PCDATA  $<span class="number">0</span>, $<span class="number">-1</span></span><br><span class="line"><span class="number">0x000f</span> <span class="number">00015</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        ADDQ    $<span class="number">-128</span>, SP</span><br><span class="line"><span class="number">0x0013</span> <span class="number">00019</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        MOVQ    BP, <span class="number">120</span>(SP)</span><br><span class="line"><span class="number">0x0018</span> <span class="number">00024</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        LEAQ    <span class="number">120</span>(SP), BP</span><br><span class="line"><span class="number">0x001d</span> <span class="number">00029</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        FUNCDATA        $<span class="number">0</span>, gclocalsÂ·<span class="number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)</span><br><span class="line"><span class="number">0x001d</span> <span class="number">00029</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        FUNCDATA        $<span class="number">1</span>, gclocalsÂ·<span class="number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)</span><br><span class="line"><span class="number">0x001d</span> <span class="number">00029</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        MOVL    $<span class="number">24</span>, <span class="string">&quot;&quot;</span>..autotmp_0+<span class="number">24</span>(SP)</span><br><span class="line"><span class="number">0x0025</span> <span class="number">00037</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        LEAQ    <span class="string">&quot;&quot;</span>.sumÂ·f(SB), AX</span><br><span class="line"><span class="number">0x002c</span> <span class="number">00044</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        MOVQ    AX, <span class="string">&quot;&quot;</span>..autotmp_0+<span class="number">48</span>(SP)</span><br><span class="line"><span class="number">0x0031</span> <span class="number">00049</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        MOVQ    $<span class="number">1</span>, <span class="string">&quot;&quot;</span>..autotmp_0+<span class="number">96</span>(SP)</span><br><span class="line"><span class="number">0x003a</span> <span class="number">00058</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        MOVQ    $<span class="number">2</span>, <span class="string">&quot;&quot;</span>..autotmp_0+<span class="number">104</span>(SP)</span><br><span class="line"><span class="number">0x0043</span> <span class="number">00067</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        LEAQ    <span class="string">&quot;&quot;</span>..autotmp_0+<span class="number">24</span>(SP), AX</span><br><span class="line"><span class="number">0x0048</span> <span class="number">00072</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        MOVQ    AX, (SP)</span><br><span class="line"><span class="number">0x004c</span> <span class="number">00076</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        PCDATA  $<span class="number">1</span>, $<span class="number">0</span></span><br><span class="line"><span class="number">0x004c</span> <span class="number">00076</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        CALL    runtime.deferprocStack(SB) <span class="comment">// åˆ’é‡ç‚¹,å‡½æ•°è°ƒç”¨éƒ¨åˆ†</span></span><br><span class="line"><span class="number">0x0051</span> <span class="number">00081</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        TESTL   AX, AX</span><br><span class="line"><span class="number">0x0053</span> <span class="number">00083</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        JNE     <span class="number">103</span></span><br><span class="line"><span class="number">0x0055</span> <span class="number">00085</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        JMP     <span class="number">87</span></span><br><span class="line"><span class="number">0x0057</span> <span class="number">00087</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">9</span>)        XCHGL   AX, AX</span><br><span class="line"><span class="number">0x0058</span> <span class="number">00088</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">9</span>)        CALL    runtime.deferreturn(SB)  <span class="comment">// åˆ’é‡ç‚¹,å‡½æ•°è°ƒç”¨éƒ¨åˆ†</span></span><br><span class="line"><span class="number">0x005d</span> <span class="number">00093</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">9</span>)        MOVQ    <span class="number">120</span>(SP), BP</span><br><span class="line"><span class="number">0x0062</span> <span class="number">00098</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">9</span>)        SUBQ    $<span class="number">-128</span>, SP</span><br><span class="line"><span class="number">0x0066</span> <span class="number">00102</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">9</span>)        RET</span><br><span class="line"><span class="number">0x0067</span> <span class="number">00103</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        XCHGL   AX, AX</span><br><span class="line"><span class="number">0x0068</span> <span class="number">00104</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        CALL    runtime.deferreturn(SB)  <span class="comment">// åˆ’é‡ç‚¹,å‡½æ•°è°ƒç”¨éƒ¨åˆ†</span></span><br><span class="line"><span class="number">0x006d</span> <span class="number">00109</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        MOVQ    <span class="number">120</span>(SP), BP</span><br><span class="line"><span class="number">0x0072</span> <span class="number">00114</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        SUBQ    $<span class="number">-128</span>, SP</span><br><span class="line"><span class="number">0x0076</span> <span class="number">00118</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        RET</span><br><span class="line"><span class="number">0x0077</span> <span class="number">00119</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">8</span>)        NOP</span><br><span class="line"><span class="number">0x0077</span> <span class="number">00119</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        PCDATA  $<span class="number">1</span>, $<span class="number">-1</span></span><br><span class="line"><span class="number">0x0077</span> <span class="number">00119</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        PCDATA  $<span class="number">0</span>, $<span class="number">-2</span></span><br><span class="line"><span class="number">0x0077</span> <span class="number">00119</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        CALL    runtime.morestack_noctxt(SB)</span><br><span class="line"><span class="number">0x007c</span> <span class="number">00124</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        PCDATA  $<span class="number">0</span>, $<span class="number">-1</span></span><br><span class="line"><span class="number">0x007c</span> <span class="number">00124</span> (src/main/ssp.<span class="keyword">go</span>:<span class="number">7</span>)        JMP     <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="deferå®˜æ–¹å®šä¹‰"><a class="header-anchor" href="#deferå®˜æ–¹å®šä¹‰">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L865">deferå®˜æ–¹å®šä¹‰</a>:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A _defer holds an entry on the list of deferred calls.</span></span><br><span class="line"><span class="comment">// If you add a field here, add code to clear it in freedefer and deferProcStack</span></span><br><span class="line"><span class="comment">// This struct must match the code in cmd/compile/internal/gc/reflect.go:deferstruct</span></span><br><span class="line"><span class="comment">// and cmd/compile/internal/gc/ssa.go:(*state).call.</span></span><br><span class="line"><span class="comment">// Some defers will be allocated on the stack and some on the heap. // å †æ ˆçš„ä¸ç¡®å®šæ€§</span></span><br><span class="line"><span class="comment">// All defers are logically part of the stack, so write barriers to</span></span><br><span class="line"><span class="comment">// initialize them are not required. All defers must be manually scanned,</span></span><br><span class="line"><span class="comment">// and for heap defers, marked.</span></span><br><span class="line"><span class="keyword">type</span> _defer <span class="keyword">struct</span> &#123;</span><br><span class="line">	siz     <span class="type">int32</span> <span class="comment">// includes both arguments and results</span></span><br><span class="line">	started <span class="type">bool</span></span><br><span class="line">	heap    <span class="type">bool</span></span><br><span class="line">	<span class="comment">// openDefer indicates that this _defer is for a frame with open-coded</span></span><br><span class="line">	<span class="comment">// defers. We have only one defer record for the entire frame (which may</span></span><br><span class="line">	<span class="comment">// currently have 0, 1, or more defers active).</span></span><br><span class="line">	openDefer <span class="type">bool</span></span><br><span class="line">	sp        <span class="type">uintptr</span>  <span class="comment">// sp at time of defer</span></span><br><span class="line">	pc        <span class="type">uintptr</span>  <span class="comment">// pc at time of defer</span></span><br><span class="line">	fn        *funcval <span class="comment">// can be nil for open-coded defers æŒ‡å‘å‡½æ•°</span></span><br><span class="line">	_panic    *_panic  <span class="comment">// panic that is running defer</span></span><br><span class="line">	link      *_defer  <span class="comment">// åŒä¸€ä¸ªgoroutineæ‰€æœ‰çš„deferè¿åŸçš„é“¾è¡¨</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// If openDefer is true, the fields below record values about the stack</span></span><br><span class="line">	<span class="comment">// frame and associated function that has the open-coded defer(s). sp</span></span><br><span class="line">	<span class="comment">// above will be the sp for the frame, and pc will be address of the</span></span><br><span class="line">	<span class="comment">// deferreturn call in the function.</span></span><br><span class="line">	fd   unsafe.Pointer <span class="comment">// funcdata for the function associated with the frame</span></span><br><span class="line">	varp <span class="type">uintptr</span>        <span class="comment">// value of varp for the stack frame</span></span><br><span class="line">	<span class="comment">// framepc is the current pc associated with the stack frame. Together,</span></span><br><span class="line">	<span class="comment">// with sp above (which is the sp associated with the stack frame),</span></span><br><span class="line">	<span class="comment">// framepc/sp can be used as pc/sp pair to continue a stack trace via</span></span><br><span class="line">	<span class="comment">// gentraceback().</span></span><br><span class="line">	framepc <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="deferproc"><a class="header-anchor" href="#deferproc">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/panic.go#L218">deferproc</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create a new deferred function fn with siz bytes of arguments.</span></span><br><span class="line"><span class="comment">// The compiler turns a defer statement into a call to this.</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferproc</span><span class="params">(siz <span class="type">int32</span>, fn *funcval)</span></span> &#123; <span class="comment">// arguments of fn follow fn</span></span><br><span class="line">	gp := getg()</span><br><span class="line">	<span class="keyword">if</span> gp.m.curg != gp &#123;</span><br><span class="line">		<span class="comment">// go code on the system stack can&#x27;t defer</span></span><br><span class="line">		throw(<span class="string">&quot;defer on system stack&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// the arguments of fn are in a perilous state. The stack map</span></span><br><span class="line">	<span class="comment">// for deferproc does not describe them. So we can&#x27;t let garbage</span></span><br><span class="line">	<span class="comment">// collection or stack copying trigger until we&#x27;ve copied them out</span></span><br><span class="line">	<span class="comment">// to somewhere safe. The memmove below does that.</span></span><br><span class="line">	<span class="comment">// Until the copy completes, we can only call nosplit routines.</span></span><br><span class="line">    <span class="comment">// è·å–è°ƒç”¨è€…çš„spã€Œæ ˆé¡¶ã€</span></span><br><span class="line">	sp := getcallersp()</span><br><span class="line">	argp := <span class="type">uintptr</span>(unsafe.Pointer(&amp;fn)) + unsafe.Sizeof(fn)</span><br><span class="line">	callerpc := getcallerpc() <span class="comment">// è·å–callerçš„pc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»pollä¸­è·å–æˆ–allocateä¸€ä¸ª</span></span><br><span class="line">	d := newdefer(siz)</span><br><span class="line">	<span class="keyword">if</span> d._panic != <span class="literal">nil</span> &#123;</span><br><span class="line">		throw(<span class="string">&quot;deferproc: d.panic != nil after newdefer&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// å˜é‡çš„åˆå§‹åŒ–ä¿¡æ¯</span></span><br><span class="line">	d.link = gp._defer</span><br><span class="line">	gp._defer = d</span><br><span class="line">	d.fn = fn</span><br><span class="line">	d.pc = callerpc</span><br><span class="line">	d.sp = sp</span><br><span class="line">	<span class="keyword">switch</span> siz &#123; <span class="comment">// å…³äºsizçš„å€¼çš„å¤„ç†</span></span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		<span class="comment">// Do nothing.</span></span><br><span class="line">	<span class="keyword">case</span> sys.PtrSize:</span><br><span class="line">		*(*<span class="type">uintptr</span>)(deferArgs(d)) = *(*<span class="type">uintptr</span>)(unsafe.Pointer(argp))</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		memmove(deferArgs(d), unsafe.Pointer(argp), <span class="type">uintptr</span>(siz))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// deferproc returns 0 normally.</span></span><br><span class="line">	<span class="comment">// a deferred func that stops a panic</span></span><br><span class="line">	<span class="comment">// makes the deferproc return 1.</span></span><br><span class="line">	<span class="comment">// the code the compiler generates always</span></span><br><span class="line">	<span class="comment">// checks the return value and jumps to the</span></span><br><span class="line">	<span class="comment">// end of the function if deferproc returns != 0.</span></span><br><span class="line">    <span class="comment">// æ­£å¸¸è¿”å›0,å¼‚å¸¸è¿”å›1</span></span><br><span class="line">	return0()</span><br><span class="line">	<span class="comment">// No code can go here - the C return register has</span></span><br><span class="line">	<span class="comment">// been set and must not be clobbered.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="newdefer"><a class="header-anchor" href="#newdefer">Â¶</a>newdefer</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Allocate a Defer, usually using per-P pool. // poolæ± å­</span></span><br><span class="line"><span class="comment">// Each defer must be released with freedefer.  The defer is not</span></span><br><span class="line"><span class="comment">// added to any defer chain yet.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This must not grow the stack because there may be a frame without</span></span><br><span class="line"><span class="comment">// stack map information when this is called.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newdefer</span><span class="params">(siz <span class="type">int32</span>)</span></span> *_defer &#123;</span><br><span class="line">	<span class="keyword">var</span> d *_defer</span><br><span class="line">	sc := deferclass(<span class="type">uintptr</span>(siz)) <span class="comment">// è®¡ç®—sc</span></span><br><span class="line">	gp := getg()</span><br><span class="line">	<span class="keyword">if</span> sc &lt; <span class="type">uintptr</span>(<span class="built_in">len</span>(p&#123;&#125;.deferpool)) &#123;</span><br><span class="line">		pp := gp.m.p.ptr()</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(pp.deferpool[sc]) == <span class="number">0</span> &amp;&amp; sched.deferpool[sc] != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// Take the slow path on the system stack so</span></span><br><span class="line">			<span class="comment">// we don&#x27;t grow newdefer&#x27;s stack.</span></span><br><span class="line">            <span class="comment">// å½“ç¼“å­˜æ²¡æœ‰å€¼äº†ï¼Œå°±ä»å…¨å±€poolä¸­æå‡ºæ¥ä¸€éƒ¨åˆ†</span></span><br><span class="line">			systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				lock(&amp;sched.deferlock)</span><br><span class="line">				<span class="keyword">for</span> <span class="built_in">len</span>(pp.deferpool[sc]) &lt; <span class="built_in">cap</span>(pp.deferpool[sc])/<span class="number">2</span> &amp;&amp; sched.deferpool[sc] != <span class="literal">nil</span> &#123;</span><br><span class="line">					d := sched.deferpool[sc]</span><br><span class="line">					sched.deferpool[sc] = d.link</span><br><span class="line">					d.link = <span class="literal">nil</span></span><br><span class="line">					pp.deferpool[sc] = <span class="built_in">append</span>(pp.deferpool[sc], d)</span><br><span class="line">				&#125;</span><br><span class="line">				unlock(&amp;sched.deferlock)</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> n := <span class="built_in">len</span>(pp.deferpool[sc]); n &gt; <span class="number">0</span> &#123;</span><br><span class="line">			d = pp.deferpool[sc][n<span class="number">-1</span>]</span><br><span class="line">			pp.deferpool[sc][n<span class="number">-1</span>] = <span class="literal">nil</span></span><br><span class="line">			pp.deferpool[sc] = pp.deferpool[sc][:n<span class="number">-1</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> d == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Allocate new defer+args.</span></span><br><span class="line">        <span class="comment">// å…¨å±€çš„poolä¸è¶³/argsè¿‡é•¿</span></span><br><span class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			total := roundupsize(totaldefersize(<span class="type">uintptr</span>(siz)))</span><br><span class="line">			d = (*_defer)(mallocgc(total, deferType, <span class="literal">true</span>))</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> debugCachedWork &#123;</span><br><span class="line">			<span class="comment">// Duplicate the tail below so if there&#x27;s a</span></span><br><span class="line">			<span class="comment">// crash in checkPut we can tell if d was just</span></span><br><span class="line">			<span class="comment">// allocated or came from the pool.</span></span><br><span class="line">			d.siz = siz</span><br><span class="line">			d.link = gp._defer <span class="comment">// ä¸ä¹‹å‰ç»‘å®šçš„gå½¢æˆé“¾è¡¨</span></span><br><span class="line">			gp._defer = d</span><br><span class="line">			<span class="keyword">return</span> d</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	d.siz = siz</span><br><span class="line">	d.heap = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">return</span> d</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="deferprocStack"><a class="header-anchor" href="#deferprocStack">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/panic.go#L271">deferprocStack</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// deferprocStack queues a new deferred function with a defer record on the stack.</span></span><br><span class="line"><span class="comment">// The defer record must have its siz and fn fields initialized. sizå’Œfnå¿…é¡»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// All other fields can contain junk.</span></span><br><span class="line"><span class="comment">// The defer record must be immediately followed in memory by</span></span><br><span class="line"><span class="comment">// the arguments of the defer.</span></span><br><span class="line"><span class="comment">// Nosplit because the arguments on the stack won&#x27;t be scanned</span></span><br><span class="line"><span class="comment">// until the defer record is spliced into the gp._defer list.</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferprocStack</span><span class="params">(d *_defer)</span></span> &#123;</span><br><span class="line">	gp := getg() <span class="comment">// è·å–å½“å‰çš„g,ä¹Ÿè¯´æ˜ä¸€ä»¶äº‹,è¿™ä¸ªdeferå’Œgæ˜¯ç›¸å…³è”çš„å“¦</span></span><br><span class="line">	<span class="keyword">if</span> gp.m.curg != gp &#123;</span><br><span class="line">		<span class="comment">// go code on the system stack can&#x27;t defer</span></span><br><span class="line">		throw(<span class="string">&quot;defer on system stack&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// siz and fn are already set.</span></span><br><span class="line">	<span class="comment">// The other fields are junk on entry to deferprocStack and</span></span><br><span class="line">	<span class="comment">// are initialized here. </span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå†™çš„å¾ˆæ¸…æ¥šäº†,sizå’Œfnå¿…é¡» æå‰åˆå§‹åŒ–,å…¶å®ƒçš„å˜é‡åœ¨è¿™åˆå§‹åŒ–.</span></span><br><span class="line">	d.started = <span class="literal">false</span></span><br><span class="line">	d.heap = <span class="literal">false</span></span><br><span class="line">	d.openDefer = <span class="literal">false</span></span><br><span class="line">	d.sp = getcallersp()</span><br><span class="line">	d.pc = getcallerpc()</span><br><span class="line">	d.framepc = <span class="number">0</span></span><br><span class="line">	d.varp = <span class="number">0</span></span><br><span class="line">	<span class="comment">// The lines below implement:</span></span><br><span class="line">	<span class="comment">//   d.panic = nil</span></span><br><span class="line">	<span class="comment">//   d.fd = nil</span></span><br><span class="line">	<span class="comment">//   d.link = gp._defer</span></span><br><span class="line">	<span class="comment">//   gp._defer = d</span></span><br><span class="line">	<span class="comment">// But without write barriers. The first three are writes to</span></span><br><span class="line">	<span class="comment">// the stack so they don&#x27;t need a write barrier, and furthermore</span></span><br><span class="line">	<span class="comment">// are to uninitialized memory, so they must not use a write barrier.</span></span><br><span class="line">	<span class="comment">// The fourth write does not require a write barrier because we</span></span><br><span class="line">	<span class="comment">// explicitly mark all the defer structures, so we don&#x27;t need to</span></span><br><span class="line">	<span class="comment">// keep track of pointers to them with a write barrier.</span></span><br><span class="line">	*(*<span class="type">uintptr</span>)(unsafe.Pointer(&amp;d._panic)) = <span class="number">0</span></span><br><span class="line">	*(*<span class="type">uintptr</span>)(unsafe.Pointer(&amp;d.fd)) = <span class="number">0</span></span><br><span class="line">	*(*<span class="type">uintptr</span>)(unsafe.Pointer(&amp;d.link)) = <span class="type">uintptr</span>(unsafe.Pointer(gp._defer))</span><br><span class="line">	*(*<span class="type">uintptr</span>)(unsafe.Pointer(&amp;gp._defer)) = <span class="type">uintptr</span>(unsafe.Pointer(d))</span><br><span class="line"></span><br><span class="line">	return0()</span><br><span class="line">	<span class="comment">// No code can go here - the C return register has</span></span><br><span class="line">	<span class="comment">// been set and must not be clobbered.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="deferreturn"><a class="header-anchor" href="#deferreturn">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/panic.go#L528">deferreturn</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Run a deferred function if there is one.</span></span><br><span class="line"><span class="comment">// The compiler inserts a call to this at the end of any</span></span><br><span class="line"><span class="comment">// function which calls defer.</span></span><br><span class="line"><span class="comment">// If there is a deferred function, this will call runtimeÂ·jmpdefer,</span></span><br><span class="line"><span class="comment">// which will jump to the deferred function such that it appears</span></span><br><span class="line"><span class="comment">// to have been called by the caller of deferreturn at the point</span></span><br><span class="line"><span class="comment">// just before deferreturn was called. The effect is that deferreturn</span></span><br><span class="line"><span class="comment">// is called again and again until there are no more deferred functions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Declared as nosplit, because the function should not be preempted once we start</span></span><br><span class="line"><span class="comment">// modifying the caller&#x27;s frame in order to reuse the frame to call the deferred</span></span><br><span class="line"><span class="comment">// function.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The single argument isn&#x27;t actually used - it just has its address</span></span><br><span class="line"><span class="comment">// taken so it can be matched against pending defers.</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferreturn</span><span class="params">(arg0 <span class="type">uintptr</span>)</span></span> &#123;</span><br><span class="line">	gp := getg()</span><br><span class="line">	d := gp._defer</span><br><span class="line">	<span class="keyword">if</span> d == <span class="literal">nil</span> &#123; <span class="comment">// é€’å½’è°ƒç”¨çš„ç»ˆæ­¢æ¡ä»¶</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	sp := getcallersp() </span><br><span class="line">	<span class="keyword">if</span> d.sp != sp &#123; <span class="comment">// å½“å‰çš„è°ƒç”¨æ ˆå’Œdeferä¸­æ˜¯å¦ç›¸åŒ</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> d.openDefer &#123;</span><br><span class="line">		done := runOpenDeferFrame(gp, d)</span><br><span class="line">		<span class="keyword">if</span> !done &#123;</span><br><span class="line">			throw(<span class="string">&quot;unfinished open-coded defers in deferreturn&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		gp._defer = d.link</span><br><span class="line">		freedefer(d)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Moving arguments around.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Everything called after this point must be recursively</span></span><br><span class="line">	<span class="comment">// nosplit because the garbage collector won&#x27;t know the form</span></span><br><span class="line">	<span class="comment">// of the arguments until the jmpdefer can flip the PC over to</span></span><br><span class="line">	<span class="comment">// fn.</span></span><br><span class="line">	<span class="keyword">switch</span> d.siz &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		<span class="comment">// Do nothing.</span></span><br><span class="line">	<span class="keyword">case</span> sys.PtrSize:</span><br><span class="line">		*(*<span class="type">uintptr</span>)(unsafe.Pointer(&amp;arg0)) = *(*<span class="type">uintptr</span>)(deferArgs(d))</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		memmove(unsafe.Pointer(&amp;arg0), deferArgs(d), <span class="type">uintptr</span>(d.siz))</span><br><span class="line">	&#125;</span><br><span class="line">	fn := d.fn</span><br><span class="line">	d.fn = <span class="literal">nil</span></span><br><span class="line">	gp._defer = d.link</span><br><span class="line">	freedefer(d) <span class="comment">// é‡Šæ”¾d,é‡æ–°æ”¾å›poolä¸­</span></span><br><span class="line">	<span class="comment">// If the defer function pointer is nil, force the seg fault to happen</span></span><br><span class="line">	<span class="comment">// here rather than in jmpdefer. gentraceback() throws an error if it is</span></span><br><span class="line">	<span class="comment">// called with a callback on an LR architecture and jmpdefer is on the</span></span><br><span class="line">	<span class="comment">// stack, because the stack trace can be incorrect in that case - see</span></span><br><span class="line">	<span class="comment">// issue #8153).</span></span><br><span class="line">	_ = fn.fn</span><br><span class="line">	jmpdefer(fn, <span class="type">uintptr</span>(unsafe.Pointer(&amp;arg0)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="panic"><a class="header-anchor" href="#panic">Â¶</a>panic</h3>
<h4 id="å®˜æ–¹å®šä¹‰â€“"><a class="header-anchor" href="#å®˜æ–¹å®šä¹‰â€“">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/runtime2.go#L903">å®˜æ–¹å®šä¹‰â€“&gt;</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A _panic holds information about an active panic.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This is marked go:notinheap because _panic values must only ever</span></span><br><span class="line"><span class="comment">// live on the stack.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The argp and link fields are stack pointers, but don&#x27;t need special</span></span><br><span class="line"><span class="comment">// handling during stack growth: because they are pointer-typed and</span></span><br><span class="line"><span class="comment">// _panic values only live on the stack, regular stack pointer</span></span><br><span class="line"><span class="comment">// adjustment takes care of them.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:notinheap</span></span><br><span class="line"><span class="keyword">type</span> _panic <span class="keyword">struct</span> &#123;</span><br><span class="line">	argp      unsafe.Pointer <span class="comment">// pointer to arguments of deferred call run during panic; cannot move - known to liblink</span></span><br><span class="line">	arg       <span class="keyword">interface</span>&#123;&#125;    <span class="comment">// argument to panic</span></span><br><span class="line">	link      *_panic        <span class="comment">// link to earlier panic</span></span><br><span class="line">	pc        <span class="type">uintptr</span>        <span class="comment">// where to return to in runtime if this panic is bypassed</span></span><br><span class="line">	sp        unsafe.Pointer <span class="comment">// where to return to in runtime if this panic is bypassed</span></span><br><span class="line">	recovered <span class="type">bool</span>           <span class="comment">// whether this panic is over // recoveræ ‡è¯†</span></span><br><span class="line">	aborted   <span class="type">bool</span>           <span class="comment">// the panic was aborted // ç»ˆæ­¢æ ‡è®°</span></span><br><span class="line">	goexit    <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="gopanic"><a class="header-anchor" href="#gopanic">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/panic.go#L889">gopanic</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// reflectcallSave calls reflectcall after saving the caller&#x27;s pc and sp in the</span></span><br><span class="line"><span class="comment">// panic record. This allows the runtime to return to the Goexit defer processing</span></span><br><span class="line"><span class="comment">// loop, in the unusual case where the Goexit may be bypassed by a successful</span></span><br><span class="line"><span class="comment">// recover.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflectcallSave</span><span class="params">(p *_panic, fn, arg unsafe.Pointer, argsize <span class="type">uint32</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">		p.argp = unsafe.Pointer(getargp(<span class="number">0</span>))</span><br><span class="line">		p.pc = getcallerpc()</span><br><span class="line">		p.sp = unsafe.Pointer(getcallersp())</span><br><span class="line">	&#125;</span><br><span class="line">	reflectcall(<span class="literal">nil</span>, fn, arg, argsize, argsize)</span><br><span class="line">	<span class="keyword">if</span> p != <span class="literal">nil</span> &#123;</span><br><span class="line">		p.pc = <span class="number">0</span></span><br><span class="line">		p.sp = unsafe.Pointer(<span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The implementation of the predeclared function panic.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gopanic</span><span class="params">(e <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	gp := getg()</span><br><span class="line">	<span class="keyword">if</span> gp.m.curg != gp &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;panic: &quot;</span>)</span><br><span class="line">		printany(e)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		throw(<span class="string">&quot;panic on system stack&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> gp.m.mallocing != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;panic: &quot;</span>)</span><br><span class="line">		printany(e)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		throw(<span class="string">&quot;panic during malloc&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> gp.m.preemptoff != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;panic: &quot;</span>)</span><br><span class="line">		printany(e)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;preempt off reason: &quot;</span>)</span><br><span class="line">		<span class="built_in">print</span>(gp.m.preemptoff)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		throw(<span class="string">&quot;panic during preemptoff&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> gp.m.locks != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;panic: &quot;</span>)</span><br><span class="line">		printany(e)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">		throw(<span class="string">&quot;panic holding locks&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> p _panic</span><br><span class="line">	p.arg = e</span><br><span class="line">	p.link = gp._panic</span><br><span class="line">	gp._panic = (*_panic)(noescape(unsafe.Pointer(&amp;p)))</span><br><span class="line"></span><br><span class="line">	atomic.Xadd(&amp;runningPanicDefers, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// By calculating getcallerpc/getcallersp here, we avoid scanning the</span></span><br><span class="line">	<span class="comment">// gopanic frame (stack scanning is slow...)</span></span><br><span class="line">	addOneOpenDeferFrame(gp, getcallerpc(), unsafe.Pointer(getcallersp()))</span><br><span class="line">	<span class="comment">//	éå†é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		d := gp._defer</span><br><span class="line">		<span class="keyword">if</span> d == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If defer was started by earlier panic or Goexit (and, since we&#x27;re back here, that triggered a new panic),</span></span><br><span class="line">		<span class="comment">// take defer off list. An earlier panic will not continue running, but we will make sure below that an</span></span><br><span class="line">		<span class="comment">// earlier Goexit does continue running.</span></span><br><span class="line">		<span class="keyword">if</span> d.started &#123; <span class="comment">// å·²ç»å¯åŠ¨</span></span><br><span class="line">			<span class="keyword">if</span> d._panic != <span class="literal">nil</span> &#123;</span><br><span class="line">				d._panic.aborted = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			d._panic = <span class="literal">nil</span></span><br><span class="line">			<span class="keyword">if</span> !d.openDefer &#123; <span class="comment">// æ²¡æœ‰æ‰“å¼€åˆ™è·³è¿‡</span></span><br><span class="line">				<span class="comment">// For open-coded defers, we need to process the</span></span><br><span class="line">				<span class="comment">// defer again, in case there are any other defers</span></span><br><span class="line">				<span class="comment">// to call in the frame (not including the defer</span></span><br><span class="line">				<span class="comment">// call that caused the panic).</span></span><br><span class="line">				d.fn = <span class="literal">nil</span></span><br><span class="line">				gp._defer = d.link</span><br><span class="line">				freedefer(d)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Mark defer as started, but keep on list, so that traceback</span></span><br><span class="line">		<span class="comment">// can find and update the defer&#x27;s argument frame if stack growth</span></span><br><span class="line">		<span class="comment">// or a garbage collection happens before reflectcall starts executing d.fn.</span></span><br><span class="line">		d.started = <span class="literal">true</span> <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Record the panic that is running the defer.</span></span><br><span class="line">		<span class="comment">// If there is a new panic during the deferred call, that panic</span></span><br><span class="line">		<span class="comment">// will find d in the list and will mark d._panic (this panic) aborted.</span></span><br><span class="line">		<span class="comment">// è®°å½•è¿™ä¸ªpanicï¼Œå¦‚æœåœ¨è¿è¡ŒæœŸé—´æœ‰äº†æ–°çš„panicï¼Œæ ‡è®°è¿™ä¸ªPanic abort=true(å¼ºåˆ¶ç»ˆæ­¢)</span></span><br><span class="line">		d._panic = (*_panic)(noescape(unsafe.Pointer(&amp;p)))</span><br><span class="line"></span><br><span class="line">		done := <span class="literal">true</span></span><br><span class="line">		<span class="keyword">if</span> d.openDefer &#123;</span><br><span class="line">			done = runOpenDeferFrame(gp, d)</span><br><span class="line">			<span class="keyword">if</span> done &amp;&amp; !d._panic.recovered &#123;</span><br><span class="line">				addOneOpenDeferFrame(gp, <span class="number">0</span>, <span class="literal">nil</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			p.argp = unsafe.Pointer(getargp(<span class="number">0</span>))</span><br><span class="line">			<span class="comment">// è°ƒç”¨defer</span></span><br><span class="line">			reflectcall(<span class="literal">nil</span>, unsafe.Pointer(d.fn), deferArgs(d), <span class="type">uint32</span>(d.siz), <span class="type">uint32</span>(d.siz))</span><br><span class="line">		&#125;</span><br><span class="line">		p.argp = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// reflectcall did not panic. Remove d.</span></span><br><span class="line">		<span class="keyword">if</span> gp._defer != d &#123;</span><br><span class="line">			throw(<span class="string">&quot;bad defer entry in panic&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		d._panic = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// trigger shrinkage to test stack copy. See stack_test.go:TestStackPanic</span></span><br><span class="line">		<span class="comment">//GC()</span></span><br><span class="line"></span><br><span class="line">		pc := d.pc</span><br><span class="line">		sp := unsafe.Pointer(d.sp) <span class="comment">// must be pointer so it gets adjusted during stack copy</span></span><br><span class="line">		<span class="keyword">if</span> done &#123;</span><br><span class="line">			d.fn = <span class="literal">nil</span></span><br><span class="line">			gp._defer = d.link <span class="comment">// éå†ä¸‹ä¸€ä¸ª</span></span><br><span class="line">			freedefer(d)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> p.recovered &#123; <span class="comment">// å·²ç»æœ‰recoverè¢«è°ƒç”¨</span></span><br><span class="line">			gp._panic = p.link</span><br><span class="line">			<span class="keyword">if</span> gp._panic != <span class="literal">nil</span> &amp;&amp; gp._panic.goexit &amp;&amp; gp._panic.aborted &#123;</span><br><span class="line">				<span class="comment">// A normal recover would bypass/abort the Goexit.  Instead,</span></span><br><span class="line">				<span class="comment">// we return to the processing loop of the Goexit.</span></span><br><span class="line">				gp.sigcode0 = <span class="type">uintptr</span>(gp._panic.sp)</span><br><span class="line">				gp.sigcode1 = <span class="type">uintptr</span>(gp._panic.pc)</span><br><span class="line">				mcall(recovery)</span><br><span class="line">				throw(<span class="string">&quot;bypassed recovery failed&quot;</span>) <span class="comment">// mcall should not return</span></span><br><span class="line">			&#125;</span><br><span class="line">			atomic.Xadd(&amp;runningPanicDefers, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> done &#123;</span><br><span class="line">				<span class="comment">// Remove any remaining non-started, open-coded</span></span><br><span class="line">				<span class="comment">// defer entries after a recover, since the</span></span><br><span class="line">				<span class="comment">// corresponding defers will be executed normally</span></span><br><span class="line">				<span class="comment">// (inline). Any such entry will become stale once</span></span><br><span class="line">				<span class="comment">// we run the corresponding defers inline and exit</span></span><br><span class="line">				<span class="comment">// the associated stack frame.</span></span><br><span class="line">				d := gp._defer</span><br><span class="line">				<span class="keyword">var</span> prev *_defer</span><br><span class="line">				<span class="keyword">for</span> d != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> d.openDefer &#123;</span><br><span class="line">						<span class="keyword">if</span> d.started &#123;</span><br><span class="line">							<span class="comment">// This defer is started but we</span></span><br><span class="line">							<span class="comment">// are in the middle of a</span></span><br><span class="line">							<span class="comment">// defer-panic-recover inside of</span></span><br><span class="line">							<span class="comment">// it, so don&#x27;t remove it or any</span></span><br><span class="line">							<span class="comment">// further defer entries</span></span><br><span class="line">							<span class="keyword">break</span></span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> prev == <span class="literal">nil</span> &#123;</span><br><span class="line">							gp._defer = d.link</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">							prev.link = d.link</span><br><span class="line">						&#125;</span><br><span class="line">						newd := d.link</span><br><span class="line">						freedefer(d)</span><br><span class="line">						d = newd</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						prev = d</span><br><span class="line">						d = d.link</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			gp._panic = p.link</span><br><span class="line">			<span class="comment">// Aborted panics are marked but remain on the g.panic list.</span></span><br><span class="line">			<span class="comment">// Remove them from the list.</span></span><br><span class="line">			<span class="keyword">for</span> gp._panic != <span class="literal">nil</span> &amp;&amp; gp._panic.aborted &#123;</span><br><span class="line">				gp._panic = gp._panic.link</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> gp._panic == <span class="literal">nil</span> &#123; <span class="comment">// must be done with signal</span></span><br><span class="line">				gp.sig = <span class="number">0</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Pass information about recovering frame to recovery.</span></span><br><span class="line">			gp.sigcode0 = <span class="type">uintptr</span>(sp)</span><br><span class="line">			gp.sigcode1 = pc</span><br><span class="line">			mcall(recovery)</span><br><span class="line">			throw(<span class="string">&quot;recovery failed&quot;</span>) <span class="comment">// mcall should not return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ran out of deferred calls - old-school panic now</span></span><br><span class="line">	<span class="comment">// Because it is unsafe to call arbitrary user code after freezing</span></span><br><span class="line">	<span class="comment">// the world, we call preprintpanics to invoke all necessary Error</span></span><br><span class="line">	<span class="comment">// and String methods to prepare the panic strings before startpanic.</span></span><br><span class="line">	preprintpanics(gp._panic)</span><br><span class="line"></span><br><span class="line">	fatalpanic(gp._panic) <span class="comment">// should not return</span></span><br><span class="line">	*(*<span class="type">int</span>)(<span class="literal">nil</span>) = <span class="number">0</span>      <span class="comment">// not reached</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="recover"><a class="header-anchor" href="#recover">Â¶</a>recover</h3>
<h4 id="å®˜æ–¹å®šä¹‰"><a class="header-anchor" href="#å®˜æ–¹å®šä¹‰">Â¶</a>å®˜æ–¹å®šä¹‰</h4>
<blockquote>
<p>panicä¸­çš„ä¸€ä¸ªboolå‹<br>
recovered bool           // whether this panic is over // recoveræ ‡è¯†</p>
</blockquote>
<h4 id="å®ç°"><a class="header-anchor" href="#å®ç°">Â¶</a>å®ç°</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The implementation of the predeclared function recover.</span></span><br><span class="line"><span class="comment">// Cannot split the stack because it needs to reliably</span></span><br><span class="line"><span class="comment">// find the stack segment of its caller.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// TODO(rsc): Once we commit to CopyStackAlways,</span></span><br><span class="line"><span class="comment">// this doesn&#x27;t need to be nosplit.</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gorecover</span><span class="params">(argp <span class="type">uintptr</span>)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">	<span class="comment">// Must be in a function running as part of a deferred call during the panic.</span></span><br><span class="line">	<span class="comment">// Must be called from the topmost function of the call</span></span><br><span class="line">	<span class="comment">// (the function used in the defer statement).</span></span><br><span class="line">	<span class="comment">// p.argp is the argument pointer of that topmost deferred function call.</span></span><br><span class="line">	<span class="comment">// Compare against argp reported by caller.</span></span><br><span class="line">	<span class="comment">// If they match, the caller is the one who can recover.</span></span><br><span class="line">	gp := getg()</span><br><span class="line">	p := gp._panic</span><br><span class="line">	<span class="keyword">if</span> p != <span class="literal">nil</span> &amp;&amp; !p.goexit &amp;&amp; !p.recovered &amp;&amp; argp == <span class="type">uintptr</span>(p.argp) &#123;</span><br><span class="line">		p.recovered = <span class="literal">true</span> <span class="comment">// revoveræ ‡è¯†ä¸ºtrue</span></span><br><span class="line">		<span class="keyword">return</span> p.arg</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="æ‹“å±•-ã€Œä¸‹é¢ç¨‹åºä¼šè¾“å‡ºä»€ä¹ˆå€¼ã€"><a class="header-anchor" href="#æ‹“å±•-ã€Œä¸‹é¢ç¨‹åºä¼šè¾“å‡ºä»€ä¹ˆå€¼ã€">Â¶</a>æ‹“å±•:ã€Œä¸‹é¢ç¨‹åºä¼šè¾“å‡ºä»€ä¹ˆå€¼ã€</h3>
<h4 id="eg-1"><a class="header-anchor" href="#eg-1">Â¶</a>eg-1:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!= <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;===&gt;&quot;</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	f()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!= <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;===&quot;</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> sum(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">		<span class="built_in">panic</span>(<span class="number">1</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="output"><a class="header-anchor" href="#output">Â¶</a>output:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="built_in">panic</span>: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">goroutine <span class="number">18</span> [running]:</span><br><span class="line">main.f.func2()</span><br><span class="line">        /Users/k/learn/<span class="keyword">go</span>-memory/src/main/ssp.<span class="keyword">go</span>:<span class="number">26</span> +<span class="number">0x6d</span></span><br><span class="line">created by main.f</span><br><span class="line">        /Users/k/learn/<span class="keyword">go</span>-memory/src/main/ssp.<span class="keyword">go</span>:<span class="number">24</span> +<span class="number">0x57</span></span><br></pre></td></tr></table></figure>
<h4 id="eg-2"><a class="header-anchor" href="#eg-2">Â¶</a>eg-2:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!= <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;===&gt;&quot;</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	f()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> sum(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!= <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;===&quot;</span>,err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="built_in">panic</span>(<span class="number">1</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="output-v2"><a class="header-anchor" href="#output-v2">Â¶</a>output:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">=== <span class="number">1</span></span><br><span class="line">fatal <span class="type">error</span>: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [<span class="keyword">select</span> (no cases)]:</span><br><span class="line">main.main()</span><br><span class="line">        /Users/k/learn/<span class="keyword">go</span>-memory/src/main/ssp.<span class="keyword">go</span>:<span class="number">13</span> +<span class="number">0x4a</span></span><br></pre></td></tr></table></figure>
<h4 id="eg-3"><a class="header-anchor" href="#eg-3">Â¶</a>eg-3:</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!= <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;===&gt;&quot;</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	f()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!= <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;panic--f ===&quot;</span>,err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> sum(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!= <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;===&quot;</span>,err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="built_in">panic</span>(<span class="number">1</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="output-v3"><a class="header-anchor" href="#output-v3">Â¶</a>output:</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">=== <span class="number">1</span></span><br><span class="line">fatal <span class="type">error</span>: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [<span class="keyword">select</span> (no cases)]:</span><br><span class="line">main.main()</span><br><span class="line">        /Users/k/learn/<span class="keyword">go</span>-memory/src/main/ssp.<span class="keyword">go</span>:<span class="number">13</span> +<span class="number">0x4a</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>æºç </tag>
        <tag>Runtime</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ35ã€runtime:recover not correctly recover from panic</title>
    <url>/archives/d586b949.html</url>
    <content><![CDATA[<p>æ¥ç€ä¸Šé¢çš„ç»§ç»­çœ‹çœ‹v1.16æ›´æ–°,runtimeåŒ…æ”¹åŠ¨çš„:</p>
<p><a href="https://github.com/golang/go/issues/43921">runtime: recover does not correctly recover from panic</a></p>
<p>ç®€å•çš„è¯´åŸå› ,ä½ è®¤ä¸ºä¸‹é¢ç¨‹åºçš„è¾“å‡ºç»“æœä¸ºwhat?</p>
<span id="more"></span>
<h3 id="eg"><a class="header-anchor" href="#eg">Â¶</a>eg</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		expect(<span class="number">1</span>, <span class="built_in">recover</span>())</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				expect(<span class="number">4</span>, <span class="built_in">recover</span>())</span><br><span class="line">			&#125;()</span><br><span class="line">			<span class="built_in">panic</span>(<span class="number">4</span>)</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="built_in">panic</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Prevent open-coded defers; not executed.</span></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> <span class="built_in">panic</span>(<span class="number">-1</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">expect</span><span class="params">(n <span class="type">int</span>, err <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="built_in">println</span>(<span class="string">&quot;expect&quot;</span>, n)</span><br><span class="line">	<span class="keyword">if</span> n != err &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;have %v, want %v&quot;</span>, err, n)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç†æƒ³å‹"><a class="header-anchor" href="#ç†æƒ³å‹">Â¶</a>ç†æƒ³å‹:</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">expect 4</span><br><span class="line">expect 1</span><br></pre></td></tr></table></figure>
<h4 id="ç°å®-ã€Œbase-v1-14-15ã€"><a class="header-anchor" href="#ç°å®-ã€Œbase-v1-14-15ã€">Â¶</a>ç°å®:ã€Œbase v1.14.15ã€</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">./prog.<span class="keyword">go</span>:<span class="number">19</span>:<span class="number">3</span>: unreachable code</span><br><span class="line">Go vet exited.</span><br><span class="line"></span><br><span class="line">expect <span class="number">4</span></span><br><span class="line"><span class="built_in">panic</span>: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [running]:</span><br><span class="line">main.main.func2()</span><br><span class="line">	/tmp/sandbox701237149/prog.<span class="keyword">go</span>:<span class="number">16</span> +<span class="number">0x65</span></span><br><span class="line">main.main()</span><br><span class="line">	/tmp/sandbox701237149/prog.<span class="keyword">go</span>:<span class="number">23</span> +<span class="number">0x45</span></span><br></pre></td></tr></table></figure>
<h3 id="why-å‘ç”Ÿäº†what"><a class="header-anchor" href="#why-å‘ç”Ÿäº†what">Â¶</a>why?å‘ç”Ÿäº†what?</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210217_110058.png" alt=""></p>
<blockquote>
<p>ä»ä¸Šé¢çš„ä¿®æ”¹å¯ä»¥çœ‹å‡º,æ˜¯æ²¡æœ‰éå†ç°æœ‰çš„æ•´ä¸ªdeferé“¾è¡¨ç»“æ„å¯¼è‡´çš„.</p>
</blockquote>
<h3 id="deferã€panicã€recoveræ˜¯å¦‚ä½•çš„ç»“æ„è¿æ¥åœ¨ä¸€èµ·çš„å‘¢"><a class="header-anchor" href="#deferã€panicã€recoveræ˜¯å¦‚ä½•çš„ç»“æ„è¿æ¥åœ¨ä¸€èµ·çš„å‘¢">Â¶</a>deferã€panicã€recoveræ˜¯å¦‚ä½•çš„ç»“æ„è¿æ¥åœ¨ä¸€èµ·çš„å‘¢?</h3>
<p><a href="https://blog.imrcrab.com/archives/b630d910.html#more">Nextâ€“&gt;</a></p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Runtime</tag>
        <tag>v1.14</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ34ã€Go memory leak about RSS</title>
    <url>/archives/c0e329b8.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº:</h3>
<p>ä»Šå¤©æ”¶åˆ°äº†å°é‚®ä»¶ Go 1.16 release:</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210217_094336.webp" alt=""></p>
<p>è¿›å»äº†çœ‹äº†çœ‹å…¨éƒ¨çš„ç‰¹æ€§,å‘ç°æœ‰ä¸ªå…³äºmemory  leakã€ŒRSSã€ç›¸å…³çš„issues,å»çœ‹çœ‹å…³äºGoçš„RSSåˆ°åº•æ˜¯æ€ä¹ˆè®¡ç®—çš„,<br>
é¡ºå¸¦ä¹Ÿçœ‹çœ‹è¿™ä¸ªè€å“¥ä¸ºä½•ä¼šé—®å†…å­˜æ³„éœ²çš„é—®é¢˜.</p>
<span id="more"></span>
<h3 id="é—®é¢˜"><a class="header-anchor" href="#é—®é¢˜">Â¶</a>é—®é¢˜:</h3>
<p><a href="https://github.com/golang/go/issues/40448">runtime: memory leaked observed in go program #40448</a></p>
<h4 id="ç®€è¿°èµ·å› "><a class="header-anchor" href="#ç®€è¿°èµ·å› ">Â¶</a>ç®€è¿°èµ·å› :</h4>
<blockquote>
<p>ä¸€ä¸ªtcpæ¥å—ç¨‹åºå¯¼è‡´RSSä¸æ–­ä¸Šå‡.<br>
è¿™ä¸ªèµ·äº†5ä¸ªgoroutineåç¨‹æ¥å¤„ç†è¯·æ±‚,ä½†æ˜¯è¯·æ±‚å¤„ç†ç»“æŸå,RAMå¹¶æ²¡æœ‰è¶‹äºç¨³å®šæˆ–è€…é™ä½.å¯¼è‡´äº†çœ‹ä¼¼çš„memory leak.</p>
</blockquote>
<ul>
<li>æè¿°:</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210217_095036.png" alt=""></p>
<h4 id="å…³äºRSSè§£é‡Š"><a class="header-anchor" href="#å…³äºRSSè§£é‡Š">Â¶</a><a href="https://github.com/golang/go/issues/40448#issuecomment-666350046">å…³äºRSSè§£é‡Š</a></h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">The current minimum heap size of a Go program is 4mb. In addition to this the operating system threads that back goroutines should be added to that as well as some non heap memory used by the runtime. In your case this may be somewhere between 7 and 9mb.</span><br><span class="line"></span><br><span class="line">// ä¸‹é¢çš„è§£é‡Šåˆ’é‡ç‚¹,ç®€å•çš„è¯´å°±æ˜¯RSSå—å¾ˆå¤šå€¼çš„å½±å“:swap,avaliability valuesç­‰</span><br><span class="line">Please remember that RSS is not how much memory is a program using, it is the resident segment size. Many things influence the value reported in RSS including the availability of swap and how much of the process may be swapped, if the system has reclaimed pages which we have madvise(DONTNEED) as part of the scavenger. A high RSS value does not necessarily mean that memory is not available for other processes, and so on.</span><br><span class="line"></span><br><span class="line">If memory consumption is your primary objective I would suggest investigating https://tinygo.org/ who may (I cannot confirm) have a different approach to memory allocation.</span><br><span class="line"></span><br><span class="line">I&#x27;ll defer to @randall77 and @mknyszek on the question of if the minimum heap size can be reduced.</span><br></pre></td></tr></table></figure>
<h3 id="è§£å†³åŠæ³•"><a class="header-anchor" href="#è§£å†³åŠæ³•">Â¶</a><a href="https://github.com/golang/go/issues/40448#issuecomment-667196117">è§£å†³åŠæ³•</a></h3>
<ul>
<li>runtime/debug.SetGCPercent (è®¾ç½®gcçš„ç™¾åˆ†æ¯”,-1ä¸ºä¸GC)</li>
<li>runtime.GC (è°ƒç”¨ç³»ç»ŸGC)</li>
<li>runtime/debug.FreeOSMemory (accelerate the pace of returning unused pages to the OS)</li>
</ul>
<h3 id="å…¶å®ƒæ–¹é¢çš„é—®é¢˜"><a class="header-anchor" href="#å…¶å®ƒæ–¹é¢çš„é—®é¢˜">Â¶</a>å…¶å®ƒæ–¹é¢çš„é—®é¢˜</h3>
<blockquote>
<p>ä»è¿™é‡Œçœ‹çš„è¯,å…¶å®è¿™ä¸ªå“¥ä»¬çš„é—®é¢˜å¹¶ä¸å±äºgoçš„bug,åªæ˜¯è¯´å¯¹äºå†…å­˜ä½¿ç”¨çš„ç†è§£æœ‰åå·®,<br>
è§‰å¾—goè¿è¡Œæ—¶ç¯å¢ƒå¾ˆåƒæ˜¯unixç³»ç»Ÿ,å†…å­˜æœ‰å¤šå°‘ç”¨å¤šå°‘,ä¸ä¼šæ˜¯ç”¨å®Œå°±é‡Šæ”¾ç»™ç³»ç»Ÿ.</p>
</blockquote>
<p>æ¯•ç«Ÿæœ‰å¥è¯: <em><strong>ç©ºé—´æ¢æ—¶é—´</strong></em></p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Runtime</tag>
        <tag>v1.16</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ33ã€Float IEEEæ ‡å‡†</title>
    <url>/archives/257c4ce2.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å‰å‡ å¤©è¸©å‘Floatç±»å‹çš„è®¡ç®—é—®é¢˜,ä»Šå¤©æ¥ç³»ç»Ÿçš„æ€»ç»“ä¸‹floatç›¸å…³çš„çŸ¥è¯†ç‚¹.</p>
<h3 id="æŒæ¡å…³é”®ç‚¹"><a class="header-anchor" href="#æŒæ¡å…³é”®ç‚¹">Â¶</a>æŒæ¡å…³é”®ç‚¹:</h3>
<ul>
<li>floatçš„æ ‡å‡†æ˜¯ä»€ä¹ˆ?</li>
<li>floatçš„ä½è®¡ç®—è§„åˆ™</li>
<li>floatåœºæ™¯</li>
<li>floatè®¡ç®—æ”¹è¿›</li>
</ul>
<span id="more"></span>
<h3 id="Floatçš„æ ‡å‡†"><a class="header-anchor" href="#Floatçš„æ ‡å‡†">Â¶</a>Floatçš„æ ‡å‡†?</h3>
<h4 id="å›½é™…ç»„ç»‡å®šä¹‰"><a class="header-anchor" href="#å›½é™…ç»„ç»‡å®šä¹‰">Â¶</a>å›½é™…ç»„ç»‡å®šä¹‰</h4>
<p><a href="https://zh.wikipedia.org/wiki/IEEE_754">wikiâ€“&gt;floatå®šä¹‰</a></p>
<h4 id="è¡¨ç¤ºæ–¹æ³•"><a class="header-anchor" href="#è¡¨ç¤ºæ–¹æ³•">Â¶</a>è¡¨ç¤ºæ–¹æ³•</h4>
<p style=""><img data-src="https://math.now.sh?from=value%20%3D%20%20sign%20*%20exponent%20*%20fraction%20%0A" /></p><ul>
<li>value: å®é™…å€¼</li>
<li>sign bit: ç¬¦å·ä½</li>
<li>exponent bit: æŒ‡æ•°ä¾¿å®œä½</li>
<li>fraction: åˆ†æ•°å€¼</li>
</ul>
<p>å…·ä½“è¡¨ç¤º:</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210206_104959.webp" alt=""></p>
<h4 id="å•ç²¾åº¦å’ŒåŒç²¾åº¦"><a class="header-anchor" href="#å•ç²¾åº¦å’ŒåŒç²¾åº¦">Â¶</a>å•ç²¾åº¦å’ŒåŒç²¾åº¦</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210206_110116.png" alt=""></p>
<h4 id="ç‰¹æ®Šå€¼"><a class="header-anchor" href="#ç‰¹æ®Šå€¼">Â¶</a>ç‰¹æ®Šå€¼:</h4>
<ul>
<li>æ— ç©·: Inf</li>
<li>éæ•°å€¼: NaN</li>
</ul>
<h3 id="Floatä½è®¡ç®—è§„åˆ™"><a class="header-anchor" href="#Floatä½è®¡ç®—è§„åˆ™">Â¶</a>Floatä½è®¡ç®—è§„åˆ™</h3>
<h4 id="åŸç "><a class="header-anchor" href="#åŸç ">Â¶</a>åŸç </h4>
<ul>
<li>é«˜ä½è¡¨ç¤ºç¬¦å·ä½,å…¶ä½™ä¸ºå€¼; âš ï¸:ä¸èƒ½ç›´æ¥å‚ä¸è®¡ç®—</li>
</ul>
<h4 id="åç "><a class="header-anchor" href="#åç ">Â¶</a>åç </h4>
<ul>
<li>æ­£æ•°åç ä¸ºæœ¬èº«</li>
<li>è´Ÿæ•°ä¿ç•™ç¬¦å·ä½,å…¶å®ƒä½æŒ‰ä½å–å.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¾‹å¦‚ :</span><br><span class="line">[+7]åŸ = 00000111 [+7]å = 00000111 </span><br><span class="line">[-7]åŸ = 10000111 [-7]å = 11111000</span><br></pre></td></tr></table></figure>
<h4 id="è¡¥ç "><a class="header-anchor" href="#è¡¥ç ">Â¶</a>è¡¥ç </h4>
<ul>
<li>æ­£æ•°çš„è¡¥ç ==åŸç ==è¡¥ç </li>
<li>è´Ÿæ•°è¡¥ç =åç +1</li>
</ul>
<h4 id="è®¡ç®—å½¢å¼"><a class="header-anchor" href="#è®¡ç®—å½¢å¼">Â¶</a>è®¡ç®—å½¢å¼:</h4>
<p style=""><img data-src="https://math.now.sh?from=v%20%3D%20%28-1%29%5Es%20*%20M%20*%202%5EE%20%0A" /></p><h5 id="è¯´æ˜"><a class="header-anchor" href="#è¯´æ˜">Â¶</a>è¯´æ˜:</h5>
<ul>
<li><img data-src="https://math.now.sh?inline=%28-1%29%5Es" style="display:inline-block;margin: 0;"/>è¡¨ç¤ºç¬¦å·ä½</li>
<li>Mè¡¨ç¤ºæœ‰æ•ˆæ•°å­—</li>
<li><img data-src="https://math.now.sh?inline=2%5EE" style="display:inline-block;margin: 0;"/>è¡¨ç¤ºæŒ‡æ•°ä½</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">eg:</span><br><span class="line"><span class="number">-0.5</span> =&gt; <span class="number">-0.1</span>[äºŒè¿›åˆ¶]</span><br><span class="line">=&gt; <span class="number">-1.0</span> * <span class="number">2</span>^<span class="number">-1</span></span><br><span class="line">=&gt; (<span class="number">-1</span>)^<span class="number">1</span> * <span class="number">1.0</span> * <span class="number">2</span>^<span class="number">-1</span></span><br><span class="line">=&gt; s=<span class="number">1</span>ï¼ŒM=<span class="number">1.0</span>ï¼ŒE=<span class="number">-1</span></span><br></pre></td></tr></table></figure>
<h4 id="floatç±»å‹çš„åŠ æ³•"><a class="header-anchor" href="#floatç±»å‹çš„åŠ æ³•">Â¶</a>floatç±»å‹çš„åŠ æ³•:</h4>
<ul>
<li>å¯¹é˜¶</li>
<li>å°¾æ•°</li>
<li>è§„æ ¼åŒ–</li>
<li>èˆå…¥å¤„ç†</li>
<li>æº¢å‡ºåˆ¤æ–­</li>
</ul>
<h4 id="0-3-1-6"><a class="header-anchor" href="#0-3-1-6">Â¶</a><img data-src="https://math.now.sh?inline=0.3%2B1.6%3D%3F" style="display:inline-block;margin: 0;"/></h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a=(0.3)10=(0011 1110 1001 1001 1001 1001 1001 1010)2    Sa=0    Ea=011 1110 1    Ma=1.001 1001 1001 1001 1001 1010</span><br><span class="line"></span><br><span class="line">b=(1.6)10=(0011 1111 1100 1100 1100 1100 1100 1101)2      Sb=0    Eb=011 1111 1     Mb=1.100 1100 1100 1100 1100 1101</span><br></pre></td></tr></table></figure>
<h5 id="å¯¹é˜¶"><a class="header-anchor" href="#å¯¹é˜¶">Â¶</a>å¯¹é˜¶</h5>
<blockquote>
<p>ç®€å•çš„è¯´å°±æ˜¯éœ€è¦é˜¶ç å¯¹é½,ä½¿å…¶å°¾æ•°å¯ä»¥è¿›è¡ŒåŠ å‡è¿ç®—,å³:</p>
</blockquote>
<p>$ âŠ¿E = E_b -E_a $</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">Ea&lt;Eb   Eb-Ea=<span class="number">2</span></span><br><span class="line"></span><br><span class="line">Maè¦è°ƒæ•´ä¸º <span class="number">0.0</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">1001</span> <span class="number">10</span>       <span class="number">10</span></span><br><span class="line"></span><br><span class="line">E=<span class="number">011</span> <span class="number">1111</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h5 id="å°¾æ•°"><a class="header-anchor" href="#å°¾æ•°">Â¶</a>å°¾æ•°</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="number">0.01001100110011001100110</span></span><br><span class="line">+ <span class="number">1.10011001100110011001101</span></span><br><span class="line">----------------------------</span><br><span class="line">  <span class="number">1.11100110011001100110011</span></span><br></pre></td></tr></table></figure>
<h5 id="è§„æ ¼åŒ–"><a class="header-anchor" href="#è§„æ ¼åŒ–">Â¶</a>è§„æ ¼åŒ–</h5>
<p>å°¾æ•°çš„æ ¼å¼ $ 1.M $,å°¾æ•°å¯èƒ½æ˜¯éè§„æ ¼åŒ–çš„,æ‰€ä»¥éœ€è¦å·¦è§„å’Œå³è§„æ“ä½œ:</p>
<ul>
<li>å·¦è§„æ“ä½œ: å°¾æ•°å·¦ç§»,é˜¶ç å‡å€¼</li>
<li>å³è§„æ“ä½œ: å°¾æ•°å³ç§»,é˜¶ç +å€¼</li>
</ul>
<p>$ ç›®çš„: 1 \leq M &lt; 2 $</p>
<ul>
<li><input type="checkbox" id="checkbox0" checked="true"><label for="checkbox0">1.11100110011001100110011â€¬</label></li>
</ul>
<h5 id="èˆå…¥å¤„ç†"><a class="header-anchor" href="#èˆå…¥å¤„ç†">Â¶</a>èˆå…¥å¤„ç†</h5>
<blockquote>
<p>å››ç§èˆå…¥æ–¹å¼:</p>
</blockquote>
<ul>
<li>å°±è¿‘èˆå…¥: å››èˆäº”å…¥</li>
<li>æœ+âˆèˆå…¥</li>
<li>æœ-âˆèˆå…¥</li>
<li>æœ0èˆå…¥</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">åœ¨å¯¹é˜¶æ—¶ï¼ŒMaæœ‰å³ç§»ï¼Œä¸”ç¬¬ä¸€æ¬¡æœ€é«˜ä¸º<span class="number">1</span>ï¼Œç¬¬äºŒæ¬¡ä¸º<span class="number">0</span>ï¼Œ</span><br><span class="line">æ‰€ä»¥æŒ‰<span class="string">&quot;0èˆ1å…¥&quot;</span>ï¼Œ ==&gt; ç²¾åº¦ä¸¢å¤±çš„å…³é”®, </span><br><span class="line">å°¾æ•°è¿ç®—ç»“æœè°ƒæ•´ä¸º <span class="number">1.11100110011001100110100</span></span><br></pre></td></tr></table></figure>
<h5 id="æº¢å‡ºåˆ¤æ–­"><a class="header-anchor" href="#æº¢å‡ºåˆ¤æ–­">Â¶</a>æº¢å‡ºåˆ¤æ–­</h5>
<blockquote>
<p>åˆ¤æ–­ç»“æœæ ‡å‡†: è¿ç®—ç»“æœçš„é˜¶ç </p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">a+b=(<span class="number">0</span>  <span class="number">01111111</span>  <span class="number">11100110011001100110100</span>)<span class="number">2</span></span><br><span class="line">=(<span class="number">0011</span> <span class="number">1111</span> <span class="number">1111</span> <span class="number">0011</span> <span class="number">0011</span> <span class="number">0011</span> <span class="number">0011</span> <span class="number">0100</span>)<span class="number">2</span>=(<span class="number">3</span>FF33334)<span class="number">16</span></span><br><span class="line"></span><br><span class="line">è½¬ä¸º<span class="number">10</span>è¿›åˆ¶</span><br><span class="line"></span><br><span class="line">a+b=<span class="number">1.90000010</span></span><br></pre></td></tr></table></figure>
<h3 id="floatè®¡ç®—æ”¹è¿›"><a class="header-anchor" href="#floatè®¡ç®—æ”¹è¿›">Â¶</a>floatè®¡ç®—æ”¹è¿›</h3>
<h4 id="å°½é‡é¿å…ä½¿ç”¨é«˜ç²¾åº¦ä¸”é‡è¦çš„æ•°æ®è®¡ç®—-å¦‚-Â¥"><a class="header-anchor" href="#å°½é‡é¿å…ä½¿ç”¨é«˜ç²¾åº¦ä¸”é‡è¦çš„æ•°æ®è®¡ç®—-å¦‚-Â¥">Â¶</a>å°½é‡é¿å…ä½¿ç”¨é«˜ç²¾åº¦ä¸”é‡è¦çš„æ•°æ®è®¡ç®—: å¦‚: Â¥</h4>
<h4 id="ç»Ÿä¸€å–èˆä½æ•°"><a class="header-anchor" href="#ç»Ÿä¸€å–èˆä½æ•°">Â¶</a>ç»Ÿä¸€å–èˆä½æ•°</h4>
<ul>
<li>ç»Ÿä¸€ä¿ç•™</li>
<li>ç»Ÿä¸€å–èˆç®—æ³•</li>
</ul>
<h4 id="å»ºè®®ç”¨int-stringç±»å‹"><a class="header-anchor" href="#å»ºè®®ç”¨int-stringç±»å‹">Â¶</a>å»ºè®®ç”¨int/stringç±»å‹</h4>
<ul>
<li>ç¼ºç‚¹:
<ul>
<li>ç‰ºç‰²æ€§èƒ½</li>
<li>è½¬æ¢å¤æ‚</li>
</ul>
</li>
<li>ä¼˜ç‚¹:
<ul>
<li>æé«˜å‡†ç¡®åº¦</li>
<li>å¤„ç†å¯å¤šå…ƒåŒ–</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Float</tag>
        <tag>IEEE</tag>
        <tag>ä½è¿ç®—</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ32ã€Go  Ticker å†…å­˜æ³„éœ²</title>
    <url>/archives/53e1932f.html</url>
    <content><![CDATA[<h3 id="å‰åºï¼š"><a class="header-anchor" href="#å‰åºï¼š">Â¶</a>å‰åºï¼š</h3>
<p>ä¸çŸ¥é“ä½ ä»¬æœ‰æ²¡æœ‰ç»å†è¿‡è¿™ç§æƒ…å†µï¼š</p>
<blockquote>
<p>æµ‹è¯•ç¤ºä¾‹å›¾ç‰‡ï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210204_051425.webp" alt=""></p>
<span id="more"></span>
<blockquote>
<p>è¯´çš„ç®€å•ç‚¹ï¼šå†…å­˜ç‚¸äº†å‘—â€¦OOM</p>
</blockquote>
<h3 id="å¼•è¨€"><a class="header-anchor" href="#å¼•è¨€">Â¶</a>å¼•è¨€</h3>
<blockquote>
<p>go version go1.14.14 darwin/amd64</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">æœ€è¿‘çš„å‘æ˜¯çœŸçš„å¤šï¼Œå½“ç„¶è¿™ç§å‘åœ¨å¤§é¡¹ç›®ä¸­ï¼Œä¸€ä¸å°å¿ƒå°±å†™å‡ºæ¥äº†,</span><br><span class="line"></span><br><span class="line">äººå¤šï¼Œé¡¹ç›®å¤§ï¼Œå„ç§å„æ ·çš„èŠ±å¼æ“ä½œéƒ½å‡ºæ¥äº†,åœ¨æ‰€éš¾å…ï¼Œ</span><br><span class="line">èƒ½åšçš„å°±æ˜¯åˆ†æé—®é¢˜ï¼Œæ€»ç»“ï¼Œè®°å½•ï¼Œé˜²æ­¢ä¸‹æ¬¡è‡ªå·±çŠ¯é”™ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åŠ æ·±ç†è§£ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="èµ·å› ï¼š"><a class="header-anchor" href="#èµ·å› ï¼š">Â¶</a>èµ·å› ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">XXX</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡ä»£ç  å‡ åè¡Œ...</span></span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">100000</span>;i++&#123;</span><br><span class="line">	    ticker := time.NewTicker(<span class="number">10</span> * time.Second)</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">//æ¨¡æ‹Ÿä¸šåŠ¡ä»£ç </span></span><br><span class="line">			fmt.Println(<span class="string">&quot;defer close&quot;</span>)</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span> &#123;</span><br><span class="line">                <span class="keyword">select</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">                <span class="comment">// ä¸šåŠ¡ä»£ç .....</span></span><br><span class="line">                    fmt.Println(<span class="string">&quot;time 5&quot;</span>)</span><br><span class="line">                <span class="keyword">case</span> &lt;-doneChan:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡ä»£ç  å‡ åè¡Œ...</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ">Â¶</a>å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h4>
<blockquote>
<p>ä¸Šé¢çš„ä»£ç ï¼Œä¸æ™“å¾—çœ‹å‡ºæ¥ä»€ä¹ˆé—®é¢˜äº†ä¹ˆâ€¦</p>
</blockquote>
<h3 id="å…³é”®ç‚¹ï¼š"><a class="header-anchor" href="#å…³é”®ç‚¹ï¼š">Â¶</a>å…³é”®ç‚¹ï¼š</h3>
<p>tickeræ²¡æœ‰stop</p>
<p><a href="https://github.com/golang/go/blob/master/src/time/tick.go#L62">å®˜æ–¹è§£é‡Š</a></p>
<h4 id="Tickerä¸èƒ½è¢«å›æ”¶å¯¼è‡´"><a class="header-anchor" href="#Tickerä¸èƒ½è¢«å›æ”¶å¯¼è‡´">Â¶</a>Tickerä¸èƒ½è¢«å›æ”¶å¯¼è‡´</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210204_053201.webp" alt=""></p>
<h4 id="ä¸ºä½•ä¸èƒ½è¢«å›æ”¶ï¼Ÿ"><a class="header-anchor" href="#ä¸ºä½•ä¸èƒ½è¢«å›æ”¶ï¼Ÿ">Â¶</a>ä¸ºä½•ä¸èƒ½è¢«å›æ”¶ï¼Ÿ</h4>
<h5 id="NewTickerå®ç°ï¼š"><a class="header-anchor" href="#NewTickerå®ç°ï¼š">Â¶</a>NewTickerå®ç°ï¼š</h5>
<p><a href="https://github.com/golang/go/blob/master/src/time/tick.go#L39">NewTickerå®˜æ–¹å®ç°</a></p>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203">startTimeråº•å±‚å®ç°</a></p>
<h6 id="addtimer"><a class="header-anchor" href="#addtimer">Â¶</a>addtimer</h6>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// addtimer adds a timer to the current P.</span></span><br><span class="line"><span class="comment">// This should only be called with a newly created timer.</span></span><br><span class="line"><span class="comment">// That avoids the risk of changing the when field of a timer in some P&#x27;s heap,</span></span><br><span class="line"><span class="comment">// which could cause the heap to become unsorted.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addtimer</span><span class="params">(t *timer)</span></span> &#123;</span><br><span class="line">	<span class="comment">// when must never be negative; otherwise runtimer will overflow</span></span><br><span class="line">	<span class="comment">// during its delta calculation and never expire other runtime timers.</span></span><br><span class="line">	<span class="keyword">if</span> t.when &lt; <span class="number">0</span> &#123;</span><br><span class="line">		t.when = maxWhen</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> t.status != timerNoStatus &#123;</span><br><span class="line">		throw(<span class="string">&quot;addtimer called with initialized timer&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.status = timerWaiting</span><br><span class="line"></span><br><span class="line">	when := t.when</span><br><span class="line"></span><br><span class="line">	pp := getg().m.p.ptr() <span class="comment">// è·å–å½“å‰çš„P</span></span><br><span class="line">	lock(&amp;pp.timersLock) <span class="comment">// åŠ é”</span></span><br><span class="line">	cleantimers(pp) <span class="comment">// è°ƒæ•´p.timersæ ˆé¡¶å…ƒç´ </span></span><br><span class="line">	doaddtimer(pp, t) <span class="comment">// tç»‘å®šä¸‹p</span></span><br><span class="line">	unlock(&amp;pp.timersLock) </span><br><span class="line"></span><br><span class="line">	wakeNetPoller(when)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="doaddtimer"><a class="header-anchor" href="#doaddtimer">Â¶</a>doaddtimer</h6>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// doaddtimer adds t to the current P&#x27;s heap.</span></span><br><span class="line"><span class="comment">// The caller must have locked the timers for pp.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doaddtimer</span><span class="params">(pp *p, t *timer)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Timers rely on the network poller, so make sure the poller</span></span><br><span class="line">	<span class="comment">// has started.</span></span><br><span class="line">	<span class="keyword">if</span> netpollInited == <span class="number">0</span> &#123;</span><br><span class="line">		netpollGenericInit()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> t.pp != <span class="number">0</span> &#123;</span><br><span class="line">		throw(<span class="string">&quot;doaddtimer: P already set in timer&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.pp.set(pp)</span><br><span class="line">	i := <span class="built_in">len</span>(pp.timers)</span><br><span class="line">	pp.timers = <span class="built_in">append</span>(pp.timers, t) <span class="comment">// pä¸Šæ·»åŠ ä¸€ä¸ªtimer</span></span><br><span class="line">	siftupTimer(pp.timers, i) <span class="comment">// å †è°ƒæ•´ç®—æ³•</span></span><br><span class="line">	<span class="keyword">if</span> t == pp.timers[<span class="number">0</span>] &#123;</span><br><span class="line">		atomic.Store64(&amp;pp.timer0When, <span class="type">uint64</span>(t.when))</span><br><span class="line">	&#125;</span><br><span class="line">	atomic.Xadd(&amp;pp.numTimers, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‹“å±•ï¼š"><a class="header-anchor" href="#æ‹“å±•ï¼š">Â¶</a>æ‹“å±•ï¼š</h3>
<h4 id="cleantimersè¿‡ç¨‹ï¼š"><a class="header-anchor" href="#cleantimersè¿‡ç¨‹ï¼š">Â¶</a>cleantimersè¿‡ç¨‹ï¼š</h4>
<ul>
<li>åˆ¤æ–­é•¿åº¦</li>
<li>åˆ¤æ–­ä¸Šä¸€ä¸ªtimerçŠ¶æ€</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// cleantimers cleans up the head of the timer queue. This speeds up</span></span><br><span class="line"><span class="comment">// programs that create and delete timers; leaving them in the heap</span></span><br><span class="line"><span class="comment">// slows down addtimer. Reports whether no timer problems were found.</span></span><br><span class="line"><span class="comment">// The caller must have locked the timers for pp.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cleantimers</span><span class="params">(pp *p)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(pp.timers) == <span class="number">0</span> &#123; <span class="comment">// åˆ¤æ–­é•¿åº¦</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		t := pp.timers[<span class="number">0</span>] <span class="comment">//å–ç¬¬ä¸€ä¸ª</span></span><br><span class="line">		<span class="keyword">if</span> t.pp.ptr() != pp &#123;</span><br><span class="line">			throw(<span class="string">&quot;cleantimers: bad p&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> s := atomic.Load(&amp;t.status); s &#123; <span class="comment">//éœ€è¦åˆ¤æ–­çŠ¶æ€</span></span><br><span class="line">		<span class="keyword">case</span> timerDeleted:</span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, s, timerRemoving) &#123; <span class="comment">//éåˆ é™¤ä¸­</span></span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			dodeltimer0(pp) <span class="comment">//ç§»é™¤timer0</span></span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, timerRemoving, timerRemoved) &#123;</span><br><span class="line">				badTimer()</span><br><span class="line">			&#125;</span><br><span class="line">			atomic.Xadd(&amp;pp.deletedTimers, <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">case</span> timerModifiedEarlier, timerModifiedLater: <span class="comment">// ä¿®æ”¹å‰æˆ–è€…ä¿®æ”¹åçš„çŠ¶æ€</span></span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, s, timerMoving) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Now we can change the when field.</span></span><br><span class="line">			t.when = t.nextwhen <span class="comment">// æŒ‡é’ˆåç§»</span></span><br><span class="line">			<span class="comment">// Move t to the right position.</span></span><br><span class="line">			dodeltimer0(pp) <span class="comment">// åˆ é™¤æœ€åº•ä¸‹çš„å…ƒç´ </span></span><br><span class="line">			doaddtimer(pp, t) <span class="comment">// é‡æ–°ç»‘å®šPå’Œtçš„å…³ç³»</span></span><br><span class="line">			<span class="keyword">if</span> s == timerModifiedEarlier &#123;</span><br><span class="line">				atomic.Xadd(&amp;pp.adjustTimers, <span class="number">-1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> !atomic.Cas(&amp;t.status, timerMoving, timerWaiting) &#123;</span><br><span class="line">				badTimer()</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">// Head of timers does not need adjustment.</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="dodeltimer0"><a class="header-anchor" href="#dodeltimer0">Â¶</a>dodeltimer0</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dodeltimer0 removes timer 0 from the current P&#x27;s heap.</span></span><br><span class="line"><span class="comment">// We are locked on the P when this is called.</span></span><br><span class="line"><span class="comment">// It reports whether it saw no problems due to races.</span></span><br><span class="line"><span class="comment">// The caller must have locked the timers for pp.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dodeltimer0</span><span class="params">(pp *p)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> t := pp.timers[<span class="number">0</span>]; t.pp.ptr() != pp &#123;</span><br><span class="line">		throw(<span class="string">&quot;dodeltimer0: wrong P&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		t.pp = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">	last := <span class="built_in">len</span>(pp.timers) - <span class="number">1</span> <span class="comment">// è·å–ç¬¬ä¸€ä¸ªtimers</span></span><br><span class="line">	<span class="keyword">if</span> last &gt; <span class="number">0</span> &#123;</span><br><span class="line">		pp.timers[<span class="number">0</span>] = pp.timers[last] <span class="comment">// æ ˆåº•---&gt;æ ˆé¡¶</span></span><br><span class="line">	&#125;</span><br><span class="line">	pp.timers[last] = <span class="literal">nil</span> <span class="comment">// ç½®ç©º</span></span><br><span class="line">	pp.timers = pp.timers[:last] <span class="comment">//é‡æ–°èµ‹å€¼</span></span><br><span class="line">	<span class="keyword">if</span> last &gt; <span class="number">0</span> &#123;</span><br><span class="line">		siftdownTimer(pp.timers, <span class="number">0</span>)  <span class="comment">// é‡æ–°æ’åº</span></span><br><span class="line">	&#125;</span><br><span class="line">	updateTimer0When(pp) <span class="comment">// æ›´æ–°Pä¸­çš„when</span></span><br><span class="line">	atomic.Xadd(&amp;pp.numTimers, <span class="number">-1</span>) <span class="comment">// æ›´æ–°æ•°é‡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a class="header-anchor" href="#å‚è€ƒ">Â¶</a>å‚è€ƒ</h3>
<ul>
<li>
<p><a href="https://github.com/golang/go/blob/master/src/time/tick.go#L39">NewTickerå®˜æ–¹å®ç°</a></p>
</li>
<li>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203">StartTimeråº•å±‚å®ç°</a></p>
</li>
<li>
<p>atomic</p>
<ul>
<li>atomic.Store64</li>
<li>atomic.Xadd</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>ticker</tag>
        <tag>defer</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ31ã€Floatç±»å‹æ˜“è¸©çš„å‘</title>
    <url>/archives/cb90ed2a.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>æœ€è¿‘å¿«è¿‡å¹´äº†å§ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šéœ€æ±‚è¦æï¼Œï¼Œï¼Œï¼Œ</p>
<p>çªç„¶æ¥äº†ä¸ªé”…ï¼Œè¢«äººæŠ•è¯‰è¯´æ•°æ®ç»Ÿè®¡çš„æœ‰é—®é¢˜ï¼Œæ‰“å¼€ç”µè„‘ä¸€çœ‹ï¼Œfloatç±»å‹çš„ç»Ÿè®¡ï¼Œã€Œæˆ‘æ…Œäº†ï¼Œfloatåœ¨ç»Ÿè®¡ä¸­ä¸€ç›´éƒ½å¾ˆå¤´ç–¼ã€‚ã€</p>
<h3 id="è§¦å‘ç‚¹"><a class="header-anchor" href="#è§¦å‘ç‚¹">Â¶</a>è§¦å‘ç‚¹</h3>
<h4 id="å…ˆæ¥çœ‹é—®é¢˜å§ã€Œå†™äº†ä¸ªä¾‹å­ã€ï¼š"><a class="header-anchor" href="#å…ˆæ¥çœ‹é—®é¢˜å§ã€Œå†™äº†ä¸ªä¾‹å­ã€ï¼š">Â¶</a>å…ˆæ¥çœ‹é—®é¢˜å§ã€Œå†™äº†ä¸ªä¾‹å­ã€ï¼š</h4>
<blockquote>
<p>ä¸‹é¢çš„ç»“æœï¼Œaåº”è¯¥æ˜¯ä»€ä¹ˆå€¼ï¼Ÿwhyï¼Ÿ</p>
</blockquote>
<span id="more"></span>
<blockquote>
<p>go version go1.14.14 darwin/amd64</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> floatNumber <span class="type">float64</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	a := floatNumber / <span class="number">0</span></span><br><span class="line">	fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºç»“æœï¼š"><a class="header-anchor" href="#è¾“å‡ºç»“æœï¼š">Â¶</a>è¾“å‡ºç»“æœï¼š</h5>
<p>NAN</p>
<h5 id="why-ã€Œç©¶å…¶æ ¹æºã€"><a class="header-anchor" href="#why-ã€Œç©¶å…¶æ ¹æºã€">Â¶</a>why?ã€Œç©¶å…¶æ ¹æºã€</h5>
<p><a href="https://golang.google.cn/ref/spec#Representability">å®˜æ–¹è§£é‡Š</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210204_030335.png" alt=""></p>
<blockquote>
<p>ç®€å•çš„è¯´å°±æ˜¯ 0/0 ä¸ºè´Ÿæ— ç©·å¤§ï¼Œæ‰€ä»¥ä¸º NAN.</p>
</blockquote>
<h3 id="å¦‚ä½•è§„é¿ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•è§„é¿ï¼Ÿ">Â¶</a>å¦‚ä½•è§„é¿ï¼Ÿ</h3>
<ul>
<li>æå‰åˆ¤æ–­åˆ†æ¯ï¼Œä¸º0ï¼Œä¸è®¡ç®—ã€Œæ ¹æºè§£å†³ã€</li>
<li>åˆ©ç”¨math.IsNaN(xxx)ï¼Œé€‰æ‹©æ€§è·³è¿‡ã€‚ ã€Œæ²»æ ‡ã€</li>
</ul>
<h3 id="æ‹“å±•ï¼š"><a class="header-anchor" href="#æ‹“å±•ï¼š">Â¶</a>æ‹“å±•ï¼š</h3>
<h4 id="ä¸‹é¢è¿™ä¸ªè¾“å‡ºä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#ä¸‹é¢è¿™ä¸ªè¾“å‡ºä»€ä¹ˆï¼Ÿ">Â¶</a>ä¸‹é¢è¿™ä¸ªè¾“å‡ºä»€ä¹ˆï¼Ÿ</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> number <span class="type">int</span></span><br><span class="line">	fmt.Println(number / <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºç»“æœï¼š-v2"><a class="header-anchor" href="#è¾“å‡ºç»“æœï¼š-v2">Â¶</a>è¾“å‡ºç»“æœï¼š</h5>
<blockquote>
<p>division by zero</p>
</blockquote>
<h5 id="why"><a class="header-anchor" href="#why">Â¶</a>why?</h5>
<ul>
<li>é™¤æ•°ä¸èƒ½ä¸º0.</li>
</ul>
<h4 id="å…³äºfloatç±»å‹"><a class="header-anchor" href="#å…³äºfloatç±»å‹">Â¶</a>å…³äºfloatç±»å‹</h4>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">è¿™ä¹ˆç®€å•ï¼Œä¼°è®¡ä¼šè¢«è¯´å¾ˆèœï¼Œï¼Œï¼Œï¼Œ</span><br><span class="line"></span><br><span class="line">å…³äºfloatç±»å‹çš„ä½¿ç”¨å’Œæ³¨æ„äº‹é¡¹ã€Œå’Œè¯­è¨€æ— å…³ã€ï¼Œä¸€ç›´éƒ½å¾ˆé›¶æ•£ï¼Œä¸‹æ¥æ•´ç†ä¸‹ï¼Œç³»ç»Ÿæ€§çš„å­¦ä¹ å­¦ä¹ ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
<p>å¿«è¿‡å¹´äº†ï¼Œæå‰é¢„ç¥å¤§å®¶æ–°å¹´å¿«ä¹ã€‚ã€‚ã€‚ã€‚</p>
<p>ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨ğŸ§¨</p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Golang</tag>
        <tag>Float</tag>
        <tag>IEEE</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ30ã€redis rdbæºç -1</title>
    <url>/archives/44b34745.html</url>
    <content><![CDATA[<blockquote>
<p>RDBå’ŒAOFå¸¸å¸¸è¢«æèµ·,å¥½å¥‡RDBè¿™ä¸ªåˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„,è¿™æ ·æ‰èƒ½è¿ç”¨çš„æ›´åŠ çµæ´»å’Œç²¾å‡†.</p>
</blockquote>
<h3 id="å­¦å®Œé¢„æœŸçš„ç›®æ ‡"><a class="header-anchor" href="#å­¦å®Œé¢„æœŸçš„ç›®æ ‡">Â¶</a>å­¦å®Œé¢„æœŸçš„ç›®æ ‡:</h3>
<ul>
<li>å­¦ä¹ æ•°æ®å¼‚æ­¥å¤„ç†æµç¨‹</li>
<li>RDBæŒä¹…åŒ–æ•°æ®çš„å…³é”®è¿‡ç¨‹</li>
<li>RDBçš„ç¼ºç‚¹</li>
<li>RDBé€‚ç”¨çš„åœºæ™¯</li>
<li>RDBæ”¹è¿›ç‚¹æˆ–bug?</li>
<li>æ•°æ®æŒä¹…åŒ–,åº”è¯¥æ˜¯ä¸ªä»€ä¹ˆè¿‡ç¨‹?</li>
</ul>
<span id="more"></span>
<h3 id="Version"><a class="header-anchor" href="#Version">Â¶</a>Version</h3>
<blockquote>
<p>Redis 6.0.9</p>
</blockquote>
<h3 id="å®ç°æµç¨‹"><a class="header-anchor" href="#å®ç°æµç¨‹">Â¶</a>å®ç°æµç¨‹:</h3>
<ul>
<li>è¿™é‡Œç½—åˆ—äº†å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„è¿‡ç¨‹:</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/redis-rdb-1.png" alt=""></p>
<h4 id="rdbSaveBackground"><a class="header-anchor" href="#rdbSaveBackground">Â¶</a>rdbSaveBackground</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">rdbSaveBackground</span><span class="params">(<span class="type">char</span> *filename, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    <span class="type">pid_t</span> childpid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">hasActiveChildProcess</span>()) <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    server.dirty_before_bgsave = server.dirty;</span><br><span class="line">    server.lastbgsave_try = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">openChildInfoPipe</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((childpid = <span class="built_in">redisFork</span>(CHILD_TYPE_RDB)) == <span class="number">0</span>) &#123; <span class="comment">// forkä¸€ä¸ªå­è¿›ç¨‹</span></span><br><span class="line">        <span class="type">int</span> retval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Child */</span></span><br><span class="line">        <span class="built_in">redisSetProcTitle</span>(<span class="string">&quot;redis-rdb-bgsave&quot;</span>); <span class="comment">// è®¾ç½®æ ‡é¢˜</span></span><br><span class="line">        <span class="built_in">redisSetCpuAffinity</span>(server.bgsave_cpulist); <span class="comment">// è®¾ç½®cpuäº²å’ŒåŠ›</span></span><br><span class="line">        retval = <span class="built_in">rdbSave</span>(filename,rsi); <span class="comment">// rdbä¿å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK) &#123;</span><br><span class="line">            <span class="built_in">sendChildCOWInfo</span>(CHILD_TYPE_RDB, <span class="string">&quot;RDB&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exitFromChild</span>((retval == C_OK) ? <span class="number">0</span> : <span class="number">1</span>); <span class="comment">// å­è¿›ç¨‹é€€å‡º</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Parent */</span></span><br><span class="line">        <span class="keyword">if</span> (childpid == <span class="number">-1</span>) &#123; <span class="comment">// -1 å‘ç”Ÿé”™è¯¯äº†</span></span><br><span class="line">            <span class="built_in">closeChildInfoPipe</span>();</span><br><span class="line">            server.lastbgsave_status = C_ERR;</span><br><span class="line">            <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Can&#x27;t save in background: fork: %s&quot;</span>,</span><br><span class="line">                <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">return</span> C_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_NOTICE,<span class="string">&quot;Background saving started by pid %d&quot;</span>,childpid); <span class="comment">// ä¸‹é¢æ˜¯ä¸€äº›é‡æ–°åˆå§‹åŒ–çš„éƒ¨åˆ†</span></span><br><span class="line">        server.rdb_save_time_start = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">        server.rdb_child_pid = childpid;</span><br><span class="line">        server.rdb_child_type = RDB_CHILD_TYPE_DISK;</span><br><span class="line">        <span class="keyword">return</span> C_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_OK; <span class="comment">/* unreached */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="rdbSaveInfoã€Œstructã€"><a class="header-anchor" href="#rdbSaveInfoã€Œstructã€">Â¶</a>rdbSaveInfoã€Œstructã€</h5>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* This structure can be optionally passed to RDB save/load functions in</span></span><br><span class="line"><span class="comment"> * order to implement additional functionalities, by storing and loading</span></span><br><span class="line"><span class="comment"> * metadata to the RDB file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Currently the only use is to select a DB at load time, useful in</span></span><br><span class="line"><span class="comment"> * replication in order to make sure that chained slaves (slaves of slaves)</span></span><br><span class="line"><span class="comment"> * select the correct DB and are able to accept the stream coming from the</span></span><br><span class="line"><span class="comment"> * top-level master. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">rdbSaveInfo</span> &#123;</span><br><span class="line">    <span class="comment">/* Used saving and loading. */</span></span><br><span class="line">    <span class="type">int</span> repl_stream_db;  <span class="comment">/* DB to select in server.master client. */</span> <span class="comment">// é€‰ä¸­å¤åˆ¶çš„db</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Used only loading. */</span></span><br><span class="line">    <span class="type">int</span> repl_id_is_set;  <span class="comment">/* True if repl_id field is set. */</span></span><br><span class="line">    <span class="type">char</span> repl_id[CONFIG_RUN_ID_SIZE+<span class="number">1</span>];     <span class="comment">/* Replication ID. */</span> å‰¯æœ¬ID</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> repl_offset;                  <span class="comment">/* Replication offset. */</span> åç§»é‡</span><br><span class="line">&#125; rdbSaveInfo;</span><br></pre></td></tr></table></figure>
<h4 id="rdbSave"><a class="header-anchor" href="#rdbSave">Â¶</a>rdbSave</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Save the DB on disk. Return C_ERR on error, C_OK on success. */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rdbSave</span><span class="params">(<span class="type">char</span> *filename, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> tmpfile[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> cwd[MAXPATHLEN]; <span class="comment">/* Current working dir path for error messages. */</span></span><br><span class="line">    FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line">    rio rdb;</span><br><span class="line">    <span class="type">int</span> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(tmpfile,<span class="number">256</span>,<span class="string">&quot;temp-%d.rdb&quot;</span>, (<span class="type">int</span>) <span class="built_in">getpid</span>()); <span class="comment">// ä¸´æ—¶æ–‡ä»¶å‘½å pid</span></span><br><span class="line">    fp = <span class="built_in">fopen</span>(tmpfile,<span class="string">&quot;w&quot;</span>); <span class="comment">// åªè¯»æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> (!fp) &#123;</span><br><span class="line">        <span class="type">char</span> *cwdp = <span class="built_in">getcwd</span>(cwd,MAXPATHLEN);</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Failed opening the RDB file %s (in server root dir %s) &quot;</span></span><br><span class="line">            <span class="string">&quot;for saving: %s&quot;</span>,</span><br><span class="line">            filename,</span><br><span class="line">            cwdp ? cwdp : <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">            <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rioInitWithFile</span>(&amp;rdb,fp); <span class="comment">// rdbåˆå§‹åŒ–</span></span><br><span class="line">    <span class="built_in">startSaving</span>(RDBFLAGS_NONE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_save_incremental_fsync)</span><br><span class="line">        <span class="built_in">rioSetAutoSync</span>(&amp;rdb,REDIS_AUTOSYNC_BYTES);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdbSaveRio</span>(&amp;rdb,&amp;error,RDBFLAGS_NONE,rsi) == C_ERR) &#123; <span class="comment">// rdbä¿å­˜ã€Œé‡ç‚¹ã€</span></span><br><span class="line">        errno = error;</span><br><span class="line">        <span class="keyword">goto</span> werr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Make sure data will not remain on the OS&#x27;s output buffers */</span> <span class="comment">// åˆ·æ–°fpæ–‡ä»¶ä¸­å†…å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fflush</span>(fp)) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fsync</span>(<span class="built_in">fileno</span>(fp))) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fclose</span>(fp)) &#123; fp = <span class="literal">NULL</span>; <span class="keyword">goto</span> werr; &#125;</span><br><span class="line">    fp = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Use RENAME to make sure the DB file is changed atomically only</span></span><br><span class="line"><span class="comment">     * if the generate DB file is ok. */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename</span>(tmpfile,filename) == <span class="number">-1</span>) &#123; <span class="comment">// ä¸´æ—¶æ–‡ä»¶é‡æ–°å‘½å</span></span><br><span class="line">        <span class="type">char</span> *cwdp = <span class="built_in">getcwd</span>(cwd,MAXPATHLEN);</span><br><span class="line">        <span class="built_in">serverLog</span>(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Error moving temp DB file %s on the final &quot;</span></span><br><span class="line">            <span class="string">&quot;destination %s (in server root dir %s): %s&quot;</span>,</span><br><span class="line">            tmpfile,</span><br><span class="line">            filename,</span><br><span class="line">            cwdp ? cwdp : <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">            <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="built_in">unlink</span>(tmpfile);</span><br><span class="line">        <span class="built_in">stopSaving</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">serverLog</span>(LL_NOTICE,<span class="string">&quot;DB saved on disk&quot;</span>); <span class="comment">// æ—¥å¿—ä¿å­˜</span></span><br><span class="line">    server.dirty = <span class="number">0</span>; <span class="comment">// æœ€åçš„å˜é‡è¯¥ç½®ç©º&amp;è¯¥ä¿å­˜çŠ¶æ€çš„</span></span><br><span class="line">    server.lastsave = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    server.lastbgsave_status = C_OK;</span><br><span class="line">    <span class="built_in">stopSaving</span>(<span class="number">1</span>); <span class="comment">// åœæ­¢ä¿å­˜</span></span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">werr:</span><br><span class="line">    <span class="built_in">serverLog</span>(LL_WARNING,<span class="string">&quot;Write error saving DB on disk: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">if</span> (fp) <span class="built_in">fclose</span>(fp);</span><br><span class="line">    <span class="built_in">unlink</span>(tmpfile);</span><br><span class="line">    <span class="built_in">stopSaving</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> C_ERR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="rdbSaveRio"><a class="header-anchor" href="#rdbSaveRio">Â¶</a>rdbSaveRio</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Produces a dump of the database in RDB format sending it to the specified</span></span><br><span class="line"><span class="comment"> * Redis I/O channel. On success C_OK is returned, otherwise C_ERR</span></span><br><span class="line"><span class="comment"> * is returned and part of the output, or all the output, can be</span></span><br><span class="line"><span class="comment"> * missing because of I/O errors.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When the function returns C_ERR and if &#x27;error&#x27; is not NULL, the</span></span><br><span class="line"><span class="comment"> * integer pointed by &#x27;error&#x27; is set to the value of errno just after the I/O</span></span><br><span class="line"><span class="comment"> * error. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">rdbSaveRio</span><span class="params">(rio *rdb, <span class="type">int</span> *error, <span class="type">int</span> rdbflags, rdbSaveInfo *rsi)</span> &#123;</span><br><span class="line">    dictIterator *di = <span class="literal">NULL</span>;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="type">char</span> magic[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    <span class="type">uint64_t</span> cksum;</span><br><span class="line">    <span class="type">size_t</span> processed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_checksum)</span><br><span class="line">        rdb-&gt;update_cksum = rioGenericUpdateChecksum;</span><br><span class="line">    <span class="built_in">snprintf</span>(magic,<span class="keyword">sizeof</span>(magic),<span class="string">&quot;REDIS%04d&quot;</span>,RDB_VERSION); <span class="comment">// 04æŒ‡çš„æ˜¯ç‰ˆæœ¬å·</span></span><br><span class="line">    <span class="keyword">if</span> (rdbWriteRaw(rdb,magic,<span class="number">9</span>) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveInfoAuxFields(rdb,rdbflags,rsi) == <span class="number">-1</span>) <span class="keyword">goto</span> werr; <span class="comment">// redisè¾…åŠ©ä¿¡æ¯ï¼Œè¿”å›äº†-1ï¼Œä»£è¡¨è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveModulesAux(rdb, REDISMODULE_AUX_BEFORE_RDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr; <span class="comment">// æ¨¡å—åŒ–ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        redisDb *db = server.db+j;</span><br><span class="line">        dict *d = db-&gt;dict;</span><br><span class="line">        <span class="keyword">if</span> (dictSize(d) == <span class="number">0</span>) <span class="keyword">continue</span>; <span class="comment">// å¤§å°ä¸º0ï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">        di = dictGetSafeIterator(d); <span class="comment">// åˆ†é…å†…å­˜ï¼Œè¿”å›è¿­ä»£å™¨</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Write the SELECT DB opcode */</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_SELECTDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,j) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Write the RESIZE DB opcode. */</span></span><br><span class="line">        <span class="type">uint64_t</span> db_size, expires_size;</span><br><span class="line">        db_size = dictSize(db-&gt;dict);</span><br><span class="line">        expires_size = dictSize(db-&gt;expires);</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_RESIZEDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,db_size) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,expires_size) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Iterate this DB writing every entry */</span> <span class="comment">// éå†æ¯ä¸€ä¸ªentry</span></span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123; <span class="comment">// dictNextä¸ºå‡½æ•°å–å€¼çš„æ–¹å¼</span></span><br><span class="line">            sds keystr = dictGetKey(de); <span class="comment">// è·å–key</span></span><br><span class="line">            robj key, *o = dictGetVal(de); <span class="comment">//è·å–value</span></span><br><span class="line">            <span class="type">long</span> <span class="type">long</span> expire;</span><br><span class="line"></span><br><span class="line">            initStaticStringObject(key,keystr); <span class="comment">// åˆå§‹åŒ–objï¼Œã€Œç±»å‹ï¼Œæ•°é‡ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„åœ°å€ã€</span></span><br><span class="line">            expire = getExpire(db,&amp;key); <span class="comment">// é€šè¿‡keyæ¥æ‰¾è¿‡æœŸæ—¶é—´</span></span><br><span class="line">            <span class="keyword">if</span> (rdbSaveKeyValuePair(rdb,&amp;key,o,expire) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* When this RDB is produced as part of an AOF rewrite, move</span></span><br><span class="line"><span class="comment">             * accumulated diff from parent to child while rewriting in</span></span><br><span class="line"><span class="comment">             * order to have a smaller final write. */</span>  <span class="comment">// æŠŠçˆ¶çº§åˆ«çš„ç§¯ç´¯ç¼“å†²åˆ°ç¼“å†²åŒºï¼Œåœ¨é‡å†™å®Œæˆåä¸²è”åœ¨ä¸€èµ·ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (rdbflags &amp; RDBFLAGS_AOF_PREAMBLE &amp;&amp;</span><br><span class="line">                rdb-&gt;processed_bytes &gt; processed+AOF_READ_DIFF_INTERVAL_BYTES)</span><br><span class="line">            &#123;</span><br><span class="line">                processed = rdb-&gt;processed_bytes;</span><br><span class="line">                aofReadDiffFromParent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di); <span class="comment">// å†…å­˜é‡Šæ”¾ï¼Œåœ¨æ¯ä¸€æ¬¡å¾ªç¯ä¸­ï¼Œç”¨å®Œå°±é‡Šæ”¾ï¼Œã€Œå†…å­˜å‘¨æœŸç®¡ç†ã€</span></span><br><span class="line">        di = <span class="literal">NULL</span>; <span class="comment">/* So that we don&#x27;t release it again on error. */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we are storing the replication information on disk, persist</span></span><br><span class="line"><span class="comment">     * the script cache as well: on successful PSYNC after a restart, we need</span></span><br><span class="line"><span class="comment">     * to be able to process any EVALSHA inside the replication backlog the</span></span><br><span class="line"><span class="comment">     * master will send us. */</span></span><br><span class="line">    <span class="keyword">if</span> (rsi &amp;&amp; dictSize(server.lua_scripts)) &#123;</span><br><span class="line">        di = dictGetIterator(server.lua_scripts);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            robj *body = dictGetVal(de);</span><br><span class="line">            <span class="keyword">if</span> (rdbSaveAuxField(rdb,<span class="string">&quot;lua&quot;</span>,<span class="number">3</span>,body-&gt;ptr,sdslen(body-&gt;ptr)) == <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">goto</span> werr;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">        di = <span class="literal">NULL</span>; <span class="comment">/* So that we don&#x27;t release it again on error. */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveModulesAux(rdb, REDISMODULE_AUX_AFTER_RDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr; <span class="comment">// å†æ¬¡ä¿å­˜è¾…åŠ©çš„ä¿¡æ¯ï¼Œã€Œä¸Šä¸€æ­¥å¯èƒ½ä¼šæ”¹å˜ã€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* EOF opcode */</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_EOF) == <span class="number">-1</span>) <span class="keyword">goto</span> werr; <span class="comment">// ä¿å­˜æ–‡ä»¶ç±»å‹ï¼Œç»“æŸä½ç½®çš„æ ‡å¿—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* CRC64 checksum. It will be zero if checksum computation is disabled, the</span></span><br><span class="line"><span class="comment">     * loading code skips the check in this case. */</span></span><br><span class="line">    cksum = rdb-&gt;cksum;</span><br><span class="line">    memrev64ifbe(&amp;cksum);</span><br><span class="line">    <span class="keyword">if</span> (rioWrite(rdb,&amp;cksum,<span class="number">8</span>) == <span class="number">0</span>) <span class="keyword">goto</span> werr; <span class="comment">// checksum æ ¡éªŒä½æ’å…¥æ–‡ä»¶æœ€å</span></span><br><span class="line">    <span class="keyword">return</span> C_OK; <span class="comment">// è¿”å›0ï¼Œä¸€åˆ‡ok</span></span><br><span class="line"></span><br><span class="line">werr:</span><br><span class="line">    <span class="keyword">if</span> (error) *error = errno;</span><br><span class="line">    <span class="keyword">if</span> (di) dictReleaseIterator(di); <span class="comment">// ä¸€æ—¦é”™è¯¯å‘ç”Ÿåï¼ŒåŠæ—¶é‡Šæ”¾å†…å­˜</span></span><br><span class="line">    <span class="keyword">return</span> C_ERR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="rdbSaveKeyValuePairå®ç°"><a class="header-anchor" href="#rdbSaveKeyValuePairå®ç°">Â¶</a>rdbSaveKeyValuePairå®ç°</h4>
<ul>
<li>é”™è¯¯è¿”å›-1,æ­£å¸¸è¿”å›1,å…¶å®ƒè¿”å›0</li>
<li>ä¸»é€»è¾‘åªéœ€è´Ÿè´£å…¥å‚å’Œè¿”å›å€¼ã€ŒæŠ½è±¡ã€</li>
<li>ä¼˜å…ˆçº§: expire &gt; lru &gt; lfu &gt; [&lt;key,values&gt;]</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Save a key-value pair, with expire time, type, key, value.</span></span><br><span class="line"><span class="comment"> * On error -1 is returned.</span></span><br><span class="line"><span class="comment"> * On success if the key was actually saved 1 is returned, otherwise 0</span></span><br><span class="line"><span class="comment"> * is returned (the key was already expired). */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">rdbSaveKeyValuePair</span><span class="params">(rio *rdb, robj *key, robj *val, <span class="type">long</span> <span class="type">long</span> expiretime)</span> &#123;</span><br><span class="line">    <span class="type">int</span> savelru = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LRU;</span><br><span class="line">    <span class="type">int</span> savelfu = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  ä¿å­˜è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="comment">/* Save the expire time */</span></span><br><span class="line">    <span class="keyword">if</span> (expiretime != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveMillisecondTime(rdb,expiretime) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LRUæ–¹å¼ä¿å­˜</span></span><br><span class="line">    <span class="comment">/* Save the LRU info. */</span></span><br><span class="line">    <span class="keyword">if</span> (savelru) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> idletime = estimateObjectIdleTime(val);</span><br><span class="line">        idletime /= <span class="number">1000</span>; <span class="comment">/* Using seconds is enough and requires less space.*/</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_IDLE) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,idletime) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LFUæ–¹å¼ä¿å­˜</span></span><br><span class="line">    <span class="comment">/* Save the LFU info. */</span></span><br><span class="line">    <span class="keyword">if</span> (savelfu) &#123;</span><br><span class="line">        <span class="type">uint8_t</span> buf[<span class="number">1</span>];</span><br><span class="line">        buf[<span class="number">0</span>] = LFUDecrAndReturn(val);</span><br><span class="line">        <span class="comment">/* We can encode this in exactly two bytes: the opcode and an 8</span></span><br><span class="line"><span class="comment">         * bit counter, since the frequency is logarithmic with a 0-255 range.</span></span><br><span class="line"><span class="comment">         * Note that we do not store the halving time because to reset it</span></span><br><span class="line"><span class="comment">         * a single time when loading does not affect the frequency much. */</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_FREQ) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,<span class="number">1</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜ç±»å‹ã€keyã€valueç­‰</span></span><br><span class="line">    <span class="comment">/* Save type, key, value */</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveObjectType(rdb,val) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveStringObject(rdb,key) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveObject(rdb,val,key) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»¶è¿Ÿè¯·æ±‚</span></span><br><span class="line">    <span class="comment">/* Delay return if required (for testing) */</span></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_key_save_delay)</span><br><span class="line">        usleep(server.rdb_key_save_delay);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨åœºæ™¯-ã€Œ2021-03-16ã€"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-ã€Œ2021-03-16ã€">Â¶</a>ä½¿ç”¨åœºæ™¯:ã€Œ2021-03-16ã€</h3>
<ul>
<li>æ‰§è¡Œcommand</li>
<li>æ¡ä»¶å‘½ä»¤ confé…ç½®</li>
<li>shutdownæ—¶</li>
</ul>
<h4 id="rdbSave-usage-location"><a class="header-anchor" href="#rdbSave-usage-location">Â¶</a>rdbSave usage location:</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210316_083902.png" alt=""></p>
<blockquote>
<p>å…³äºrdbSaveBackgroudçš„ä½¿ç”¨åœ°æ–¹:</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210316_085205.png" alt=""></p>
<h3 id="å…³äºrdbsaveå’Œrediså¦‚ä½•è”ç³»çš„ï¼Ÿ"><a class="header-anchor" href="#å…³äºrdbsaveå’Œrediså¦‚ä½•è”ç³»çš„ï¼Ÿ">Â¶</a>å…³äºrdbsaveå’Œrediså¦‚ä½•è”ç³»çš„ï¼Ÿ</h3>
<blockquote>
<p>å†™åˆ°è¿™é‡Œçš„æ‰æ…¢æ…¢ç†è§£è¿™ä¸ªé‡Œé¢çš„å…³ç³»ï¼Œå¦‚æœä½ é—®æˆ‘ä¸ºå•¥ä¸åœ¨å‰é¢å°±åˆ—å‡ºæ¥å…³ç³»å›¾å‘¢ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>é‚£æˆ‘åªèƒ½è¯´è¿™æ˜¯ä¸€ä¸ªå­¦ä¹ çš„æ­£å¸¸æµç¨‹ï¼ŒæŠ“ä½å…¶ä¸­çš„å…³é”®ç‚¹ï¼Œå…ˆçœ‹å®ç°ï¼Œç„¶åå†å‘å¤–æ‰©æ•£ï¼Œç”±å†…è€Œå¤–.</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/redis-2021-03-16-13-48-23.png" alt=""></p>
<p><strong>å¦‚æœåŒºåˆ†ä¸‹redisçš„ä¸Šä¸‹å±‚é¢çš„å…³ç³»ï¼Œé‚£å°±å¯ä»¥å¤§è‡´åˆ†ä¸ºä¸‰å±‚ï¼šcommand+åº•å±‚å®ç°+æœ€åº•å±‚çš„IOæ“ä½œç­‰.</strong></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/redis-2021-03-16-13-58-41.png" alt=""></p>
<p><strong>å†ç»†åˆ†ä¸‹ä¸­é—´çš„è¿‡ç¨‹</strong><br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/redis-2021-03-16-14-13-35.png" alt=""></p>
<h3 id="Todo"><a class="header-anchor" href="#Todo">Â¶</a>Todo</h3>
<ul>
<li><input type="checkbox" id="checkbox0" checked="true"><label for="checkbox0">rdbå¿«é€Ÿå¤‡ä»½åŸå› : forkä¸»è¿›ç¨‹</label></li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1">æ•…éšœã€Œæ–­ç”µã€ç­‰æ¢å¤æœºåˆ¶</label></li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2">clusterå¤åˆ¶æ€ä¹ˆè¿›è¡Œçš„ï¼Ÿ</label></li>
</ul>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>Redis</tag>
        <tag>RDB</tag>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ29ã€map delete Memä¸é‡Šæ”¾é—®é¢˜</title>
    <url>/archives/2de36dd7.html</url>
    <content><![CDATA[<h3 id="Go-version"><a class="header-anchor" href="#Go-version">Â¶</a>Go version:</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">7384</span> â—¯  <span class="keyword">go</span> version</span><br><span class="line"><span class="keyword">go</span> version go1<span class="number">.14</span><span class="number">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="æœ€è¿‘æœ‰è¿™ä¹ˆä¸ªå‘"><a class="header-anchor" href="#æœ€è¿‘æœ‰è¿™ä¹ˆä¸ªå‘">Â¶</a>æœ€è¿‘æœ‰è¿™ä¹ˆä¸ªå‘:</h3>
<blockquote>
<p>ç¢°åˆ°å†…å­˜æ³„éœ²é—®é¢˜ï¼Œå¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p>
</blockquote>
<ul>
<li>1ã€å®šä¹‰ä¸€ä¸ªå…¨å±€map</li>
<li>2ã€ç»™é‡Œé¢æ”¾å€¼</li>
<li>3ã€ç”¨å®Œä¹‹ååˆ é™¤Key/value</li>
</ul>
<h3 id="é—®é¢˜ï¼šmapåˆ é™¤å®Œkeyåï¼ŒMemæœ‰æ²¡æœ‰è¢«é‡Šæ”¾ï¼Ÿ"><a class="header-anchor" href="#é—®é¢˜ï¼šmapåˆ é™¤å®Œkeyåï¼ŒMemæœ‰æ²¡æœ‰è¢«é‡Šæ”¾ï¼Ÿ">Â¶</a>é—®é¢˜ï¼šmapåˆ é™¤å®Œkeyåï¼ŒMemæœ‰æ²¡æœ‰è¢«é‡Šæ”¾ï¼Ÿ</h3>
<span id="more"></span>
<h3 id="è§‚å¯Ÿå†…å­˜å˜åŒ–ï¼š"><a class="header-anchor" href="#è§‚å¯Ÿå†…å­˜å˜åŒ–ï¼š">Â¶</a>è§‚å¯Ÿå†…å­˜å˜åŒ–ï¼š</h3>
<h4 id="æƒ…æ™¯1-åªåˆ é™¤Mapçš„k-v"><a class="header-anchor" href="#æƒ…æ™¯1-åªåˆ é™¤Mapçš„k-v">Â¶</a>æƒ…æ™¯1: åªåˆ é™¤Mapçš„k/v</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	<span class="comment">//intMap = nil</span></span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š"><a class="header-anchor" href="#è¾“å‡ºï¼š">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">162</span> TotalAlloc = <span class="number">162</span> Sys = <span class="number">69714</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">487</span> Sys = <span class="number">70290</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">473</span> TotalAlloc = <span class="number">490</span> Sys = <span class="number">70610</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> Alloc = <span class="number">475</span> TotalAlloc = <span class="number">494</span> Sys = <span class="number">70610</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯2-åˆ é™¤mapçš„k-v-å¹¶ç½®mapä¸ºnil"><a class="header-anchor" href="#æƒ…æ™¯2-åˆ é™¤mapçš„k-v-å¹¶ç½®mapä¸ºnil">Â¶</a>æƒ…æ™¯2: åˆ é™¤mapçš„k/v,å¹¶ç½®mapä¸ºnil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	intMap = <span class="literal">nil</span></span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v2"><a class="header-anchor" href="#è¾“å‡ºï¼š-v2">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69714</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">71696</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">71760</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">40</span> Alloc = <span class="number">160</span> TotalAlloc = <span class="number">492</span> Sys = <span class="number">71760</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯3-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-ä¸ç½®nil"><a class="header-anchor" href="#æƒ…æ™¯3-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-ä¸ç½®nil">Â¶</a>æƒ…æ™¯3: mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k/v,ä¸ç½®nil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	other()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">other</span><span class="params">()</span></span>&#123;</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	<span class="comment">//intMap = nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v3"><a class="header-anchor" href="#è¾“å‡ºï¼š-v3">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69458</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">71440</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">71504</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">35</span> Alloc = <span class="number">473</span> TotalAlloc = <span class="number">492</span> Sys = <span class="number">71504</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯4-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-mapç½®ä¸ºnil"><a class="header-anchor" href="#æƒ…æ™¯4-mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k-v-mapç½®ä¸ºnil">Â¶</a>æƒ…æ™¯4: mapæ”¾åœ¨å‡½æ•°ä¸­ï¼Œå¹¶åˆ é™¤mapçš„k/v,mapç½®ä¸ºnil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	other()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">other</span><span class="params">()</span></span>&#123;</span><br><span class="line">	initMap()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	intMap = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v4"><a class="header-anchor" href="#è¾“å‡ºï¼š-v4">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69714</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">70034</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">471</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">70098</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">02</span> Alloc = <span class="number">160</span> TotalAlloc = <span class="number">492</span> Sys = <span class="number">70098</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h4 id="æƒ…æ™¯5-mapå®šä¹‰æ”¾åœ¨å±€éƒ¨å˜é‡ä¸­ï¼š"><a class="header-anchor" href="#æƒ…æ™¯5-mapå®šä¹‰æ”¾åœ¨å±€éƒ¨å˜é‡ä¸­ï¼š">Â¶</a>æƒ…æ™¯5: mapå®šä¹‰æ”¾åœ¨å±€éƒ¨å˜é‡ä¸­ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> cnt = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	printMemStats()</span><br><span class="line">	other()</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">other</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> intMap <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span></span><br><span class="line">	intMap = initMap(intMap)</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		<span class="built_in">delete</span>(intMap, i)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="built_in">len</span>(intMap))</span><br><span class="line">	runtime.GC()</span><br><span class="line">	printMemStats()</span><br><span class="line">	<span class="comment">//intMap = nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initMap</span><span class="params">(intMap <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>)</span></span> <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span> &#123;</span><br><span class="line">	intMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>, cnt)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; cnt; i++ &#123;</span><br><span class="line">		intMap[i] = i</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> intMap</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">	runtime.ReadMemStats(&amp;m)</span><br><span class="line">	log.Printf(<span class="string">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\n&quot;</span>, m.Alloc/<span class="number">1024</span>, m.TotalAlloc/<span class="number">1024</span>, m.Sys/<span class="number">1024</span>, m.NumGC)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¾“å‡ºï¼š-v5"><a class="header-anchor" href="#è¾“å‡ºï¼š-v5">Â¶</a>è¾“å‡ºï¼š</h5>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">161</span> TotalAlloc = <span class="number">161</span> Sys = <span class="number">69458</span> NumGC = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">469</span> TotalAlloc = <span class="number">484</span> Sys = <span class="number">71440</span> NumGC = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">158</span> TotalAlloc = <span class="number">488</span> Sys = <span class="number">71504</span> NumGC = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">01</span>/<span class="number">06</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">54</span> Alloc = <span class="number">160</span> TotalAlloc = <span class="number">491</span> Sys = <span class="number">71504</span> NumGC = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h5 id="æ±‡ç¼–è¾“å‡ºï¼š"><a class="header-anchor" href="#æ±‡ç¼–è¾“å‡ºï¼š">Â¶</a>æ±‡ç¼–è¾“å‡ºï¼š</h5>
<p>æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€è¡Œï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210106_051000.png" alt=""></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">XORL å¼‚æˆ–è¿ç®—ç¬¦ </span><br><span class="line"></span><br><span class="line">XORL AX,AX ---&gt;å°†AXç½®0å€¼</span><br></pre></td></tr></table></figure>
<h4 id="deleteå‡½æ•°ï¼š"><a class="header-anchor" href="#deleteå‡½æ•°ï¼š">Â¶</a>deleteå‡½æ•°ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0125</span> <span class="number">00293</span> (../<span class="number">1126</span>/main.<span class="keyword">go</span>:<span class="number">26</span>)	CALL	runtime.mapdelete_fast64(SB)</span><br></pre></td></tr></table></figure>
<h5 id="mapdelete-fast64å‡½æ•°ä½œç”¨ï¼š"><a class="header-anchor" href="#mapdelete-fast64å‡½æ•°ä½œç”¨ï¼š">Â¶</a>mapdelete_fast64å‡½æ•°ä½œç”¨ï¼š</h5>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/map_fast64.go#L272">ç‚¹å‡»GithubæŸ¥çœ‹</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210106_052140.png" alt=""></p>
<blockquote>
<p>æœ‰æ„æ€çš„æ˜¯ï¼šmapçš„è®¾è®¡å°±æ˜¯è¿™æ ·ï¼Œåˆ é™¤keyï¼Œåªæ˜¯æŠŠè¿™ä¸ªæ§½ä½ç½®emptyï¼Œå¹¶æ²¡æœ‰é‡Šæ”¾å†…å­˜.</p>
</blockquote>
<h3 id="Others"><a class="header-anchor" href="#Others">Â¶</a>Others:</h3>
<h4 id="å…¶å®ƒåœºæ™¯ï¼š"><a class="header-anchor" href="#å…¶å®ƒåœºæ™¯ï¼š">Â¶</a>å…¶å®ƒåœºæ™¯ï¼š</h4>
<blockquote>
<p>åœºæ™¯æœ‰å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯é€»åˆ—æœ€ç®€å•çš„ï¼Œè‡³äºç”¨æŒ‡é’ˆä¹‹ç±»çš„ï¼Œæœ‰å…´è¶£äº†å†ç ”ç©¶ç ”ç©¶ï¼Œæ–¹æ³•éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
</blockquote>
<h4 id="æ±‡ç¼–ä»£ç ç”Ÿæˆ"><a class="header-anchor" href="#æ±‡ç¼–ä»£ç ç”Ÿæˆ">Â¶</a>æ±‡ç¼–ä»£ç ç”Ÿæˆ</h4>
<ul>
<li>è¯¦ç»†è§æ­¤æ–‡ï¼š<a href="https://blog.imrcrab.com/archives/2ce846ed.html">ã€Œ15ã€Plan9 æ±‡ç¼–å°è®°</a></li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Map</tag>
        <tag>Hash</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ28ã€sync-mutexä¼ å‚å¤åˆ¶é—®é¢˜</title>
    <url>/archives/a82ae489.html</url>
    <content><![CDATA[<h3 id="Go-version"><a class="header-anchor" href="#Go-version">Â¶</a>Go version:</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">7384</span> â—¯  <span class="keyword">go</span> version</span><br><span class="line"><span class="keyword">go</span> version go1<span class="number">.14</span><span class="number">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="èµ·å› "><a class="header-anchor" href="#èµ·å› ">Â¶</a>èµ·å› :</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sync.Mutexå½“å‚æ•°,å€¼ä¼ é€’åå‡ºé”™.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ç°è±¡"><a class="header-anchor" href="#ç°è±¡">Â¶</a>ç°è±¡:</h3>
<blockquote>
<p>ä¸åºŸè¯,ä¸Šä»£ç :</p>
</blockquote>
<span id="more"></span>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> age <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	mux sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span></span> AddAge() &#123;</span><br><span class="line">	<span class="keyword">defer</span> wg.Done()</span><br><span class="line">	p.mux.Lock()</span><br><span class="line">	age++</span><br><span class="line">	<span class="keyword">defer</span> p.mux.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	p1 := Person&#123;</span><br><span class="line">		mux: sync.Mutex&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Add(<span class="number">100</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> p1.AddAge()</span><br><span class="line">	&#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    </span><br><span class="line">	fmt.Println(age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="è¿™ä¸ªageçš„è¾“å‡ºåº”è¯¥æ˜¯å¤šå°‘"><a class="header-anchor" href="#è¿™ä¸ªageçš„è¾“å‡ºåº”è¯¥æ˜¯å¤šå°‘">Â¶</a>è¿™ä¸ªageçš„è¾“å‡ºåº”è¯¥æ˜¯å¤šå°‘?</h4>
<h4 id="ä¸å¦¨å¯ä»¥å¤šå°è¯•å‡ æ¬¡-ç»“æœ"><a class="header-anchor" href="#ä¸å¦¨å¯ä»¥å¤šå°è¯•å‡ æ¬¡-ç»“æœ">Â¶</a>ä¸å¦¨å¯ä»¥å¤šå°è¯•å‡ æ¬¡,ç»“æœ:</h4>
<blockquote>
<p>100/99/98éƒ½æœ‰å¯èƒ½.</p>
</blockquote>
<h3 id="What-Lockéš¾é“ä¸æ˜¯åŠ é”çš„ä¹ˆ"><a class="header-anchor" href="#What-Lockéš¾é“ä¸æ˜¯åŠ é”çš„ä¹ˆ">Â¶</a>What? Lockéš¾é“ä¸æ˜¯åŠ é”çš„ä¹ˆ</h3>
<blockquote>
<p>LockåŠ é”éš¾é“ä¸æ˜¯è¿™ä¹ˆç”¨çš„ä¹ˆ,é¢ è¦†è®¤çŸ¥!</p>
</blockquote>
<h4 id="Lockæºç "><a class="header-anchor" href="#Lockæºç ">Â¶</a>Lockæºç :</h4>
<p><em>A Mutex must not be copied after first use</em></p>
<h3 id="æ ¹æº"><a class="header-anchor" href="#æ ¹æº">Â¶</a>æ ¹æº:</h3>
<ul>
<li>Goå‚æ•°ä¼ é€’å±äºå€¼ä¼ é€’</li>
<li>Mutexå¤åˆ¶åä¸­çš„stateå±äºå‰ä¸€çŠ¶æ€,æ²¡æœ‰æ”¹å˜</li>
<li>Mutexä¸­çš„Lockå’ŒUnlockã€Œæ–¹æ³•ã€å±äºæŒ‡é’ˆç±»å‹<sup>å›¾1</sup></li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210102_102753.png" alt=""><br>
<strong><center>å›¾<sup>1</sup></center></strong></p>
<h3 id="è§£å†³åŠæ³•"><a class="header-anchor" href="#è§£å†³åŠæ³•">Â¶</a>è§£å†³åŠæ³•</h3>
<ul>
<li>å½“ç„¶æ˜¯å‚è€ƒæºç ,ã€Œå›¾1ã€</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ç¼ºç‚¹:</span><br><span class="line">    æ¯æ¬¡ä½¿ç”¨ä¹‹å‰éœ€è¦åˆå§‹åŒ–,æ¯•ç«Ÿæ˜¯æŒ‡é’ˆç±»å‹çš„</span><br><span class="line"></span><br><span class="line">ä¼˜ç‚¹:</span><br><span class="line">    è®¾è®¡æºäºæºç ,è¿½éšGoçš„è®¾è®¡.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>åŠ é”çš„åœ°æ–¹å°½é‡æ˜¯å…¨å±€çš„</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">è¿™ä¸ªå°±ä¸åˆ†æäº†,æ¯•ç«Ÿä¸é€‚ç”¨æ‰€æœ‰åœºæ™¯.</span><br><span class="line"></span><br><span class="line">ä¸é€‚ç”¨çš„åœºæ™¯:</span><br><span class="line">    ä¸´æ—¶çš„Mapéœ€è¦åŠ é”,å¦‚æœç”¨å…¨å±€é”,åˆ™æ•ˆç‡é™ä½.</span><br></pre></td></tr></table></figure>
<h3 id="SyncåŒ…ä¸å¯å¤åˆ¶æ€§"><a class="header-anchor" href="#SyncåŒ…ä¸å¯å¤åˆ¶æ€§">Â¶</a>SyncåŒ…ä¸å¯å¤åˆ¶æ€§</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨syncåŒ…ä¸‹çš„åŠŸèƒ½,å¯èƒ½å¾—æ³¨æ„äº†,éƒ½æ˜¯ä¸å¯å¤åˆ¶çš„.</span><br></pre></td></tr></table></figure>
<h3 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h3>
<blockquote>
<p>æ¯æ¬¡çœ‹æºç ,éƒ½ä¼šæœ‰ä¸ä¸€æ ·çš„æ”¶è·.ã€Œä¹Ÿè®¸æ˜¯æˆ‘ç†è§£èƒ½åŠ›å·®å“ˆã€</p>
</blockquote>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>sync</tag>
        <tag>Mutex</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ27ã€Time Zoneæ—¶åŒºè¯¦è§£</title>
    <url>/archives/513dbeba.html</url>
    <content><![CDATA[<p>æ—¶åŒºï¼Œæ— å…³è¯­è¨€ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç³»ç»Ÿä¸­éƒ½ä¼šç”¨åˆ°ï¼š</p>
<ul>
<li>timeã€Œæ—¶é—´ã€</li>
<li>timeIDã€Œæ—¶é—´ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€</li>
<li>time to unix</li>
<li>unix to time string</li>
<li>â€¦</li>
</ul>
<blockquote>
<p>å¾ˆå¤šåœºæ™¯éƒ½ä¼šçœ‹åˆ°è¿™ä¸ªæ—¶é—´çš„é‡è¦æ€§ï¼Œè¿™æ¬¡çœ‹åˆ°16çš„ç‰¹æ€§ä¸­æœ‰ä¸€ä¸ªä¿®æ”¹é¡¹ï¼Œè§‰å¾—è‡ªå·±å¯¹timeå’Œzoneäº†è§£çš„å¤ªå°‘äº†ï¼Œä»¥æ­¤è®°å½•ï¼Œä»¥ä¾¿ç§¯ç´¯ã€‚</p>
</blockquote>
<span id="more"></span>
<h3 id="Go-version"><a class="header-anchor" href="#Go-version">Â¶</a>Go version:</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">7384</span> â—¯  <span class="keyword">go</span> version</span><br><span class="line"><span class="keyword">go</span> version go1<span class="number">.14</span><span class="number">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="æ—¶åŒº-UTC-GMT-MDT-CST"><a class="header-anchor" href="#æ—¶åŒº-UTC-GMT-MDT-CST">Â¶</a>æ—¶åŒº UTC\GMT\MDT\CST</h3>
<blockquote>
<p>è¯´åˆ°æ—¶é—´ï¼Œè‚¯å®šå¾—æƒ³åˆ°æ—¶åŒºé—®é¢˜ï¼Œå’±ä»¬å›½å®¶è¿˜å¥½ï¼Œåªæœ‰ä¸€ä¸ªBeijingæ—¶åŒºï¼Œç¾å›½æœ¬åœŸã€‚ã€‚ã€‚ã€‚å››ä¸ªæ—¶åŒºã€Œæ™•äº†ã€</p>
</blockquote>
<p>Ps: <a href="https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E6%99%82%E5%8D%80">ç‚¹å‡»æŸ¥çœ‹å››ä¸ªæ—¶åŒº</a></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">GMT (Greenwich Mean Time)çš„ç¼©å†™ï¼ŒæŒ‡çš„æ˜¯çš‡å®¶æ ¼æ—å¨æ²»å¤©æ–‡å°çš„æ ‡å‡†æ—¶é—´ï¼Œç§°ä½œæ ¼æ—å¨æ²»æ—¶é—´ï¼Œå› ä¸ºæœ¬åˆå­åˆçº¿é€šè¿‡æ­¤åœ°åŒºï¼Œå› æ­¤ä¹Ÿç§°ä¸ºä¸–ç•Œæ ‡å‡†æ—¶é—´ã€‚ç„¶è€Œåœ°çƒçš„è‡ªè½¬ä¸æ˜¯å®Œå…¨è§„å¾‹çš„ï¼Œè€Œä¸”æ­£é€æ¸å‡æ…¢ï¼Œå› æ­¤è‡ª1924å¹´å¼€å§‹ï¼Œæ ¼æ—å¨æ²»æ—¶é—´(GMT)å·²ç»ä¸å†è¢«è§†ä¸ºæ ‡å‡†æ—¶é—´ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯&quot;ä¸–ç•Œåè°ƒæ—¶é—´&quot; (UTC: Coordinated Universal Time)</span><br><span class="line"></span><br><span class="line">UTC åè°ƒä¸–ç•Œæ—¶ï¼ˆCoordinated Universal Timeï¼‰æ˜¯æœ€ä¸»è¦çš„ä¸–ç•Œæ—¶é—´æ ‡å‡†ï¼Œå…¶ä»¥åŸå­æ—¶ç§’é•¿ä¸ºåŸºç¡€ï¼Œåœ¨æ—¶åˆ»ä¸Šå°½é‡æ¥è¿‘äºæ ¼æ—å°¼æ²»æ ‡å‡†æ—¶é—´ã€‚UTC æ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ—¶åŒº</span><br><span class="line"></span><br><span class="line">CST</span><br><span class="line">â€ƒåŒ—äº¬æ—¶é—´ï¼ŒChina Standard Timeï¼Œä¸­å›½æ ‡å‡†æ—¶é—´ï¼Œæ˜¯ä¸­å›½çš„æ ‡å‡†æ—¶é—´ã€‚åœ¨æ—¶åŒºåˆ’åˆ†ä¸Šï¼Œå±ä¸œå…«åŒºï¼Œæ¯”åè°ƒä¸–ç•Œæ—¶æ—©8å°æ—¶ï¼Œè®°ä¸ºUTC+8</span><br></pre></td></tr></table></figure>
<h3 id="Goä¸­çš„æ—¶åŒºé—®é¢˜"><a class="header-anchor" href="#Goä¸­çš„æ—¶åŒºé—®é¢˜">Â¶</a>Goä¸­çš„æ—¶åŒºé—®é¢˜</h3>
<p>æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥è¯´æ˜è¿™ä¸ªæ—¶åŒºé—®é¢˜ï¼š</p>
<ul>
<li>time.LoadLocation</li>
</ul>
<blockquote>
<p>å¦‚æœä½ æŸ¥æŸ¥æºç ï¼Œå°±ä¼šå‘ç°è¿™ä¸ªå‡½æ•°ä¸Šé¢å†™ç€æ—¶åŒºçš„é—®é¢˜ï¼Œä¹Ÿè·Ÿä¸ç”¨ç™¾åº¦æ—¶åŒºï¼Œæœ‰çš„è‡ªç„¶æ”¯æŒï¼Œæ²¡æœ‰çš„å†™äº†å°±æ˜¯ä¹±å†™äº†ã€‚</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20201228_112003.png" alt=""></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">æŸ¥è¯¢çš„æ—¶åŒºä¸€ç›´å°±åœ¨ä½ gorootè·¯å¾„ä¸‹çš„ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä¸­ã€‚</span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„æœ‰å…´è¶£å¯ä»¥å»çœ‹çœ‹æ‰€æœ‰çš„æ—¶åŒºï¼Œåç»­ä¹Ÿå°±æœ‰ä¸€ä¸ªå…¨é¢çš„äº†è§£äº†ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20201228_112408.png" alt=""></p>
<h3 id="Go-ä¸­å¯¹äºæ—¶é—´çš„ä½¿ç”¨"><a class="header-anchor" href="#Go-ä¸­å¯¹äºæ—¶é—´çš„ä½¿ç”¨">Â¶</a>Go ä¸­å¯¹äºæ—¶é—´çš„ä½¿ç”¨</h3>
<blockquote>
<p>å¾…æ›´æ–°â€¦</p>
</blockquote>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>time</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ26ã€Go 1.16 ç‰¹æ€§</title>
    <url>/archives/4f05d45d.html</url>
    <content><![CDATA[<p><a href="https://golang.org/doc/go1.16">Go 1.16ç‰¹æ€§ï¼š</a></p>
<span id="more"></span>
<h2 id="jsonè‡ªå®šä¹‰ã€Œissues-5901ã€"><a class="header-anchor" href="#jsonè‡ªå®šä¹‰ã€Œissues-5901ã€">Â¶</a>jsonè‡ªå®šä¹‰<a href="https://github.com/golang/go/issues/5901">ã€Œissues 5901ã€</a></h2>
<h3 id="ã€ŒFeatã€"><a class="header-anchor" href="#ã€ŒFeatã€">Â¶</a>ã€ŒFeatã€</h3>
<h3 id="èµ·æºï¼š"><a class="header-anchor" href="#èµ·æºï¼š">Â¶</a>èµ·æºï¼š</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">For example, if a user wants to marshal net.IP with custom code, we should provide a way</span><br><span class="line">to do that, probably a method on *Encoder. Similarly for *Decoder.</span><br><span class="line"></span><br><span class="line">Same for encoding/xml</span><br></pre></td></tr></table></figure>
<h3 id="å˜æ›´ï¼š"><a class="header-anchor" href="#å˜æ›´ï¼š">Â¶</a>å˜æ›´ï¼š</h3>
<p><a href="https://go-review.googlesource.com/c/go/+/31091">coding:</a></p>
<h3 id="ä½¿ç”¨æ•™ç¨‹ï¼š"><a class="header-anchor" href="#ä½¿ç”¨æ•™ç¨‹ï¼š">Â¶</a><a href="https://github.com/golang/go/issues/5901#issuecomment-566269861">ä½¿ç”¨æ•™ç¨‹ï¼š</a></h3>
<h2 id="GMTå’ŒMDTæ—¶åŒºé—®é¢˜ã€Œissues-43354ã€"><a class="header-anchor" href="#GMTå’ŒMDTæ—¶åŒºé—®é¢˜ã€Œissues-43354ã€">Â¶</a>GMTå’ŒMDTæ—¶åŒºé—®é¢˜<a href="https://github.com/golang/go/issues/43354">ã€Œissues 43354ã€</a></h2>
<h3 id="ã€ŒFixã€"><a class="header-anchor" href="#ã€ŒFixã€">Â¶</a>ã€ŒFixã€</h3>
<h3 id="é—®é¢˜ï¼š"><a class="header-anchor" href="#é—®é¢˜ï¼š">Â¶</a>é—®é¢˜ï¼š</h3>
<blockquote>
<p>ä¸»è¦ä¿®å¤ä¸€ä¸ªæ—¶åŒºé—®é¢˜ MDT or GMT ï¼Ÿ</p>
</blockquote>
<p><a href="https://github.com/golang/go/issues/43354#issuecomment-750490418">å®˜æ–¹reply</a><br>
<a href="https://go-review.googlesource.com/c/go/+/280072/">go-review</a></p>
<h2 id="go-get-dã€Œissues-43131ã€"><a class="header-anchor" href="#go-get-dã€Œissues-43131ã€">Â¶</a>go get -d<a href="https://github.com/golang/go/issues/43131">ã€Œissues 43131ã€</a></h2>
<h3 id="ã€ŒFeatã€-v2"><a class="header-anchor" href="#ã€ŒFeatã€-v2">Â¶</a>ã€ŒFeatã€</h3>
<h3 id="å˜æ›´ï¼š-v2"><a class="header-anchor" href="#å˜æ›´ï¼š-v2">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">cmd/<span class="keyword">go</span>æ–°å¢ï¼šã€Œä»…ä¸‹è½½ï¼Œä¸ä½¿ç”¨æ­¤ä¾èµ–ã€</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> get -d</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="go-mod-downloadæ— æ³•æŒ‡å®šç‰ˆæœ¬ã€Œissues-42524ã€"><a class="header-anchor" href="#go-mod-downloadæ— æ³•æŒ‡å®šç‰ˆæœ¬ã€Œissues-42524ã€">Â¶</a>go mod downloadæ— æ³•æŒ‡å®šç‰ˆæœ¬<a href="https://github.com/golang/go/issues/42524">ã€Œissues 42524ã€</a></h2>
<h3 id="ã€ŒFixã€-v2"><a class="header-anchor" href="#ã€ŒFixã€-v2">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´ï¼š-v3"><a class="header-anchor" href="#å˜æ›´ï¼š-v3">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">modify æŒ‡å®šç‰ˆæœ¬å¯ä»¥download</span><br></pre></td></tr></table></figure>
<h3 id="review"><a class="header-anchor" href="#review">Â¶</a><a href="https://go-review.googlesource.com/c/go/+/270520/">review</a></h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20201228_011910.png" alt=""></p>
<h2 id="ParseDir-æŒ‡å®š-goä½œä¸ºåç¼€çš„bugã€Œissues-42951ã€"><a class="header-anchor" href="#ParseDir-æŒ‡å®š-goä½œä¸ºåç¼€çš„bugã€Œissues-42951ã€">Â¶</a>ParseDir æŒ‡å®š.goä½œä¸ºåç¼€çš„bug<a href="https://github.com/golang/go/issues/42951">ã€Œissues 42951ã€</a></h2>
<h3 id="ã€ŒFixã€-v3"><a class="header-anchor" href="#ã€ŒFixã€-v3">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´ï¼š-v4"><a class="header-anchor" href="#å˜æ›´ï¼š-v4">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ä»¥.<span class="keyword">go</span>ç»“å°¾çš„æ–‡ä»¶å¤¹ï¼ŒParseDiræ— æ³•è½¬æ¢</span><br></pre></td></tr></table></figure>
<h3 id="review-v2"><a class="header-anchor" href="#review-v2">Â¶</a><a href="https://github.com/golang/go/commit/48838c35dc7c8e938a83db66faabf3a51f4adc3d">review</a></h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20201228_013355.png" alt=""></p>
<h2 id="strconv-ParseComplexæœªå¤„ç†32ä½æ•°å­—ã€Œissues-40706ã€"><a class="header-anchor" href="#strconv-ParseComplexæœªå¤„ç†32ä½æ•°å­—ã€Œissues-40706ã€">Â¶</a>strconv:ParseComplexæœªå¤„ç†32ä½æ•°å­—<a href="https://github.com/golang/go/issues/40706">ã€Œissues 40706ã€</a></h2>
<h3 id="ã€ŒFixã€-v4"><a class="header-anchor" href="#ã€ŒFixã€-v4">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´ï¼š-v5"><a class="header-anchor" href="#å˜æ›´ï¼š-v5">Â¶</a>å˜æ›´ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">å¤„ç†<span class="number">32</span>bitsizeï¼Œéœ€è¦è¿”å›<span class="type">error</span>ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="review-v3"><a class="header-anchor" href="#review-v3">Â¶</a><a href="https://go-review.googlesource.com/c/go/+/248219/">review</a></h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20201228_051536.png" alt=""></p>
<h2 id="runtime-getMcache-ã€Œissues-42339ã€"><a class="header-anchor" href="#runtime-getMcache-ã€Œissues-42339ã€">Â¶</a>runtime {getMcache} <a href="https://github.com/golang/go/issues/42339">ã€Œissues 42339ã€</a></h2>
<h3 id="ã€ŒFixã€-v5"><a class="header-anchor" href="#ã€ŒFixã€-v5">Â¶</a>ã€ŒFixã€</h3>
<h3 id="å˜æ›´"><a class="header-anchor" href="#å˜æ›´">Â¶</a>å˜æ›´</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">runtime: <span class="built_in">make</span> getMCache inlineable</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="review-v4"><a class="header-anchor" href="#review-v4">Â¶</a>review</h3>
<ul>
<li>
<p><a href="https://go-review.googlesource.com/c/go/+/267158/">runtime: decouple consistent stats from mcache and allow P-less update</a></p>
</li>
<li>
<p><a href="https://go-review.googlesource.com/c/go/+/267157/">runtime: make getMCache inlineable</a></p>
</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20201228_081048.png" alt=""></p>
<h2 id="Slice-Grow-Size-Change"><a class="header-anchor" href="#Slice-Grow-Size-Change">Â¶</a>Slice Grow Size Change</h2>
<h3 id="ã€ŒChangeã€"><a class="header-anchor" href="#ã€ŒChangeã€">Â¶</a>ã€ŒChangeã€</h3>
<h3 id="å˜æ›´-v2"><a class="header-anchor" href="#å˜æ›´-v2">Â¶</a>å˜æ›´</h3>
<p><a href="https://github.com/golang/go/commit/2333c6299f340a5f76a73a4fec6db23ffa388e97">ğŸ‘‹ğŸ‘‹commit</a></p>
<p><a href="https://go-review.googlesource.com/c/go/+/257338">ğŸ‘‹â¡ï¸review</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20210424_012848.png" alt=""></p>
<h2 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h2>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Go_1.16</tag>
        <tag>encoding/json</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ25ã€GPM sysmonå‡½æ•°</title>
    <url>/archives/c770fe49.html</url>
    <content><![CDATA[<p>å‰é¢ä¸»è¦æ˜¯äº†è§£newmçš„å…¨è¿‡ç¨‹å’Œå…¶ä¸­éš¾è¿‡ä¸€äº›ç»†èŠ‚é€»è¾‘ï¼Œï¼Œï¼Œ<br>
å¦‚æœæ²¡äº†è§£çš„ï¼Œå»ºè®®å…ˆå»çœ‹ä¸‹å¤§æ¦‚çš„è¿‡ç¨‹ï¼Œè™½ç„¶ä¸æ˜¯éå¸¸è¯¦ç»†ï¼Œ<br>
æœ€èµ·ç å¾—çŸ¥é“newmè¿‡ç¨‹ï¼Œä¸»è¦å®Œæˆäº†ä»€ä¹ˆæ“ä½œï¼Œæœ‰åˆ©äºåç»­ç†è§£ã€‚</p>
<p>è¿™æ¬¡ä¸»è¦æ˜¯æ¥å­¦å­¦è¿™ä¸ªsysmonï¼Œç³»ç»Ÿç›‘æ§è°ƒåº¦çš„é€»è¾‘ã€‚</p>
<span id="more"></span>
<h3 id="Go-version"><a class="header-anchor" href="#Go-version">Â¶</a>Go version</h3>
<blockquote>
<p>go 1.14</p>
</blockquote>
<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>åœ¨æ·±å…¥ä¹‹å‰å‘¢ï¼Œå…ˆå¯¹ä¸‹é¢è¿™äº›å˜é‡æœ‰ä¸ªæ¦‚å¿µï¼Œåç»­æåˆ°ä¹Ÿå°±ä¸é™Œç”Ÿäº†ã€‚ã€Œæ‘˜æŠ„è‡ªsysmonå‡½æ•°ã€</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	allglen    <span class="type">uintptr</span> <span class="comment">//g</span></span><br><span class="line">	allm       *m      <span class="comment">//m</span></span><br><span class="line">	allp       []*p  <span class="comment">// p     len(allp) == gomaxprocs; may change at safe points, otherwise immutable</span></span><br><span class="line">	allpLock   mutex <span class="comment">// å…¨å±€lockã€‚   Protects P-less reads of allp and all writes</span></span><br><span class="line">	gomaxprocs <span class="type">int32</span> <span class="comment">//æœ€å¤§processæ•°é‡</span></span><br><span class="line">	ncpu       <span class="type">int32</span> <span class="comment">//cpuä¸ªæ•°</span></span><br><span class="line">	forcegc    forcegcstate <span class="comment">//å¼ºåˆ¶GC</span></span><br><span class="line">	sched      schedt <span class="comment">//é¢„åˆ†é…çš„ä¸€äº›å˜é‡å€¼</span></span><br><span class="line">	newprocs   <span class="type">int32</span>  <span class="comment">//æ–°çš„process</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Information about what cpu features are available.</span></span><br><span class="line">	<span class="comment">// Packages outside the runtime should not use these</span></span><br><span class="line">	<span class="comment">// as they are not an external api.</span></span><br><span class="line">	<span class="comment">// Set on startup in asm_&#123;386,amd64&#125;.s</span></span><br><span class="line">	processorVersionInfo <span class="type">uint32</span></span><br><span class="line">	isIntel              <span class="type">bool</span></span><br><span class="line">	lfenceBeforeRdtsc    <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">	goarm                <span class="type">uint8</span> <span class="comment">// set by cmd/link on arm systems</span></span><br><span class="line">	framepointer_enabled <span class="type">bool</span>  <span class="comment">// set by cmd/link</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="sysmonå‡½æ•°"><a class="header-anchor" href="#sysmonå‡½æ•°">Â¶</a>sysmonå‡½æ•°</h3>
<h4 id="æ¦‚è§ˆ"><a class="header-anchor" href="#æ¦‚è§ˆ">Â¶</a>æ¦‚è§ˆ</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysmon</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lock(&amp;sched.lock)<span class="comment">//åŠ é”</span></span><br><span class="line">	sched.nmsys++ <span class="comment">//æ•°é‡+1</span></span><br><span class="line">	checkdead() <span class="comment">//æ£€æŸ¥æ˜¯å¦dead</span></span><br><span class="line">	unlock(&amp;sched.lock) <span class="comment">//é‡Šæ”¾lock</span></span><br><span class="line"></span><br><span class="line">	lasttrace := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line">	idle := <span class="number">0</span> <span class="comment">// how many cycles in succession we had not wokeup somebody</span></span><br><span class="line">	delay := <span class="type">uint32</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span>&#123;</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/GPM-sysmon-1.png" alt=""></p>
<h3 id="å¾ªç¯å¹²ä»€ä¹ˆï¼Ÿ"><a class="header-anchor" href="#å¾ªç¯å¹²ä»€ä¹ˆï¼Ÿ">Â¶</a>å¾ªç¯å¹²ä»€ä¹ˆï¼Ÿ</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/clipboard_20201206_085755.png" alt=""></p>
<blockquote>
<p>ä¸€ä¸ªä¸ªè¿‡å§</p>
</blockquote>
<h4 id="è·å–ç³»ç»Ÿçš„çº³ç§’æ—¶é—´"><a class="header-anchor" href="#è·å–ç³»ç»Ÿçš„çº³ç§’æ—¶é—´">Â¶</a>è·å–ç³»ç»Ÿçš„çº³ç§’æ—¶é—´</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">now := nanotime()</span><br></pre></td></tr></table></figure>
<h4 id="timeSleepUntil"><a class="header-anchor" href="#timeSleepUntil">Â¶</a>timeSleepUntil</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// timeSleepUntil returns the time when the next timer should fire,</span></span><br><span class="line"><span class="comment">// and the P that holds the timer heap that that timer is on.</span></span><br><span class="line"><span class="comment">// This is only called by sysmon and checkdead.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeSleepUntil</span><span class="params">()</span></span> (<span class="type">int64</span>, *p) &#123;</span><br><span class="line">	next := <span class="type">int64</span>(maxWhen)</span><br><span class="line">	<span class="keyword">var</span> pret *p</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Prevent allp slice changes. This is like retake.</span></span><br><span class="line">	lock(&amp;allpLock)</span><br><span class="line">	<span class="keyword">for</span> _, pp := <span class="keyword">range</span> allp &#123;</span><br><span class="line">		<span class="keyword">if</span> pp == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// This can happen if procresize has grown</span></span><br><span class="line">			<span class="comment">// allp but not yet created new Ps.</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		c := atomic.Load(&amp;pp.adjustTimers)</span><br><span class="line">		<span class="keyword">if</span> c == <span class="number">0</span> &#123;</span><br><span class="line">			w := <span class="type">int64</span>(atomic.Load64(&amp;pp.timer0When))</span><br><span class="line">			<span class="comment">//åˆ’é‡ç‚¹</span></span><br><span class="line">			<span class="keyword">if</span> w != <span class="number">0</span> &amp;&amp; w &lt; next &#123;</span><br><span class="line">				next = w</span><br><span class="line">				pret = pp</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		lock(&amp;pp.timersLock)</span><br><span class="line">		<span class="keyword">for</span> _, t := <span class="keyword">range</span> pp.timers &#123;</span><br><span class="line">			<span class="comment">//åˆ’é‡ç‚¹</span></span><br><span class="line">			<span class="keyword">switch</span> s := atomic.Load(&amp;t.status); s &#123;</span><br><span class="line">			<span class="keyword">case</span> timerWaiting:</span><br><span class="line">				<span class="keyword">if</span> t.when &lt; next &#123;</span><br><span class="line">					next = t.when</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">case</span> timerModifiedEarlier, timerModifiedLater:</span><br><span class="line">				<span class="keyword">if</span> t.nextwhen &lt; next &#123;</span><br><span class="line">					next = t.nextwhen</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> s == timerModifiedEarlier &#123;</span><br><span class="line">					c--</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// The timers are sorted, so we only have to check</span></span><br><span class="line">			<span class="comment">// the first timer for each P, unless there are</span></span><br><span class="line">			<span class="comment">// some timerModifiedEarlier timers. The number</span></span><br><span class="line">			<span class="comment">// of timerModifiedEarlier timers is in the adjustTimers</span></span><br><span class="line">			<span class="comment">// field, used to initialize c, above.</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="comment">// We don&#x27;t worry about cases like timerModifying.</span></span><br><span class="line">			<span class="comment">// New timers can show up at any time,</span></span><br><span class="line">			<span class="comment">// so this function is necessarily imprecise.</span></span><br><span class="line">			<span class="comment">// Do a signed check here since we aren&#x27;t</span></span><br><span class="line">			<span class="comment">// synchronizing the read of pp.adjustTimers</span></span><br><span class="line">			<span class="comment">// with the check of a timer status.</span></span><br><span class="line">			<span class="keyword">if</span> <span class="type">int32</span>(c) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;pp.timersLock)</span><br><span class="line">	&#125;</span><br><span class="line">	unlock(&amp;allpLock)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> next, pret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="schedå’Œgomaxprocsåˆ¤æ–­ã€Œsleep-wakeupè¿‡ç¨‹ã€"><a class="header-anchor" href="#schedå’Œgomaxprocsåˆ¤æ–­ã€Œsleep-wakeupè¿‡ç¨‹ã€">Â¶</a>schedå’Œgomaxprocsåˆ¤æ–­ã€Œsleep&amp;wakeupè¿‡ç¨‹ã€</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åŒå±‚åˆ¤æ–­ï¼Œé˜²æ­¢åœ¨åŠ é”è¿™æ®µæ—¶é—´å€¼å‘ç”Ÿå˜åŒ–</span></span><br><span class="line"><span class="keyword">if</span> debug.schedtrace &lt;= <span class="number">0</span> &amp;&amp; (sched.gcwaiting != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="type">uint32</span>(gomaxprocs)) &#123;</span><br><span class="line">			lock(&amp;sched.lock)</span><br><span class="line">			<span class="keyword">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="type">uint32</span>(gomaxprocs) &#123;</span><br><span class="line">				<span class="keyword">if</span> next &gt; now &#123;</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">1</span>)</span><br><span class="line">					unlock(&amp;sched.lock)</span><br><span class="line">					<span class="comment">// Make wake-up period small enough</span></span><br><span class="line">					<span class="comment">// for the sampling to be correct.</span></span><br><span class="line">					sleep := forcegcperiod / <span class="number">2</span></span><br><span class="line">					<span class="keyword">if</span> next-now &lt; sleep &#123;</span><br><span class="line">						sleep = next - now</span><br><span class="line">					&#125;</span><br><span class="line">					shouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">true</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					notetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">false</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					now = nanotime()</span><br><span class="line">					next, _ = timeSleepUntil()</span><br><span class="line">					lock(&amp;sched.lock)</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">0</span>)</span><br><span class="line">					noteclear(&amp;sched.sysmonnote)</span><br><span class="line">				&#125;</span><br><span class="line">				idle = <span class="number">0</span></span><br><span class="line">				delay = <span class="number">20</span></span><br><span class="line">			&#125;</span><br><span class="line">			unlock(&amp;sched.lock)</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h4 id="poll-network"><a class="header-anchor" href="#poll-network">Â¶</a>poll network</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// poll network if not polled for more than 10ms</span></span><br><span class="line">lastpoll := <span class="type">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class="line"><span class="keyword">if</span> netpollinited() &amp;&amp; lastpoll != <span class="number">0</span> &amp;&amp; lastpoll+<span class="number">10</span>*<span class="number">1000</span>*<span class="number">1000</span> &lt; now &#123;</span><br><span class="line">	atomic.Cas64(&amp;sched.lastpoll, <span class="type">uint64</span>(lastpoll), <span class="type">uint64</span>(now))</span><br><span class="line">	list := netpoll(<span class="number">0</span>) <span class="comment">// non-blocking - returns list of goroutines</span></span><br><span class="line">	<span class="keyword">if</span> !list.empty() &#123;</span><br><span class="line">		<span class="comment">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class="line">		<span class="comment">// (pretending that one more is running) before injectglist.</span></span><br><span class="line">		<span class="comment">// Otherwise it can lead to the following situation:</span></span><br><span class="line">		<span class="comment">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class="line">		<span class="comment">// another M returns from syscall, finishes running its G,</span></span><br><span class="line">		<span class="comment">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class="line">		<span class="comment">// and reports deadlock.</span></span><br><span class="line">		incidlelocked(<span class="number">-1</span>)</span><br><span class="line">		injectglist(&amp;list)</span><br><span class="line">		incidlelocked(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> next &lt; now &#123;</span><br><span class="line">	<span class="comment">// There are timers that should have already run,</span></span><br><span class="line">	<span class="comment">// perhaps because there is an unpreemptible P.</span></span><br><span class="line">	<span class="comment">// Try to start an M to run them.</span></span><br><span class="line">	<span class="comment">//åˆ’é‡ç‚¹</span></span><br><span class="line">	startm(<span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="wakeScavenger"><a class="header-anchor" href="#wakeScavenger">Â¶</a>wakeScavenger</h4>
<blockquote>
<p>åˆ¤æ–­éœ€è¦å”¤é†’è¯·æ±‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class="number">0</span> &#123;</span><br><span class="line">	<span class="comment">// Kick the scavenger awake if someone requested it.</span></span><br><span class="line">	wakeScavenger()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// wakeScavenger immediately unparks the scavenger if necessary.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// May run without a P, but it may allocate, so it must not be called</span></span><br><span class="line"><span class="comment">// on any allocation path.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// mheap_.lock, scavenge.lock, and sched.lock must not be held.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wakeScavenger</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lock(&amp;scavenge.lock)</span><br><span class="line">	<span class="keyword">if</span> scavenge.parked &#123;</span><br><span class="line">		<span class="comment">// Notify sysmon that it shouldn&#x27;t bother waking up the scavenger.</span></span><br><span class="line">		atomic.Store(&amp;scavenge.sysmonWake, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Try to stop the timer but we don&#x27;t really care if we succeed.</span></span><br><span class="line">		<span class="comment">// It&#x27;s possible that either a timer was never started, or that</span></span><br><span class="line">		<span class="comment">// we&#x27;re racing with it.</span></span><br><span class="line">		<span class="comment">// In the case that we&#x27;re racing with there&#x27;s the low chance that</span></span><br><span class="line">		<span class="comment">// we experience a spurious wake-up of the scavenger, but that&#x27;s</span></span><br><span class="line">		<span class="comment">// totally safe.</span></span><br><span class="line">		stopTimer(scavenge.timer)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Unpark the goroutine and tell it that there may have been a pacing</span></span><br><span class="line">		<span class="comment">// change. Note that we skip the scheduler&#x27;s runnext slot because we</span></span><br><span class="line">		<span class="comment">// want to avoid having the scavenger interfere with the fair</span></span><br><span class="line">		<span class="comment">// scheduling of user goroutines. In effect, this schedules the</span></span><br><span class="line">		<span class="comment">// scavenger at a &quot;lower priority&quot; but that&#x27;s OK because it&#x27;ll</span></span><br><span class="line">		<span class="comment">// catch up on the work it missed when it does get scheduled.</span></span><br><span class="line">		scavenge.parked = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ready the goroutine by injecting it. We use injectglist instead</span></span><br><span class="line">		<span class="comment">// of ready or goready in order to allow us to run this function</span></span><br><span class="line">		<span class="comment">// without a P. injectglist also avoids placing the goroutine in</span></span><br><span class="line">		<span class="comment">// the current P&#x27;s runnext slot, which is desireable to prevent</span></span><br><span class="line">		<span class="comment">// the scavenger from interfering with user goroutine scheduling</span></span><br><span class="line">		<span class="comment">// too much.</span></span><br><span class="line">		<span class="keyword">var</span> list gList</span><br><span class="line">		list.push(scavenge.g)</span><br><span class="line">		injectglist(&amp;list)</span><br><span class="line">	&#125;</span><br><span class="line">	unlock(&amp;scavenge.lock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="retakeå¤ºå–"><a class="header-anchor" href="#retakeå¤ºå–">Â¶</a>retakeå¤ºå–</h4>
<blockquote>
<p>å¤ºå–ç©ºé—²çš„P</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// retake P&#x27;s blocked in syscalls</span></span><br><span class="line"><span class="comment">// and preempt long running G&#x27;s</span></span><br><span class="line"><span class="keyword">if</span> retake(now) != <span class="number">0</span> &#123;</span><br><span class="line">	idle = <span class="number">0</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	idle++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GC-åˆ¤æ–­"><a class="header-anchor" href="#GC-åˆ¤æ–­">Â¶</a>GC åˆ¤æ–­</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// check if we need to force a GC</span></span><br><span class="line"><span class="comment">//åˆ’é‡ç‚¹ t.test()</span></span><br><span class="line"><span class="keyword">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class="number">0</span> &#123;</span><br><span class="line">	lock(&amp;forcegc.lock)</span><br><span class="line">	forcegc.idle = <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> list gList</span><br><span class="line">	list.push(forcegc.g)</span><br><span class="line">	injectglist(&amp;list)</span><br><span class="line">	unlock(&amp;forcegc.lock)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“ä¸‹å¹²äº†ä»€ä¹ˆï¼Ÿï¼Ÿ"><a class="header-anchor" href="#æ€»ç»“ä¸‹å¹²äº†ä»€ä¹ˆï¼Ÿï¼Ÿ">Â¶</a>æ€»ç»“ä¸‹å¹²äº†ä»€ä¹ˆï¼Ÿï¼Ÿ</h3>
<ul>
<li>1ã€å¼ºåˆ¶åƒåœ¾å›æ”¶ã€‚</li>
<li>2ã€å°†é•¿æ—¶é—´æœªå¤„ç†çš„netpollç»“æœæ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚</li>
<li>3ã€å¯¹é•¿æ—¶é—´è¿è¡ŒGï¼Œè¿›è¡Œretakeå¤ºPçš„è°ƒåº¦ã€‚</li>
<li>4ã€å›æ”¶syscallé•¿æ—¶é—´é˜»å¡çš„Pã€‚</li>
</ul>
<h3 id="å…³äºèµ„æ–™å‚è€ƒæ›´æ­£ï¼š"><a class="header-anchor" href="#å…³äºèµ„æ–™å‚è€ƒæ›´æ­£ï¼š">Â¶</a>å…³äºèµ„æ–™å‚è€ƒæ›´æ­£ï¼š</h3>
<h4 id="å‚è€ƒï¼š"><a class="header-anchor" href="#å‚è€ƒï¼š">Â¶</a>å‚è€ƒï¼š</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/ico/clipboard_20210510_014127.png" alt=""></p>
<p>å…³äºè¿™ä¸ªç¬¬ä¸€ç‚¹çš„è¯´æ³•æ˜¯å»ºç«‹åœ¨18å¹´Go 1.11çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜ï¼Œå¤§å®¶æŒ‰ä¸åŒçš„ç‰ˆæœ¬ï¼Œå˜åŒ–çš„æ¥çœ‹å¾…ã€‚</p>
<h5 id="Go-1-11"><a class="header-anchor" href="#Go-1-11">Â¶</a>Go 1.11</h5>
<p>é™„ä¸Šå…³äº5åˆ†é’Ÿå›æ”¶çš„é“¾æ¥<a href="https://github.com/golang/go/blob/release-branch.go1.11/src/runtime/proc.go#L4328">ğŸ‘‰ğŸ»ğŸ‘‰ğŸ»Go 1.11 proc.go</a></p>
<p>è°ƒç”¨å‡½æ•°ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/ico/clipboard_20210510_020832.png" alt=""></p>
<h5 id="Go-1-14"><a class="header-anchor" href="#Go-1-14">Â¶</a>Go 1.14</h5>
<blockquote>
<p>scavengeAllæ›¿ä»£ scavengeå‡½æ•°</p>
</blockquote>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/mheap.go#L1424">ğŸ‘‰ğŸ»scavengeALL</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/ico/clipboard_20210510_021037.png" alt=""></p>
<p>è°ƒç”¨åœ°æ–¹ <a href="https://github.com/golang/go/blob/5cf057ddedfbb149b71c85ec86050431dd6b2d9d/src/runtime/mheap.go#L1445">ğŸ‘‰ğŸ»runtime debug freeosMemory</a>ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/ico/clipboard_20210510_021423.png" alt=""></p>
<h3 id="å‚è€ƒï¼š-v2"><a class="header-anchor" href="#å‚è€ƒï¼š-v2">Â¶</a>å‚è€ƒï¼š</h3>
<p><a href="https://studygolang.com/articles/12112">Goå­¦ä¹ æ•´ç†ç¬”è®°</a></p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ24ã€GPM newmå‡½æ•°</title>
    <url>/archives/b4edbd7.html</url>
    <content><![CDATA[<p>ä¸ŠèŠ‚çœ‹äº†goçš„å…¥å£å‡½æ•°ï¼Œï¼Œï¼Œä¹Ÿå°±æ˜¯ä½ æ‰§è¡Œmainå‡½æ•°å‰åæ‰€åšçš„å‡†å¤‡å·¥ä½œã€‚</p>
<p>ç»§ç»­æ·±å…¥å­¦ä¹ ã€‚ã€Œnewmã€ç¬¬ä¸€ä¸ªMï¼Œåˆ°åº•æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ</p>
<span id="more"></span>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h3 id="å…¥å£"><a class="header-anchor" href="#å…¥å£">Â¶</a>å…¥å£</h3>
<p>å…ˆçœ‹ä¸‹ä¸»ä½“ï¼Œä¸»è¦åœ¨Måˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œå¹²äº†whatï¼Œï¼Œï¼Œï¼Œï¼Œã€ŒPS : å…³é”®çœ‹å€¼å¾—å­¦ä¹ çš„ç‚¹ã€</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class="line"><span class="comment">// fn needs to be static and not a heap allocated closure.</span></span><br><span class="line"><span class="comment">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newm</span><span class="params">(fn <span class="keyword">func</span>()</span></span>, _p_ *p) &#123;</span><br><span class="line">  <span class="comment">//åˆ†é…å†…å­˜</span></span><br><span class="line">	mp := allocm(_p_, fn)</span><br><span class="line">  <span class="comment">//è®¾ç½®p</span></span><br><span class="line">	mp.nextp.set(_p_)</span><br><span class="line">  <span class="comment">//åˆå§‹åŒ–ä¿¡å·é‡</span></span><br><span class="line">	mp.sigmask = initSigmask</span><br><span class="line">  <span class="comment">//è·å–åˆ°gpåï¼Œåˆ¤æ–­M&amp;ï¼ˆç³»ç»Ÿé”å®šï½œï½œcgoæ‰§è¡Œä¸­ï¼‰ï¼›ï¼›ï¼›plan9çš„ç³»ç»Ÿè·³è¿‡ä¸‹é¢æ“ä½œ....</span></span><br><span class="line">	<span class="keyword">if</span> gp := getg(); gp != <span class="literal">nil</span> &amp;&amp; gp.m != <span class="literal">nil</span> &amp;&amp; (gp.m.lockedExt != <span class="number">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class="string">&quot;plan9&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class="line">		<span class="comment">// started by C. The kernel state of this thread may</span></span><br><span class="line">		<span class="comment">// be strange (the user may have locked it for that</span></span><br><span class="line">		<span class="comment">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class="line">		<span class="comment">// thread. Instead, ask a known-good thread to create</span></span><br><span class="line">		<span class="comment">// the thread for us.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class="line">		<span class="comment">// doesn&#x27;t model thread creation off fork.</span></span><br><span class="line">		lock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.haveTemplateThread == <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		mp.schedlink = newmHandoff.newm</span><br><span class="line">		newmHandoff.newm.set(mp)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.waiting &#123;</span><br><span class="line">			newmHandoff.waiting = <span class="literal">false</span></span><br><span class="line">			notewakeup(&amp;newmHandoff.wake)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//new m1æŒ‡ç¬¬ä¸€ä¸ªMçš„åˆ›å»ºè¿‡ç¨‹.</span></span><br><span class="line">	newm1(mp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="newm1"><a class="header-anchor" href="#newm1">Â¶</a>newm1</h3>
<blockquote>
<p>go to ã€Œnewm1ã€</p>
</blockquote>
<p>çœ‹èµ·æ¥å¾ˆç®€çŸ­</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newm1</span><span class="params">(mp *m)</span></span> &#123;</span><br><span class="line">  <span class="comment">//cgoç¨‹åºæ‰§è¡Œä¸­?</span></span><br><span class="line">	<span class="keyword">if</span> iscgo &#123;</span><br><span class="line">		<span class="keyword">var</span> ts cgothreadstart</span><br><span class="line">		<span class="keyword">if</span> _cgo_thread_start == <span class="literal">nil</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		ts.g.set(mp.g0)</span><br><span class="line">		ts.tls = (*<span class="type">uint64</span>)(unsafe.Pointer(&amp;mp.tls[<span class="number">0</span>]))</span><br><span class="line">		ts.fn = unsafe.Pointer(funcPC(mstart))</span><br><span class="line">		<span class="keyword">if</span> msanenabled &#123;</span><br><span class="line">			msanwrite(unsafe.Pointer(&amp;ts), unsafe.Sizeof(ts))</span><br><span class="line">		&#125;</span><br><span class="line">		execLock.rlock() <span class="comment">// Prevent process clone.</span></span><br><span class="line">		asmcgocall(_cgo_thread_start, unsafe.Pointer(&amp;ts))</span><br><span class="line">		execLock.runlock()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	execLock.rlock() <span class="comment">// Prevent process clone.</span></span><br><span class="line">  <span class="comment">//æ¶‰åŠåˆ°ç³»ç»Ÿè¿›ç¨‹åˆ›å»º</span></span><br><span class="line">	newosproc(mp)</span><br><span class="line">	execLock.runlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="newosproc"><a class="header-anchor" href="#newosproc">Â¶</a>newosproc</h3>
<blockquote>
<p>Måˆ›å»ºä¹‹å‰ï¼Œç³»ç»Ÿçš„æ“ä½œå’Œç›¸å…³åœ°å€çš„å˜åŒ–</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newosproc</span><span class="params">(mp *m)</span></span> &#123;</span><br><span class="line"><span class="comment">//è¿™ä¸ªstkæ“ä½œå¾ˆå¥‡æ€ªï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸‹....[çœ‹èµ·æ¥å•¥ä¹Ÿæ²¡å¹²é‚£]</span></span><br><span class="line">	stk := unsafe.Pointer(mp.g0.stack.hi)</span><br><span class="line">	<span class="keyword">if</span> <span class="literal">false</span> &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;newosproc stk=&quot;</span>, stk, <span class="string">&quot; m=&quot;</span>, mp, <span class="string">&quot; g=&quot;</span>, mp.g0, <span class="string">&quot; id=&quot;</span>, mp.id, <span class="string">&quot; ostk=&quot;</span>, &amp;mp, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize an attribute object.</span></span><br><span class="line">	<span class="keyword">var</span> attr pthreadattr</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">int32</span></span><br><span class="line">  <span class="comment">//æ±‡ç¼–ï¼Œå˜é‡åˆå§‹åŒ–</span></span><br><span class="line">	err = pthread_attr_init(&amp;attr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="type">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find out OS stack size for our own stack guard.</span></span><br><span class="line">	<span class="keyword">var</span> stacksize <span class="type">uintptr</span></span><br><span class="line">	<span class="keyword">if</span> pthread_attr_getstacksize(&amp;attr, &amp;stacksize) != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="type">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//Må¯¹åº”çš„g0çš„é«˜ä½ç©ºé—´æ ˆåœ°å€</span></span><br><span class="line">	mp.g0.stack.hi = stacksize <span class="comment">// for mstart</span></span><br><span class="line">	<span class="comment">//mSysStatInc(&amp;memstats.stacks_sys, stacksize) //<span class="doctag">TODO:</span> do this?</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tell the pthread library we won&#x27;t join with this thread.</span></span><br><span class="line">	<span class="keyword">if</span> pthread_attr_setdetachstate(&amp;attr, _PTHREAD_CREATE_DETACHED) != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="type">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Finally, create the thread. It starts at mstart_stub, which does some low-level</span></span><br><span class="line">	<span class="comment">// setup and then calls mstart.</span></span><br><span class="line">	<span class="keyword">var</span> oset sigset</span><br><span class="line">  <span class="comment">//æ‰€æœ‰çš„maskåˆå§‹åŒ–</span></span><br><span class="line">	sigprocmask(_SIG_SETMASK, &amp;sigset_all, &amp;oset)</span><br><span class="line">	err = pthread_create(&amp;attr, funcPC(mstart_stub), unsafe.Pointer(mp))</span><br><span class="line">  <span class="comment">// osetåœ°å€ç½®nil</span></span><br><span class="line">	sigprocmask(_SIG_SETMASK, &amp;oset, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="number">0</span> &#123;</span><br><span class="line">		write(<span class="number">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class="number">0</span>]), <span class="type">int32</span>(<span class="built_in">len</span>(failthreadcreate)))</span><br><span class="line">		exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pthread-attr-initç»†èŠ‚"><a class="header-anchor" href="#pthread-attr-initç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L402">pthread_attr_initç»†èŠ‚</a></h4>
<blockquote>
<p>æ±‡ç¼–ä»£ç ï¼š</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TEXT runtimeÂ·pthread_attr_init_trampoline(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	MOVD	<span class="number">0</span>(R0), R0	<span class="comment">// arg 1 attr</span></span><br><span class="line">	BL	libc_pthread_attr_init(SB)</span><br><span class="line">	RET</span><br></pre></td></tr></table></figure>
<h4 id="pthread-attr-getstacksizeç»†èŠ‚"><a class="header-anchor" href="#pthread-attr-getstacksizeç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L407">pthread_attr_getstacksizeç»†èŠ‚</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TEXT runtimeÂ·pthread_attr_getstacksize_trampoline(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	MOVD	<span class="number">8</span>(R0), R1	<span class="comment">// arg 2 size</span></span><br><span class="line">	MOVD	<span class="number">0</span>(R0), R0	<span class="comment">// arg 1 attr</span></span><br><span class="line">	BL	libc_pthread_attr_getstacksize(SB)</span><br><span class="line">	RET</span><br></pre></td></tr></table></figure>
<h4 id="sigprocmask-trampolineç»†èŠ‚"><a class="header-anchor" href="#sigprocmask-trampolineç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L266">sigprocmask_trampolineç»†èŠ‚</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">TEXT runtimeÂ·sigprocmask_trampoline(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	MOVD	<span class="number">8</span>(R0), R1	<span class="comment">// arg 2 new</span></span><br><span class="line">	MOVD	<span class="number">16</span>(R0), R2	<span class="comment">// arg 3 old</span></span><br><span class="line">	MOVW	<span class="number">0</span>(R0), R0	<span class="comment">// arg 1 how</span></span><br><span class="line">	BL	libc_pthread_sigmask(SB)</span><br><span class="line">	CMP	$<span class="number">0</span>, R0</span><br><span class="line">	BEQ	<span class="number">2</span>(PC)</span><br><span class="line">	BL	notok&lt;&gt;(SB)</span><br><span class="line">	RET</span><br></pre></td></tr></table></figure>
<h4 id="pthread-createç»†èŠ‚"><a class="header-anchor" href="#pthread-createç»†èŠ‚">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L342">pthread_createç»†èŠ‚</a></h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mstart_stub is the first function executed on a new thread started by pthread_create.</span></span><br><span class="line"><span class="comment">// It just does some low-level setup and then calls mstart.</span></span><br><span class="line"><span class="comment">// Note: called with the C calling convention.</span></span><br><span class="line">TEXT runtimeÂ·mstart_stub(SB),NOSPLIT,$<span class="number">0</span></span><br><span class="line">	<span class="comment">// DI points to the m.</span></span><br><span class="line">	<span class="comment">// We are already on m&#x27;s g0 stack.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save callee-save registers.</span></span><br><span class="line">	SUBQ	$<span class="number">40</span>, SP</span><br><span class="line">	MOVQ	BX, <span class="number">0</span>(SP)</span><br><span class="line">	MOVQ	R12, <span class="number">8</span>(SP)</span><br><span class="line">	MOVQ	R13, <span class="number">16</span>(SP)</span><br><span class="line">	MOVQ	R14, <span class="number">24</span>(SP)</span><br><span class="line">	MOVQ	R15, <span class="number">32</span>(SP)</span><br><span class="line"></span><br><span class="line">	MOVQ	m_g0(DI), DX <span class="comment">// g</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize TLS entry.</span></span><br><span class="line">	<span class="comment">// See cmd/link/internal/ld/sym.go:computeTLSOffset.</span></span><br><span class="line">	MOVQ	DX, <span class="number">0x30</span>(GS)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Someday the convention will be D is always cleared.</span></span><br><span class="line">	CLD</span><br><span class="line"></span><br><span class="line">	CALL	runtimeÂ·mstart(SB)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Restore callee-save registers.</span></span><br><span class="line">	MOVQ	<span class="number">0</span>(SP), BX</span><br><span class="line">	MOVQ	<span class="number">8</span>(SP), R12</span><br><span class="line">	MOVQ	<span class="number">16</span>(SP), R13</span><br><span class="line">	MOVQ	<span class="number">24</span>(SP), R14</span><br><span class="line">	MOVQ	<span class="number">32</span>(SP), R15</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Go is all done with this OS thread.</span></span><br><span class="line">	<span class="comment">// Tell pthread everything is ok (we never join with this thread, so</span></span><br><span class="line">	<span class="comment">// the value here doesn&#x27;t really matter).</span></span><br><span class="line">	XORL	AX, AX</span><br><span class="line"></span><br><span class="line">	ADDQ	$<span class="number">40</span>, SP</span><br><span class="line">	RET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="execLock-rlock"><a class="header-anchor" href="#execLock-rlock">Â¶</a>execLock.rlock()</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// rlock locks rw for reading.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *rwmutex)</span></span> rlock() &#123;</span><br><span class="line">	<span class="comment">// The reader must not be allowed to lose its P or else other</span></span><br><span class="line">	<span class="comment">// things blocking on the lock may consume all of the Ps and</span></span><br><span class="line">	<span class="comment">// deadlock (issue #20903). Alternatively, we could drop the P</span></span><br><span class="line">	<span class="comment">// while sleeping.</span></span><br><span class="line">	acquirem()</span><br><span class="line">	<span class="keyword">if</span> <span class="type">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class="number">1</span>)) &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// A writer is pending. Park on the reader queue.</span></span><br><span class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			lockWithRank(&amp;rw.rLock, lockRankRwmutexR)</span><br><span class="line">			<span class="keyword">if</span> rw.readerPass &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// Writer finished.</span></span><br><span class="line">				rw.readerPass -= <span class="number">1</span></span><br><span class="line">				unlock(&amp;rw.rLock)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Queue this reader to be woken by</span></span><br><span class="line">				<span class="comment">// the writer.</span></span><br><span class="line">				m := getg().m</span><br><span class="line">				m.schedlink = rw.readers</span><br><span class="line">				rw.readers.set(m)</span><br><span class="line">				unlock(&amp;rw.rLock)</span><br><span class="line">				notesleep(&amp;m.park)</span><br><span class="line">				noteclear(&amp;m.park)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="acquirem"><a class="header-anchor" href="#acquirem">Â¶</a>acquirem()</h4>
<blockquote>
<p>åŠ é”è·å–M</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">acquirem</span><span class="params">()</span></span> *m &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line">	_g_.m.locks++</span><br><span class="line">	<span class="keyword">return</span> _g_.m</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="notesleep"><a class="header-anchor" href="#notesleep">Â¶</a>notesleep()</h4>
<blockquote>
<p>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯sleepæ˜¯ç”¨é˜Ÿåˆ—å®ç°,å‰ååŠ é”</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">notesleep</span><span class="params">(n *note)</span></span> &#123;</span><br><span class="line">	gp := getg()</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// Queued. Sleep.</span></span><br><span class="line">	gp.m.blocked = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">if</span> *cgo_yield == <span class="literal">nil</span> &#123;</span><br><span class="line">		semasleep(<span class="number">-1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.</span></span><br><span class="line">		<span class="keyword">const</span> ns = <span class="number">10e6</span></span><br><span class="line">		<span class="keyword">for</span> atomic.Loaduintptr(&amp;n.key) == <span class="number">0</span> &#123;</span><br><span class="line">			semasleep(ns)</span><br><span class="line">			asmcgocall(*cgo_yield, <span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	gp.m.blocked = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="execLock-runlock"><a class="header-anchor" href="#execLock-runlock">Â¶</a>execLock.runlock()</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// runlock undoes a single rlock call on rw.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *rwmutex)</span></span> runlock() &#123;</span><br><span class="line">	<span class="keyword">if</span> r := <span class="type">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class="number">-1</span>)); r &lt; <span class="number">0</span> &#123;</span><br><span class="line">		....</span><br><span class="line">	&#125;</span><br><span class="line">	releasem(getg().m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="releasem"><a class="header-anchor" href="#releasem">Â¶</a>releasem</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="comment">//lockæ•°é‡â–1ï¼Œæ¢å¤åˆ°preemptçš„çŠ¶æ€.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">releasem</span><span class="params">(mp *m)</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line">	mp.locks--</span><br><span class="line">	<span class="keyword">if</span> mp.locks == <span class="number">0</span> &amp;&amp; _g_.preempt &#123;</span><br><span class="line">		<span class="comment">// restore the preemption request in case we&#x27;ve cleared it in newstack</span></span><br><span class="line">		_g_.stackguard0 = stackPreempt</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆåˆ†æåˆ°è¿™å„¿å§â€¦å…³äºè¿™ä¸€èŠ‚çš„æµç¨‹å›¾ï¼Œä¼šæ•´ç†å‡ºæ¥çš„ï¼Œï¼Œï¼Œï¼Œ</p>
<p>ä¸ç„¶å°±ç™½åˆ†æè¿™ä¹ˆå¤šäº†ï¼ŒåŠæ—¶å­¦ä¹ ï¼ŒåŠæ—¶æ€»ç»“ã€‚</p>
<p>æ™šå®‰ğŸ˜´â€¦</p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ23ã€GPM mainå…¥å£å‡½æ•°</title>
    <url>/archives/9bb71eca.html</url>
    <content><![CDATA[<p>å‰é¢g0å’Œm0çæ‰¯äº†éƒ¨åˆ†çš„å…¥å£å’Œä¸€äº›å…³é”®çš„ç‚¹ã€‚</p>
<p>æœ¬æ¥åº”è¯¥æ‰¯æ‰¯sheduleè°ƒåº¦æ–¹é¢çš„çŸ¥è¯†ï¼Œä½†æ˜¯è¿™ä¸ªå…ˆå¾€åæ”¾ä¸€èŠ‚å§ï¼Œ</p>
<p>å…ˆå­¦ä¹ ä¸‹è¿™ä¸ªã€Œå…¥å£å‡½æ•°ã€ï¼Œæ¯•ç«Ÿå¯¹äºæ¯ä¸€ä¸ªé¡¹ç›®éƒ½ä¼šæœ‰ä¸€ä¸ªå…¥å£çš„ç›¸å…³é€»è¾‘ï¼Œé‚£ä¹ˆgoæºç æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</p>
<p>æœ‰æ²¡æœ‰ä»€ä¹ˆå¯ä»¥å€Ÿé‰´çš„å˜ï¼Ÿï¼</p>
<span id="more"></span>
<p>æ¥ä¸‹æ¥è¯¥åˆ°mainå‡½æ•°çš„ç›¸å…³å¤„ç†ã€‚</p>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h3 id="codeåˆ†æ"><a class="header-anchor" href="#codeåˆ†æ">Â¶</a>codeåˆ†æ</h3>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L113">mainå‡½æ•°å…¥å£</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// The main goroutine.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	g := getg()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.</span></span><br><span class="line">	<span class="comment">// It must not be used for anything else.</span></span><br><span class="line">	g.m.g0.racectx = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.</span></span><br><span class="line">	<span class="comment">// Using decimal instead of binary GB and MB because</span></span><br><span class="line">    <span class="comment">// they look nicer in the stack overflow failure message.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æœ€å¤§æ ˆç©ºé—´é™åˆ¶</span></span><br><span class="line">	<span class="keyword">if</span> sys.PtrSize == <span class="number">8</span> &#123;</span><br><span class="line">		maxstacksize = <span class="number">1000000000</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		maxstacksize = <span class="number">250000000</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow newproc to start new Ms.</span></span><br><span class="line">	mainStarted = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯wasmï¼Œå°±ä¸è¦è°ƒåº¦ç¨‹åºäº†.</span></span><br><span class="line">    <span class="keyword">if</span> GOARCH != <span class="string">&quot;wasm&quot;</span> &#123; <span class="comment">// no threads on wasm yet, so no sysmon</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//ç³»ç»Ÿæ ˆè°ƒç”¨</span></span><br><span class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="comment">// newmçš„å›è°ƒå‡½æ•°ï¼Œï¼Œï¼Œä¸€ä¸ªMä¸€ä¸ªsysmon P</span></span><br><span class="line">			newm(sysmon, <span class="literal">nil</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Lock the main goroutine onto this, the main OS thread,</span></span><br><span class="line">	<span class="comment">// during initialization. Most programs won&#x27;t care, but a few</span></span><br><span class="line">	<span class="comment">// do require certain calls to be made by the main thread.</span></span><br><span class="line">	<span class="comment">// Those can arrange for main.main to run in the main thread</span></span><br><span class="line">	<span class="comment">// by calling runtime.LockOSThread during initialization</span></span><br><span class="line">	<span class="comment">// to preserve the lock.</span></span><br><span class="line">	lockOSThread()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> g.m != &amp;m0 &#123;</span><br><span class="line">		throw(<span class="string">&quot;runtime.main not on m0&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	doInit(&amp;runtime_inittask) <span class="comment">// must be before defer</span></span><br><span class="line">	<span class="keyword">if</span> nanotime() == <span class="number">0</span> &#123;</span><br><span class="line">		throw(<span class="string">&quot;nanotime returning zero&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Defer unlock so that runtime.Goexit during init does the unlock too.</span></span><br><span class="line">	needUnlock := <span class="literal">true</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> needUnlock &#123;</span><br><span class="line">			unlockOSThread()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Record when the world started.</span></span><br><span class="line">	runtimeInitTime = nanotime()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨GC</span></span><br><span class="line">	gcenable()</span><br><span class="line"></span><br><span class="line">	main_init_done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line">	<span class="keyword">if</span> iscgo &#123;</span><br><span class="line">		<span class="keyword">if</span> _cgo_thread_start == <span class="literal">nil</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> GOOS != <span class="string">&quot;windows&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> _cgo_setenv == <span class="literal">nil</span> &#123;</span><br><span class="line">				throw(<span class="string">&quot;_cgo_setenv missing&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> _cgo_unsetenv == <span class="literal">nil</span> &#123;</span><br><span class="line">				throw(<span class="string">&quot;_cgo_unsetenv missing&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> _cgo_notify_runtime_init_done == <span class="literal">nil</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;_cgo_notify_runtime_init_done missing&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Start the template thread in case we enter Go from</span></span><br><span class="line">		<span class="comment">// a C-created thread and need to create a new thread.</span></span><br><span class="line">		startTemplateThread()</span><br><span class="line">		cgocall(_cgo_notify_runtime_init_done, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	doInit(&amp;main_inittask)</span><br><span class="line"></span><br><span class="line">	<span class="built_in">close</span>(main_init_done)</span><br><span class="line"></span><br><span class="line">	needUnlock = <span class="literal">false</span></span><br><span class="line">	unlockOSThread()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isarchive || islibrary &#123;</span><br><span class="line">		<span class="comment">// A program compiled with -buildmode=c-archive or c-shared</span></span><br><span class="line">		<span class="comment">// has a main, but it is not executed.</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¯¹äºmainå‡½æ•°çš„å›è°ƒï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·å†™çš„mainç¨‹åº</span></span><br><span class="line">	fn := main_main <span class="comment">// make an indirect call, as the linker doesn&#x27;t know the address of the main package when laying down the runtime</span></span><br><span class="line">	fn()</span><br><span class="line">	<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">		racefini()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make racy client program work: if panicking on</span></span><br><span class="line">	<span class="comment">// another goroutine at the same time as main returns,</span></span><br><span class="line">	<span class="comment">// let the other goroutine finish printing the panic trace.</span></span><br><span class="line">    <span class="comment">// Once it does, it will exit. See issues 3934 and 20018.</span></span><br><span class="line">    <span class="comment">//åˆ¤æ–­panicDeferå‡½æ•°ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œ</span></span><br><span class="line">	<span class="keyword">if</span> atomic.Load(&amp;runningPanicDefers) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Running deferred functions should not take long.</span></span><br><span class="line">		<span class="keyword">for</span> c := <span class="number">0</span>; c &lt; <span class="number">1000</span>; c++ &#123;</span><br><span class="line">			<span class="keyword">if</span> atomic.Load(&amp;runningPanicDefers) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			Gosched()</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­panic</span></span><br><span class="line">	<span class="keyword">if</span> atomic.Load(&amp;panicking) != <span class="number">0</span> &#123;</span><br><span class="line">		gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonPanicWait, traceEvGoStop, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//æ­£å¸¸é€€å‡ºäº†é‚£.....</span></span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> x *<span class="type">int32</span></span><br><span class="line">		*x = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="systemstack"><a class="header-anchor" href="#systemstack">Â¶</a>systemstack</h3>
<blockquote>
<p>è¿™ä¸ªå‡½æ•°ï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿä¸­è¾ƒä¸ºé‡è¦ï¼Œæ¥çœ‹çœ‹å®˜æ–¹è¯´æ˜</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// systemstack runs fn on a system stack.</span></span><br><span class="line"><span class="comment">// If systemstack is called from the per-OS-thread (g0) stack, or</span></span><br><span class="line"><span class="comment">// if systemstack is called from the signal handling (gsignal) stack,</span></span><br><span class="line"><span class="comment">// systemstack calls fn directly and returns.</span></span><br><span class="line"><span class="comment">//g0 stackæˆ–è€…ä¿¡å·å¤„ç†çš„ï¼Œå°±ç›´æ¥è°ƒç”¨å¹¶è¿”å›ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Otherwise, systemstack is being called from the limited stack</span></span><br><span class="line"><span class="comment">// of an ordinary goroutine. In this case, systemstack switches</span></span><br><span class="line"><span class="comment">// to the per-OS-thread stack, calls fn, and switches back.</span></span><br><span class="line"><span class="comment">// It is common to use a func literal as the argument, in order</span></span><br><span class="line"><span class="comment">// to share inputs and outputs with the code around the call</span></span><br><span class="line"><span class="comment">// to system stack:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	... set up y ...</span></span><br><span class="line"><span class="comment">//	systemstack(func() &#123;</span></span><br><span class="line"><span class="comment">//		x = bigcall(y)</span></span><br><span class="line"><span class="comment">//	&#125;)</span></span><br><span class="line"><span class="comment">//	... use x ...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:noescape</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">systemstack</span><span class="params">(fn <span class="keyword">func</span>()</span></span>)</span><br></pre></td></tr></table></figure>
<h3 id="newm"><a class="header-anchor" href="#newm">Â¶</a>newm</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class="line"><span class="comment">// fn needs to be static and not a heap allocated closure.</span></span><br><span class="line"><span class="comment">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨äºåˆ›å»ºæ–°çš„Mï¼Œfn:sysmonå‡½æ•°ï¼Œç±»ä¼¼äºäº‹ä»¶é©±åŠ¨ç±»å‹çš„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newm</span><span class="params">(fn <span class="keyword">func</span>()</span></span>, _p_ *p) &#123;</span><br><span class="line">	<span class="comment">//åˆ†é…å†…å­˜</span></span><br><span class="line">	mp := allocm(_p_, fn)</span><br><span class="line">	mp.nextp.set(_p_)</span><br><span class="line">	mp.sigmask = initSigmask</span><br><span class="line">	<span class="keyword">if</span> gp := getg(); gp != <span class="literal">nil</span> &amp;&amp; gp.m != <span class="literal">nil</span> &amp;&amp; (gp.m.lockedExt != <span class="number">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class="string">&quot;plan9&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class="line">		<span class="comment">// started by C. The kernel state of this thread may</span></span><br><span class="line">		<span class="comment">// be strange (the user may have locked it for that</span></span><br><span class="line">		<span class="comment">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class="line">		<span class="comment">// thread. Instead, ask a known-good thread to create</span></span><br><span class="line">		<span class="comment">// the thread for us.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class="line">		<span class="comment">// doesn&#x27;t model thread creation off fork.</span></span><br><span class="line">		lock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.haveTemplateThread == <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		mp.schedlink = newmHandoff.newm</span><br><span class="line">		newmHandoff.newm.set(mp)</span><br><span class="line">		<span class="keyword">if</span> newmHandoff.waiting &#123;</span><br><span class="line">			newmHandoff.waiting = <span class="literal">false</span></span><br><span class="line">			notewakeup(&amp;newmHandoff.wake)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;newmHandoff.lock)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	newm1(mp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªå‡½æ•°ï¼š</p>
</blockquote>
<ul>
<li>allocm</li>
<li>notewakeup</li>
<li>newm1</li>
</ul>
<h3 id="sysmon"><a class="header-anchor" href="#sysmon">Â¶</a>sysmon</h3>
<p>å­¦ä¹ ç³»ç»Ÿç›‘æ§ä¹‹å‰ï¼Œå…ˆå­¦ä¸‹éƒ¨åˆ†å‡½æ•°çš„ä½¿ç”¨å’Œå…¶å¤§æ¦‚å«ä¹‰ï¼š</p>
<ul>
<li>checkdead</li>
<li>usleep</li>
<li>timeSleepUntil</li>
<li>nanotime</li>
<li>netpollinited</li>
<li>startm</li>
<li>retake</li>
<li>gcTrigger</li>
<li>injectglist</li>
</ul>
<blockquote>
<p>å…ˆçœ‹ä¸‹ä¸»ä½“æµç¨‹</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Always runs without a P, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysmon</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lock(&amp;sched.lock)</span><br><span class="line">	sched.nmsys++</span><br><span class="line">	<span class="comment">//åŸºäºrunningä¸­çš„Mï¼Œæ£€æŸ¥æ­»é”ï¼Œï¼Œï¼Œï¼Œ</span></span><br><span class="line">	checkdead()</span><br><span class="line">	unlock(&amp;sched.lock)</span><br><span class="line"></span><br><span class="line">	lasttrace := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line">	idle := <span class="number">0</span> <span class="comment">// how many cycles in succession we had not wokeup somebody</span></span><br><span class="line">	delay := <span class="type">uint32</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> idle == <span class="number">0</span> &#123; <span class="comment">// start with 20us sleep...</span></span><br><span class="line">			delay = <span class="number">20</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> idle &gt; <span class="number">50</span> &#123; <span class="comment">// start doubling the sleep after 1ms...</span></span><br><span class="line">			delay *= <span class="number">2</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> delay &gt; <span class="number">10</span>*<span class="number">1000</span> &#123; <span class="comment">// up to 10ms</span></span><br><span class="line">			delay = <span class="number">10</span> * <span class="number">1000</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//ä¼‘çœ æ—¶é—´</span></span><br><span class="line">		usleep(delay)</span><br><span class="line">		<span class="comment">//è·å–æ—¶é—´</span></span><br><span class="line">		now := nanotime()</span><br><span class="line">		<span class="comment">// ä¼‘çœ ç­‰å¾…å”¤é†’ä¿¡å·</span></span><br><span class="line">		next, _ := timeSleepUntil()</span><br><span class="line">		<span class="keyword">if</span> debug.schedtrace &lt;= <span class="number">0</span> &amp;&amp; (sched.gcwaiting != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="type">uint32</span>(gomaxprocs)) &#123;</span><br><span class="line">			lock(&amp;sched.lock)</span><br><span class="line">			<span class="keyword">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class="number">0</span> || atomic.Load(&amp;sched.npidle) == <span class="type">uint32</span>(gomaxprocs) &#123;</span><br><span class="line">				<span class="keyword">if</span> next &gt; now &#123;</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">1</span>)</span><br><span class="line">					unlock(&amp;sched.lock)</span><br><span class="line">					<span class="comment">// Make wake-up period small enough</span></span><br><span class="line">					<span class="comment">// for the sampling to be correct.</span></span><br><span class="line">					sleep := forcegcperiod / <span class="number">2</span></span><br><span class="line">					<span class="keyword">if</span> next-now &lt; sleep &#123;</span><br><span class="line">						sleep = next - now</span><br><span class="line">					&#125;</span><br><span class="line">					shouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">true</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					notetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class="line">					<span class="keyword">if</span> shouldRelax &#123;</span><br><span class="line">						osRelax(<span class="literal">false</span>)</span><br><span class="line">					&#125;</span><br><span class="line">					now = nanotime()</span><br><span class="line">					next, _ = timeSleepUntil()</span><br><span class="line">					lock(&amp;sched.lock)</span><br><span class="line">					atomic.Store(&amp;sched.sysmonwait, <span class="number">0</span>)</span><br><span class="line">					noteclear(&amp;sched.sysmonnote)</span><br><span class="line">				&#125;</span><br><span class="line">				idle = <span class="number">0</span></span><br><span class="line">				delay = <span class="number">20</span></span><br><span class="line">			&#125;</span><br><span class="line">			unlock(&amp;sched.lock)</span><br><span class="line">		&#125;</span><br><span class="line">		lock(&amp;sched.sysmonlock)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If we spent a long time blocked on sysmonlock</span></span><br><span class="line">			<span class="comment">// then we want to update now and next since it&#x27;s</span></span><br><span class="line">			<span class="comment">// likely stale.</span></span><br><span class="line">			now1 := nanotime()</span><br><span class="line">			<span class="keyword">if</span> now1-now &gt; <span class="number">50</span>*<span class="number">1000</span> <span class="comment">/* 50Âµs */</span> &#123;</span><br><span class="line">				next, _ = timeSleepUntil()</span><br><span class="line">			&#125;</span><br><span class="line">			now = now1</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// trigger libc interceptors if needed</span></span><br><span class="line">		<span class="keyword">if</span> *cgo_yield != <span class="literal">nil</span> &#123;</span><br><span class="line">			asmcgocall(*cgo_yield, <span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// poll network if not polled for more than 10ms</span></span><br><span class="line">		<span class="comment">//åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦è¶…è¿‡10msï¼Œå°±ç»™äº¤ç»™globalæŠ¢æ¸¡äº†</span></span><br><span class="line">		lastpoll := <span class="type">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class="line">		<span class="keyword">if</span> netpollinited() &amp;&amp; lastpoll != <span class="number">0</span> &amp;&amp; lastpoll+<span class="number">10</span>*<span class="number">1000</span>*<span class="number">1000</span> &lt; now &#123;</span><br><span class="line">			atomic.Cas64(&amp;sched.lastpoll, <span class="type">uint64</span>(lastpoll), <span class="type">uint64</span>(now))</span><br><span class="line">			list := netpoll(<span class="number">0</span>) <span class="comment">// non-blocking - returns list of goroutines</span></span><br><span class="line">			<span class="keyword">if</span> !list.empty() &#123;</span><br><span class="line">				<span class="comment">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class="line">				<span class="comment">// (pretending that one more is running) before injectglist.</span></span><br><span class="line">				<span class="comment">// Otherwise it can lead to the following situation:</span></span><br><span class="line">				<span class="comment">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class="line">				<span class="comment">// another M returns from syscall, finishes running its G,</span></span><br><span class="line">				<span class="comment">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class="line">				<span class="comment">// and reports deadlock.</span></span><br><span class="line">				incidlelocked(<span class="number">-1</span>)</span><br><span class="line">				<span class="comment">//æ³¨å…¥å…¨å±€gé˜Ÿåˆ—ä¸­</span></span><br><span class="line">				injectglist(&amp;list)</span><br><span class="line">				incidlelocked(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> next &lt; now &#123;</span><br><span class="line">			<span class="comment">// There are timers that should have already run,</span></span><br><span class="line">			<span class="comment">// perhaps because there is an unpreemptible P.</span></span><br><span class="line">			<span class="comment">// Try to start an M to run them.</span></span><br><span class="line">			<span class="comment">//éœ€è¦ä¸€ä¸ªæ–°çš„Mæ¥è·‘Pä¸Šé¢çš„Gã€‚</span></span><br><span class="line">			startm(<span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">// Kick the scavenger awake if someone requested it.</span></span><br><span class="line">			wakeScavenger()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// retake P&#x27;s blocked in syscalls</span></span><br><span class="line">		<span class="comment">// and preempt long running G&#x27;s</span></span><br><span class="line">		<span class="comment">// å¾ªç¯æ‰€æœ‰çš„allpï¼Œè¿›è¡ŒæŠ¢å¤ºã€‚</span></span><br><span class="line">		<span class="keyword">if</span> retake(now) != <span class="number">0</span> &#123;</span><br><span class="line">			idle = <span class="number">0</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			idle++</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// check if we need to force a GC</span></span><br><span class="line">		<span class="comment">//å¼ºè¡ŒGC</span></span><br><span class="line">		<span class="keyword">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class="number">0</span> &#123;</span><br><span class="line">			lock(&amp;forcegc.lock)</span><br><span class="line">			forcegc.idle = <span class="number">0</span></span><br><span class="line">			<span class="keyword">var</span> list gList</span><br><span class="line">			list.push(forcegc.g)</span><br><span class="line">			injectglist(&amp;list)</span><br><span class="line">			unlock(&amp;forcegc.lock)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> debug.schedtrace &gt; <span class="number">0</span> &amp;&amp; lasttrace+<span class="type">int64</span>(debug.schedtrace)*<span class="number">1000000</span> &lt;= now &#123;</span><br><span class="line">			lasttrace = now</span><br><span class="line">			schedtrace(debug.scheddetail &gt; <span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;sched.sysmonlock)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="doInit"><a class="header-anchor" href="#doInit">Â¶</a>doInit</h3>
<blockquote>
<p>è¿™ä¸€éƒ¨åˆ†åœ¨æºç çœ‹æ¥ï¼Œæ²¡æœ‰å…·ä½“çš„ä½œç”¨ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œtodoæ ‡ç­¾å§ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doInit</span><span class="params">(t *initTask)</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> t.state &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// fully initialized</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// initialization in progress</span></span><br><span class="line">		throw(<span class="string">&quot;recursive call during initialization - linker skew&quot;</span>)</span><br><span class="line">	<span class="keyword">default</span>: <span class="comment">// not initialized yet</span></span><br><span class="line">		t.state = <span class="number">1</span> <span class="comment">// initialization in progress</span></span><br><span class="line">		<span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; t.ndeps; i++ &#123;</span><br><span class="line">			p := add(unsafe.Pointer(t), (<span class="number">3</span>+i)*sys.PtrSize)</span><br><span class="line">			t2 := *(**initTask)(p)</span><br><span class="line">			doInit(t2)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; t.nfns; i++ &#123;</span><br><span class="line">			p := add(unsafe.Pointer(t), (<span class="number">3</span>+t.ndeps+i)*sys.PtrSize)</span><br><span class="line">			f := *(*<span class="function"><span class="keyword">func</span><span class="params">()</span></span>)(unsafe.Pointer(&amp;p))</span><br><span class="line">			f()</span><br><span class="line">		&#125;</span><br><span class="line">		t.state = <span class="number">2</span> <span class="comment">// initialization done</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gcenable"><a class="header-anchor" href="#gcenable">Â¶</a>gcenable</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gcenable is called after the bulk of the runtime initialization,</span></span><br><span class="line"><span class="comment">// just before we&#x27;re about to start letting user code run.</span></span><br><span class="line"><span class="comment">// It kicks off the background sweeper goroutine, the background</span></span><br><span class="line"><span class="comment">// scavenger goroutine, and enables GC.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gcenable</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Kick off sweeping and scavenging.</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> bgsweep(c)</span><br><span class="line">	<span class="keyword">go</span> bgscavenge(c)</span><br><span class="line">	&lt;-c</span><br><span class="line">	&lt;-c</span><br><span class="line">	memstats.enablegc = <span class="literal">true</span> <span class="comment">// now that runtime is initialized, GC is okay</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Gosched"><a class="header-anchor" href="#Gosched">Â¶</a>Gosched</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Gosched yields the processor, allowing other goroutines to run. It does not</span></span><br><span class="line"><span class="comment">// suspend the current goroutine, so execution resumes automatically.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Gosched</span><span class="params">()</span></span> &#123;</span><br><span class="line">	checkTimeouts()</span><br><span class="line">	mcall(gosched_m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gopark"><a class="header-anchor" href="#gopark">Â¶</a>gopark</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Puts the current goroutine into a waiting state and calls unlockf.</span></span><br><span class="line"><span class="comment">// If unlockf returns false, the goroutine is resumed.</span></span><br><span class="line"><span class="comment">// unlockf must not access this G&#x27;s stack, as it may be moved between</span></span><br><span class="line"><span class="comment">// the call to gopark and the call to unlockf.</span></span><br><span class="line"><span class="comment">// Reason explains why the goroutine has been parked.</span></span><br><span class="line"><span class="comment">// It is displayed in stack traces and heap dumps.</span></span><br><span class="line"><span class="comment">// Reasons should be unique and descriptive.</span></span><br><span class="line"><span class="comment">// Do not re-use reasons, add new ones.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gopark</span><span class="params">(unlockf <span class="keyword">func</span>(*g, unsafe.Pointer)</span></span> <span class="type">bool</span>, lock unsafe.Pointer, reason waitReason, traceEv <span class="type">byte</span>, traceskip <span class="type">int</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> reason != waitReasonSleep &#123;</span><br><span class="line">		checkTimeouts() <span class="comment">// timeouts may expire while two goroutines keep the scheduler busy</span></span><br><span class="line">	&#125;</span><br><span class="line">	mp := acquirem()</span><br><span class="line">	gp := mp.curg</span><br><span class="line">	status := readgstatus(gp)</span><br><span class="line">	<span class="keyword">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;</span><br><span class="line">		throw(<span class="string">&quot;gopark: bad g status&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	mp.waitlock = lock</span><br><span class="line">	mp.waitunlockf = unlockf</span><br><span class="line">	gp.waitreason = reason</span><br><span class="line">	mp.waittraceev = traceEv</span><br><span class="line">	mp.waittraceskip = traceskip</span><br><span class="line">	<span class="comment">//mpè§£ç»‘</span></span><br><span class="line">	releasem(mp)</span><br><span class="line">	<span class="comment">// can&#x27;t do anything that might move the G between Ms here.</span></span><br><span class="line">	mcall(park_m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åç»­"><a class="header-anchor" href="#åç»­">Â¶</a>åç»­</h3>
<blockquote>
<p>å…³äºé‡Œé¢çš„é‡è¦éƒ¨åˆ†å®ç°ç»†èŠ‚ï¼Œä¸æ˜¯æœ¬æ¬¡å…³æ³¨çš„é‡ç‚¹ï¼Œï¼Œï¼Œï¼Œ</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">è¿™æ¬¡ä¸»è¦çœ‹åˆ°çš„æ˜¯Goå›´ç»•mainå‡½æ•°ï¼Œä¸ºäº†ç¨‹åºçš„æ­£å¸¸å¯åŠ¨ï¼Œæ‰€åšçš„å·¥ä½œ.</span><br><span class="line"></span><br><span class="line">æ— è®ºæ˜¯gçš„å¯åŠ¨è¿˜æ˜¯è°ƒåº¦ç›‘æ§æ–¹é¢ï¼Œä¹Ÿå°±æ˜¯ä»æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥è€ƒè™‘ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯å…³äºpanicçš„å¤„ç†ï¼Œé‡‡ç”¨äº‹ä»¶é©±åŠ¨çš„æ–¹å¼ï¼Œå¾ˆå¥½çš„è·å–åˆ°panic,è¿›è¡Œåç»­çš„å¤„ç†ã€‚</span><br><span class="line"></span><br><span class="line">æœ€åè¿˜æœ‰ä¸€ä¸ªå…³äºå…¨å±€locktrheadï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œç²’åº¦å°½é‡ç»†å°ï¼Œæœ‰åˆ©äºæé«˜æ€§èƒ½ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ22ã€GPM g0å’Œm0</title>
    <url>/archives/392d66f0.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>GPMç®—æ˜¯ç»å…¸çš„è°ƒåº¦æ¨¡å‹ï¼Œä½†æ˜¯æ¯ä¸ªç¨‹åºéƒ½éœ€è¦ä¸€ä¸ªå¯åŠ¨çš„å‡½æ•°æˆ–è€…å…¥å£ï¼›<br>
GPMä¹Ÿä¸ä¾‹å¤–ã€‚<br>
ç›´æ¥åˆ†ææºç ï¼Œæ˜¾å¾—å¾ˆæ¯ç‡¥ï¼Œå¦‚æœè¯´è¦ä½ è®¾è®¡GPMä¸­çš„Gå’ŒMçš„æ‰§è¡Œå…³ç³»ï¼Œä½ åº”è¯¥æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿ</p>
<span id="more"></span>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h3 id="å°è¯•è®¾è®¡"><a class="header-anchor" href="#å°è¯•è®¾è®¡">Â¶</a>å°è¯•è®¾è®¡</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/GPM202011182201.png" alt=""><br>
å¦‚æœåªæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£æ€»ä½“çš„Gå’ŒMæ˜¯å¦éœ€è¦ç®¡ç†è€…ï¼Œæ¯•ç«Ÿåœ¨1.1ç‰ˆæœ¬ä¹‹å‰åªæœ‰GMæ¨¡å‹ï¼Œï¼Œï¼Œ<br>
é‚£ä¹ˆä¸ºäº†å¥½ç®¡ç†Må’ŒGï¼Œå°±éœ€è¦ç¬¬ä¸€ä¸ªMå’ŒGæˆä¸ºç®¡ç†è€…ï¼Œç±»ä¼¼äºå¤§æ€»ç®¡è¿™æ ·çš„å­˜åœ¨ã€‚</p>
<h3 id="å†æ¬¡è®¾è®¡"><a class="header-anchor" href="#å†æ¬¡è®¾è®¡">Â¶</a>å†æ¬¡è®¾è®¡</h3>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/GPM202011182219.png" alt=""></p>
<h3 id="å…³é”®ç‚¹ï¼š"><a class="header-anchor" href="#å…³é”®ç‚¹ï¼š">Â¶</a>å…³é”®ç‚¹ï¼š</h3>
<ul>
<li>på…ˆå¯åŠ¨</li>
<li>g0çš„åˆ›å»ºï¼›ç”¨äºåˆ›å»ºæ–°çš„G</li>
<li>m0çš„åˆ›å»ºï¼›ç”¨äºåˆ›å»ºæ–°çš„M</li>
<li>å¯åŠ¨mainè°ƒåº¦æ•´ä¸ªç³»ç»Ÿ</li>
</ul>
<blockquote>
<p>ä¸Šè¿°è¿™æ ·æ¯”è¾ƒåˆç†ç‚¹ã€‚</p>
</blockquote>
<h3 id="Goæºç çš„å¦‚ä½•å®ç°ï¼Ÿ"><a class="header-anchor" href="#Goæºç çš„å¦‚ä½•å®ç°ï¼Ÿ">Â¶</a>Goæºç çš„å¦‚ä½•å®ç°ï¼Ÿ</h3>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L524">bootstrap sequence</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The bootstrap sequence is:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	call osinit</span></span><br><span class="line"><span class="comment">//	call schedinit</span></span><br><span class="line"><span class="comment">//	make &amp; queue new G</span></span><br><span class="line"><span class="comment">//	call runtimeÂ·mstart</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The new G calls runtimeÂ·main.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L194">g0å’Œm0åˆå§‹åŒ–è¿‡ç¨‹</a></p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="comment">// set the per-goroutine and per-mach &quot;registers&quot;</span></span><br><span class="line">	get_tls(BX)</span><br><span class="line">	LEAQ	runtimeÂ·g0(SB), CX</span><br><span class="line">	MOVQ	CX, g(BX)</span><br><span class="line">	LEAQ	runtimeÂ·m0(SB), AX</span><br><span class="line"></span><br><span class="line">	<span class="comment">// save m-&gt;g0 = g0</span></span><br><span class="line">	MOVQ	CX, m_g0(AX)</span><br><span class="line">	<span class="comment">// save m0 to g0-&gt;m</span></span><br><span class="line">	MOVQ	AX, g_m(CX)</span><br><span class="line"></span><br><span class="line">	CLD				<span class="comment">// convention is D is always left cleared</span></span><br><span class="line">	CALL	runtimeÂ·check(SB)</span><br><span class="line"></span><br><span class="line">	MOVL	<span class="number">16</span>(SP), AX		<span class="comment">// copy argc</span></span><br><span class="line">	MOVL	AX, <span class="number">0</span>(SP)</span><br><span class="line">	MOVQ	<span class="number">24</span>(SP), AX		<span class="comment">// copy argv</span></span><br><span class="line">	MOVQ	AX, <span class="number">8</span>(SP)</span><br><span class="line">	CALL	runtimeÂ·args(SB)</span><br><span class="line">	CALL	runtimeÂ·osinit(SB)</span><br><span class="line">	CALL	runtimeÂ·schedinit(SB)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create a new goroutine to start program</span></span><br><span class="line">	MOVQ	$runtimeÂ·mainPC(SB), AX		<span class="comment">// entry</span></span><br><span class="line">	PUSHQ	AX</span><br><span class="line">	PUSHQ	$<span class="number">0</span>			<span class="comment">// arg size</span></span><br><span class="line">	CALL	runtimeÂ·newproc(SB)</span><br><span class="line">	POPQ	AX</span><br><span class="line">	POPQ	AX</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start this M</span></span><br><span class="line">	CALL	runtimeÂ·mstart(SB)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åˆ°è¿™é‡Œäº†ï¼Œåˆå§‹åŒ–æ€è·¯åŸºæœ¬ç¡®å®šäº†</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€initP</span><br><span class="line">2ã€m0å’Œg0çš„ç»‘å®š</span><br><span class="line">3ã€new groutine for mainä¸»çº¿ç¨‹å¯åŠ¨</span><br><span class="line">4ã€mstart</span><br></pre></td></tr></table></figure>
<h3 id="m-initæ¶‰åŠåˆ°çš„å‡½æ•°"><a class="header-anchor" href="#m-initæ¶‰åŠåˆ°çš„å‡½æ•°">Â¶</a>m initæ¶‰åŠåˆ°çš„å‡½æ•°</h3>
<ul>
<li>mstart</li>
<li>mstart1</li>
<li>mstartm0</li>
</ul>
<h4 id="mstart"><a class="header-anchor" href="#mstart">Â¶</a>mstart</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mstart is the entry-point for new Ms.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This must not split the stack because we may not even have stack</span></span><br><span class="line"><span class="comment">// bounds set up yet.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// May run during STW (because it doesn&#x27;t have a P yet), so write</span></span><br><span class="line"><span class="comment">// barriers are not allowed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mstart</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä½ä½åˆ¤æ–­</span></span><br><span class="line">	osStack := _g_.stack.lo == <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> osStack &#123;</span><br><span class="line">		<span class="comment">// Initialize stack bounds from system stack.</span></span><br><span class="line">		<span class="comment">// Cgo may have left stack size in stack.hi.</span></span><br><span class="line">		<span class="comment">// minit may update the stack bounds.</span></span><br><span class="line">		size := _g_.stack.hi</span><br><span class="line">		<span class="keyword">if</span> size == <span class="number">0</span> &#123;</span><br><span class="line">			size = <span class="number">8192</span> * sys.StackGuardMultiplier</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//g0çš„stackç©ºé—´æ˜¯çœŸçš„å¤§</span></span><br><span class="line">		_g_.stack.hi = <span class="type">uintptr</span>(noescape(unsafe.Pointer(&amp;size)))</span><br><span class="line">		_g_.stack.lo = _g_.stack.hi - size + <span class="number">1024</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Initialize stack guard so that we can start calling regular</span></span><br><span class="line">	<span class="comment">// Go code.</span></span><br><span class="line">	_g_.stackguard0 = _g_.stack.lo + _StackGuard</span><br><span class="line">	<span class="comment">// This is the g0, so we can also call go:systemstack</span></span><br><span class="line">	<span class="comment">// functions, which check stackguard1.</span></span><br><span class="line">	_g_.stackguard1 = _g_.stackguard0</span><br><span class="line">	mstart1()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Exit this thread.</span></span><br><span class="line">	<span class="keyword">switch</span> GOOS &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;windows&quot;</span>, <span class="string">&quot;solaris&quot;</span>, <span class="string">&quot;illumos&quot;</span>, <span class="string">&quot;plan9&quot;</span>, <span class="string">&quot;darwin&quot;</span>, <span class="string">&quot;aix&quot;</span>:</span><br><span class="line">		<span class="comment">// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate</span></span><br><span class="line">		<span class="comment">// the stack, but put it in _g_.stack before mstart,</span></span><br><span class="line">		<span class="comment">// so the logic above hasn&#x27;t set osStack yet.</span></span><br><span class="line">		osStack = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	mexit(osStack)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mstart1"><a class="header-anchor" href="#mstart1">Â¶</a>mstart1</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mstart1</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨ég0å°±å´©ç›˜äº†</span></span><br><span class="line">	<span class="keyword">if</span> _g_ != _g_.m.g0 &#123;</span><br><span class="line">		throw(<span class="string">&quot;bad runtimeÂ·mstart&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	<span class="comment">// Record the caller for use as the top of stack in mcall and</span></span><br><span class="line">	<span class="comment">// for terminating the thread.</span></span><br><span class="line">	<span class="comment">// We&#x27;re never coming back to mstart1 after we call schedule,</span></span><br><span class="line">	<span class="comment">// so other calls can reuse the current frame.</span></span><br><span class="line">	save(getcallerpc(), getcallersp())</span><br><span class="line">	asminit()</span><br><span class="line">	minit()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Install signal handlers; after minit so that minit can</span></span><br><span class="line">    <span class="comment">// prepare the thread to be able to handle the signals.</span></span><br><span class="line">    <span class="comment">//m0å¯åŠ¨</span></span><br><span class="line">	<span class="keyword">if</span> _g_.m == &amp;m0 &#123;</span><br><span class="line">		mstartm0()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> fn := _g_.m.mstartfn; fn != <span class="literal">nil</span> &#123;</span><br><span class="line">		fn()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _g_.m != &amp;m0 &#123;</span><br><span class="line">		acquirep(_g_.m.nextp.ptr())</span><br><span class="line">		_g_.m.nextp = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¼€å§‹è°ƒåº¦</span></span><br><span class="line">	schedule()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mstartm0"><a class="header-anchor" href="#mstartm0">Â¶</a>mstartm0</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mstart1çš„å…·ä½“å®ç°ï¼Œä»…runåœ¨m0ä¸Š</span></span><br><span class="line"><span class="comment">// mstartm0 implements part of mstart1 that only runs on the m0.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Write barriers are allowed here because we know the GC can&#x27;t be</span></span><br><span class="line"><span class="comment">// running yet, so they&#x27;ll be no-ops.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:yeswritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mstartm0</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create an extra M for callbacks on threads not created by Go.</span></span><br><span class="line">	<span class="comment">// An extra M is also needed on Windows for callbacks created by</span></span><br><span class="line">    <span class="comment">// syscall.NewCallback. See issue #6751 for details.</span></span><br><span class="line">    <span class="comment">//windowsä¸‹éœ€è¦ä¸€ä¸ªé¢å¤–çš„M</span></span><br><span class="line">	<span class="keyword">if</span> (iscgo || GOOS == <span class="string">&quot;windows&quot;</span>) &amp;&amp; !cgoHasExtraM &#123;</span><br><span class="line">		cgoHasExtraM = <span class="literal">true</span></span><br><span class="line">		newextram()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ä¿¡å·é‡,ç”¨äºåç»­è°ƒåº¦</span></span><br><span class="line">	initsig(<span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åç»­scheduleå‡½æ•°"><a class="header-anchor" href="#åç»­scheduleå‡½æ•°">Â¶</a><a href="https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L1119">åç»­scheduleå‡½æ•°</a></h4>
<blockquote>
<p>ç®¡å®¶æœ‰äº†ï¼Œé‚£ä¹ˆå¼€å§‹è°ƒåº¦å§â€¦ã€‚</p>
</blockquote>
<h3 id="ä¸‹èŠ‚ï¼š"><a class="header-anchor" href="#ä¸‹èŠ‚ï¼š">Â¶</a>ä¸‹èŠ‚ï¼š</h3>
<ul>
<li>schedule</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ21ã€linux selectæºç </title>
    <url>/archives/ba7b70bf.html</url>
    <content><![CDATA[<blockquote>
<p>select poll epollä¸‰ä¸ªè€ç”Ÿé•¿è°ˆçš„é—®é¢˜.è¿™æ¬¡ä¸æ˜¯æ¥è®²åŒºåˆ«çš„ï¼Œåç»­ä¼šæ›´æ–°ä¸€ç¯‡å…³äºä¸‰è€…åŒºåˆ«çš„ã€‚</p>
</blockquote>
<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>selectå±äºlinuxç³»åˆ—çš„æ–‡ä»¶ç³»ç»Ÿã€Œfsã€çš„èŒƒç•´ï¼Œæ¯æ¬¡çš„ç³»ç»Ÿè°ƒç”¨ã€æ‰“å¼€è½¯ä»¶ã€å¯åŠ¨ç¨‹åºç­‰ç­‰éƒ½ä¼šæ¶‰åŠåˆ°æ–‡ä»¶çš„è¯»å†™ï¼Œ<br>
è¿™ä¸ªæ˜¯åœ¨æ‰€éš¾å…çš„ã€‚</p>
<p>é‚£ä¹ˆI/Oäº‹ä»¶çš„åŸºæœ¬æ€è·¯ï¼šæ–‡ä»¶å‡†å¤‡okï¼Œå¼€å§‹è¯»å†™ï¼Œç­‰å‡½æ•°è¿”å›ï¼Œæ ¹æ®ç»“æœç»§ç»­è¿è¡Œ.</p>
<p>å¦‚æœæ˜¯è‡ªå·±å®ç°ï¼Œå¤§ä½“ä¸Šæ— éä»¥ä¸‹æ€è·¯ï¼š</p>
<span id="more"></span>
<ul>
<li>åˆ›å»ºå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹æ¥ç›‘å¬</li>
<li>Non-blockingè¯»å†™ç›‘å¬çš„è½®è¯¢</li>
<li>å¼‚æ­¥I/Oä¸Unix Signaläº‹ä»¶æœºåˆ¶</li>
</ul>
<p>å…ˆæ¥å­¦ä¹ ä¸‹linuxæºç æ˜¯æ€ä¹ˆå¤„ç†selectæœºåˆ¶çš„ï¼š</p>
<blockquote>
<p>linux version: 5.10-r5</p>
</blockquote>
<h3 id="æ¦‚è§ˆå›¾"><a class="header-anchor" href="#æ¦‚è§ˆå›¾">Â¶</a>æ¦‚è§ˆå›¾</h3>
<p>æ¢³ç†äº†ä¸‹ï¼Œå¤§æ¦‚æ•´ç†æˆäº†æµç¨‹å›¾ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/linux%E6%BA%90%E7%A0%81-select-1.png" alt=""></p>
<h3 id="selectåˆ‡å…¥ç‚¹"><a class="header-anchor" href="#selectåˆ‡å…¥ç‚¹">Â¶</a>selectåˆ‡å…¥ç‚¹</h3>
<p>æ—¢ç„¶çŸ¥é“äº†selectå±äºfsç³»åˆ—çš„ï¼Œé‚£å°±å¾ˆå®¹æ˜“æ‰¾åˆ°:[fs/select.c]</p>
<p>æŸ¥çœ‹selectå‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">man 2 select</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ¥è§£è¯»ï¼Œä¸€èµ·å­¦ä¹ ï¼š</p>
<ul>
<li>å…¥å£ SYSCALL_DEFINE5</li>
<li>æ ¸å¿ƒå‡½æ•° do_select</li>
<li>è®¾å¤‡é©±åŠ¨çš„æ“ä½œå‡½æ•°</li>
<li>poll_waitä¸è®¾å¤‡çš„ç­‰å¾…é˜Ÿåˆ—</li>
<li>fdæ•°é‡é™åˆ¶ã€Œwhyã€</li>
<li>selectä¸poll</li>
</ul>
<h3 id="SYSCALL-DEFINE5"><a class="header-anchor" href="#SYSCALL-DEFINE5">Â¶</a>SYSCALL_DEFINE5</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">SYSCALL_DEFINE5</span>(select, <span class="type">int</span>, n, fd_set __user *, inp, fd_set __user *, outp,</span><br><span class="line">		fd_set __user *, exp, <span class="keyword">struct</span> __kernel_old_timeval __user *, tvp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">kern_select</span>(n, inp, outp, exp, tvp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å‡½æ•°ï¼šcore_sys_selectä¸­ä¸»è¦çš„do_selectå¤„ç†å…¶ä¸­çš„é€»è¾‘</p>
<h3 id="do-select"><a class="header-anchor" href="#do-select">Â¶</a>do_select</h3>
<p>å…³é”®æ€§çš„ç»“æ„ä½“</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *in, *out, *ex; <span class="comment">//è¾“å‡º ã€è¾“å…¥ã€å¼‚å¸¸</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *res_in, *res_out, *res_ex;</span><br><span class="line">&#125; fd_set_bits;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">do_select</span><span class="params">(<span class="type">int</span> n, fd_set_bits *fds, <span class="keyword">struct</span> timespec64 *end_time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">ktime_t</span> expire, *to = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">poll_wqueues</span> table;</span><br><span class="line">	poll_table *wait;</span><br><span class="line">	<span class="type">int</span> retval, i, timed_out = <span class="number">0</span>;</span><br><span class="line">	u64 slack = <span class="number">0</span>;</span><br><span class="line">	<span class="type">__poll_t</span> busy_flag = <span class="built_in">net_busy_loop_on</span>() ? POLL_BUSY_LOOP : <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> busy_start = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rcu_read_lock</span>();</span><br><span class="line">    <span class="comment">//æ‰¾å‡ºæ–‡ä»¶çš„æœ€å¤§æè¿°ç¬¦</span></span><br><span class="line">	retval = <span class="built_in">max_select_fd</span>(n, fds);</span><br><span class="line">	<span class="built_in">rcu_read_unlock</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	n = retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	<span class="built_in">poll_initwait</span>(&amp;table);</span><br><span class="line">	wait = &amp;table.pt;</span><br><span class="line">	<span class="keyword">if</span> (end_time &amp;&amp; !end_time-&gt;tv_sec &amp;&amp; !end_time-&gt;tv_nsec) &#123;</span><br><span class="line">		wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">		timed_out = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (end_time &amp;&amp; !timed_out)</span><br><span class="line">		slack = <span class="built_in">select_estimate_accuracy</span>(end_time);</span><br><span class="line"></span><br><span class="line">	retval = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> *rinp, *routp, *rexp, *inp, *outp, *exp;</span><br><span class="line">		<span class="type">bool</span> can_busy_loop = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		inp = fds-&gt;in; outp = fds-&gt;out; exp = fds-&gt;ex;</span><br><span class="line">		rinp = fds-&gt;res_in; routp = fds-&gt;res_out; rexp = fds-&gt;res_ex;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//éå†æ‰€æœ‰çš„fd.......åŒæ­¥ç­‰.....</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; ++rinp, ++routp, ++rexp) &#123;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> in, out, ex, all_bits, bit = <span class="number">1</span>, j;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> res_in = <span class="number">0</span>, res_out = <span class="number">0</span>, res_ex = <span class="number">0</span>;</span><br><span class="line">			<span class="type">__poll_t</span> mask;</span><br><span class="line"></span><br><span class="line">			in = *inp++; out = *outp++; ex = *exp++;</span><br><span class="line">			all_bits = in | out | ex;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰ä»»ä½•æ³¨å†Œäº‹ä»¶</span></span><br><span class="line">			<span class="keyword">if</span> (all_bits == <span class="number">0</span>) &#123;</span><br><span class="line">				i += BITS_PER_LONG;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; BITS_PER_LONG; ++j, ++i, bit &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">struct</span> <span class="title class_">fd</span> f;</span><br><span class="line">				<span class="keyword">if</span> (i &gt;= n)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//è·³è¿‡æœªæ³¨å†Œçš„</span></span><br><span class="line">				<span class="keyword">if</span> (!(bit &amp; all_bits))</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				f = <span class="built_in">fdget</span>(i);</span><br><span class="line">				<span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">					<span class="built_in">wait_key_set</span>(wait, in, out, bit,</span><br><span class="line">						     busy_flag);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//å¯¹æ¯ä¸€ä¸ªfdè¿›è¡Œæ£€æµ‹</span></span><br><span class="line">					mask = <span class="built_in">vfs_poll</span>(f.file, wait);</span><br><span class="line"></span><br><span class="line">					<span class="built_in">fdput</span>(f);</span><br><span class="line">					<span class="keyword">if</span> ((mask &amp; POLLIN_SET) &amp;&amp; (in &amp; bit)) &#123;</span><br><span class="line">						res_in |= bit;</span><br><span class="line">						retval++;</span><br><span class="line">						wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> ((mask &amp; POLLOUT_SET) &amp;&amp; (out &amp; bit)) &#123;</span><br><span class="line">						res_out |= bit;</span><br><span class="line">						retval++;</span><br><span class="line">						wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> ((mask &amp; POLLEX_SET) &amp;&amp; (ex &amp; bit)) &#123;</span><br><span class="line">						res_ex |= bit;</span><br><span class="line">						retval++;</span><br><span class="line">						wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">/* got something, stop busy polling */</span></span><br><span class="line">					<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">						can_busy_loop = <span class="literal">false</span>;</span><br><span class="line">						busy_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">/*</span></span><br><span class="line"><span class="comment">					 * only remember a returned</span></span><br><span class="line"><span class="comment">					 * POLL_BUSY_LOOP if we asked for it</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (busy_flag &amp; mask)</span><br><span class="line">						can_busy_loop = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (res_in)</span><br><span class="line">				*rinp = res_in;</span><br><span class="line">			<span class="keyword">if</span> (res_out)</span><br><span class="line">				*routp = res_out;</span><br><span class="line">			<span class="keyword">if</span> (res_ex)</span><br><span class="line">				*rexp = res_ex;</span><br><span class="line">			<span class="built_in">cond_resched</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		wait-&gt;_qproc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é€€å‡ºå¾ªç¯ï¼Œæ¡ä»¶ï¼š äº‹ä»¶å°±ç»ª/è¶…æ—¶/æ”¶åˆ°ä¿¡å·</span></span><br><span class="line">		<span class="keyword">if</span> (retval || timed_out || <span class="built_in">signal_pending</span>(current))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (table.error) &#123;</span><br><span class="line">			retval = table.error;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* only if found POLL_BUSY_LOOP sockets &amp;&amp; not out of time */</span></span><br><span class="line">		<span class="keyword">if</span> (can_busy_loop &amp;&amp; !<span class="built_in">need_resched</span>()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!busy_start) &#123;</span><br><span class="line">				busy_start = <span class="built_in">busy_loop_current_time</span>();</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">busy_loop_timeout</span>(busy_start))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		busy_flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If this is the first loop and we have a timeout</span></span><br><span class="line"><span class="comment">		 * given, then we convert to ktime_t and set the to</span></span><br><span class="line"><span class="comment">		 * pointer to the expiry value.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (end_time &amp;&amp; !to) &#123;</span><br><span class="line">			expire = <span class="built_in">timespec64_to_ktime</span>(*end_time);</span><br><span class="line">			to = &amp;expire;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¶…æ—¶å°±ä¼‘çœ ä¸€ä¼šå„¿ã€Œä¸­æ–­ä¼šå„¿ã€</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">poll_schedule_timeout</span>(&amp;table, TASK_INTERRUPTIBLE,</span><br><span class="line">					   to, slack))</span><br><span class="line">			timed_out = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">poll_freewait</span>(&amp;table);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">poll_schedule_timeout</span><span class="params">(<span class="keyword">struct</span> poll_wqueues *pwq, <span class="type">int</span> state,</span></span></span><br><span class="line"><span class="params"><span class="function">			  <span class="type">ktime_t</span> *expires, <span class="type">unsigned</span> <span class="type">long</span> slack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> rc = -EINTR;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set_current_state</span>(state);</span><br><span class="line">	<span class="keyword">if</span> (!pwq-&gt;triggered)</span><br><span class="line">		rc = <span class="built_in">schedule_hrtimeout_range</span>(expires, slack, HRTIMER_MODE_ABS);</span><br><span class="line">	__set_current_state(TASK_RUNNING);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Prepare for the next iteration.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The following smp_store_mb() serves two purposes.  First, it&#x27;s</span></span><br><span class="line"><span class="comment">	 * the counterpart rmb of the wmb in pollwake() such that data</span></span><br><span class="line"><span class="comment">	 * written before wake up is always visible after wake up.</span></span><br><span class="line"><span class="comment">	 * Second, the full barrier guarantees that triggered clearing</span></span><br><span class="line"><span class="comment">	 * doesn&#x27;t pass event check of the next iteration.  Note that</span></span><br><span class="line"><span class="comment">	 * this problem doesn&#x27;t exist for the first iteration as</span></span><br><span class="line"><span class="comment">	 * add_wait_queue() has full barrier semantics.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">smp_store_mb</span>(pwq-&gt;triggered, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="poll-wait"><a class="header-anchor" href="#poll-wait">Â¶</a>poll_wait</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * structures and helpers for f_op-&gt;poll implementations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">//ç±»ä¼¼ä¸€ä¸ªå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*poll_queue_proc)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">wait_queue_head_t</span> *, <span class="keyword">struct</span> poll_table_struct *)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">poll_table_struct</span> &#123;</span><br><span class="line">	poll_queue_proc _qproc; <span class="comment">//callbackæœºåˆ¶</span></span><br><span class="line">	<span class="type">__poll_t</span> _key;</span><br><span class="line">&#125; poll_table;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">poll_wait</span><span class="params">(<span class="keyword">struct</span> file * filp, <span class="type">wait_queue_head_t</span> * wait_address, poll_table *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (p &amp;&amp; p-&gt;_qproc &amp;&amp; wait_address)</span><br><span class="line">		p-&gt;_qproc(filp, wait_address, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="fdæ•°é‡é—®é¢˜"><a class="header-anchor" href="#fdæ•°é‡é—®é¢˜">Â¶</a>fdæ•°é‡é—®é¢˜</h3>
<blockquote>
<p>include/uapi/linux/posix_types.h</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __FD_SETSIZE	1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">//__FD_SETSIZEå½“ä¸‹æ ‡ä½¿ï¼Ÿï¼Ÿï¼Ÿwhatï¼</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> fds_bits[__FD_SETSIZE / (<span class="number">8</span> * <span class="built_in">sizeof</span>(<span class="type">long</span>))];</span><br><span class="line">&#125; __kernel_fd_set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">fd</span> &#123;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">file</span> *file;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä»ä¸Šé¢çœ‹æ¥æ–‡ä»¶æè¿°ç¬¦åªæ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç”¨æ¥æ“ä½œä¸‹æ ‡çš„ï¼Œä¸»è¦æ˜¯æ¯ä¸€ä¸ªè¿›ç¨‹fileæ•°ç»„çš„ä¸‹æ ‡ã€‚ç†è§£do_selectæ˜¯æ ¸å¿ƒã€‚</p>
</blockquote>
<h3 id="select-ä¸poll"><a class="header-anchor" href="#select-ä¸poll">Â¶</a>select ä¸poll</h3>
<blockquote>
<p>pollå–æ¶ˆäº†æœ€å¤§æ•°é‡çš„é™åˆ¶,è¿”å›ç»“æœè¿˜æ˜¯éœ€è¦è½®è¯¢æ¥è·å–å°±ç»ªçš„æè¿°ç¬¦ã€‚</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">pollfd</span> &#123;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">short</span> events; <span class="comment">//request</span></span><br><span class="line">	<span class="type">short</span> revents; <span class="comment">// return</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“è§åç»­æ›´æ–°ã€Œpollæºç ã€</p>
<h3 id="å‚è€ƒ"><a class="header-anchor" href="#å‚è€ƒ">Â¶</a>å‚è€ƒ</h3>
<p><a href="https://www.oreilly.com/openbook/linuxdrive3/book/">Linux Device Drivers, Third Edition</a><br>
<a href="https://stackoverflow.com/questions/11496059/how-do-system-calls-like-select-or-poll-work-under-the-hood">How do system calls like select() or poll() work under the hood?</a></p>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ20ã€åšå®¢è¯¡å¼‚äº‹ä»¶</title>
    <url>/archives/5ce14ff5.html</url>
    <content><![CDATA[<h3 id="åšå®¢CI-CDå´©äº†"><a class="header-anchor" href="#åšå®¢CI-CDå´©äº†">Â¶</a>åšå®¢CI CDå´©äº†</h3>
<blockquote>
<p>å°±åœ¨åˆšæ‰ä¿®æ”¹äº†éƒ¨åˆ†çš„configé…ç½®ï¼Œåæ‰“äº†tag pushäº†ä¸Šå»,</p>
</blockquote>
<blockquote>
<p>ohâ€¦GGäº†</p>
</blockquote>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">err: FATAL Something&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span><br><span class="line">err: TypeError: Cannot read property &#x27;enable&#x27; of undefined</span><br><span class="line">err:     at ***/themes/nextTheme/scripts/filters/comment/disqus.js:11:21</span><br><span class="line">err:     at Filter.execSync (/***/node_modules/hexo/lib/extend/filter.js:74:28)</span><br><span class="line">err:     at Hexo.execFilterSync (/***/node_modules/hexo/lib/hexo/index.js:432:29)</span><br><span class="line">err:     at module.exports (***/themes/nextTheme/scripts/events/lib/injects.js:58:8)</span><br><span class="line">err:     at Hexo.&lt;anonymous&gt; (***/themes/nextTheme/scripts/events/index.js:9:27)</span><br><span class="line">err:     at Hexo.emit (events.js:314:20)</span><br><span class="line">err:     at Hexo._generate (/***/node_modules/hexo/lib/hexo/index.js:399:8)</span><br><span class="line">err:     at /***/node_modules/hexo/lib/hexo/index.js:249:***</span><br><span class="line">err:     at tryCatcher (/***/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:547:31)</span><br><span class="line">err:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:604:18)</span><br><span class="line">err:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)</span><br><span class="line">err:     at PromiseArray._resolve (/***/node_modules/bluebird/js/release/promise_array.js:127:19)</span><br><span class="line">err:     at PromiseArray._promiseFulfilled (/***/node_modules/bluebird/js/release/promise_array.js:145:14)</span><br><span class="line">err:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:609:26)</span><br><span class="line">err:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)</span><br><span class="line">err:     at Promise._resolveCallback (/***/node_modules/bluebird/js/release/promise.js:466:57)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:559:17)</span><br><span class="line">out: INFO  Start processing</span><br><span class="line">err: FATAL Something&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span><br><span class="line">err: TypeError: Cannot read property &#x27;enable&#x27; of undefined</span><br><span class="line">err:     at ***/themes/nextTheme/scripts/filters/comment/disqus.js:11:21</span><br><span class="line">err:     at Filter.execSync (/***/node_modules/hexo/lib/extend/filter.js:74:28)</span><br><span class="line">err:     at Hexo.execFilterSync (/***/node_modules/hexo/lib/hexo/index.js:432:29)</span><br><span class="line">err:     at module.exports (***/themes/nextTheme/scripts/events/lib/injects.js:58:8)</span><br><span class="line">err:     at Hexo.&lt;anonymous&gt; (***/themes/nextTheme/scripts/events/index.js:9:27)</span><br><span class="line">err:     at Hexo.emit (events.js:314:20)</span><br><span class="line">err:     at Hexo._generate (/***/node_modules/hexo/lib/hexo/index.js:399:8)</span><br><span class="line">err:     at /***/node_modules/hexo/lib/hexo/index.js:249:***</span><br><span class="line">err:     at tryCatcher (/***/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:547:31)</span><br><span class="line">err:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:604:18)</span><br><span class="line">err:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)</span><br><span class="line">err:     at PromiseArray._resolve (/***/node_modules/bluebird/js/release/promise_array.js:127:19)</span><br><span class="line">err:     at PromiseArray._promiseFulfilled (/***/node_modules/bluebird/js/release/promise_array.js:145:14)</span><br><span class="line">err:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:609:26)</span><br><span class="line">err:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)</span><br><span class="line">err:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)</span><br><span class="line">err:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)</span><br><span class="line">err:     at Promise._resolveCallback (/***/node_modules/bluebird/js/release/promise.js:466:57)</span><br><span class="line">err:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:559:17)</span><br></pre></td></tr></table></figure>
<p>ç®€å•ç‚¹ï¼Œæ˜¾ç¤ºæ²¡æœ‰enableè¿™ä¸ªå±æ€§ï¼Œï¼Œï¼Œï¼Œæˆ‘æ‡µäº†ï¼Œè¿™éƒ¨ç½²äº†å¤šå°‘æ¬¡äº†ï¼Œæ²¡æœ‰å‡ºç°è¿™ä¹ˆä¸ªé”™è¯¯å•Šã€‚</p>
<p>å…ˆåˆ äº†jsï¼Œæœ¬åœ°è·‘okäº†ï¼Œè¿œç«¯æŒ‚äº†ï¼Œåˆæç¤ºå¦ä¸€ä¸ªjsé”™è¯¯ã€‚<br>
å†åˆ ä¸€ä¸ªé”™è¯¯çš„js,å†è·‘â€¦åˆæŒ‚äº†!</p>
<h3 id="æ’æŸ¥â€¦"><a class="header-anchor" href="#æ’æŸ¥â€¦">Â¶</a>æ’æŸ¥â€¦</h3>
<blockquote>
<p>åˆæ­¥å®šä½ä¸ºæ–‡ä»¶æ²¡æœ‰æ›´åˆ°æœ€æ–°</p>
</blockquote>
<p>æœ¬åœ°ok,æœåŠ¡å™¨éƒ¨ç½²ä¸èµ·æ¥â€¦</p>
<p>æŸ¥ä¸‹æ–‡ä»¶scp copyçš„å·¥ä½œæµ</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-000817@2x.png" alt=""></p>
<p>çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆå¥½ç”¨ï¼Œä½†æ˜¯å‘¢ï¼Œå¤§å‘æ¥äº†â€¦<br>
å½“æ—¶æ²¡æœ‰é€‰æ‹©æ˜¯å¦é€‰æ‹©è¦†ç›–æ–‡ä»¶ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-001054@2x.png" alt=""></p>
<h3 id="é—®é¢˜ç‚¹"><a class="header-anchor" href="#é—®é¢˜ç‚¹">Â¶</a>é—®é¢˜ç‚¹</h3>
<p>æ²¡æœ‰è¦†ç›–é…ç½®æ–‡ä»¶ï¼Œå¯¼è‡´æ®‹ç•™æˆ–è€…ä¿®æ”¹ä¸å½»åº•ï¼ŒåŒåçš„å§‹ç»ˆä¸ä¿®æ”¹ï¼Œå¯¼è‡´çš„é—®é¢˜ã€‚</p>
<p>PSï¼šèŠ±äº†åŠä¸ªå°æ—¶å®šä½è¿™ä¹ˆä¸ªrewriteçš„é—®é¢˜ï¼ è®°ç€å§ï¼Œæé†’è‡ªå·±â€¦</p>
<h3 id="å‚è€ƒï¼š"><a class="header-anchor" href="#å‚è€ƒï¼š">Â¶</a>å‚è€ƒï¼š</h3>
<p><a href="https://github.com/appleboy/scp-action/blob/master/action.yml#L44">copy workflow Github</a><br>
<a href="https://github.com/marketplace/actions/scp-files">scp copy workflow</a></p>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>åšå®¢</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ19ã€GPM è°ƒåº¦æµç¨‹</title>
    <url>/archives/5c6a362f.html</url>
    <content><![CDATA[<p>å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆçŸ¥å…¶æ‰€ä»¥ç„¶â€¦<br>
å­¦ä¹ GPMè°ƒåº¦ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹æºç éƒ¨åˆ†çš„å‡†å¤‡å·¥ä½œå§ï¼Œä¸ç„¶ä¸€è„¸èŒ«ç„¶çš„çœ‹æºç ï¼ŒåŸºæœ¬ä¸ä¼šæœ‰å¤ªå¤šçš„æ”¶è·.</p>
<h3 id="å‡½æ•°-å˜é‡åˆè¯†"><a class="header-anchor" href="#å‡½æ•°-å˜é‡åˆè¯†">Â¶</a>å‡½æ•°&amp; å˜é‡åˆè¯†</h3>
<blockquote></blockquote>
<span id="more"></span>
<blockquote>
<p>go version: 1.14.3</p>
</blockquote>
<h4 id="å‡½æ•°"><a class="header-anchor" href="#å‡½æ•°">Â¶</a>å‡½æ•°</h4>
<blockquote>
<p>/proc.go</p>
</blockquote>
<ul>
<li>main</li>
<li>sysmon</li>
<li>findrunnable</li>
<li>goparkã€Œ1.1ã€</li>
<li>gosched ã€Œ1.2ã€</li>
<li>mstart</li>
<li>wakep</li>
<li>schedule</li>
<li>cpuinit</li>
<li>schedinit</li>
<li>ready</li>
<li>readgstatus</li>
<li>startm</li>
<li>pollWork</li>
<li>injectglist</li>
<li>park_m</li>
<li>goyield</li>
<li>retake</li>
<li>globrunqput</li>
<li>globrunqputbatch</li>
<li>globrunqputhead</li>
</ul>
<h4 id="å˜é‡"><a class="header-anchor" href="#å˜é‡">Â¶</a>å˜é‡</h4>
<blockquote>
<p>/proc.go</p>
</blockquote>
<ul>
<li>m0</li>
<li>g0</li>
<li>allgs</li>
<li>allglock</li>
</ul>
<blockquote>
<p>/runtime2.go</p>
</blockquote>
<ul>
<li>g</li>
<li>p</li>
<li>m</li>
<li>allglen</li>
<li>allm</li>
<li>allp</li>
<li>allpLock</li>
<li>gomaxprocs</li>
<li>sched</li>
</ul>
<blockquote>
<p>/runtime2.go å¸¸é‡</p>
</blockquote>
<ul>
<li>_Grunnable/_Grunning/_Gwaitingâ€¦</li>
</ul>
<h3 id="ä¸Šè¿°è¿™äº›å‡½æ•°-å˜é‡-å¸¸é‡-whatï¼Ÿ"><a class="header-anchor" href="#ä¸Šè¿°è¿™äº›å‡½æ•°-å˜é‡-å¸¸é‡-whatï¼Ÿ">Â¶</a>ä¸Šè¿°è¿™äº›å‡½æ•°/å˜é‡/å¸¸é‡ whatï¼Ÿ</h3>
<p>å†™è¿™ä¹ˆå¤šï¼Œè‚¯å®šä¸æ˜¯ç®€å•çš„ä»æºç ä»“åº“é‡Œé¢è¶…å‡ºæ¥ï¼Œè¿™äº›æ˜¯ä¸€äº›æ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šæ²¡æœ‰ç½—åˆ—ï¼Œè¿™é‡Œä¸»è¦æƒ³è®°å½•ï¼Œä¹Ÿæ˜¯æ€è€ƒçš„ç‚¹ï¼š</p>
<ul>
<li>GPMä¸ºä½•ä¼šæœ‰è¿™ä¹ˆå¤šçš„çŠ¶æ€</li>
<li>è¿™äº›çŠ¶æ€ä¹‹é—´æ˜¯å¦‚ä½•é…åˆå’Œåè°ƒçš„</li>
<li>è‘—åçš„å·¥ä½œå·å–ã€ŒPã€æ˜¯æ€ä¹ˆæ“ä½œçš„</li>
<li>å¦‚æœè®©ä½ è®¾è®¡ï¼Œä½ åº”è¯¥ä¼šæ€ä¹ˆè®¾è®¡GPMè¿™ä¸ªè°ƒåº¦çš„è¿‡ç¨‹ã€ŒğŸé‡ç‚¹ã€</li>
</ul>
<h3 id="åˆ‡å…¥ç‚¹"><a class="header-anchor" href="#åˆ‡å…¥ç‚¹">Â¶</a>åˆ‡å…¥ç‚¹</h3>
<ul>
<li>main:å…¥å£å‡½æ•°</li>
<li>sysmonï¼šç›‘æ§è°ƒåº¦çº¿ç¨‹</li>
<li>scheduleï¼šçœŸå®çš„è°ƒåº¦å™¨é€»è¾‘</li>
<li>m0/g0ï¼šç‰¹æ®Šçš„å­˜åœ¨ä½“</li>
</ul>
<h3 id="å¦‚ä½•å¼€å§‹ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å¼€å§‹ï¼Ÿ">Â¶</a>å¦‚ä½•å¼€å§‹ï¼Ÿ</h3>
<blockquote>
<p>ç®€å•ç‚¹ï¼Œä»mainå¼€å§‹.</p>
</blockquote>
<h3 id="çæ‰¯"><a class="header-anchor" href="#çæ‰¯">Â¶</a>çæ‰¯</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">çœ‹äº†å¾ˆé•¿æ—¶é—´çš„goæºç äº†ï¼Œè§‰å¾—ä¸€ä¸ªå¥½çš„è®¾è®¡ï¼Œä»æ¥ä¸æ˜¯ç®€å•çš„å­¦ä¹ åˆ«äººçš„æºç ï¼Œ</span><br><span class="line">æ›´å¤šçš„æ˜¯å­¦ä¹ æºç çš„è®¾è®¡æ€è·¯å’Œå½“æ—¶è®¾è®¡æ—¶æ˜¯åŸºäºå“ªç§åœºæ™¯ä¸‹çš„ã€‚</span><br><span class="line"></span><br><span class="line">è€ƒè™‘æ›´å¤šçš„åœºæ™¯ï¼Œæœ‰æ²¡æœ‰å…¶å®ƒçš„è®¾è®¡æ€è·¯ï¼Œå¯èƒ½æ²¡æœ‰ç°æœ‰çš„è®¾è®¡æ›´å‡ºè‰²ï¼Œä½†æ›´åŠ é€‚åˆåˆ«çš„åœºæ™¯ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="æœªå®Œå¾…ç»­"><a class="header-anchor" href="#æœªå®Œå¾…ç»­">Â¶</a>æœªå®Œå¾…ç»­.</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ18ã€GPM åˆè¯†/è®¾è®¡</title>
    <url>/archives/b885f9f7.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å­¦goæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œæœ€è¿‘æ€»æ„Ÿè§‰å¿™ç¢Œæ— ä¸ºï¼Œä¹Ÿè¯¥æ€»ç»“ä¸‹å‰æ®µæ—¶é—´è¯»æºç çš„ä¸€äº›å¿ƒå¾—å’Œä½“ä¼šäº†ã€‚</p>
<p>GPMè°ƒåº¦ç®—æ˜¯åœ¨Goä¸­æ¯”è¾ƒç»å…¸çš„äº†ï¼Œæœ‰å¿…è¦æ·±å…¥å­¦ä¹ ä¸‹ã€‚</p>
<blockquote>
<p><a href="https://golang.org/s/go11sched">Go GPMè®¾è®¡æ–‡æ¡£</a></p>
</blockquote>
<h3 id="GPMè®¾è®¡çš„ç”±æ¥"><a class="header-anchor" href="#GPMè®¾è®¡çš„ç”±æ¥">Â¶</a>GPMè®¾è®¡çš„ç”±æ¥</h3>
<p>ä¸€ä¸ªå¥½çš„è®¾è®¡ï¼Œæ€»ä¼šä¼´éšå‘ç°ç°æœ‰çš„é—®é¢˜ï¼Œåœ¨è§£å†³çš„åŸºç¡€ä¸Šè€ƒè™‘åœºæ™¯å¹¶æé«˜æ‰©å±•æ€§ï¼Œå…ˆæ¥äº†è§£ä¸‹Goä¸ºä½•è¦é‡æ–°è®¾è®¡GPMè¿™ä¸ªæ¨¡å‹ï¼š</p>
<span id="more"></span>
<h4 id="ç°æœ‰çš„é—®é¢˜ï¼š"><a class="header-anchor" href="#ç°æœ‰çš„é—®é¢˜ï¼š">Â¶</a>ç°æœ‰çš„é—®é¢˜ï¼š</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. Single global mutex (Sched.Lock) and centralized state. The mutex protects all goroutine-related operations (creation, completion, rescheduling, etc).</span><br><span class="line">2. Goroutine (G) hand-off (G.nextg). Worker threads (M&#x27;s) frequently hand-off runnable goroutines between each other, this may lead to increased latencies and additional overheads. Every M must be able to execute any runnable G, in particular the M that just created the G.</span><br><span class="line">3. Per-M memory cache (M.mcache). Memory cache and other caches (stack alloc) are associated with all M&#x27;s, while they need to be associated only with M&#x27;s running Go code (an M blocked inside of syscall does not need mcache). A ratio between M&#x27;s running Go code and all M&#x27;s can be as high as 1:100. This leads to excessive resource consumption (each MCache can suck up up to 2M) and poor data locality.</span><br><span class="line">4. Aggressive thread blocking/unblocking. In presence of syscalls worker threads are frequently blocked and unblocked. This adds a lot of overhead.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1ã€å•ä¸€çš„å…¨å±€é”å’Œé›†ä¸­çš„çŠ¶æ€.æ­¤é”æ‰€æœ‰gçš„æ“ä½œã€‚</span><br><span class="line">2ã€gé€€å‡ºã€‚å·¥ä½œä¸­çš„Mé¢‘ç¹çš„äº¤å‡ºæ­£åœ¨runningçš„gï¼Œå¯¼è‡´å»¶è¿Ÿå¢åŠ å’Œé¢å¤–çš„è´Ÿè½½ã€‚æ¯ä¸ªMæ‰§è¡Œä»»ä½•gï¼Œå°¤å…¶æ˜¯Mè‡ªèº«åˆ›å»ºçš„gã€‚</span><br><span class="line">3ã€Mçš„å†…å­˜ç¼“å­˜é—®é¢˜ã€‚   å†…å­˜ç¼“å­˜å’Œå…¶å®ƒçš„ç¼“å­˜å…³è”è¿™æ‰€æœ‰çš„Mï¼Œå½“ä»–ä»¬éœ€è¦å…³è”Mæ¥running codeæ—¶ã€‚æ¯”ç‡æ˜¾ç¤ºMè¿è¡Œçš„codeå’Œæ‰€æœ‰Mçš„å‘ˆ1:100ã€‚å¯¼è‡´å¾ˆå¤šèµ„æºçš„æµªè´¹å’Œå†…å­˜çš„è´«ç˜ ã€‚</span><br><span class="line">4ã€ä¾µç•¥æ€§çš„åŠ é”ï¼Œåœ¨ç³»ç»Ÿçº¿ç¨‹é¢‘ç¹çš„åŠ é”å’Œè§£é”ã€‚è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„è´Ÿè½½ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="è®¾è®¡æ”¹å˜"><a class="header-anchor" href="#è®¾è®¡æ”¹å˜">Â¶</a>è®¾è®¡æ”¹å˜</h3>
<blockquote>
<p>ä»¥å‰çš„è®¾è®¡ï¼š<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/GPM-1.png" alt=""></p>
</blockquote>
<blockquote>
<p>æ–°å¢Processor</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/GPM-2.png" alt=""></p>
<h3 id="å®ç°è®¡åˆ’"><a class="header-anchor" href="#å®ç°è®¡åˆ’">Â¶</a>å®ç°è®¡åˆ’</h3>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. Introduce the P struct (empty for now); implement allp/idlep containers (idlep is mutex-protected for starters); associate a P with M running Go code. Global mutex and atomic state is still preserved.</span><br><span class="line">2. Move G freelist to P.</span><br><span class="line">3. Move mcache to P.</span><br><span class="line">4. Move stackalloc to P.</span><br><span class="line">5. Move ncgocall/gcstats to P.</span><br><span class="line">// work-stealå·¥ä½œçªƒå–æ¨¡å¼,ä»ç„¶åœ¨å…¨å±€é”ä¸‹ã€‚</span><br><span class="line">6. Decentralize run queue, implement work-stealing. Eliminate G hand off. Still under global mutex.</span><br><span class="line"></span><br><span class="line">// ç§»é™¤å…¨å±€é”ï¼Œå®ç°åˆ†æ•£çš„æ£€æµ‹ã€‚</span><br><span class="line">7. Remove global mutex, implement distributed termination detection, LockOSThread.</span><br><span class="line"></span><br><span class="line">// å®ç°è‡ªæ—‹æ›¿ä»£æç¤ºé”ã€Œæ™®é€šé”ã€ã€‚</span><br><span class="line">8. Implement spinning instead of prompt blocking/unblocking.</span><br><span class="line">The plan may turn out to not work, there are a lot of unexplored details.</span><br></pre></td></tr></table></figure>
<h3 id="Potential-Improvement"><a class="header-anchor" href="#Potential-Improvement">Â¶</a>Potential Improvement</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># åè¿›å…ˆå‡ºè®¡åˆ’ã€‚æä¾›å…¬å¹³å’Œä¼˜é›…çš„å¤„ç†gã€‚</span><br><span class="line">1. Try out LIFO scheduling, this will improve locality. However, it still must provide some degree of fairness and gracefully handle yielding goroutines.</span><br><span class="line"></span><br><span class="line"># ä¸åˆ†é…å†…å­˜å’Œæ ˆç©ºé—´ï¼Œç›´åˆ°gè·‘èµ·æ¥ã€‚å¯¹äºä¸€ä¸ªæ–°åˆ›å»ºçš„gï¼Œéœ€è¦ä¸‹é¢å‡ ä¸ªå‡½æ•°ã€‚ è¿™å°†åˆ›å»ºtoå®Œæˆä¼´éšç€è¾ƒä½å†…å­˜çš„è´Ÿè½½ã€‚</span><br><span class="line">2. Do not allocate G and stack until the goroutine first runs. For a newly created goroutine we need just callerpc, fn, narg, nret and args, that is, about 6 words. This will allow to create a lot of running-to-completion goroutines with significantly lower memory overhead.</span><br><span class="line"></span><br><span class="line"># æ›´å¥½çš„G-Pã€‚å°è¯•å…¥é˜Ÿæœªé”å®šçš„Gåˆ°Pï¼Œä»ä¸Šä¸€æ¬¡è¿è¡Œã€‚</span><br><span class="line">4. Better locality of G-to-P. Try to enqueue an unblocked G to a P on which it was last running.</span><br><span class="line"></span><br><span class="line"># æ›´å¥½çš„P-Mã€‚å°è¯•æ‰§è¡Œpï¼Œåœ¨åŒæ ·çš„Mæœ€åä¸€æ¬¡è¿è¡Œã€‚</span><br><span class="line">5. Better locality of P-to-M. Try to execute P on the same M it was last running.</span><br><span class="line"></span><br><span class="line"># Mé™æµåˆ›å»ºã€‚è°ƒåº¦å™¨åˆ›å»ºä¸Šåƒå“¥Måœ¨æ¯«ç§’ä¹‹é—´ï¼Œç›´åˆ°OSæ‹’ç»åˆ›å»ºæ›´å¤šçš„threadã€‚Må¿…é¡»ç«‹åˆ»åˆ›å»ºï¼Œæœ€å¤šåˆ›å»ºk*GOMAXPROCS,åç»­æ–°çš„Mä¼šé€šè¿‡å®šæ—¶å™¨åˆ›å»ºã€‚</span><br><span class="line">6. Throttling of M creation. The scheduler can be easily forced to create thousands of M&#x27;s per second until OS refuses to create more threads. Mâ€™s must be created promptly up to k*GOMAXPROCS, after that new Mâ€™s may added by a timer.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒï¼š"><a class="header-anchor" href="#å‚è€ƒï¼š">Â¶</a>å‚è€ƒï¼š</h3>
<ul>
<li>
<p><a href="https://golang.org/s/go11scheds">GPM g11è®¾è®¡æ–‡æ¡£</a></p>
</li>
<li>
<p><a href="http://supertech.csail.mit.edu/papers/steal.pdf">work stealæ¨¡å¼</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GPM</tag>
        <tag>Goæºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ17ã€chrome headlessã€Œæˆªå›¾/PDF/DOM...ã€</title>
    <url>/archives/5544baea.html</url>
    <content><![CDATA[<blockquote>
<p>æœ€è¿‘åœ¨æä¸€ä¸ªéœ€æ±‚ï¼šhtmlã€Œæ–‡ä»¶ã€æ¸²æŸ“æˆpng/jpgï¼›chromeä¸èƒ½è£…åœ¨æœåŠ¡å™¨ä¸­ï¼Œå¯ä»¥æ‰“æˆdockeré•œåƒã€‚<br>
è¯´åˆ°è¿™ä¸ªï¼Œå¾ˆå¤šäººè‚¯å®šè¯´å¾ˆå®¹æ˜“å•Šï¼Œchrome headlessæœ‰ç°æˆçš„ï¼Œç›´æ¥ç”¨ï¼Œå®ƒæ˜¯ä¸é¦™ä¹ˆã€‚<br>
ç„¶è€Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼›</p>
</blockquote>
<h3 id="éš¾ç‚¹ï¼š"><a class="header-anchor" href="#éš¾ç‚¹ï¼š">Â¶</a>éš¾ç‚¹ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€æœåŠ¡å™¨ä¸­ä¸èƒ½è£…chrome</span><br><span class="line"><span class="number">2</span>ã€chromeå¿…é¡»æ‰“åœ¨dockeré‡Œé¢</span><br><span class="line"><span class="number">3</span>ã€æ¸²æŸ“æ•ˆæœè¦å’Œåœ¨æœ¬åœ°æ•ˆæœä¸€æ ·ï¼šå›¾ç‰‡ä¸èƒ½ä¸¢å¤±å­—ä½“ï¼Œä¸èƒ½å¤±çœŸã€‚</span><br><span class="line"><span class="number">4</span>ã€ä¸èƒ½å¯åŠ¨æ–°çš„æœåŠ¡</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="åˆ‡å…¥ç‚¹ï¼š"><a class="header-anchor" href="#åˆ‡å…¥ç‚¹ï¼š">Â¶</a>åˆ‡å…¥ç‚¹ï¼š</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">docker &amp;&amp; chrome</span><br></pre></td></tr></table></figure>
<blockquote>
<p>soå…ˆå»æœä¸€æŠŠæœ‰æ²¡æœ‰ç°æˆçš„å¯ç”¨ï¼Ÿ</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20201110-193745.png" alt=""></p>
<p>åˆ†æåˆ†æå§ï¼š</p>
<ul>
<li><a href="https://github.com/browserless/chrome">browserless</a></li>
<li><a href="https://github.com/puppeteer/puppeteer">puppeteer</a></li>
<li><a href="https://github.com/prisma-archive/chromeless">prisma-archive</a><br>
â€¦
<ul>
<li>é€‚åˆå¯åŠ¨æœåŠ¡ï¼Œç„¶åè¿›è¡Œæµ‹è¯•æˆ–è€…è·‘æœåŠ¡</li>
<li>å…¥å‚æ•°ä¸ºurl</li>
</ul>
</li>
</ul>
<blockquote>
<p>æ‰€ä»¥ä¸Šè¿°çš„åŸºæœ¬ä¸ç¬¦åˆéœ€æ±‚ï¼Œå†å¯»æ‰¾â€¦</p>
</blockquote>
<h3 id="Zenika-alpine-chrome"><a class="header-anchor" href="#Zenika-alpine-chrome">Â¶</a><a href="https://github.com/Zenika/alpine-chrome">Zenika/alpine-chrome</a></h3>
<blockquote>
<p>çœ‹èµ·æ¥å¯è¡Œï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20201110-194452.png" alt=""></p>
<p>è¿™ä¸ªç»è¿‡éªŒè¯æ€»ä¼šæœ‰ä¸€ä¸ªé”™è¯¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[1110/031547.366909:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket /var/run/dbus/system_bus_socket: No such file or directory</span><br><span class="line">[1110/031547.367451:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class="line">[1110/031547.437879:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class="line">[1110/031549.073431:ERROR:headless_shell.cc(591)] Writing to file code/ss.png was unsuccessful, could not open file: FILE_ERROR_ACCESS_DENIED</span><br></pre></td></tr></table></figure>
<p>æ–‡ä»¶æ²¡æƒé™å“¦ï¼Œå°´å°¬äº†,å†ä¿®æ­£ï¼š</p>
<blockquote>
<p>å‘ç°æºç æœ‰ä¸€æ®µæ·»åŠ äº†ç”¨æˆ·ï¼Œæ±—ï¼Œå¤ªæäº†.</p>
</blockquote>
<p><a href="https://github.com/Zenika/alpine-chrome/blob/master/Dockerfile#L38">ç‚¹å‡»æŸ¥çœ‹</a></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20201110-194711.png" alt=""></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å¾ˆéƒé—·è¿™ä¸ªchromeç”¨æˆ·å¹²å˜›çš„ï¼Œå¦‚æœçœŸç”¨è¿™ä¸ªï¼Œé‚£å¾—ç¡®å®šä½ è·‘çš„ç¯å¢ƒè¦å…è®¸ä½ æ·»åŠ ä¸€ä¸ªuserå‡ºæ¥ï¼Œå¾ˆæ˜æ˜¾ä¸è¡Œ,</span><br><span class="line">è¿™æ ·å¯¼è‡´æ•´ä¸ªalpine-chromeæœåŠ¡æƒé™éƒ½æ˜¯ä¹±çš„ã€Œchromeç”¨æˆ·çš„ã€,æœ€æ˜æ˜¾çš„æ˜¯æ— æ³•è¯»å†™æ–‡ä»¶ï¼Œå› ä¸ºä½ è¿™ä¸ªadd chromeæ²¡æƒé™ã€‚</span><br><span class="line"></span><br><span class="line">æœ€ç›´æ¥çš„ï¼Œå»æ‰å°±å¥½äº†ã€‚</span><br><span class="line"></span><br><span class="line">æœç„¶å»æ‰åï¼Œè·‘dockerå°±å¯ä»¥äº†</span><br></pre></td></tr></table></figure>
<p><a href="https://hub.docker.com/r/zenika/alpine-chrome">dockeré•œåƒåœ°å€</a></p>
<p>è¿™ä¸ªæ˜¯å¯ä»¥äº†ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå›¾åƒå¤±çœŸäº†ï¼Œå†å»æŸ¥githubæºç ï¼Œå‘é‚£ï¼Œå‹æ ¹æ²¡æœ‰è£…å…¨æ–‡å­—åº“ï¼Œåªç®€å•è£…äº†lib***çš„åº“ã€‚</p>
<h3 id="å†å°è¯•ã€Œè‡ªå·±æä¸ªdocker-imagesã€"><a class="header-anchor" href="#å†å°è¯•ã€Œè‡ªå·±æä¸ªdocker-imagesã€">Â¶</a>å†å°è¯•ã€Œè‡ªå·±æä¸ªdocker imagesã€</h3>
<blockquote>
<p>åˆ«äººéƒ½èƒ½æï¼Œä¸ºä½•æˆ‘ä¸å¯ä»¥å‹’</p>
</blockquote>
<h3 id="åˆ†æï¼š"><a class="header-anchor" href="#åˆ†æï¼š">Â¶</a>åˆ†æï¼š</h3>
<ul>
<li>æœ¬åœ°è·‘è¿™ä¸ªæœåŠ¡æ˜¯okçš„ï¼Œé‚£chromeå°±æ˜¯ä¾èµ–macos/linuxç³»ç»Ÿçš„</li>
<li>é‚£å¯ä»¥æä¸ªlinuxç³»ç»Ÿï¼Œå†è£…ä¸ªchrome</li>
<li>æœ€åæŠŠå­—ä½“è£…å®Œå°±okäº†</li>
<li>æœ€åçš„æœ€åï¼Œæƒ³åŠæ³•ç›´æ¥å¯ä»¥ç”¨è¿™ä¸ªdockerï¼Œä¸ç”¨å¯åŠ¨æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´docker runä¹‹åæœ‰äº†ç»“æœï¼Œç›´æ¥rmæ‰ã€‚</li>
</ul>
<h3 id="æ€è·¯ï¼š"><a class="header-anchor" href="#æ€è·¯ï¼š">Â¶</a>æ€è·¯ï¼š</h3>
<ul>
<li>1ã€æä¸ªdocker debainç³»ç»Ÿ</li>
<li>2ã€æƒ³åŠæ³•æŠŠchromeè£…ä¸Š</li>
<li>3ã€åœ¨é‡Œé¢è·‘ä¸€ä¸ªæµ‹è¯•ï¼Œçœ‹èƒ½å¦ç”Ÿæˆå›¾ç‰‡</li>
<li>4ã€å®‰è£…ç¼ºå¤±çš„å­—ä½“</li>
<li>5ã€containerè·‘èµ·æ¥</li>
<li>6ã€å¯¼å‡ºcontainerï¼Œå†å¯¼å…¥åˆ°æœ¬åœ°çš„imagesï¼›è®©containerå˜æˆimages</li>
<li>7ã€è‡ªå·±æä¸ªDockerfileï¼ŒæŠŠã€ŒRUNã€æ¥å£ç•™å‡ºæ¥ï¼Œæ–¹ä¾¿å¯ä»¥ç›´æ¥è·‘èµ·æ¥</li>
<li>8ã€å†æŠŠæå¥½çš„imageså¯¼å‡ºæ¥ç”¨å°±å¯ä»¥äº†ã€‚</li>
</ul>
<h3 id="æ­¥éª¤ï¼š"><a class="header-anchor" href="#æ­¥éª¤ï¼š">Â¶</a>æ­¥éª¤ï¼š</h3>
<h4 id="1"><a class="header-anchor" href="#1">Â¶</a>1</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pull debian</span><br></pre></td></tr></table></figure>
<h4 id="2-3-4-5"><a class="header-anchor" href="#2-3-4-5">Â¶</a>2/3/4/5</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€è¿›å…¥ç³»ç»Ÿ</span><br><span class="line">docker exec -it XXXXX /bin/bash</span><br><span class="line">2ã€æ›´æ–°æº</span><br><span class="line">apt-get update</span><br><span class="line">3ã€ä¸‹è½½wget</span><br><span class="line">apt-get install wget</span><br><span class="line">4ã€ä¸‹è½½chrome linuxç‰ˆæœ¬çš„</span><br><span class="line">wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</span><br><span class="line">5ã€å®‰è£…chrome</span><br><span class="line"> dpkg -i ******.deb</span><br><span class="line"> è§£å†³ä¾èµ–å…³ç³»ï¼š</span><br><span class="line">    apt-get -f install</span><br><span class="line">6ã€è·‘ä¸€æŠŠå‘ç°æ±‰å­—å˜é—®å¥½ã€Œï¼Ÿã€äº†</span><br><span class="line">7ã€å®‰è£…ç¼ºå¤±çš„å­—ä½“</span><br><span class="line">apt-get install ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br></pre></td></tr></table></figure>
<h4 id="6å¯¼å‡ºcontainer"><a class="header-anchor" href="#6å¯¼å‡ºcontainer">Â¶</a>6å¯¼å‡ºcontainer</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€å¯¼å‡ºcontainer</span><br><span class="line">docker export container_name &gt; chrome.tar</span><br><span class="line">2ã€å¯¼å…¥åˆ°imagesä¸­</span><br><span class="line">docker load &lt; chrome.tar</span><br></pre></td></tr></table></figure>
<h4 id="7è‡ªå·±æDockerfile-é¢„ç•™ã€ŒRUNã€æ¥å£"><a class="header-anchor" href="#7è‡ªå·±æDockerfile-é¢„ç•™ã€ŒRUNã€æ¥å£">Â¶</a>7è‡ªå·±æDockerfile,é¢„ç•™ã€ŒRUNã€æ¥å£</h4>
<p>Dockerfileæ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#è¿™ä¸ªæ˜¯ä¸Šä¸€æ­¥å¯¼å…¥çš„images</span><br><span class="line">FROM gogoowang/chrome:v1</span><br><span class="line">RUN mkdir -p /home</span><br><span class="line">WORKDIR /home</span><br><span class="line">ENTRYPOINT [&quot;chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ„å»ºæˆé•œåƒï¼šdocker build -t gogoo/chrome:v2 .</p>
</blockquote>
<p>PS:ã€Œ/homeã€çš„å«ä¹‰å°±æ˜¯è¿™ä¸ªimagesçš„å·¥ä½œç›®å½•æ˜¯/homeæ–‡ä»¶å¤¹ä¸‹é¢</p>
<h4 id="8è·‘ä¸€æŠŠï¼Œæ”¶å·¥"><a class="header-anchor" href="#8è·‘ä¸€æŠŠï¼Œæ”¶å·¥">Â¶</a>8è·‘ä¸€æŠŠï¼Œæ”¶å·¥</h4>
<h3 id="æ³¨æ„ç‚¹ï¼š"><a class="header-anchor" href="#æ³¨æ„ç‚¹ï¼š">Â¶</a>æ³¨æ„ç‚¹ï¼š</h3>
<h4 id="PS-1"><a class="header-anchor" href="#PS-1">Â¶</a>PS-1</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€é”™è¯¯âŒ</span><br><span class="line">docker container run -it --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot --hide-scrollbars /XXXX/XXXX.html</span><br><span class="line">2ã€æ­£ç¡®</span><br><span class="line">docker container run -i --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot=/home/xx.png --hide-scrollbars /XXXX/XXXX.html</span><br><span class="line"></span><br><span class="line">å°‘ä¸€ä¸ª -tï¼Œè¿™ä¸ª -tï¼šå†æä¸€ä¸ªä¸´æ—¶çš„TTyæ¥è·‘ç¨‹åºï¼Œæ—¢ç„¶æ˜¯åå°è·‘çš„ï¼Œé‚£å°±æ²¡å¿…è¦äº†</span><br></pre></td></tr></table></figure>
<h4 id="PS-2"><a class="header-anchor" href="#PS-2">Â¶</a>PS-2</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker container run -i --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot=/home/xx.png --hide-scrollbars /XXXX/XXXX.html</span><br><span class="line"></span><br><span class="line">1ã€å…³äºè¿™ä¸ª-vçš„é—®é¢˜,åé¢å°±å›ºå®šäº†ï¼Œå…·ä½“è§Dockerfileä¸­</span><br><span class="line">2ã€--screenshotè·¯å¾„é—®é¢˜ï¼Œæ—¢ç„¶æ˜¯dockeré•œåƒï¼Œé‚£å°±å¾—å¡«ä¸ªdockeré•œåƒä¸­çš„åœ°å€ï¼Œé‚£å°±æ˜¯/homeä¸‹é¢äº†</span><br></pre></td></tr></table></figure>
<h3 id="ä¼˜åŒ–åä¸€é”®è„šæœ¬"><a class="header-anchor" href="#ä¼˜åŒ–åä¸€é”®è„šæœ¬">Â¶</a>ä¼˜åŒ–åä¸€é”®è„šæœ¬</h3>
<p>Dockerfileæ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FROM debian</span><br><span class="line">RUN apt-get update </span><br><span class="line">RUN apt-get install -y wget </span><br><span class="line">RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb </span><br><span class="line">RUN dpkg -i google-chrome-stable_current_amd64.deb || true</span><br><span class="line">RUN apt-get -f -y install</span><br><span class="line">RUN apt-get install -y ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br><span class="line">RUN mkdir -p /home</span><br><span class="line">WORKDIR /home</span><br><span class="line">ENTRYPOINT [&quot;/opt/google/chrome/chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>
<p>æ„å»ºï¼š</p>
<blockquote>
<p>docker build -t google-chrome:latest .</p>
</blockquote>
]]></content>
      <tags>
        <tag>Day</tag>
        <tag>chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ16ã€goæºç wordså½’çº³</title>
    <url>/archives/425d5e80.html</url>
    <content><![CDATA[<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<p>å¥½ä¹…æ²¡æœ‰æ›´æ–°äº†ï¼Œä¸æ˜¯ä¸æ›´æ–°ï¼Œæœ€è¿‘æ„Ÿå†’ä¸¥é‡ï¼Œä¸€ç›´æ²¡å¥½ï¼Œå¤ªå½±å“èº«ä½“äº†â€¦ã€Œèº«ä½“è¿˜æ˜¯å¾ˆé‡è¦çš„!ã€</p>
<p>å½“ç„¶äº†ï¼Œåœ¨ç”Ÿç—…æœŸé—´ä¹Ÿçœ‹äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ›´å¤šçš„æ€è€ƒäº†è®¸å¤šï¼šäººç”Ÿè§„åˆ’çš„ã€å¦‚ä½•å­¦ä¹ æŠ€æœ¯ã€åç»­çš„ç”Ÿæ¶¯å‘å±•ä¹‹ç±»çš„ã€‚ã€Œæ€è€ƒçš„æ–¹å¼å¾ˆå¤šç§ï¼Œä¸å»ºè®®å»ç”Ÿç—…äº†æ‰å»æ€è€ƒ.ã€</p>
<blockquote>
<p>åç»­ä¼šæ›´æ–°ä¸€ç¯‡ï¼Œä¸»è¦æ˜¯ç»“åˆä¹‹å‰çš„æˆé•¿å’ŒæŠ€æœ¯çš„å£å’æ¥è¯´è¯´åç»­æƒ³æ€ä¹ˆå­¦ï¼Œæ€ä¹ˆå‘å±•ï¼Œç”Ÿæ¶¯è§„åˆ’å§ã€‚</p>
</blockquote>
<p>ä¸æ‰¯äº†ï¼Œè¿™ç¯‡ä¸»è¦æƒ³è®°å½•ä¸€äº›è¯æ±‡ï¼Œä¸»è¦è¿˜æ˜¯åœ¨é˜…è¯»Goæºç ä¸­çš„ä¸€äº›è¯æ±‡ï¼Œæ¯•ç«Ÿè‹±æ–‡æœ‰ç‚¹å·®ï¼Œå†ä¸ç§¯ç´¯å°±æ›´å·®äº†ã€‚</p>
<h3 id="Words"><a class="header-anchor" href="#Words">Â¶</a>Words</h3>
<h4 id="å…¨ç§°"><a class="header-anchor" href="#å…¨ç§°">Â¶</a>å…¨ç§°</h4>
<span id="more"></span>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ã€Œ<span class="number">11</span>/<span class="number">3</span>ã€</span><br><span class="line">Preempt  v æŠ¢å ã€æ å¤º                                   --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">retake   v é‡æ–°è·å–ã€Œé‡æ–°åˆ†é…ã€                           --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">syscall  v ç³»ç»Ÿè°ƒç”¨                                     --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">decrement v é€’å‡                                       --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">pretending  v å‡è£…ã€ä¼ªè£…                                --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">contended  v ç«äº‰                                      --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">procresize  v æ‰©å¤§                                     --&gt; /proc.<span class="keyword">go</span> </span><br><span class="line">corruption  n è…è´¥ï¼Œè¯‘ï¼šæŸå</span><br><span class="line">infinite  adj æ— é™çš„  </span><br><span class="line">reproduce v  å¤åˆ¶</span><br><span class="line">consists  v ç»„æˆ</span><br><span class="line">reproducer  v å¤åˆ¶</span><br><span class="line">allocating v åˆ†é…</span><br><span class="line">embed   v åµŒå…¥ </span><br><span class="line"></span><br><span class="line">ã€Œ<span class="number">11</span>/<span class="number">5</span>ã€</span><br><span class="line">assembly  n  è£…é…                                      --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">amortizes  v  ç¼“å†²                                     --&gt; /proc.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line">ã€Œ<span class="number">11</span>/<span class="number">25</span>ã€</span><br><span class="line">guard  v. çœ‹å®ˆ																				 --&gt; /proc.<span class="keyword">go</span></span><br><span class="line">Alternatively  æˆ–è€…																		--&gt;  /runtime/rwmutex.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line">ã€Œlaterã€</span><br><span class="line">demonstrate  v æ¼”ç¤º</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">instructions v  æŒ‡ç¤º  ----&gt; (<span class="keyword">go</span> github memory leak)[https:<span class="comment">//github.com/golang/go/issues/40448]</span></span><br><span class="line">reiterate    v  é‡ç”³</span><br><span class="line">procedure    n ç¨‹åº</span><br><span class="line">hypothesis   n å‡è®¾</span><br></pre></td></tr></table></figure>
<h4 id="ç®€å†™"><a class="header-anchor" href="#ç®€å†™">Â¶</a>ç®€å†™</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">ã€Œ<span class="number">11</span>/<span class="number">3</span>ã€</span><br><span class="line">sysmon -&gt; system monitor ç³»ç»Ÿç›‘æ§                                               /proc.<span class="keyword">go</span></span><br><span class="line">incidlelocked  --&gt; increment idle locked   å¢åŠ ç©ºé—²é”                           /proc.<span class="keyword">go</span></span><br><span class="line">sysmontick  --&gt; system monitor ticket   ç³»ç»Ÿç›‘æ§æ•°é‡                            /proc.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<h3 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ15ã€Plan9 æ±‡ç¼–å°è®°</title>
    <url>/archives/2ce846ed.html</url>
    <content><![CDATA[<h4 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h4>
<blockquote>
<p>å¹³å¸¸codingæ—¶ï¼Œå¶å°”ä¼šæŸ¥çœ‹è®¡ç®—æœºçš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼Œé‚£æœ€åŸºæœ¬çš„å°±æ˜¯æ±‡ç¼–äº†ï¼Œäº†è§£æ±‡ç¼–æ˜¯è°ƒè¯•è¿‡ç¨‹ä¸­å¿…ä¸å¯å°‘çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›ç»†èŠ‚çš„å¤„ç†æ–¹é¢.Goçš„æ±‡ç¼–æ˜¯Plan 9(è´å°”å®éªŒå®¤çš„äº§ç‰©)ï¼Œå’Œæ±‡ç¼–å¾ˆç±»ä¼¼ã€‚</p>
</blockquote>
<h4 id="å¦‚ä½•å¾—åˆ°æ±‡ç¼–ç»“æœï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å¾—åˆ°æ±‡ç¼–ç»“æœï¼Ÿ">Â¶</a>å¦‚ä½•å¾—åˆ°æ±‡ç¼–ç»“æœï¼Ÿ</h4>
<ul>
<li>å®˜ç½‘æ–‡æ¡£</li>
<li>Google</li>
</ul>
<h5 id="3ç§æ–¹å¼ï¼š"><a class="header-anchor" href="#3ç§æ–¹å¼ï¼š">Â¶</a>3ç§æ–¹å¼ï¼š</h5>
<blockquote>
<p>ç¬¬ä¸€ç§</p>
</blockquote>
<span id="more"></span>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> tool compile -N -l -S ***.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç¬¬äºŒç§</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€å…ˆç¼–è¯‘ï¼š</span><br><span class="line">    <span class="keyword">go</span> tool compile -N -l ***.<span class="keyword">go</span></span><br><span class="line"><span class="number">2</span>ã€å†åç¼–è¯‘ï¼š</span><br><span class="line">    <span class="keyword">go</span> tool objdump ***.o</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç¬¬ä¸‰ç§</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> build -gcflags -S ***.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<h4 id="å¸¸ç”¨å¯„å­˜å™¨"><a class="header-anchor" href="#å¸¸ç”¨å¯„å­˜å™¨">Â¶</a>å¸¸ç”¨å¯„å­˜å™¨</h4>
<blockquote>
<p>plan9 æŒ‡ä»¤æ ¼å¼:  æŒ‡ä»¤ æºæ“ä½œæ•° ç›®æ ‡æ“ä½œæ•°</p>
</blockquote>
<h5 id="AX-BX-CX-DX-BP-SI-SP-IP"><a class="header-anchor" href="#AX-BX-CX-DX-BP-SI-SP-IP">Â¶</a>AX BX CX DX BP SI SP IP</h5>
<table>
<thead>
<tr>
<th style="text-align:left">å¯„å­˜å™¨</th>
<th style="text-align:left">16ä½</th>
<th style="text-align:left">32ä½</th>
<th style="text-align:left">64ä½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ç´¯åŠ å¯„å­˜å™¨</td>
<td style="text-align:left">AX</td>
<td style="text-align:left">EAX</td>
<td style="text-align:left">RAX</td>
</tr>
<tr>
<td style="text-align:left">åŸºå€å¯„å­˜å™¨</td>
<td style="text-align:left">BX</td>
<td style="text-align:left">EBX</td>
<td style="text-align:left">RBX</td>
</tr>
<tr>
<td style="text-align:left">è®¡æ•°å¯„å­˜å™¨</td>
<td style="text-align:left">CX</td>
<td style="text-align:left">ECX</td>
<td style="text-align:left">RCX</td>
</tr>
<tr>
<td style="text-align:left">æ•°æ®å¯„å­˜å™¨</td>
<td style="text-align:left">DX</td>
<td style="text-align:left">EDX</td>
<td style="text-align:left">RDX</td>
</tr>
<tr>
<td style="text-align:left">å †æ ˆåŸºæŒ‡é’ˆ</td>
<td style="text-align:left">BP</td>
<td style="text-align:left">EBP</td>
<td style="text-align:left">RBP</td>
</tr>
<tr>
<td style="text-align:left">å˜å€å¯„å­˜å™¨</td>
<td style="text-align:left">SI</td>
<td style="text-align:left">ESI</td>
<td style="text-align:left">RSI</td>
</tr>
<tr>
<td style="text-align:left">å †æ ˆé¡¶æŒ‡é’ˆ</td>
<td style="text-align:left">SP</td>
<td style="text-align:left">ESP</td>
<td style="text-align:left">RSP</td>
</tr>
<tr>
<td style="text-align:left">æŒ‡ä»¤å¯„å­˜å™¨</td>
<td style="text-align:left">IP</td>
<td style="text-align:left">EIP</td>
<td style="text-align:left">RIP</td>
</tr>
</tbody>
</table>
<h5 id="4ä¸ªä¼ªå¯„å­˜å™¨"><a class="header-anchor" href="#4ä¸ªä¼ªå¯„å­˜å™¨">Â¶</a>4ä¸ªä¼ªå¯„å­˜å™¨:</h5>
<ul>
<li>FP: æŒ‡å‘æ ˆåº•ä½ç½®,ä¸€èˆ¬ç”¨æ¥å¼•ç”¨å‡½æ•°çš„è¾“å…¥å‚æ•°,ç”¨äºå‡½æ•°å‚æ•°çš„è®¿é—®ã€Œframe pointerã€</li>
<li>PC: ç¨‹åºè®¡æ•°å™¨,ç”¨äºåˆ†æ”¯ä¸è·³è½¬.ã€Œprogram counterã€</li>
<li>SB: å‡½æ•°å£°æ˜å’Œå…¨å±€å˜é‡.ã€Œstatic base pointerã€</li>
<li>SP: æŒ‡å‘å½“å‰æ ˆå¸§çš„å±€éƒ¨å˜é‡çš„å¼€å§‹ä½ç½®ã€Œæ ˆé¡¶ä½ç½®ã€,ç”¨äºå±€éƒ¨å˜é‡çš„å¼•ç”¨.</li>
</ul>
<p>æ›´æ–°ï¼š</p>
<ul>
<li>SB Static base pointer: global symbols. å…¨å±€é™æ€åŸºæŒ‡é’ˆï¼Œç¨‹åºåœ°å€ç©ºé—´çš„å¼€å§‹åœ°å€ã€‚æ‰€æœ‰ç”¨æˆ·å®šä¹‰çš„ç¬¦å·éƒ½å¯ä»¥ä½œä¸ºåç§»é‡å†™å…¥ä¼ªå¯„å­˜å™¨ FPï¼ˆå‚æ•°å’Œå±€éƒ¨å˜é‡ï¼‰å’Œ SBï¼ˆå…¨å±€å˜é‡ï¼‰ã€‚SB ä¼ªå¯„å­˜å™¨å¯ä»¥è¢«è®¤ä¸ºæ˜¯å†…å­˜çš„èµ·å§‹ä½ç½® 0x0ï¼Œä¾‹å¦‚ runtime.newobject(SB) å°±æ˜¯å‡½æ•° runtime.newobject ä½äºå†…å­˜ä¸­çš„åœ°å€ã€‚</li>
<li>SP Stack pointer: the highest address within the local stack frame. æ ˆé¡¶ï¼ŒæŒ‡å‘å½“å‰æ ˆå¸§çš„å¼€å§‹ä½ç½®ã€‚ä½¿ç”¨å½¢å¦‚ symbol+offset(SP) çš„æ–¹å¼ï¼Œå¼•ç”¨å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œä¾‹å¦‚ a+8(SP) æŒ‡ç›¸å¯¹äº SPï¼Œoffset ä¸º +8 çš„åœ°å€ï¼Œå‡å¦‚ SP æŒ‡å‘ 0x000f0, é‚£ä¹ˆ a+8(SP) æŒ‡å‘ 0x000f8ã€‚a æ˜¯ symbolï¼Œå˜é‡åç§°ï¼Œç”¨äºæå‡ä»£ç å¯è¯»æ€§ã€‚</li>
<li>FP Frame pointer: arguments and locals. ç±»ä¼¼ SPï¼Œå®é™…ä½¿ç”¨éå¸¸å°‘ã€‚</li>
<li>PC Program counter: jumps and branches. å­˜æ”¾ CPU ä¸‹ä¸€ä¸ªæ‰§è¡ŒæŒ‡ä»¤çš„ä½ç½®åœ°å€ï¼ŒPC æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œåœ¨ x86 ä¸Šï¼Œé€šè¿‡ CS æ®µå¯„å­˜å™¨å’Œ IP å¯„å­˜å™¨å…±åŒè®¡ç®—å‡ºæŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯PCçš„å€¼ã€‚å…·ä½“ä½¿ç”¨ç¤ºä¾‹JMP 2(PC) ä»¥å½“å‰æŒ‡ä»¤ä¸ºåŸºç¡€ï¼Œå‘åè·³è½¬ 2 è¡Œ</li>
<li>TLS thread local storage å­˜æ”¾äº†å½“å‰æ­£åœ¨æ‰§è¡Œçš„ g çš„ç»“æ„ä½“ã€‚ä¾‹å¦‚ 0(TLS) è¡¨ç¤º g.stack.loï¼Œ8(TLS) è¡¨ç¤º g.stack.hi</li>
</ul>
<h5 id="MOV"><a class="header-anchor" href="#MOV">Â¶</a>MOV</h5>
<blockquote>
<p>movbï¼ˆ8ä½ï¼‰ã€movwï¼ˆ16ä½ï¼‰ã€movlï¼ˆ32ä½ï¼‰ã€movqï¼ˆ64ä½ï¼‰</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">MOVSS: ç§»åŠ¨å•ç²¾åº¦æµ®ç‚¹æ•°</span><br></pre></td></tr></table></figure>
<h4 id="LEAå’ŒMOV"><a class="header-anchor" href="#LEAå’ŒMOV">Â¶</a>LEAå’ŒMOV</h4>
<p>LEAï¼šæ“ä½œåœ°å€<br>
MOVï¼šæ“ä½œæ•°æ®</p>
<p>ä¾‹å­ï¼š<br>
LEAQ 8(SP), SI // argv æŠŠ 8(SP)åœ°å€æ”¾å…¥ SI å¯„å­˜å™¨ä¸­<br>
MOVQ 0(SP), DI // argc æŠŠ0(SP)å†…å®¹æ”¾å…¥ DI å¯„å­˜å™¨ä¸­</p>
<h4 id="Reference"><a class="header-anchor" href="#Reference">Â¶</a>Reference</h4>
<ul>
<li><a href="https://blog.thinkhp.site/plan9/#%E6%9F%A5%E7%9C%8B%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95">â˜ Plan 9æ±‡ç¼–å¸¸è§</a></li>
<li><a href="https://c9x.me/x86/html/file_module_x86_id_205.html">â˜ MOVSS</a></li>
<li><a href="https://www.felixcloutier.com/x86/index.html">â˜ Intelæ±‡ç¼–æŒ‡ä»¤æŸ¥è¯¢</a></li>
<li><a href="https://plan9.io/sources/contrib/ericvh/go-plan9/src/pkg/runtime/slice.c">â˜ Plan9æŸ¥è¯¢</a></li>
<li><a href="http://68k.hax.com/">â˜ æŒ‡ä»¤æŸ¥è¯¢</a></li>
<li><a href="https://9p.io/sys/doc/">â˜ plan9 doc</a></li>
</ul>
<h4 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h4>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Day</tag>
        <tag>Plan9</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ14ã€hexo-å®‰è£…&amp;æ’ä»¶</title>
    <url>/archives/ae4aba0d.html</url>
    <content><![CDATA[<p>hexoå®‰è£…åŠå…¶ç¬¬ä¸‰æ–¹æ’ä»¶åŒ…ä¸‹è½½æ€»ç»“ï¼Œä»¥ä¾¿åç»­CIä¸€æ¬¡åˆ°ä½ã€‚</p>
<span id="more"></span>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"> npm install -g hexo-cli</span><br><span class="line"> npm install hexo-renderer-sass --save</span><br><span class="line"> npm install hexo-generator-searchdb --save</span><br><span class="line"> npm install hexo-generator-sitemap --save</span><br><span class="line"> npm install hexo-generator-baidu-sitemap --save</span><br><span class="line"> npm install request --save</span><br><span class="line"> npm install xml-parser --save</span><br><span class="line"> npm install yamljs --save</span><br><span class="line"> npm install md5 --save</span><br><span class="line"> npm install request --save</span><br><span class="line"> npm install xml-parser --save</span><br><span class="line"> npm install yamljs --save</span><br><span class="line"> npm install cheerio --save</span><br><span class="line"> npm install blueimp-md5 --save</span><br><span class="line"> npm install hexo-abbrlink --save</span><br><span class="line"> npm audit fix</span><br><span class="line"></span><br><span class="line"> npm uninstall hexo-generator-index --save</span><br><span class="line"> npm install hexo-generator-index-pin-top --save</span><br><span class="line"> npm audit fix</span><br><span class="line"> </span><br><span class="line"> npm install hexo-neat --save</span><br><span class="line"> npm audit fix</span><br><span class="line"> npm install --save hexo-admin</span><br><span class="line"> npm audit fix</span><br><span class="line"> npm install hexo-deployer-git --save</span><br><span class="line"> npm audit fix</span><br><span class="line"></span><br><span class="line"> sudo npm install hexo-toc --save</span><br><span class="line"> npm audit fix</span><br><span class="line"></span><br><span class="line"><span class="comment">//çŒ«å’ªæ¨¡å‹</span></span><br><span class="line"> sudo npm install --save hexo-helper-live2d </span><br><span class="line"> npm audit fix</span><br><span class="line"> sudo npm install --save live2d-widget-model-z16</span><br><span class="line"></span><br><span class="line"> <span class="comment">//pdf:</span></span><br><span class="line">npm install --save hexo-pdf</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>update: 2021-02-05 19:25:42</p>
</blockquote>
<p>hexo nextè§£ææ’ä»¶æ›´æ¢ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">npm un hexo-renderer-marked -S</span><br><span class="line"></span><br><span class="line"> npm uninstall hexo-renderer-marked --save</span><br><span class="line"></span><br><span class="line">å†å®‰è£…ä¸‹é¢æ’ä»¶ï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">npm install --save markdown-it-abbr</span><br><span class="line">npm install --save markdown-it-footnote</span><br><span class="line">npm install --save markdown-it-ins</span><br><span class="line">npm install --save markdown-it-sub</span><br><span class="line">npm install --save markdown-it-sup</span><br><span class="line">npm install --save markdown-it-anchor</span><br><span class="line">npm install --save markdown-it-deflist</span><br><span class="line">npm install --save markdown-it-mark</span><br><span class="line">npm install --save markdown-it-container</span><br><span class="line"></span><br><span class="line">npm install --save markdown-it-emoji</span><br><span class="line">npm install --save markdown-it-attrs</span><br><span class="line">npm install --save markdown-it-task-lists</span><br><span class="line">npm install --save markdown-it<span class="number">-68</span>tygbv </span><br><span class="line"></span><br><span class="line">npm install markdown-it-mathjax --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm i markdown-it-latex2img --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install markdown-it-texmath</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br><span class="line">æœ€åæ›´æ–°ä¸‹hexoæ›´ç›®å½•ä¸‹çš„_config.yaml</span><br><span class="line"></span><br><span class="line"># Markdown-it config</span><br><span class="line">## Docs: https:<span class="comment">//github.com/celsomiranda/hexo-renderer-markdown-it/wiki</span></span><br><span class="line">markdown:</span><br><span class="line">  render:</span><br><span class="line">    # Enable HTML tags in source</span><br><span class="line">    html: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    # Use <span class="string">&#x27;/&#x27;</span> to <span class="built_in">close</span> single tags (&lt;br /&gt;). This is only <span class="keyword">for</span> full CommonMark compatibility.</span><br><span class="line">    xhtmlOut: <span class="literal">true</span>        </span><br><span class="line"></span><br><span class="line">    # Convert <span class="string">&#x27;\n&#x27;</span> in paragraphs into &lt;br&gt; </span><br><span class="line">    breaks: <span class="literal">true</span>      </span><br><span class="line"></span><br><span class="line">    # CSS language prefix <span class="keyword">for</span> fenced blocks. Can be useful <span class="keyword">for</span> external highlighters.</span><br><span class="line">    langPrefix: <span class="string">&#x27;language-&#x27;</span>  </span><br><span class="line"></span><br><span class="line">    # Autoconvert URL-like text to links </span><br><span class="line">    linkify: <span class="literal">true</span>        </span><br><span class="line"></span><br><span class="line">    # Enable some language-neutral replacement + quotes beautification</span><br><span class="line">    typographer: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    # Double + single quotes replacement pairs, when typographer enabled,</span><br><span class="line">    # and smartquotes on. Could be either a String or an Array.</span><br><span class="line">    #</span><br><span class="line">    # For example, you can use <span class="string">&#x27;Â«Â»â€â€œ&#x27;</span> <span class="keyword">for</span> Russian, <span class="string">&#x27;â€â€œâ€šâ€˜&#x27;</span> <span class="keyword">for</span> German,</span><br><span class="line">    # and [<span class="string">&#x27;Â«\xA0&#x27;</span>, <span class="string">&#x27;\xA0Â»&#x27;</span>, <span class="string">&#x27;â€¹\xA0&#x27;</span>, <span class="string">&#x27;\xA0â€º&#x27;</span>] <span class="keyword">for</span> French (including nbsp).</span><br><span class="line">    quotes: <span class="string">&#x27;â€œâ€â€˜â€™&#x27;</span></span><br><span class="line"></span><br><span class="line">  # Plugins</span><br><span class="line">  plugins:</span><br><span class="line">    - markdown-it-abbr</span><br><span class="line">    - markdown-it-footnote</span><br><span class="line">    - markdown-it-ins</span><br><span class="line">    - markdown-it-sub</span><br><span class="line">    - markdown-it-sup</span><br><span class="line">    - markdown-it-anchor</span><br><span class="line">    - markdown-it-deflist</span><br><span class="line">    - markdown-it-mark</span><br><span class="line">    - markdown-it-container</span><br><span class="line"></span><br><span class="line">    - markdown-it-emoji</span><br><span class="line">    - markdown-it-named-headings</span><br><span class="line">    - markdown-it-toc</span><br><span class="line">    - markdown-it-attrs</span><br><span class="line">    - name: markdown-it-task-lists</span><br><span class="line">      options:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">        label: <span class="literal">true</span></span><br><span class="line">        labelAfter: <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  # Automatic Headline ID<span class="string">&#x27;s</span></span><br><span class="line"><span class="string">  anchors:</span></span><br><span class="line"><span class="string">    # Minimum level for ID creation. (Ex. h2 to h6)</span></span><br><span class="line"><span class="string">    level: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # A suffix that is prepended to the number given if the ID is repeated.</span></span><br><span class="line"><span class="string">    collisionSuffix: &#x27;</span>v<span class="string">&#x27;           </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # If `true`, creates an anchor tag with a permalink besides the heading.</span></span><br><span class="line"><span class="string">    permalink: false              </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Class used for the permalink anchor tag.</span></span><br><span class="line"><span class="string">    permalinkClass: header-anchor </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # The symbol used to make the permalink</span></span><br><span class="line"><span class="string">    permalinkSymbol: Â¶</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>hexo gulpå…¼å®¹es5:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install gulp --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-minify-css --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-uglify --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-htmlmin --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-htmlclean --save</span><br><span class="line">npm audit fix</span><br><span class="line">npm install gulp-imagemin --save</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br><span class="line">npm install babel-core@6.26.3 --save</span><br><span class="line">npm install gulp-babel@7.0.1 --save</span><br><span class="line">npm install babel-preset-es2015@6.24.1 --save</span><br><span class="line">npm audit fix</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>nextæ–‡ç« åŠ å¯†ç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-blog-encrypt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æœªå®Œå¾…ç»­â€¦</p>
</blockquote>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ13ã€Linux è¿›ç¨‹</title>
    <url>/archives/ba455c1d.html</url>
    <content><![CDATA[<p>è¿›ç¨‹è¿™æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œå½“ç„¶æˆ‘ä¸æ˜¯é‚£ä¸ªè€ç”Ÿï¼Œæˆ‘åªæ˜¯ä¸ªloserã€‚</p>
<p>ä»Šå¤©ç”¨chromeï¼Œå ç”¨å¾ˆå¤šçš„å†…å­˜å’Œèµ„æºï¼ŒæŸ¥äº†æŸ¥ï¼Œè¯´chromeæ˜¯å¤šè¿›ç¨‹çš„ï¼Œäºæ˜¯å°±æƒ³äº†è§£ä¸‹è¿›ç¨‹ä¸€äº›ç›¸å…³çš„å†…å®¹ã€‚<br>
ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦äº†è§£ä¸‹è¿›ç¨‹ï¼š</p>
<ul>
<li>æ¥æº</li>
<li>å®šä¹‰</li>
<li>ç‰¹å¾</li>
<li>å¤šè¿›ç¨‹å¦‚ä½•å·¥ä½œï¼Ÿ</li>
<li>é€šä¿¡</li>
</ul>
<span id="more"></span>
<h3 id="æ¥æº"><a class="header-anchor" href="#æ¥æº">Â¶</a>æ¥æº</h3>
<p>æŠ½è±¡æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œæˆ–è€…è¯´æ˜¯å¯¹è®¡ç®—æœºç³»ç»Ÿå­˜å‚¨å™¨çš„è°ƒåº¦å’Œç®¡ç†ã€‚</p>
<h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰">Â¶</a>å®šä¹‰</h3>
<p>è¿›ç¨‹ï¼šå¹¶å‘ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­èµ„æºåˆ†é…å’Œç®¡ç†çš„æœ€åŸºæœ¬çš„å•å…ƒï¼ˆèµ„æºåˆ†é…çš„æœ€å°å•å…ƒï¼Œæ‰§è¡Œçš„æœ€å°å•å…ƒï¼‰ã€‚ä¸€ä¸ªç¨‹åºä¸€æ—¦å¼€å§‹æ‰§è¡Œï¼Œå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´ï¼Œç³»ç»Ÿä¼šåˆ†é…ä¸€å®šçš„åœ°å€ç©ºé—´å’Œå®Œæ•´çš„æ•°æ®æ®µç©ºé—´ã€‚</p>
<p>ps:[çº¿ç¨‹ï¼šç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½ã€‚]</p>
<p>ç»„æˆï¼šç¨‹åºã€æ•°æ®ã€æ§åˆ¶å—ç»„æˆã€‚</p>
<h3 id="ç‰¹å¾"><a class="header-anchor" href="#ç‰¹å¾">Â¶</a>ç‰¹å¾</h3>
<ul>
<li>åŠ¨æ€æ€§ ï¼š å¤šä¸ªç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œè¿›ç¨‹æ˜¯åŠ¨æ€äº§ç”Ÿï¼ŒåŠ¨æ€é”€æ¯çš„ã€‚</li>
<li>å¹¶å‘æ€§ ï¼š ä»»ä½•è¿›ç¨‹å¯ä»¥å’Œå…¶å®ƒè¿›ç¨‹å¹¶å‘æ‰§è¡Œã€‚</li>
<li>ç‹¬ç«‹æ€§ ï¼š æ˜¯ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•å…ƒï¼Œä¹Ÿæ˜¯èµ„æºåˆ†é…å’Œè°ƒåº¦çš„ç‹¬ç«‹å•å…ƒã€‚</li>
<li>å¼‚æ­¥æ€§ ï¼š ç”±äºè¿›ç¨‹é—´çš„ç›¸äº’åˆ¶çº¦ï¼Œè¿›ç¨‹é—´æ˜¯å„è‡ªç‹¬ç«‹ï¼Œå„è‡ªå‘å‰ã€‚</li>
</ul>
<h3 id="å¤šè¿›ç¨‹å·¥ä½œï¼š"><a class="header-anchor" href="#å¤šè¿›ç¨‹å·¥ä½œï¼š">Â¶</a>å¤šè¿›ç¨‹å·¥ä½œï¼š</h3>
<h4 id="è¿›ç¨‹çš„çŠ¶æ€ï¼š"><a class="header-anchor" href="#è¿›ç¨‹çš„çŠ¶æ€ï¼š">Â¶</a>è¿›ç¨‹çš„çŠ¶æ€ï¼š</h4>
<blockquote>
<p>3ç§çŠ¶æ€ï¼š</p>
</blockquote>
<ul>
<li>å°±ç»ª</li>
<li>è¿è¡Œ</li>
<li>é˜»å¡</li>
</ul>
<h5 id="3æ€å›¾ï¼š"><a class="header-anchor" href="#3æ€å›¾ï¼š">Â¶</a>3æ€å›¾ï¼š</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/linux_process_3.1.png" alt=""></p>
<h5 id="5æ€å›¾ï¼š"><a class="header-anchor" href="#5æ€å›¾ï¼š">Â¶</a>5æ€å›¾ï¼š</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/linux_p3.png" alt=""></p>
<h5 id="7æ€å›¾ï¼š"><a class="header-anchor" href="#7æ€å›¾ï¼š">Â¶</a>7æ€å›¾ï¼š</h5>
<p>æ–°å¢ä¸¤ç§çŠ¶æ€ï¼š</p>
<ul>
<li>æŒ‚èµ·å°±ç»ªçŠ¶æ€ï¼šè¡¨æ˜è¿›ç¨‹å…·å¤‡äº†è¿è¡Œçš„æ¡ä»¶ï¼Œç›®å‰åœ¨äºŒçº§å­˜å‚¨å™¨é‡Œé¢ã€‚</li>
<li>æŒ‚èµ·ç­‰å¾…çŠ¶æ€ï¼šè¡¨æ˜è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸€ä¸ªäº‹ä»¶çš„ç»“æŸä¸”ç›®å‰åœ¨äºŒçº§å­˜å‚¨å™¨é‡Œé¢ã€‚</li>
</ul>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/linux_process_7.png" alt=""></p>
<h3 id="è¿›ç¨‹é—´é€šä¿¡"><a class="header-anchor" href="#è¿›ç¨‹é—´é€šä¿¡">Â¶</a>è¿›ç¨‹é—´é€šä¿¡</h3>
<h4 id="å…±äº«å†…å­˜"><a class="header-anchor" href="#å…±äº«å†…å­˜">Â¶</a>å…±äº«å†…å­˜</h4>
<p>æ˜ å°„ä¸€æ®µèƒ½è¢«å…¶å®ƒè¿›ç¨‹è®¿é—®çš„å†…å­˜ï¼Œä¸€ä¸ªè¿›ç¨‹åˆ›å»ºï¼Œå…¶å®ƒè¿›ç¨‹å¯è®¿é—®ã€‚å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„IPCæ–¹å¼ï¼Œå¾€å¾€å’Œä¿¡å·é‡ä¸€èµ·ä½¿ç”¨ï¼Œè¾¾åˆ°è¿›ç¨‹é—´çš„åŒæ­¥å’Œäº’æ–¥ã€‚</p>
<h4 id="ç®¡é“"><a class="header-anchor" href="#ç®¡é“">Â¶</a>ç®¡é“</h4>
<p>å®è´¨å°±æ˜¯ä¸€ä¸ªç¼“å†²åŒºã€‚<br>
ç®¡é“é™åˆ¶ï¼š</p>
<ul>
<li>åŠåŒå·¥</li>
<li>åªèƒ½åœ¨äº²ç¼˜è¿›ç¨‹é—´é€šä¿¡</li>
</ul>
<p><strong>ç‰¹ç‚¹:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å†™æ»¡æ—¶ï¼Œä¸èƒ½å†å†™ï¼Œè¯»ç©ºæ—¶ï¼Œä¸èƒ½å†è¯»</span><br><span class="line">æ²¡å†™æ»¡ï¼Œä¸èƒ½è¯»ï¼Œæ²¡è¯»ç©ºï¼Œä¸èƒ½å†™</span><br></pre></td></tr></table></figure>
<h4 id="æ¶ˆæ¯é˜Ÿåˆ—"><a class="header-anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—">Â¶</a>æ¶ˆæ¯é˜Ÿåˆ—</h4>
<p>æ˜¯ä¸€ç§æ¶ˆæ¯çš„é“¾è¡¨ï¼Œè§£å†³äº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµåŠç®¡é“å¤§å°é™åˆ¶çš„ç¼ºç‚¹ã€‚</p>
<h4 id="ä¿¡å·"><a class="header-anchor" href="#ä¿¡å·">Â¶</a>ä¿¡å·</h4>
<p>é€šçŸ¥å’Œæ¥å—è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿäº†çš„ã€‚</p>
<h4 id="ä¿¡å·é‡"><a class="header-anchor" href="#ä¿¡å·é‡">Â¶</a>ä¿¡å·é‡</h4>
<p>å®è´¨ä¸Šå°±æ˜¯ä¸ªè®¡æ•°å™¨ï¼Œç”¨æ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹äºå…±äº«èµ„æºçš„è®¿é—®æƒ…å†µã€‚</p>
<h4 id="å¥—æ¥å­—ï¼ˆSocketï¼‰"><a class="header-anchor" href="#å¥—æ¥å­—ï¼ˆSocketï¼‰">Â¶</a>å¥—æ¥å­—ï¼ˆSocketï¼‰</h4>
<p>è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æœºåˆ¶ï¼Œå¤šç”¨äºä¸åŒæœºå™¨è¿›ç¨‹é—´çš„é€šä¿¡ã€‚</p>
<h4 id="ä¼˜ç¼ºç‚¹ï¼š"><a class="header-anchor" href="#ä¼˜ç¼ºç‚¹ï¼š">Â¶</a>ä¼˜ç¼ºç‚¹ï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>ã€ç®¡é“ï¼šé€Ÿåº¦æ…¢ï¼Œå®¹é‡æœ‰é™ï¼Œåªæœ‰çˆ¶å­è¿›ç¨‹èƒ½é€šè®¯.</span><br><span class="line"><span class="number">2</span>ã€FIFOï¼šä»»ä½•è¿›ç¨‹é—´éƒ½èƒ½é€šè®¯ï¼Œä½†é€Ÿåº¦æ…¢.</span><br><span class="line"><span class="number">3</span>ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼šå®¹é‡å—åˆ°ç³»ç»Ÿé™åˆ¶ï¼Œä¸”è¦æ³¨æ„ç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™ï¼Œè¦è€ƒè™‘ä¸Šä¸€æ¬¡æ²¡æœ‰è¯»å®Œæ•°æ®çš„é—®é¢˜.</span><br><span class="line"><span class="number">4</span>ã€ä¿¡å·é‡ï¼šä¸èƒ½ä¼ é€’å¤æ‚æ¶ˆæ¯ï¼Œåªèƒ½ç”¨æ¥åŒæ­¥.</span><br><span class="line"><span class="number">5</span>ã€å…±äº«å†…å­˜åŒºï¼šèƒ½å¤Ÿå¾ˆå®¹æ˜“æ§åˆ¶å®¹é‡ï¼Œé€Ÿåº¦å¿«ï¼Œä½†è¦ä¿æŒåŒæ­¥ï¼Œæ¯”å¦‚ä¸€ä¸ªè¿›ç¨‹åœ¨å†™çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹è¦æ³¨æ„è¯»å†™çš„é—®é¢˜ï¼Œç›¸å½“äºçº¿ç¨‹ä¸­çš„çº¿ç¨‹å®‰å…¨ï¼Œå½“ç„¶ï¼Œå…±äº«å†…å­˜åŒºåŒæ ·å¯ä»¥ç”¨ä½œçº¿ç¨‹é—´é€šè®¯ï¼Œä¸è¿‡æ²¡è¿™ä¸ªå¿…è¦ï¼Œçº¿ç¨‹é—´æœ¬æ¥å°±å·²ç»å…±äº«äº†åŒä¸€è¿›ç¨‹å†…çš„ä¸€å—å†…å­˜.</span><br></pre></td></tr></table></figure>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>è¿›ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ12ã€go æŒ‡é’ˆå’Œå¼•ç”¨</title>
    <url>/archives/1191d613.html</url>
    <content><![CDATA[<p>ä»Šå†™ä»£ç æ—¶ï¼Œä¼ å‡½æ•°æ— æ„é—´æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œsliceé€šè¿‡å‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œä¸ºä½•å¯ä»¥æ”¹å˜å…·ä½“çš„å€¼å‘¢ï¼Ÿ</p>
<p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</p>
<ul>
<li>å®˜æ–¹æŸ¥æ–‡æ¡£</li>
<li>çœ‹æºç </li>
<li>googleçœ‹çœ‹æœ‰æ²¡æœ‰å¥½çš„è§è§£</li>
<li>æ€è€ƒğŸ¤”+å†¥æƒ³ğŸ§˜â€â™‚ï¸</li>
</ul>
<p>ï¼ˆps:è§£å†³é—®é¢˜ï¼Œä¸»è¦ä¸æ˜¯çœ‹ç»“æœæ˜¯æ€ä¹ˆæ ·çš„ï¼Œä¸»è¦æ˜¯è€ƒè™‘é—®é¢˜çš„è§’åº¦ï¼‰</p>
<span id="more"></span>
<h3 id="æŸ¥èµ„æ–™"><a class="header-anchor" href="#æŸ¥èµ„æ–™">Â¶</a>æŸ¥èµ„æ–™</h3>
<p><a href="https://golang.google.cn/doc/effective_go.html#slices">å®˜ç½‘æŒ‡å—ä¹‹Slice</a><br>
æœ‰ä¸€æ®µæ˜¯è¿™ä¹ˆæè¿°ï¼š<br>
<em>Slices hold references to an underlying array, and if you assign one slice to another, both refer to the same array.</em></p>
<h3 id="æŸ¥æºç "><a class="header-anchor" href="#æŸ¥æºç ">Â¶</a>æŸ¥æºç </h3>
<h4 id="src-runtime-slice-go"><a class="header-anchor" href="#src-runtime-slice-go">Â¶</a>/src/runtime/slice.go</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">	array unsafe.Pointer  <span class="comment">//æŒ‡é’ˆç±»å‹å“¦</span></span><br><span class="line">	<span class="built_in">len</span>   <span class="type">int</span></span><br><span class="line">	<span class="built_in">cap</span>   <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€è€ƒ"><a class="header-anchor" href="#æ€è€ƒ">Â¶</a>æ€è€ƒ</h3>
<blockquote>
<p>åŸæ¥ä¸‹å±‚æ˜¯ç”¨è¿‡arrayè¿™ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å…·ä½“çš„æ•°æ®çš„</p>
</blockquote>
<blockquote>
<p>é‚£ä¹ˆå…¶ä»–çš„å¼•ç”¨ç±»å‹å‘¢ï¼Ÿ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map?</span><br><span class="line">chan?</span><br><span class="line">interface?</span><br><span class="line">//Slice?</span><br></pre></td></tr></table></figure>
<h3 id="å¼•ç”¨ç±»å‹ä¹‹Map"><a class="header-anchor" href="#å¼•ç”¨ç±»å‹ä¹‹Map">Â¶</a>å¼•ç”¨ç±»å‹ä¹‹Map</h3>
<h4 id="çœ‹æºç -src-runtime-map-goï¼š"><a class="header-anchor" href="#çœ‹æºç -src-runtime-map-goï¼š">Â¶</a>çœ‹æºç  /src/runtime/map.goï¼š</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// A header for a Go map.</span></span><br><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span></span><br><span class="line">	<span class="comment">// Make sure this stays in sync with the compiler&#x27;s definition.</span></span><br><span class="line">	count     <span class="type">int</span> <span class="comment">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class="line">	flags     <span class="type">uint8</span></span><br><span class="line">	B         <span class="type">uint8</span>  <span class="comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class="line">	noverflow <span class="type">uint16</span> <span class="comment">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class="line">	hash0     <span class="type">uint32</span> <span class="comment">// hash seed</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡æ­¤æŒ‡é’ˆç±»å‹</span></span><br><span class="line">	buckets    unsafe.Pointer <span class="comment">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class="line">	oldbuckets unsafe.Pointer <span class="comment">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class="line">	nevacuate  <span class="type">uintptr</span>        <span class="comment">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class="line"></span><br><span class="line">	extra *mapextra <span class="comment">// optional fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼•ç”¨ç±»å‹ä¹‹Chan"><a class="header-anchor" href="#å¼•ç”¨ç±»å‹ä¹‹Chan">Â¶</a>å¼•ç”¨ç±»å‹ä¹‹Chan</h3>
<h4 id="æºç -src-runtime-chan-go"><a class="header-anchor" href="#æºç -src-runtime-chan-go">Â¶</a>æºç :/src/runtime/chan.go</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">	qcount   <span class="type">uint</span>           <span class="comment">// total data in the queue</span></span><br><span class="line">    dataqsiz <span class="type">uint</span>           <span class="comment">// size of the circular queue</span></span><br><span class="line">    <span class="comment">//é€šè¿‡æ­¤æŒ‡é’ˆç±»å‹æ¥å¤„ç†</span></span><br><span class="line">	buf      unsafe.Pointer <span class="comment">// points to an array of dataqsiz elements</span></span><br><span class="line">	elemsize <span class="type">uint16</span></span><br><span class="line">	closed   <span class="type">uint32</span></span><br><span class="line">	elemtype *_type <span class="comment">// element type</span></span><br><span class="line">	sendx    <span class="type">uint</span>   <span class="comment">// send index</span></span><br><span class="line">	recvx    <span class="type">uint</span>   <span class="comment">// receive index</span></span><br><span class="line">	recvq    waitq  <span class="comment">// list of recv waiters</span></span><br><span class="line">	sendq    waitq  <span class="comment">// list of send waiters</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// lock protects all fields in hchan, as well as several</span></span><br><span class="line">	<span class="comment">// fields in sudogs blocked on this channel.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Do not change another G&#x27;s status while holding this lock</span></span><br><span class="line">	<span class="comment">// (in particular, do not ready a G), as this can deadlock</span></span><br><span class="line">	<span class="comment">// with stack shrinking.</span></span><br><span class="line">	lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼•ç”¨ç±»å‹ä¹‹Interface"><a class="header-anchor" href="#å¼•ç”¨ç±»å‹ä¹‹Interface">Â¶</a>å¼•ç”¨ç±»å‹ä¹‹Interface</h3>
<h4 id="æºç -src-runtime-runtime2-go"><a class="header-anchor" href="#æºç -src-runtime-runtime2-go">Â¶</a>æºç /src/runtime/runtime2.go</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> iface <span class="keyword">struct</span> &#123;</span><br><span class="line">    tab  *itab</span><br><span class="line">    <span class="comment">//æŒ‡é’ˆç±»å‹</span></span><br><span class="line">	data unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> eface <span class="keyword">struct</span> &#123;</span><br><span class="line">    _type *_type</span><br><span class="line">    <span class="comment">//æŒ‡é’ˆç±»å‹</span></span><br><span class="line">	data  unsafe.Pointer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç»“è®ºï¼Ÿé€šè¿‡æŒ‡é’ˆï¼Ÿ"><a class="header-anchor" href="#ç»“è®ºï¼Ÿé€šè¿‡æŒ‡é’ˆï¼Ÿ">Â¶</a>ç»“è®ºï¼Ÿé€šè¿‡æŒ‡é’ˆï¼Ÿ</h3>
<p>ä»ä¸Šè¿°æºç çœ‹æ¥ï¼Œå†…éƒ¨ç»“æ„ä¸­éƒ½æ˜¯ç”¨æŒ‡é’ˆç±»å‹æ¥æŒ‡å‘å…·ä½“çš„å€¼ï¼Œ</p>
<blockquote>
<p>Soï¼šå½¢åŒè¿™ç±»çš„ç»“æ„ï¼Œè‚¯å®šæ˜¯å¼•ç”¨ç±»å‹çš„ï¼Œå…·ä½“æ˜¯æŒ‡é’ˆæŒ‡å‘åˆ«çš„åœ°å€ï¼Œä»è€Œæ¥å¼•ç”¨å€¼ã€‚</p>
</blockquote>
<p>å…¶å®è¿™ä¸ªç‰¹æ€§å¾ˆæ—©å°±æ™“å¾—äº†ï¼Œåªæ˜¯ä»Šå¤©åˆçœ‹åˆ°äº†ï¼Œè§‰å¾—è¿˜æ˜¯è®°å½•ç€å§ï¼Œä¹Ÿè®¸åç»­å“ªä¸€å¤©å°±æœ‰äº†åˆ›æ–°çš„çµæ„Ÿæ¥ç€~~.</p>
<p>[ç¡è§‰äº†ï½æœ€è¿‘æœ‰ç‚¹ä¹ï½ZZzzzâ€¦]</p>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Go Package</tag>
        <tag>Day</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ11ã€hexo ä¸»é¢˜&amp;è¯„è®º&amp;è¿›åº¦æ¡&amp;èƒŒæ™¯æ•ˆæœ</title>
    <url>/archives/e18c94ab.html</url>
    <content><![CDATA[<p>æ™šä¸ŠæŠ˜è…¾äº†ä¸‹åšå®¢ï¼Œç¨å¾®è£…é¥°äº†ä¸‹ï¼Œä¸»è¦è¿˜æ˜¯åŠ äº†ä¸ªè¯„è®ºå§ï¼Œå…¶å®ƒéå¸¸ç§€çš„æ’ä»¶å°±æ²¡æœ‰æ¥å…¥äº†ï¼Œæ‡’å¾—æŠ˜è…¾ï¼Œå¥½å¥½å†™åšå®¢ï¼Œå†…å®¹æ‰æ˜¯ç²¾åã€‚<br>
è®°å½•ä¸‹æŠ˜è…¾å²ï¼š</p>
<h3 id="gitalkè¯„è®ºæ’ä»¶"><a class="header-anchor" href="#gitalkè¯„è®ºæ’ä»¶">Â¶</a>gitalkè¯„è®ºæ’ä»¶</h3>
<h4 id="æ­¥éª¤ï¼š"><a class="header-anchor" href="#æ­¥éª¤ï¼š">Â¶</a>æ­¥éª¤ï¼š</h4>
<h5 id="ç”³è¯·idå’Œsecret"><a class="header-anchor" href="#ç”³è¯·idå’Œsecret">Â¶</a>ç”³è¯·idå’Œsecret</h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/36f31671-8ada-4cbe-b60b-d1595dd701ee.png" alt=""></p>
<span id="more"></span>
<h4 id="é…ç½®æ–‡ä»¶ï¼š"><a class="header-anchor" href="#é…ç½®æ–‡ä»¶ï¼š">Â¶</a>é…ç½®æ–‡ä»¶ï¼š</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gitalk:</span><br><span class="line">  enable: true</span><br><span class="line">  github_id: crab21 # GitHub repo owner</span><br><span class="line">  repo: blog # Repository name to store issues</span><br><span class="line">  client_id: XXX # GitHub Application Client ID</span><br><span class="line">  client_secret: XXX # GitHub Application Client Secret</span><br><span class="line">  admin_user: crab21 # GitHub repo owner and collaborators, only these guys can initialize gitHub issues</span><br><span class="line">  distraction_free_mode: true # Facebook-like distraction free mode</span><br><span class="line">  perPage: 15 #æ¯é¡µå¤šå°‘ä¸ªè¯„è®º</span><br><span class="line">  pagerDirection: last  #æ’åºæ–¹å¼æ˜¯ä»æ—§åˆ°æ–°ï¼ˆfirstï¼‰è¿˜æ˜¯ä»æ–°åˆ°æ—§ï¼ˆlastï¼‰</span><br><span class="line">  createIssueManually: true #å¦‚æœå½“å‰é¡µé¢æ²¡æœ‰ç›¸åº”çš„ isssue ï¼Œä¸”ç™»å½•çš„ç”¨æˆ·å±äº adminï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»º issueã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™æ˜¾ç¤ºä¸€ä¸ªåˆå§‹åŒ–é¡µé¢ï¼Œåˆ›å»º issue éœ€è¦ç‚¹å‡» init æŒ‰é’®ã€‚</span><br><span class="line">  distractionFreeMode: true #æ˜¯å¦å¯ç”¨å¿«æ·é”®(cmd|ctrl + enter) æäº¤è¯„è®º.</span><br><span class="line"></span><br><span class="line">  # Gitalk&#x27;s display language depends on user&#x27;s browser or system environment</span><br><span class="line">  # If you want everyone visiting your site to see a uniform language, you can set a force language value</span><br><span class="line">  # Available values: en | es-ES | fr | ru | zh-CN | zh-TW</span><br><span class="line">  language:</span><br></pre></td></tr></table></figure>
<h3 id="pacé˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”"><a class="header-anchor" href="#pacé˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”">Â¶</a>pacé˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”</h3>
<p>1ã€githubåœ°å€ï¼š https://github.com/HubSpot/paceï¼Œå¯ä»¥çœ‹ä¸‹ä»‹ç»<br>
2ã€ä¿®æ”¹å€¼ï¼š<br>
ä¿®æ”¹ä¸»é¢˜ä¸‹é¢çš„_config.ymlï¼š<br>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pace:</span><br><span class="line">    enable: <span class="literal">true</span></span><br><span class="line">    # Themes list:</span><br><span class="line">    # big-counter | bounce | barber-shop | center-atom | center-circle | center-radar | center-simple</span><br><span class="line">    # corner-indicator | fill-left | flat-top | flash | loading-bar | mac-osx | material | minimal</span><br><span class="line">    theme: minimal</span><br></pre></td></tr></table></figure></p>
<h3 id="reading-progress"><a class="header-anchor" href="#reading-progress">Â¶</a>reading_progress</h3>
<p>githubåœ°å€ï¼šhttps://github.com/theme-next/theme-next-reading-progress</p>
<p>åŒ…å«ä½¿ç”¨è¯´æ˜å’Œå…·ä½“çš„æ­¥éª¤ï¼Œå°±ä¸æ¬è¿äº†ï¼ŒåŠæ—¶è°ƒæ•´ã€‚</p>
<h3 id="æ–‡ç« å­—æ•°å’Œé˜…è¯»æ—¶é—´ç»Ÿè®¡ï¼š"><a class="header-anchor" href="#æ–‡ç« å­—æ•°å’Œé˜…è¯»æ—¶é—´ç»Ÿè®¡ï¼š">Â¶</a>æ–‡ç« å­—æ•°å’Œé˜…è¯»æ—¶é—´ç»Ÿè®¡ï¼š</h3>
<p>hexoé…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ï¼š<br>
<code>symbols_count_time</code> ä¸ºtrue.</p>
<h3 id="back2top"><a class="header-anchor" href="#back2top">Â¶</a>back2top</h3>
<p>å¼€å¯æ¨¡å¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">back2top:</span><br><span class="line">  enable: true</span><br><span class="line">  # Back to top in sidebar.</span><br><span class="line">  sidebar: true</span><br><span class="line">  # Scroll percent label in b2t button.</span><br><span class="line">  scrollpercent: true</span><br></pre></td></tr></table></figure>
<h3 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h3>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>hexo</tag>
        <tag>hexoæ’ä»¶</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ10ã€go mutexè§£è¯»</title>
    <url>/archives/ff0d6c2b.html</url>
    <content><![CDATA[<p>ä¸Šæ¬¡è¯´åˆ°rwmutexè¯»å†™é”ï¼Œå…¶å®å°±æ˜¯åŠ å¼ºäº†é”çš„ç²’åº¦ï¼ŒåŒºåˆ†è¯»å’Œå†™æ—¶ä¸åŒçš„æƒ…å†µï¼Œæ ¸å¿ƒæ€æƒ³ï¼šå†™ä¼˜å…ˆäºè¯»ã€‚<br>
è¿™æ¬¡æ¥çœ‹çœ‹mutexï¼Œgoä¸­çš„é”æ˜¯å¦‚ä½•å®ç°çš„ï¼Œç”¨ä¸€å¼ å›¾æ¥æ¦‚æ‹¬æ•´ä¸ªæµç¨‹ï¼š</p>
<span id="more"></span>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/mutex.png" alt=""></p>
<blockquote>
<p>æ ¸å¿ƒæ€æƒ³ï¼šé¥¥é¥¿å’Œé˜Ÿåˆ—ï¼Œæ­£å¸¸æµç¨‹éƒ½æ˜¯åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´é™åˆ¶åˆ™åŠ å…¥åˆ°é˜Ÿåˆ—å¤´éƒ¨ã€‚</p>
</blockquote>
<h3 id="å‰åº"><a class="header-anchor" href="#å‰åº">Â¶</a>å‰åº</h3>
<blockquote>
<p>å¼€å§‹çœ‹ä»£ç æˆ–è€…åˆ†æä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹æ–‡æ¡£è¯´æ˜åŠå…¶ç›¸å…³çš„èµ„æ–™ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â—¯  go version</span><br><span class="line">go version go1.14.9 darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="src-sync-mutex-go"><a class="header-anchor" href="#src-sync-mutex-go">Â¶</a>src/sync/mutex.go</h3>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	mutexLocked = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span> <span class="comment">// mutex is locked      state &amp; mutexLocked 1==åŠ é”  0==æœªåŠ é”</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	mutexWoken                                      <span class="comment">//state &amp; mutexWoken 1==å”¤é†’  0==æœªå”¤é†’</span></span><br><span class="line">	mutexStarving                                   <span class="comment">// state &amp; mutexStarving 1==é¥¥é¥¿çŠ¶æ€   0==æ­£å¸¸çŠ¶æ€</span></span><br><span class="line">	mutexWaiterShift = <span class="literal">iota</span>                         <span class="comment">// state &gt;&gt; mutexWaiterShiftå¾—åˆ°å½“å‰çš„goroutineæ•°é‡</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Mutex fairness.</span></span><br><span class="line">	<span class="comment">// ä¸¤ç§æ¨¡å¼ï¼šæ­£å¸¸æˆ–é¥¥é¥¿</span></span><br><span class="line">    <span class="comment">// Mutex can be in 2 modes of operations: normal and starvation.</span></span><br><span class="line">    <span class="comment">//  æ­£å¸¸æ¨¡å¼å°±æ˜¯FIFOé˜Ÿåˆ—ã€‚</span></span><br><span class="line">	<span class="comment">// In normal mode waiters are queued in FIFO order, but a woken up waiter</span></span><br><span class="line">	<span class="comment">// does not own the mutex and competes with new arriving goroutines over</span></span><br><span class="line">	<span class="comment">// the ownership. New arriving goroutines have an advantage -- they are</span></span><br><span class="line">	<span class="comment">// already running on CPU and there can be lots of them, so a woken up</span></span><br><span class="line">	<span class="comment">// waiter has good chances of losing. In such case it is queued at front</span></span><br><span class="line">	<span class="comment">// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,  //è·å–é”çš„æ—¶é—´è¶…è¿‡1msï¼Œåˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">	<span class="comment">// it switches mutex to the starvation mode.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// In starvation mode ownership of the mutex is directly handed off from        //é¥¥é¥¿æ¨¡å¼ä¸‹é”çš„æ‰€æœ‰æƒç›´æ¥ä»è§£é”goroutineçš„waiteræ‰‹ä¸­ç§»äº¤åˆ°é˜Ÿåˆ—çš„å‰é¢ã€‚</span></span><br><span class="line">	<span class="comment">// the unlocking goroutine to the waiter at the front of the queue.</span></span><br><span class="line">	<span class="comment">// New arriving goroutines don&#x27;t try to acquire the mutex even if it appears</span></span><br><span class="line">	<span class="comment">// to be unlocked, and don&#x27;t try to spin. Instead they queue themselves at</span></span><br><span class="line">	<span class="comment">// the tail of the wait queue.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// If a waiter receives ownership of the mutex and sees that either         //å¦‚æœä¸€ä¸ªé”çš„æ‰€æœ‰æƒçš„ç­‰å¾…è€…æ˜¯ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€çš„ï¼š1ã€å¤„äºé˜Ÿåˆ—çš„æœ€åä¸€ä¸ª2ã€ç­‰å¾…æ—¶é—´å°‘äº1msï¼Œåˆ™åˆ‡æ¢åˆ°æ­£å¸¸æ¨¡å¼</span></span><br><span class="line">	<span class="comment">// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,</span></span><br><span class="line">	<span class="comment">// it switches mutex back to normal operation mode.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Normal mode has considerably better performance as a goroutine can acquire</span></span><br><span class="line">	<span class="comment">// a mutex several times in a row even if there are blocked waiters.</span></span><br><span class="line">	<span class="comment">// Starvation mode is important to prevent pathological cases of tail latency.</span></span><br><span class="line">	starvationThresholdNs = <span class="number">1e6</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="åŠ é”æµç¨‹"><a class="header-anchor" href="#åŠ é”æµç¨‹">Â¶</a>åŠ é”æµç¨‹</h3>
<blockquote>
<p>åŠ é”è¿‡ç¨‹å›¾å¦‚ä¸Šå›¾æåˆ°çš„æµç¨‹ã€‚</p>
</blockquote>
<blockquote>
<p>åŠ é”ä»£ç å…·ä½“æµç¨‹ï¼š</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Lock() &#123;</span><br><span class="line">	<span class="comment">// Fast path: grab unlocked mutex.</span></span><br><span class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</span><br><span class="line">		<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">			race.Acquire(unsafe.Pointer(m))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Slow path (outlined so that the fast path can be inlined)</span></span><br><span class="line">	m.lockSlow()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> lockSlow() &#123;</span><br><span class="line">	<span class="keyword">var</span> waitStartTime <span class="type">int64</span> <span class="comment">//ç­‰å¾…æ—¶é—´</span></span><br><span class="line">	starving := <span class="literal">false</span>       <span class="comment">//æ˜¯å¦å¤„äºé¥¥é¥¿çŠ¶æ€</span></span><br><span class="line">	awoke := <span class="literal">false</span>          <span class="comment">//å”¤é†’çŠ¶æ€</span></span><br><span class="line">	iter := <span class="number">0</span>               <span class="comment">//è‡ªæ—‹æ¬¡æ•°</span></span><br><span class="line">	old := m.state          <span class="comment">//å½“å‰çŠ¶æ€copy</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// Don&#x27;t spin in starvation mode, ownership is handed off to waiters</span></span><br><span class="line">        <span class="comment">// so we won&#x27;t be able to acquire the mutex anyway.</span></span><br><span class="line">        <span class="comment">//åŠ é”ä¸”èƒ½å¤Ÿè‡ªæ—‹</span></span><br><span class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</span><br><span class="line">			<span class="comment">// Active spinning makes sense.</span></span><br><span class="line">			<span class="comment">// Try to set mutexWoken flag to inform Unlock</span></span><br><span class="line">            <span class="comment">// to not wake other blocked goroutines.</span></span><br><span class="line">            <span class="comment">//è‡ªæ—‹è¿‡ç¨‹å‘ç°æ²¡æœ‰è¢«ç½®wokenæ ‡è¯†ï¼Œè®¾ç½®æ ‡è¯†ï¼Œå°†è‡ªå·±ç½®ä¸ºå”¤é†’</span></span><br><span class="line">			<span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</span><br><span class="line">				atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</span><br><span class="line">				awoke = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			runtime_doSpin()    <span class="comment">//è‡ªæ—‹</span></span><br><span class="line">			iter++              </span><br><span class="line">			old = m.state       <span class="comment">//çŠ¶æ€é‡ç½®</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ›´æ–°çŠ¶æ€</span></span><br><span class="line">		<span class="built_in">new</span> := old</span><br><span class="line">        <span class="comment">// Don&#x27;t try to acquire starving mutex, new arriving goroutines must queue.</span></span><br><span class="line">        <span class="comment">//éé¥¥é¥¿æ¨¡å¼ï¼Œåˆ™ç½®é”</span></span><br><span class="line">		<span class="keyword">if</span> old&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">new</span> |= mutexLocked</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œæ–°æ¥çš„goroutineè¿›å…¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">new</span> += <span class="number">1</span> &lt;&lt; mutexWaiterShift</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// The current goroutine switches mutex to starvation mode.</span></span><br><span class="line">		<span class="comment">// But if the mutex is currently unlocked, don&#x27;t do the switch.</span></span><br><span class="line">		<span class="comment">// Unlock expects that starving mutex has waiters, which will not</span></span><br><span class="line">        <span class="comment">// be true in this case.</span></span><br><span class="line">        <span class="comment">//åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ä¸‹</span></span><br><span class="line">		<span class="keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">new</span> |= mutexStarving</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å½“å‰å¤„äºå”¤é†’çŠ¶æ€ï¼Œåˆ™é‡ç½®æ¸…é™¤å”¤é†’çŠ¶æ€ã€‚</span></span><br><span class="line">		<span class="keyword">if</span> awoke &#123;</span><br><span class="line">			<span class="comment">// The goroutine has been woken from sleep,</span></span><br><span class="line">			<span class="comment">// so we need to reset the flag in either case.</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</span><br><span class="line">				throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">new</span> &amp;^= mutexWoken</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//CASæ›´æ–°çŠ¶æ€ã€‚</span></span><br><span class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line">            <span class="comment">//è·å–åˆ°é”</span></span><br><span class="line">			<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">break</span> <span class="comment">// locked the mutex with CAS</span></span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// If we were already waiting before, queue at the front of the queue.</span></span><br><span class="line">            <span class="comment">//ç­‰å¾…é˜Ÿåˆ—çš„æ—¶é—´</span></span><br><span class="line">			queueLifo := waitStartTime != <span class="number">0</span></span><br><span class="line">			<span class="keyword">if</span> waitStartTime == <span class="number">0</span> &#123;</span><br><span class="line">				waitStartTime = runtime_nanotime()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//acquireé˜»å¡é˜Ÿåˆ—....</span></span><br><span class="line">            <span class="comment">// æ–°æ¥çš„ goroutine, queueLifo=false, åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œè€å¿ƒç­‰å¾…</span></span><br><span class="line">            <span class="comment">// å”¤é†’çš„ goroutine, queueLifo=true, åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å¤´éƒ¨</span></span><br><span class="line">			runtime_SemacquireMutex(&amp;m.sema, queueLifo, <span class="number">1</span>)</span><br><span class="line">			starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</span><br><span class="line">            old = m.state</span><br><span class="line">            <span class="comment">//å¤„äºé¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">			<span class="keyword">if</span> old&amp;mutexStarving != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// If this goroutine was woken and mutex is in starvation mode,</span></span><br><span class="line">				<span class="comment">// ownership was handed off to us but mutex is in somewhat</span></span><br><span class="line">				<span class="comment">// inconsistent state: mutexLocked is not set and we are still</span></span><br><span class="line">				<span class="comment">// accounted as waiter. Fix that.</span></span><br><span class="line">				<span class="keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="number">0</span> &#123;</span><br><span class="line">					throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ç­‰å¾…çš„goroutine-1</span></span><br><span class="line">                delta := <span class="type">int32</span>(mutexLocked - <span class="number">1</span>&lt;&lt;mutexWaiterShift)</span><br><span class="line">                <span class="comment">// å¤„äºé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæˆ–è€…è¯·æ±‚é”çš„æ—¶é—´æœªè¶…è¿‡starvationThresholdNsï¼Œåˆ™å›é€€åˆ°æ­£å¸¸æ¨¡å¼ã€‚</span></span><br><span class="line">				<span class="keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="number">1</span> &#123;</span><br><span class="line">					<span class="comment">// Exit starvation mode.</span></span><br><span class="line">					<span class="comment">// Critical to do it here and consider wait time.</span></span><br><span class="line">					<span class="comment">// Starvation mode is so inefficient, that two goroutines</span></span><br><span class="line">					<span class="comment">// can go lock-step infinitely once they switch mutex</span></span><br><span class="line">					<span class="comment">// to starvation mode.</span></span><br><span class="line">					delta -= mutexStarving</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//æ›´æ–°çŠ¶æ€</span></span><br><span class="line">				atomic.AddInt32(&amp;m.state, delta)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é‡ç½®è¿­ä»£å™¨å’Œå”¤é†’è¡¨ç¤ºï¼Œç»§ç»­è·å–é”</span></span><br><span class="line">			awoke = <span class="literal">true</span></span><br><span class="line">			iter = <span class="number">0</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//CASå¤±è´¥ï¼Œåˆ™æ›´æ–°çŠ¶æ€ï¼Œç»§ç»­è·å–ã€‚</span></span><br><span class="line">			old = m.state</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Acquire(unsafe.Pointer(m))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="è§£é”è¿‡ç¨‹"><a class="header-anchor" href="#è§£é”è¿‡ç¨‹">Â¶</a>è§£é”è¿‡ç¨‹</h3>
<p>ç”¨ä¸€ä¸ªæµç¨‹å›¾æ¥è¡¨ç¤ºè§£é”è¿‡ç¨‹ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/mutex-unlock.png" alt=""></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Unlock() &#123;</span><br><span class="line">    <span class="comment">//state ä¸æ˜¯å¤„äºé”çš„çŠ¶æ€, é‚£ä¹ˆå°±æ˜¯ Unlock æ ¹æœ¬æ²¡æœ‰åŠ é”çš„ mutex, panic</span></span><br><span class="line">    <span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123;</span><br><span class="line">        throw(<span class="string">&quot;sync: unlock of unlocked mutex&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”ï¼Œå¹¶é€šçŸ¥å…¶å®ƒç­‰å¾…è€…</span></span><br><span class="line">    <span class="comment">// é”å¦‚æœå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œç›´æ¥äº¤ç»™ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª, å”¤é†’å®ƒï¼Œè®©å®ƒå»è·å–é”</span></span><br><span class="line">    <span class="comment">// mutex æ­£å¸¸æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line">        old := <span class="built_in">new</span></span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰ç­‰å¾…è€…ï¼Œæˆ–è€…å·²ç»å­˜åœ¨ä¸€ä¸ª goroutine è¢«å”¤é†’æˆ–å¾—åˆ°é”ã€æˆ–å¤„äºé¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">            <span class="comment">// ç›´æ¥è¿”å›.</span></span><br><span class="line">            <span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†ç­‰å¾…çš„ goroutine-1ï¼Œå¹¶è®¾ç½® woken æ ‡è¯†</span></span><br><span class="line">            <span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</span><br><span class="line">            <span class="comment">// è®¾ç½®æ–°çš„ state, è¿™é‡Œé€šè¿‡ä¿¡å·é‡ä¼šå”¤é†’ä¸€ä¸ªé˜»å¡çš„ goroutine å»è·å–é”.</span></span><br><span class="line">            <span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line">                runtime_Semrelease(&amp;m.sema, <span class="literal">false</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            old = m.state</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// mutex é¥¥é¥¿æ¨¡å¼ï¼Œç›´æ¥å°† mutex æ‹¥æœ‰æƒç§»äº¤ç»™ç­‰å¾…é˜Ÿåˆ—æœ€å‰ç«¯çš„ goroutine</span></span><br><span class="line">        <span class="comment">// æ³¨æ„æ­¤æ—¶ state çš„ mutex è¿˜æ²¡æœ‰åŠ é”ï¼Œå”¤é†’çš„ goroutine ä¼šè®¾ç½®å®ƒã€‚</span></span><br><span class="line">        <span class="comment">// åœ¨æ­¤æœŸé—´ï¼Œå¦‚æœæœ‰æ–°çš„ goroutine æ¥è¯·æ±‚é”ï¼Œ å› ä¸º mutex å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œ mutex è¿˜æ˜¯è¢«è®¤ä¸ºå¤„äºé”çŠ¶æ€ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ–°æ¥çš„ goroutine ä¸ä¼šæŠŠé”æŠ¢è¿‡å».</span></span><br><span class="line">        runtime_Semrelease(&amp;m.sema, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="å…³é”®ç‚¹"><a class="header-anchor" href="#å…³é”®ç‚¹">Â¶</a>å…³é”®ç‚¹</h3>
<ul>
<li>ä¸è¦é‡å¤é”å®šäº’æ–¥é”</li>
<li>ä¸è¦å¿˜è®°è§£é”äº’æ–¥é”</li>
<li>ä¸è¦åœ¨å¤šä¸ªå‡½æ•°ä¹‹é—´ç›´æ¥ä¼ é€’äº’æ–¥é”</li>
</ul>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Go Package</tag>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ9ã€Go reflect ~ DeepEqual</title>
    <url>/archives/e2e7cc4e.html</url>
    <content><![CDATA[<p>ä»Šå¤©æ— æ„ä¸­çœ‹åˆ°Go101å‘äº†ä¸€ä¸ªæ¨ç‰¹:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">p</span><span class="params">(a, b <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">  fmt.Print(<span class="string">&quot;:&quot;</span>, reflect.DeepEqual(a, b))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  a := [<span class="number">1</span>]<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;&#125;&#125;</span><br><span class="line">  p(a, a)</span><br><span class="line">  p(a[:], a[:])</span><br><span class="line">  b := a</span><br><span class="line">  p(a[:], b[:])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¾“å‡ºç»“æœï¼Ÿï¼Ÿ :true:true:false</p>
</blockquote>
<span id="more"></span>
<blockquote>
<p>æ­£ç¡®ç­”æ¡ˆ :false:true:false</p>
</blockquote>
<h3 id="é”™è¯¯æ¥æº"><a class="header-anchor" href="#é”™è¯¯æ¥æº">Â¶</a>é”™è¯¯æ¥æº</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç¬¬ä¸€ä¸ªä¸ºå•¥æƒ³ç€ä¸ºtrue,ç¬¬ä¸€çœ¼çœ‹è¿‡å»ï¼Œæ¯”è¾ƒä¸¤ä¸ªaçš„å‡½æ•°ï¼Œé‚£ä¸¤ä¸ªå‡½æ•°è‚¯å®šæ˜¯ç›¸ç­‰çš„ï¼Œè¿™æ˜¯ç¬¬ä¸€ç›´è§‰(ç‹—å±ç›´è§‰).</span><br><span class="line">ç¬¬äºŒä¸ªä¸¤ä¸ªéƒ½ä¸ºniläº†ï¼Œè¿™ä¸ªæ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¸¤ä¸ªnilè‚¯å®šæ˜¯deepç›¸ç­‰çš„ã€‚</span><br><span class="line">ç¬¬ä¸‰ä¸ªè™½ç„¶æ˜¯é‡æ–°åˆå§‹åŒ–äº†ï¼Œæ‰€ä»¥ä¸¤ä¸ªè‚¯å®šä¸æ˜¯deepç›¸ç­‰çš„ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="æ€è·¯æ¯”å¯¹ï¼ˆé”™åœ¨å“ªé‡Œï¼‰"><a class="header-anchor" href="#æ€è·¯æ¯”å¯¹ï¼ˆé”™åœ¨å“ªé‡Œï¼‰">Â¶</a>æ€è·¯æ¯”å¯¹ï¼ˆé”™åœ¨å“ªé‡Œï¼‰</h3>
<p>æŸ¥é˜…æ–‡æ¡£ä¹‹åï¼Œå‘ç°ç†è§£é”™äº†ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200918-124746.png" alt=""></p>
<h3 id="DeepEqualæ­£ç¡®ç†è§£"><a class="header-anchor" href="#DeepEqualæ­£ç¡®ç†è§£">Â¶</a>DeepEqualæ­£ç¡®ç†è§£</h3>
<blockquote>
<p>æºç ä¹Ÿå¾ˆç®€æ´ï¼š</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeepEqual</span><span class="params">(x, y <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">  <span class="comment">//åŒnil</span></span><br><span class="line">	<span class="keyword">if</span> x == <span class="literal">nil</span> || y == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> x == y</span><br><span class="line">	&#125;</span><br><span class="line">	v1 := ValueOf(x)</span><br><span class="line">  v2 := ValueOf(y)</span><br><span class="line">  <span class="comment">//å±äºåŒä¸€ç±»å‹</span></span><br><span class="line">	<span class="keyword">if</span> v1.Type() != v2.Type() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> deepValueEqual(v1, v2, <span class="built_in">make</span>(<span class="keyword">map</span>[visit]<span class="type">bool</span>), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™¤äº†ä¸Šé¢çœ‹æºç ï¼Œä¸»è¦è¿˜æ˜¯è¦çœ‹å®˜æ–¹çš„æ–‡æ¡£å’Œè¯´æ˜æ€§çš„ï¼Œè¿™ä¸ªç®—æ˜¯ç†è§£æºç çš„å‰ææŠŠï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DeepEqual reports whether x and y are ``deeply equal,&#x27;&#x27; defined as follows.</span></span><br><span class="line"><span class="comment">// Two values of identical type are deeply equal if one of the following cases applies.</span></span><br><span class="line"><span class="comment">// Values of distinct types are never deeply equal.</span></span><br><span class="line"><span class="comment">//  æ¡ä»¶ï¼šæ•°ç»„æ·±åº¦ç›¸ç­‰ï¼Œç›¸åº”çš„å…ƒç´ éƒ½æ˜¯ç›¸ç­‰çš„ã€‚</span></span><br><span class="line"><span class="comment">// Array values are deeply equal when their corresponding elements are deeply equal.</span></span><br><span class="line"><span class="comment">//  æ¡ä»¶ï¼šç»“æ„ä½“ç›¸å¯¹åº”çš„å­—æ®µéƒ½æ˜¯ç›¸ç­‰çš„ã€‚</span></span><br><span class="line"><span class="comment">// Struct values are deeply equal if their corresponding fields,</span></span><br><span class="line"><span class="comment">// both exported and unexported, are deeply equal.</span></span><br><span class="line"><span class="comment">// æ¡ä»¶ï¼šå‡½æ•°éƒ½æ˜¯nilï¼Œåˆ™ä¸ºæ·±åº¦ç›¸ç­‰ï¼Œå…¶å®ƒæƒ…å†µä¸‹éƒ½æ˜¯ä¸ç›¸ç­‰çš„ã€‚</span></span><br><span class="line"><span class="comment">// Func values are deeply equal if both are nil; otherwise they are not deeply equal.</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// æ¡ä»¶ï¼šä¸¤ä¸ªinterfaceæŒæœ‰æ·±åº¦ç›¸åŒçš„å€¼ã€‚</span></span><br><span class="line"><span class="comment">// Interface values are deeply equal if they hold deeply equal concrete values.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    æ¡ä»¶ï¼šä¸‹é¢æ¡ä»¶ä¸º<span class="literal">true</span>ï¼Œåˆ™æ·±åº¦ç›¸ç­‰ï¼š</span><br><span class="line">    ä¸¤ä¸ªå…¨æ˜¯<span class="literal">nil</span>ï¼Œæˆ–è€…å…¨non-<span class="literal">nil</span>ï¼Œæœ‰ç›¸åŒçš„é•¿åº¦å¹¶ä¸”æœ‰ç›¸åŒçš„å¯¹è±¡/keyå¯¹åº”çš„å€¼æ˜¯ç›¸ç­‰çš„ã€‚</span><br><span class="line"><span class="comment">// Map values are deeply equal when all of the following are true:</span></span><br><span class="line"><span class="comment">// they are both nil or both non-nil, they have the same length,</span></span><br><span class="line"><span class="comment">// and either they are the same map object or their corresponding keys</span></span><br><span class="line"><span class="comment">// (matched using Go equality) map to deeply equal values.</span></span><br><span class="line">    æ¡ä»¶ï¼šç”¨ == æ¯”è¾ƒæˆ–è€… pointçš„</span><br><span class="line"><span class="comment">// Pointer values are deeply equal if they are equal using Go&#x27;s == operator</span></span><br><span class="line"><span class="comment">// or if they point to deeply equal values.</span></span><br><span class="line">    æ¡ä»¶ï¼šä¸‹é¢æ¡ä»¶ä¸º<span class="literal">true</span>ï¼Œåˆ™æ·±åº¦ç›¸ç­‰ï¼š</span><br><span class="line">    ä¸¤ä¸ªå…¨æ˜¯<span class="literal">nil</span>ï¼Œæˆ–è€…å…¨non-<span class="literal">nil</span>ï¼Œæœ‰ç›¸åŒçš„é•¿åº¦ï¼ŒæŒ‡å‘ç›¸åŒçš„åˆå§‹åŒ–èŠ‚ç‚¹ï¼ˆå³ï¼šç›¸åŒçš„æ•°ç»„ï¼‰æˆ–ç›¸åŒçš„å…ƒç´ æ·±åº¦ç›¸ç­‰ã€‚</span><br><span class="line">    æ³¨æ„ï¼šemptyå’Œ<span class="literal">nil</span> sliceä¸æ˜¯æ·±åº¦ç›¸ç­‰çš„ã€‚</span><br><span class="line"><span class="comment">// Slice values are deeply equal when all of the following are true:</span></span><br><span class="line"><span class="comment">// they are both nil or both non-nil, they have the same length,</span></span><br><span class="line"><span class="comment">// and either they point to the same initial entry of the same underlying array</span></span><br><span class="line"><span class="comment">// (that is, &amp;x[0] == &amp;y[0]) or their corresponding elements (up to length) are deeply equal.</span></span><br><span class="line"><span class="comment">// Note that a non-nil empty slice and a nil slice (for example, []byte&#123;&#125; and []byte(nil))</span></span><br><span class="line"><span class="comment">// are not deeply equal.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Other values - numbers, bools, strings, and channels - are deeply equal</span></span><br><span class="line"><span class="comment">// if they are equal using Go&#x27;s == operator.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In general DeepEqual is a recursive relaxation of Go&#x27;s == operator.</span></span><br><span class="line"><span class="comment">// However, this idea is impossible to implement without some inconsistency.</span></span><br><span class="line"><span class="comment">// Specifically, it is possible for a value to be unequal to itself,</span></span><br><span class="line"><span class="comment">// either because it is of func type (uncomparable in general)</span></span><br><span class="line"><span class="comment">// or because it is a floating-point NaN value (not equal to itself in floating-point comparison),</span></span><br><span class="line"><span class="comment">// or because it is an array, struct, or interface containing</span></span><br><span class="line"><span class="comment">// such a value.</span></span><br><span class="line"><span class="comment">// On the other hand, pointer values are always equal to themselves,</span></span><br><span class="line"><span class="comment">// even if they point at or contain such problematic values,</span></span><br><span class="line"><span class="comment">// because they compare equal using Go&#x27;s == operator, and that</span></span><br><span class="line"><span class="comment">// is a sufficient condition to be deeply equal, regardless of content.</span></span><br><span class="line"><span class="comment">// DeepEqual has been defined so that the same short-cut applies</span></span><br><span class="line"><span class="comment">// to slices and maps: if x and y are the same slice or the same map,</span></span><br><span class="line"><span class="comment">// they are deeply equal regardless of content.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// As DeepEqual traverses the data values it may find a cycle. The</span></span><br><span class="line"><span class="comment">// second and subsequent times that DeepEqual compares two pointer</span></span><br><span class="line"><span class="comment">// values that have been compared before, it treats the values as</span></span><br><span class="line"><span class="comment">// equal rather than examining the values to which they point.</span></span><br><span class="line"><span class="comment">// This ensures that DeepEqual terminates.</span></span><br></pre></td></tr></table></figure>
<p>å†çœ‹çœ‹è¯¦ç»†çš„deepValueEqual,å¤§è‡´çš„è¿‡ç¨‹ï¼š<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200920-103516@2x.png" alt=""></p>
<blockquote>
<p>å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹ï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€åˆ¤æ–­ç±»å‹å’Œå€¼</span><br><span class="line">2ã€hardå›è°ƒ</span><br><span class="line">3ã€æŒ‰ç…§kindåˆ†ç±»å¤„ç†</span><br></pre></td></tr></table></figure>
<h4 id="æ•°ç»„ï¼š"><a class="header-anchor" href="#æ•°ç»„ï¼š">Â¶</a>æ•°ç»„ï¼š</h4>
<p>æ¯”è¾ƒæ¯ä¸€ä¸ªå…ƒç´ </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class="line">	<span class="keyword">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Slice"><a class="header-anchor" href="#Slice">Â¶</a>Slice</h4>
<ul>
<li>æ¯”è¾ƒä¸ºnil</li>
<li>æ¯”è¾ƒé•¿åº¦</li>
<li>æ¯”è¾ƒåœ°å€</li>
<li>æ¯”è¾ƒæ¯ä¸€ä¸ªå…ƒç´ </li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Len() != v2.Len() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class="line">	<span class="keyword">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Interface"><a class="header-anchor" href="#Interface">Â¶</a>Interface</h4>
<ul>
<li>æ¯”è¾ƒnil</li>
<li>é€’å½’æ¯”è¾ƒ</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() || v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> v1.IsNil() == v2.IsNil()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Ptr"><a class="header-anchor" href="#Ptr">Â¶</a>Ptr</h4>
<ul>
<li>åœ°å€</li>
<li>é€’å½’æ¯”è¾ƒ</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h4 id="struct"><a class="header-anchor" href="#struct">Â¶</a>struct</h4>
<ul>
<li>æ¯”è¾ƒæ¯ä¸€ä¸ªå…ƒç´ </li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">for</span> i, n := <span class="number">0</span>, v1.NumField(); i &lt; n; i++ &#123;</span><br><span class="line">	<span class="keyword">if</span> !deepValueEqual(v1.Field(i), v2.Field(i), visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Map"><a class="header-anchor" href="#Map">Â¶</a>Map</h4>
<ul>
<li>æ¯”è¾ƒNil</li>
<li>æ¯”è¾ƒé•¿åº¦</li>
<li>åœ°å€æ¯”è¾ƒ</li>
<li>æ¯ä¸€ä¸ªkeyå¯¹åº”çš„value</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Len() != v2.Len() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, k := <span class="keyword">range</span> v1.MapKeys() &#123;</span><br><span class="line">	val1 := v1.MapIndex(k)</span><br><span class="line">	val2 := v2.MapIndex(k)</span><br><span class="line">	<span class="keyword">if</span> !val1.IsValid() || !val2.IsValid() || !deepValueEqual(val1, val2, visited, depth+<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Func"><a class="header-anchor" href="#Func">Â¶</a>Func</h4>
<ul>
<li>énilï¼Œä¸ºä¸ç­‰ã€‚</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> v1.IsNil() &amp;&amp; v2.IsNil() &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Can&#x27;t do better than this:</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="paincæ³¨æ„ç‚¹ï¼š"><a class="header-anchor" href="#paincæ³¨æ„ç‚¹ï¼š">Â¶</a>paincæ³¨æ„ç‚¹ï¼š</h3>
<p>deepValueEqualå‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"> .....</span><br><span class="line"> ....</span><br><span class="line"> ...</span><br><span class="line"> ..</span><br><span class="line"> .</span><br><span class="line"> é€’å½’æ¬¡æ•°è¶…è¿‡<span class="number">10</span>æ¬¡åˆ™ä¼špainc....</span><br><span class="line"> <span class="comment">// if depth &gt; 10 &#123; panic(&quot;deepValueEqual&quot;) &#125;	// for debugging</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We want to avoid putting more in the visited map than we need to.</span></span><br><span class="line"><span class="comment">// For any possible reference cycle that might be encountered,</span></span><br><span class="line"><span class="comment">// hard(v1, v2) needs to return true for at least one of the types in the cycle,</span></span><br><span class="line"><span class="comment">// and it&#x27;s safe and valid to get Value&#x27;s internal pointer.</span></span><br><span class="line">hard := <span class="function"><span class="keyword">func</span><span class="params">(v1, v2 Value)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> v1.Kind() &#123;</span><br><span class="line">	<span class="keyword">case</span> Map, Slice, Ptr, Interface:</span><br><span class="line">		<span class="comment">// Nil pointers cannot be cyclic. Avoid putting them in the visited map.</span></span><br><span class="line">		<span class="keyword">return</span> !v1.IsNil() &amp;&amp; !v2.IsNil()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"> &#125;</span><br><span class="line"> .</span><br><span class="line"> ..</span><br><span class="line"> ...</span><br><span class="line"> ....</span><br><span class="line"> .....</span><br><span class="line"> ......</span><br></pre></td></tr></table></figure>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Go Package</tag>
        <tag>Day</tag>
        <tag>Go reflect</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ8ã€go rwmutexè§£è¯»</title>
    <url>/archives/3038b6c3.html</url>
    <content><![CDATA[<pre><code>å¥½ä¹…æ²¡æœ‰æ›´æ–°æ–‡ç« äº†ï¼Œè¡¨è¾¾èƒ½åŠ›ç”Ÿç–äº†è®¸å¤šğŸ˜„....
ä»Šå¤©æ‰¯æ‰¯:rwmutex è¢«ç§°ä¸ºè¯»å†™é”ã€‚ä¸€è¯´åˆ°ã€é”ã€‘æœ€ç›´æ¥çš„è”æƒ³å¯èƒ½å°±æ˜¯lock()ã€Rlock()ã€unlock()ã€Runlock()ä¹‹ç±»çš„ï¼Œä½†æ˜¯ä½œä¸ºç¨‹åºçŒ¿ï¼Œè¿˜æ˜¯è¦äº†è§£ä¸‹åº•å±‚çš„è®¾è®¡å’Œç›¸å…³çš„é€»è¾‘å®ç°ï¼Œä»¥ä¾¿äºæŠŠè¿™ç§é”çš„è®¾è®¡æ€æƒ³åº”ç”¨åˆ°å…¶å®ƒåœºæ™¯ä¸­ï¼Œå¥½äº†ï¼Œä¸åºŸè¯äº†ï¼Œå¼€é¢˜å§ã€‚
ä»é”çš„ç»“æ„è®¾è®¡--&gt;åŠ é”çš„è¿‡ç¨‹---&gt;åŠ é”çš„ç²’åº¦----&gt;è§£é”é‡Šæ”¾ï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥çœ‹rwmutexçš„å…·ä½“å®ç°ã€‚
</code></pre>
<span id="more"></span>
<h3 id="ç‰ˆæœ¬"><a class="header-anchor" href="#ç‰ˆæœ¬">Â¶</a>ç‰ˆæœ¬</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â—¯  go version</span><br><span class="line">go version go1.14.9 darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="åŒå‘å¯¹æ¯”rwmutexé”çš„è®¾è®¡"><a class="header-anchor" href="#åŒå‘å¯¹æ¯”rwmutexé”çš„è®¾è®¡">Â¶</a>åŒå‘å¯¹æ¯”rwmutexé”çš„è®¾è®¡</h3>
<pre><code>javaå®ç°ï¼šAQS(AbstractQueuedSynchronizer)
</code></pre>
<h3 id="ç»“æ„è®¾è®¡"><a class="header-anchor" href="#ç»“æ„è®¾è®¡">Â¶</a>ç»“æ„è®¾è®¡</h3>
<blockquote>
<p>åŸåˆ™ï¼šè¯»å†™äº’æ–¥ï¼Œä¼˜å…ˆå†™ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> RWMutex <span class="keyword">struct</span> &#123;</span><br><span class="line">	w           Mutex  <span class="comment">// held if there are pending writers</span></span><br><span class="line">	writerSem   <span class="type">uint32</span> <span class="comment">// semaphore for writers to wait for completing readers  å†™ä¿¡å·é‡</span></span><br><span class="line">	readerSem   <span class="type">uint32</span> <span class="comment">// semaphore for readers to wait for completing writers  è¯»ä¿¡å·é‡</span></span><br><span class="line">	readerCount <span class="type">int32</span>  <span class="comment">// number of pending readers è¯»è®¡æ•°</span></span><br><span class="line">	readerWait  <span class="type">int32</span>  <span class="comment">// number of departing readers   è¯»ç­‰å¾…ï¼ˆwriteè¿›è¡Œï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rwmutexMaxReaders = <span class="number">1</span> &lt;&lt; <span class="number">30</span>   <span class="comment">//æœ€å¤§è¯»é”çš„ä¸ªæ•°</span></span><br></pre></td></tr></table></figure>
<p>å…¶å®ƒå†åˆ†ç±»å°±æ˜¯å››ä¸ªä¸»è¦çš„å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RLock</span><br><span class="line">RUnLock</span><br><span class="line">Lock</span><br><span class="line">UnLock</span><br></pre></td></tr></table></figure>
<h3 id="åŠ é”è¿‡ç¨‹"><a class="header-anchor" href="#åŠ é”è¿‡ç¨‹">Â¶</a>åŠ é”è¿‡ç¨‹</h3>
<h4 id="RLockè¿‡ç¨‹"><a class="header-anchor" href="#RLockè¿‡ç¨‹">Â¶</a>RLockè¿‡ç¨‹</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> RLock() &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.Disable()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœå†™é”è¢«è·å–çš„ï¼Œåˆ™readerCount&lt;0çš„ï¼Œé˜»å¡çŠ¶æ€</span></span><br><span class="line">    <span class="comment">//å¦‚æœå†™é”æ²¡æœ‰è¢«è·å–ï¼Œåˆ™readerCount &gt;0çš„ï¼Œè·å–è¯»é”ï¼Œä¸é˜»å¡</span></span><br><span class="line">	<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="number">1</span>) &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// A writer is pending, wait for it. </span></span><br><span class="line">        <span class="comment">//å†™é”è¢«è·å–äº†ï¼ŒåŠ åˆ°Gé˜Ÿåˆ—åé¢ï¼ŒæŒ‚èµ·ã€‚</span></span><br><span class="line">		runtime_SemacquireMutex(&amp;rw.readerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Lockè¿‡ç¨‹"><a class="header-anchor" href="#Lockè¿‡ç¨‹">Â¶</a>Lockè¿‡ç¨‹</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Lock locks rw for writing.</span></span><br><span class="line"><span class="comment">// If the lock is already locked for reading or writing,</span></span><br><span class="line"><span class="comment">// Lock blocks until the lock is available.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> Lock() &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.Disable()</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// First, resolve competition with other writers.</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨mutexé”</span></span><br><span class="line">	rw.w.Lock()</span><br><span class="line">	<span class="comment">// Announce to readers there is a pending writer.</span></span><br><span class="line">	r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</span><br><span class="line">	<span class="comment">// Wait for active readers.</span></span><br><span class="line">	<span class="keyword">if</span> r != <span class="number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">//ç­‰å¾…æ´»è·ƒçš„readerç»“æŸåï¼Œå†ç»™ä¸€ä¸ªå†™çš„ä¿¡å·é‡ï¼Œä¿è¯æ­¤åˆ»ä¹‹åçš„readeræŒ‚èµ·ã€‚</span></span><br><span class="line">		runtime_SemacquireMutex(&amp;rw.writerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">		race.Acquire(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åŠ é”çš„ç²’åº¦"><a class="header-anchor" href="#åŠ é”çš„ç²’åº¦">Â¶</a>åŠ é”çš„ç²’åº¦</h3>
<blockquote>
<p>è¯» &amp; å†™ äº’ä¸å¹²æ‰°.</p>
</blockquote>
<h3 id="è§£é”é‡Šæ”¾"><a class="header-anchor" href="#è§£é”é‡Šæ”¾">Â¶</a>è§£é”é‡Šæ”¾</h3>
<h4 id="RUnLock"><a class="header-anchor" href="#RUnLock">Â¶</a>RUnLock</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> RUnlock() &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.ReleaseMerge(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class="line">		race.Disable()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†™é”ç­‰å¾…çŠ¶æ€ï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦å¯ä»¥è¿›è¡Œè·å–</span></span><br><span class="line">	<span class="keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="number">-1</span>); r &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Outlined slow-path to allow the fast-path to be inlined</span></span><br><span class="line">		rw.rUnlockSlow(r)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> rUnlockSlow(r <span class="type">int32</span>) &#123;</span><br><span class="line">    <span class="comment">// r + 1 == 0è¡¨ç¤ºç›´æ¥æ‰§è¡ŒRUnlock()</span></span><br><span class="line">	<span class="comment">// r + 1 == -rwmutexMaxReadersè¡¨ç¤ºæ‰§è¡ŒLock()å†æ‰§è¡ŒRUnlock()</span></span><br><span class="line">	<span class="keyword">if</span> r+<span class="number">1</span> == <span class="number">0</span> || r+<span class="number">1</span> == -rwmutexMaxReaders &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		throw(<span class="string">&quot;sync: RUnlock of unlocked RWMutex&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// A writer is pending.</span></span><br><span class="line">    <span class="comment">// å½“è¯»é”é‡Šæ”¾å®Œæ¯•åï¼Œé€šçŸ¥å†™é”</span></span><br><span class="line">	<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="number">-1</span>) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// The last reader unblocks the writer.</span></span><br><span class="line">		runtime_Semrelease(&amp;rw.writerSem, <span class="literal">false</span>, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="UnLock"><a class="header-anchor" href="#UnLock">Â¶</a>UnLock</h4>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> Unlock() &#123;</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		_ = rw.w.state</span><br><span class="line">		race.Release(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class="line">		race.Disable()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Announce to readers there is no active writer.</span></span><br><span class="line">    r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</span><br><span class="line">    <span class="comment">//è¯´æ˜è¿™ä¸ªæ²¡æœ‰æ·é”ï¼Œæ²¡æ³•å†æ¬¡é‡Šæ”¾</span></span><br><span class="line">	<span class="keyword">if</span> r &gt;= rwmutexMaxReaders &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">		throw(<span class="string">&quot;sync: Unlock of unlocked RWMutex&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// Unblock blocked readers, if any.</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾æ‰€æœ‰çš„é”ã€‚</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="type">int</span>(r); i++ &#123;</span><br><span class="line">		runtime_Semrelease(&amp;rw.readerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Allow other writers to proceed.</span></span><br><span class="line">	rw.w.Unlock()</span><br><span class="line">	<span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">		race.Enable()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“">Â¶</a>æ€»ç»“</h3>
<blockquote>
<p>è¯»&amp;å†™ï¼Œäº’ä¸å¹²æ‰°ã€‚</p>
</blockquote>
<ul>
<li>
<p>è¯»é”ä¸èƒ½é˜»å¡è¯»é”ï¼Œå¼•å…¥readerCount.</p>
</li>
<li>
<p>è¯»é”éœ€è¦é˜»å¡å†™é”ï¼Œç›´åˆ°æ‰€ä»¥è¯»é”éƒ½é‡Šæ”¾ï¼Œå¼•å…¥readerSem.</p>
</li>
<li>
<p>å†™é”éœ€è¦é˜»å¡è¯»é”ï¼Œç›´åˆ°æ‰€ä»¥å†™é”éƒ½é‡Šæ”¾ï¼Œå¼•å…¥wirterSem.</p>
</li>
<li>
<p>å†™é”éœ€è¦é˜»å¡å†™é”ï¼Œå¼•å…¥Metux.</p>
</li>
</ul>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Goæºç </tag>
        <tag>Go Package</tag>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ7ã€Go ContextåŒ…ä½¿ç”¨</title>
    <url>/archives/410dfaec.html</url>
    <content><![CDATA[<h3 id="ç‰ˆæœ¬"><a class="header-anchor" href="#ç‰ˆæœ¬">Â¶</a>ç‰ˆæœ¬</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â—¯  go version</span><br><span class="line">go version go1.14.9 darwin/amd64</span><br></pre></td></tr></table></figure>
<h3 id="ç”¨Goçš„éƒ½ç¦»ä¸å¼€Contextï¼Œå¼•ç”¨å®˜ç½‘çš„ä¸€å¥è¯æ¥æè¿°ContextåŒ…ï¼š"><a class="header-anchor" href="#ç”¨Goçš„éƒ½ç¦»ä¸å¼€Contextï¼Œå¼•ç”¨å®˜ç½‘çš„ä¸€å¥è¯æ¥æè¿°ContextåŒ…ï¼š">Â¶</a>ç”¨Goçš„éƒ½ç¦»ä¸å¼€Contextï¼Œå¼•ç”¨å®˜ç½‘çš„ä¸€å¥è¯æ¥æè¿°ContextåŒ…ï¼š</h3>
<blockquote>
<p>Package context defines the Context type, which carries deadlines, cancellation signals, and other request-scoped values across API boundaries and between processes.</p>
</blockquote>
<p>ä¸»è¦æŒæ¡å››ä¸ªæ–¹æ³•çš„ä½¿ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WithCancel</span><br><span class="line">WithDeadline</span><br><span class="line">WithTimeout</span><br><span class="line">WithValue</span><br></pre></td></tr></table></figure>
<h3 id="å‰æœŸready"><a class="header-anchor" href="#å‰æœŸready">Â¶</a>å‰æœŸready</h3>
<p>è¦ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼Œå…ˆäº†è§£ä¸‹éƒ¨åˆ†ç»“æ„å’Œé€»è¾‘ï¼š</p>
<blockquote>
<p>æ—¢ç„¶contextå…¨éƒ¨éƒ½æ˜¯å’Œå–æ¶ˆç›¸å…³çš„ï¼Œæœ€èµ·ç Goåœ¨è®¾è®¡æ—¶ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªç»“æ„ã€‚</p>
</blockquote>
<span id="more"></span>
<blockquote>
<p>å…·ä½“çš„å–æ¶ˆè®¾è®¡ç»“æ„</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">type cancelCtx struct &#123;</span><br><span class="line">	Context</span><br><span class="line"></span><br><span class="line">	mu       sync.Mutex            // protects following fields  åŠ é”ç”¨</span><br><span class="line">	done     chan struct&#123;&#125;         // created lazily, closed by first cancel call   æ§åˆ¶channel</span><br><span class="line">	children map[canceler]struct&#123;&#125; // set to nil by the first cancel call  cancelå‡½æ•°è°ƒç”¨åï¼Œé‡Šæ”¾å­ç±»</span><br><span class="line">	err      error                 // set to non-nil by the first cancel call</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>timeræ§åˆ¶æ­»é”æ—¶é—´ç»“æ„ï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// A timerCtx carries a timer and a deadline. It embeds a cancelCtx to</span><br><span class="line">// implement Done and Err. It implements cancel by stopping its timer then</span><br><span class="line">// delegating to cancelCtx.cancel.</span><br><span class="line"></span><br><span class="line">type timerCtx struct &#123;</span><br><span class="line">	cancelCtx  </span><br><span class="line">	timer *time.Timer // Under cancelCtx.mu.</span><br><span class="line"></span><br><span class="line">	deadline time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WithCancel"><a class="header-anchor" href="#WithCancel">Â¶</a>WithCancel</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">func WithCancel(parent Context) (ctx Context, cancel CancelFunc) &#123;</span><br><span class="line">    if parent == nil &#123;  //æ—¥å¸¸åˆ¤ç©º</span><br><span class="line">		panic(&quot;cannot create context from nil parent&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	c := newCancelCtx(parent) //cancelCtx new</span><br><span class="line">	propagateCancel(parent, &amp;c)  //å¾ªç¯ä¼ æ’­å–æ¶ˆå‡½æ•°for ctx</span><br><span class="line">	return &amp;c, func() &#123; c.cancel(true, Canceled) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>çœ‹ä¼¼å¾ˆç®€å•ï¼Œå››è¡Œè§£å†³ï¼Œä½†æ˜¯æ›´é‡è¦çš„æ˜¯å­¦ä¼šçœ‹æ³¨é‡Šè¯´æ˜å’Œç›¸å…³çš„è®¾è®¡æ€è·¯ï¼š<br>
TODO</p>
</blockquote>
<p>å¼•ç”¨å®˜æ–¹çš„è¯­è¨€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// WithCancel returns a copy of parent with a new Done channel. The returned</span><br><span class="line">// context&#x27;s Done channel is closed when the returned cancel function is called</span><br><span class="line">// or when the parent context&#x27;s Done channel is closed, whichever happens first.</span><br><span class="line">//</span><br><span class="line">// Canceling this context releases resources associated with it, so code should</span><br><span class="line">// call cancel as soon as the operations running in this Context complete.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Withcancel è¿”å›çš„æ˜¯ä¸€ä¸ªparentçš„é•œåƒ/å¤åˆ¶ï¼Œä¼´éšä¸€ä¸ªDone channelé€šé“ã€‚</span><br><span class="line">Doneå…³é—­çŠ¶æ€å–å†³äº</span><br><span class="line">1ã€è¿”å›çš„cancelå‡½æ•°ã€‚</span><br><span class="line">2ã€parentçš„Done Channelå…³é—­ã€‚</span><br><span class="line">è¿™ä¸¤ä¸ªå“ªä¸ªå…ˆç¬¦åˆæ¡ä»¶äº†ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="WithDeadline-WithTimeout"><a class="header-anchor" href="#WithDeadline-WithTimeout">Â¶</a>WithDeadline/WithTimeout</h3>
<p>è‡ªå·±æ¢³ç†çš„é€»è¾‘æ‰§è¡Œé¡ºåºï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200907-152032.png" alt=""></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Deadline/WithTimeoutåŒºåˆ«ï¼š</span><br><span class="line"></span><br><span class="line">* deadline:çš„å…¥å‚æ˜¯ä¸€ä¸ªå…·ä½“çš„æˆªæ­¢æ—¶é—´ï¼šTime.time</span><br><span class="line">* withTimeout:å…¥å‚æ˜¯ä¸€ä¸ªå¤šå°‘æ—¶é—´åè¶…æ—¶ï¼šTime.Duration</span><br></pre></td></tr></table></figure>
<h3 id="WithValue"><a class="header-anchor" href="#WithValue">Â¶</a>WithValue</h3>
<blockquote>
<p>Withvalueå’Œvalueæ˜¯æˆå¯¹å‡ºç°çš„:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€ç»™ctxè®¾ç½®k,vï¼šwithvalue(ctx,k,v)</span><br><span class="line">2ã€è·å–ctxä¸­kçš„å€¼value(ctx,k)</span><br></pre></td></tr></table></figure>
<h3 id="TODO"><a class="header-anchor" href="#TODO">Â¶</a>TODO</h3>
<h4 id="timerCtxè¯¦ç»†çš„è®¾è®¡æ€è·¯å’Œç»“æ„æ–‡æ¡£"><a class="header-anchor" href="#timerCtxè¯¦ç»†çš„è®¾è®¡æ€è·¯å’Œç»“æ„æ–‡æ¡£">Â¶</a>timerCtxè¯¦ç»†çš„è®¾è®¡æ€è·¯å’Œç»“æ„æ–‡æ¡£</h4>
<h4 id="æ¡†æ¶å›¾æ•´ç†"><a class="header-anchor" href="#æ¡†æ¶å›¾æ•´ç†">Â¶</a>æ¡†æ¶å›¾æ•´ç†</h4>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Go Package</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ6ã€git åˆé˜¶:å®‰è£…é…ç½® ï½1</title>
    <url>/archives/bddc30f6.html</url>
    <content><![CDATA[<blockquote>
<p>è‡ªç›˜å¤å¼€å¤©è¾Ÿåœ°ï½ï½ï½ï½<br>
æ‰¯è¿œäº†â€¦<br>
å®Œæ•´çš„åˆ†äº«ä¸‹Gitçš„ä½¿ç”¨å’Œå­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œä¹‹å‰ç« èŠ‚ä¸­çš„<a href="http://blog.imrcrab.com/2020/09/01/Git%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/">Gitå¸¸ç”¨æŠ€å·§</a>æ˜¯æˆ‘ä¹‹å‰éƒ¨åˆ†å¿«é€Ÿä½¿ç”¨çš„åœºæ™¯ï¼Œé€‚åˆäºæœ‰ç»éªŒçš„å¼€å‘è€…ï¼Œç°åœ¨æ¥ç³»ç»Ÿçš„åˆ†äº«ä¸‹å¯¹äºGitçš„ç†è§£ï¼Œä¹Ÿç®—æ˜¯è‡ªå·±å­¦ä¹ çš„è®°å½•ã€‚</p>
</blockquote>
<h2 id="å‰æ™¯"><a class="header-anchor" href="#å‰æ™¯">Â¶</a>å‰æ™¯</h2>
<p>SVNä¼°è®¡æ˜¯å®¶å–»æˆ·æ™“äº†ï¼Œä¸€ç›´è¢«ç”¨ä½œ<code>'ç‰ˆæœ¬ç®¡ç†'</code>å’Œ<code>ä»£ç ä»“åº“</code>ã€‚ï¼ˆps:ä¸ç®—æ˜¯å®Œæ•´çš„<code>ç‰ˆæœ¬ç®¡ç†</code>.ï¼‰<br>
Gitçš„å‡ºç°ï¼Œæ˜¯linusä¹‹çˆ¶ä¼‘å‡æ—¶äº§å‡ºçš„â€œä½œå“â€,<code>ç‰ˆæœ¬ç®¡ç†</code> &amp; <code>ä»£ç ä»“åº“</code>çš„ä½œç”¨ã€‚æ€»è€Œè¨€ä¹‹ï¼Œç”¨ç†Ÿç»ƒGitäº†ï¼Œå°±å†ä¹Ÿå›ä¸å»äº†ã€‚</p>
<span id="more"></span>
<h2 id="ç›®æ ‡ï¼š"><a class="header-anchor" href="#ç›®æ ‡ï¼š">Â¶</a>ç›®æ ‡ï¼š</h2>
<blockquote>
<p>æœ€ç»ˆå¯ä»¥é¡ºåˆ©çš„æäº¤ä»£ç å³å¯ã€‚</p>
</blockquote>
<h2 id="æ­¤ç¯‡åªåˆ†äº«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š"><a class="header-anchor" href="#æ­¤ç¯‡åªåˆ†äº«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š">Â¶</a>æ­¤ç¯‡åªåˆ†äº«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š</h2>
<blockquote>
<p>å®‰è£…Gitå’ŒGitåŸºæœ¬é…ç½®</p>
</blockquote>
<h3 id="Gitå®‰è£…"><a class="header-anchor" href="#Gitå®‰è£…">Â¶</a>Gitå®‰è£…</h3>
<p>è¯´å®‰è£…å…¶å®å°±æ˜¯å»å®˜ç½‘ä¸‹è½½è½¯ä»¶ï¼Œå®‰è£…åˆ°ä½ é€‰å®šåœ°æ–¹å³å¯ã€‚</p>
<p>åœ¨æ­¤é™„ä¸Šå®˜ç½‘çš„ä¸‹è½½é“¾æ¥ï¼š <a href="https://git-scm.com/download/">ç‚¹å‡»è¿›å…¥</a></p>
<p>é€‰æ‹©å¯¹åº”å¹³å°windows?linux?macos?</p>
<p>ps:åˆ«é€‰é”™äº†ï¼Œé‚£å°±veryå°´å°¬äº†ã€‚</p>
<h3 id="åŸºæœ¬é…ç½®"><a class="header-anchor" href="#åŸºæœ¬é…ç½®">Â¶</a>åŸºæœ¬é…ç½®</h3>
<p>è¯´åˆ°åŸºæœ¬é…ç½®ï¼Œå¤§å¤šæ•°éƒ½ä¼šæœ‰ï¼Œæ›´ä½•å†µæ˜¯å¦‚æ­¤å¼ºå¤§çš„ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶ã€‚</p>
<h4 id="å‰æœŸåŸºæœ¬é…ç½®"><a class="header-anchor" href="#å‰æœŸåŸºæœ¬é…ç½®">Â¶</a>å‰æœŸåŸºæœ¬é…ç½®</h4>
<p>ä¸»è¦åˆ†ä¸‰ä¸ªåœ°æ–¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€/etc/gitconfig æ–‡ä»¶: ç³»ç»Ÿä¸Šæ¯ä¸€ä¸ªç”¨æˆ·åŠå…¶ä»–ä»¬çš„ä»“åº“é…ç½®æ–‡ä»¶ã€‚</span><br><span class="line">2ã€~/.gitconfig æˆ– ~/.config/git/config æ–‡ä»¶ï¼š åªé’ˆå¯¹å½“å‰ç”¨æˆ·ç”Ÿæ•ˆã€‚ [globalé…ç½®]</span><br><span class="line">3ã€å½“å‰ä½¿ç”¨ä»“åº“çš„Gité…ç½®ï¼š .git/configæ–‡ä»¶ï¼Œä»…ä»…å¯¹å½“å‰ä»“åº“é…ç½®ç”Ÿæ•ˆã€‚    [localé…ç½®]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ps: ä¼˜å…ˆæœºåˆ¶ï¼š3 &gt; 2 &gt; 1  [.git/configè¦†ç›–~/.gitconfigã€  ~/.gitconfigè¦†ç›–/etc/gitconfig]</p>
</blockquote>
<h5 id="æ³¨æ„ï¼š"><a class="header-anchor" href="#æ³¨æ„ï¼š">Â¶</a>æ³¨æ„ï¼š</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">windowsä¸‹çš„~/.gitconfigè·¯å¾„ä¸ºï¼šC:\Users\$USERä¸‹ï¼›$USERæŒ‡å½“å‰ç”µè„‘ç”¨æˆ·åç§°</span><br></pre></td></tr></table></figure>
<h5 id="æŸ¥çœ‹æ‰€æœ‰é…ç½®å‘½ä»¤"><a class="header-anchor" href="#æŸ¥çœ‹æ‰€æœ‰é…ç½®å‘½ä»¤">Â¶</a>æŸ¥çœ‹æ‰€æœ‰é…ç½®å‘½ä»¤</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --list --show-origin</span><br></pre></td></tr></table></figure>
<h4 id="ç”Ÿæˆå¯†é’¥-å…³è”Github-Gitlab"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥-å…³è”Github-Gitlab">Â¶</a>ç”Ÿæˆå¯†é’¥&amp;å…³è”Github/Gitlab</h4>
<h5 id="ç”Ÿæˆå¯†é’¥"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥">Â¶</a>ç”Ÿæˆå¯†é’¥</h5>
<blockquote>
<p>æ ¹æ®é‚®ç®±ï¼Œä¼šè¦æ±‚è¾“å…¥å¯†ç ï¼Œè¿ç»­3ä¸ªå›è½¦å³å¯ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;è¿™é‡Œæ¢ä¸Šä½ çš„é‚®ç®±&quot;</span><br></pre></td></tr></table></figure>
<p>æœ€åå¾—åˆ°id_rsaå’Œid_rsa.pubä¸¤ä¸ªæ–‡ä»¶ã€‚</p>
<p>è¿™é‡Œç”¨åˆ°çš„æ˜¯ä½ çš„ å…¬é’¥<code>id_rsa.pub</code>æ–‡ä»¶ï¼Œå¤åˆ¶æ–‡ä»¶é‡Œé¢çš„å†…å®¹åˆ°githubå¯†é’¥çš„ç•Œé¢ï¼š</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902075825.png" alt=""></p>
<p>æ·»åŠ SSHå®Œäº†ä¹‹åï¼Œå°±ç»‘å®šäº†ä½ æœ¬æœºå™¨å’Œgithubçš„å…³è”å…³ç³»ï¼Œç›¸å½“äºæˆæƒæˆåŠŸã€‚</p>
<h5 id="æ‹“å±•"><a class="header-anchor" href="#æ‹“å±•">Â¶</a>æ‹“å±•</h5>
<blockquote>
<p>ä¸Šè¿°ç”Ÿæˆå¯†é’¥æ—¶ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ–‡ä»¶åç§°.æ­¤ç§æƒ…å†µé’ˆå¯¹ä½ æœ‰å¤šä¸ªgithubè´¦å·æ—¶ï¼Œæäº¤å…¬é’¥æ–‡ä»¶æ—¶ï¼Œæ‰¾å‡ºè‡ªå®šä¹‰åç§°çš„æ–‡ä»¶å³å¯ã€‚ï¼ˆä¸‹å›¾è‡ªå®šä¹‰ç”Ÿæˆæ–‡ä»¶åç§°pywang112,åˆ™å…¬é’¥ä¸ºpywang112.pubï¼Œçœ‹å¥½ä½ ç”Ÿæˆçš„è·¯å¾„å“¦ï¼‰</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902080130.png" alt=""></p>
<h4 id="globalé…ç½®ï¼ˆå…¨å±€é…ç½®ï¼‰æˆ–-localé…ç½®ï¼ˆå½“å‰ä»“åº“é…ç½®ï¼‰"><a class="header-anchor" href="#globalé…ç½®ï¼ˆå…¨å±€é…ç½®ï¼‰æˆ–-localé…ç½®ï¼ˆå½“å‰ä»“åº“é…ç½®ï¼‰">Â¶</a>globalé…ç½®ï¼ˆå…¨å±€é…ç½®ï¼‰æˆ– localé…ç½®ï¼ˆå½“å‰ä»“åº“é…ç½®ï¼‰</h4>
<h5 id="globalé…ç½®ï¼ˆé’ˆå¯¹ä½ åªæœ‰ä¸€ä¸ªgitè´¦æˆ·çš„æƒ…å†µï¼‰"><a class="header-anchor" href="#globalé…ç½®ï¼ˆé’ˆå¯¹ä½ åªæœ‰ä¸€ä¸ªgitè´¦æˆ·çš„æƒ…å†µï¼‰">Â¶</a>globalé…ç½®ï¼ˆé’ˆå¯¹ä½ åªæœ‰ä¸€ä¸ªgitè´¦æˆ·çš„æƒ…å†µï¼‰</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å‘½ä»¤ï¼š</span><br><span class="line">git config --global --list</span><br><span class="line"></span><br><span class="line">å…¨å±€é…ç½®ï¼š</span><br><span class="line"></span><br><span class="line">git config --global user.name &quot;crab&quot;</span><br><span class="line">git config --global user.email &quot;imrcrab@163.com&quot;</span><br><span class="line"></span><br><span class="line">ä»£ç†é…ç½®ï¼ˆæŒ‰éœ€å¯é€‰ï¼‰</span><br><span class="line"># http</span><br><span class="line">git config --global https.proxy http://127.0.0.1:1080 </span><br><span class="line"># sock</span><br><span class="line">git config --global http.proxy &#x27;socks5://127.0.0.1:1080&#x27; </span><br><span class="line"></span><br><span class="line">å–æ¶ˆä»£ç†ï¼š</span><br><span class="line">git config --global --unset http.proxy</span><br></pre></td></tr></table></figure>
<h5 id="localé…ç½®-å»ºè®®æœ¬åœ°ä»“åº“é…ç½®ï¼Œè¿™æ ·æ¯”è¾ƒçµæ´»"><a class="header-anchor" href="#localé…ç½®-å»ºè®®æœ¬åœ°ä»“åº“é…ç½®ï¼Œè¿™æ ·æ¯”è¾ƒçµæ´»">Â¶</a>localé…ç½® (å»ºè®®æœ¬åœ°ä»“åº“é…ç½®ï¼Œè¿™æ ·æ¯”è¾ƒçµæ´»)</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹å‘½ä»¤ï¼š</span><br><span class="line">git config --local --list</span><br><span class="line"></span><br><span class="line">å…¨å±€é…ç½®ï¼š</span><br><span class="line"></span><br><span class="line">git config --local user.name &quot;crab&quot;</span><br><span class="line">git config --local user.email &quot;imrcrab@163.com&quot;</span><br><span class="line"></span><br><span class="line">ä»£ç†é…ç½®ï¼ˆæŒ‰éœ€å¯é€‰ï¼‰</span><br><span class="line"># http</span><br><span class="line">git config --local https.proxy http://127.0.0.1:1080 </span><br><span class="line"># sock</span><br><span class="line">git config --local http.proxy &#x27;socks5://127.0.0.1:1080&#x27; </span><br><span class="line"></span><br><span class="line">å–æ¶ˆä»£ç†ï¼š</span><br><span class="line">git config --local --unset http.proxy</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®å®Œæˆï¼Œclone-commitä»£ç "><a class="header-anchor" href="#é…ç½®å®Œæˆï¼Œclone-commitä»£ç ">Â¶</a>é…ç½®å®Œæˆï¼Œclone/commitä»£ç </h4>
<h5 id="cloneä»“åº“ä»£ç "><a class="header-anchor" href="#cloneä»“åº“ä»£ç ">Â¶</a>cloneä»“åº“ä»£ç </h5>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902081306.png" alt=""></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/crab21/blog.git</span><br></pre></td></tr></table></figure>
<h5 id="commitä»£ç "><a class="header-anchor" href="#commitä»£ç ">Â¶</a>commitä»£ç </h5>
<blockquote>
<p>æŒ‰ç…§å¦‚ä¸Šé…ç½®å®Œæˆåï¼Œå°±å¯ä»¥å®ŒæˆåŸºæœ¬çš„pushå’Œpullä»“åº“ä»£ç äº†ã€‚</p>
</blockquote>
<h3 id="END"><a class="header-anchor" href="#END">Â¶</a>END</h3>
]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ5ã€Git GPGç­¾ç½²å·¥ä½œ</title>
    <url>/archives/580377d0.html</url>
    <content><![CDATA[<h3 id="GPGåœºæ™¯"><a class="header-anchor" href="#GPGåœºæ™¯">Â¶</a>GPGåœºæ™¯</h3>
<p>Git è™½ç„¶æ˜¯å¯†ç çº§å®‰å…¨çš„ï¼Œä½†å®ƒä¸æ˜¯ä¸‡æ— ä¸€å¤±çš„ã€‚ å¦‚æœä½ ä»å› ç‰¹ç½‘ä¸Šçš„å…¶ä»–äººé‚£é‡Œæ‹¿å–å·¥ä½œï¼Œå¹¶ä¸”æƒ³è¦éªŒè¯æäº¤æ˜¯ä¸æ˜¯çœŸæ­£åœ°æ¥è‡ªäºå¯ä¿¡æ¥æºï¼Œ Git æä¾›äº†å‡ ç§é€šè¿‡ GPG æ¥ç­¾ç½²å’ŒéªŒè¯å·¥ä½œçš„æ–¹å¼ã€‚</p>
<p>æœ€ç»ˆæ•ˆæœï¼šå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902123343.png" alt=""></p>
<h3 id="å®‰è£…è¿‡ç¨‹"><a class="header-anchor" href="#å®‰è£…è¿‡ç¨‹">Â¶</a>å®‰è£…è¿‡ç¨‹</h3>
<p>windowså®‰è£…åœ°å€ï¼š <a href="https://www.gnupg.org/">ç‚¹å‡»ä¸‹è½½</a></p>
<p>mac osä¸ºä¾‹ï¼š</p>
<span id="more"></span>
<h4 id="å®‰è£…GPG"><a class="header-anchor" href="#å®‰è£…GPG">Â¶</a>å®‰è£…GPG</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">brew install gpg</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹ç»“æœï¼š</span><br><span class="line">Â± gpg --version                                                                                                                                                                                                                                     â</span><br><span class="line"></span><br><span class="line">gpg (GnuPG) 2.2.22</span><br><span class="line">libgcrypt 1.8.6</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;https://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">Home: /Users/gogoowang/.gnupg</span><br><span class="line">æ”¯æŒçš„ç®—æ³•ï¼š</span><br><span class="line">å…¬é’¥ï¼š RSA, ELG, DSA, ECDH, ECDSA, EDDSA</span><br><span class="line">å¯†æ–‡ï¼š IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,</span><br><span class="line">    CAMELLIA128, CAMELLIA192, CAMELLIA256</span><br><span class="line">æ•£åˆ—ï¼š SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224</span><br><span class="line">å‹ç¼©ï¼š  ä¸å‹ç¼©, ZIP, ZLIB, BZIP2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ç”Ÿæˆå¯†é’¥"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥">Â¶</a>ç”Ÿæˆå¯†é’¥</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gpg --full-generate-key</span><br></pre></td></tr></table></figure>
<p>éœ€è¦å¡«å†™çš„åœ°æ–¹ï¼š<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902123803.png" alt=""></p>
<h4 id="æŸ¥çœ‹å¯†é’¥å®Œæ•´ä¿¡æ¯"><a class="header-anchor" href="#æŸ¥çœ‹å¯†é’¥å®Œæ•´ä¿¡æ¯">Â¶</a>æŸ¥çœ‹å¯†é’¥å®Œæ•´ä¿¡æ¯</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gpg --list-secret-keys --keyid-format LONG</span><br></pre></td></tr></table></figure>
<blockquote>
<p>secret keysï¼ˆçº¢åœˆåœ°æ–¹åç»­ç”¨åˆ°ï¼Œç•™æ„ä¸‹ï¼‰ï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902124016.png" alt=""></p>
<h4 id="æ ¹æ®secret-keysç”ŸæˆPGP"><a class="header-anchor" href="#æ ¹æ®secret-keysç”ŸæˆPGP">Â¶</a>æ ¹æ®secret keysç”ŸæˆPGP</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gpg --armor --export  7BB8CF3593CA174C</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„PGPç»“æœï¼Œåç»­éœ€è¦å°†æ­¤ç»“æœå¯¼å…¥åˆ°Githubè´¦å·çš„é…ç½®ä¿¡æ¯ä¸­<br>
<img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902124305.png" alt=""></p>
<h4 id="Githubè´¦å·ä¸­è®¾ç½®"><a class="header-anchor" href="#Githubè´¦å·ä¸­è®¾ç½®">Â¶</a>Githubè´¦å·ä¸­è®¾ç½®</h4>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902124443.png" alt=""></p>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902124527.png" alt=""></p>
<blockquote>
<p>å°†ä¸Šè¿°ç”Ÿæˆçš„PGPå¡«å…¥ï¼Œç‚¹å‡»[Add GPG Key]å³å¯</p>
</blockquote>
<h4 id="é…ç½®æœ¬åœ°GPGç­¾åä¿¡æ¯"><a class="header-anchor" href="#é…ç½®æœ¬åœ°GPGç­¾åä¿¡æ¯">Â¶</a>é…ç½®æœ¬åœ°GPGç­¾åä¿¡æ¯</h4>
<p>ä¾æ¬¡æ‰§è¡Œä¸‹é¢å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€git config --global user.signingkey 7BB8CF3593CA174C  #æ­¤å¤„çš„7BB8CF3593CA174Cä¸ºç”Ÿæˆçš„secret keys</span><br><span class="line">2ã€git config commit.gpgsign true</span><br><span class="line">3ã€git config --global commit.gpgsign true</span><br></pre></td></tr></table></figure>
<h4 id="Git-PGPç”Ÿæ•ˆ"><a class="header-anchor" href="#Git-PGPç”Ÿæ•ˆ">Â¶</a>Git PGPç”Ÿæ•ˆ</h4>
<blockquote>
<p>å†æ¬¡æäº¤commitå³å¯ç”Ÿæ•ˆã€‚äº§ç”Ÿå¦‚ä¸‹å›¾çš„ç­¾åæ•ˆæœï¼š</p>
</blockquote>
<p><img data-src="https://raw.githubusercontent.com/crab21/Images/master/20200902123343.png" alt=""></p>
<h4 id="End"><a class="header-anchor" href="#End">Â¶</a>End</h4>
]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ4ã€Gitå¸¸ç”¨æŠ€å·§</title>
    <url>/archives/3c1dd822.html</url>
    <content><![CDATA[<h3 id="å­¦ä¹ æ–¹å¼"><a class="header-anchor" href="#å­¦ä¹ æ–¹å¼">Â¶</a>å­¦ä¹ æ–¹å¼</h3>
<p>å¤šç»ƒå¤šå¾—ï¼Œç›´æ¥å­¦ä¹ <a href="https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6">å®˜ç½‘</a>ç†è§£ã€‚</p>
<p>ä»¥ä¸‹ä»…ä»…æ˜¯éƒ¨åˆ†ç”¨åˆ°çš„åœºæ™¯å’Œéƒ¨åˆ†åœºæ™¯è®°å½•ï¼Œä¸ä»£è¡¨å…¨éƒ¨æƒ…å†µï¼Œå¦‚æœ‰é”™è¯¯ï¼Œè¯·åŠæ—¶æŒ‡æ­£ã€‚</p>
<h3 id="Gitç‰ˆæœ¬ï¼š"><a class="header-anchor" href="#Gitç‰ˆæœ¬ï¼š">Â¶</a>Gitç‰ˆæœ¬ï¼š</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1944 Â± git version </span><br><span class="line">git version 2.28.0</span><br></pre></td></tr></table></figure>
<h3 id="å…ˆè¯´è¯´Gitçš„å¸¸ç”¨å‘½ä»¤ï¼š-å¯è·³è¿‡"><a class="header-anchor" href="#å…ˆè¯´è¯´Gitçš„å¸¸ç”¨å‘½ä»¤ï¼š-å¯è·³è¿‡">Â¶</a>å…ˆè¯´è¯´Gitçš„å¸¸ç”¨å‘½ä»¤ï¼š(å¯è·³è¿‡)</h3>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2081 â—¯  git </span><br><span class="line">ç”¨æ³•ï¼šgit [--version] [--help] [-C &lt;path&gt;] [-c &lt;name&gt;=&lt;value&gt;]</span><br><span class="line">           [--exec-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class="line">           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]</span><br><span class="line">           [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]</span><br><span class="line">           &lt;command&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">è¿™äº›æ˜¯å„ç§åœºåˆå¸¸è§çš„ Git å‘½ä»¤ï¼š</span><br><span class="line"></span><br><span class="line">å¼€å§‹ä¸€ä¸ªå·¥ä½œåŒºï¼ˆå‚è§ï¼šgit help tutorialï¼‰</span><br><span class="line">   clone             å…‹éš†ä»“åº“åˆ°ä¸€ä¸ªæ–°ç›®å½•</span><br><span class="line">   init              åˆ›å»ºä¸€ä¸ªç©ºçš„ Git ä»“åº“æˆ–é‡æ–°åˆå§‹åŒ–ä¸€ä¸ªå·²å­˜åœ¨çš„ä»“åº“</span><br><span class="line"></span><br><span class="line">åœ¨å½“å‰å˜æ›´ä¸Šå·¥ä½œï¼ˆå‚è§ï¼šgit help everydayï¼‰</span><br><span class="line">   add               æ·»åŠ æ–‡ä»¶å†…å®¹è‡³ç´¢å¼•</span><br><span class="line">   mv                ç§»åŠ¨æˆ–é‡å‘½åä¸€ä¸ªæ–‡ä»¶ã€ç›®å½•æˆ–ç¬¦å·é“¾æ¥</span><br><span class="line">   restore           æ¢å¤å·¥ä½œåŒºæ–‡ä»¶</span><br><span class="line">   rm                ä»å·¥ä½œåŒºå’Œç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶</span><br><span class="line">   sparse-checkout   åˆå§‹åŒ–åŠä¿®æ”¹ç¨€ç–æ£€å‡º</span><br><span class="line"></span><br><span class="line">æ£€æŸ¥å†å²å’ŒçŠ¶æ€ï¼ˆå‚è§ï¼šgit help revisionsï¼‰</span><br><span class="line">   bisect            é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½å¼•å…¥ bug çš„æäº¤</span><br><span class="line">   diff              æ˜¾ç¤ºæäº¤ä¹‹é—´ã€æäº¤å’Œå·¥ä½œåŒºä¹‹é—´ç­‰çš„å·®å¼‚</span><br><span class="line">   grep              è¾“å‡ºå’Œæ¨¡å¼åŒ¹é…çš„è¡Œ</span><br><span class="line">   log               æ˜¾ç¤ºæäº¤æ—¥å¿—</span><br><span class="line">   show              æ˜¾ç¤ºå„ç§ç±»å‹çš„å¯¹è±¡</span><br><span class="line">   status            æ˜¾ç¤ºå·¥ä½œåŒºçŠ¶æ€</span><br><span class="line"></span><br><span class="line">æ‰©å±•ã€æ ‡è®°å’Œè°ƒæ ¡æ‚¨çš„å†å²è®°å½•</span><br><span class="line">   branch            åˆ—å‡ºã€åˆ›å»ºæˆ–åˆ é™¤åˆ†æ”¯</span><br><span class="line">   commit            è®°å½•å˜æ›´åˆ°ä»“åº“</span><br><span class="line">   merge             åˆå¹¶ä¸¤ä¸ªæˆ–æ›´å¤šå¼€å‘å†å²</span><br><span class="line">   rebase            åœ¨å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šé‡æ–°åº”ç”¨æäº¤</span><br><span class="line">   reset             é‡ç½®å½“å‰ HEAD åˆ°æŒ‡å®šçŠ¶æ€</span><br><span class="line">   switch            åˆ‡æ¢åˆ†æ”¯</span><br><span class="line">   tag               åˆ›å»ºã€åˆ—å‡ºã€åˆ é™¤æˆ–æ ¡éªŒä¸€ä¸ª GPG ç­¾åçš„æ ‡ç­¾å¯¹è±¡</span><br><span class="line"></span><br><span class="line">ååŒï¼ˆå‚è§ï¼šgit help workflowsï¼‰</span><br><span class="line">   fetch             ä»å¦å¤–ä¸€ä¸ªä»“åº“ä¸‹è½½å¯¹è±¡å’Œå¼•ç”¨</span><br><span class="line">   pull              è·å–å¹¶æ•´åˆå¦å¤–çš„ä»“åº“æˆ–ä¸€ä¸ªæœ¬åœ°åˆ†æ”¯</span><br><span class="line">   push              æ›´æ–°è¿œç¨‹å¼•ç”¨å’Œç›¸å…³çš„å¯¹è±¡</span><br><span class="line"></span><br><span class="line">å‘½ä»¤ &#x27;git help -a&#x27; å’Œ &#x27;git help -g&#x27; æ˜¾ç¤ºå¯ç”¨çš„å­å‘½ä»¤å’Œä¸€äº›æ¦‚å¿µå¸®åŠ©ã€‚</span><br><span class="line">æŸ¥çœ‹ &#x27;git help &lt;å‘½ä»¤&gt;&#x27; æˆ– &#x27;git help &lt;æ¦‚å¿µ&gt;&#x27; ä»¥è·å–ç»™å®šå­å‘½ä»¤æˆ–æ¦‚å¿µçš„</span><br><span class="line">å¸®åŠ©ã€‚</span><br><span class="line">æœ‰å…³ç³»ç»Ÿçš„æ¦‚è¿°ï¼ŒæŸ¥çœ‹ &#x27;git help git&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="Gitä½¿ç”¨ï¼š"><a class="header-anchor" href="#Gitä½¿ç”¨ï¼š">Â¶</a>Gitä½¿ç”¨ï¼š</h3>
<h4 id="ç”Ÿæˆå¯†é’¥"><a class="header-anchor" href="#ç”Ÿæˆå¯†é’¥">Â¶</a>ç”Ÿæˆå¯†é’¥</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;è¿™é‡Œæ¢ä¸Šä½ çš„é‚®ç®±&quot;</span><br></pre></td></tr></table></figure>
<p>æœ€åå¾—åˆ°<code>id_rsa</code>å’Œ<code>id_rsa.pub</code>ä¸¤ä¸ªæ–‡ä»¶ã€‚</p>
<h4 id="Gité…ç½®ä¿¡æ¯"><a class="header-anchor" href="#Gité…ç½®ä¿¡æ¯">Â¶</a>Gité…ç½®ä¿¡æ¯</h4>
<h5 id="æŸ¥çœ‹é…ç½®ä¿¡æ¯"><a class="header-anchor" href="#æŸ¥çœ‹é…ç½®ä¿¡æ¯">Â¶</a>æŸ¥çœ‹é…ç½®ä¿¡æ¯</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹ç³»ç»Ÿé…ç½®ä¿¡æ¯</span><br><span class="line">* git config --system --list</span><br><span class="line"></span><br><span class="line">å½“å‰ç”¨æˆ·é…ç½®</span><br><span class="line">* git config --global --list</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹å½“å‰ä»“åº“é…ç½®</span><br><span class="line">* git config --local --list</span><br></pre></td></tr></table></figure>
<h5 id="è®¾ç½®ç”¨æˆ·ä¿¡æ¯"><a class="header-anchor" href="#è®¾ç½®ç”¨æˆ·ä¿¡æ¯">Â¶</a>è®¾ç½®ç”¨æˆ·ä¿¡æ¯</h5>
<p>å…¨å±€è®¾ç½®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;crab&quot;</span><br><span class="line">git config --global user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>
<p>å½“å‰ä»“åº“ç”Ÿæ•ˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --local user.name &quot;crab&quot;</span><br><span class="line">git config --local user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>
<h4 id="Git-Remote"><a class="header-anchor" href="#Git-Remote">Â¶</a>Git Remote</h4>
<h5 id="æ–°å¢remoteåœ°å€"><a class="header-anchor" href="#æ–°å¢remoteåœ°å€">Â¶</a>æ–°å¢remoteåœ°å€</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git remote add upstream http://github/**remote**/test.git</span><br><span class="line">git remote -v å¯ä»¥æŸ¥çœ‹å…·ä½“è·¯å¾„</span><br></pre></td></tr></table></figure>
<h5 id="merge-fetchè¿œç¨‹ä»£ç åˆ°XXXåˆ†æ”¯"><a class="header-anchor" href="#merge-fetchè¿œç¨‹ä»£ç åˆ°XXXåˆ†æ”¯">Â¶</a>merge/fetchè¿œç¨‹ä»£ç åˆ°XXXåˆ†æ”¯</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€git fetch upstreamã€‚</span><br><span class="line">2ã€åˆ‡å›åˆ°masteråˆ†æ”¯ã€‚</span><br><span class="line">3ã€git merge upstream/master åˆå¹¶è¿œç¨‹upstreamåˆ†æ”¯åˆ°æœ¬åœ°masterã€‚</span><br><span class="line">4ã€è§£å†³å†²çªæˆ–å…¶ä»–é—®é¢˜ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="Git-è¯¯åˆ é™¤æ¢å¤"><a class="header-anchor" href="#Git-è¯¯åˆ é™¤æ¢å¤">Â¶</a>Git è¯¯åˆ é™¤æ¢å¤</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€git  fsck --lost -found :æŸ¥çœ‹æœ€è¿‘ç§»é™¤çš„æ–‡ä»¶.</span><br><span class="line">2ã€git show  &#x27;è¯¯åˆ ç¼–å·&#x27;ï¼šæŸ¥çœ‹åˆ é™¤æ–‡ä»¶å†…å®¹.</span><br><span class="line">3ã€git merge â€˜è¯¯åˆ ç¼–å·â€™ï¼š æœ¬åœ°åˆå¹¶è¯¯åˆ çš„æ–‡ä»¶å†…å®¹.</span><br></pre></td></tr></table></figure>
<h4 id="Git-resetæ’¤å›æ“ä½œ"><a class="header-anchor" href="#Git-resetæ’¤å›æ“ä½œ">Â¶</a>Git resetæ’¤å›æ“ä½œ</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1ã€git reflog</span><br><span class="line">2ã€git reset COMMITID    å°±å¯ä»¥å›åˆ°COMMITIDé‚£ä¸ªåˆ†æ”¯å’Œç‰ˆæœ¬ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="Gitåˆ†æ”¯"><a class="header-anchor" href="#Gitåˆ†æ”¯">Â¶</a>Gitåˆ†æ”¯</h4>
<h5 id="ç”¨æ³•"><a class="header-anchor" href="#ç”¨æ³•">Â¶</a>ç”¨æ³•</h5>
<blockquote>
<p>è·å–ç”¨æ³•ï¼šGit branch -d --help</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç”¨æ³•ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r | -a] [--merged | --no-merged]</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-l] [-f] &lt;åˆ†æ”¯å&gt; [&lt;èµ·å§‹ç‚¹&gt;]</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r] (-d | -D) &lt;åˆ†æ”¯å&gt;...</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] (-m | -M) [&lt;æ—§åˆ†æ”¯&gt;] &lt;æ–°åˆ†æ”¯&gt;</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] (-c | -C) [&lt;è€åˆ†æ”¯&gt;] &lt;æ–°åˆ†æ”¯&gt;</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r | -a] [--points-at]</span><br><span class="line">  æˆ–ï¼šgit branch [&lt;é€‰é¡¹&gt;] [-r | -a] [--format]</span><br><span class="line"></span><br><span class="line">é€šç”¨é€‰é¡¹</span><br><span class="line">    -v, --verbose         æ˜¾ç¤ºå“ˆå¸Œå€¼å’Œä¸»é¢˜ï¼Œè‹¥å‚æ•°å‡ºç°ä¸¤æ¬¡åˆ™æ˜¾ç¤ºä¸Šæ¸¸åˆ†æ”¯</span><br><span class="line">    -q, --quiet           ä¸æ˜¾ç¤ºä¿¡æ¯</span><br><span class="line">    -t, --track           è®¾ç½®è·Ÿè¸ªæ¨¡å¼ï¼ˆå‚è§ git-pull(1)ï¼‰</span><br><span class="line">    -u, --set-upstream-to &lt;ä¸Šæ¸¸&gt;</span><br><span class="line">                          æ”¹å˜ä¸Šæ¸¸ä¿¡æ¯</span><br><span class="line">    --unset-upstream      å–æ¶ˆä¸Šæ¸¸ä¿¡æ¯çš„è®¾ç½®</span><br><span class="line">    --color[=&lt;ä½•æ—¶&gt;]      ä½¿ç”¨å½©è‰²è¾“å‡º</span><br><span class="line">    -r, --remotes         ä½œç”¨äºè¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</span><br><span class="line">    --contains &lt;æäº¤&gt;     åªæ‰“å°åŒ…å«è¯¥æäº¤çš„åˆ†æ”¯</span><br><span class="line">    --no-contains &lt;æäº¤&gt;  åªæ‰“å°ä¸åŒ…å«è¯¥æäº¤çš„åˆ†æ”¯</span><br><span class="line">    --abbrev[=&lt;n&gt;]        ç”¨ &lt;n&gt; ä½æ•°å­—æ˜¾ç¤º SHA-1 å“ˆå¸Œå€¼</span><br><span class="line"></span><br><span class="line">å…·ä½“çš„ git-branch åŠ¨ä½œï¼š</span><br><span class="line">    -a, --all             åˆ—å‡ºè¿œç¨‹è·Ÿè¸ªåŠæœ¬åœ°åˆ†æ”¯</span><br><span class="line">    -d, --delete          åˆ é™¤å®Œå…¨åˆå¹¶çš„åˆ†æ”¯</span><br><span class="line">    -D                    åˆ é™¤åˆ†æ”¯ï¼ˆå³ä½¿æ²¡æœ‰åˆå¹¶ï¼‰</span><br><span class="line">    -m, --move            ç§»åŠ¨/é‡å‘½åä¸€ä¸ªåˆ†æ”¯ï¼Œä»¥åŠå®ƒçš„å¼•ç”¨æ—¥å¿—</span><br><span class="line">    -M                    ç§»åŠ¨/é‡å‘½åä¸€ä¸ªåˆ†æ”¯ï¼Œå³ä½¿ç›®æ ‡å·²å­˜åœ¨</span><br><span class="line">    -c, --copy            æ‹·è´ä¸€ä¸ªåˆ†æ”¯å’Œå®ƒçš„å¼•ç”¨æ—¥å¿—</span><br><span class="line">    -C                    æ‹·è´ä¸€ä¸ªåˆ†æ”¯ï¼Œå³ä½¿ç›®æ ‡å·²å­˜åœ¨</span><br><span class="line">    -l, --list            åˆ—å‡ºåˆ†æ”¯å</span><br><span class="line">    --show-current        æ˜¾ç¤ºå½“å‰åˆ†æ”¯å</span><br><span class="line">    --create-reflog       åˆ›å»ºåˆ†æ”¯çš„å¼•ç”¨æ—¥å¿—</span><br><span class="line">    --edit-description    æ ‡è®°åˆ†æ”¯çš„æè¿°</span><br><span class="line">    -f, --force           å¼ºåˆ¶åˆ›å»ºã€ç§»åŠ¨/é‡å‘½åã€åˆ é™¤</span><br><span class="line">    --merged &lt;æäº¤&gt;       åªæ‰“å°å·²ç»åˆå¹¶çš„åˆ†æ”¯</span><br><span class="line">    --no-merged &lt;æäº¤&gt;    åªæ‰“å°å°šæœªåˆå¹¶çš„åˆ†æ”¯</span><br><span class="line">    --column[=&lt;é£æ ¼&gt;]     ä»¥åˆ—çš„æ–¹å¼æ˜¾ç¤ºåˆ†æ”¯</span><br><span class="line">    --sort &lt;key&gt;          æ’åºçš„å­—æ®µå</span><br><span class="line">    --points-at &lt;å¯¹è±¡&gt;    åªæ‰“å°æŒ‡å‘è¯¥å¯¹è±¡çš„åˆ†æ”¯</span><br><span class="line">    -i, --ignore-case     æ’åºå’Œè¿‡æ»¤å±äºå¤§å°å†™ä¸æ•æ„Ÿ</span><br><span class="line">    --format &lt;æ ¼å¼&gt;       è¾“å‡ºæ ¼å¼</span><br></pre></td></tr></table></figure>
<h5 id="è·å–æ‰€æœ‰åˆ†æ”¯"><a class="header-anchor" href="#è·å–æ‰€æœ‰åˆ†æ”¯">Â¶</a>è·å–æ‰€æœ‰åˆ†æ”¯</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git branch -r | grep -v &#x27;\-&gt;&#x27; | while read remote; do git branch --track &quot;$&#123;remote#origin/&#125;&quot; &quot;$remote&quot;; done</span><br><span class="line">git fetch --all</span><br><span class="line">git pull --all</span><br></pre></td></tr></table></figure>
<h5 id="add-removeåˆ†æ”¯"><a class="header-anchor" href="#add-removeåˆ†æ”¯">Â¶</a>add/removeåˆ†æ”¯</h5>
<p>æ–°å»º&amp;åˆ‡æ¢:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git checkout -b iss53</span><br><span class="line"></span><br><span class="line">æ˜¯ä¸‹é¢ä¸¤æ¡çš„ç®€å†™ï¼š</span><br><span class="line">git branch iss53</span><br><span class="line">git checkout iss53</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤åˆ†æ”¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git branch -d iss53</span><br></pre></td></tr></table></figure>
<h4 id="Git-stash"><a class="header-anchor" href="#Git-stash">Â¶</a>Git stash</h4>
<h5 id="å¸¸ç”¨ï¼š"><a class="header-anchor" href="#å¸¸ç”¨ï¼š">Â¶</a>å¸¸ç”¨ï¼š</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ï¼ˆ1ï¼‰git stash save &quot;save message&quot;  : æ‰§è¡Œå­˜å‚¨æ—¶ï¼Œæ·»åŠ å¤‡æ³¨ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ï¼Œåªæœ‰git stash ä¹Ÿè¦å¯ä»¥çš„ï¼Œä½†æŸ¥æ‰¾æ—¶ä¸æ–¹ä¾¿è¯†åˆ«ã€‚</span><br><span class="line">ï¼ˆ2ï¼‰git stash list  ï¼šæŸ¥çœ‹stashäº†å“ªäº›å­˜å‚¨</span><br><span class="line">ï¼ˆ3ï¼‰git stash show ï¼šæ˜¾ç¤ºåšäº†å“ªäº›æ”¹åŠ¨ï¼Œé»˜è®¤showç¬¬ä¸€ä¸ªå­˜å‚¨,å¦‚æœè¦æ˜¾ç¤ºå…¶ä»–å­˜è´®ï¼Œåé¢åŠ stash@&#123;$num&#125;ï¼Œæ¯”å¦‚ç¬¬äºŒä¸ª git stash show stash@&#123;1&#125;</span><br><span class="line">ï¼ˆ4ï¼‰git stash show -p : æ˜¾ç¤ºç¬¬ä¸€ä¸ªå­˜å‚¨çš„æ”¹åŠ¨ï¼Œå¦‚æœæƒ³æ˜¾ç¤ºå…¶ä»–å­˜å­˜å‚¨ï¼Œå‘½ä»¤ï¼šgit stash show  stash@&#123;$num&#125;  -p ï¼Œæ¯”å¦‚ç¬¬äºŒä¸ªï¼šgit stash show  stash@&#123;1&#125;  -p</span><br><span class="line">ï¼ˆ5ï¼‰git stash apply :åº”ç”¨æŸä¸ªå­˜å‚¨,ä½†ä¸ä¼šæŠŠå­˜å‚¨ä»å­˜å‚¨åˆ—è¡¨ä¸­åˆ é™¤ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªå­˜å‚¨,å³stash@&#123;0&#125;ï¼Œå¦‚æœè¦ä½¿ç”¨å…¶ä»–ä¸ªï¼Œgit stash apply stash@&#123;$num&#125; ï¼Œ æ¯”å¦‚ç¬¬äºŒä¸ªï¼šgit stash apply stash@&#123;1&#125; </span><br><span class="line">ï¼ˆ6ï¼‰git stash pop ï¼šå‘½ä»¤æ¢å¤ä¹‹å‰ç¼“å­˜çš„å·¥ä½œç›®å½•ï¼Œå°†ç¼“å­˜å †æ ˆä¸­çš„å¯¹åº”stashåˆ é™¤ï¼Œå¹¶å°†å¯¹åº”ä¿®æ”¹åº”ç”¨åˆ°å½“å‰çš„å·¥ä½œç›®å½•ä¸‹,é»˜è®¤ä¸ºç¬¬ä¸€ä¸ªstash,å³stash@&#123;0&#125;ï¼Œå¦‚æœè¦åº”ç”¨å¹¶åˆ é™¤å…¶ä»–stashï¼Œå‘½ä»¤ï¼šgit stash pop stash@&#123;$num&#125; ï¼Œæ¯”å¦‚åº”ç”¨å¹¶åˆ é™¤ç¬¬äºŒä¸ªï¼šgit stash pop stash@&#123;1&#125;</span><br><span class="line">ï¼ˆ7ï¼‰git stash drop stash@&#123;$num&#125; ï¼šä¸¢å¼ƒstash@&#123;$num&#125;å­˜å‚¨ï¼Œä»åˆ—è¡¨ä¸­åˆ é™¤è¿™ä¸ªå­˜å‚¨</span><br><span class="line">ï¼ˆ8ï¼‰git stash clear ï¼šåˆ é™¤æ‰€æœ‰ç¼“å­˜çš„stash</span><br></pre></td></tr></table></figure>
<h4 id="Git-Tag"><a class="header-anchor" href="#Git-Tag">Â¶</a>Git Tag</h4>
<h5 id="å¸¸ç”¨ï¼š-v2"><a class="header-anchor" href="#å¸¸ç”¨ï¼š-v2">Â¶</a>å¸¸ç”¨ï¼š</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2097 Â± git tag -a --help</span><br><span class="line">ç”¨æ³•ï¼šgit tag [-a | -s | -u &lt;key-id&gt;] [-f] [-m &lt;æ¶ˆæ¯&gt; | -F &lt;æ–‡ä»¶&gt;]</span><br><span class="line">		&lt;æ ‡ç­¾å&gt; [&lt;å¤´&gt;]</span><br><span class="line">  æˆ–ï¼šgit tag -d &lt;æ ‡ç­¾å&gt;...</span><br><span class="line">  æˆ–ï¼šgit tag -l [-n[&lt;æ•°å­—&gt;]] [--contains &lt;æäº¤&gt;] [--no-contains &lt;æäº¤&gt;] [--points-at &lt;å¯¹è±¡&gt;]</span><br><span class="line">		[--format=&lt;æ ¼å¼&gt;] [--[no-]merged [&lt;æäº¤&gt;]] [&lt;æ¨¡å¼&gt;...]</span><br><span class="line">  æˆ–ï¼šgit tag -v [--format=&lt;æ ¼å¼&gt;] &lt;æ ‡ç­¾å&gt;...</span><br><span class="line"></span><br><span class="line">    -l, --list            åˆ—å‡ºæ ‡ç­¾åç§°</span><br><span class="line">    -n[&lt;n&gt;]               æ¯ä¸ªæ ‡ç­¾ä¿¡æ¯æ‰“å° &lt;n&gt; è¡Œ</span><br><span class="line">    -d, --delete          åˆ é™¤æ ‡ç­¾</span><br><span class="line">    -v, --verify          éªŒè¯æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">æ ‡ç­¾åˆ›å»ºé€‰é¡¹</span><br><span class="line">    -a, --annotate        é™„æ³¨æ ‡ç­¾ï¼Œéœ€è¦ä¸€ä¸ªè¯´æ˜</span><br><span class="line">    -m, --message &lt;è¯´æ˜&gt;  æ ‡ç­¾è¯´æ˜</span><br><span class="line">    -F, --file &lt;æ–‡ä»¶&gt;     ä»æ–‡ä»¶ä¸­è¯»å–æäº¤è¯´æ˜</span><br><span class="line">    -e, --edit            å¼ºåˆ¶ç¼–è¾‘æ ‡ç­¾è¯´æ˜</span><br><span class="line">    -s, --sign            é™„æ³¨å¹¶é™„åŠ  GPG ç­¾åçš„æ ‡ç­¾</span><br><span class="line">    --cleanup &lt;æ¨¡å¼&gt;      è®¾ç½®å¦‚ä½•åˆ é™¤æäº¤è¯´æ˜é‡Œçš„ç©ºæ ¼å’Œ#æ³¨é‡Š</span><br><span class="line">    -u, --local-user &lt;key-id&gt;</span><br><span class="line">                          ä½¿ç”¨å¦å¤–çš„ç§é’¥ç­¾åè¯¥æ ‡ç­¾</span><br><span class="line">    -f, --force           å¦‚æœå­˜åœ¨ï¼Œæ›¿æ¢ç°æœ‰çš„æ ‡ç­¾</span><br><span class="line">    --create-reflog       åˆ›å»ºå¼•ç”¨æ—¥å¿—</span><br><span class="line"></span><br><span class="line">æ ‡ç­¾åˆ—è¡¨é€‰é¡¹</span><br><span class="line">    --column[=&lt;é£æ ¼&gt;]     ä»¥åˆ—çš„æ–¹å¼æ˜¾ç¤ºæ ‡ç­¾åˆ—è¡¨</span><br><span class="line">    --contains &lt;æäº¤&gt;     åªæ‰“å°åŒ…å«è¯¥æäº¤çš„æ ‡ç­¾</span><br><span class="line">    --no-contains &lt;æäº¤&gt;  åªæ‰“å°ä¸åŒ…å«è¯¥æäº¤çš„æ ‡ç­¾</span><br><span class="line">    --merged &lt;æäº¤&gt;       åªæ‰“å°å·²ç»åˆå¹¶çš„æ ‡ç­¾</span><br><span class="line">    --no-merged &lt;æäº¤&gt;    åªæ‰“å°å°šæœªåˆå¹¶çš„æ ‡ç­¾</span><br><span class="line">    --sort &lt;key&gt;          æ’åºçš„å­—æ®µå</span><br><span class="line">    --points-at &lt;å¯¹è±¡&gt;    åªæ‰“å°æŒ‡å‘è¯¥å¯¹è±¡çš„æ ‡ç­¾</span><br><span class="line">    --format &lt;æ ¼å¼&gt;       è¾“å‡ºæ ¼å¼</span><br><span class="line">    --color[=&lt;ä½•æ—¶&gt;]      éµç…§æ ¼å¼ä¸­çš„é¢œè‰²è¾“å‡º</span><br><span class="line">    -i, --ignore-case     æ’åºå’Œè¿‡æ»¤å±äºå¤§å°å†™ä¸æ•æ„Ÿ</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git tagæŒ‰ç…§versionæ’åºï¼š</span><br><span class="line">git tag -n</span><br><span class="line"></span><br><span class="line">git tagæŒ‰ç…§æ—¶é—´æ’åº</span><br><span class="line">git tag -n --sort=taggerdate</span><br><span class="line"></span><br><span class="line">git tagæŒ‰ç…§é¡ºåºæ‹‰</span><br><span class="line">git tag --sort=-v:refname</span><br><span class="line"></span><br><span class="line">git tag æ‰¹é‡åˆ é™¤</span><br><span class="line">git tag | grep &quot;v&quot; |xargs git tag -d</span><br><span class="line"></span><br><span class="line">git tag æ‰¹é‡åˆ é™¤è¿œç«¯</span><br><span class="line">git show-ref --tag | grep &quot;v1.0&quot;| awk &#x27;&#123;print $2&#125;&#x27;|xargs git push origin --delete</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="æ‰“Tag"><a class="header-anchor" href="#æ‰“Tag">Â¶</a>æ‰“Tag</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git tag -a v0.0.1 -m &quot;V0.0.1&quot; </span><br></pre></td></tr></table></figure>
<h5 id="åˆ é™¤Tag"><a class="header-anchor" href="#åˆ é™¤Tag">Â¶</a>åˆ é™¤Tag</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git tag -d v0.0.1</span><br></pre></td></tr></table></figure>
<h5 id="æ¨é€Tag"><a class="header-anchor" href="#æ¨é€Tag">Â¶</a>æ¨é€Tag</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git push origin master --tags</span><br></pre></td></tr></table></figure>
<h4 id="Git-push"><a class="header-anchor" href="#Git-push">Â¶</a>Git push</h4>
<h5 id="ç”¨æ³•-v2"><a class="header-anchor" href="#ç”¨æ³•-v2">Â¶</a>ç”¨æ³•</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç”¨æ³•ï¼šgit push [&lt;é€‰é¡¹&gt;] [&lt;ä»“åº“&gt; [&lt;å¼•ç”¨è§„æ ¼&gt;...]]</span><br><span class="line"></span><br><span class="line">    -v, --verbose         æ›´åŠ è¯¦ç»†</span><br><span class="line">    -q, --quiet           æ›´åŠ å®‰é™</span><br><span class="line">    --repo &lt;ä»“åº“&gt;         ä»“åº“</span><br><span class="line">    --all                 æ¨é€æ‰€æœ‰å¼•ç”¨</span><br><span class="line">    --mirror              é•œåƒæ‰€æœ‰å¼•ç”¨</span><br><span class="line">    -d, --delete          åˆ é™¤å¼•ç”¨</span><br><span class="line">    --tags                æ¨é€æ ‡ç­¾ï¼ˆä¸èƒ½ä½¿ç”¨ --all or --mirrorï¼‰</span><br><span class="line">    -n, --dry-run         æ¼”ä¹ </span><br><span class="line">    --porcelain           æœºå™¨å¯è¯»çš„è¾“å‡º</span><br><span class="line">    -f, --force           å¼ºåˆ¶æ›´æ–°</span><br><span class="line">    --force-with-lease[=&lt;å¼•ç”¨å&gt;:&lt;æœŸæœ›å€¼&gt;]</span><br><span class="line">                          è¦æ±‚å¼•ç”¨æ—§çš„å–å€¼ä¸ºè®¾å®šå€¼</span><br><span class="line">    --recurse-submodules (check|on-demand|no)</span><br><span class="line">                          æ§åˆ¶å­æ¨¡ç»„çš„é€’å½’æ¨é€</span><br><span class="line">    --thin                ä½¿ç”¨ç²¾ç®€æ‰“åŒ…</span><br><span class="line">    --receive-pack &lt;receive-pack&gt;</span><br><span class="line">                          æ¥æ”¶åŒ…ç¨‹åº</span><br><span class="line">    --exec &lt;receive-pack&gt;</span><br><span class="line">                          æ¥æ”¶åŒ…ç¨‹åº</span><br><span class="line">    -u, --set-upstream    è®¾ç½® git pull/status çš„ä¸Šæ¸¸</span><br><span class="line">    --progress            å¼ºåˆ¶æ˜¾ç¤ºè¿›åº¦æŠ¥å‘Š</span><br><span class="line">    --prune               æ¸…é™¤æœ¬åœ°åˆ é™¤çš„å¼•ç”¨</span><br><span class="line">    --no-verify           ç»•è¿‡ pre-push é’©å­</span><br><span class="line">    --follow-tags         æ¨é€ç¼ºå¤±ä½†æœ‰å…³çš„æ ‡ç­¾</span><br><span class="line">    --signed[=(yes|no|if-asked)]</span><br><span class="line">                          ç”¨ GPG ä¸ºæ¨é€ç­¾å</span><br><span class="line">    --atomic              éœ€è¦è¿œç«¯æ”¯æŒåŸå­äº‹åŠ¡</span><br><span class="line">    -o, --push-option &lt;server-specific&gt;</span><br><span class="line">                          ä¼ è¾“é€‰é¡¹</span><br><span class="line">    -4, --ipv4            åªä½¿ç”¨ IPv4 åœ°å€</span><br><span class="line">    -6, --ipv6            åªä½¿ç”¨ IPv6 åœ°å€</span><br></pre></td></tr></table></figure>
<h4 id="Git-rebase"><a class="header-anchor" href="#Git-rebase">Â¶</a>Git rebase</h4>
<h5 id="å˜åŸºéµå®ˆçš„åŸåˆ™"><a class="header-anchor" href="#å˜åŸºéµå®ˆçš„åŸåˆ™">Â¶</a>å˜åŸºéµå®ˆçš„åŸåˆ™</h5>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å¦‚æœæäº¤å­˜åœ¨äºä½ çš„ä»“åº“ä¹‹å¤–ï¼Œè€Œåˆ«äººå¯èƒ½åŸºäºè¿™äº›æäº¤è¿›è¡Œå¼€å‘ï¼Œé‚£ä¹ˆä¸è¦æ‰§è¡Œå˜åŸºã€‚---[å®˜ç½‘å˜åŸº](https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)</span><br><span class="line"></span><br><span class="line">TODO åç»­æ›´æ–°æ­¤è¿‡ç¨‹</span><br></pre></td></tr></table></figure>
<h5 id="ç»å…¸ç”¨æ³•ï¼š"><a class="header-anchor" href="#ç»å…¸ç”¨æ³•ï¼š">Â¶</a>ç»å…¸ç”¨æ³•ï¼š</h5>
<blockquote>
<p>git rebase --help</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Assume the following history exists and the current branch is &quot;topic&quot;:</span><br><span class="line"></span><br><span class="line">              A---B---C topic</span><br><span class="line">             /</span><br><span class="line">        D---E---F---G master</span><br><span class="line">From this point, the result of either of thefollowing </span><br><span class="line"></span><br><span class="line">commands:</span><br><span class="line">    git rebase master</span><br><span class="line">    git rebase master topic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">would be:</span><br><span class="line">                      A&#x27;--B&#x27;--C&#x27; topic</span><br><span class="line">                     /</span><br><span class="line">        D---E---F---G master</span><br></pre></td></tr></table></figure>
<h5 id="rebaseåœºæ™¯ï¼š"><a class="header-anchor" href="#rebaseåœºæ™¯ï¼š">Â¶</a>rebaseåœºæ™¯ï¼š</h5>
<p><a href="https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA">å®˜ç½‘ä¾‹å­</a></p>
<h3 id="Git-å¿«é€Ÿåœºæ™¯ï¼š"><a class="header-anchor" href="#Git-å¿«é€Ÿåœºæ™¯ï¼š">Â¶</a>Git å¿«é€Ÿåœºæ™¯ï¼š</h3>
<p>å…¶å®è¿˜æ˜¯å¯¹ä¸Šè¿°å‘½ä»¤çš„æ´»å­¦æ´»ç”¨ã€‚</p>
<h4 id="Git-Resetåœºæ™¯"><a class="header-anchor" href="#Git-Resetåœºæ™¯">Â¶</a>Git Resetåœºæ™¯</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. æœ¬åœ°ä¿®æ”¹äº†ä¸€å †æ–‡ä»¶(å¹¶æ²¡æœ‰ä½¿ç”¨git addåˆ°æš‚å­˜åŒº)ï¼Œæƒ³æ”¾å¼ƒä¿®æ”¹ã€‚</span><br><span class="line">å•ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git checkout -- filename</span><br><span class="line"></span><br><span class="line">æ‰€æœ‰æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git checkout .</span><br><span class="line"> </span><br><span class="line">2. æœ¬åœ°æ–°å¢äº†ä¸€å †æ–‡ä»¶(å¹¶æ²¡æœ‰git addåˆ°æš‚å­˜åŒº)ï¼Œæƒ³æ”¾å¼ƒä¿®æ”¹ã€‚</span><br><span class="line">å•ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">$ rm filename / rm dir -rf</span><br><span class="line"></span><br><span class="line">æ‰€æœ‰æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">$ git clean -xdf</span><br><span class="line"></span><br><span class="line">// åˆ é™¤æ–°å¢çš„æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å·²ç»å·²ç»git addåˆ°æš‚å­˜åŒºï¼Œå¹¶ä¸ä¼šåˆ é™¤ï¼</span><br><span class="line"></span><br><span class="line">3. æœ¬åœ°ä¿®æ”¹/æ–°å¢äº†ä¸€å †æ–‡ä»¶ï¼Œå·²ç»git addåˆ°æš‚å­˜åŒºï¼Œæƒ³æ”¾å¼ƒä¿®æ”¹ã€‚</span><br><span class="line">å•ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git reset HEAD filename</span><br><span class="line"></span><br><span class="line">æ‰€æœ‰æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼š</span><br><span class="line"></span><br><span class="line">git reset HEAD .</span><br><span class="line"> </span><br><span class="line">4. æœ¬åœ°é€šè¿‡git add &amp; git commit ä¹‹åï¼Œæƒ³è¦æ’¤é”€æ­¤æ¬¡commitå’Œä»£ç </span><br><span class="line"></span><br><span class="line">git reset commit_id</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªidæ˜¯ä½ æƒ³è¦å›åˆ°çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡git logæŸ¥çœ‹ï¼Œå¯ä»¥åªé€‰å‰6ä½</span><br><span class="line">// æ’¤é”€ä¹‹åï¼Œä½ æ‰€åšçš„å·²ç»commitçš„ä¿®æ”¹è¿˜åœ¨å·¥ä½œåŒºï¼</span><br><span class="line"></span><br><span class="line">git reset --hard commit_id</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªidæ˜¯ä½ æƒ³è¦å›åˆ°çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡git logæŸ¥çœ‹ï¼Œå¯ä»¥åªé€‰å‰6ä½</span><br><span class="line">// æ’¤é”€ä¹‹åï¼Œä½ æ‰€åšçš„å·²ç»commitçš„ä¿®æ”¹å°†ä¼šæ¸…é™¤ï¼Œä»åœ¨å·¥ä½œåŒº/æš‚å­˜åŒºçš„ä»£ç ä¸ä¼šæ¸…é™¤ï¼</span><br><span class="line"></span><br><span class="line">5. git add &amp; git commit æäº¤åï¼Œåªæƒ³å›æ»šcommitï¼š</span><br><span class="line">	git reset --soft HEAD^</span><br><span class="line">	æ³¨æ„è¿™ä»…ä»…æ˜¯å›æ»šäº†ä½ çš„commitï¼Œä»£ç ä¾æ—§åœ¨çš„ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="Git-â˜-for-each-ref"><a class="header-anchor" href="#Git-â˜-for-each-ref">Â¶</a>Git <a href="https://git-scm.com/docs/git-for-each-ref"> â˜ for-each-ref</a></h3>
<blockquote>
<p>ä¸»è¦ç”¨äºæŸ¥çœ‹æ‰€æœ‰çš„refå†å²ç­‰ä¿¡æ¯ã€‚</p>
</blockquote>
<blockquote>
<p>ä¸åºŸè¯ï¼Œä¸Šä¾‹å­</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git for-each-ref --sort=committerdate --format=&#x27;*** %(refname)%09%(committerdate) *** %(subject)  %09%(upstream) %09 %(authorname)%(authordate)&#x27;|tail -n 10</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¾“å‡ºï¼š<br>
[è¿™é‡Œæ˜¾ç¤ºæœ€å10æ¬¡ä¿¡æ¯]</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â¯ git for-each-ref --sort=committerdate --format=&#x27;*** %(refname)%09%(committerdate) *** %(subject)  %09%(upstream) %09 %(authorname)%(authordate)&#x27;|tail -n 10</span><br><span class="line">*** refs/tags/v0.1.0.4   *** v0.1.0.4            </span><br><span class="line">*** refs/tags/v0.1.0.5   *** v0.1.0.5            </span><br><span class="line">*** refs/tags/v0.1.0.6   *** v0.1.0.6            </span><br><span class="line">*** refs/tags/v0.1.0.7   *** v0.1.0.7            </span><br><span class="line">*** refs/tags/v0.1.0.8   *** v0.1.0.8            </span><br><span class="line">*** refs/tags/v0.1.0.9   *** v0.1.0.9            </span><br><span class="line">*** refs/remotes/origin/server  Sun Dec 13 11:41:57 2020 +0800 *** Site updated: 2020-12-13 11:41:57             crabSun Dec 13 11:41:57 2020 +0800</span><br><span class="line">*** refs/heads/master   Wed Mar 30 00:53:31 2022 +0800 *** feat: kubebuilder    refs/remotes/origin/master       crabWed Mar 30 00:53:31 2022 +0800</span><br><span class="line">*** refs/remotes/origin/HEAD    Wed Mar 30 00:53:31 2022 +0800 *** feat: kubebuilder             crabWed Mar 30 00:53:31 2022 +0800</span><br><span class="line">*** refs/remotes/origin/master  Wed Mar 30 00:53:31 2022 +0800 *** feat: kubebuilder             crabWed Mar 30 00:53:31 2022 +0800</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="æŒç»­æ›´æ–°â€¦"><a class="header-anchor" href="#æŒç»­æ›´æ–°â€¦">Â¶</a>æŒç»­æ›´æ–°â€¦</h3>
]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ3ã€git czè§„èŒƒæäº¤</title>
    <url>/archives/458b44c2.html</url>
    <content><![CDATA[<h3 id="å®šä¹‰"><a class="header-anchor" href="#å®šä¹‰">Â¶</a>å®šä¹‰</h3>
<p><a href="https://github.com/commitizen/cz-cli">å®˜æ–¹ specification</a><br>
ç®€å•çš„è¯´ä¸ºäº†ä»£ç æäº¤æ›´åŠ è§„èŒƒ</p>
<h3 id="åœºæ™¯"><a class="header-anchor" href="#åœºæ™¯">Â¶</a>åœºæ™¯</h3>
<p>git commitä½¿ç”¨<br>
<img data-src="https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png" alt=""></p>
<h3 id="ä½¿ç”¨æ­¥éª¤"><a class="header-anchor" href="#ä½¿ç”¨æ­¥éª¤">Â¶</a>ä½¿ç”¨æ­¥éª¤</h3>
<ul>
<li>å®‰è£…nodejsï¼Œç‰ˆæœ¬å»ºè®®æœ€æ–°.<a href="https://nodejs.org/zh-cn/">å®˜ç½‘</a></li>
<li>æ‰“å¼€ä½ çš„å‘½ä»¤è¡Œï¼š</li>
</ul>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥ï¼šnpm install -g commitizen</span><br><span class="line">windowsåº”è¯¥æ˜¯cmdå§ã€‚</span><br><span class="line">macç”¨ç»ˆç«¯æˆ–è€…iterm2éƒ½å¯ä»¥ã€‚</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æç¤ºä»¥ä¸‹ä¿¡æ¯å³æˆåŠŸã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-&gt; % sudo npm install -g commitizen</span><br><span class="line">Password:</span><br><span class="line">npm WARN deprecated resolve-url@0.2.1: https://github.com/lydell/resolve-url#deprecated</span><br><span class="line">npm WARN deprecated urix@0.1.0: Please see https://github.com/lydell/urix#deprecated</span><br><span class="line">/usr/local/bin/cz -&gt; /usr/local/lib/node_modules/commitizen/bin/git-cz</span><br><span class="line">/usr/local/bin/git-cz -&gt; /usr/local/lib/node_modules/commitizen/bin/git-cz</span><br><span class="line">/usr/local/bin/commitizen -&gt; /usr/local/lib/node_modules/commitizen/bin/commitizen</span><br><span class="line">+ commitizen@4.2.1</span><br><span class="line">updated 1 package in 8.132s</span><br></pre></td></tr></table></figure>
<p>3ã€è¿›å…¥gité¡¹ç›®ä¸­ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤åˆå§‹åŒ–ç¯å¢ƒã€‚<br>
<code>commitizen init cz-conventional-changelog --save --save-exact</code></p>
<p>4ã€åœ¨æäº¤ä»£ç æ—¶ä½¿ç”¨</p>
<blockquote>
<p>git cz æ›¿æ¢ git commitå‘½ä»¤</p>
</blockquote>
<h3 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹">Â¶</a>æ³¨æ„äº‹é¡¹</h3>
<ul>
<li>å®‰è£…æ–¹å¼å¯é€‰æ‹©å…¨å±€å®‰è£…</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install -g commitizen cz-conventional-changelog</span><br><span class="line">echo &#x27;&#123; &quot;path&quot;: &quot;cz-conventional-changelog&quot; &#125;&#x27; &gt; ~/.czrc</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Œ2ã€vscode å¸¸è§æ’ä»¶åŠå…¶ä½¿ç”¨</title>
    <url>/archives/8cf3cbca.html</url>
    <content><![CDATA[<blockquote>
<p>vscodeä¸­ä¸€äº›å¸¸è§çš„å‘ç‚¹â€¦</p>
</blockquote>
<h3 id="æ’ä»¶"><a class="header-anchor" href="#æ’ä»¶">Â¶</a>æ’ä»¶</h3>
<h4 id="æ ·å¼æ–¹é¢ï¼š"><a class="header-anchor" href="#æ ·å¼æ–¹é¢ï¼š">Â¶</a>æ ·å¼æ–¹é¢ï¼š</h4>
<ul>
<li>Indent Rainbo</li>
<li>Bracket Pair Colorizer # æ‹¬å·é¢œè‰²</li>
<li>Chinese Language       # æ±‰åŒ–</li>
</ul>
<span id="more"></span>
<h4 id="åŠŸèƒ½æ–¹é¢"><a class="header-anchor" href="#åŠŸèƒ½æ–¹é¢">Â¶</a>åŠŸèƒ½æ–¹é¢</h4>
<ul>
<li>Git Blame              # Gitæäº¤æŸ¥çœ‹</li>
<li>Code Spell Checker     # æ‹¼å†™æ£€æŸ¥</li>
<li>Reload                 # é‡æ–°åŠ è½½</li>
<li>Todo Tree              # ä»£åŠäº‹é¡¹</li>
<li>Settings Sync          # è®¾ç½®åŒæ­¥</li>
</ul>
]]></content>
      <tags>
        <tag>vscode</tag>
        <tag>å·¥å…·</tag>
      </tags>
  </entry>
</search>
