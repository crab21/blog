{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/nextTheme/source/css/fancybox.css","path":"css/fancybox.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/css/robofont.css","path":"css/robofont.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/scroll.png","path":"images/scroll.png","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/images/title.webp","path":"images/title.webp","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/av-min.js","path":"js/av-min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/busuanzi.js","path":"js/busuanzi.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/fancybox.js","path":"js/fancybox.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/fancybox.mini.js","path":"js/fancybox.mini.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/fundebug-1.9.0-min.js","path":"js/fundebug-1.9.0-min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/local-search.js","path":"js/local-search.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/valine.min.js","path":"js/valine.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/KFOkCnqEu92Fr1Mu51xIIzIXKMny.woff2","path":"lib/KFOkCnqEu92Fr1Mu51xIIzIXKMny.woff2","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/KFOlCnqEu92Fr1MmWUlfBBc4AMP6lQ.woff2","path":"lib/KFOlCnqEu92Fr1MmWUlfBBc4AMP6lQ.woff2","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2","path":"lib/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/anime.min.js","path":"lib/anime.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/core.js","path":"js/mathjax/core.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/latest.js","path":"js/mathjax/latest.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/loader.js","path":"js/mathjax/loader.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/math-tex-mml-chtml.js","path":"js/mathjax/math-tex-mml-chtml.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/mml-chtml.js","path":"js/mathjax/mml-chtml.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/mml-svg.js","path":"js/mathjax/mml-svg.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/node-main.js","path":"js/mathjax/node-main.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/startup.js","path":"js/mathjax/startup.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/tex-chtml-full.js","path":"js/mathjax/tex-chtml-full.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/tex-chtml.js","path":"js/mathjax/tex-chtml.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/tex-mml-chtml.js","path":"js/mathjax/tex-mml-chtml.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/tex-svg-full.js","path":"js/mathjax/tex-svg-full.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/tex-mml-svg.js","path":"js/mathjax/tex-mml-svg.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/tex-svg.js","path":"js/mathjax/tex-svg.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/canvas-nest/LICENSE","path":"lib/canvas-nest/LICENSE","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/canvas-nest/README.md","path":"lib/canvas-nest/README.md","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/canvas-nest/canvas-nest-nomobile.min.js","path":"lib/canvas-nest/canvas-nest-nomobile.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/canvas-ribbon/LICENSE","path":"lib/canvas-ribbon/LICENSE","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/canvas-ribbon/README.md","path":"lib/canvas-ribbon/README.md","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/fancybox/LICENSE","path":"lib/fancybox/LICENSE","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/fancybox/README.md","path":"lib/fancybox/README.md","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/LICENSE","path":"lib/pace/LICENSE","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/README.md","path":"lib/pace/README.md","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-flat-top.min.css","path":"lib/pace/pace-theme-flat-top.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-material.min.css","path":"lib/pace/pace-theme-material.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/reading_progress/README.md","path":"lib/reading_progress/README.md","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/reading_progress/LICENSE","path":"lib/reading_progress/LICENSE","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/reading_progress/package.json","path":"lib/reading_progress/package.json","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/reading_progress/reading_progress.js","path":"lib/reading_progress/reading_progress.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/reading_progress/reading_progress.min.js","path":"lib/reading_progress/reading_progress.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/reading_progress/renovate.json","path":"lib/reading_progress/renovate.json","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/LICENSE","path":"lib/three/LICENSE","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/README.md","path":"lib/three/README.md","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/gulpfile.js","path":"lib/three/gulpfile.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/package.json","path":"lib/three/package.json","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/renovate.json","path":"lib/three/renovate.json","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/a11y/assistive-mml.js","path":"js/mathjax/a11y/assistive-mml.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/a11y/complexity.js","path":"js/mathjax/a11y/complexity.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/a11y/explorer.js","path":"js/mathjax/a11y/explorer.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/a11y/semantic-enrich.js","path":"js/mathjax/a11y/semantic-enrich.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/adaptors/liteDOM.js","path":"js/mathjax/adaptors/liteDOM.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/asciimath.js","path":"js/mathjax/input/asciimath.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/mml.js","path":"js/mathjax/input/mml.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex-base.js","path":"js/mathjax/input/tex-base.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex-full.js","path":"js/mathjax/input/tex-full.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex.js","path":"js/mathjax/input/tex.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/sre/sre-node.js","path":"js/mathjax/sre/sre-node.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/sre/sre_browser.js","path":"js/mathjax/sre/sre_browser.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml.js","path":"js/mathjax/output/chtml.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/svg.js","path":"js/mathjax/output/svg.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/ui/menu.js","path":"js/mathjax/ui/menu.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/ui/safe.js","path":"js/mathjax/ui/safe.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.min.css","path":"lib/fancybox/source/jquery.fancybox.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.min.js","path":"lib/fancybox/source/jquery.fancybox.min.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/lib/CanvasRenderer.js","path":"lib/three/lib/CanvasRenderer.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/lib/Projector.js","path":"lib/three/lib/Projector.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/src/canvas_lines.js","path":"lib/three/src/canvas_lines.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/src/canvas_sphere.js","path":"lib/three/src/canvas_sphere.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/lib/three/src/three-waves.js","path":"lib/three/src/three-waves.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/mml/entities.js","path":"js/mathjax/input/mml/entities.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/action.js","path":"js/mathjax/input/tex/extensions/action.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/all-packages.js","path":"js/mathjax/input/tex/extensions/all-packages.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/ams.js","path":"js/mathjax/input/tex/extensions/ams.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/amscd.js","path":"js/mathjax/input/tex/extensions/amscd.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/autoload.js","path":"js/mathjax/input/tex/extensions/autoload.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/bbox.js","path":"js/mathjax/input/tex/extensions/bbox.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/boldsymbol.js","path":"js/mathjax/input/tex/extensions/boldsymbol.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/braket.js","path":"js/mathjax/input/tex/extensions/braket.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/bussproofs.js","path":"js/mathjax/input/tex/extensions/bussproofs.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/cancel.js","path":"js/mathjax/input/tex/extensions/cancel.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/color.js","path":"js/mathjax/input/tex/extensions/color.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/colorv2.js","path":"js/mathjax/input/tex/extensions/colorv2.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/configmacros.js","path":"js/mathjax/input/tex/extensions/configmacros.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/enclose.js","path":"js/mathjax/input/tex/extensions/enclose.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/extpfeil.js","path":"js/mathjax/input/tex/extensions/extpfeil.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/html.js","path":"js/mathjax/input/tex/extensions/html.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/mhchem.js","path":"js/mathjax/input/tex/extensions/mhchem.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/newcommand.js","path":"js/mathjax/input/tex/extensions/newcommand.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/noerrors.js","path":"js/mathjax/input/tex/extensions/noerrors.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/noundefined.js","path":"js/mathjax/input/tex/extensions/noundefined.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/physics.js","path":"js/mathjax/input/tex/extensions/physics.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/require.js","path":"js/mathjax/input/tex/extensions/require.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/tagformat.js","path":"js/mathjax/input/tex/extensions/tagformat.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/textmacros.js","path":"js/mathjax/input/tex/extensions/textmacros.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/unicode.js","path":"js/mathjax/input/tex/extensions/unicode.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/verb.js","path":"js/mathjax/input/tex/extensions/verb.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/tex.js","path":"js/mathjax/output/chtml/fonts/tex.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/svg/fonts/tex.js","path":"js/mathjax/output/svg/fonts/tex.js","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff","modified":0,"renderable":1},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Zero.woff","path":"js/mathjax/output/chtml/fonts/woff-v2/MathJax_Zero.woff","modified":0,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"b48c4f7d61a5928be717d4bd654481ff1eab36ee","modified":1611669905687},{"_id":"source/_discarded/info.md","hash":"b6fe5afbecfca4b97e535ae9e987e12d720f0ca6","modified":1611669905687},{"_id":"source/_drafts/25-GPM-newm函数要点.md","hash":"5bb4d16bbe6e8681421672421eb717c0a3a05881","modified":1611669905687},{"_id":"source/_drafts/26-RabbitMQ五种工作模式.md","hash":"74cc334bb8e276ec3c83eb770de2d41dace9d118","modified":1611669905688},{"_id":"source/_drafts/TLS-SSL-HTTPS详解.md","hash":"609a9ac36c64a6d679a0aee80eef7b1d873bc151","modified":1611669905688},{"_id":"source/_drafts/N-正态规划.md","hash":"3d7a8b570183e758bf575d7ffb63cda658969a72","modified":1611669905688},{"_id":"source/_drafts/bookmarks.md","hash":"dbc3719700613ff590611cbaf1f2f188515a4a4b","modified":1611669905688},{"_id":"source/_drafts/git 初阶add-commit-push ~2.md","hash":"204f87f2540f63751722fc5d449c287270516e42","modified":1611669905688},{"_id":"source/_drafts/plan todo.md","hash":"4a11f2572588cac9cd05fc62e90c8cfef518d2ab","modified":1611669905688},{"_id":"source/categories/index.md","hash":"958a5f0f58e4b3d7351ad170d43d812bda6ce739","modified":1611669905693},{"_id":"source/_posts/11-hexo-主题-评论-进度条-背景效果.md","hash":"82b086c3c84f599213c215fa61c0804cca76ce5e","modified":1611669905689},{"_id":"source/_posts/10-sync-mutex解读.md","hash":"940f6339db1f6e5a7f8711caaa663f0c0f983f09","modified":1611669905689},{"_id":"source/_posts/14-hexo-安装-插件.md","hash":"32062978a77d1aa1eaca5d0b643b841d27ba9fb9","modified":1612603113607},{"_id":"source/_posts/1-重拾那份折腾之心，坚定脚步.md","hash":"48411661c725f9518bf4b3243232d84a4a2984bb","modified":1612444655433},{"_id":"source/_posts/16-go源码words归纳.md","hash":"fd5e5911b5f7fcaca2a204104534c7a23817811f","modified":1611669905689},{"_id":"source/_posts/13-Linux-进程.md","hash":"b732ddaa08fbb41d392b951e9f1d155bdece19d1","modified":1611669905689},{"_id":"source/_posts/12-go-指针和引用.md","hash":"e3eef04eb0c9c774b9231bbf26ce53b6fd1786f5","modified":1611669905689},{"_id":"source/_posts/15-Plan9-汇编小记.md","hash":"8ea132f85a58b8fd190461b28cc485293d30e6c5","modified":1611669905689},{"_id":"source/_posts/17-chrome headless.md","hash":"a3c44229bdd7f8aa75ea7a9177f9c1dcc012b68e","modified":1611669905689},{"_id":"source/_posts/18-GPM初识.md","hash":"255285ae57a9713b41ac80113b013f35179bf920","modified":1611669905690},{"_id":"source/_posts/21-linux-select源码.md","hash":"fe2509d62f7e50f8cec02d4395a26a587a6e96cf","modified":1612570802272},{"_id":"source/_posts/2-vscode-常见问题.md","hash":"7e9e00f39ea8ec1ee44e3a65120fa860d2374bac","modified":1611669905690},{"_id":"source/_posts/19-GPM调度流程.md","hash":"ed4e2f2e60741a86904578a7316b3f4ca1de0648","modified":1611669905690},{"_id":"source/_posts/20-博客诡异事件.md","hash":"afd6b5c3148892326a1378299c11113878473c56","modified":1611669905690},{"_id":"source/_posts/22-GPM g0和m0.md","hash":"4f91508dce162ed8b503d3fccf46d1e2aaa2d8ef","modified":1611669905690},{"_id":"source/_posts/23-GPM-main入口函数.md","hash":"fa4f0e58d88b123292672944d966580921e133a5","modified":1611669905691},{"_id":"source/_posts/24-GPM-newm函数.md","hash":"56a7c9d936f93974f8cc6e677e61c3bd9c6f1857","modified":1611669905691},{"_id":"source/_posts/26-v1-16.md","hash":"3c3ee6933795f25c49e60a994f9e70684dffd1a5","modified":1611669905691},{"_id":"source/_posts/25-GPM-sysmon函数.md","hash":"22865843b4ddf0964c2b0d904a41004377adb633","modified":1611669905691},{"_id":"source/_posts/28-sync-mutex传参复制问题.md","hash":"c2b50acd28be2c441e9e5154644b8cc1a2617dbc","modified":1611669905691},{"_id":"source/_posts/27-Time-Zone时区详解.md","hash":"193009846912c5d270442874b84593983e42c6d6","modified":1611669905691},{"_id":"source/_posts/29-map-delete-Mem不释放问题.md","hash":"a482e4a0e317a2add4cc4178cacb8f140006ef63","modified":1611669905692},{"_id":"source/_posts/3-git-cz规范提交.md","hash":"52b23cf15d57a69f3be96b805385a16656d2968b","modified":1611669905692},{"_id":"source/_posts/30-redis-rdb数据保存.md","hash":"c4444f61932976126d8f1c17b8ca70a730e16b61","modified":1612444655434},{"_id":"source/_posts/31-float类型易踩的坑.md","hash":"e49ef6525d744e2d805030f9c045ae0efe2702f2","modified":1612444655434},{"_id":"source/_posts/33-IEEE745-Float.md","hash":"a1d94812e9ce6b7095c706ad9f778590559477b4","modified":1612600051453},{"_id":"source/_posts/32-go-ticker-内存泄露.md","hash":"987d6e1d4c43c026964684221eef1f6b93dda61e","modified":1612575301955},{"_id":"source/_posts/5-Git-GPG签署工作.md","hash":"c9a50170f8abb0720a8ce7731b22db0b5713d0fb","modified":1611669905692},{"_id":"source/_posts/4-Git常用技巧.md","hash":"b47ab4d59565ca060d66f56c34dde9bd4f90b5ad","modified":1611669905692},{"_id":"source/_posts/7-Go-Context包使用.md","hash":"55f518ab0cbf60ec0b1ef128dc2469c20dae1990","modified":1611669905693},{"_id":"source/_posts/6-git 初阶:安装配置 ～1.md","hash":"39efe5a20bf343346791c2185cec5390998050bc","modified":1611669905693},{"_id":"source/tags/index.md","hash":"1d844ace792d6fa481eb42d64cfb6cecf93f3fbb","modified":1611669905693},{"_id":"source/_posts/8-go-rwmutex解读.md","hash":"214ed88e9b98d92cfc0fa45c52d416be4fdda476","modified":1611669905693},{"_id":"source/_posts/9-Go-reflect-DeepEqual.md","hash":"130331fcca1ab30c1fc2e966508305e420a0d489","modified":1611669905693},{"_id":"themes/nextTheme/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1611669905715},{"_id":"themes/nextTheme/.eslintrc.json","hash":"cc5f297f0322672fe3f684f823bc4659e4a54c41","modified":1611669905716},{"_id":"themes/nextTheme/.gitattributes","hash":"a54f902957d49356376b59287b894b1a3d7a003f","modified":1611669905716},{"_id":"themes/nextTheme/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1611669905721},{"_id":"themes/nextTheme/.travis.yml","hash":"ecca3b919a5b15886e3eca58aa84aafc395590da","modified":1611669905721},{"_id":"themes/nextTheme/LICENSE.md","hash":"18144d8ed58c75af66cb419d54f3f63374cd5c5b","modified":1611669905721},{"_id":"themes/nextTheme/_config.yml","hash":"4cd435fe2fe2d9f1b2849b148c0b65ce57f1a11e","modified":1612601966565},{"_id":"themes/nextTheme/package.json","hash":"62fad6de02adbbba9fb096cbe2dcc15fe25f2435","modified":1611669905742},{"_id":"themes/nextTheme/README.md","hash":"9b4b7d66aca47f9c65d6321b14eef48d95c4dff1","modified":1611669905722},{"_id":"themes/nextTheme/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1611669905722},{"_id":"themes/nextTheme/.github/CODE_OF_CONDUCT.md","hash":"aa4cb7aff595ca628cb58160ee1eee117989ec4e","modified":1611669905717},{"_id":"themes/nextTheme/gulpfile.js","hash":"1b4fc262b89948937b9e3794de812a7c1f2f3592","modified":1611669905726},{"_id":"themes/nextTheme/.github/PULL_REQUEST_TEMPLATE.md","hash":"1a435c20ae8fa183d49bbf96ac956f7c6c25c8af","modified":1611669905720},{"_id":"themes/nextTheme/.github/CONTRIBUTING.md","hash":"e554931b98f251fd49ff1d2443006d9ea2c20461","modified":1611669905718},{"_id":"themes/nextTheme/.github/config.yml","hash":"1d3f4e8794986817c0fead095c74f756d45f91ed","modified":1611669905720},{"_id":"themes/nextTheme/.github/issue-close-app.yml","hash":"7cba457eec47dbfcfd4086acd1c69eaafca2f0cd","modified":1611669905720},{"_id":"themes/nextTheme/.github/issue_label_bot.yaml","hash":"fca600ddef6f80c5e61aeed21722d191e5606e5b","modified":1611669905720},{"_id":"themes/nextTheme/.github/lock.yml","hash":"61173b9522ebac13db2c544e138808295624f7fd","modified":1611669905721},{"_id":"themes/nextTheme/.github/mergeable.yml","hash":"0ee56e23bbc71e1e76427d2bd255a9879bd36e22","modified":1611669905721},{"_id":"themes/nextTheme/.github/release-drafter.yml","hash":"3cc10ce75ecc03a5ce86b00363e2a17eb65d15ea","modified":1611669905721},{"_id":"themes/nextTheme/.github/stale.yml","hash":"fdf82de9284f8bc8e0b0712b4cc1cb081a94de59","modified":1611669905721},{"_id":"themes/nextTheme/.github/support.yml","hash":"d75db6ffa7b4ca3b865a925f9de9aef3fc51925c","modified":1611669905721},{"_id":"themes/nextTheme/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1611669905722},{"_id":"themes/nextTheme/docs/ALGOLIA-SEARCH.md","hash":"c7a994b9542040317d8f99affa1405c143a94a38","modified":1611669905722},{"_id":"themes/nextTheme/docs/AUTHORS.md","hash":"10135a2f78ac40e9f46b3add3e360c025400752f","modified":1611669905723},{"_id":"themes/nextTheme/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"94dc3404ccb0e5f663af2aa883c1af1d6eae553d","modified":1611669905723},{"_id":"themes/nextTheme/docs/DATA-FILES.md","hash":"cddbdc91ee9e65c37a50bec12194f93d36161616","modified":1611669905723},{"_id":"themes/nextTheme/docs/INSTALLATION.md","hash":"af88bcce035780aaa061261ed9d0d6c697678618","modified":1611669905723},{"_id":"themes/nextTheme/docs/UPDATE-FROM-5.1.X.md","hash":"8b6e4b2c9cfcb969833092bdeaed78534082e3e6","modified":1611669905724},{"_id":"themes/nextTheme/docs/LICENSE.txt","hash":"368bf2c29d70f27d8726dd914f1b3211cae4bbab","modified":1611669905723},{"_id":"themes/nextTheme/docs/MATH.md","hash":"d645b025ec7fb9fbf799b9bb76af33b9f5b9ed93","modified":1611669905724},{"_id":"themes/nextTheme/languages/ar.yml","hash":"9815e84e53d750c8bcbd9193c2d44d8d910e3444","modified":1611669905726},{"_id":"themes/nextTheme/languages/de.yml","hash":"74c59f2744217003b717b59d96e275b54635abf5","modified":1611669905726},{"_id":"themes/nextTheme/languages/default.yml","hash":"4575e843e44b30a35c1b4956efb47a4ba5ad9408","modified":1611669905727},{"_id":"themes/nextTheme/languages/fa.yml","hash":"3676b32fda37e122f3c1a655085a1868fb6ad66b","modified":1611669905727},{"_id":"themes/nextTheme/languages/en.yml","hash":"4575e843e44b30a35c1b4956efb47a4ba5ad9408","modified":1611669905727},{"_id":"themes/nextTheme/languages/es.yml","hash":"c64cf05f356096f1464b4b1439da3c6c9b941062","modified":1611669905727},{"_id":"themes/nextTheme/languages/id.yml","hash":"70179b62a12bd08c575cfbb6b155229601efe6f0","modified":1611669905727},{"_id":"themes/nextTheme/languages/fr.yml","hash":"752bf309f46a2cd43890b82300b342d7218d625f","modified":1611669905727},{"_id":"themes/nextTheme/languages/hu.yml","hash":"e8c7dc328b88a40e25ed4778f39e7eb6cfd4801a","modified":1611669905727},{"_id":"themes/nextTheme/languages/it.yml","hash":"7564d37852f87787d159883b604ee0fa05295841","modified":1611669905727},{"_id":"themes/nextTheme/languages/nl.yml","hash":"5af3473d9f22897204afabc08bb984b247493330","modified":1611669905728},{"_id":"themes/nextTheme/languages/pt-BR.yml","hash":"67555b1ba31a0242b12fc6ce3add28531160e35b","modified":1611669905728},{"_id":"themes/nextTheme/languages/ko.yml","hash":"bfc4a1007d0c849a9fd81e8adb3c5c00bbbc5d95","modified":1611669905728},{"_id":"themes/nextTheme/languages/ja.yml","hash":"68f0c434b82d7eb1a67ca71f5b90ce4672cd0c05","modified":1611669905728},{"_id":"themes/nextTheme/languages/ru.yml","hash":"e993d5ca072f7f6887e30fc0c19b4da791ca7a88","modified":1611669905728},{"_id":"themes/nextTheme/languages/pt.yml","hash":"718d131f42f214842337776e1eaddd1e9a584054","modified":1611669905728},{"_id":"themes/nextTheme/languages/uk.yml","hash":"3a6d635b1035423b22fc86d9455dba9003724de9","modified":1611669905729},{"_id":"themes/nextTheme/languages/tr.yml","hash":"fe793f4c2608e3f85f0b872fd0ac1fb93e6155e2","modified":1611669905729},{"_id":"themes/nextTheme/languages/vi.yml","hash":"93393b01df148dcbf0863f6eee8e404e2d94ef9e","modified":1611669905729},{"_id":"themes/nextTheme/languages/zh-TW.yml","hash":"8c09da7c4ec3fca2c6ee897b2eea260596a2baa1","modified":1611669905729},{"_id":"themes/nextTheme/languages/zh-HK.yml","hash":"3789f94010f948e9f23e21235ef422a191753c65","modified":1611669905729},{"_id":"themes/nextTheme/layout/_layout.swig","hash":"b81d35d347e1f4a6db5af4674c598cc688861024","modified":1612444655438},{"_id":"themes/nextTheme/layout/archive.swig","hash":"e4e31317a8df68f23156cfc49e9b1aa9a12ad2ed","modified":1611669905740},{"_id":"themes/nextTheme/layout/category.swig","hash":"1bde61cf4d2d171647311a0ac2c5c7933f6a53b0","modified":1611669905741},{"_id":"themes/nextTheme/layout/index.swig","hash":"7f403a18a68e6d662ae3e154b2c1d3bbe0801a23","modified":1611669905741},{"_id":"themes/nextTheme/languages/zh-CN.yml","hash":"a1f15571ee7e1e84e3cc0985c3ec4ba1a113f6f8","modified":1612108759847},{"_id":"themes/nextTheme/layout/page.swig","hash":"db581bdeac5c75fabb0f17d7c5e746e47f2a9168","modified":1611669905741},{"_id":"themes/nextTheme/scripts/renderer.js","hash":"49a65df2028a1bc24814dc72fa50d52231ca4f05","modified":1611669905745},{"_id":"themes/nextTheme/layout/tag.swig","hash":"0dfb653bd5de980426d55a0606d1ab122bd8c017","modified":1611669905741},{"_id":"themes/nextTheme/layout/post.swig","hash":"2f6d992ced7e067521fdce05ffe4fd75481f41c5","modified":1611669905741},{"_id":"themes/nextTheme/source/.DS_Store","hash":"163994d04019fa7ae30dcbe4dfa46d84064a58b9","modified":1611669905747},{"_id":"themes/nextTheme/.github/ISSUE_TEMPLATE/bug-report.md","hash":"c3e6b8196c983c40fd140bdeca012d03e6e86967","modified":1611669905719},{"_id":"themes/nextTheme/.github/ISSUE_TEMPLATE/question.md","hash":"53df7d537e26aaf062d70d86835c5fd8f81412f3","modified":1611669905720},{"_id":"themes/nextTheme/.github/ISSUE_TEMPLATE/other.md","hash":"d3efc0df0275c98440e69476f733097916a2d579","modified":1611669905720},{"_id":"themes/nextTheme/.github/ISSUE_TEMPLATE/feature-request.md","hash":"12d99fb8b62bd9e34d9672f306c9ae4ace7e053e","modified":1611669905719},{"_id":"themes/nextTheme/docs/ru/DATA-FILES.md","hash":"0bd2d696f62a997a11a7d84fec0130122234174e","modified":1611669905724},{"_id":"themes/nextTheme/docs/ru/INSTALLATION.md","hash":"9c4fe2873123bf9ceacab5c50d17d8a0f1baef27","modified":1611669905724},{"_id":"themes/nextTheme/docs/ru/README.md","hash":"85dd68ed1250897a8e4a444a53a68c1d49eb7e11","modified":1611669905724},{"_id":"themes/nextTheme/docs/ru/UPDATE-FROM-5.1.X.md","hash":"5237a368ab99123749d724b6c379415f2c142a96","modified":1611669905724},{"_id":"themes/nextTheme/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"fb23b85db6f7d8279d73ae1f41631f92f64fc864","modified":1611669905725},{"_id":"themes/nextTheme/docs/zh-CN/CONTRIBUTING.md","hash":"d3f03be036b75dc71cf3c366cd75aee7c127c874","modified":1611669905725},{"_id":"themes/nextTheme/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"34b88784ec120dfdc20fa82aadeb5f64ef614d14","modified":1611669905725},{"_id":"themes/nextTheme/docs/zh-CN/INSTALLATION.md","hash":"579c7bd8341873fb8be4732476d412814f1a3df7","modified":1611669905725},{"_id":"themes/nextTheme/docs/zh-CN/DATA-FILES.md","hash":"ca1030efdfca5e20f9db2e7a428998e66a24c0d0","modified":1611669905725},{"_id":"themes/nextTheme/docs/zh-CN/README.md","hash":"c038629ff8f3f24e8593c4c8ecf0bef3a35c750d","modified":1611669905726},{"_id":"themes/nextTheme/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"8b18f84503a361fc712b0fe4d4568e2f086ca97d","modified":1611669905725},{"_id":"themes/nextTheme/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"d9ce7331c1236bbe0a551d56cef2405e47e65325","modified":1611669905726},{"_id":"themes/nextTheme/layout/_macro/post-collapse.swig","hash":"9c8dc0b8170679cdc1ee9ee8dbcbaebf3f42897b","modified":1611669905730},{"_id":"themes/nextTheme/docs/zh-CN/MATH.md","hash":"b92585d251f1f9ebe401abb5d932cb920f9b8b10","modified":1611669905726},{"_id":"themes/nextTheme/layout/_macro/sidebar.swig","hash":"71655ca21907e9061b6e8ac52d0d8fbf54d0062b","modified":1611669905730},{"_id":"themes/nextTheme/layout/_macro/post.swig","hash":"9ded8166e4a8e572b0954638c368f92710af24a3","modified":1612570802273},{"_id":"themes/nextTheme/layout/_partials/pagination.swig","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1611669905732},{"_id":"themes/nextTheme/layout/_partials/comments.swig","hash":"db6ab5421b5f4b7cb32ac73ad0e053fdf065f83e","modified":1611669905730},{"_id":"themes/nextTheme/layout/_partials/languages.swig","hash":"ba9e272f1065b8f0e8848648caa7dea3f02c6be1","modified":1611669905732},{"_id":"themes/nextTheme/layout/_partials/footer.swig","hash":"10818fd25e93b4099a657f7a74a22af813b41d96","modified":1612103789554},{"_id":"themes/nextTheme/layout/_partials/widgets.swig","hash":"83a40ce83dfd5cada417444fb2d6f5470aae6bb0","modified":1611669905734},{"_id":"themes/nextTheme/layout/_scripts/index.swig","hash":"cea942b450bcb0f352da78d76dc6d6f1d23d5029","modified":1611669905735},{"_id":"themes/nextTheme/layout/_scripts/noscript.swig","hash":"d1f2bfde6f1da51a2b35a7ab9e7e8eb6eefd1c6b","modified":1611669905735},{"_id":"themes/nextTheme/layout/_scripts/pjax.swig","hash":"4d2c93c66e069852bb0e3ea2e268d213d07bfa3f","modified":1611669905735},{"_id":"themes/nextTheme/layout/_scripts/three.swig","hash":"a4f42f2301866bd25a784a2281069d8b66836d0b","modified":1611669905736},{"_id":"themes/nextTheme/layout/_scripts/vendors.swig","hash":"ef38c213679e7b6d2a4116f56c9e55d678446069","modified":1611669905736},{"_id":"themes/nextTheme/layout/_third-party/index.swig","hash":"70c3c01dd181de81270c57f3d99b6d8f4c723404","modified":1611669905738},{"_id":"themes/nextTheme/layout/_third-party/baidu-push.swig","hash":"b782eb2e34c0c15440837040b5d65b093ab6ec04","modified":1611669905737},{"_id":"themes/nextTheme/scripts/events/index.js","hash":"5743cde07f3d2aa11532a168a652e52ec28514fd","modified":1611669905742},{"_id":"themes/nextTheme/layout/_third-party/quicklink.swig","hash":"311e5eceec9e949f1ea8d623b083cec0b8700ff2","modified":1611669905738},{"_id":"themes/nextTheme/scripts/helpers/engine.js","hash":"bdb424c3cc0d145bd0c6015bb1d2443c8a9c6cda","modified":1611669905745},{"_id":"themes/nextTheme/scripts/helpers/font.js","hash":"5059d2f7163ad0763b4f13af09d3131b2941d36e","modified":1612446151597},{"_id":"themes/nextTheme/scripts/helpers/next-config.js","hash":"5e11f30ddb5093a88a687446617a46b048fa02e5","modified":1611669905745},{"_id":"themes/nextTheme/scripts/helpers/next-url.js","hash":"958e86b2bd24e4fdfcbf9ce73e998efe3491a71f","modified":1611669905745},{"_id":"themes/nextTheme/layout/_third-party/rating.swig","hash":"2731e262a6b88eaee2a3ca61e6a3583a7f594702","modified":1611669905738},{"_id":"themes/nextTheme/scripts/filters/default-injects.js","hash":"aec50ed57b9d5d3faf2db3c88374f107203617e0","modified":1611669905744},{"_id":"themes/nextTheme/scripts/filters/front-matter.js","hash":"703bdd142a671b4b67d3d9dfb4a19d1dd7e7e8f7","modified":1611669905744},{"_id":"themes/nextTheme/scripts/filters/locals.js","hash":"b193a936ee63451f09f8886343dcfdca577c0141","modified":1611669905744},{"_id":"themes/nextTheme/scripts/filters/minify.js","hash":"19985723b9f677ff775f3b17dcebf314819a76ac","modified":1611669905744},{"_id":"themes/nextTheme/scripts/tags/button.js","hash":"8c6b45f36e324820c919a822674703769e6da32c","modified":1611669905746},{"_id":"themes/nextTheme/scripts/filters/post.js","hash":"44ba9b1c0bdda57590b53141306bb90adf0678db","modified":1611669905745},{"_id":"themes/nextTheme/scripts/tags/caniuse.js","hash":"94e0bbc7999b359baa42fa3731bdcf89c79ae2b3","modified":1611669905746},{"_id":"themes/nextTheme/scripts/tags/center-quote.js","hash":"f1826ade2d135e2f60e2d95cb035383685b3370c","modified":1611669905746},{"_id":"themes/nextTheme/scripts/tags/group-pictures.js","hash":"d902fd313e8d35c3cc36f237607c2a0536c9edf1","modified":1611669905746},{"_id":"themes/nextTheme/scripts/tags/label.js","hash":"fc5b267d903facb7a35001792db28b801cccb1f8","modified":1611669905746},{"_id":"themes/nextTheme/scripts/tags/mermaid.js","hash":"983c6c4adea86160ecc0ba2204bc312aa338121d","modified":1611669905746},{"_id":"themes/nextTheme/scripts/tags/note.js","hash":"0a02bb4c15aec41f6d5f1271cdb5c65889e265d9","modified":1611669905746},{"_id":"themes/nextTheme/scripts/tags/pdf.js","hash":"8c613b39e7bff735473e35244b5629d02ee20618","modified":1611669905746},{"_id":"themes/nextTheme/scripts/tags/tabs.js","hash":"93d8a734a3035c1d3f04933167b500517557ba3e","modified":1611669905747},{"_id":"themes/nextTheme/scripts/tags/video.js","hash":"e5ff4c44faee604dd3ea9db6b222828c4750c227","modified":1611669905747},{"_id":"themes/nextTheme/source/css/_colors.styl","hash":"a8442520f719d3d7a19811cb3b85bcfd4a596e1f","modified":1611669905747},{"_id":"themes/nextTheme/source/css/_mixins.styl","hash":"e31a557f8879c2f4d8d5567ee1800b3e03f91f6e","modified":1611669905756},{"_id":"themes/nextTheme/source/css/main.styl","hash":"a3a3bbb5a973052f0186b3523911cb2539ff7b88","modified":1611669905760},{"_id":"themes/nextTheme/source/css/fancybox.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1611669905760},{"_id":"themes/nextTheme/source/css/robofont.css","hash":"c3ba185de1e257638ea49592a554f6eec8c9770c","modified":1612446069290},{"_id":"themes/nextTheme/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1611669905760},{"_id":"themes/nextTheme/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1611669905760},{"_id":"themes/nextTheme/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1611669905760},{"_id":"themes/nextTheme/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1611669905761},{"_id":"themes/nextTheme/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1611669905761},{"_id":"themes/nextTheme/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1611669905761},{"_id":"themes/nextTheme/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1611669905761},{"_id":"themes/nextTheme/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1611669905761},{"_id":"themes/nextTheme/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1611669905761},{"_id":"themes/nextTheme/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1611669905762},{"_id":"themes/nextTheme/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1611669905762},{"_id":"themes/nextTheme/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1611669905762},{"_id":"themes/nextTheme/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1611669905762},{"_id":"themes/nextTheme/source/images/scroll.png","hash":"443930af0ee54778babad7724291bfed9b431dd5","modified":1611669905762},{"_id":"themes/nextTheme/source/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1611669905763},{"_id":"themes/nextTheme/source/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1611669905763},{"_id":"themes/nextTheme/source/js/fundebug-1.9.0-min.js","hash":"a68d0e2b35c7d6cf60b4b1a0a892cdc51b4732d8","modified":1611707084273},{"_id":"themes/nextTheme/source/js/busuanzi.js","hash":"a30fcd42f277944e6524b99f2412b1f01880b813","modified":1611671136713},{"_id":"themes/nextTheme/source/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1611669905764},{"_id":"themes/nextTheme/source/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1611669905764},{"_id":"themes/nextTheme/source/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1611669905765},{"_id":"themes/nextTheme/source/js/utils.js","hash":"f7353c946f7483139e0ff3f17e7620736d81b1a1","modified":1612570802274},{"_id":"themes/nextTheme/source/lib/KFOkCnqEu92Fr1Mu51xIIzIXKMny.woff2","hash":"6328533762fd139a66466929231898eb893f78d1","modified":1612444847915},{"_id":"themes/nextTheme/source/lib/KFOlCnqEu92Fr1MmWUlfBBc4AMP6lQ.woff2","hash":"5789e81a66958aabc7590c1ddd41058335636027","modified":1612444847873},{"_id":"themes/nextTheme/layout/_partials/header/index.swig","hash":"7dbe93b8297b746afb89700b4d29289556e85267","modified":1611669905731},{"_id":"themes/nextTheme/layout/_partials/head/head-unique.swig","hash":"000bad572d76ee95d9c0a78f9ccdc8d97cc7d4b4","modified":1611669905731},{"_id":"themes/nextTheme/source/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1611669905765},{"_id":"themes/nextTheme/source/lib/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2","hash":"6ff06a34f68ad0324ddec1bbe4d453c959178b36","modified":1612444847951},{"_id":"themes/nextTheme/layout/_partials/header/brand.swig","hash":"c70f8e71e026e878a4e9d5ab3bbbf9b0b23c240c","modified":1611669905731},{"_id":"themes/nextTheme/layout/_partials/head/head.swig","hash":"82f370a5f9ec7590f2e2acf63f8d9782de151f04","modified":1611669905731},{"_id":"themes/nextTheme/layout/_partials/header/menu-item.swig","hash":"9440d8a3a181698b80e1fa47f5104f4565d8cdf3","modified":1611669905731},{"_id":"themes/nextTheme/layout/_partials/header/sub-menu.swig","hash":"ae2261bea836581918a1c2b0d1028a78718434e0","modified":1611669905731},{"_id":"themes/nextTheme/layout/_partials/header/menu.swig","hash":"d31f896680a6c2f2c3f5128b4d4dd46c87ce2130","modified":1611669905731},{"_id":"themes/nextTheme/layout/_partials/page/breadcrumb.swig","hash":"c851717497ca64789f2176c9ecd1dedab237b752","modified":1611669905732},{"_id":"themes/nextTheme/layout/_partials/page/page-header.swig","hash":"9b7a66791d7822c52117fe167612265356512477","modified":1611669905732},{"_id":"themes/nextTheme/layout/_partials/post/post-copyright.swig","hash":"954ad71536b6eb08bd1f30ac6e2f5493b69d1c04","modified":1611669905732},{"_id":"themes/nextTheme/layout/_partials/post/post-followme.swig","hash":"ceba16b9bd3a0c5c8811af7e7e49d0f9dcb2f41e","modified":1611669905733},{"_id":"themes/nextTheme/layout/_partials/post/post-footer.swig","hash":"8f14f3f8a1b2998d5114cc56b680fb5c419a6b07","modified":1611669905733},{"_id":"themes/nextTheme/layout/_partials/post/post-related.swig","hash":"f79c44692451db26efce704813f7a8872b7e63a0","modified":1611669905733},{"_id":"themes/nextTheme/layout/_partials/post/post-reward.swig","hash":"2b1a73556595c37951e39574df5a3f20b2edeaef","modified":1611669905733},{"_id":"themes/nextTheme/layout/_partials/search/algolia-search.swig","hash":"48430bd03b8f19c9b8cdb2642005ed67d56c6e0b","modified":1611669905733},{"_id":"themes/nextTheme/layout/_partials/search/index.swig","hash":"2be50f9bfb1c56b85b3b6910a7df27f51143632c","modified":1611669905734},{"_id":"themes/nextTheme/layout/_partials/search/localsearch.swig","hash":"f48a6a8eba04eb962470ce76dd731e13074d4c45","modified":1611669905734},{"_id":"themes/nextTheme/layout/_partials/sidebar/site-overview.swig","hash":"c46849e0af8f8fb78baccd40d2af14df04a074af","modified":1611669905734},{"_id":"themes/nextTheme/layout/_scripts/schemes/gemini.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1611669905735},{"_id":"themes/nextTheme/layout/_scripts/pages/schedule.swig","hash":"077b5d66f6309f2e7dcf08645058ff2e03143e6c","modified":1611669905735},{"_id":"themes/nextTheme/layout/_scripts/schemes/mist.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1611669905735},{"_id":"themes/nextTheme/layout/_scripts/schemes/muse.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1611669905736},{"_id":"themes/nextTheme/layout/_scripts/schemes/pisces.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1611669905736},{"_id":"themes/nextTheme/layout/_third-party/analytics/growingio.swig","hash":"5adea065641e8c55994dd2328ddae53215604928","modified":1611669905736},{"_id":"themes/nextTheme/layout/_third-party/analytics/google-analytics.swig","hash":"2fa2b51d56bfac6a1ea76d651c93b9c20b01c09b","modified":1611669905736},{"_id":"themes/nextTheme/layout/_third-party/analytics/baidu-analytics.swig","hash":"4790058691b7d36cf6d2d6b4e93795a7b8d608ad","modified":1611669905736},{"_id":"themes/nextTheme/layout/_third-party/analytics/index.swig","hash":"1472cabb0181f60a6a0b7fec8899a4d03dfb2040","modified":1611669905737},{"_id":"themes/nextTheme/layout/_third-party/comments/disqusjs.swig","hash":"82f5b6822aa5ec958aa987b101ef860494c6cf1f","modified":1611669905737},{"_id":"themes/nextTheme/layout/_third-party/comments/disqus.swig","hash":"b14908644225d78c864cd0a9b60c52407de56183","modified":1611669905737},{"_id":"themes/nextTheme/layout/_third-party/comments/changyan.swig","hash":"f39a5bf3ce9ee9adad282501235e0c588e4356ec","modified":1611669905737},{"_id":"themes/nextTheme/layout/_third-party/comments/livere.swig","hash":"f7a9eca599a682479e8ca863db59be7c9c7508c8","modified":1611669905738},{"_id":"themes/nextTheme/layout/_third-party/comments/gitalk.swig","hash":"d6ceb70648555338a80ae5724b778c8c58d7060d","modified":1611669905737},{"_id":"themes/nextTheme/layout/_third-party/comments/valine.swig","hash":"be0a8eccf1f6dc21154af297fc79555343031277","modified":1611669905738},{"_id":"themes/nextTheme/layout/_third-party/chat/chatra.swig","hash":"f910618292c63871ca2e6c6e66c491f344fa7b1f","modified":1611669905737},{"_id":"themes/nextTheme/layout/_third-party/chat/tidio.swig","hash":"cba0e6e0fad08568a9e74ba9a5bee5341cfc04c1","modified":1611669905737},{"_id":"themes/nextTheme/layout/_third-party/math/index.swig","hash":"6c5976621efd5db5f7c4c6b4f11bc79d6554885f","modified":1611669905738},{"_id":"themes/nextTheme/layout/_third-party/math/katex.swig","hash":"4791c977a730f29c846efcf6c9c15131b9400ead","modified":1611669905738},{"_id":"themes/nextTheme/layout/_third-party/math/mathjax.swig","hash":"ecf751321e799f0fb3bf94d049e535130e2547aa","modified":1611669905738},{"_id":"themes/nextTheme/layout/_third-party/search/algolia-search.swig","hash":"d35a999d67f4c302f76fdf13744ceef3c6506481","modified":1611669905739},{"_id":"themes/nextTheme/layout/_third-party/search/localsearch.swig","hash":"767b6c714c22588bcd26ba70b0fc19b6810cbacd","modified":1611669905739},{"_id":"themes/nextTheme/layout/_third-party/search/swiftype.swig","hash":"ba0dbc06b9d244073a1c681ff7a722dcbf920b51","modified":1611669905739},{"_id":"themes/nextTheme/layout/_third-party/statistics/cnzz-analytics.swig","hash":"a17ace37876822327a2f9306a472974442c9005d","modified":1611669905739},{"_id":"themes/nextTheme/layout/_third-party/statistics/firestore.swig","hash":"b26ac2bfbe91dd88267f8b96aee6bb222b265b7a","modified":1611669905740},{"_id":"themes/nextTheme/layout/_third-party/statistics/index.swig","hash":"5f6a966c509680dbfa70433f9d658cee59c304d7","modified":1611669905740},{"_id":"themes/nextTheme/layout/_third-party/statistics/busuanzi-counter.swig","hash":"1149f3e52b3fbc6eadf1bfe4dab3f331c7fb367f","modified":1612103789554},{"_id":"themes/nextTheme/layout/_third-party/statistics/lean-analytics.swig","hash":"d56d5af427cdfecc33a0f62ee62c056b4e33d095","modified":1611669905740},{"_id":"themes/nextTheme/layout/_third-party/tags/mermaid.swig","hash":"f3c43664a071ff3c0b28bd7e59b5523446829576","modified":1611669905740},{"_id":"themes/nextTheme/scripts/events/lib/config.js","hash":"d34c6040b13649714939f59be5175e137de65ede","modified":1611669905742},{"_id":"themes/nextTheme/layout/_third-party/tags/pdf.swig","hash":"d30b0e255a8092043bac46441243f943ed6fb09b","modified":1611669905740},{"_id":"themes/nextTheme/scripts/events/lib/injects-point.js","hash":"6661c1c91c7cbdefc6a5e6a034b443b8811235a1","modified":1611669905742},{"_id":"themes/nextTheme/scripts/events/lib/injects.js","hash":"f233d8d0103ae7f9b861344aa65c1a3c1de8a845","modified":1611669905742},{"_id":"themes/nextTheme/scripts/filters/comment/common.js","hash":"2486f3e0150c753e5f3af1a3665d074704b8ee2c","modified":1611669905743},{"_id":"themes/nextTheme/scripts/filters/comment/default-config.js","hash":"7f2d93af012c1e14b8596fecbfc7febb43d9b7f5","modified":1611669905743},{"_id":"themes/nextTheme/scripts/filters/comment/disqus.js","hash":"4c0c99c7e0f00849003dfce02a131104fb671137","modified":1611669905743},{"_id":"themes/nextTheme/scripts/filters/comment/disqusjs.js","hash":"7f8b92913d21070b489457fa5ed996d2a55f2c32","modified":1611669905743},{"_id":"themes/nextTheme/scripts/filters/comment/gitalk.js","hash":"e51dc3072c1ba0ea3008f09ecae8b46242ec6021","modified":1611669905743},{"_id":"themes/nextTheme/scripts/filters/comment/livere.js","hash":"d5fefc31fba4ab0188305b1af1feb61da49fdeb0","modified":1611669905743},{"_id":"themes/nextTheme/scripts/filters/comment/valine.js","hash":"6cbd85f9433c06bae22225ccf75ac55e04f2d106","modified":1611669905744},{"_id":"themes/nextTheme/source/css/_variables/Gemini.styl","hash":"f4e694e5db81e57442c7e34505a416d818b3044a","modified":1611669905759},{"_id":"themes/nextTheme/source/css/_variables/Mist.styl","hash":"f70be8e229da7e1715c11dd0e975a2e71e453ac8","modified":1611669905759},{"_id":"themes/nextTheme/source/css/_variables/Muse.styl","hash":"62df49459d552bbf73841753da8011a1f5e875c8","modified":1611669905759},{"_id":"themes/nextTheme/source/css/_variables/Pisces.styl","hash":"612ec843372dae709acb17112c1145a53450cc59","modified":1611669905759},{"_id":"themes/nextTheme/source/css/_variables/base.styl","hash":"0a8057c9a5e17aaaf8ca30363405bee8290d443e","modified":1611669905759},{"_id":"themes/nextTheme/source/css/_custom/custom.styl","hash":"9141f198c3ff1c62f07715f6193d1a3a76f9a8ef","modified":1612570802273},{"_id":"themes/nextTheme/source/js/mathjax/latest.js","hash":"94625a1bbc4afd27b9412c65955581fac9d63145","modified":1612601981513},{"_id":"themes/nextTheme/source/js/mathjax/loader.js","hash":"1ee56611b3087759d7c55f82aca30793ac508599","modified":1612601981544},{"_id":"themes/nextTheme/source/js/mathjax/startup.js","hash":"44bfd46ba3524c44a8d0c549ca5e3b82182d9c96","modified":1612601981749},{"_id":"themes/nextTheme/source/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1611669905765},{"_id":"themes/nextTheme/source/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1611669905765},{"_id":"themes/nextTheme/source/lib/canvas-nest/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/canvas-nest/README.md","hash":"0ba5a24a483f36166f0cb871bd30f4c7467f3593","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/canvas-nest/canvas-nest-nomobile.min.js","hash":"956eada198babd00f028e8908767cb158926c3f3","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/canvas-ribbon/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/canvas-ribbon/README.md","hash":"3a18d68b0673c0e79faecc8503268ac7bec7d30e","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"65b1a8f12d04b15d7ed6eeb9d11dec760a799c5f","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/fancybox/.bower.json","hash":"d8bf9cb15d9d91c7ad022ba2954b5b4d326f17f7","modified":1611669905766},{"_id":"themes/nextTheme/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1611669905767},{"_id":"themes/nextTheme/source/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1611669905769},{"_id":"themes/nextTheme/source/lib/fancybox/README.md","hash":"8286582ed7c338fce8bb03566b769fba378bce83","modified":1611669905767},{"_id":"themes/nextTheme/source/lib/fancybox/LICENSE","hash":"8624bcdae55baeef00cd11d5dfcfa60f68710a02","modified":1611669905767},{"_id":"themes/nextTheme/source/lib/pace/README.md","hash":"168f57bb63563b9671d0c4f10c0940e7eec261f0","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1611669905770},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1611669905771},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1611669905771},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-flat-top.min.css","hash":"5e1c97e232b46e48592a8e4983ae5a89e0a7da6a","modified":1611669905771},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1611669905771},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1611669905771},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1611669905772},{"_id":"themes/nextTheme/source/lib/pace/pace-theme-material.min.css","hash":"f1ff83985c090f3a3236554c5ef69542dcceb049","modified":1611669905771},{"_id":"themes/nextTheme/source/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1611669905772},{"_id":"themes/nextTheme/source/lib/reading_progress/.editorconfig","hash":"7d47ecd70ca58d26af4f69ff1b23034edcf4475e","modified":1611669905772},{"_id":"themes/nextTheme/source/lib/reading_progress/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1611669905772},{"_id":"themes/nextTheme/source/lib/reading_progress/README.md","hash":"d370ea928bad9e91fd8f1590e23e279b9a959516","modified":1611669905772},{"_id":"themes/nextTheme/source/lib/reading_progress/package.json","hash":"b48a3293b45d8cab41e0ab61a64104a854f6dc94","modified":1611669905773},{"_id":"themes/nextTheme/source/lib/reading_progress/reading_progress.min.js","hash":"b768dc009e6d37dd952632c317f6c33e6e2d89ad","modified":1611669905773},{"_id":"themes/nextTheme/source/lib/reading_progress/reading_progress.js","hash":"ec68a79421cfba022ac53f46813d013dd48617c0","modified":1611669905773},{"_id":"themes/nextTheme/source/lib/reading_progress/renovate.json","hash":"cb29cc16e61b0b8a6dac34657d76822ae29ad5aa","modified":1611669905773},{"_id":"themes/nextTheme/source/lib/three/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1611669905773},{"_id":"themes/nextTheme/source/lib/three/README.md","hash":"1e31051ce404eaa86df192b7000442bacd31e2b4","modified":1611669905773},{"_id":"themes/nextTheme/source/lib/three/canvas_lines.min.js","hash":"ae6584edc0418d68731cab82c1494f26bd77c07d","modified":1611669905774},{"_id":"themes/nextTheme/source/lib/three/canvas_sphere.min.js","hash":"186c3bd6ae352d336cdbd0e555ee76a844854c94","modified":1611669905774},{"_id":"themes/nextTheme/source/lib/three/gulpfile.js","hash":"e0e9e7051d9d82a37c2aba1df396d8b3916323c4","modified":1611669905774},{"_id":"themes/nextTheme/source/lib/three/package.json","hash":"af5089f910e1041b316def5512a23443f0ffaadc","modified":1611669905775},{"_id":"themes/nextTheme/source/lib/three/renovate.json","hash":"cb29cc16e61b0b8a6dac34657d76822ae29ad5aa","modified":1611669905775},{"_id":"themes/nextTheme/source/lib/three/three-waves.min.js","hash":"329483be97cdda030779da9a6cd1e3eae645cf4f","modified":1611669905776},{"_id":"themes/nextTheme/source/css/_common/components/components.styl","hash":"8e7b57a72e757cf95278239641726bb2d5b869d1","modified":1611669905748},{"_id":"themes/nextTheme/source/css/_common/components/back-to-top.styl","hash":"a47725574e1bee3bc3b63b0ff2039cc982b17eff","modified":1611669905747},{"_id":"themes/nextTheme/source/css/_common/components/back-to-top-sidebar.styl","hash":"ca5e70662dcfb261c25191cc5db5084dcf661c76","modified":1611669905747},{"_id":"themes/nextTheme/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1611669905779},{"_id":"themes/nextTheme/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1611669905779},{"_id":"themes/nextTheme/source/css/_common/components/reading-progress.styl","hash":"2e3bf7baf383c9073ec5e67f157d3cb3823c0957","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/outline/outline.styl","hash":"a1690e035b505d28bdef2b4424c13fc6312ab049","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/outline/mobile.styl","hash":"681d33e3bc85bdca407d93b134c089264837378c","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/scaffolding/base.styl","hash":"0b2c4b78eead410020d7c4ded59c75592a648df8","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/scaffolding/buttons.styl","hash":"a2e9e00962e43e98ec2614d6d248ef1773bb9b78","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/comments.styl","hash":"b1f0fab7344a20ed6748b04065b141ad423cf4d9","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/scaffolding.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/pagination.styl","hash":"8f58570a1bbc34c4989a47a1b7d42a8030f38b06","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/toggles.styl","hash":"179e33b8ac7f4d8a8e76736a7e4f965fe9ab8b42","modified":1611669905756},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tables.styl","hash":"18ce72d90459c9aa66910ac64eae115f2dde3767","modified":1611669905755},{"_id":"themes/nextTheme/source/css/_schemes/Mist/_header.styl","hash":"f6516d0f7d89dc7b6c6e143a5af54b926f585d82","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Gemini/index.styl","hash":"7785bd756e0c4acede3a47fec1ed7b55988385a5","modified":1611669905756},{"_id":"themes/nextTheme/source/css/_schemes/Mist/_layout.styl","hash":"bb7ace23345364eb14983e860a7172e1683a4c94","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Mist/_menu.styl","hash":"7104b9cef90ca3b140d7a7afcf15540a250218fc","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Mist/_posts-expand.styl","hash":"6136da4bbb7e70cec99f5c7ae8c7e74f5e7c261a","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Mist/index.styl","hash":"a717969829fa6ef88225095737df3f8ee86c286b","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Muse/_header.styl","hash":"f0131db6275ceaecae7e1a6a3798b8f89f6c850d","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Muse/_layout.styl","hash":"4d1c17345d2d39ef7698f7acf82dfc0f59308c34","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Muse/_menu.styl","hash":"93db5dafe9294542a6b5f647643cb9deaced8e06","modified":1611669905757},{"_id":"themes/nextTheme/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Muse/_sidebar.styl","hash":"2b2e7b5cea7783c9c8bb92655e26a67c266886f0","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Pisces/_header.styl","hash":"e282df938bd029f391c466168d0e68389978f120","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Pisces/_layout.styl","hash":"70a4324b70501132855b5e59029acfc5d3da1ebd","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Pisces/_menu.styl","hash":"85da2f3006f4bef9a2199416ecfab4d288f848c4","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Pisces/_sidebar.styl","hash":"44f47c88c06d89d06f220f102649057118715828","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Pisces/_sub-menu.styl","hash":"e740deadcfc4f29c5cb01e40f9df6277262ba4e3","modified":1611669905758},{"_id":"themes/nextTheme/source/css/_schemes/Pisces/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1611669905759},{"_id":"themes/nextTheme/source/js/mathjax/a11y/assistive-mml.js","hash":"5372ec023e91dfa9e0dfe12e23575522f4f9de74","modified":1612601981343},{"_id":"themes/nextTheme/source/js/mathjax/a11y/complexity.js","hash":"3334351ed583aa6ca00790ebc491c5bae62d1093","modified":1612601981347},{"_id":"themes/nextTheme/source/js/mathjax/a11y/semantic-enrich.js","hash":"97ab0c470b090e1abf5eca5f1a5cc0537968d348","modified":1612601981352},{"_id":"themes/nextTheme/source/js/mathjax/adaptors/liteDOM.js","hash":"424b1368f6ffb0665dec5eef2b95b5ef9f80b50d","modified":1612601981381},{"_id":"themes/nextTheme/source/js/mathjax/a11y/explorer.js","hash":"819a0463f08abf43f9dddecaca40aa60f87df933","modified":1612601981350},{"_id":"themes/nextTheme/source/js/mathjax/input/mml.js","hash":"7772feba4ff7e5de08156da163d33155ee4cda49","modified":1612601981448},{"_id":"themes/nextTheme/source/js/mathjax/sre/sre-node.js","hash":"ebfe0186250d35441be4148c36b75ed95d158177","modified":1612601981734},{"_id":"themes/nextTheme/source/js/mathjax/ui/safe.js","hash":"af5c93175420ccd4447685e6f27baf4e4db2a98f","modified":1612601981956},{"_id":"themes/nextTheme/source/lib/fancybox/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1611669905767},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.css","hash":"e43435fb9eaa918f5b8e35c9e110124b8bd13751","modified":1611669905767},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1611669905767},{"_id":"themes/nextTheme/source/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1611669905769},{"_id":"themes/nextTheme/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1611669905769},{"_id":"themes/nextTheme/source/lib/three/lib/CanvasRenderer.js","hash":"cf8e1ce6e884023ad0d692cf30f399862407fb40","modified":1611669905774},{"_id":"themes/nextTheme/source/lib/three/lib/Projector.js","hash":"1ad16e96cea2a8a9155bb429c83ef9bdd341ce99","modified":1611669905775},{"_id":"themes/nextTheme/source/lib/three/src/canvas_lines.js","hash":"650310ff6783671f8ceccf01f840b20d9c87b491","modified":1611669905775},{"_id":"themes/nextTheme/source/lib/three/src/canvas_sphere.js","hash":"7614790c67d3e79e3390fe688f6b01afad7e3bb1","modified":1611669905776},{"_id":"themes/nextTheme/source/lib/three/src/three-waves.js","hash":"e98e442f14920e9fb8691846dca3a2225d403048","modified":1611669905776},{"_id":"themes/nextTheme/source/css/_common/components/post/post-collapse.styl","hash":"e75693f33dbc92afc55489438267869ae2f3db54","modified":1611669905748},{"_id":"themes/nextTheme/source/css/_common/components/post/post-eof.styl","hash":"902569a9dea90548bec21a823dd3efd94ff7c133","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-copyright.styl","hash":"f49ca072b5a800f735e8f01fc3518f885951dd8e","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-expand.styl","hash":"ded41fd9d20a5e8db66aaff7cc50f105f5ef2952","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-gallery.styl","hash":"72d495a88f7d6515af425c12cbc67308a57d88ea","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-followme.styl","hash":"1e4190c10c9e0c9ce92653b0dbcec21754b0b69d","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-header.styl","hash":"65cb6edb69e94e70e3291e9132408361148d41d5","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-nav.styl","hash":"6a97bcfa635d637dc59005be3b931109e0d1ead5","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-reward.styl","hash":"d114b2a531129e739a27ba6271cfe6857aa9a865","modified":1611669905749},{"_id":"themes/nextTheme/source/css/_common/components/post/post-rtl.styl","hash":"f5c2788a78790aca1a2f37f7149d6058afb539e0","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/components/post/post-tags.styl","hash":"99e12c9ce3d14d4837e3d3f12fc867ba9c565317","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/components/post/post.styl","hash":"a760ee83ba6216871a9f14c5e56dc9bd0d9e2103","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/components/post/post-widgets.styl","hash":"5b5649b9749e3fd8b63aef22ceeece0a6e1df605","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/components/pages/breadcrumb.styl","hash":"fafc96c86926b22afba8bb9418c05e6afbc05a57","modified":1611669905748},{"_id":"themes/nextTheme/source/css/_common/components/pages/categories.styl","hash":"2bd0eb1512415325653b26d62a4463e6de83c5ac","modified":1611669905748},{"_id":"themes/nextTheme/source/css/_common/components/pages/schedule.styl","hash":"e771dcb0b4673e063c0f3e2d73e7336ac05bcd57","modified":1611669905748},{"_id":"themes/nextTheme/source/css/_common/components/pages/pages.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1611669905748},{"_id":"themes/nextTheme/source/css/_common/components/third-party/gitalk.styl","hash":"8a7fc03a568b95be8d3337195e38bc7ec5ba2b23","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/components/pages/tag-cloud.styl","hash":"d21d4ac1982c13d02f125a67c065412085a92ff2","modified":1611669905748},{"_id":"themes/nextTheme/source/css/_common/components/third-party/math.styl","hash":"b49e9fbd3c182b8fc066b8c2caf248e3eb748619","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/components/third-party/related-posts.styl","hash":"e2992846b39bf3857b5104675af02ba73e72eed5","modified":1611669905750},{"_id":"themes/nextTheme/source/css/_common/components/third-party/search.styl","hash":"9f0b93d109c9aec79450c8a0cf4a4eab717d674d","modified":1611669905751},{"_id":"themes/nextTheme/source/css/_common/components/third-party/third-party.styl","hash":"9a878d0119785a2316f42aebcceaa05a120b9a7a","modified":1611669905751},{"_id":"themes/nextTheme/source/css/_common/outline/footer/footer.styl","hash":"454a4aebfabb4469b92a8cbb49f46c49ac9bf165","modified":1611669905751},{"_id":"themes/nextTheme/source/css/_common/outline/header/bookmark.styl","hash":"e2d606f1ac343e9be4f15dbbaf3464bc4df8bf81","modified":1611669905751},{"_id":"themes/nextTheme/source/css/_common/outline/header/github-banner.styl","hash":"e7a9fdb6478b8674b1cdf94de4f8052843fb71d9","modified":1611669905751},{"_id":"themes/nextTheme/source/css/_common/outline/header/header.styl","hash":"a793cfff86ad4af818faef04c18013077873f8f0","modified":1611669905751},{"_id":"themes/nextTheme/source/css/_common/outline/header/headerband.styl","hash":"0caf32492692ba8e854da43697a2ec8a41612194","modified":1611669905751},{"_id":"themes/nextTheme/source/css/_common/outline/header/menu.styl","hash":"5f432a6ed9ca80a413c68b00e93d4a411abf280a","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/outline/header/site-meta.styl","hash":"45a239edca44acecf971d99b04f30a1aafbf6906","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/outline/header/site-nav.styl","hash":"b2fc519828fe89a1f8f03ff7b809ad68cd46f3d7","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"2cb1876e9e0c9ac32160888af27b1178dbcb0616","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"fa0222197b5eee47e18ac864cdc6eac75678b8fe","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"44487d9ab290dc97871fa8dd4487016deb56e123","modified":1611669905752},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"1f0e7fbe80956f47087c2458ea880acf7a83078b","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"9b479c2f9a9bfed77885e5093b8245cc5d768ec7","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"a960a2dd587b15d3b3fe1b59525d6fa971c6a6ec","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"a05a4031e799bc864a4536f9ef61fe643cd421af","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"b3220db827e1adbca7880c2bb23e78fa7cbe95cb","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/sidebar.styl","hash":"a9cd93c36bae5af9223e7804963096274e8a4f03","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/outline/sidebar/site-state.styl","hash":"2a47f8a6bb589c2fb635e6c1e4a2563c7f63c407","modified":1611669905753},{"_id":"themes/nextTheme/source/css/_common/scaffolding/highlight/diff.styl","hash":"d3f73688bb7423e3ab0de1efdf6db46db5e34f80","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"f71a3e86c05ea668b008cf05a81f67d92b6d65e4","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/highlight/highlight.styl","hash":"35c871a809afa8306c8cde13651010e282548bc6","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"1d2778ca5aeeeafaa690dc2766b01b352ab76a02","modified":1611669905755},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"709d10f763e357e1472d6471f8be384ec9e2d983","modified":1611669905755},{"_id":"themes/nextTheme/source/css/_common/scaffolding/highlight/theme.styl","hash":"3b3acc5caa0b95a2598bef4eeacb21bab21bea56","modified":1611669905754},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tags/label.styl","hash":"d7fce4b51b5f4b7c31d93a9edb6c6ce740aa0d6b","modified":1611669905755},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tags/note.styl","hash":"e4d9a77ffe98e851c1202676940097ba28253313","modified":1611669905755},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tags/pdf.styl","hash":"b49c64f8e9a6ca1c45c0ba98febf1974fdd03616","modified":1611669905755},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tags/tags.styl","hash":"9e4c0653cfd3cc6908fa0d97581bcf80861fb1e7","modified":1611669905756},{"_id":"themes/nextTheme/source/css/_common/scaffolding/tags/tabs.styl","hash":"f23670f1d8e749f3e83766d446790d8fd9620278","modified":1611669905755},{"_id":"themes/nextTheme/source/js/mathjax/input/mml/entities.js","hash":"836b54f30619d2523b6ebc4ab33a2204e2549545","modified":1612601981447},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/action.js","hash":"296f000bb6cfd28c818b0af05d6656ea1f314bc2","modified":1612601981450},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/ams.js","hash":"943dfb788d9d08d3c3464a01011b5120c969c029","modified":1612601981452},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/amscd.js","hash":"556449a2658ce826cd3b645d9e7edf44e6b67bc9","modified":1612601981453},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/autoload.js","hash":"89e8cecace9677e7634c28faf68d13e61f624d49","modified":1612601981453},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/bbox.js","hash":"7bd5504fb6d8fad2e711b4586cac3e92e9feb301","modified":1612601981454},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/boldsymbol.js","hash":"5624628c24258b5c9578a0f61dceecd4a57fe6f2","modified":1612601981455},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/braket.js","hash":"b3b97cc102563f9de6fca6fb131ea1d334c94f45","modified":1612601981456},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/cancel.js","hash":"42bb28c206f9fc309bd948457e54dbd67eb0945f","modified":1612601981458},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/bussproofs.js","hash":"ce27b7ac5232f67ad6e945fe5c699228fae729fe","modified":1612601981457},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/color.js","hash":"a35e15dd311b190cb889c3090bda76d2f522422f","modified":1612601981458},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/configmacros.js","hash":"cf3328108ac94a80ef80eb724fcb572a6221278b","modified":1612601981460},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/colorv2.js","hash":"f94baf407a2144392984992845fba89ed89aa979","modified":1612601981459},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/enclose.js","hash":"c314540938c51a2a337395850561bb026338f759","modified":1612601981460},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/extpfeil.js","hash":"c4b81b6b5cbe7c54ba6d98e55a5d537cd3871047","modified":1612601981461},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/html.js","hash":"539f2a894ed6b6d2f661125b653b6b1492b50622","modified":1612601981462},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/newcommand.js","hash":"2916b690bdb81c345e565a1834fa7d823879054d","modified":1612601981465},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/noerrors.js","hash":"d78b4d7473d88fe2c9c47ed56794741062b4b7dd","modified":1612601981465},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/noundefined.js","hash":"3989e661bd8e6062a8aba23263e257680e0016e5","modified":1612601981466},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/mhchem.js","hash":"940808a4039c7aa89dc20ffbb8eac05f3b5fa4a1","modified":1612601981464},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/require.js","hash":"5f16746e0b4a6c1464b3e0892d40457d99132e0f","modified":1612601981467},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/physics.js","hash":"91e3017e1968d91a049a23e3cdfa0d4b20765946","modified":1612601981466},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/tagformat.js","hash":"0101bbcd701429bf4e6d31b0b590564d27f3db3b","modified":1612601981468},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/unicode.js","hash":"4803470d9d113a7b3595ef28fcca723d90941d57","modified":1612601981471},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/verb.js","hash":"d38b935f35726ceb7b45c2a13e86055b9e4043bc","modified":1612601981472},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/textmacros.js","hash":"fe5cfd463c2fdac21cde19b0eaa552deae507a9a","modified":1612601981468},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff","hash":"6bc2c425db1226bf91a45c5ac4bf92c6a2659e4c","modified":1612601981669},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff","hash":"4f45a4737793be31b0cf5606a717b27d4f33633f","modified":1612601981669},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff","hash":"69abf851342ea0ea88cd7a48a3855a8da85144ce","modified":1612601981670},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff","hash":"0db97c087590f9e4866e376183d5dc11f10db0be","modified":1612601981671},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff","hash":"28704c6a56970ba681fc09763ad3b6d4d1f408a4","modified":1612601981672},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff","hash":"1b39dd27087cec46eb36b4b0cb967c7a2b7548ae","modified":1612601981672},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff","hash":"b83eded6d73439a0387219214d0a320a3c3b0d7e","modified":1612601981673},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff","hash":"89d2c8d274693c5a6e250e96e2a2e26e25619079","modified":1612601981674},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff","hash":"de80661cd5bc7e2328217db699a0ef7159d27a2e","modified":1612601981675},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff","hash":"91a4025dd3b18ca6bda63a215869773705435041","modified":1612601981676},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Regular.woff","hash":"440031e5fd0684c5e38a9221114d280a55763ad4","modified":1612601981677},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff","hash":"8ec440016063a0dcd1e8d7e806ec86b2babfea29","modified":1612601981677},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff","hash":"9a30c856fa1957552d0226a600bf28fd8f417413","modified":1612601981678},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff","hash":"b14c723751a0ac1f8a94ed55fabf6ebeb38559ce","modified":1612601981679},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff","hash":"9c98f9f022647eb802434947e062b569ccedd5f0","modified":1612601981680},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff","hash":"c668b55e8405d2f8acf2bcf1578d01838a8ef399","modified":1612601981680},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff","hash":"5848fbf600fbb7d4a67e720e60da885ba4e12bb8","modified":1612601981682},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff","hash":"53e2fb218469bb4b2118437e542cc018f849747b","modified":1612601981681},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff","hash":"683c23731b31b766d8ed805b2d258eaab52085db","modified":1612601981683},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff","hash":"14dd272bd9ce18c5a32bcaef50107d872a7d8543","modified":1612601981684},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff","hash":"8dc0fe3bcd2cf9d3e46c3feb3a21b62961aa557c","modified":1612601981683},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff","hash":"1c6d1ec6fcfecc0585e93c2ac52a4ab8a34b1b77","modified":1612601981685},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Zero.woff","hash":"6712cf0aa5c12edc1cbbca8a1732a9cde0854c48","modified":1612601981685},{"_id":"themes/nextTheme/source/js/fancybox.mini.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1611669905764},{"_id":"themes/nextTheme/source/js/fancybox.js","hash":"c8e1c8b386dc5b7a9184c763c88d19a346eb3342","modified":1611669905764},{"_id":"themes/nextTheme/source/js/valine.min.js","hash":"deaa627029a24fc0fef9f6cad3a46118dcd58256","modified":1612600656040},{"_id":"themes/nextTheme/source/js/mathjax/input/asciimath.js","hash":"12a8993f8c7d893d637cb3143d57aa160d4bbb71","modified":1612601981445},{"_id":"themes/nextTheme/source/js/mathjax/input/tex-base.js","hash":"94b077d61ee163431253f23d8bf48dd449f24a6a","modified":1612601981474},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1611669905768},{"_id":"themes/nextTheme/source/js/mathjax/ui/menu.js","hash":"b0ec99c79e515bccfb029e3cf8c966357e2428ab","modified":1612601981954},{"_id":"themes/nextTheme/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1611669905769},{"_id":"themes/nextTheme/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1611669905769},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml/fonts/tex.js","hash":"64bb0fc88cbdec760b57c0e3f289ca3552da8402","modified":1612601981666},{"_id":"themes/nextTheme/source/images/title.webp","hash":"9c24c251cf7e790bd340414eef1ba8a878efd361","modified":1612486416711},{"_id":"themes/nextTheme/source/js/mathjax/input/tex.js","hash":"fc1852b3c03a9adc1758b1db78610a5198416ee3","modified":1612601981477},{"_id":"themes/nextTheme/source/js/mathjax/output/svg.js","hash":"5f6efb05f98d07fb09eeb2f2e32b937c8aedea45","modified":1612601981692},{"_id":"themes/nextTheme/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"27f034e5db8c32e268e2959b9a7c1258d36e4510","modified":1611669905768},{"_id":"themes/nextTheme/source/js/mathjax/input/tex/extensions/all-packages.js","hash":"c5b1057a328b44bf7299939766067522bfa1e16d","modified":1612601981451},{"_id":"themes/nextTheme/source/js/av-min.js","hash":"706b41ebb6381a89b52578a25c71a73d28155c6c","modified":1611706964407},{"_id":"themes/nextTheme/source/js/mathjax/core.js","hash":"5287dddb297681ebfb51eac27a6a18ff14b019ae","modified":1612601981414},{"_id":"themes/nextTheme/source/js/mathjax/output/chtml.js","hash":"a927bd486356127818659fc2772de6bf44b1c851","modified":1612601981687},{"_id":"themes/nextTheme/source/js/mathjax/sre/mathmaps/nemeth.js","hash":"6591cac31a30b5366bc07b97ce1abd96eafb4009","modified":1612601981733},{"_id":"themes/nextTheme/source/js/mathjax/node-main.js","hash":"328aef447c6404a034e7c9f31d8f673703ab25fa","modified":1612601981635},{"_id":"themes/nextTheme/source/js/mathjax/sre/mathmaps/de.js","hash":"f2c125baba05ec138602f3bbc1c12365dde82237","modified":1612601981721},{"_id":"themes/nextTheme/source/js/mathjax/sre/mathmaps/fr.js","hash":"f5037a98b33b24c9fe23e4bd50450a69360a2e8d","modified":1612601981726},{"_id":"themes/nextTheme/source/js/mathjax/input/tex-full.js","hash":"82aef103c40aa175c535b1485f6c4f7c9af31e29","modified":1612601981476},{"_id":"themes/nextTheme/source/js/mathjax/sre/mathmaps/es.js","hash":"88938b14c6187b49469d8945ff8879d7cca13e4d","modified":1612601981725},{"_id":"themes/nextTheme/source/js/mathjax/sre/mathmaps/en.js","hash":"5400c569ff7a152ebc7f3661f69d29f2db1745c2","modified":1612601981723},{"_id":"themes/nextTheme/source/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1611669905778},{"_id":"themes/nextTheme/source/js/mathjax/mml-chtml.js","hash":"89bde7029d87e5bf73a810ad9df6986f5fdaed65","modified":1612601981577},{"_id":"themes/nextTheme/source/js/mathjax/tex-chtml.js","hash":"14142392a7d04afa3167ea97fe5fca9ac46299e4","modified":1612601981804},{"_id":"themes/nextTheme/source/js/mathjax/tex-mml-chtml.js","hash":"ddf9e9789b79e2492ef51a22b6be30c8c8cd07a3","modified":1612601981833},{"_id":"themes/nextTheme/source/js/mathjax/math-tex-mml-chtml.js","hash":"ddf9e9789b79e2492ef51a22b6be30c8c8cd07a3","modified":1612601952293},{"_id":"themes/nextTheme/source/js/mathjax/tex-chtml-full.js","hash":"b6e6382fd1d385c65a8a90250ada566e643fd7af","modified":1612601981776},{"_id":"themes/nextTheme/source/js/mathjax/sre/sre_browser.js","hash":"91a52d8eb7ed3c58bd73fecbc8508eaa5c5e273d","modified":1612601981737},{"_id":"themes/nextTheme/source/js/mathjax/output/svg/fonts/tex.js","hash":"41e7ee126ea2c11b2ee17080043c6b065d889c33","modified":1612601981691},{"_id":"themes/nextTheme/source/js/mathjax/sre/mathmaps/mathmaps_ie.js","hash":"7592ab1ae061b0ff612509da64229d96be2aff87","modified":1612601981731},{"_id":"themes/nextTheme/source/js/mathjax/mml-svg.js","hash":"d7b174cc08791a4dabd1181af25bc559ab54a446","modified":1612601981607},{"_id":"themes/nextTheme/source/js/mathjax/tex-mml-svg.js","hash":"53330ec997c7398504bea30173aec8c24751cec1","modified":1612601981867},{"_id":"themes/nextTheme/source/js/mathjax/tex-svg.js","hash":"a4dcabf818d039da6df20e2dbb647385fe234a9a","modified":1612601981929},{"_id":"themes/nextTheme/source/js/mathjax/tex-svg-full.js","hash":"1b192a7b819bbaf6d25e9dfda327c1bbb21bd518","modified":1612601981898},{"_id":"public/baidusitemap.xml","hash":"8b507c2bb9fa1a87b5ff29c05731d7cc1da2c5d7","modified":1612603875012},{"_id":"public/search.xml","hash":"bee24674545725b21821a72e91e541de944b91f8","modified":1612603875012},{"_id":"public/sitemap.xml","hash":"d18b0e1401eee76134577a5a21c42cef0bf8890e","modified":1612603875012},{"_id":"public/categories/index.html","hash":"45c3ff4d23649579e0933ce7d2279a844eb2dbf8","modified":1612603875012},{"_id":"public/tags/index.html","hash":"d1d3d1735d8f87e9ec31bb6e187c3872b4a921be","modified":1612603875012},{"_id":"public/archives/257c4ce2.html","hash":"66418a33f44522ef132825abe8ebefdda7d3afb8","modified":1612603875012},{"_id":"public/archives/53e1932f.html","hash":"e13ae41a21efc4edb2c7b6969a066b260508671a","modified":1612603875012},{"_id":"public/archives/cb90ed2a.html","hash":"36bd4b9993e14db5bee79e81205269c6dd39d954","modified":1612603875012},{"_id":"public/archives/44b34745.html","hash":"d1c56bbef7d77ddc123d0dd8eea19d75ff763552","modified":1612603875012},{"_id":"public/archives/2de36dd7.html","hash":"7540f393a6b6be4d93116540e1bfd060be9861fb","modified":1612603875012},{"_id":"public/archives/a82ae489.html","hash":"e14926c87dbb7d5854b51f055d80f4cef359d566","modified":1612603875012},{"_id":"public/archives/513dbeba.html","hash":"8f3db53d0440e7e5e67b9623cb2b0f7669b0beb4","modified":1612603875012},{"_id":"public/archives/4f05d45d.html","hash":"ed54cc3bd3193b4b0c52ddf49365522e3ee959d8","modified":1612603875012},{"_id":"public/archives/c770fe49.html","hash":"59ac55a1a2dea1f211ba56afc0ecdb0828bdc687","modified":1612603875012},{"_id":"public/archives/b4edbd7.html","hash":"8a353f820ec9c9a257268bf8b69442b8f342b1dd","modified":1612603875012},{"_id":"public/archives/9bb71eca.html","hash":"77ec549ab218dcad4d2ed7ba17457420e37a1fb5","modified":1612603875012},{"_id":"public/archives/392d66f0.html","hash":"fb39d9a3b257ed4422f79c2a81a282e500d7e2d2","modified":1612603875012},{"_id":"public/archives/ba7b70bf.html","hash":"4d8839fe3b71e458dc1a55848fb957e5e16efab2","modified":1612603875012},{"_id":"public/archives/5ce14ff5.html","hash":"d6efc921ba99e72c64308087547213f56226976c","modified":1612603875012},{"_id":"public/archives/5c6a362f.html","hash":"c4168080e732989f22efc3be10ac2383c5cd0737","modified":1612603875012},{"_id":"public/archives/b885f9f7.html","hash":"3b45c4ef6162d2486d6d05ebed48cd97c961187e","modified":1612603875012},{"_id":"public/archives/5544baea.html","hash":"e3b505b22ca93b36a5999eb6b8e7afc50efab903","modified":1612603875012},{"_id":"public/archives/425d5e80.html","hash":"58d2a079cc14d6eea6d9bfdeaebda1f4592cbd8e","modified":1612603875012},{"_id":"public/archives/2ce846ed.html","hash":"49d8299853d4025e5bf481e378aae5902c10f0f0","modified":1612603875012},{"_id":"public/archives/ae4aba0d.html","hash":"32b8f4588db6301b3275c3ddbc33c089a18551d1","modified":1612603875012},{"_id":"public/archives/ba455c1d.html","hash":"c5d8df7981157bab70a1daa9621119d276ca6257","modified":1612603875012},{"_id":"public/archives/1191d613.html","hash":"796640c4060fc9125247cc1c9821d12e990702a2","modified":1612603875012},{"_id":"public/archives/e18c94ab.html","hash":"ce3ed72c130501e04cdb748bdb59872f5bf76884","modified":1612603875012},{"_id":"public/archives/ff0d6c2b.html","hash":"6c971566ad48924a6b3aa4421410c20ba11e80f0","modified":1612603875012},{"_id":"public/archives/e2e7cc4e.html","hash":"d7ca4c05078f60dfc146d95e1da9eb7de8d2d9ce","modified":1612603875012},{"_id":"public/archives/3038b6c3.html","hash":"913138290d1383284e10e8f7387b7e04ca65091d","modified":1612603875012},{"_id":"public/archives/410dfaec.html","hash":"652cd8961bac12f7276f62568acf0d5173293ec4","modified":1612603875012},{"_id":"public/archives/bddc30f6.html","hash":"b4e1090db44bfe5ffedea187fc6563a7e0409c49","modified":1612603875012},{"_id":"public/archives/580377d0.html","hash":"f7afc0d49dc203fd582ba58387633f128ddeca46","modified":1612603875012},{"_id":"public/archives/3c1dd822.html","hash":"d8fa2d78fd5bcbba24e0ed810f5133a9c9d9d822","modified":1612603875012},{"_id":"public/archives/458b44c2.html","hash":"ed7a22b1dc8c1142ba51bcdb7ca695540ec983f0","modified":1612603875012},{"_id":"public/archives/8cf3cbca.html","hash":"bd53bfc2a502375b771053a715b3dc2d25edf6df","modified":1612603875012},{"_id":"public/archives/640b5696.html","hash":"55dff6024ed947262d4755b714e1b165bd427a88","modified":1612603875012},{"_id":"public/archives/index.html","hash":"eb4a802cadb80cc61cdaf380dedaff6afbe213cf","modified":1612603875012},{"_id":"public/archives/page/2/index.html","hash":"c47fdc2cb69631a5db4fefd14a0f6fe5b0471e13","modified":1612603875012},{"_id":"public/archives/page/3/index.html","hash":"6bf982d2f961db5e0bd84ff018a5ff59d75303b5","modified":1612603875012},{"_id":"public/archives/page/4/index.html","hash":"63b76bc0f4a4980467ecbd215ed9fd0546bc8319","modified":1612603875012},{"_id":"public/archives/2020/index.html","hash":"861618ace1f69d83c48cf2df037873871246ce3f","modified":1612603875012},{"_id":"public/archives/2020/page/2/index.html","hash":"3a52da7fef6f344a6ef35e33f4e4747553f889e6","modified":1612603875012},{"_id":"public/archives/2020/page/3/index.html","hash":"4400300f86c9306fe9e2eb54b3c6dbc6476c31d1","modified":1612603875012},{"_id":"public/archives/2020/08/index.html","hash":"2d146c6b5ba099a85dea3dc6f14263f6f39151e9","modified":1612603875012},{"_id":"public/archives/2020/09/index.html","hash":"b01ef6c59304d9cfaf401ec1cb9fe82486165997","modified":1612603875012},{"_id":"public/archives/2020/09/page/2/index.html","hash":"6fb36443f4dcbb5964b642e77bd6da6872399392","modified":1612603875012},{"_id":"public/archives/2020/10/index.html","hash":"e66d1bc16ed01b1697c4d93185b4068c88d31930","modified":1612603875012},{"_id":"public/archives/2020/11/index.html","hash":"c948e6b9098bf604f8209dd076f0abc9caeab420","modified":1612603875012},{"_id":"public/archives/2020/12/index.html","hash":"ab3c8654fa228228cdf06e6357c983864f5e9b67","modified":1612603875012},{"_id":"public/archives/2021/index.html","hash":"596e103a4adc4bc26001f5a5c1fcb20167361268","modified":1612603875012},{"_id":"public/archives/2021/01/index.html","hash":"b40576af00f0527d96843969ecaca55caf07fb2d","modified":1612603875012},{"_id":"public/archives/2021/02/index.html","hash":"d14305a2625f28a31273bd485ce6b047b0f14647","modified":1612603875012},{"_id":"public/index.html","hash":"21cf84d2491c36c9d066dacdc294229a4f1c2ee6","modified":1612603875012},{"_id":"public/page/2/index.html","hash":"270b5e1e14787722380c2efcaac838eabfecbf9f","modified":1612603875012},{"_id":"public/page/3/index.html","hash":"750b8f69796cab9001427399d4bdcc473bf05205","modified":1612603875012},{"_id":"public/page/4/index.html","hash":"97a155c275bd5448e680ed65f8765daecab628c1","modified":1612603875012},{"_id":"public/tags/Go/index.html","hash":"40b6551ffc5e93616a9d479f49f1c5e2c742a4e8","modified":1612603875012},{"_id":"public/tags/Go/page/2/index.html","hash":"87067bce5eb42686496c7cb1717a17c577071d93","modified":1612603875012},{"_id":"public/tags/GPM/index.html","hash":"4cde6416970e0ab3cb19ac12cfd05d8312544166","modified":1612603875012},{"_id":"public/tags/Go源码/index.html","hash":"b94110d8f229e445b3110124c0b3e6f7bbffdfb6","modified":1612603875012},{"_id":"public/tags/Git/index.html","hash":"f3726c2cbe2ed1473b6c01618e3b8d90fb96a62c","modified":1612603875012},{"_id":"public/tags/life/index.html","hash":"93b7e65fa36e35d7812e42046adcdf3ed1b6b4ad","modified":1612603875012},{"_id":"public/tags/hexo/index.html","hash":"e853b61f4ee200291bedcccc3e8fa058ddac8617","modified":1612603875012},{"_id":"public/tags/hexo插件/index.html","hash":"19a9327b5c31a48d464b68cb8431e8b091757a3b","modified":1612603875012},{"_id":"public/tags/Go-Package/index.html","hash":"af9cd7ed387c35a20439ab4b2d8b5c4566aa7315","modified":1612603875012},{"_id":"public/tags/锁/index.html","hash":"993d5d92987387b14d450b251f33346175c34a44","modified":1612603875012},{"_id":"public/tags/Day/index.html","hash":"d28d3e504f13b770e0835f8b95c4a8369354fa63","modified":1612603875012},{"_id":"public/tags/Day/page/2/index.html","hash":"5b4ec00820f612de5caec9f48e4dd30569ddc9c3","modified":1612603875012},{"_id":"public/tags/Linux/index.html","hash":"62e02e5205eed5a8e86dc59c41ee09c022bb5ec2","modified":1612603875012},{"_id":"public/tags/进程/index.html","hash":"ebf779a9f415134dbb73526f597a517d20e8994d","modified":1612603875012},{"_id":"public/tags/Plan9/index.html","hash":"8dde560c0debc8475871b11096ad2bde1b7d791f","modified":1612603875012},{"_id":"public/tags/chrome/index.html","hash":"850f98e78cc49a230fa2f1933f68ce8cfff448b9","modified":1612603875012},{"_id":"public/tags/vscode/index.html","hash":"756048d924ea2bb2715a4874c4003c99e0f4d77d","modified":1612603875012},{"_id":"public/tags/工具/index.html","hash":"c293e5b3deae15155e1f6b475c758aa6ea92d46c","modified":1612603875012},{"_id":"public/tags/博客/index.html","hash":"408d3a5d6b9fc2f92ff67b97318609c2592f3081","modified":1612603875012},{"_id":"public/tags/v1-16/index.html","hash":"4383b120333557031bd7fc4688ee5897ac552102","modified":1612603875012},{"_id":"public/tags/encoding-json/index.html","hash":"b735e13cf0aaea33641dafc10bbe12fa2710b01f","modified":1612603875012},{"_id":"public/tags/time/index.html","hash":"035aef3a322d39f140a264d8b8179f73a47dbf51","modified":1612603875012},{"_id":"public/tags/sync/index.html","hash":"31c8d27f3483df3fa5a82063b9d4fd37bd778355","modified":1612603875012},{"_id":"public/tags/Mutex/index.html","hash":"ec9df9575032dc6c6a4bf74b76d573fb79de3008","modified":1612603875012},{"_id":"public/tags/Map/index.html","hash":"ae7e43ff1bc91c51d647dbb11ca5c26455abae94","modified":1612603875012},{"_id":"public/tags/Hash/index.html","hash":"ef78d166a980cebc646cef9d602506db934f9d94","modified":1612603875012},{"_id":"public/tags/Redis/index.html","hash":"59bd9c2d13711cf290ada9a007b79778807815c7","modified":1612603875012},{"_id":"public/tags/RDB/index.html","hash":"3ae6a02d90c3e019e6794495998563f3bce3ffdf","modified":1612603875012},{"_id":"public/tags/源码/index.html","hash":"7bac9d00dbe4bc6869e7a8877af6a5b4b8b6e893","modified":1612603875012},{"_id":"public/tags/Golang/index.html","hash":"64028791991450d07e9425f0ec6aeed199d81c8e","modified":1612603875012},{"_id":"public/tags/Float/index.html","hash":"0be5d8fade68298d5b42876797dae2669ec6a02f","modified":1612603875012},{"_id":"public/tags/IEEE/index.html","hash":"5566ee3cfec11cd03f677737c45165791c481d4d","modified":1612603875012},{"_id":"public/tags/ticker/index.html","hash":"1132ed67c131021301693a66c04edf3d353ae7c9","modified":1612603875012},{"_id":"public/tags/defer/index.html","hash":"43b5806933e540528672f55a8abe0126fadc8aba","modified":1612603875012},{"_id":"public/tags/位运算/index.html","hash":"85812992faab8e127baac4ca928e9aa71777ff6e","modified":1612603875012},{"_id":"public/tags/Go-reflect/index.html","hash":"2de55ea6bd012c98af040a11353bb9e1e495bd9a","modified":1612603875012},{"_id":"public/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1612603875012},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1612603875012},{"_id":"public/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1612603875012},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1612603875012},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1612603875012},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1612603875012},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1612603875012},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1612603875012},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1612603875012},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1612603875012},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1612603875012},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1612603875012},{"_id":"public/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1612603875012},{"_id":"public/images/scroll.png","hash":"443930af0ee54778babad7724291bfed9b431dd5","modified":1612603875012},{"_id":"public/lib/KFOlCnqEu92Fr1MmWUlfBBc4AMP6lQ.woff2","hash":"5789e81a66958aabc7590c1ddd41058335636027","modified":1612603875012},{"_id":"public/lib/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2","hash":"6ff06a34f68ad0324ddec1bbe4d453c959178b36","modified":1612603875012},{"_id":"public/lib/KFOkCnqEu92Fr1Mu51xIIzIXKMny.woff2","hash":"6328533762fd139a66466929231898eb893f78d1","modified":1612603875012},{"_id":"public/lib/canvas-nest/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1612603875012},{"_id":"public/lib/canvas-ribbon/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1612603875012},{"_id":"public/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1612603875012},{"_id":"public/lib/fancybox/LICENSE","hash":"8624bcdae55baeef00cd11d5dfcfa60f68710a02","modified":1612603875012},{"_id":"public/lib/reading_progress/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1612603875012},{"_id":"public/lib/three/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1612603875012},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff","hash":"4f45a4737793be31b0cf5606a717b27d4f33633f","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff","hash":"6bc2c425db1226bf91a45c5ac4bf92c6a2659e4c","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff","hash":"69abf851342ea0ea88cd7a48a3855a8da85144ce","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff","hash":"0db97c087590f9e4866e376183d5dc11f10db0be","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff","hash":"28704c6a56970ba681fc09763ad3b6d4d1f408a4","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff","hash":"b83eded6d73439a0387219214d0a320a3c3b0d7e","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff","hash":"1b39dd27087cec46eb36b4b0cb967c7a2b7548ae","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff","hash":"de80661cd5bc7e2328217db699a0ef7159d27a2e","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff","hash":"89d2c8d274693c5a6e250e96e2a2e26e25619079","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Regular.woff","hash":"440031e5fd0684c5e38a9221114d280a55763ad4","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff","hash":"91a4025dd3b18ca6bda63a215869773705435041","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff","hash":"9a30c856fa1957552d0226a600bf28fd8f417413","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff","hash":"8ec440016063a0dcd1e8d7e806ec86b2babfea29","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff","hash":"b14c723751a0ac1f8a94ed55fabf6ebeb38559ce","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff","hash":"9c98f9f022647eb802434947e062b569ccedd5f0","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff","hash":"53e2fb218469bb4b2118437e542cc018f849747b","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff","hash":"c668b55e8405d2f8acf2bcf1578d01838a8ef399","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff","hash":"5848fbf600fbb7d4a67e720e60da885ba4e12bb8","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff","hash":"683c23731b31b766d8ed805b2d258eaab52085db","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff","hash":"14dd272bd9ce18c5a32bcaef50107d872a7d8543","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff","hash":"1c6d1ec6fcfecc0585e93c2ac52a4ab8a34b1b77","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Zero.woff","hash":"6712cf0aa5c12edc1cbbca8a1732a9cde0854c48","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff","hash":"8dc0fe3bcd2cf9d3e46c3feb3a21b62961aa557c","modified":1612603875012},{"_id":"public/live2dw/assets/hijiki.model.json","hash":"feff43bf7498d213982c3736c2c029664e4bcbd2","modified":1612603875012},{"_id":"public/live2dw/assets/hijiki.pose.json","hash":"81438bf69b32c7c11e311b4fe043730cdc7b7ec2","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/02.mtn","hash":"7eafc52edc73b7cb80ae70d34b43c6ac778fa47b","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/00_idle.mtn","hash":"b224c60e463b9f71ddbfc0c720e430496c175f4f","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/01.mtn","hash":"fb550833ae22c9954c3e01df37ed29b2d61700f2","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/03.mtn","hash":"f900737c7a98441cbb2e05255427e6260e19ae68","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/05.mtn","hash":"dd20ad24b5d1830a5d44b9bccb28f922eea5e0e5","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/04.mtn","hash":"c7a25d3c5d783639bae18db2f3cd284b819c3c85","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/06.mtn","hash":"ad404bd852d276cdd3d054c953e23f90e4e45ae1","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/07.mtn","hash":"b7f2e3a9fa4f3ffbb6e64a08f8d9f45ca1868ffb","modified":1612603875012},{"_id":"public/live2dw/assets/mtn/08.mtn","hash":"4411c7651ff65195b113d95e7d5ebef8a59a37d9","modified":1612603875012},{"_id":"public/live2dw/lib/L2Dwidget.min.js","hash":"5f1a807437cc723bcadc3791d37add5ceed566a2","modified":1612603875012},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1612603875012},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1612603875012},{"_id":"public/images/title.webp","hash":"9c24c251cf7e790bd340414eef1ba8a878efd361","modified":1612603875012},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js","hash":"35bb5b588b6de25c9be2dd51d3fd331feafac02d","modified":1612603875012},{"_id":"public/live2dw/lib/L2Dwidget.min.js.map","hash":"3290fe2df45f065b51a1cd7b24ec325cbf9bb5ce","modified":1612603875012},{"_id":"public/css/fancybox.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1612603875012},{"_id":"public/css/main.css","hash":"5a64e692ed96305bdd00e09c97436c77457c0fd7","modified":1612603875012},{"_id":"public/css/robofont.css","hash":"c3ba185de1e257638ea49592a554f6eec8c9770c","modified":1612603875012},{"_id":"public/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1612603875012},{"_id":"public/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1612603875012},{"_id":"public/js/busuanzi.js","hash":"a30fcd42f277944e6524b99f2412b1f01880b813","modified":1612603875012},{"_id":"public/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1612603875012},{"_id":"public/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1612603875012},{"_id":"public/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1612603875012},{"_id":"public/js/utils.js","hash":"f7353c946f7483139e0ff3f17e7620736d81b1a1","modified":1612603875012},{"_id":"public/js/mathjax/latest.js","hash":"94625a1bbc4afd27b9412c65955581fac9d63145","modified":1612603875012},{"_id":"public/js/mathjax/loader.js","hash":"1ee56611b3087759d7c55f82aca30793ac508599","modified":1612603875012},{"_id":"public/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1612603875012},{"_id":"public/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1612603875012},{"_id":"public/lib/canvas-nest/README.html","hash":"9c1f4c9870811e77a7516e6c15ce88ae94ef596d","modified":1612603875012},{"_id":"public/lib/canvas-nest/canvas-nest-nomobile.min.js","hash":"956eada198babd00f028e8908767cb158926c3f3","modified":1612603875012},{"_id":"public/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1612603875012},{"_id":"public/lib/canvas-ribbon/README.html","hash":"90f05e856cc813fff41e4b73d9657bda3258da1b","modified":1612603875012},{"_id":"public/lib/canvas-ribbon/canvas-ribbon.js","hash":"65b1a8f12d04b15d7ed6eeb9d11dec760a799c5f","modified":1612603875012},{"_id":"public/lib/fancybox/README.html","hash":"597dd82eda2b6d721045d860495a398461cd44ee","modified":1612603875012},{"_id":"public/lib/pace/README.html","hash":"2d29880d72cf65d219051ce11e59a6117b0a501a","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-flat-top.min.css","hash":"5e1c97e232b46e48592a8e4983ae5a89e0a7da6a","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1612603875012},{"_id":"public/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1612603875012},{"_id":"public/lib/reading_progress/README.html","hash":"2437c3eecb95e24cb3497b96fbe08848aa912cc6","modified":1612603875012},{"_id":"public/lib/reading_progress/package.json","hash":"8d6815f29afe52968881f536aee8d9267ba53bd2","modified":1612603875012},{"_id":"public/lib/reading_progress/reading_progress.js","hash":"ec68a79421cfba022ac53f46813d013dd48617c0","modified":1612603875012},{"_id":"public/lib/reading_progress/reading_progress.min.js","hash":"b768dc009e6d37dd952632c317f6c33e6e2d89ad","modified":1612603875012},{"_id":"public/lib/reading_progress/renovate.json","hash":"94990e0ad04ce4a7c6f0ac3543318d9e02db1264","modified":1612603875012},{"_id":"public/lib/three/README.html","hash":"4140ac992eab7c3f7f8a04d35fcc8f27256613de","modified":1612603875012},{"_id":"public/lib/three/gulpfile.js","hash":"e0e9e7051d9d82a37c2aba1df396d8b3916323c4","modified":1612603875012},{"_id":"public/lib/three/package.json","hash":"3e6a0c56ec47a38c0bf7b404f6e46965ec7d2e3d","modified":1612603875012},{"_id":"public/lib/three/renovate.json","hash":"94990e0ad04ce4a7c6f0ac3543318d9e02db1264","modified":1612603875012},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1612603875012},{"_id":"public/js/mathjax/a11y/assistive-mml.js","hash":"5372ec023e91dfa9e0dfe12e23575522f4f9de74","modified":1612603875012},{"_id":"public/js/mathjax/a11y/semantic-enrich.js","hash":"97ab0c470b090e1abf5eca5f1a5cc0537968d348","modified":1612603875012},{"_id":"public/js/mathjax/input/mml.js","hash":"7772feba4ff7e5de08156da163d33155ee4cda49","modified":1612603875012},{"_id":"public/js/mathjax/sre/sre-node.js","hash":"ebfe0186250d35441be4148c36b75ed95d158177","modified":1612603875012},{"_id":"public/js/mathjax/ui/safe.js","hash":"af5c93175420ccd4447685e6f27baf4e4db2a98f","modified":1612603875012},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1612603875012},{"_id":"public/lib/three/src/canvas_lines.js","hash":"650310ff6783671f8ceccf01f840b20d9c87b491","modified":1612603875012},{"_id":"public/lib/three/src/canvas_sphere.js","hash":"7614790c67d3e79e3390fe688f6b01afad7e3bb1","modified":1612603875012},{"_id":"public/lib/three/src/three-waves.js","hash":"e98e442f14920e9fb8691846dca3a2225d403048","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/action.js","hash":"296f000bb6cfd28c818b0af05d6656ea1f314bc2","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/amscd.js","hash":"556449a2658ce826cd3b645d9e7edf44e6b67bc9","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/autoload.js","hash":"89e8cecace9677e7634c28faf68d13e61f624d49","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/bbox.js","hash":"7bd5504fb6d8fad2e711b4586cac3e92e9feb301","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/boldsymbol.js","hash":"5624628c24258b5c9578a0f61dceecd4a57fe6f2","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/braket.js","hash":"b3b97cc102563f9de6fca6fb131ea1d334c94f45","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/cancel.js","hash":"42bb28c206f9fc309bd948457e54dbd67eb0945f","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/color.js","hash":"a35e15dd311b190cb889c3090bda76d2f522422f","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/colorv2.js","hash":"f94baf407a2144392984992845fba89ed89aa979","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/configmacros.js","hash":"cf3328108ac94a80ef80eb724fcb572a6221278b","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/enclose.js","hash":"c314540938c51a2a337395850561bb026338f759","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/extpfeil.js","hash":"c4b81b6b5cbe7c54ba6d98e55a5d537cd3871047","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/html.js","hash":"539f2a894ed6b6d2f661125b653b6b1492b50622","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/newcommand.js","hash":"2916b690bdb81c345e565a1834fa7d823879054d","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/noerrors.js","hash":"d78b4d7473d88fe2c9c47ed56794741062b4b7dd","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/noundefined.js","hash":"3989e661bd8e6062a8aba23263e257680e0016e5","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/require.js","hash":"5f16746e0b4a6c1464b3e0892d40457d99132e0f","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/tagformat.js","hash":"0101bbcd701429bf4e6d31b0b590564d27f3db3b","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/textmacros.js","hash":"fe5cfd463c2fdac21cde19b0eaa552deae507a9a","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/unicode.js","hash":"4803470d9d113a7b3595ef28fcca723d90941d57","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/verb.js","hash":"d38b935f35726ceb7b45c2a13e86055b9e4043bc","modified":1612603875012},{"_id":"public/live2dw/assets/moc/hijiki.moc","hash":"44289e62545a7046e0f5231103a851750b78524e","modified":1612603875012},{"_id":"public/js/fundebug-1.9.0-min.js","hash":"a68d0e2b35c7d6cf60b4b1a0a892cdc51b4732d8","modified":1612603875012},{"_id":"public/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1612603875012},{"_id":"public/js/mathjax/startup.js","hash":"44bfd46ba3524c44a8d0c549ca5e3b82182d9c96","modified":1612603875012},{"_id":"public/lib/pace/pace-theme-material.min.css","hash":"f1ff83985c090f3a3236554c5ef69542dcceb049","modified":1612603875012},{"_id":"public/lib/three/canvas_lines.min.js","hash":"ae6584edc0418d68731cab82c1494f26bd77c07d","modified":1612603875012},{"_id":"public/lib/three/canvas_sphere.min.js","hash":"186c3bd6ae352d336cdbd0e555ee76a844854c94","modified":1612603875012},{"_id":"public/lib/three/three-waves.min.js","hash":"329483be97cdda030779da9a6cd1e3eae645cf4f","modified":1612603875012},{"_id":"public/js/mathjax/a11y/explorer.js","hash":"819a0463f08abf43f9dddecaca40aa60f87df933","modified":1612603875012},{"_id":"public/js/mathjax/a11y/complexity.js","hash":"3334351ed583aa6ca00790ebc491c5bae62d1093","modified":1612603875012},{"_id":"public/js/mathjax/adaptors/liteDOM.js","hash":"424b1368f6ffb0665dec5eef2b95b5ef9f80b50d","modified":1612603875012},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"e43435fb9eaa918f5b8e35c9e110124b8bd13751","modified":1612603875012},{"_id":"public/lib/three/lib/CanvasRenderer.js","hash":"cf8e1ce6e884023ad0d692cf30f399862407fb40","modified":1612603875012},{"_id":"public/lib/three/lib/Projector.js","hash":"1ad16e96cea2a8a9155bb429c83ef9bdd341ce99","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/ams.js","hash":"943dfb788d9d08d3c3464a01011b5120c969c029","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/bussproofs.js","hash":"ce27b7ac5232f67ad6e945fe5c699228fae729fe","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/physics.js","hash":"91e3017e1968d91a049a23e3cdfa0d4b20765946","modified":1612603875012},{"_id":"public/live2dw/assets/moc/hijiki.2048/texture_00.png","hash":"66464e0d96439695b5542c5e2f5be60739c29999","modified":1612603875012},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1612603875012},{"_id":"public/js/mathjax/input/mml/entities.js","hash":"836b54f30619d2523b6ebc4ab33a2204e2549545","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/mhchem.js","hash":"940808a4039c7aa89dc20ffbb8eac05f3b5fa4a1","modified":1612603875012},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1612603875012},{"_id":"public/js/fancybox.mini.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1612603875012},{"_id":"public/js/valine.min.js","hash":"deaa627029a24fc0fef9f6cad3a46118dcd58256","modified":1612603875012},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1612603875012},{"_id":"public/js/fancybox.js","hash":"c8e1c8b386dc5b7a9184c763c88d19a346eb3342","modified":1612603875012},{"_id":"public/js/mathjax/ui/menu.js","hash":"b0ec99c79e515bccfb029e3cf8c966357e2428ab","modified":1612603875012},{"_id":"public/js/mathjax/input/asciimath.js","hash":"12a8993f8c7d893d637cb3143d57aa160d4bbb71","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml/fonts/tex.js","hash":"64bb0fc88cbdec760b57c0e3f289ca3552da8402","modified":1612603875012},{"_id":"public/js/mathjax/input/tex-base.js","hash":"94b077d61ee163431253f23d8bf48dd449f24a6a","modified":1612603875012},{"_id":"public/js/mathjax/input/tex/extensions/all-packages.js","hash":"c5b1057a328b44bf7299939766067522bfa1e16d","modified":1612603875012},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"27f034e5db8c32e268e2959b9a7c1258d36e4510","modified":1612603875012},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js.map","hash":"35e71cc2a130199efb167b9a06939576602f0d75","modified":1612603875012},{"_id":"public/js/mathjax/input/tex.js","hash":"fc1852b3c03a9adc1758b1db78610a5198416ee3","modified":1612603875012},{"_id":"public/js/mathjax/output/svg.js","hash":"5f6efb05f98d07fb09eeb2f2e32b937c8aedea45","modified":1612603875012},{"_id":"public/js/av-min.js","hash":"706b41ebb6381a89b52578a25c71a73d28155c6c","modified":1612603875012},{"_id":"public/js/mathjax/core.js","hash":"5287dddb297681ebfb51eac27a6a18ff14b019ae","modified":1612603875012},{"_id":"public/js/mathjax/output/chtml.js","hash":"a927bd486356127818659fc2772de6bf44b1c851","modified":1612603875012},{"_id":"public/js/mathjax/node-main.js","hash":"328aef447c6404a034e7c9f31d8f673703ab25fa","modified":1612603875012},{"_id":"public/js/mathjax/sre/mathmaps/nemeth.js","hash":"6591cac31a30b5366bc07b97ce1abd96eafb4009","modified":1612603796569},{"_id":"public/js/mathjax/input/tex-full.js","hash":"82aef103c40aa175c535b1485f6c4f7c9af31e29","modified":1612603875012},{"_id":"public/js/mathjax/sre/mathmaps/fr.js","hash":"f5037a98b33b24c9fe23e4bd50450a69360a2e8d","modified":1612603796569},{"_id":"public/js/mathjax/sre/mathmaps/es.js","hash":"88938b14c6187b49469d8945ff8879d7cca13e4d","modified":1612603796569},{"_id":"public/js/mathjax/sre/mathmaps/de.js","hash":"f2c125baba05ec138602f3bbc1c12365dde82237","modified":1612603796569},{"_id":"public/js/mathjax/sre/mathmaps/en.js","hash":"5400c569ff7a152ebc7f3661f69d29f2db1745c2","modified":1612603796569},{"_id":"public/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1612603875012},{"_id":"public/js/mathjax/mml-chtml.js","hash":"89bde7029d87e5bf73a810ad9df6986f5fdaed65","modified":1612603875012},{"_id":"public/js/mathjax/math-tex-mml-chtml.js","hash":"ddf9e9789b79e2492ef51a22b6be30c8c8cd07a3","modified":1612603875012},{"_id":"public/js/mathjax/tex-mml-chtml.js","hash":"ddf9e9789b79e2492ef51a22b6be30c8c8cd07a3","modified":1612603875012},{"_id":"public/js/mathjax/tex-chtml.js","hash":"14142392a7d04afa3167ea97fe5fca9ac46299e4","modified":1612603875012},{"_id":"public/js/mathjax/tex-chtml-full.js","hash":"b6e6382fd1d385c65a8a90250ada566e643fd7af","modified":1612603875012},{"_id":"public/js/mathjax/sre/sre_browser.js","hash":"91a52d8eb7ed3c58bd73fecbc8508eaa5c5e273d","modified":1612603875012},{"_id":"public/js/mathjax/output/svg/fonts/tex.js","hash":"41e7ee126ea2c11b2ee17080043c6b065d889c33","modified":1612603875012},{"_id":"public/js/mathjax/sre/mathmaps/mathmaps_ie.js","hash":"7592ab1ae061b0ff612509da64229d96be2aff87","modified":1612603796569},{"_id":"public/js/mathjax/mml-svg.js","hash":"d7b174cc08791a4dabd1181af25bc559ab54a446","modified":1612603875012},{"_id":"public/js/mathjax/tex-svg.js","hash":"a4dcabf818d039da6df20e2dbb647385fe234a9a","modified":1612603875012},{"_id":"public/js/mathjax/tex-mml-svg.js","hash":"53330ec997c7398504bea30173aec8c24751cec1","modified":1612603875012},{"_id":"public/js/mathjax/tex-svg-full.js","hash":"1b192a7b819bbaf6d25e9dfda327c1bbb21bd518","modified":1612603875012}],"Category":[],"Data":[],"Page":[{"title":"categories","date":"2020-09-01T06:02:45.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2020-09-01 14:02:45\ntype: \"categories\"\n---\n","updated":"2021-01-26T14:05:05.693Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ckktibdkk00003ci7br679y2f","content":"","site":{"data":{}},"excerpt":"","more":"","length":0},{"title":"tags","date":"2020-09-01T06:01:56.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2020-09-01 14:01:56\ntype: \"tags\"\n---\n","updated":"2021-01-26T14:05:05.693Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckktibdkp00023ci7ck5cg1f6","content":"","site":{"data":{}},"excerpt":"","more":"","length":0}],"Post":[{"title":"「25」GPM newm函数要点","date":"2020-11-29T16:00:17.000Z","updated":"2020-11-29T16:00:17.000Z","keywords":"GPM,Go,Go调度器,Go资源调度器","_content":"\n\n之前大概学了GPM在main函数调度过程中关于newm的相关知识。\n\n觉得还是了解甚少，，，，，\n\n这次主要是想了解其中一些关键点的变换过程.\n\n<!--more-->\n\n```go\n//go:nowritebarrierrec\nfunc newm(fn func(), _p_ *p) {\n\tmp := allocm(_p_, fn)\n\tmp.nextp.set(_p_)\n\tmp.sigmask = initSigmask\n\tif gp := getg(); gp != nil && gp.m != nil && (gp.m.lockedExt != 0 || gp.m.incgo) && GOOS != \"plan9\" {\n        ...\n        ....\n\t\tmp.schedlink = newmHandoff.newm\n\t\tnewmHandoff.newm.set(mp)\n\t\tif newmHandoff.waiting {\n\t\t\tnewmHandoff.waiting = false\n\t\t\tnotewakeup(&newmHandoff.wake)\n\t\t}\n\t\tunlock(&newmHandoff.lock)\n\t\treturn\n\t}\n\tnewm1(mp)\n}\n```","source":"_drafts/25-GPM-newm函数要点.md","raw":"---\ntitle: 「25」GPM newm函数要点\ndate: '2020/11/30 00:00:17'\nupdated: '2020/11/30 00:00:17'\nkeywords: 'GPM,Go,Go调度器,Go资源调度器'\ntags:\n  - Go\n  - GPM\n  - Go源码\n---\n\n\n之前大概学了GPM在main函数调度过程中关于newm的相关知识。\n\n觉得还是了解甚少，，，，，\n\n这次主要是想了解其中一些关键点的变换过程.\n\n<!--more-->\n\n```go\n//go:nowritebarrierrec\nfunc newm(fn func(), _p_ *p) {\n\tmp := allocm(_p_, fn)\n\tmp.nextp.set(_p_)\n\tmp.sigmask = initSigmask\n\tif gp := getg(); gp != nil && gp.m != nil && (gp.m.lockedExt != 0 || gp.m.incgo) && GOOS != \"plan9\" {\n        ...\n        ....\n\t\tmp.schedlink = newmHandoff.newm\n\t\tnewmHandoff.newm.set(mp)\n\t\tif newmHandoff.waiting {\n\t\t\tnewmHandoff.waiting = false\n\t\t\tnotewakeup(&newmHandoff.wake)\n\t\t}\n\t\tunlock(&newmHandoff.lock)\n\t\treturn\n\t}\n\tnewm1(mp)\n}\n```","slug":"25-GPM-newm函数要点","published":0,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkn00013ci74oqodzky","content":"<p>之前大概学了GPM在main函数调度过程中关于newm的相关知识。</p>\n<p>觉得还是了解甚少，，，，，</p>\n<p>这次主要是想了解其中一些关键点的变换过程.</p>\n<a id=\"more\"></a>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>, _<span class=\"title\">p_</span> *<span class=\"title\">p</span>)</span> &#123;</span><br><span class=\"line\">\tmp := allocm(_p_, fn)</span><br><span class=\"line\">\tmp.nextp.set(_p_)</span><br><span class=\"line\">\tmp.sigmask = initSigmask</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> gp := getg(); gp != <span class=\"literal\">nil</span> &amp;&amp; gp.m != <span class=\"literal\">nil</span> &amp;&amp; (gp.m.lockedExt != <span class=\"number\">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class=\"string\">&quot;plan9&quot;</span> &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        ....</span><br><span class=\"line\">\t\tmp.schedlink = newmHandoff.newm</span><br><span class=\"line\">\t\tnewmHandoff.newm.set(mp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.waiting &#123;</span><br><span class=\"line\">\t\t\tnewmHandoff.waiting = <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t\tnotewakeup(&amp;newmHandoff.wake)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnewm1(mp)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<p>之前大概学了GPM在main函数调度过程中关于newm的相关知识。</p>\n<p>觉得还是了解甚少，，，，，</p>\n<p>这次主要是想了解其中一些关键点的变换过程.</p>","more":"<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>, _<span class=\"title\">p_</span> *<span class=\"title\">p</span>)</span> &#123;</span><br><span class=\"line\">\tmp := allocm(_p_, fn)</span><br><span class=\"line\">\tmp.nextp.set(_p_)</span><br><span class=\"line\">\tmp.sigmask = initSigmask</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> gp := getg(); gp != <span class=\"literal\">nil</span> &amp;&amp; gp.m != <span class=\"literal\">nil</span> &amp;&amp; (gp.m.lockedExt != <span class=\"number\">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class=\"string\">&quot;plan9&quot;</span> &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        ....</span><br><span class=\"line\">\t\tmp.schedlink = newmHandoff.newm</span><br><span class=\"line\">\t\tnewmHandoff.newm.set(mp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.waiting &#123;</span><br><span class=\"line\">\t\t\tnewmHandoff.waiting = <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t\tnotewakeup(&amp;newmHandoff.wake)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnewm1(mp)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","length":531},{"title":"「25」RabbitMQ五种工作模式","date":"2020-12-13T16:00:17.000Z","updated":"2020-11-29T16:00:17.000Z","keywords":"RabbitMQ,消息中间件","_content":"\n\n最近本来只想简单学习一下子RabbitMQ，后在男票强迫下写了这篇总结文档，哈哈哈哈...\n以上就是我写这篇文档的初衷，仅供和我一样的小白参考。\n\n\n第一种\n  简单队列（一对一模式）\n  --简单地说，就是一个生产者对应一个消费者。\n\n\n生产者：\npublic class Product {\n\n    /**\n     * 一对一关系，一个生产者对应一个消费者\n     * @throws Exception\n     */\n    public void send() throws Exception{\n        //1.创建连接\n        ConnectionFactory factory = new ConnectionFactory();\n        //2.设置参数\n        factory.setHost(\"localhost\");//设置地址\n        factory.setPort(22);//设置端口号\n        factory.setUsername(\"user\");//设置用户名\n        factory.setPassword(\"123456\");//设置密码\n        factory.setVirtualHost(\"/\"); //设置虚拟机\n\n        //3. 在连接工厂中创建新的连接\n        Connection connection = factory.newConnection();\n\n        //4.新增信道用于通信\n        Channel channel  = connection.createChannel();\n\n        //5.绑定队列\n        /**\n         * 参数1：队列名称-若不存在则会创建\n         * 参数2：是否给队列持久化-false则重启时消息会丢失不会持久化\n         * 参数3：是否独享信道-true则只有当前连接可连接\n         * 参数4：是否用完自动删除-false不删除\n         * 参数5：其他参数\n         */\n        channel.queueDeclare(\"hello\", true, false, false, null);\n\n        //6.发送消息\n        /**\n         * 参数1：交换机\n         * 参数2：队列名\n         * 参数3：相关属性（消息持久化）-保持消息体进行持久化，null则不对消息持久化\n         * 参数4：消息体\n         */\n        channel.basicPublish(\"\", \"hello\", MessageProperties.PERSISTENT_TEXT_PLAIN, \"This is a queue message\".getBytes());\n\n        //7.关闭通道和连接\n        channel.close();\n        connection.close();\n        System.out.println(\"消息已被发送\");\n\n    }\n}\n\n\n消费者：\npublic class Consumer {\n\n    public void send() throws Exception{\n        //1.创建连接\n        ConnectionFactory factory = new ConnectionFactory();\n        //2.设置参数\n        factory.setHost(\"localhost\");//设置地址\n        factory.setPort(22);//设置端口号\n        factory.setUsername(\"user\");//设置用户名\n        factory.setPassword(\"123456\");//设置密码\n        factory.setVirtualHost(\"/\"); //设置虚拟机\n\n        //3. 在连接工厂中创建新的连接\n        Connection connection = factory.newConnection();\n\n        //4.新增信道用于通信\n        Channel channel  = connection.createChannel();\n\n        //5.绑定队列\n        /**\n         * 参数1：队列名称-若不存在则会创建\n         * 参数2：是否持久化-false则重启时消息会丢失不会持久化\n         * 参数3：是否独享信道-true则只有当前连接可连接\n         * 参数4：是否用完自动删除\n         * 参数5：其他参数\n         */\n        channel.queueDeclare(\"hello\", true, false, false, null);\n\n        //6.接受消息\n        channel.basicConsume(\"hello\", true, new DefaultConsumer(channel){\n            @Override\n            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException {\n                System.out.println(\"消息内容是\"+body.toString());\n\n            }\n        });\n\n        //不能回调输出消息,为了不让程序结束\n        System.in.read();\n\n    }\n}\n\n","source":"_drafts/26-RabbitMQ五种工作模式.md","raw":"---\ntitle: 「25」RabbitMQ五种工作模式\ndate: '2020/12/14 00:00:17'\nupdated: '2020/11/30 00:00:17'\nkeywords: 'RabbitMQ,消息中间件'\ntags:\n  - RabbitMQ\n  - 消息中间件\n---\n\n\n最近本来只想简单学习一下子RabbitMQ，后在男票强迫下写了这篇总结文档，哈哈哈哈...\n以上就是我写这篇文档的初衷，仅供和我一样的小白参考。\n\n\n第一种\n  简单队列（一对一模式）\n  --简单地说，就是一个生产者对应一个消费者。\n\n\n生产者：\npublic class Product {\n\n    /**\n     * 一对一关系，一个生产者对应一个消费者\n     * @throws Exception\n     */\n    public void send() throws Exception{\n        //1.创建连接\n        ConnectionFactory factory = new ConnectionFactory();\n        //2.设置参数\n        factory.setHost(\"localhost\");//设置地址\n        factory.setPort(22);//设置端口号\n        factory.setUsername(\"user\");//设置用户名\n        factory.setPassword(\"123456\");//设置密码\n        factory.setVirtualHost(\"/\"); //设置虚拟机\n\n        //3. 在连接工厂中创建新的连接\n        Connection connection = factory.newConnection();\n\n        //4.新增信道用于通信\n        Channel channel  = connection.createChannel();\n\n        //5.绑定队列\n        /**\n         * 参数1：队列名称-若不存在则会创建\n         * 参数2：是否给队列持久化-false则重启时消息会丢失不会持久化\n         * 参数3：是否独享信道-true则只有当前连接可连接\n         * 参数4：是否用完自动删除-false不删除\n         * 参数5：其他参数\n         */\n        channel.queueDeclare(\"hello\", true, false, false, null);\n\n        //6.发送消息\n        /**\n         * 参数1：交换机\n         * 参数2：队列名\n         * 参数3：相关属性（消息持久化）-保持消息体进行持久化，null则不对消息持久化\n         * 参数4：消息体\n         */\n        channel.basicPublish(\"\", \"hello\", MessageProperties.PERSISTENT_TEXT_PLAIN, \"This is a queue message\".getBytes());\n\n        //7.关闭通道和连接\n        channel.close();\n        connection.close();\n        System.out.println(\"消息已被发送\");\n\n    }\n}\n\n\n消费者：\npublic class Consumer {\n\n    public void send() throws Exception{\n        //1.创建连接\n        ConnectionFactory factory = new ConnectionFactory();\n        //2.设置参数\n        factory.setHost(\"localhost\");//设置地址\n        factory.setPort(22);//设置端口号\n        factory.setUsername(\"user\");//设置用户名\n        factory.setPassword(\"123456\");//设置密码\n        factory.setVirtualHost(\"/\"); //设置虚拟机\n\n        //3. 在连接工厂中创建新的连接\n        Connection connection = factory.newConnection();\n\n        //4.新增信道用于通信\n        Channel channel  = connection.createChannel();\n\n        //5.绑定队列\n        /**\n         * 参数1：队列名称-若不存在则会创建\n         * 参数2：是否持久化-false则重启时消息会丢失不会持久化\n         * 参数3：是否独享信道-true则只有当前连接可连接\n         * 参数4：是否用完自动删除\n         * 参数5：其他参数\n         */\n        channel.queueDeclare(\"hello\", true, false, false, null);\n\n        //6.接受消息\n        channel.basicConsume(\"hello\", true, new DefaultConsumer(channel){\n            @Override\n            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException {\n                System.out.println(\"消息内容是\"+body.toString());\n\n            }\n        });\n\n        //不能回调输出消息,为了不让程序结束\n        System.in.read();\n\n    }\n}\n\n","slug":"26-RabbitMQ五种工作模式","published":0,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkq00033ci79ut67pu1","content":"<p>最近本来只想简单学习一下子RabbitMQ，后在男票强迫下写了这篇总结文档，哈哈哈哈…<br>\n以上就是我写这篇文档的初衷，仅供和我一样的小白参考。</p>\n<p>第一种<br>\n简单队列（一对一模式）<br>\n–简单地说，就是一个生产者对应一个消费者。</p>\n<p>生产者：<br>\npublic class Product {</p>\n<pre><code>/**\n * 一对一关系，一个生产者对应一个消费者\n * @throws Exception\n */\npublic void send() throws Exception&#123;\n    //1.创建连接\n    ConnectionFactory factory = new ConnectionFactory();\n    //2.设置参数\n    factory.setHost(&quot;localhost&quot;);//设置地址\n    factory.setPort(22);//设置端口号\n    factory.setUsername(&quot;user&quot;);//设置用户名\n    factory.setPassword(&quot;123456&quot;);//设置密码\n    factory.setVirtualHost(&quot;/&quot;); //设置虚拟机\n\n    //3. 在连接工厂中创建新的连接\n    Connection connection = factory.newConnection();\n\n    //4.新增信道用于通信\n    Channel channel  = connection.createChannel();\n\n    //5.绑定队列\n    /**\n     * 参数1：队列名称-若不存在则会创建\n     * 参数2：是否给队列持久化-false则重启时消息会丢失不会持久化\n     * 参数3：是否独享信道-true则只有当前连接可连接\n     * 参数4：是否用完自动删除-false不删除\n     * 参数5：其他参数\n     */\n    channel.queueDeclare(&quot;hello&quot;, true, false, false, null);\n\n    //6.发送消息\n    /**\n     * 参数1：交换机\n     * 参数2：队列名\n     * 参数3：相关属性（消息持久化）-保持消息体进行持久化，null则不对消息持久化\n     * 参数4：消息体\n     */\n    channel.basicPublish(&quot;&quot;, &quot;hello&quot;, MessageProperties.PERSISTENT_TEXT_PLAIN, &quot;This is a queue message&quot;.getBytes());\n\n    //7.关闭通道和连接\n    channel.close();\n    connection.close();\n    System.out.println(&quot;消息已被发送&quot;);\n\n&#125;\n</code></pre>\n<p>}</p>\n<p>消费者：<br>\npublic class Consumer {</p>\n<pre><code>public void send() throws Exception&#123;\n    //1.创建连接\n    ConnectionFactory factory = new ConnectionFactory();\n    //2.设置参数\n    factory.setHost(&quot;localhost&quot;);//设置地址\n    factory.setPort(22);//设置端口号\n    factory.setUsername(&quot;user&quot;);//设置用户名\n    factory.setPassword(&quot;123456&quot;);//设置密码\n    factory.setVirtualHost(&quot;/&quot;); //设置虚拟机\n\n    //3. 在连接工厂中创建新的连接\n    Connection connection = factory.newConnection();\n\n    //4.新增信道用于通信\n    Channel channel  = connection.createChannel();\n\n    //5.绑定队列\n    /**\n     * 参数1：队列名称-若不存在则会创建\n     * 参数2：是否持久化-false则重启时消息会丢失不会持久化\n     * 参数3：是否独享信道-true则只有当前连接可连接\n     * 参数4：是否用完自动删除\n     * 参数5：其他参数\n     */\n    channel.queueDeclare(&quot;hello&quot;, true, false, false, null);\n\n    //6.接受消息\n    channel.basicConsume(&quot;hello&quot;, true, new DefaultConsumer(channel)&#123;\n        @Override\n        public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;\n            System.out.println(&quot;消息内容是&quot;+body.toString());\n\n        &#125;\n    &#125;);\n\n    //不能回调输出消息,为了不让程序结束\n    System.in.read();\n\n&#125;\n</code></pre>\n<p>}</p>\n","site":{"data":{}},"excerpt":"","more":"<p>最近本来只想简单学习一下子RabbitMQ，后在男票强迫下写了这篇总结文档，哈哈哈哈…<br>\n以上就是我写这篇文档的初衷，仅供和我一样的小白参考。</p>\n<p>第一种<br>\n简单队列（一对一模式）<br>\n–简单地说，就是一个生产者对应一个消费者。</p>\n<p>生产者：<br>\npublic class Product {</p>\n<pre><code>/**\n * 一对一关系，一个生产者对应一个消费者\n * @throws Exception\n */\npublic void send() throws Exception&#123;\n    //1.创建连接\n    ConnectionFactory factory = new ConnectionFactory();\n    //2.设置参数\n    factory.setHost(&quot;localhost&quot;);//设置地址\n    factory.setPort(22);//设置端口号\n    factory.setUsername(&quot;user&quot;);//设置用户名\n    factory.setPassword(&quot;123456&quot;);//设置密码\n    factory.setVirtualHost(&quot;/&quot;); //设置虚拟机\n\n    //3. 在连接工厂中创建新的连接\n    Connection connection = factory.newConnection();\n\n    //4.新增信道用于通信\n    Channel channel  = connection.createChannel();\n\n    //5.绑定队列\n    /**\n     * 参数1：队列名称-若不存在则会创建\n     * 参数2：是否给队列持久化-false则重启时消息会丢失不会持久化\n     * 参数3：是否独享信道-true则只有当前连接可连接\n     * 参数4：是否用完自动删除-false不删除\n     * 参数5：其他参数\n     */\n    channel.queueDeclare(&quot;hello&quot;, true, false, false, null);\n\n    //6.发送消息\n    /**\n     * 参数1：交换机\n     * 参数2：队列名\n     * 参数3：相关属性（消息持久化）-保持消息体进行持久化，null则不对消息持久化\n     * 参数4：消息体\n     */\n    channel.basicPublish(&quot;&quot;, &quot;hello&quot;, MessageProperties.PERSISTENT_TEXT_PLAIN, &quot;This is a queue message&quot;.getBytes());\n\n    //7.关闭通道和连接\n    channel.close();\n    connection.close();\n    System.out.println(&quot;消息已被发送&quot;);\n\n&#125;\n</code></pre>\n<p>}</p>\n<p>消费者：<br>\npublic class Consumer {</p>\n<pre><code>public void send() throws Exception&#123;\n    //1.创建连接\n    ConnectionFactory factory = new ConnectionFactory();\n    //2.设置参数\n    factory.setHost(&quot;localhost&quot;);//设置地址\n    factory.setPort(22);//设置端口号\n    factory.setUsername(&quot;user&quot;);//设置用户名\n    factory.setPassword(&quot;123456&quot;);//设置密码\n    factory.setVirtualHost(&quot;/&quot;); //设置虚拟机\n\n    //3. 在连接工厂中创建新的连接\n    Connection connection = factory.newConnection();\n\n    //4.新增信道用于通信\n    Channel channel  = connection.createChannel();\n\n    //5.绑定队列\n    /**\n     * 参数1：队列名称-若不存在则会创建\n     * 参数2：是否持久化-false则重启时消息会丢失不会持久化\n     * 参数3：是否独享信道-true则只有当前连接可连接\n     * 参数4：是否用完自动删除\n     * 参数5：其他参数\n     */\n    channel.queueDeclare(&quot;hello&quot;, true, false, false, null);\n\n    //6.接受消息\n    channel.basicConsume(&quot;hello&quot;, true, new DefaultConsumer(channel)&#123;\n        @Override\n        public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;\n            System.out.println(&quot;消息内容是&quot;+body.toString());\n\n        &#125;\n    &#125;);\n\n    //不能回调输出消息,为了不让程序结束\n    System.in.read();\n\n&#125;\n</code></pre>\n<p>}</p>\n","length":2029},{"title":"正态规划","date":"2020-12-27T02:10:01.000Z","_content":"\n### 定义：\n\n> 一种把原问题分解为子问题的方式求解复杂问题的方法。\n\n### 适用范围：\n* 有重叠子问题\n* 最优子结构性质\n\n### 处理思路：\n#### 1、 定义数组元素含义\n\n#### 2、 找出数组元素间的关系「状态转移方程」\n\n#### 3、 找出最关键的初始值\n\n\n### 案例实践\n\n### 参考：\n\n* [动态规划「维基百科」](https://zh.wikipedia.org/zh-hans/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92)\n\n","source":"_drafts/N-正态规划.md","raw":"---\ntitle: '正态规划'\ndate: 2020-12-27 10:10:01\ntags:\n    - N个问题\n    - 正态规划\n---\n\n### 定义：\n\n> 一种把原问题分解为子问题的方式求解复杂问题的方法。\n\n### 适用范围：\n* 有重叠子问题\n* 最优子结构性质\n\n### 处理思路：\n#### 1、 定义数组元素含义\n\n#### 2、 找出数组元素间的关系「状态转移方程」\n\n#### 3、 找出最关键的初始值\n\n\n### 案例实践\n\n### 参考：\n\n* [动态规划「维基百科」](https://zh.wikipedia.org/zh-hans/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92)\n\n","slug":"N-正态规划","published":0,"updated":"2021-01-26T14:05:05.688Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdks00053ci791b855c1","content":"<h3 id=\"定义：\"><a class=\"header-anchor\" href=\"#定义：\">¶</a>定义：</h3>\n<blockquote>\n<p>一种把原问题分解为子问题的方式求解复杂问题的方法。</p>\n</blockquote>\n<h3 id=\"适用范围：\"><a class=\"header-anchor\" href=\"#适用范围：\">¶</a>适用范围：</h3>\n<ul>\n<li>有重叠子问题</li>\n<li>最优子结构性质</li>\n</ul>\n<h3 id=\"处理思路：\"><a class=\"header-anchor\" href=\"#处理思路：\">¶</a>处理思路：</h3>\n<h4 id=\"1、-定义数组元素含义\"><a class=\"header-anchor\" href=\"#1、-定义数组元素含义\">¶</a>1、 定义数组元素含义</h4>\n<h4 id=\"2、-找出数组元素间的关系「状态转移方程」\"><a class=\"header-anchor\" href=\"#2、-找出数组元素间的关系「状态转移方程」\">¶</a>2、 找出数组元素间的关系「状态转移方程」</h4>\n<h4 id=\"3、-找出最关键的初始值\"><a class=\"header-anchor\" href=\"#3、-找出最关键的初始值\">¶</a>3、 找出最关键的初始值</h4>\n<h3 id=\"案例实践\"><a class=\"header-anchor\" href=\"#案例实践\">¶</a>案例实践</h3>\n<h3 id=\"参考：\"><a class=\"header-anchor\" href=\"#参考：\">¶</a>参考：</h3>\n<ul>\n<li><a href=\"https://zh.wikipedia.org/zh-hans/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92\">动态规划「维基百科」</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"定义：\"><a class=\"header-anchor\" href=\"#定义：\">¶</a>定义：</h3>\n<blockquote>\n<p>一种把原问题分解为子问题的方式求解复杂问题的方法。</p>\n</blockquote>\n<h3 id=\"适用范围：\"><a class=\"header-anchor\" href=\"#适用范围：\">¶</a>适用范围：</h3>\n<ul>\n<li>有重叠子问题</li>\n<li>最优子结构性质</li>\n</ul>\n<h3 id=\"处理思路：\"><a class=\"header-anchor\" href=\"#处理思路：\">¶</a>处理思路：</h3>\n<h4 id=\"1、-定义数组元素含义\"><a class=\"header-anchor\" href=\"#1、-定义数组元素含义\">¶</a>1、 定义数组元素含义</h4>\n<h4 id=\"2、-找出数组元素间的关系「状态转移方程」\"><a class=\"header-anchor\" href=\"#2、-找出数组元素间的关系「状态转移方程」\">¶</a>2、 找出数组元素间的关系「状态转移方程」</h4>\n<h4 id=\"3、-找出最关键的初始值\"><a class=\"header-anchor\" href=\"#3、-找出最关键的初始值\">¶</a>3、 找出最关键的初始值</h4>\n<h3 id=\"案例实践\"><a class=\"header-anchor\" href=\"#案例实践\">¶</a>案例实践</h3>\n<h3 id=\"参考：\"><a class=\"header-anchor\" href=\"#参考：\">¶</a>参考：</h3>\n<ul>\n<li><a href=\"https://zh.wikipedia.org/zh-hans/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92\">动态规划「维基百科」</a></li>\n</ul>\n","length":117},{"title":"TLS/SSL/HTTPS详解","date":"2020-12-20T17:10:01.000Z","_content":"\n\n\n\n","source":"_drafts/TLS-SSL-HTTPS详解.md","raw":"---\ntitle: 'TLS/SSL/HTTPS详解'\ndate: 2020-12-21 01:10:01\ntags:\n    - TLS\n    - HTTPS\n---\n\n\n\n\n","slug":"TLS-SSL-HTTPS详解","published":0,"updated":"2021-01-26T14:05:05.688Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkt00063ci7b946d15u","content":"","site":{"data":{}},"excerpt":"","more":"","length":0},{"_content":"\n\n## Recently\n* [动态规划](https://zhuanlan.zhihu.com/p/78220312s)\n\n* [Redis源码解析列表](https://blog.csdn.net/men_wen/category_6769467.html)\n\n ","source":"_drafts/bookmarks.md","raw":"\n\n## Recently\n* [动态规划](https://zhuanlan.zhihu.com/p/78220312s)\n\n* [Redis源码解析列表](https://blog.csdn.net/men_wen/category_6769467.html)\n\n ","slug":"bookmarks","published":0,"date":"2021-01-26T14:05:05.688Z","updated":"2021-01-26T14:05:05.688Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkt00073ci74uq3evrv","content":"<h2 id=\"Recently\"><a class=\"header-anchor\" href=\"#Recently\">¶</a>Recently</h2>\n<ul>\n<li>\n<p><a href=\"https://zhuanlan.zhihu.com/p/78220312s\">动态规划</a></p>\n</li>\n<li>\n<p><a href=\"https://blog.csdn.net/men_wen/category_6769467.html\">Redis源码解析列表</a></p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Recently\"><a class=\"header-anchor\" href=\"#Recently\">¶</a>Recently</h2>\n<ul>\n<li>\n<p><a href=\"https://zhuanlan.zhihu.com/p/78220312s\">动态规划</a></p>\n</li>\n<li>\n<p><a href=\"https://blog.csdn.net/men_wen/category_6769467.html\">Redis源码解析列表</a></p>\n</li>\n</ul>\n","length":24},{"title":"git 初阶:add/commit/push ~2","date":"2020-09-02T17:10:01.000Z","_content":"\n>上节提要：[Git初阶：安装配置～1](http://blog.imrcrab.com/2020/09/02/git%20%E5%88%9D%E9%98%B6:%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%20%EF%BD%9E1/#more)属于Git搭建的基础。\n\n\n>本章节主要以代码的add、commit、push为主，及使用过程中遇到的场景和解决策略。\n\n### 掌握目标\n\n<!-- more -->\n\n### add/commit/push使用\n\n```\ngit add XXX\ngit commit -m \"commit说明\"\ngit push origin master \n```\n\n### 常见的场景及策略\n\n\n\n\n\n","source":"_drafts/git 初阶add-commit-push ~2.md","raw":"---\ntitle: 'git 初阶:add/commit/push ~2'\ndate: 2020-09-03 01:10:01\ntags:\n    - Git\n---\n\n>上节提要：[Git初阶：安装配置～1](http://blog.imrcrab.com/2020/09/02/git%20%E5%88%9D%E9%98%B6:%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%20%EF%BD%9E1/#more)属于Git搭建的基础。\n\n\n>本章节主要以代码的add、commit、push为主，及使用过程中遇到的场景和解决策略。\n\n### 掌握目标\n\n<!-- more -->\n\n### add/commit/push使用\n\n```\ngit add XXX\ngit commit -m \"commit说明\"\ngit push origin master \n```\n\n### 常见的场景及策略\n\n\n\n\n\n","slug":"git 初阶add-commit-push ~2","published":0,"updated":"2021-01-26T14:05:05.688Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdku00093ci75ww5hnol","content":"<blockquote>\n<p>上节提要：<a href=\"http://blog.imrcrab.com/2020/09/02/git%20%E5%88%9D%E9%98%B6:%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%20%EF%BD%9E1/#more\">Git初阶：安装配置～1</a>属于Git搭建的基础。</p>\n</blockquote>\n<blockquote>\n<p>本章节主要以代码的add、commit、push为主，及使用过程中遇到的场景和解决策略。</p>\n</blockquote>\n<h3 id=\"掌握目标\"><a class=\"header-anchor\" href=\"#掌握目标\">¶</a>掌握目标</h3>\n<a id=\"more\"></a>\n<h3 id=\"add-commit-push使用\"><a class=\"header-anchor\" href=\"#add-commit-push使用\">¶</a>add/commit/push使用</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add XXX</span><br><span class=\"line\">git commit -m &quot;commit说明&quot;</span><br><span class=\"line\">git push origin master </span><br></pre></td></tr></table></figure>\n<h3 id=\"常见的场景及策略\"><a class=\"header-anchor\" href=\"#常见的场景及策略\">¶</a>常见的场景及策略</h3>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>上节提要：<a href=\"http://blog.imrcrab.com/2020/09/02/git%20%E5%88%9D%E9%98%B6:%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%20%EF%BD%9E1/#more\">Git初阶：安装配置～1</a>属于Git搭建的基础。</p>\n</blockquote>\n<blockquote>\n<p>本章节主要以代码的add、commit、push为主，及使用过程中遇到的场景和解决策略。</p>\n</blockquote>\n<h3 id=\"掌握目标\"><a class=\"header-anchor\" href=\"#掌握目标\">¶</a>掌握目标</h3>","more":"<h3 id=\"add-commit-push使用\"><a class=\"header-anchor\" href=\"#add-commit-push使用\">¶</a>add/commit/push使用</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add XXX</span><br><span class=\"line\">git commit -m &quot;commit说明&quot;</span><br><span class=\"line\">git push origin master </span><br></pre></td></tr></table></figure>\n<h3 id=\"常见的场景及策略\"><a class=\"header-anchor\" href=\"#常见的场景及策略\">¶</a>常见的场景及策略</h3>","length":166},{"title":"Todo","date":"2020-12-27T02:10:01.000Z","_content":"\n\n<!--more-->\n\n## Redis\n\n### 使用篇\n\n\n### 源码篇\n#### 五大数据结构\n\n##### string\n###### sds\n\n##### list\n\n##### set\n\n##### z_set\n\n##### hash\n\n\n#### 网络连接处理\n\n#### 集群处理「哨兵模式」\n\n#### 事件处理\n\n#### AOF & RDB\n\n#### 命令实现\n\n#### 复制\n\n#### 悲观锁和乐观锁\n\n\n#### 消息通知「发布/订阅」\n\n#### 基数统计「hyperLogLog」\n\n#### 集群伸缩\n\n\n### 踩坑篇\n\n## N个问题\n\n#### 正态规划：\n\n#### 窗口滑动:\n","source":"_drafts/plan todo.md","raw":"---\ntitle: 'Todo'\ndate: 2020-12-27 10:10:01\ntags:\n    - Todo\n---\n\n\n<!--more-->\n\n## Redis\n\n### 使用篇\n\n\n### 源码篇\n#### 五大数据结构\n\n##### string\n###### sds\n\n##### list\n\n##### set\n\n##### z_set\n\n##### hash\n\n\n#### 网络连接处理\n\n#### 集群处理「哨兵模式」\n\n#### 事件处理\n\n#### AOF & RDB\n\n#### 命令实现\n\n#### 复制\n\n#### 悲观锁和乐观锁\n\n\n#### 消息通知「发布/订阅」\n\n#### 基数统计「hyperLogLog」\n\n#### 集群伸缩\n\n\n### 踩坑篇\n\n## N个问题\n\n#### 正态规划：\n\n#### 窗口滑动:\n","slug":"plan todo","published":0,"updated":"2021-01-26T14:05:05.688Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkv000a3ci7fflbd40n","content":"<a id=\"more\"></a>\n<h2 id=\"Redis\"><a class=\"header-anchor\" href=\"#Redis\">¶</a>Redis</h2>\n<h3 id=\"使用篇\"><a class=\"header-anchor\" href=\"#使用篇\">¶</a>使用篇</h3>\n<h3 id=\"源码篇\"><a class=\"header-anchor\" href=\"#源码篇\">¶</a>源码篇</h3>\n<h4 id=\"五大数据结构\"><a class=\"header-anchor\" href=\"#五大数据结构\">¶</a>五大数据结构</h4>\n<h5 id=\"string\"><a class=\"header-anchor\" href=\"#string\">¶</a>string</h5>\n<h6 id=\"sds\"><a class=\"header-anchor\" href=\"#sds\">¶</a>sds</h6>\n<h5 id=\"list\"><a class=\"header-anchor\" href=\"#list\">¶</a>list</h5>\n<h5 id=\"set\"><a class=\"header-anchor\" href=\"#set\">¶</a>set</h5>\n<h5 id=\"z-set\"><a class=\"header-anchor\" href=\"#z-set\">¶</a>z_set</h5>\n<h5 id=\"hash\"><a class=\"header-anchor\" href=\"#hash\">¶</a>hash</h5>\n<h4 id=\"网络连接处理\"><a class=\"header-anchor\" href=\"#网络连接处理\">¶</a>网络连接处理</h4>\n<h4 id=\"集群处理「哨兵模式」\"><a class=\"header-anchor\" href=\"#集群处理「哨兵模式」\">¶</a>集群处理「哨兵模式」</h4>\n<h4 id=\"事件处理\"><a class=\"header-anchor\" href=\"#事件处理\">¶</a>事件处理</h4>\n<h4 id=\"AOF-RDB\"><a class=\"header-anchor\" href=\"#AOF-RDB\">¶</a>AOF &amp; RDB</h4>\n<h4 id=\"命令实现\"><a class=\"header-anchor\" href=\"#命令实现\">¶</a>命令实现</h4>\n<h4 id=\"复制\"><a class=\"header-anchor\" href=\"#复制\">¶</a>复制</h4>\n<h4 id=\"悲观锁和乐观锁\"><a class=\"header-anchor\" href=\"#悲观锁和乐观锁\">¶</a>悲观锁和乐观锁</h4>\n<h4 id=\"消息通知「发布-订阅」\"><a class=\"header-anchor\" href=\"#消息通知「发布-订阅」\">¶</a>消息通知「发布/订阅」</h4>\n<h4 id=\"基数统计「hyperLogLog」\"><a class=\"header-anchor\" href=\"#基数统计「hyperLogLog」\">¶</a>基数统计「hyperLogLog」</h4>\n<h4 id=\"集群伸缩\"><a class=\"header-anchor\" href=\"#集群伸缩\">¶</a>集群伸缩</h4>\n<h3 id=\"踩坑篇\"><a class=\"header-anchor\" href=\"#踩坑篇\">¶</a>踩坑篇</h3>\n<h2 id=\"N个问题\"><a class=\"header-anchor\" href=\"#N个问题\">¶</a>N个问题</h2>\n<h4 id=\"正态规划：\"><a class=\"header-anchor\" href=\"#正态规划：\">¶</a>正态规划：</h4>\n<h4 id=\"窗口滑动\"><a class=\"header-anchor\" href=\"#窗口滑动\">¶</a>窗口滑动:</h4>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Redis\"><a class=\"header-anchor\" href=\"#Redis\">¶</a>Redis</h2>\n<h3 id=\"使用篇\"><a class=\"header-anchor\" href=\"#使用篇\">¶</a>使用篇</h3>\n<h3 id=\"源码篇\"><a class=\"header-anchor\" href=\"#源码篇\">¶</a>源码篇</h3>\n<h4 id=\"五大数据结构\"><a class=\"header-anchor\" href=\"#五大数据结构\">¶</a>五大数据结构</h4>\n<h5 id=\"string\"><a class=\"header-anchor\" href=\"#string\">¶</a>string</h5>\n<h6 id=\"sds\"><a class=\"header-anchor\" href=\"#sds\">¶</a>sds</h6>\n<h5 id=\"list\"><a class=\"header-anchor\" href=\"#list\">¶</a>list</h5>\n<h5 id=\"set\"><a class=\"header-anchor\" href=\"#set\">¶</a>set</h5>\n<h5 id=\"z-set\"><a class=\"header-anchor\" href=\"#z-set\">¶</a>z_set</h5>\n<h5 id=\"hash\"><a class=\"header-anchor\" href=\"#hash\">¶</a>hash</h5>\n<h4 id=\"网络连接处理\"><a class=\"header-anchor\" href=\"#网络连接处理\">¶</a>网络连接处理</h4>\n<h4 id=\"集群处理「哨兵模式」\"><a class=\"header-anchor\" href=\"#集群处理「哨兵模式」\">¶</a>集群处理「哨兵模式」</h4>\n<h4 id=\"事件处理\"><a class=\"header-anchor\" href=\"#事件处理\">¶</a>事件处理</h4>\n<h4 id=\"AOF-RDB\"><a class=\"header-anchor\" href=\"#AOF-RDB\">¶</a>AOF &amp; RDB</h4>\n<h4 id=\"命令实现\"><a class=\"header-anchor\" href=\"#命令实现\">¶</a>命令实现</h4>\n<h4 id=\"复制\"><a class=\"header-anchor\" href=\"#复制\">¶</a>复制</h4>\n<h4 id=\"悲观锁和乐观锁\"><a class=\"header-anchor\" href=\"#悲观锁和乐观锁\">¶</a>悲观锁和乐观锁</h4>\n<h4 id=\"消息通知「发布-订阅」\"><a class=\"header-anchor\" href=\"#消息通知「发布-订阅」\">¶</a>消息通知「发布/订阅」</h4>\n<h4 id=\"基数统计「hyperLogLog」\"><a class=\"header-anchor\" href=\"#基数统计「hyperLogLog」\">¶</a>基数统计「hyperLogLog」</h4>\n<h4 id=\"集群伸缩\"><a class=\"header-anchor\" href=\"#集群伸缩\">¶</a>集群伸缩</h4>\n<h3 id=\"踩坑篇\"><a class=\"header-anchor\" href=\"#踩坑篇\">¶</a>踩坑篇</h3>\n<h2 id=\"N个问题\"><a class=\"header-anchor\" href=\"#N个问题\">¶</a>N个问题</h2>\n<h4 id=\"正态规划：\"><a class=\"header-anchor\" href=\"#正态规划：\">¶</a>正态规划：</h4>\n<h4 id=\"窗口滑动\"><a class=\"header-anchor\" href=\"#窗口滑动\">¶</a>窗口滑动:</h4>","length":159},{"title":"「1」重拾那份折腾之心，坚定脚步","date":"2020-08-31T00:48:48.000Z","updated":"2020-08-31T00:48:48.000Z","keywords":"折腾,后端博客,golang","toc":true,"abbrlink":"640b5696","_content":"\n    从前，现在，将来...","source":"_posts/1-重拾那份折腾之心，坚定脚步.md","raw":"---\ntitle: 「1」重拾那份折腾之心，坚定脚步\ndate: '2020/08/31 08:48:48'\nupdated: '2020/08/31 08:48:48'\nkeywords: '折腾,后端博客,golang'\ntoc: true\ntags:\n  - life\nabbrlink: 640b5696\n---\n\n    从前，现在，将来...","slug":"1-重拾那份折腾之心，坚定脚步","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkw000c3ci75hxnhpmb","content":"<pre><code>从前，现在，将来...</code></pre>\n","site":{"data":{}},"excerpt":"","more":"<pre><code>从前，现在，将来...</code></pre>\n","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Mon Aug 31 2020 08:48:48 GMT+0800 (中国标准时间)","title":"「1」重拾那份折腾之心，坚定脚步","path":"archives/640b5696.html","eyeCatchImage":null,"excerpt":null,"date":{"_isAMomentObject":true,"_i":"2020-08-31T00:48:48.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-08-31T00:48:48.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["life"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":11},{"title":"「11」hexo 主题&评论&进度条&背景效果","date":"2020-09-22T17:10:02.000Z","updated":"2020-09-22T17:10:02.000Z","keywords":"hexo,hexo主题,hexo评论,next主题评论,hexo阅读进度条","abbrlink":"e18c94ab","_content":"\n晚上折腾了下博客，稍微装饰了下，主要还是加了个评论吧，其它非常秀的插件就没有接入了，懒得折腾，好好写博客，内容才是精华。\n记录下折腾史：\n\n### gitalk评论插件\n\n#### 步骤：\n##### 申请id和secret\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png)\n\n<!-- more -->\n\n#### 配置文件：\n\n```\ngitalk:\n  enable: true\n  github_id: crab21 # GitHub repo owner\n  repo: blog # Repository name to store issues\n  client_id: XXX # GitHub Application Client ID\n  client_secret: XXX # GitHub Application Client Secret\n  admin_user: crab21 # GitHub repo owner and collaborators, only these guys can initialize gitHub issues\n  distraction_free_mode: true # Facebook-like distraction free mode\n  perPage: 15 #每页多少个评论\n  pagerDirection: last  #排序方式是从旧到新（first）还是从新到旧（last）\n  createIssueManually: true #如果当前页面没有相应的 isssue ，且登录的用户属于 admin，则会自动创建 issue。如果设置为 true，则显示一个初始化页面，创建 issue 需要点击 init 按钮。\n  distractionFreeMode: true #是否启用快捷键(cmd|ctrl + enter) 提交评论.\n\n  # Gitalk's display language depends on user's browser or system environment\n  # If you want everyone visiting your site to see a uniform language, you can set a force language value\n  # Available values: en | es-ES | fr | ru | zh-CN | zh-TW\n  language:\n```\n\n### pac阅读进度百分比\n1、github地址： https://github.com/HubSpot/pace，可以看下介绍\n2、修改值：\n    修改主题下面的_config.yml：\n    ```go\n    pace:\n        enable: true\n        # Themes list:\n        # big-counter | bounce | barber-shop | center-atom | center-circle | center-radar | center-simple\n        # corner-indicator | fill-left | flat-top | flash | loading-bar | mac-osx | material | minimal\n        theme: minimal\n    ```\n\n### reading_progress\n\ngithub地址：https://github.com/theme-next/theme-next-reading-progress\n\n包含使用说明和具体的步骤，就不搬运了，及时调整。\n\n### 文章字数和阅读时间统计：\n\nhexo配置文件中修改：\n    `symbols_count_time` 为true.\n\n### back2top\n开启模式\n```\nback2top:\n  enable: true\n  # Back to top in sidebar.\n  sidebar: true\n  # Scroll percent label in b2t button.\n  scrollpercent: true\n```\n### 持续更新...\n\n### END\n","source":"_posts/11-hexo-主题-评论-进度条-背景效果.md","raw":"---\ntitle: 「11」hexo 主题&评论&进度条&背景效果\ndate: '2020/09/23 01:10:02'\nupdated: '2020/09/23 01:10:02'\nkeywords: 'hexo,hexo主题,hexo评论,next主题评论,hexo阅读进度条'\ntags:\n  - hexo\n  - hexo插件\nabbrlink: e18c94ab\n---\n\n晚上折腾了下博客，稍微装饰了下，主要还是加了个评论吧，其它非常秀的插件就没有接入了，懒得折腾，好好写博客，内容才是精华。\n记录下折腾史：\n\n### gitalk评论插件\n\n#### 步骤：\n##### 申请id和secret\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png)\n\n<!-- more -->\n\n#### 配置文件：\n\n```\ngitalk:\n  enable: true\n  github_id: crab21 # GitHub repo owner\n  repo: blog # Repository name to store issues\n  client_id: XXX # GitHub Application Client ID\n  client_secret: XXX # GitHub Application Client Secret\n  admin_user: crab21 # GitHub repo owner and collaborators, only these guys can initialize gitHub issues\n  distraction_free_mode: true # Facebook-like distraction free mode\n  perPage: 15 #每页多少个评论\n  pagerDirection: last  #排序方式是从旧到新（first）还是从新到旧（last）\n  createIssueManually: true #如果当前页面没有相应的 isssue ，且登录的用户属于 admin，则会自动创建 issue。如果设置为 true，则显示一个初始化页面，创建 issue 需要点击 init 按钮。\n  distractionFreeMode: true #是否启用快捷键(cmd|ctrl + enter) 提交评论.\n\n  # Gitalk's display language depends on user's browser or system environment\n  # If you want everyone visiting your site to see a uniform language, you can set a force language value\n  # Available values: en | es-ES | fr | ru | zh-CN | zh-TW\n  language:\n```\n\n### pac阅读进度百分比\n1、github地址： https://github.com/HubSpot/pace，可以看下介绍\n2、修改值：\n    修改主题下面的_config.yml：\n    ```go\n    pace:\n        enable: true\n        # Themes list:\n        # big-counter | bounce | barber-shop | center-atom | center-circle | center-radar | center-simple\n        # corner-indicator | fill-left | flat-top | flash | loading-bar | mac-osx | material | minimal\n        theme: minimal\n    ```\n\n### reading_progress\n\ngithub地址：https://github.com/theme-next/theme-next-reading-progress\n\n包含使用说明和具体的步骤，就不搬运了，及时调整。\n\n### 文章字数和阅读时间统计：\n\nhexo配置文件中修改：\n    `symbols_count_time` 为true.\n\n### back2top\n开启模式\n```\nback2top:\n  enable: true\n  # Back to top in sidebar.\n  sidebar: true\n  # Scroll percent label in b2t button.\n  scrollpercent: true\n```\n### 持续更新...\n\n### END\n","slug":"11-hexo-主题-评论-进度条-背景效果","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkw000d3ci7fnzthl8s","content":"<p>晚上折腾了下博客，稍微装饰了下，主要还是加了个评论吧，其它非常秀的插件就没有接入了，懒得折腾，好好写博客，内容才是精华。<br>\n记录下折腾史：</p>\n<h3 id=\"gitalk评论插件\"><a class=\"header-anchor\" href=\"#gitalk评论插件\">¶</a>gitalk评论插件</h3>\n<h4 id=\"步骤：\"><a class=\"header-anchor\" href=\"#步骤：\">¶</a>步骤：</h4>\n<h5 id=\"申请id和secret\"><a class=\"header-anchor\" href=\"#申请id和secret\">¶</a>申请id和secret</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png\" alt=\"\"></p>\n<a id=\"more\"></a>\n<h4 id=\"配置文件：\"><a class=\"header-anchor\" href=\"#配置文件：\">¶</a>配置文件：</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitalk:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  github_id: crab21 # GitHub repo owner</span><br><span class=\"line\">  repo: blog # Repository name to store issues</span><br><span class=\"line\">  client_id: XXX # GitHub Application Client ID</span><br><span class=\"line\">  client_secret: XXX # GitHub Application Client Secret</span><br><span class=\"line\">  admin_user: crab21 # GitHub repo owner and collaborators, only these guys can initialize gitHub issues</span><br><span class=\"line\">  distraction_free_mode: true # Facebook-like distraction free mode</span><br><span class=\"line\">  perPage: 15 #每页多少个评论</span><br><span class=\"line\">  pagerDirection: last  #排序方式是从旧到新（first）还是从新到旧（last）</span><br><span class=\"line\">  createIssueManually: true #如果当前页面没有相应的 isssue ，且登录的用户属于 admin，则会自动创建 issue。如果设置为 true，则显示一个初始化页面，创建 issue 需要点击 init 按钮。</span><br><span class=\"line\">  distractionFreeMode: true #是否启用快捷键(cmd|ctrl + enter) 提交评论.</span><br><span class=\"line\"></span><br><span class=\"line\">  # Gitalk&#39;s display language depends on user&#39;s browser or system environment</span><br><span class=\"line\">  # If you want everyone visiting your site to see a uniform language, you can set a force language value</span><br><span class=\"line\">  # Available values: en | es-ES | fr | ru | zh-CN | zh-TW</span><br><span class=\"line\">  language:</span><br></pre></td></tr></table></figure>\n<h3 id=\"pac阅读进度百分比\"><a class=\"header-anchor\" href=\"#pac阅读进度百分比\">¶</a>pac阅读进度百分比</h3>\n<p>1、github地址： https://github.com/HubSpot/pace，可以看下介绍<br>\n2、修改值：<br>\n修改主题下面的_config.yml：<br>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pace:</span><br><span class=\"line\">    enable: <span class=\"literal\">true</span></span><br><span class=\"line\">    # Themes list:</span><br><span class=\"line\">    # big-counter | bounce | barber-shop | center-atom | center-circle | center-radar | center-simple</span><br><span class=\"line\">    # corner-indicator | fill-left | flat-top | flash | loading-bar | mac-osx | material | minimal</span><br><span class=\"line\">    theme: minimal</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"reading-progress\"><a class=\"header-anchor\" href=\"#reading-progress\">¶</a>reading_progress</h3>\n<p>github地址：https://github.com/theme-next/theme-next-reading-progress</p>\n<p>包含使用说明和具体的步骤，就不搬运了，及时调整。</p>\n<h3 id=\"文章字数和阅读时间统计：\"><a class=\"header-anchor\" href=\"#文章字数和阅读时间统计：\">¶</a>文章字数和阅读时间统计：</h3>\n<p>hexo配置文件中修改：<br>\n<code>symbols_count_time</code> 为true.</p>\n<h3 id=\"back2top\"><a class=\"header-anchor\" href=\"#back2top\">¶</a>back2top</h3>\n<p>开启模式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">back2top:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  # Back to top in sidebar.</span><br><span class=\"line\">  sidebar: true</span><br><span class=\"line\">  # Scroll percent label in b2t button.</span><br><span class=\"line\">  scrollpercent: true</span><br></pre></td></tr></table></figure>\n<h3 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h3>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<p>晚上折腾了下博客，稍微装饰了下，主要还是加了个评论吧，其它非常秀的插件就没有接入了，懒得折腾，好好写博客，内容才是精华。<br>\n记录下折腾史：</p>\n<h3 id=\"gitalk评论插件\"><a class=\"header-anchor\" href=\"#gitalk评论插件\">¶</a>gitalk评论插件</h3>\n<h4 id=\"步骤：\"><a class=\"header-anchor\" href=\"#步骤：\">¶</a>步骤：</h4>\n<h5 id=\"申请id和secret\"><a class=\"header-anchor\" href=\"#申请id和secret\">¶</a>申请id和secret</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png\" alt=\"\"></p>","more":"<h4 id=\"配置文件：\"><a class=\"header-anchor\" href=\"#配置文件：\">¶</a>配置文件：</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitalk:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  github_id: crab21 # GitHub repo owner</span><br><span class=\"line\">  repo: blog # Repository name to store issues</span><br><span class=\"line\">  client_id: XXX # GitHub Application Client ID</span><br><span class=\"line\">  client_secret: XXX # GitHub Application Client Secret</span><br><span class=\"line\">  admin_user: crab21 # GitHub repo owner and collaborators, only these guys can initialize gitHub issues</span><br><span class=\"line\">  distraction_free_mode: true # Facebook-like distraction free mode</span><br><span class=\"line\">  perPage: 15 #每页多少个评论</span><br><span class=\"line\">  pagerDirection: last  #排序方式是从旧到新（first）还是从新到旧（last）</span><br><span class=\"line\">  createIssueManually: true #如果当前页面没有相应的 isssue ，且登录的用户属于 admin，则会自动创建 issue。如果设置为 true，则显示一个初始化页面，创建 issue 需要点击 init 按钮。</span><br><span class=\"line\">  distractionFreeMode: true #是否启用快捷键(cmd|ctrl + enter) 提交评论.</span><br><span class=\"line\"></span><br><span class=\"line\">  # Gitalk&#39;s display language depends on user&#39;s browser or system environment</span><br><span class=\"line\">  # If you want everyone visiting your site to see a uniform language, you can set a force language value</span><br><span class=\"line\">  # Available values: en | es-ES | fr | ru | zh-CN | zh-TW</span><br><span class=\"line\">  language:</span><br></pre></td></tr></table></figure>\n<h3 id=\"pac阅读进度百分比\"><a class=\"header-anchor\" href=\"#pac阅读进度百分比\">¶</a>pac阅读进度百分比</h3>\n<p>1、github地址： https://github.com/HubSpot/pace，可以看下介绍<br>\n2、修改值：<br>\n修改主题下面的_config.yml：<br>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pace:</span><br><span class=\"line\">    enable: <span class=\"literal\">true</span></span><br><span class=\"line\">    # Themes list:</span><br><span class=\"line\">    # big-counter | bounce | barber-shop | center-atom | center-circle | center-radar | center-simple</span><br><span class=\"line\">    # corner-indicator | fill-left | flat-top | flash | loading-bar | mac-osx | material | minimal</span><br><span class=\"line\">    theme: minimal</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"reading-progress\"><a class=\"header-anchor\" href=\"#reading-progress\">¶</a>reading_progress</h3>\n<p>github地址：https://github.com/theme-next/theme-next-reading-progress</p>\n<p>包含使用说明和具体的步骤，就不搬运了，及时调整。</p>\n<h3 id=\"文章字数和阅读时间统计：\"><a class=\"header-anchor\" href=\"#文章字数和阅读时间统计：\">¶</a>文章字数和阅读时间统计：</h3>\n<p>hexo配置文件中修改：<br>\n<code>symbols_count_time</code> 为true.</p>\n<h3 id=\"back2top\"><a class=\"header-anchor\" href=\"#back2top\">¶</a>back2top</h3>\n<p>开启模式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">back2top:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  # Back to top in sidebar.</span><br><span class=\"line\">  sidebar: true</span><br><span class=\"line\">  # Scroll percent label in b2t button.</span><br><span class=\"line\">  scrollpercent: true</span><br></pre></td></tr></table></figure>\n<h3 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h3>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png","popularPost_tmp_gaData":{"updated":"Wed Sep 23 2020 01:10:02 GMT+0800 (中国标准时间)","title":"「11」hexo 主题&评论&进度条&背景效果","path":"archives/e18c94ab.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png","excerpt":"<p>晚上折腾了下博客，稍微装饰了下，主要还是加了个评论吧，其它非常秀的插件就没有接入了，懒得折腾，好好写博客，内容才是精华。<br>\n记录下折腾史：</p>\n<h3 id=\"gitalk评论插件\"><a class=\"header-anchor\" href=\"#gitalk评论插件\">¶</a>gitalk评论插件</h3>\n<h4 id=\"步骤：\"><a class=\"header-anchor\" href=\"#步骤：\">¶</a>步骤：</h4>\n<h5 id=\"申请id和secret\"><a class=\"header-anchor\" href=\"#申请id和secret\">¶</a>申请id和secret</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/36f31671-8ada-4cbe-b60b-d1595dd701ee.png\" alt=\"\"></p>","date":{"_isAMomentObject":true,"_i":"2020-09-22T17:10:02.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-22T17:10:02.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["hexo","hexo插件"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":1462},{"title":"「10」go mutex解读","date":"2020-09-21T15:06:32.000Z","updated":"2020-09-22T05:20:32.000Z","keywords":"golang,go 源码,go 锁, mutex 解读","abbrlink":"ff0d6c2b","_content":"\n上次说到rwmutex读写锁，其实就是加强了锁的粒度，区分读和写时不同的情况，核心思想：写优先于读。\n这次来看看mutex，go中的锁是如何实现的，用一张图来概括整个流程：\n<!-- more -->\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/mutex.png)\n\n>核心思想：饥饿和队列，正常流程都是加入到队列尾部，如果超过一定的时间限制则加入到队列头部。\n\n### 前序\n>开始看代码或者分析之前，先看下文档说明及其相关的资料。\n\n```\n◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### src/sync/mutex.go\n```go\nconst (\n\tmutexLocked = 1 << iota // mutex is locked      state & mutexLocked 1==加锁  0==未加锁\n\n\t\n\n\tmutexWoken                                      //state & mutexWoken 1==唤醒  0==未唤醒\n\tmutexStarving                                   // state & mutexStarving 1==饥饿状态   0==正常状态\n\tmutexWaiterShift = iota                         // state >> mutexWaiterShift得到当前的goroutine数量\n\n\t// Mutex fairness.\n\t// 两种模式：正常或饥饿\n    // Mutex can be in 2 modes of operations: normal and starvation.\n    //  正常模式就是FIFO队列。\n\t// In normal mode waiters are queued in FIFO order, but a woken up waiter\n\t// does not own the mutex and competes with new arriving goroutines over\n\t// the ownership. New arriving goroutines have an advantage -- they are\n\t// already running on CPU and there can be lots of them, so a woken up\n\t// waiter has good chances of losing. In such case it is queued at front\n\t// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,  //获取锁的时间超过1ms，切换到饥饿模式\n\t// it switches mutex to the starvation mode.\n\t//\n\t// In starvation mode ownership of the mutex is directly handed off from        //饥饿模式下锁的所有权直接从解锁goroutine的waiter手中移交到队列的前面。\n\t// the unlocking goroutine to the waiter at the front of the queue.\n\t// New arriving goroutines don't try to acquire the mutex even if it appears\n\t// to be unlocked, and don't try to spin. Instead they queue themselves at\n\t// the tail of the wait queue.\n\t//\n\t// If a waiter receives ownership of the mutex and sees that either         //如果一个锁的所有权的等待者是以下两种情况之一的：1、处于队列的最后一个2、等待时间少于1ms，则切换到正常模式\n\t// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,\n\t// it switches mutex back to normal operation mode.\n\t//\n\t// Normal mode has considerably better performance as a goroutine can acquire\n\t// a mutex several times in a row even if there are blocked waiters.\n\t// Starvation mode is important to prevent pathological cases of tail latency.\n\tstarvationThresholdNs = 1e6\n)\n```\n### 加锁流程\n>加锁过程图如上图提到的流程。\n\n>加锁代码具体流程：\n\n```go\nfunc (m *Mutex) Lock() {\n\t// Fast path: grab unlocked mutex.\n\tif atomic.CompareAndSwapInt32(&m.state, 0, mutexLocked) {\n\t\tif race.Enabled {\n\t\t\trace.Acquire(unsafe.Pointer(m))\n\t\t}\n\t\treturn\n\t}\n\t// Slow path (outlined so that the fast path can be inlined)\n\tm.lockSlow()\n}\n\nfunc (m *Mutex) lockSlow() {\n\tvar waitStartTime int64 //等待时间\n\tstarving := false       //是否处于饥饿状态\n\tawoke := false          //唤醒状态\n\titer := 0               //自旋次数\n\told := m.state          //当前状态copy\n\tfor {\n\t\t// Don't spin in starvation mode, ownership is handed off to waiters\n        // so we won't be able to acquire the mutex anyway.\n        //加锁且能够自旋\n\t\tif old&(mutexLocked|mutexStarving) == mutexLocked && runtime_canSpin(iter) {\n\t\t\t// Active spinning makes sense.\n\t\t\t// Try to set mutexWoken flag to inform Unlock\n            // to not wake other blocked goroutines.\n            //自旋过程发现没有被置woken标识，设置标识，将自己置为唤醒\n\t\t\tif !awoke && old&mutexWoken == 0 && old>>mutexWaiterShift != 0 &&\n\t\t\t\tatomic.CompareAndSwapInt32(&m.state, old, old|mutexWoken) {\n\t\t\t\tawoke = true\n\t\t\t}\n\t\t\truntime_doSpin()    //自旋\n\t\t\titer++              \n\t\t\told = m.state       //状态重置\n\t\t\tcontinue\n        }\n        //更新状态\n\t\tnew := old\n        // Don't try to acquire starving mutex, new arriving goroutines must queue.\n        //非饥饿模式，则置锁\n\t\tif old&mutexStarving == 0 {\n\t\t\tnew |= mutexLocked\n        }\n        // 处于饥饿模式下，新来的goroutine进入队列中\n\t\tif old&(mutexLocked|mutexStarving) != 0 {\n\t\t\tnew += 1 << mutexWaiterShift\n\t\t}\n\t\t// The current goroutine switches mutex to starvation mode.\n\t\t// But if the mutex is currently unlocked, don't do the switch.\n\t\t// Unlock expects that starving mutex has waiters, which will not\n        // be true in this case.\n        //切换到饥饿模式下\n\t\tif starving && old&mutexLocked != 0 {\n\t\t\tnew |= mutexStarving\n        }\n        //当前处于唤醒状态，则重置清除唤醒状态。\n\t\tif awoke {\n\t\t\t// The goroutine has been woken from sleep,\n\t\t\t// so we need to reset the flag in either case.\n\t\t\tif new&mutexWoken == 0 {\n\t\t\t\tthrow(\"sync: inconsistent mutex state\")\n\t\t\t}\n\t\t\tnew &^= mutexWoken\n        }\n        //CAS更新状态。\n\t\tif atomic.CompareAndSwapInt32(&m.state, old, new) {\n            //获取到锁\n\t\t\tif old&(mutexLocked|mutexStarving) == 0 {\n\t\t\t\tbreak // locked the mutex with CAS\n\t\t\t}\n            // If we were already waiting before, queue at the front of the queue.\n            //等待队列的时间\n\t\t\tqueueLifo := waitStartTime != 0\n\t\t\tif waitStartTime == 0 {\n\t\t\t\twaitStartTime = runtime_nanotime()\n            }\n            //acquire阻塞队列....\n            // 新来的 goroutine, queueLifo=false, 加入到等待队列的尾部，耐心等待\n            // 唤醒的 goroutine, queueLifo=true, 加入到等待队列的头部\n\t\t\truntime_SemacquireMutex(&m.sema, queueLifo, 1)\n\t\t\tstarving = starving || runtime_nanotime()-waitStartTime > starvationThresholdNs\n            old = m.state\n            //处于饥饿模式\n\t\t\tif old&mutexStarving != 0 {\n\t\t\t\t// If this goroutine was woken and mutex is in starvation mode,\n\t\t\t\t// ownership was handed off to us but mutex is in somewhat\n\t\t\t\t// inconsistent state: mutexLocked is not set and we are still\n\t\t\t\t// accounted as waiter. Fix that.\n\t\t\t\tif old&(mutexLocked|mutexWoken) != 0 || old>>mutexWaiterShift == 0 {\n\t\t\t\t\tthrow(\"sync: inconsistent mutex state\")\n                }\n                //等待的goroutine-1\n                delta := int32(mutexLocked - 1<<mutexWaiterShift)\n                // 处于队列中最后一个或者请求锁的时间未超过starvationThresholdNs，则回退到正常模式。\n\t\t\t\tif !starving || old>>mutexWaiterShift == 1 {\n\t\t\t\t\t// Exit starvation mode.\n\t\t\t\t\t// Critical to do it here and consider wait time.\n\t\t\t\t\t// Starvation mode is so inefficient, that two goroutines\n\t\t\t\t\t// can go lock-step infinitely once they switch mutex\n\t\t\t\t\t// to starvation mode.\n\t\t\t\t\tdelta -= mutexStarving\n                }\n                //更新状态\n\t\t\t\tatomic.AddInt32(&m.state, delta)\n\t\t\t\tbreak\n            }\n            //重置迭代器和唤醒表示，继续获取锁\n\t\t\tawoke = true\n\t\t\titer = 0\n\t\t} else {\n            //CAS失败，则更新状态，继续获取。\n\t\t\told = m.state\n\t\t}\n\t}\n\n\tif race.Enabled {\n\t\trace.Acquire(unsafe.Pointer(m))\n\t}\n}\n\n```\n### 解锁过程\n\n用一个流程图来表示解锁过程：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/mutex-unlock.png)\n\n```go\nfunc (m *Mutex) Unlock() {\n    //state 不是处于锁的状态, 那么就是 Unlock 根本没有加锁的 mutex, panic\n    new := atomic.AddInt32(&m.state, -mutexLocked)\n    if (new+mutexLocked)&mutexLocked == 0 {\n        throw(\"sync: unlock of unlocked mutex\")\n    }\n\n    // 释放锁，并通知其它等待者\n    // 锁如果处于饥饿状态，直接交给等待队列的第一个, 唤醒它，让它去获取锁\n    // mutex 正常模式\n    if new&mutexStarving == 0 {\n        old := new\n        for {\n            // 如果没有等待者，或者已经存在一个 goroutine 被唤醒或得到锁、或处于饥饿模式\n            // 直接返回.\n            if old>>mutexWaiterShift == 0 || old&(mutexLocked|mutexWoken|mutexStarving) != 0 {\n                return\n            }\n            // 将等待的 goroutine-1，并设置 woken 标识\n            new = (old - 1<<mutexWaiterShift) | mutexWoken\n            // 设置新的 state, 这里通过信号量会唤醒一个阻塞的 goroutine 去获取锁.\n            if atomic.CompareAndSwapInt32(&m.state, old, new) {\n                runtime_Semrelease(&m.sema, false)\n                return\n            }\n            old = m.state\n        }\n    } else {\n        // mutex 饥饿模式，直接将 mutex 拥有权移交给等待队列最前端的 goroutine\n        // 注意此时 state 的 mutex 还没有加锁，唤醒的 goroutine 会设置它。\n        // 在此期间，如果有新的 goroutine 来请求锁， 因为 mutex 处于饥饿状态， mutex 还是被认为处于锁状态，\n        // 新来的 goroutine 不会把锁抢过去.\n        runtime_Semrelease(&m.sema, true)\n    }\n}\n\n```\n\n### 关键点\n\n* 不要重复锁定互斥锁\n* 不要忘记解锁互斥锁\n* 不要在多个函数之间直接传递互斥锁\n\n### END","source":"_posts/10-sync-mutex解读.md","raw":"---\ntitle: 「10」go mutex解读\ndate: '2020/09/21 23:06:32'\nupdated: '2020/09/22 13:20:32'\nkeywords: 'golang,go 源码,go 锁, mutex 解读'\ntags:\n  - Go\n  - Go源码\n  - Go Package\n  - 锁\nabbrlink: ff0d6c2b\n---\n\n上次说到rwmutex读写锁，其实就是加强了锁的粒度，区分读和写时不同的情况，核心思想：写优先于读。\n这次来看看mutex，go中的锁是如何实现的，用一张图来概括整个流程：\n<!-- more -->\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/mutex.png)\n\n>核心思想：饥饿和队列，正常流程都是加入到队列尾部，如果超过一定的时间限制则加入到队列头部。\n\n### 前序\n>开始看代码或者分析之前，先看下文档说明及其相关的资料。\n\n```\n◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### src/sync/mutex.go\n```go\nconst (\n\tmutexLocked = 1 << iota // mutex is locked      state & mutexLocked 1==加锁  0==未加锁\n\n\t\n\n\tmutexWoken                                      //state & mutexWoken 1==唤醒  0==未唤醒\n\tmutexStarving                                   // state & mutexStarving 1==饥饿状态   0==正常状态\n\tmutexWaiterShift = iota                         // state >> mutexWaiterShift得到当前的goroutine数量\n\n\t// Mutex fairness.\n\t// 两种模式：正常或饥饿\n    // Mutex can be in 2 modes of operations: normal and starvation.\n    //  正常模式就是FIFO队列。\n\t// In normal mode waiters are queued in FIFO order, but a woken up waiter\n\t// does not own the mutex and competes with new arriving goroutines over\n\t// the ownership. New arriving goroutines have an advantage -- they are\n\t// already running on CPU and there can be lots of them, so a woken up\n\t// waiter has good chances of losing. In such case it is queued at front\n\t// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,  //获取锁的时间超过1ms，切换到饥饿模式\n\t// it switches mutex to the starvation mode.\n\t//\n\t// In starvation mode ownership of the mutex is directly handed off from        //饥饿模式下锁的所有权直接从解锁goroutine的waiter手中移交到队列的前面。\n\t// the unlocking goroutine to the waiter at the front of the queue.\n\t// New arriving goroutines don't try to acquire the mutex even if it appears\n\t// to be unlocked, and don't try to spin. Instead they queue themselves at\n\t// the tail of the wait queue.\n\t//\n\t// If a waiter receives ownership of the mutex and sees that either         //如果一个锁的所有权的等待者是以下两种情况之一的：1、处于队列的最后一个2、等待时间少于1ms，则切换到正常模式\n\t// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,\n\t// it switches mutex back to normal operation mode.\n\t//\n\t// Normal mode has considerably better performance as a goroutine can acquire\n\t// a mutex several times in a row even if there are blocked waiters.\n\t// Starvation mode is important to prevent pathological cases of tail latency.\n\tstarvationThresholdNs = 1e6\n)\n```\n### 加锁流程\n>加锁过程图如上图提到的流程。\n\n>加锁代码具体流程：\n\n```go\nfunc (m *Mutex) Lock() {\n\t// Fast path: grab unlocked mutex.\n\tif atomic.CompareAndSwapInt32(&m.state, 0, mutexLocked) {\n\t\tif race.Enabled {\n\t\t\trace.Acquire(unsafe.Pointer(m))\n\t\t}\n\t\treturn\n\t}\n\t// Slow path (outlined so that the fast path can be inlined)\n\tm.lockSlow()\n}\n\nfunc (m *Mutex) lockSlow() {\n\tvar waitStartTime int64 //等待时间\n\tstarving := false       //是否处于饥饿状态\n\tawoke := false          //唤醒状态\n\titer := 0               //自旋次数\n\told := m.state          //当前状态copy\n\tfor {\n\t\t// Don't spin in starvation mode, ownership is handed off to waiters\n        // so we won't be able to acquire the mutex anyway.\n        //加锁且能够自旋\n\t\tif old&(mutexLocked|mutexStarving) == mutexLocked && runtime_canSpin(iter) {\n\t\t\t// Active spinning makes sense.\n\t\t\t// Try to set mutexWoken flag to inform Unlock\n            // to not wake other blocked goroutines.\n            //自旋过程发现没有被置woken标识，设置标识，将自己置为唤醒\n\t\t\tif !awoke && old&mutexWoken == 0 && old>>mutexWaiterShift != 0 &&\n\t\t\t\tatomic.CompareAndSwapInt32(&m.state, old, old|mutexWoken) {\n\t\t\t\tawoke = true\n\t\t\t}\n\t\t\truntime_doSpin()    //自旋\n\t\t\titer++              \n\t\t\told = m.state       //状态重置\n\t\t\tcontinue\n        }\n        //更新状态\n\t\tnew := old\n        // Don't try to acquire starving mutex, new arriving goroutines must queue.\n        //非饥饿模式，则置锁\n\t\tif old&mutexStarving == 0 {\n\t\t\tnew |= mutexLocked\n        }\n        // 处于饥饿模式下，新来的goroutine进入队列中\n\t\tif old&(mutexLocked|mutexStarving) != 0 {\n\t\t\tnew += 1 << mutexWaiterShift\n\t\t}\n\t\t// The current goroutine switches mutex to starvation mode.\n\t\t// But if the mutex is currently unlocked, don't do the switch.\n\t\t// Unlock expects that starving mutex has waiters, which will not\n        // be true in this case.\n        //切换到饥饿模式下\n\t\tif starving && old&mutexLocked != 0 {\n\t\t\tnew |= mutexStarving\n        }\n        //当前处于唤醒状态，则重置清除唤醒状态。\n\t\tif awoke {\n\t\t\t// The goroutine has been woken from sleep,\n\t\t\t// so we need to reset the flag in either case.\n\t\t\tif new&mutexWoken == 0 {\n\t\t\t\tthrow(\"sync: inconsistent mutex state\")\n\t\t\t}\n\t\t\tnew &^= mutexWoken\n        }\n        //CAS更新状态。\n\t\tif atomic.CompareAndSwapInt32(&m.state, old, new) {\n            //获取到锁\n\t\t\tif old&(mutexLocked|mutexStarving) == 0 {\n\t\t\t\tbreak // locked the mutex with CAS\n\t\t\t}\n            // If we were already waiting before, queue at the front of the queue.\n            //等待队列的时间\n\t\t\tqueueLifo := waitStartTime != 0\n\t\t\tif waitStartTime == 0 {\n\t\t\t\twaitStartTime = runtime_nanotime()\n            }\n            //acquire阻塞队列....\n            // 新来的 goroutine, queueLifo=false, 加入到等待队列的尾部，耐心等待\n            // 唤醒的 goroutine, queueLifo=true, 加入到等待队列的头部\n\t\t\truntime_SemacquireMutex(&m.sema, queueLifo, 1)\n\t\t\tstarving = starving || runtime_nanotime()-waitStartTime > starvationThresholdNs\n            old = m.state\n            //处于饥饿模式\n\t\t\tif old&mutexStarving != 0 {\n\t\t\t\t// If this goroutine was woken and mutex is in starvation mode,\n\t\t\t\t// ownership was handed off to us but mutex is in somewhat\n\t\t\t\t// inconsistent state: mutexLocked is not set and we are still\n\t\t\t\t// accounted as waiter. Fix that.\n\t\t\t\tif old&(mutexLocked|mutexWoken) != 0 || old>>mutexWaiterShift == 0 {\n\t\t\t\t\tthrow(\"sync: inconsistent mutex state\")\n                }\n                //等待的goroutine-1\n                delta := int32(mutexLocked - 1<<mutexWaiterShift)\n                // 处于队列中最后一个或者请求锁的时间未超过starvationThresholdNs，则回退到正常模式。\n\t\t\t\tif !starving || old>>mutexWaiterShift == 1 {\n\t\t\t\t\t// Exit starvation mode.\n\t\t\t\t\t// Critical to do it here and consider wait time.\n\t\t\t\t\t// Starvation mode is so inefficient, that two goroutines\n\t\t\t\t\t// can go lock-step infinitely once they switch mutex\n\t\t\t\t\t// to starvation mode.\n\t\t\t\t\tdelta -= mutexStarving\n                }\n                //更新状态\n\t\t\t\tatomic.AddInt32(&m.state, delta)\n\t\t\t\tbreak\n            }\n            //重置迭代器和唤醒表示，继续获取锁\n\t\t\tawoke = true\n\t\t\titer = 0\n\t\t} else {\n            //CAS失败，则更新状态，继续获取。\n\t\t\told = m.state\n\t\t}\n\t}\n\n\tif race.Enabled {\n\t\trace.Acquire(unsafe.Pointer(m))\n\t}\n}\n\n```\n### 解锁过程\n\n用一个流程图来表示解锁过程：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/mutex-unlock.png)\n\n```go\nfunc (m *Mutex) Unlock() {\n    //state 不是处于锁的状态, 那么就是 Unlock 根本没有加锁的 mutex, panic\n    new := atomic.AddInt32(&m.state, -mutexLocked)\n    if (new+mutexLocked)&mutexLocked == 0 {\n        throw(\"sync: unlock of unlocked mutex\")\n    }\n\n    // 释放锁，并通知其它等待者\n    // 锁如果处于饥饿状态，直接交给等待队列的第一个, 唤醒它，让它去获取锁\n    // mutex 正常模式\n    if new&mutexStarving == 0 {\n        old := new\n        for {\n            // 如果没有等待者，或者已经存在一个 goroutine 被唤醒或得到锁、或处于饥饿模式\n            // 直接返回.\n            if old>>mutexWaiterShift == 0 || old&(mutexLocked|mutexWoken|mutexStarving) != 0 {\n                return\n            }\n            // 将等待的 goroutine-1，并设置 woken 标识\n            new = (old - 1<<mutexWaiterShift) | mutexWoken\n            // 设置新的 state, 这里通过信号量会唤醒一个阻塞的 goroutine 去获取锁.\n            if atomic.CompareAndSwapInt32(&m.state, old, new) {\n                runtime_Semrelease(&m.sema, false)\n                return\n            }\n            old = m.state\n        }\n    } else {\n        // mutex 饥饿模式，直接将 mutex 拥有权移交给等待队列最前端的 goroutine\n        // 注意此时 state 的 mutex 还没有加锁，唤醒的 goroutine 会设置它。\n        // 在此期间，如果有新的 goroutine 来请求锁， 因为 mutex 处于饥饿状态， mutex 还是被认为处于锁状态，\n        // 新来的 goroutine 不会把锁抢过去.\n        runtime_Semrelease(&m.sema, true)\n    }\n}\n\n```\n\n### 关键点\n\n* 不要重复锁定互斥锁\n* 不要忘记解锁互斥锁\n* 不要在多个函数之间直接传递互斥锁\n\n### END","slug":"10-sync-mutex解读","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkx000f3ci7fyz80nu9","content":"<p>上次说到rwmutex读写锁，其实就是加强了锁的粒度，区分读和写时不同的情况，核心思想：写优先于读。<br>\n这次来看看mutex，go中的锁是如何实现的，用一张图来概括整个流程：</p>\n<a id=\"more\"></a>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/mutex.png\" alt=\"\"></p>\n<blockquote>\n<p>核心思想：饥饿和队列，正常流程都是加入到队列尾部，如果超过一定的时间限制则加入到队列头部。</p>\n</blockquote>\n<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<blockquote>\n<p>开始看代码或者分析之前，先看下文档说明及其相关的资料。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">◯  go version</span><br><span class=\"line\">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"src-sync-mutex-go\"><a class=\"header-anchor\" href=\"#src-sync-mutex-go\">¶</a>src/sync/mutex.go</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tmutexLocked = <span class=\"number\">1</span> &lt;&lt; <span class=\"literal\">iota</span> <span class=\"comment\">// mutex is locked      state &amp; mutexLocked 1==加锁  0==未加锁</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tmutexWoken                                      <span class=\"comment\">//state &amp; mutexWoken 1==唤醒  0==未唤醒</span></span><br><span class=\"line\">\tmutexStarving                                   <span class=\"comment\">// state &amp; mutexStarving 1==饥饿状态   0==正常状态</span></span><br><span class=\"line\">\tmutexWaiterShift = <span class=\"literal\">iota</span>                         <span class=\"comment\">// state &gt;&gt; mutexWaiterShift得到当前的goroutine数量</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Mutex fairness.</span></span><br><span class=\"line\">\t<span class=\"comment\">// 两种模式：正常或饥饿</span></span><br><span class=\"line\">    <span class=\"comment\">// Mutex can be in 2 modes of operations: normal and starvation.</span></span><br><span class=\"line\">    <span class=\"comment\">//  正常模式就是FIFO队列。</span></span><br><span class=\"line\">\t<span class=\"comment\">// In normal mode waiters are queued in FIFO order, but a woken up waiter</span></span><br><span class=\"line\">\t<span class=\"comment\">// does not own the mutex and competes with new arriving goroutines over</span></span><br><span class=\"line\">\t<span class=\"comment\">// the ownership. New arriving goroutines have an advantage -- they are</span></span><br><span class=\"line\">\t<span class=\"comment\">// already running on CPU and there can be lots of them, so a woken up</span></span><br><span class=\"line\">\t<span class=\"comment\">// waiter has good chances of losing. In such case it is queued at front</span></span><br><span class=\"line\">\t<span class=\"comment\">// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,  //获取锁的时间超过1ms，切换到饥饿模式</span></span><br><span class=\"line\">\t<span class=\"comment\">// it switches mutex to the starvation mode.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// In starvation mode ownership of the mutex is directly handed off from        //饥饿模式下锁的所有权直接从解锁goroutine的waiter手中移交到队列的前面。</span></span><br><span class=\"line\">\t<span class=\"comment\">// the unlocking goroutine to the waiter at the front of the queue.</span></span><br><span class=\"line\">\t<span class=\"comment\">// New arriving goroutines don&#x27;t try to acquire the mutex even if it appears</span></span><br><span class=\"line\">\t<span class=\"comment\">// to be unlocked, and don&#x27;t try to spin. Instead they queue themselves at</span></span><br><span class=\"line\">\t<span class=\"comment\">// the tail of the wait queue.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// If a waiter receives ownership of the mutex and sees that either         //如果一个锁的所有权的等待者是以下两种情况之一的：1、处于队列的最后一个2、等待时间少于1ms，则切换到正常模式</span></span><br><span class=\"line\">\t<span class=\"comment\">// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,</span></span><br><span class=\"line\">\t<span class=\"comment\">// it switches mutex back to normal operation mode.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// Normal mode has considerably better performance as a goroutine can acquire</span></span><br><span class=\"line\">\t<span class=\"comment\">// a mutex several times in a row even if there are blocked waiters.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Starvation mode is important to prevent pathological cases of tail latency.</span></span><br><span class=\"line\">\tstarvationThresholdNs = <span class=\"number\">1e6</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<h3 id=\"加锁流程\"><a class=\"header-anchor\" href=\"#加锁流程\">¶</a>加锁流程</h3>\n<blockquote>\n<p>加锁过程图如上图提到的流程。</p>\n</blockquote>\n<blockquote>\n<p>加锁代码具体流程：</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *Mutex)</span> <span class=\"title\">Lock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Fast path: grab unlocked mutex.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class=\"number\">0</span>, mutexLocked) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t\trace.Acquire(unsafe.Pointer(m))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Slow path (outlined so that the fast path can be inlined)</span></span><br><span class=\"line\">\tm.lockSlow()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *Mutex)</span> <span class=\"title\">lockSlow</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> waitStartTime <span class=\"keyword\">int64</span> <span class=\"comment\">//等待时间</span></span><br><span class=\"line\">\tstarving := <span class=\"literal\">false</span>       <span class=\"comment\">//是否处于饥饿状态</span></span><br><span class=\"line\">\tawoke := <span class=\"literal\">false</span>          <span class=\"comment\">//唤醒状态</span></span><br><span class=\"line\">\titer := <span class=\"number\">0</span>               <span class=\"comment\">//自旋次数</span></span><br><span class=\"line\">\told := m.state          <span class=\"comment\">//当前状态copy</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Don&#x27;t spin in starvation mode, ownership is handed off to waiters</span></span><br><span class=\"line\">        <span class=\"comment\">// so we won&#x27;t be able to acquire the mutex anyway.</span></span><br><span class=\"line\">        <span class=\"comment\">//加锁且能够自旋</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Active spinning makes sense.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Try to set mutexWoken flag to inform Unlock</span></span><br><span class=\"line\">            <span class=\"comment\">// to not wake other blocked goroutines.</span></span><br><span class=\"line\">            <span class=\"comment\">//自旋过程发现没有被置woken标识，设置标识，将自己置为唤醒</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class=\"number\">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">\t\t\t\tatomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</span><br><span class=\"line\">\t\t\t\tawoke = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\truntime_doSpin()    <span class=\"comment\">//自旋</span></span><br><span class=\"line\">\t\t\titer++              </span><br><span class=\"line\">\t\t\told = m.state       <span class=\"comment\">//状态重置</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//更新状态</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">new</span> := old</span><br><span class=\"line\">        <span class=\"comment\">// Don&#x27;t try to acquire starving mutex, new arriving goroutines must queue.</span></span><br><span class=\"line\">        <span class=\"comment\">//非饥饿模式，则置锁</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> old&amp;mutexStarving == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> |= mutexLocked</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 处于饥饿模式下，新来的goroutine进入队列中</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexStarving) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> += <span class=\"number\">1</span> &lt;&lt; mutexWaiterShift</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The current goroutine switches mutex to starvation mode.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// But if the mutex is currently unlocked, don&#x27;t do the switch.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// Unlock expects that starving mutex has waiters, which will not</span></span><br><span class=\"line\">        <span class=\"comment\">// be true in this case.</span></span><br><span class=\"line\">        <span class=\"comment\">//切换到饥饿模式下</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> |= mutexStarving</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//当前处于唤醒状态，则重置清除唤醒状态。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> awoke &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// The goroutine has been woken from sleep,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// so we need to reset the flag in either case.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"built_in\">new</span>&amp;mutexWoken == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\tthrow(<span class=\"string\">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> &amp;^= mutexWoken</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//CAS更新状态。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class=\"built_in\">new</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//获取到锁</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexStarving) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span> <span class=\"comment\">// locked the mutex with CAS</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">            <span class=\"comment\">// If we were already waiting before, queue at the front of the queue.</span></span><br><span class=\"line\">            <span class=\"comment\">//等待队列的时间</span></span><br><span class=\"line\">\t\t\tqueueLifo := waitStartTime != <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> waitStartTime == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\twaitStartTime = runtime_nanotime()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//acquire阻塞队列....</span></span><br><span class=\"line\">            <span class=\"comment\">// 新来的 goroutine, queueLifo=false, 加入到等待队列的尾部，耐心等待</span></span><br><span class=\"line\">            <span class=\"comment\">// 唤醒的 goroutine, queueLifo=true, 加入到等待队列的头部</span></span><br><span class=\"line\">\t\t\truntime_SemacquireMutex(&amp;m.sema, queueLifo, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\tstarving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</span><br><span class=\"line\">            old = m.state</span><br><span class=\"line\">            <span class=\"comment\">//处于饥饿模式</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> old&amp;mutexStarving != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// If this goroutine was woken and mutex is in starvation mode,</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// ownership was handed off to us but mutex is in somewhat</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// inconsistent state: mutexLocked is not set and we are still</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// accounted as waiter. Fix that.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexWoken) != <span class=\"number\">0</span> || old&gt;&gt;mutexWaiterShift == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tthrow(<span class=\"string\">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//等待的goroutine-1</span></span><br><span class=\"line\">                delta := <span class=\"keyword\">int32</span>(mutexLocked - <span class=\"number\">1</span>&lt;&lt;mutexWaiterShift)</span><br><span class=\"line\">                <span class=\"comment\">// 处于队列中最后一个或者请求锁的时间未超过starvationThresholdNs，则回退到正常模式。</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Exit starvation mode.</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Critical to do it here and consider wait time.</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Starvation mode is so inefficient, that two goroutines</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// can go lock-step infinitely once they switch mutex</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// to starvation mode.</span></span><br><span class=\"line\">\t\t\t\t\tdelta -= mutexStarving</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//更新状态</span></span><br><span class=\"line\">\t\t\t\tatomic.AddInt32(&amp;m.state, delta)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//重置迭代器和唤醒表示，继续获取锁</span></span><br><span class=\"line\">\t\t\tawoke = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\t\titer = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//CAS失败，则更新状态，继续获取。</span></span><br><span class=\"line\">\t\t\told = m.state</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(m))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"解锁过程\"><a class=\"header-anchor\" href=\"#解锁过程\">¶</a>解锁过程</h3>\n<p>用一个流程图来表示解锁过程：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/mutex-unlock.png\" alt=\"\"></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *Mutex)</span> <span class=\"title\">Unlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//state 不是处于锁的状态, 那么就是 Unlock 根本没有加锁的 mutex, panic</span></span><br><span class=\"line\">    <span class=\"built_in\">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">new</span>+mutexLocked)&amp;mutexLocked == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        throw(<span class=\"string\">&quot;sync: unlock of unlocked mutex&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 释放锁，并通知其它等待者</span></span><br><span class=\"line\">    <span class=\"comment\">// 锁如果处于饥饿状态，直接交给等待队列的第一个, 唤醒它，让它去获取锁</span></span><br><span class=\"line\">    <span class=\"comment\">// mutex 正常模式</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">new</span>&amp;mutexStarving == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        old := <span class=\"built_in\">new</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果没有等待者，或者已经存在一个 goroutine 被唤醒或得到锁、或处于饥饿模式</span></span><br><span class=\"line\">            <span class=\"comment\">// 直接返回.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> old&gt;&gt;mutexWaiterShift == <span class=\"number\">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 将等待的 goroutine-1，并设置 woken 标识</span></span><br><span class=\"line\">            <span class=\"built_in\">new</span> = (old - <span class=\"number\">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</span><br><span class=\"line\">            <span class=\"comment\">// 设置新的 state, 这里通过信号量会唤醒一个阻塞的 goroutine 去获取锁.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class=\"built_in\">new</span>) &#123;</span><br><span class=\"line\">                runtime_Semrelease(&amp;m.sema, <span class=\"literal\">false</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            old = m.state</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// mutex 饥饿模式，直接将 mutex 拥有权移交给等待队列最前端的 goroutine</span></span><br><span class=\"line\">        <span class=\"comment\">// 注意此时 state 的 mutex 还没有加锁，唤醒的 goroutine 会设置它。</span></span><br><span class=\"line\">        <span class=\"comment\">// 在此期间，如果有新的 goroutine 来请求锁， 因为 mutex 处于饥饿状态， mutex 还是被认为处于锁状态，</span></span><br><span class=\"line\">        <span class=\"comment\">// 新来的 goroutine 不会把锁抢过去.</span></span><br><span class=\"line\">        runtime_Semrelease(&amp;m.sema, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"关键点\"><a class=\"header-anchor\" href=\"#关键点\">¶</a>关键点</h3>\n<ul>\n<li>不要重复锁定互斥锁</li>\n<li>不要忘记解锁互斥锁</li>\n<li>不要在多个函数之间直接传递互斥锁</li>\n</ul>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<p>上次说到rwmutex读写锁，其实就是加强了锁的粒度，区分读和写时不同的情况，核心思想：写优先于读。<br>\n这次来看看mutex，go中的锁是如何实现的，用一张图来概括整个流程：</p>","more":"<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/mutex.png\" alt=\"\"></p>\n<blockquote>\n<p>核心思想：饥饿和队列，正常流程都是加入到队列尾部，如果超过一定的时间限制则加入到队列头部。</p>\n</blockquote>\n<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<blockquote>\n<p>开始看代码或者分析之前，先看下文档说明及其相关的资料。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">◯  go version</span><br><span class=\"line\">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"src-sync-mutex-go\"><a class=\"header-anchor\" href=\"#src-sync-mutex-go\">¶</a>src/sync/mutex.go</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tmutexLocked = <span class=\"number\">1</span> &lt;&lt; <span class=\"literal\">iota</span> <span class=\"comment\">// mutex is locked      state &amp; mutexLocked 1==加锁  0==未加锁</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tmutexWoken                                      <span class=\"comment\">//state &amp; mutexWoken 1==唤醒  0==未唤醒</span></span><br><span class=\"line\">\tmutexStarving                                   <span class=\"comment\">// state &amp; mutexStarving 1==饥饿状态   0==正常状态</span></span><br><span class=\"line\">\tmutexWaiterShift = <span class=\"literal\">iota</span>                         <span class=\"comment\">// state &gt;&gt; mutexWaiterShift得到当前的goroutine数量</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Mutex fairness.</span></span><br><span class=\"line\">\t<span class=\"comment\">// 两种模式：正常或饥饿</span></span><br><span class=\"line\">    <span class=\"comment\">// Mutex can be in 2 modes of operations: normal and starvation.</span></span><br><span class=\"line\">    <span class=\"comment\">//  正常模式就是FIFO队列。</span></span><br><span class=\"line\">\t<span class=\"comment\">// In normal mode waiters are queued in FIFO order, but a woken up waiter</span></span><br><span class=\"line\">\t<span class=\"comment\">// does not own the mutex and competes with new arriving goroutines over</span></span><br><span class=\"line\">\t<span class=\"comment\">// the ownership. New arriving goroutines have an advantage -- they are</span></span><br><span class=\"line\">\t<span class=\"comment\">// already running on CPU and there can be lots of them, so a woken up</span></span><br><span class=\"line\">\t<span class=\"comment\">// waiter has good chances of losing. In such case it is queued at front</span></span><br><span class=\"line\">\t<span class=\"comment\">// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,  //获取锁的时间超过1ms，切换到饥饿模式</span></span><br><span class=\"line\">\t<span class=\"comment\">// it switches mutex to the starvation mode.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// In starvation mode ownership of the mutex is directly handed off from        //饥饿模式下锁的所有权直接从解锁goroutine的waiter手中移交到队列的前面。</span></span><br><span class=\"line\">\t<span class=\"comment\">// the unlocking goroutine to the waiter at the front of the queue.</span></span><br><span class=\"line\">\t<span class=\"comment\">// New arriving goroutines don&#x27;t try to acquire the mutex even if it appears</span></span><br><span class=\"line\">\t<span class=\"comment\">// to be unlocked, and don&#x27;t try to spin. Instead they queue themselves at</span></span><br><span class=\"line\">\t<span class=\"comment\">// the tail of the wait queue.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// If a waiter receives ownership of the mutex and sees that either         //如果一个锁的所有权的等待者是以下两种情况之一的：1、处于队列的最后一个2、等待时间少于1ms，则切换到正常模式</span></span><br><span class=\"line\">\t<span class=\"comment\">// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,</span></span><br><span class=\"line\">\t<span class=\"comment\">// it switches mutex back to normal operation mode.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// Normal mode has considerably better performance as a goroutine can acquire</span></span><br><span class=\"line\">\t<span class=\"comment\">// a mutex several times in a row even if there are blocked waiters.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Starvation mode is important to prevent pathological cases of tail latency.</span></span><br><span class=\"line\">\tstarvationThresholdNs = <span class=\"number\">1e6</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<h3 id=\"加锁流程\"><a class=\"header-anchor\" href=\"#加锁流程\">¶</a>加锁流程</h3>\n<blockquote>\n<p>加锁过程图如上图提到的流程。</p>\n</blockquote>\n<blockquote>\n<p>加锁代码具体流程：</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *Mutex)</span> <span class=\"title\">Lock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Fast path: grab unlocked mutex.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class=\"number\">0</span>, mutexLocked) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t\trace.Acquire(unsafe.Pointer(m))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Slow path (outlined so that the fast path can be inlined)</span></span><br><span class=\"line\">\tm.lockSlow()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *Mutex)</span> <span class=\"title\">lockSlow</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> waitStartTime <span class=\"keyword\">int64</span> <span class=\"comment\">//等待时间</span></span><br><span class=\"line\">\tstarving := <span class=\"literal\">false</span>       <span class=\"comment\">//是否处于饥饿状态</span></span><br><span class=\"line\">\tawoke := <span class=\"literal\">false</span>          <span class=\"comment\">//唤醒状态</span></span><br><span class=\"line\">\titer := <span class=\"number\">0</span>               <span class=\"comment\">//自旋次数</span></span><br><span class=\"line\">\told := m.state          <span class=\"comment\">//当前状态copy</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Don&#x27;t spin in starvation mode, ownership is handed off to waiters</span></span><br><span class=\"line\">        <span class=\"comment\">// so we won&#x27;t be able to acquire the mutex anyway.</span></span><br><span class=\"line\">        <span class=\"comment\">//加锁且能够自旋</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Active spinning makes sense.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Try to set mutexWoken flag to inform Unlock</span></span><br><span class=\"line\">            <span class=\"comment\">// to not wake other blocked goroutines.</span></span><br><span class=\"line\">            <span class=\"comment\">//自旋过程发现没有被置woken标识，设置标识，将自己置为唤醒</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class=\"number\">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">\t\t\t\tatomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</span><br><span class=\"line\">\t\t\t\tawoke = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\truntime_doSpin()    <span class=\"comment\">//自旋</span></span><br><span class=\"line\">\t\t\titer++              </span><br><span class=\"line\">\t\t\told = m.state       <span class=\"comment\">//状态重置</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//更新状态</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">new</span> := old</span><br><span class=\"line\">        <span class=\"comment\">// Don&#x27;t try to acquire starving mutex, new arriving goroutines must queue.</span></span><br><span class=\"line\">        <span class=\"comment\">//非饥饿模式，则置锁</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> old&amp;mutexStarving == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> |= mutexLocked</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 处于饥饿模式下，新来的goroutine进入队列中</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexStarving) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> += <span class=\"number\">1</span> &lt;&lt; mutexWaiterShift</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The current goroutine switches mutex to starvation mode.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// But if the mutex is currently unlocked, don&#x27;t do the switch.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// Unlock expects that starving mutex has waiters, which will not</span></span><br><span class=\"line\">        <span class=\"comment\">// be true in this case.</span></span><br><span class=\"line\">        <span class=\"comment\">//切换到饥饿模式下</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> |= mutexStarving</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//当前处于唤醒状态，则重置清除唤醒状态。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> awoke &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// The goroutine has been woken from sleep,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// so we need to reset the flag in either case.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"built_in\">new</span>&amp;mutexWoken == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\tthrow(<span class=\"string\">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">new</span> &amp;^= mutexWoken</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//CAS更新状态。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class=\"built_in\">new</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//获取到锁</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexStarving) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span> <span class=\"comment\">// locked the mutex with CAS</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">            <span class=\"comment\">// If we were already waiting before, queue at the front of the queue.</span></span><br><span class=\"line\">            <span class=\"comment\">//等待队列的时间</span></span><br><span class=\"line\">\t\t\tqueueLifo := waitStartTime != <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> waitStartTime == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\twaitStartTime = runtime_nanotime()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//acquire阻塞队列....</span></span><br><span class=\"line\">            <span class=\"comment\">// 新来的 goroutine, queueLifo=false, 加入到等待队列的尾部，耐心等待</span></span><br><span class=\"line\">            <span class=\"comment\">// 唤醒的 goroutine, queueLifo=true, 加入到等待队列的头部</span></span><br><span class=\"line\">\t\t\truntime_SemacquireMutex(&amp;m.sema, queueLifo, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\tstarving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</span><br><span class=\"line\">            old = m.state</span><br><span class=\"line\">            <span class=\"comment\">//处于饥饿模式</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> old&amp;mutexStarving != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// If this goroutine was woken and mutex is in starvation mode,</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// ownership was handed off to us but mutex is in somewhat</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// inconsistent state: mutexLocked is not set and we are still</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// accounted as waiter. Fix that.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> old&amp;(mutexLocked|mutexWoken) != <span class=\"number\">0</span> || old&gt;&gt;mutexWaiterShift == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t\tthrow(<span class=\"string\">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//等待的goroutine-1</span></span><br><span class=\"line\">                delta := <span class=\"keyword\">int32</span>(mutexLocked - <span class=\"number\">1</span>&lt;&lt;mutexWaiterShift)</span><br><span class=\"line\">                <span class=\"comment\">// 处于队列中最后一个或者请求锁的时间未超过starvationThresholdNs，则回退到正常模式。</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Exit starvation mode.</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Critical to do it here and consider wait time.</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Starvation mode is so inefficient, that two goroutines</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// can go lock-step infinitely once they switch mutex</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// to starvation mode.</span></span><br><span class=\"line\">\t\t\t\t\tdelta -= mutexStarving</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"comment\">//更新状态</span></span><br><span class=\"line\">\t\t\t\tatomic.AddInt32(&amp;m.state, delta)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//重置迭代器和唤醒表示，继续获取锁</span></span><br><span class=\"line\">\t\t\tawoke = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\t\titer = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//CAS失败，则更新状态，继续获取。</span></span><br><span class=\"line\">\t\t\told = m.state</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(m))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"解锁过程\"><a class=\"header-anchor\" href=\"#解锁过程\">¶</a>解锁过程</h3>\n<p>用一个流程图来表示解锁过程：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/mutex-unlock.png\" alt=\"\"></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *Mutex)</span> <span class=\"title\">Unlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//state 不是处于锁的状态, 那么就是 Unlock 根本没有加锁的 mutex, panic</span></span><br><span class=\"line\">    <span class=\"built_in\">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">new</span>+mutexLocked)&amp;mutexLocked == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        throw(<span class=\"string\">&quot;sync: unlock of unlocked mutex&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 释放锁，并通知其它等待者</span></span><br><span class=\"line\">    <span class=\"comment\">// 锁如果处于饥饿状态，直接交给等待队列的第一个, 唤醒它，让它去获取锁</span></span><br><span class=\"line\">    <span class=\"comment\">// mutex 正常模式</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">new</span>&amp;mutexStarving == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        old := <span class=\"built_in\">new</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 如果没有等待者，或者已经存在一个 goroutine 被唤醒或得到锁、或处于饥饿模式</span></span><br><span class=\"line\">            <span class=\"comment\">// 直接返回.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> old&gt;&gt;mutexWaiterShift == <span class=\"number\">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 将等待的 goroutine-1，并设置 woken 标识</span></span><br><span class=\"line\">            <span class=\"built_in\">new</span> = (old - <span class=\"number\">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</span><br><span class=\"line\">            <span class=\"comment\">// 设置新的 state, 这里通过信号量会唤醒一个阻塞的 goroutine 去获取锁.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class=\"built_in\">new</span>) &#123;</span><br><span class=\"line\">                runtime_Semrelease(&amp;m.sema, <span class=\"literal\">false</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            old = m.state</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// mutex 饥饿模式，直接将 mutex 拥有权移交给等待队列最前端的 goroutine</span></span><br><span class=\"line\">        <span class=\"comment\">// 注意此时 state 的 mutex 还没有加锁，唤醒的 goroutine 会设置它。</span></span><br><span class=\"line\">        <span class=\"comment\">// 在此期间，如果有新的 goroutine 来请求锁， 因为 mutex 处于饥饿状态， mutex 还是被认为处于锁状态，</span></span><br><span class=\"line\">        <span class=\"comment\">// 新来的 goroutine 不会把锁抢过去.</span></span><br><span class=\"line\">        runtime_Semrelease(&amp;m.sema, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"关键点\"><a class=\"header-anchor\" href=\"#关键点\">¶</a>关键点</h3>\n<ul>\n<li>不要重复锁定互斥锁</li>\n<li>不要忘记解锁互斥锁</li>\n<li>不要在多个函数之间直接传递互斥锁</li>\n</ul>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/mutex.png","popularPost_tmp_gaData":{"updated":"Tue Sep 22 2020 13:20:32 GMT+0800 (中国标准时间)","title":"「10」go mutex解读","path":"archives/ff0d6c2b.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/mutex.png","excerpt":"<p>上次说到rwmutex读写锁，其实就是加强了锁的粒度，区分读和写时不同的情况，核心思想：写优先于读。<br>\n这次来看看mutex，go中的锁是如何实现的，用一张图来概括整个流程：</p>","date":{"_isAMomentObject":true,"_i":"2020-09-21T15:06:32.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-21T15:06:32.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Go源码","Go Package","锁"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":6287},{"title":"「12」go 指针和引用","date":"2020-09-23T13:13:51.000Z","updated":"2020-09-23T14:21:52.000Z","keywords":"golang,go,chan,map,指针,引用,interface,slice","abbrlink":"1191d613","_content":"\n\n今写代码时，传函数无意间想到一个问题，slice通过参数传递给函数，为何可以改变具体的值呢？\n\n如何解决这个问题？\n\n* 官方查文档\n* 看源码\n* google看看有没有好的见解\n* 思考🤔+冥想🧘‍♂️\n\n（ps:解决问题，主要不是看结果是怎么样的，主要是考虑问题的角度）\n<!--more-->\n\n### 查资料\n[官网指南之Slice](https://golang.google.cn/doc/effective_go.html#slices)\n有一段是这么描述：\n*Slices hold references to an underlying array, and if you assign one slice to another, both refer to the same array.*\n\n### 查源码\n\n#### /src/runtime/slice.go\n```go\ntype slice struct {\n\tarray unsafe.Pointer  //指针类型哦\n\tlen   int\n\tcap   int\n}\n```\n\n### 思考\n\n>原来下层是用过array这个指针，指向具体的数据的\n\n>那么其他的引用类型呢？\n\n```\nMap?\nchan?\ninterface?\n//Slice?\n```\n\n### 引用类型之Map\n\n#### 看源码 /src/runtime/map.go：\n```go\n\n// A header for a Go map.\ntype hmap struct {\n\t// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.\n\t// Make sure this stays in sync with the compiler's definition.\n\tcount     int // # live cells == size of map.  Must be first (used by len() builtin)\n\tflags     uint8\n\tB         uint8  // log_2 of # of buckets (can hold up to loadFactor * 2^B items)\n\tnoverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details\n\thash0     uint32 // hash seed\n\n    //通过此指针类型\n\tbuckets    unsafe.Pointer // array of 2^B Buckets. may be nil if count==0.\n\toldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing\n\tnevacuate  uintptr        // progress counter for evacuation (buckets less than this have been evacuated)\n\n\textra *mapextra // optional fields\n}\n```\n\n### 引用类型之Chan\n#### 源码:/src/runtime/chan.go\n\n```go\ntype hchan struct {\n\tqcount   uint           // total data in the queue\n    dataqsiz uint           // size of the circular queue\n    //通过此指针类型来处理\n\tbuf      unsafe.Pointer // points to an array of dataqsiz elements\n\telemsize uint16\n\tclosed   uint32\n\telemtype *_type // element type\n\tsendx    uint   // send index\n\trecvx    uint   // receive index\n\trecvq    waitq  // list of recv waiters\n\tsendq    waitq  // list of send waiters\n\n\t// lock protects all fields in hchan, as well as several\n\t// fields in sudogs blocked on this channel.\n\t//\n\t// Do not change another G's status while holding this lock\n\t// (in particular, do not ready a G), as this can deadlock\n\t// with stack shrinking.\n\tlock mutex\n}\n```\n\n### 引用类型之Interface\n\n#### 源码/src/runtime/runtime2.go\n```go\ntype iface struct {\n    tab  *itab\n    //指针类型\n\tdata unsafe.Pointer\n}\n\ntype eface struct {\n    _type *_type\n    //指针类型\n\tdata  unsafe.Pointer\n}\n```\n\n### 结论？通过指针？\n\n从上述源码看来，内部结构中都是用指针类型来指向具体的值，\n>So：形同这类的结构，肯定是引用类型的，具体是指针指向别的地址，从而来引用值。\n\n其实这个特性很早就晓得了，只是今天又看到了，觉得还是记录着吧，也许后续哪一天就有了创新的灵感来着~~.\n\n[睡觉了～最近有点乏～ZZzzz...]\n### END","source":"_posts/12-go-指针和引用.md","raw":"---\ntitle: 「12」go 指针和引用\ndate: '2020/09/23 21:13:51'\nupdated: '2020/09/23 22:21:52'\nkeywords: 'golang,go,chan,map,指针,引用,interface,slice'\ntags:\n  - Go\n  - Go Package\n  - Day\nabbrlink: 1191d613\n---\n\n\n今写代码时，传函数无意间想到一个问题，slice通过参数传递给函数，为何可以改变具体的值呢？\n\n如何解决这个问题？\n\n* 官方查文档\n* 看源码\n* google看看有没有好的见解\n* 思考🤔+冥想🧘‍♂️\n\n（ps:解决问题，主要不是看结果是怎么样的，主要是考虑问题的角度）\n<!--more-->\n\n### 查资料\n[官网指南之Slice](https://golang.google.cn/doc/effective_go.html#slices)\n有一段是这么描述：\n*Slices hold references to an underlying array, and if you assign one slice to another, both refer to the same array.*\n\n### 查源码\n\n#### /src/runtime/slice.go\n```go\ntype slice struct {\n\tarray unsafe.Pointer  //指针类型哦\n\tlen   int\n\tcap   int\n}\n```\n\n### 思考\n\n>原来下层是用过array这个指针，指向具体的数据的\n\n>那么其他的引用类型呢？\n\n```\nMap?\nchan?\ninterface?\n//Slice?\n```\n\n### 引用类型之Map\n\n#### 看源码 /src/runtime/map.go：\n```go\n\n// A header for a Go map.\ntype hmap struct {\n\t// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.\n\t// Make sure this stays in sync with the compiler's definition.\n\tcount     int // # live cells == size of map.  Must be first (used by len() builtin)\n\tflags     uint8\n\tB         uint8  // log_2 of # of buckets (can hold up to loadFactor * 2^B items)\n\tnoverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details\n\thash0     uint32 // hash seed\n\n    //通过此指针类型\n\tbuckets    unsafe.Pointer // array of 2^B Buckets. may be nil if count==0.\n\toldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing\n\tnevacuate  uintptr        // progress counter for evacuation (buckets less than this have been evacuated)\n\n\textra *mapextra // optional fields\n}\n```\n\n### 引用类型之Chan\n#### 源码:/src/runtime/chan.go\n\n```go\ntype hchan struct {\n\tqcount   uint           // total data in the queue\n    dataqsiz uint           // size of the circular queue\n    //通过此指针类型来处理\n\tbuf      unsafe.Pointer // points to an array of dataqsiz elements\n\telemsize uint16\n\tclosed   uint32\n\telemtype *_type // element type\n\tsendx    uint   // send index\n\trecvx    uint   // receive index\n\trecvq    waitq  // list of recv waiters\n\tsendq    waitq  // list of send waiters\n\n\t// lock protects all fields in hchan, as well as several\n\t// fields in sudogs blocked on this channel.\n\t//\n\t// Do not change another G's status while holding this lock\n\t// (in particular, do not ready a G), as this can deadlock\n\t// with stack shrinking.\n\tlock mutex\n}\n```\n\n### 引用类型之Interface\n\n#### 源码/src/runtime/runtime2.go\n```go\ntype iface struct {\n    tab  *itab\n    //指针类型\n\tdata unsafe.Pointer\n}\n\ntype eface struct {\n    _type *_type\n    //指针类型\n\tdata  unsafe.Pointer\n}\n```\n\n### 结论？通过指针？\n\n从上述源码看来，内部结构中都是用指针类型来指向具体的值，\n>So：形同这类的结构，肯定是引用类型的，具体是指针指向别的地址，从而来引用值。\n\n其实这个特性很早就晓得了，只是今天又看到了，觉得还是记录着吧，也许后续哪一天就有了创新的灵感来着~~.\n\n[睡觉了～最近有点乏～ZZzzz...]\n### END","slug":"12-go-指针和引用","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdkz000h3ci70lto3wbt","content":"<p>今写代码时，传函数无意间想到一个问题，slice通过参数传递给函数，为何可以改变具体的值呢？</p>\n<p>如何解决这个问题？</p>\n<ul>\n<li>官方查文档</li>\n<li>看源码</li>\n<li>google看看有没有好的见解</li>\n<li>思考🤔+冥想🧘‍♂️</li>\n</ul>\n<p>（ps:解决问题，主要不是看结果是怎么样的，主要是考虑问题的角度）</p>\n<a id=\"more\"></a>\n<h3 id=\"查资料\"><a class=\"header-anchor\" href=\"#查资料\">¶</a>查资料</h3>\n<p><a href=\"https://golang.google.cn/doc/effective_go.html#slices\">官网指南之Slice</a><br>\n有一段是这么描述：<br>\n<em>Slices hold references to an underlying array, and if you assign one slice to another, both refer to the same array.</em></p>\n<h3 id=\"查源码\"><a class=\"header-anchor\" href=\"#查源码\">¶</a>查源码</h3>\n<h4 id=\"src-runtime-slice-go\"><a class=\"header-anchor\" href=\"#src-runtime-slice-go\">¶</a>/src/runtime/slice.go</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> slice <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tarray unsafe.Pointer  <span class=\"comment\">//指针类型哦</span></span><br><span class=\"line\">\t<span class=\"built_in\">len</span>   <span class=\"keyword\">int</span></span><br><span class=\"line\">\t<span class=\"built_in\">cap</span>   <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"思考\"><a class=\"header-anchor\" href=\"#思考\">¶</a>思考</h3>\n<blockquote>\n<p>原来下层是用过array这个指针，指向具体的数据的</p>\n</blockquote>\n<blockquote>\n<p>那么其他的引用类型呢？</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Map?</span><br><span class=\"line\">chan?</span><br><span class=\"line\">interface?</span><br><span class=\"line\">&#x2F;&#x2F;Slice?</span><br></pre></td></tr></table></figure>\n<h3 id=\"引用类型之Map\"><a class=\"header-anchor\" href=\"#引用类型之Map\">¶</a>引用类型之Map</h3>\n<h4 id=\"看源码-src-runtime-map-go：\"><a class=\"header-anchor\" href=\"#看源码-src-runtime-map-go：\">¶</a>看源码 /src/runtime/map.go：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// A header for a Go map.</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> hmap <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Make sure this stays in sync with the compiler&#x27;s definition.</span></span><br><span class=\"line\">\tcount     <span class=\"keyword\">int</span> <span class=\"comment\">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class=\"line\">\tflags     <span class=\"keyword\">uint8</span></span><br><span class=\"line\">\tB         <span class=\"keyword\">uint8</span>  <span class=\"comment\">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class=\"line\">\tnoverflow <span class=\"keyword\">uint16</span> <span class=\"comment\">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class=\"line\">\thash0     <span class=\"keyword\">uint32</span> <span class=\"comment\">// hash seed</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//通过此指针类型</span></span><br><span class=\"line\">\tbuckets    unsafe.Pointer <span class=\"comment\">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class=\"line\">\toldbuckets unsafe.Pointer <span class=\"comment\">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class=\"line\">\tnevacuate  <span class=\"keyword\">uintptr</span>        <span class=\"comment\">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class=\"line\"></span><br><span class=\"line\">\textra *mapextra <span class=\"comment\">// optional fields</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"引用类型之Chan\"><a class=\"header-anchor\" href=\"#引用类型之Chan\">¶</a>引用类型之Chan</h3>\n<h4 id=\"源码-src-runtime-chan-go\"><a class=\"header-anchor\" href=\"#源码-src-runtime-chan-go\">¶</a>源码:/src/runtime/chan.go</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> hchan <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tqcount   <span class=\"keyword\">uint</span>           <span class=\"comment\">// total data in the queue</span></span><br><span class=\"line\">    dataqsiz <span class=\"keyword\">uint</span>           <span class=\"comment\">// size of the circular queue</span></span><br><span class=\"line\">    <span class=\"comment\">//通过此指针类型来处理</span></span><br><span class=\"line\">\tbuf      unsafe.Pointer <span class=\"comment\">// points to an array of dataqsiz elements</span></span><br><span class=\"line\">\telemsize <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tclosed   <span class=\"keyword\">uint32</span></span><br><span class=\"line\">\telemtype *_type <span class=\"comment\">// element type</span></span><br><span class=\"line\">\tsendx    <span class=\"keyword\">uint</span>   <span class=\"comment\">// send index</span></span><br><span class=\"line\">\trecvx    <span class=\"keyword\">uint</span>   <span class=\"comment\">// receive index</span></span><br><span class=\"line\">\trecvq    waitq  <span class=\"comment\">// list of recv waiters</span></span><br><span class=\"line\">\tsendq    waitq  <span class=\"comment\">// list of send waiters</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// lock protects all fields in hchan, as well as several</span></span><br><span class=\"line\">\t<span class=\"comment\">// fields in sudogs blocked on this channel.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// Do not change another G&#x27;s status while holding this lock</span></span><br><span class=\"line\">\t<span class=\"comment\">// (in particular, do not ready a G), as this can deadlock</span></span><br><span class=\"line\">\t<span class=\"comment\">// with stack shrinking.</span></span><br><span class=\"line\">\tlock mutex</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"引用类型之Interface\"><a class=\"header-anchor\" href=\"#引用类型之Interface\">¶</a>引用类型之Interface</h3>\n<h4 id=\"源码-src-runtime-runtime2-go\"><a class=\"header-anchor\" href=\"#源码-src-runtime-runtime2-go\">¶</a>源码/src/runtime/runtime2.go</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> iface <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    tab  *itab</span><br><span class=\"line\">    <span class=\"comment\">//指针类型</span></span><br><span class=\"line\">\tdata unsafe.Pointer</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> eface <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    _type *_type</span><br><span class=\"line\">    <span class=\"comment\">//指针类型</span></span><br><span class=\"line\">\tdata  unsafe.Pointer</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"结论？通过指针？\"><a class=\"header-anchor\" href=\"#结论？通过指针？\">¶</a>结论？通过指针？</h3>\n<p>从上述源码看来，内部结构中都是用指针类型来指向具体的值，</p>\n<blockquote>\n<p>So：形同这类的结构，肯定是引用类型的，具体是指针指向别的地址，从而来引用值。</p>\n</blockquote>\n<p>其实这个特性很早就晓得了，只是今天又看到了，觉得还是记录着吧，也许后续哪一天就有了创新的灵感来着~~.</p>\n<p>[睡觉了～最近有点乏～ZZzzz…]</p>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<p>今写代码时，传函数无意间想到一个问题，slice通过参数传递给函数，为何可以改变具体的值呢？</p>\n<p>如何解决这个问题？</p>\n<ul>\n<li>官方查文档</li>\n<li>看源码</li>\n<li>google看看有没有好的见解</li>\n<li>思考🤔+冥想🧘‍♂️</li>\n</ul>\n<p>（ps:解决问题，主要不是看结果是怎么样的，主要是考虑问题的角度）</p>","more":"<h3 id=\"查资料\"><a class=\"header-anchor\" href=\"#查资料\">¶</a>查资料</h3>\n<p><a href=\"https://golang.google.cn/doc/effective_go.html#slices\">官网指南之Slice</a><br>\n有一段是这么描述：<br>\n<em>Slices hold references to an underlying array, and if you assign one slice to another, both refer to the same array.</em></p>\n<h3 id=\"查源码\"><a class=\"header-anchor\" href=\"#查源码\">¶</a>查源码</h3>\n<h4 id=\"src-runtime-slice-go\"><a class=\"header-anchor\" href=\"#src-runtime-slice-go\">¶</a>/src/runtime/slice.go</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> slice <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tarray unsafe.Pointer  <span class=\"comment\">//指针类型哦</span></span><br><span class=\"line\">\t<span class=\"built_in\">len</span>   <span class=\"keyword\">int</span></span><br><span class=\"line\">\t<span class=\"built_in\">cap</span>   <span class=\"keyword\">int</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"思考\"><a class=\"header-anchor\" href=\"#思考\">¶</a>思考</h3>\n<blockquote>\n<p>原来下层是用过array这个指针，指向具体的数据的</p>\n</blockquote>\n<blockquote>\n<p>那么其他的引用类型呢？</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Map?</span><br><span class=\"line\">chan?</span><br><span class=\"line\">interface?</span><br><span class=\"line\">&#x2F;&#x2F;Slice?</span><br></pre></td></tr></table></figure>\n<h3 id=\"引用类型之Map\"><a class=\"header-anchor\" href=\"#引用类型之Map\">¶</a>引用类型之Map</h3>\n<h4 id=\"看源码-src-runtime-map-go：\"><a class=\"header-anchor\" href=\"#看源码-src-runtime-map-go：\">¶</a>看源码 /src/runtime/map.go：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// A header for a Go map.</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> hmap <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Make sure this stays in sync with the compiler&#x27;s definition.</span></span><br><span class=\"line\">\tcount     <span class=\"keyword\">int</span> <span class=\"comment\">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class=\"line\">\tflags     <span class=\"keyword\">uint8</span></span><br><span class=\"line\">\tB         <span class=\"keyword\">uint8</span>  <span class=\"comment\">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class=\"line\">\tnoverflow <span class=\"keyword\">uint16</span> <span class=\"comment\">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class=\"line\">\thash0     <span class=\"keyword\">uint32</span> <span class=\"comment\">// hash seed</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//通过此指针类型</span></span><br><span class=\"line\">\tbuckets    unsafe.Pointer <span class=\"comment\">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class=\"line\">\toldbuckets unsafe.Pointer <span class=\"comment\">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class=\"line\">\tnevacuate  <span class=\"keyword\">uintptr</span>        <span class=\"comment\">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class=\"line\"></span><br><span class=\"line\">\textra *mapextra <span class=\"comment\">// optional fields</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"引用类型之Chan\"><a class=\"header-anchor\" href=\"#引用类型之Chan\">¶</a>引用类型之Chan</h3>\n<h4 id=\"源码-src-runtime-chan-go\"><a class=\"header-anchor\" href=\"#源码-src-runtime-chan-go\">¶</a>源码:/src/runtime/chan.go</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> hchan <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tqcount   <span class=\"keyword\">uint</span>           <span class=\"comment\">// total data in the queue</span></span><br><span class=\"line\">    dataqsiz <span class=\"keyword\">uint</span>           <span class=\"comment\">// size of the circular queue</span></span><br><span class=\"line\">    <span class=\"comment\">//通过此指针类型来处理</span></span><br><span class=\"line\">\tbuf      unsafe.Pointer <span class=\"comment\">// points to an array of dataqsiz elements</span></span><br><span class=\"line\">\telemsize <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tclosed   <span class=\"keyword\">uint32</span></span><br><span class=\"line\">\telemtype *_type <span class=\"comment\">// element type</span></span><br><span class=\"line\">\tsendx    <span class=\"keyword\">uint</span>   <span class=\"comment\">// send index</span></span><br><span class=\"line\">\trecvx    <span class=\"keyword\">uint</span>   <span class=\"comment\">// receive index</span></span><br><span class=\"line\">\trecvq    waitq  <span class=\"comment\">// list of recv waiters</span></span><br><span class=\"line\">\tsendq    waitq  <span class=\"comment\">// list of send waiters</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// lock protects all fields in hchan, as well as several</span></span><br><span class=\"line\">\t<span class=\"comment\">// fields in sudogs blocked on this channel.</span></span><br><span class=\"line\">\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"comment\">// Do not change another G&#x27;s status while holding this lock</span></span><br><span class=\"line\">\t<span class=\"comment\">// (in particular, do not ready a G), as this can deadlock</span></span><br><span class=\"line\">\t<span class=\"comment\">// with stack shrinking.</span></span><br><span class=\"line\">\tlock mutex</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"引用类型之Interface\"><a class=\"header-anchor\" href=\"#引用类型之Interface\">¶</a>引用类型之Interface</h3>\n<h4 id=\"源码-src-runtime-runtime2-go\"><a class=\"header-anchor\" href=\"#源码-src-runtime-runtime2-go\">¶</a>源码/src/runtime/runtime2.go</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> iface <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    tab  *itab</span><br><span class=\"line\">    <span class=\"comment\">//指针类型</span></span><br><span class=\"line\">\tdata unsafe.Pointer</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> eface <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    _type *_type</span><br><span class=\"line\">    <span class=\"comment\">//指针类型</span></span><br><span class=\"line\">\tdata  unsafe.Pointer</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"结论？通过指针？\"><a class=\"header-anchor\" href=\"#结论？通过指针？\">¶</a>结论？通过指针？</h3>\n<p>从上述源码看来，内部结构中都是用指针类型来指向具体的值，</p>\n<blockquote>\n<p>So：形同这类的结构，肯定是引用类型的，具体是指针指向别的地址，从而来引用值。</p>\n</blockquote>\n<p>其实这个特性很早就晓得了，只是今天又看到了，觉得还是记录着吧，也许后续哪一天就有了创新的灵感来着~~.</p>\n<p>[睡觉了～最近有点乏～ZZzzz…]</p>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Wed Sep 23 2020 22:21:52 GMT+0800 (中国标准时间)","title":"「12」go 指针和引用","path":"archives/1191d613.html","eyeCatchImage":null,"excerpt":"<p>今写代码时，传函数无意间想到一个问题，slice通过参数传递给函数，为何可以改变具体的值呢？</p>\n<p>如何解决这个问题？</p>\n<ul>\n<li>官方查文档</li>\n<li>看源码</li>\n<li>google看看有没有好的见解</li>\n<li>思考🤔+冥想🧘‍♂️</li>\n</ul>\n<p>（ps:解决问题，主要不是看结果是怎么样的，主要是考虑问题的角度）</p>","date":{"_isAMomentObject":true,"_i":"2020-09-23T13:13:51.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-23T13:13:51.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Go Package","Day"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":2069},{"title":"「13」Linux 进程","date":"2020-09-24T11:09:49.000Z","updated":"2020-09-24T12:00:00.000Z","keywords":"Linux,Linux 进程","top":false,"sticky":4,"abbrlink":"ba455c1d","_content":"\n进程这是个老生常谈的问题，当然我不是那个老生，我只是个loser。\n\n今天用chrome，占用很多的内存和资源，查了查，说chrome是多进程的，于是就想了解下进程一些相关的内容。\n主要从以下几个角度了解下进程：\n* 来源\n* 定义\n* 特征\n* 多进程如何工作？\n* 通信\n\n<!--more-->\n\n### 来源\n\n抽象正在运行的程序，或者说是对计算机系统存储器的调度和管理。\n\n### 定义\n\n进程：并发程序在执行过程中资源分配和管理的最基本的单元（资源分配的最小单元，执行的最小单元）。一个程序一旦开始执行，就是一个进程。每一个进程都有自己的独立空间，系统会分配一定的地址空间和完整的数据段空间。\n\nps:[线程：程序执行的最小单位。]\n\n组成：程序、数据、控制块组成。\n\n### 特征\n\n* 动态性 ： 多个程序执行过程中的一次执行过程，进程是动态产生，动态销毁的。\n* 并发性 ： 任何进程可以和其它进程并发执行。\n* 独立性 ： 是独立运行的基本单元，也是资源分配和调度的独立单元。\n* 异步性 ： 由于进程间的相互制约，进程间是各自独立，各自向前。\n\n### 多进程工作：\n\n#### 进程的状态：\n>3种状态：\n* 就绪\n* 运行\n* 阻塞\n\n##### 3态图：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_3.1.png)\n\n##### 5态图：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux_p3.png)\n\n##### 7态图：\n\n新增两种状态：\n* 挂起就绪状态：表明进程具备了运行的条件，目前在二级存储器里面。\n* 挂起等待状态：表明进程正在等待某一个事件的结束且目前在二级存储器里面。\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_7.png)\n\n### 进程间通信\n\n#### 共享内存\n\n映射一段能被其它进程访问的内存，一个进程创建，其它进程可访问。共享内存是最快的IPC方式，往往和信号量一起使用，达到进程间的同步和互斥。\n\n#### 管道\n\n实质就是一个缓冲区。\n管道限制：\n\n* 半双工\n* 只能在亲缘进程间通信\n\n**特点:**\n```\n写满时，不能再写，读空时，不能再读\n没写满，不能读，没读空，不能写\n```\n\n#### 消息队列\n\n是一种消息的链表，解决了信号传递信息少，管道只能承载无格式字节流及管道大小限制的缺点。\n\n#### 信号\n\n通知和接受进程某个事件已经发生了的。\n\n#### 信号量\n\n实质上就是个计数器，用来控制多个进程对于共享资源的访问情况。\n\n#### 套接字（Socket）\n\n进程间通信的一种机制，多用于不同机器进程间的通信。\n\n#### 优缺点：\n\n```go\n1、管道：速度慢，容量有限，只有父子进程能通讯.\n2、FIFO：任何进程间都能通讯，但速度慢.\n3、消息队列：容量受到系统限制，且要注意第一次读的时候，要考虑上一次没有读完数据的问题.\n4、信号量：不能传递复杂消息，只能用来同步.\n5、共享内存区：能够很容易控制容量，速度快，但要保持同步，比如一个进程在写的时候，另一个进程要注意读写的问题，相当于线程中的线程安全，当然，共享内存区同样可以用作线程间通讯，不过没这个必要，线程间本来就已经共享了同一进程内的一块内存.\n```\n\n### END","source":"_posts/13-Linux-进程.md","raw":"---\ntitle: 「13」Linux 进程\ndate: '2020/09/24 19:09:49'\nupdated: '2020/09/24 20:00:00'\nkeywords: 'Linux,Linux 进程'\ntop: false\nsticky: 4\ntags:\n  - Linux\n  - 进程\nabbrlink: ba455c1d\n---\n\n进程这是个老生常谈的问题，当然我不是那个老生，我只是个loser。\n\n今天用chrome，占用很多的内存和资源，查了查，说chrome是多进程的，于是就想了解下进程一些相关的内容。\n主要从以下几个角度了解下进程：\n* 来源\n* 定义\n* 特征\n* 多进程如何工作？\n* 通信\n\n<!--more-->\n\n### 来源\n\n抽象正在运行的程序，或者说是对计算机系统存储器的调度和管理。\n\n### 定义\n\n进程：并发程序在执行过程中资源分配和管理的最基本的单元（资源分配的最小单元，执行的最小单元）。一个程序一旦开始执行，就是一个进程。每一个进程都有自己的独立空间，系统会分配一定的地址空间和完整的数据段空间。\n\nps:[线程：程序执行的最小单位。]\n\n组成：程序、数据、控制块组成。\n\n### 特征\n\n* 动态性 ： 多个程序执行过程中的一次执行过程，进程是动态产生，动态销毁的。\n* 并发性 ： 任何进程可以和其它进程并发执行。\n* 独立性 ： 是独立运行的基本单元，也是资源分配和调度的独立单元。\n* 异步性 ： 由于进程间的相互制约，进程间是各自独立，各自向前。\n\n### 多进程工作：\n\n#### 进程的状态：\n>3种状态：\n* 就绪\n* 运行\n* 阻塞\n\n##### 3态图：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_3.1.png)\n\n##### 5态图：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux_p3.png)\n\n##### 7态图：\n\n新增两种状态：\n* 挂起就绪状态：表明进程具备了运行的条件，目前在二级存储器里面。\n* 挂起等待状态：表明进程正在等待某一个事件的结束且目前在二级存储器里面。\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_7.png)\n\n### 进程间通信\n\n#### 共享内存\n\n映射一段能被其它进程访问的内存，一个进程创建，其它进程可访问。共享内存是最快的IPC方式，往往和信号量一起使用，达到进程间的同步和互斥。\n\n#### 管道\n\n实质就是一个缓冲区。\n管道限制：\n\n* 半双工\n* 只能在亲缘进程间通信\n\n**特点:**\n```\n写满时，不能再写，读空时，不能再读\n没写满，不能读，没读空，不能写\n```\n\n#### 消息队列\n\n是一种消息的链表，解决了信号传递信息少，管道只能承载无格式字节流及管道大小限制的缺点。\n\n#### 信号\n\n通知和接受进程某个事件已经发生了的。\n\n#### 信号量\n\n实质上就是个计数器，用来控制多个进程对于共享资源的访问情况。\n\n#### 套接字（Socket）\n\n进程间通信的一种机制，多用于不同机器进程间的通信。\n\n#### 优缺点：\n\n```go\n1、管道：速度慢，容量有限，只有父子进程能通讯.\n2、FIFO：任何进程间都能通讯，但速度慢.\n3、消息队列：容量受到系统限制，且要注意第一次读的时候，要考虑上一次没有读完数据的问题.\n4、信号量：不能传递复杂消息，只能用来同步.\n5、共享内存区：能够很容易控制容量，速度快，但要保持同步，比如一个进程在写的时候，另一个进程要注意读写的问题，相当于线程中的线程安全，当然，共享内存区同样可以用作线程间通讯，不过没这个必要，线程间本来就已经共享了同一进程内的一块内存.\n```\n\n### END","slug":"13-Linux-进程","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl0000k3ci757rj7a98","content":"<p>进程这是个老生常谈的问题，当然我不是那个老生，我只是个loser。</p>\n<p>今天用chrome，占用很多的内存和资源，查了查，说chrome是多进程的，于是就想了解下进程一些相关的内容。<br>\n主要从以下几个角度了解下进程：</p>\n<ul>\n<li>来源</li>\n<li>定义</li>\n<li>特征</li>\n<li>多进程如何工作？</li>\n<li>通信</li>\n</ul>\n<a id=\"more\"></a>\n<h3 id=\"来源\"><a class=\"header-anchor\" href=\"#来源\">¶</a>来源</h3>\n<p>抽象正在运行的程序，或者说是对计算机系统存储器的调度和管理。</p>\n<h3 id=\"定义\"><a class=\"header-anchor\" href=\"#定义\">¶</a>定义</h3>\n<p>进程：并发程序在执行过程中资源分配和管理的最基本的单元（资源分配的最小单元，执行的最小单元）。一个程序一旦开始执行，就是一个进程。每一个进程都有自己的独立空间，系统会分配一定的地址空间和完整的数据段空间。</p>\n<p>ps:[线程：程序执行的最小单位。]</p>\n<p>组成：程序、数据、控制块组成。</p>\n<h3 id=\"特征\"><a class=\"header-anchor\" href=\"#特征\">¶</a>特征</h3>\n<ul>\n<li>动态性 ： 多个程序执行过程中的一次执行过程，进程是动态产生，动态销毁的。</li>\n<li>并发性 ： 任何进程可以和其它进程并发执行。</li>\n<li>独立性 ： 是独立运行的基本单元，也是资源分配和调度的独立单元。</li>\n<li>异步性 ： 由于进程间的相互制约，进程间是各自独立，各自向前。</li>\n</ul>\n<h3 id=\"多进程工作：\"><a class=\"header-anchor\" href=\"#多进程工作：\">¶</a>多进程工作：</h3>\n<h4 id=\"进程的状态：\"><a class=\"header-anchor\" href=\"#进程的状态：\">¶</a>进程的状态：</h4>\n<blockquote>\n<p>3种状态：</p>\n</blockquote>\n<ul>\n<li>就绪</li>\n<li>运行</li>\n<li>阻塞</li>\n</ul>\n<h5 id=\"3态图：\"><a class=\"header-anchor\" href=\"#3态图：\">¶</a>3态图：</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_3.1.png\" alt=\"\"></p>\n<h5 id=\"5态图：\"><a class=\"header-anchor\" href=\"#5态图：\">¶</a>5态图：</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_p3.png\" alt=\"\"></p>\n<h5 id=\"7态图：\"><a class=\"header-anchor\" href=\"#7态图：\">¶</a>7态图：</h5>\n<p>新增两种状态：</p>\n<ul>\n<li>挂起就绪状态：表明进程具备了运行的条件，目前在二级存储器里面。</li>\n<li>挂起等待状态：表明进程正在等待某一个事件的结束且目前在二级存储器里面。</li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_7.png\" alt=\"\"></p>\n<h3 id=\"进程间通信\"><a class=\"header-anchor\" href=\"#进程间通信\">¶</a>进程间通信</h3>\n<h4 id=\"共享内存\"><a class=\"header-anchor\" href=\"#共享内存\">¶</a>共享内存</h4>\n<p>映射一段能被其它进程访问的内存，一个进程创建，其它进程可访问。共享内存是最快的IPC方式，往往和信号量一起使用，达到进程间的同步和互斥。</p>\n<h4 id=\"管道\"><a class=\"header-anchor\" href=\"#管道\">¶</a>管道</h4>\n<p>实质就是一个缓冲区。<br>\n管道限制：</p>\n<ul>\n<li>半双工</li>\n<li>只能在亲缘进程间通信</li>\n</ul>\n<p><strong>特点:</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">写满时，不能再写，读空时，不能再读</span><br><span class=\"line\">没写满，不能读，没读空，不能写</span><br></pre></td></tr></table></figure>\n<h4 id=\"消息队列\"><a class=\"header-anchor\" href=\"#消息队列\">¶</a>消息队列</h4>\n<p>是一种消息的链表，解决了信号传递信息少，管道只能承载无格式字节流及管道大小限制的缺点。</p>\n<h4 id=\"信号\"><a class=\"header-anchor\" href=\"#信号\">¶</a>信号</h4>\n<p>通知和接受进程某个事件已经发生了的。</p>\n<h4 id=\"信号量\"><a class=\"header-anchor\" href=\"#信号量\">¶</a>信号量</h4>\n<p>实质上就是个计数器，用来控制多个进程对于共享资源的访问情况。</p>\n<h4 id=\"套接字（Socket）\"><a class=\"header-anchor\" href=\"#套接字（Socket）\">¶</a>套接字（Socket）</h4>\n<p>进程间通信的一种机制，多用于不同机器进程间的通信。</p>\n<h4 id=\"优缺点：\"><a class=\"header-anchor\" href=\"#优缺点：\">¶</a>优缺点：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、管道：速度慢，容量有限，只有父子进程能通讯.</span><br><span class=\"line\"><span class=\"number\">2</span>、FIFO：任何进程间都能通讯，但速度慢.</span><br><span class=\"line\"><span class=\"number\">3</span>、消息队列：容量受到系统限制，且要注意第一次读的时候，要考虑上一次没有读完数据的问题.</span><br><span class=\"line\"><span class=\"number\">4</span>、信号量：不能传递复杂消息，只能用来同步.</span><br><span class=\"line\"><span class=\"number\">5</span>、共享内存区：能够很容易控制容量，速度快，但要保持同步，比如一个进程在写的时候，另一个进程要注意读写的问题，相当于线程中的线程安全，当然，共享内存区同样可以用作线程间通讯，不过没这个必要，线程间本来就已经共享了同一进程内的一块内存.</span><br></pre></td></tr></table></figure>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<p>进程这是个老生常谈的问题，当然我不是那个老生，我只是个loser。</p>\n<p>今天用chrome，占用很多的内存和资源，查了查，说chrome是多进程的，于是就想了解下进程一些相关的内容。<br>\n主要从以下几个角度了解下进程：</p>\n<ul>\n<li>来源</li>\n<li>定义</li>\n<li>特征</li>\n<li>多进程如何工作？</li>\n<li>通信</li>\n</ul>","more":"<h3 id=\"来源\"><a class=\"header-anchor\" href=\"#来源\">¶</a>来源</h3>\n<p>抽象正在运行的程序，或者说是对计算机系统存储器的调度和管理。</p>\n<h3 id=\"定义\"><a class=\"header-anchor\" href=\"#定义\">¶</a>定义</h3>\n<p>进程：并发程序在执行过程中资源分配和管理的最基本的单元（资源分配的最小单元，执行的最小单元）。一个程序一旦开始执行，就是一个进程。每一个进程都有自己的独立空间，系统会分配一定的地址空间和完整的数据段空间。</p>\n<p>ps:[线程：程序执行的最小单位。]</p>\n<p>组成：程序、数据、控制块组成。</p>\n<h3 id=\"特征\"><a class=\"header-anchor\" href=\"#特征\">¶</a>特征</h3>\n<ul>\n<li>动态性 ： 多个程序执行过程中的一次执行过程，进程是动态产生，动态销毁的。</li>\n<li>并发性 ： 任何进程可以和其它进程并发执行。</li>\n<li>独立性 ： 是独立运行的基本单元，也是资源分配和调度的独立单元。</li>\n<li>异步性 ： 由于进程间的相互制约，进程间是各自独立，各自向前。</li>\n</ul>\n<h3 id=\"多进程工作：\"><a class=\"header-anchor\" href=\"#多进程工作：\">¶</a>多进程工作：</h3>\n<h4 id=\"进程的状态：\"><a class=\"header-anchor\" href=\"#进程的状态：\">¶</a>进程的状态：</h4>\n<blockquote>\n<p>3种状态：</p>\n</blockquote>\n<ul>\n<li>就绪</li>\n<li>运行</li>\n<li>阻塞</li>\n</ul>\n<h5 id=\"3态图：\"><a class=\"header-anchor\" href=\"#3态图：\">¶</a>3态图：</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_3.1.png\" alt=\"\"></p>\n<h5 id=\"5态图：\"><a class=\"header-anchor\" href=\"#5态图：\">¶</a>5态图：</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_p3.png\" alt=\"\"></p>\n<h5 id=\"7态图：\"><a class=\"header-anchor\" href=\"#7态图：\">¶</a>7态图：</h5>\n<p>新增两种状态：</p>\n<ul>\n<li>挂起就绪状态：表明进程具备了运行的条件，目前在二级存储器里面。</li>\n<li>挂起等待状态：表明进程正在等待某一个事件的结束且目前在二级存储器里面。</li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_7.png\" alt=\"\"></p>\n<h3 id=\"进程间通信\"><a class=\"header-anchor\" href=\"#进程间通信\">¶</a>进程间通信</h3>\n<h4 id=\"共享内存\"><a class=\"header-anchor\" href=\"#共享内存\">¶</a>共享内存</h4>\n<p>映射一段能被其它进程访问的内存，一个进程创建，其它进程可访问。共享内存是最快的IPC方式，往往和信号量一起使用，达到进程间的同步和互斥。</p>\n<h4 id=\"管道\"><a class=\"header-anchor\" href=\"#管道\">¶</a>管道</h4>\n<p>实质就是一个缓冲区。<br>\n管道限制：</p>\n<ul>\n<li>半双工</li>\n<li>只能在亲缘进程间通信</li>\n</ul>\n<p><strong>特点:</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">写满时，不能再写，读空时，不能再读</span><br><span class=\"line\">没写满，不能读，没读空，不能写</span><br></pre></td></tr></table></figure>\n<h4 id=\"消息队列\"><a class=\"header-anchor\" href=\"#消息队列\">¶</a>消息队列</h4>\n<p>是一种消息的链表，解决了信号传递信息少，管道只能承载无格式字节流及管道大小限制的缺点。</p>\n<h4 id=\"信号\"><a class=\"header-anchor\" href=\"#信号\">¶</a>信号</h4>\n<p>通知和接受进程某个事件已经发生了的。</p>\n<h4 id=\"信号量\"><a class=\"header-anchor\" href=\"#信号量\">¶</a>信号量</h4>\n<p>实质上就是个计数器，用来控制多个进程对于共享资源的访问情况。</p>\n<h4 id=\"套接字（Socket）\"><a class=\"header-anchor\" href=\"#套接字（Socket）\">¶</a>套接字（Socket）</h4>\n<p>进程间通信的一种机制，多用于不同机器进程间的通信。</p>\n<h4 id=\"优缺点：\"><a class=\"header-anchor\" href=\"#优缺点：\">¶</a>优缺点：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、管道：速度慢，容量有限，只有父子进程能通讯.</span><br><span class=\"line\"><span class=\"number\">2</span>、FIFO：任何进程间都能通讯，但速度慢.</span><br><span class=\"line\"><span class=\"number\">3</span>、消息队列：容量受到系统限制，且要注意第一次读的时候，要考虑上一次没有读完数据的问题.</span><br><span class=\"line\"><span class=\"number\">4</span>、信号量：不能传递复杂消息，只能用来同步.</span><br><span class=\"line\"><span class=\"number\">5</span>、共享内存区：能够很容易控制容量，速度快，但要保持同步，比如一个进程在写的时候，另一个进程要注意读写的问题，相当于线程中的线程安全，当然，共享内存区同样可以用作线程间通讯，不过没这个必要，线程间本来就已经共享了同一进程内的一块内存.</span><br></pre></td></tr></table></figure>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_3.1.png","popularPost_tmp_gaData":{"updated":"Thu Sep 24 2020 20:00:00 GMT+0800 (中国标准时间)","title":"「13」Linux 进程","path":"archives/ba455c1d.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/linux_process_3.1.png","excerpt":"<p>进程这是个老生常谈的问题，当然我不是那个老生，我只是个loser。</p>\n<p>今天用chrome，占用很多的内存和资源，查了查，说chrome是多进程的，于是就想了解下进程一些相关的内容。<br>\n主要从以下几个角度了解下进程：</p>\n<ul>\n<li>来源</li>\n<li>定义</li>\n<li>特征</li>\n<li>多进程如何工作？</li>\n<li>通信</li>\n</ul>","date":{"_isAMomentObject":true,"_i":"2020-09-24T11:09:49.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-24T11:09:49.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Linux","进程"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":1050},{"title":"「15」Plan9 汇编小记","date":"2020-10-09T05:47:39.000Z","updated":"2020-10-09T05:47:39.000Z","keywords":"汇编,Go,Plan9","top":false,"sticky":3,"abbrlink":"2ce846ed","_content":"#### 前序\n>平常coding时，偶尔会查看计算机的具体执行过程，那最基本的就是汇编了，了解汇编是调试过程中必不可少的，尤其是一些细节的处理方面.Go的汇编是Plan 9(贝尔实验室的产物)，和汇编很类似。\n#### 如何得到汇编结果？\n\n* 官网文档\n* Google\n\n##### 3种方式：\n>第一种\n<!-- more -->\n```go\ngo tool compile -N -l -S ***.go\n```\n>第二种\n\n```go\n1、先编译：\n    go tool compile -N -l ***.go\n2、再反编译：\n    go tool objdump ***.o\n```\n\n>第三种\n\n```go\ngo build -gcflags -S ***.go\n```\n\n\n#### 常用寄存器\n##### AX BX CX DX BP SI SP IP\n\n|寄存器|16位|32位|64位|\n|:----|:----|:----|:----|\n|累加寄存器|AX|EAX|RAX|\n|基址寄存器|BX|EBX|RBX|\n|计数寄存器|CX|ECX|RCX|\n|数据寄存器|DX|EDX|RDX|\n|堆栈基指针|BP|EBP|RBP|\n|变址寄存器|SI|ESI|RSI|\n|堆栈顶指针|SP|ESP|RSP|\n|指令寄存器|IP|EIP|RIP|\n\n##### MOV\n\n>movb（8位）、movw（16位）、movl（32位）、movq（64位）\n\n```go\nMOVSS: 移动单精度浮点数\n```\n\n#### 查询地址\n\n[MOVSS](https://c9x.me/x86/html/file_module_x86_id_205.html)\n[Intel汇编指令查询](https://www.felixcloutier.com/x86/index.html)\n[Plan9查询](https://plan9.io/sources/contrib/ericvh/go-plan9/src/pkg/runtime/slice.c)\n\n#### 持续更新....","source":"_posts/15-Plan9-汇编小记.md","raw":"---\ntitle: 「15」Plan9 汇编小记\ndate: '2020/10/09 13:47:39'\nupdated: '2020/10/09 13:47:39'\nkeywords: '汇编,Go,Plan9'\ntop: false\nsticky: 3\ntags:\n  - Plan9\n  - Go\n  - Day\nabbrlink: 2ce846ed\n---\n#### 前序\n>平常coding时，偶尔会查看计算机的具体执行过程，那最基本的就是汇编了，了解汇编是调试过程中必不可少的，尤其是一些细节的处理方面.Go的汇编是Plan 9(贝尔实验室的产物)，和汇编很类似。\n#### 如何得到汇编结果？\n\n* 官网文档\n* Google\n\n##### 3种方式：\n>第一种\n<!-- more -->\n```go\ngo tool compile -N -l -S ***.go\n```\n>第二种\n\n```go\n1、先编译：\n    go tool compile -N -l ***.go\n2、再反编译：\n    go tool objdump ***.o\n```\n\n>第三种\n\n```go\ngo build -gcflags -S ***.go\n```\n\n\n#### 常用寄存器\n##### AX BX CX DX BP SI SP IP\n\n|寄存器|16位|32位|64位|\n|:----|:----|:----|:----|\n|累加寄存器|AX|EAX|RAX|\n|基址寄存器|BX|EBX|RBX|\n|计数寄存器|CX|ECX|RCX|\n|数据寄存器|DX|EDX|RDX|\n|堆栈基指针|BP|EBP|RBP|\n|变址寄存器|SI|ESI|RSI|\n|堆栈顶指针|SP|ESP|RSP|\n|指令寄存器|IP|EIP|RIP|\n\n##### MOV\n\n>movb（8位）、movw（16位）、movl（32位）、movq（64位）\n\n```go\nMOVSS: 移动单精度浮点数\n```\n\n#### 查询地址\n\n[MOVSS](https://c9x.me/x86/html/file_module_x86_id_205.html)\n[Intel汇编指令查询](https://www.felixcloutier.com/x86/index.html)\n[Plan9查询](https://plan9.io/sources/contrib/ericvh/go-plan9/src/pkg/runtime/slice.c)\n\n#### 持续更新....","slug":"15-Plan9-汇编小记","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl0000m3ci73s2pevcf","content":"<h4 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h4>\n<blockquote>\n<p>平常coding时，偶尔会查看计算机的具体执行过程，那最基本的就是汇编了，了解汇编是调试过程中必不可少的，尤其是一些细节的处理方面.Go的汇编是Plan 9(贝尔实验室的产物)，和汇编很类似。</p>\n</blockquote>\n<h4 id=\"如何得到汇编结果？\"><a class=\"header-anchor\" href=\"#如何得到汇编结果？\">¶</a>如何得到汇编结果？</h4>\n<ul>\n<li>官网文档</li>\n<li>Google</li>\n</ul>\n<h5 id=\"3种方式：\"><a class=\"header-anchor\" href=\"#3种方式：\">¶</a>3种方式：</h5>\n<blockquote>\n<p>第一种</p>\n</blockquote>\n<a id=\"more\"></a>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">go</span> tool compile -N -l -S ***.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>第二种</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、先编译：</span><br><span class=\"line\">    <span class=\"keyword\">go</span> tool compile -N -l ***.<span class=\"keyword\">go</span></span><br><span class=\"line\"><span class=\"number\">2</span>、再反编译：</span><br><span class=\"line\">    <span class=\"keyword\">go</span> tool objdump ***.o</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>第三种</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">go</span> build -gcflags -S ***.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"常用寄存器\"><a class=\"header-anchor\" href=\"#常用寄存器\">¶</a>常用寄存器</h4>\n<h5 id=\"AX-BX-CX-DX-BP-SI-SP-IP\"><a class=\"header-anchor\" href=\"#AX-BX-CX-DX-BP-SI-SP-IP\">¶</a>AX BX CX DX BP SI SP IP</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">寄存器</th>\n<th style=\"text-align:left\">16位</th>\n<th style=\"text-align:left\">32位</th>\n<th style=\"text-align:left\">64位</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">累加寄存器</td>\n<td style=\"text-align:left\">AX</td>\n<td style=\"text-align:left\">EAX</td>\n<td style=\"text-align:left\">RAX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">基址寄存器</td>\n<td style=\"text-align:left\">BX</td>\n<td style=\"text-align:left\">EBX</td>\n<td style=\"text-align:left\">RBX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">计数寄存器</td>\n<td style=\"text-align:left\">CX</td>\n<td style=\"text-align:left\">ECX</td>\n<td style=\"text-align:left\">RCX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">数据寄存器</td>\n<td style=\"text-align:left\">DX</td>\n<td style=\"text-align:left\">EDX</td>\n<td style=\"text-align:left\">RDX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">堆栈基指针</td>\n<td style=\"text-align:left\">BP</td>\n<td style=\"text-align:left\">EBP</td>\n<td style=\"text-align:left\">RBP</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">变址寄存器</td>\n<td style=\"text-align:left\">SI</td>\n<td style=\"text-align:left\">ESI</td>\n<td style=\"text-align:left\">RSI</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">堆栈顶指针</td>\n<td style=\"text-align:left\">SP</td>\n<td style=\"text-align:left\">ESP</td>\n<td style=\"text-align:left\">RSP</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">指令寄存器</td>\n<td style=\"text-align:left\">IP</td>\n<td style=\"text-align:left\">EIP</td>\n<td style=\"text-align:left\">RIP</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"MOV\"><a class=\"header-anchor\" href=\"#MOV\">¶</a>MOV</h5>\n<blockquote>\n<p>movb（8位）、movw（16位）、movl（32位）、movq（64位）</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOVSS: 移动单精度浮点数</span><br></pre></td></tr></table></figure>\n<h4 id=\"查询地址\"><a class=\"header-anchor\" href=\"#查询地址\">¶</a>查询地址</h4>\n<p><a href=\"https://c9x.me/x86/html/file_module_x86_id_205.html\">MOVSS</a><br>\n<a href=\"https://www.felixcloutier.com/x86/index.html\">Intel汇编指令查询</a><br>\n<a href=\"https://plan9.io/sources/contrib/ericvh/go-plan9/src/pkg/runtime/slice.c\">Plan9查询</a></p>\n<h4 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h4>\n","site":{"data":{}},"excerpt":"<h4 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h4>\n<blockquote>\n<p>平常coding时，偶尔会查看计算机的具体执行过程，那最基本的就是汇编了，了解汇编是调试过程中必不可少的，尤其是一些细节的处理方面.Go的汇编是Plan 9(贝尔实验室的产物)，和汇编很类似。</p>\n</blockquote>\n<h4 id=\"如何得到汇编结果？\"><a class=\"header-anchor\" href=\"#如何得到汇编结果？\">¶</a>如何得到汇编结果？</h4>\n<ul>\n<li>官网文档</li>\n<li>Google</li>\n</ul>\n<h5 id=\"3种方式：\"><a class=\"header-anchor\" href=\"#3种方式：\">¶</a>3种方式：</h5>\n<blockquote>\n<p>第一种</p>\n</blockquote>","more":"<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">go</span> tool compile -N -l -S ***.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>第二种</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、先编译：</span><br><span class=\"line\">    <span class=\"keyword\">go</span> tool compile -N -l ***.<span class=\"keyword\">go</span></span><br><span class=\"line\"><span class=\"number\">2</span>、再反编译：</span><br><span class=\"line\">    <span class=\"keyword\">go</span> tool objdump ***.o</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>第三种</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">go</span> build -gcflags -S ***.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"常用寄存器\"><a class=\"header-anchor\" href=\"#常用寄存器\">¶</a>常用寄存器</h4>\n<h5 id=\"AX-BX-CX-DX-BP-SI-SP-IP\"><a class=\"header-anchor\" href=\"#AX-BX-CX-DX-BP-SI-SP-IP\">¶</a>AX BX CX DX BP SI SP IP</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">寄存器</th>\n<th style=\"text-align:left\">16位</th>\n<th style=\"text-align:left\">32位</th>\n<th style=\"text-align:left\">64位</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">累加寄存器</td>\n<td style=\"text-align:left\">AX</td>\n<td style=\"text-align:left\">EAX</td>\n<td style=\"text-align:left\">RAX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">基址寄存器</td>\n<td style=\"text-align:left\">BX</td>\n<td style=\"text-align:left\">EBX</td>\n<td style=\"text-align:left\">RBX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">计数寄存器</td>\n<td style=\"text-align:left\">CX</td>\n<td style=\"text-align:left\">ECX</td>\n<td style=\"text-align:left\">RCX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">数据寄存器</td>\n<td style=\"text-align:left\">DX</td>\n<td style=\"text-align:left\">EDX</td>\n<td style=\"text-align:left\">RDX</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">堆栈基指针</td>\n<td style=\"text-align:left\">BP</td>\n<td style=\"text-align:left\">EBP</td>\n<td style=\"text-align:left\">RBP</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">变址寄存器</td>\n<td style=\"text-align:left\">SI</td>\n<td style=\"text-align:left\">ESI</td>\n<td style=\"text-align:left\">RSI</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">堆栈顶指针</td>\n<td style=\"text-align:left\">SP</td>\n<td style=\"text-align:left\">ESP</td>\n<td style=\"text-align:left\">RSP</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">指令寄存器</td>\n<td style=\"text-align:left\">IP</td>\n<td style=\"text-align:left\">EIP</td>\n<td style=\"text-align:left\">RIP</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"MOV\"><a class=\"header-anchor\" href=\"#MOV\">¶</a>MOV</h5>\n<blockquote>\n<p>movb（8位）、movw（16位）、movl（32位）、movq（64位）</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOVSS: 移动单精度浮点数</span><br></pre></td></tr></table></figure>\n<h4 id=\"查询地址\"><a class=\"header-anchor\" href=\"#查询地址\">¶</a>查询地址</h4>\n<p><a href=\"https://c9x.me/x86/html/file_module_x86_id_205.html\">MOVSS</a><br>\n<a href=\"https://www.felixcloutier.com/x86/index.html\">Intel汇编指令查询</a><br>\n<a href=\"https://plan9.io/sources/contrib/ericvh/go-plan9/src/pkg/runtime/slice.c\">Plan9查询</a></p>\n<h4 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h4>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Fri Oct 09 2020 13:47:39 GMT+0800 (中国标准时间)","title":"「15」Plan9 汇编小记","path":"archives/2ce846ed.html","eyeCatchImage":null,"excerpt":"<h4 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h4>\n<blockquote>\n<p>平常coding时，偶尔会查看计算机的具体执行过程，那最基本的就是汇编了，了解汇编是调试过程中必不可少的，尤其是一些细节的处理方面.Go的汇编是Plan 9(贝尔实验室的产物)，和汇编很类似。</p>\n</blockquote>\n<h4 id=\"如何得到汇编结果？\"><a class=\"header-anchor\" href=\"#如何得到汇编结果？\">¶</a>如何得到汇编结果？</h4>\n<ul>\n<li>官网文档</li>\n<li>Google</li>\n</ul>\n<h5 id=\"3种方式：\"><a class=\"header-anchor\" href=\"#3种方式：\">¶</a>3种方式：</h5>\n<blockquote>\n<p>第一种</p>\n</blockquote>","date":{"_isAMomentObject":true,"_i":"2020-10-09T05:47:39.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-10-09T05:47:39.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day","Plan9"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":471},{"title":"「14」hexo-安装&插件","date":"2020-09-30T11:24:32.000Z","updated":"2021-02-05T11:27:28.000Z","abbrlink":"ae4aba0d","_content":"\nhexo安装及其第三方插件包下载总结，以便后续CI一次到位。\n<!--more-->\n```go\n npm install -g hexo-cli\n npm install hexo-renderer-sass --save\n npm install hexo-generator-searchdb --save\n npm install hexo-generator-sitemap --save\n npm install hexo-generator-baidu-sitemap --save\n npm install request --save\n npm install xml-parser --save\n npm install yamljs --save\n npm install md5 --save\n npm install request --save\n npm install xml-parser --save\n npm install yamljs --save\n npm install cheerio --save\n npm install blueimp-md5 --save\n npm install hexo-abbrlink --save\n npm audit fix\n\n npm uninstall hexo-generator-index --save\n npm install hexo-generator-index-pin-top --save\n npm audit fix\n \n npm install hexo-neat --save\n npm audit fix\n npm install --save hexo-admin\n npm audit fix\n npm install hexo-deployer-git --save\n npm audit fix\n\n sudo npm install hexo-toc --save\n npm audit fix\n\n//猫咪模型\n sudo npm install --save hexo-helper-live2d \n npm audit fix\n sudo npm install --save live2d-widget-model-z16\n```\n\n\n>update: 2021-02-05 19:25:42\n\nhexo next解析插件更换：\n```go\nnpm un hexo-renderer-marked -S\n\n npm uninstall hexo-renderer-marked --save\n\n再安装下面插件：\n\n\nnpm install --save markdown-it-abbr\nnpm install --save markdown-it-footnote\nnpm install --save markdown-it-ins\nnpm install --save markdown-it-sub\nnpm install --save markdown-it-sup\nnpm install --save markdown-it-anchor\nnpm install --save markdown-it-deflist\nnpm install --save markdown-it-mark\nnpm install --save markdown-it-container\n\nnpm install --save markdown-it-emoji\nnpm install --save markdown-it-attrs\nnpm install --save markdown-it-task-lists\nnpm install --save markdown-it-68tygbv \n\nnpm install markdown-it-mathjax --save\nnpm audit fix\nnpm i markdown-it-latex2img --save\nnpm audit fix\nnpm install markdown-it-texmath\nnpm audit fix\n\n最后更新下hexo更目录下的_config.yaml\n\n# Markdown-it config\n## Docs: https://github.com/celsomiranda/hexo-renderer-markdown-it/wiki\nmarkdown:\n  render:\n    # Enable HTML tags in source\n    html: true\n\n    # Use '/' to close single tags (<br />). This is only for full CommonMark compatibility.\n    xhtmlOut: true        \n\n    # Convert '\\n' in paragraphs into <br> \n    breaks: true      \n\n    # CSS language prefix for fenced blocks. Can be useful for external highlighters.\n    langPrefix: 'language-'  \n\n    # Autoconvert URL-like text to links \n    linkify: true        \n\n    # Enable some language-neutral replacement + quotes beautification\n    typographer: false\n\n    # Double + single quotes replacement pairs, when typographer enabled,\n    # and smartquotes on. Could be either a String or an Array.\n    #\n    # For example, you can use '«»„“' for Russian, '„“‚‘' for German,\n    # and ['«\\xA0', '\\xA0»', '‹\\xA0', '\\xA0›'] for French (including nbsp).\n    quotes: '“”‘’'\n\n  # Plugins\n  plugins:\n    - markdown-it-abbr\n    - markdown-it-footnote\n    - markdown-it-ins\n    - markdown-it-sub\n    - markdown-it-sup\n    - markdown-it-anchor\n    - markdown-it-deflist\n    - markdown-it-mark\n    - markdown-it-container\n\n    - markdown-it-emoji\n    - markdown-it-named-headings\n    - markdown-it-toc\n    - markdown-it-attrs\n    - name: markdown-it-task-lists\n      options:\n        enabled: false\n        label: true\n        labelAfter: false\n  \n  # Automatic Headline ID's\n  anchors:\n    # Minimum level for ID creation. (Ex. h2 to h6)\n    level: 2\n\n    # A suffix that is prepended to the number given if the ID is repeated.\n    collisionSuffix: 'v'           \n\n    # If `true`, creates an anchor tag with a permalink besides the heading.\n    permalink: false              \n\n    # Class used for the permalink anchor tag.\n    permalinkClass: header-anchor \n\n    # The symbol used to make the permalink\n    permalinkSymbol: ¶\n\n```\n\n\nhexo gulp兼容es5:\n```\nnpm install gulp --save\nnpm audit fix\nnpm install gulp-minify-css --save\nnpm audit fix\nnpm install gulp-uglify --save\nnpm audit fix\nnpm install gulp-htmlmin --save\nnpm audit fix\nnpm install gulp-htmlclean --save\nnpm audit fix\nnpm install gulp-imagemin --save\nnpm audit fix\n\nnpm install babel-core@6.26.3 --save\nnpm install gulp-babel@7.0.1 --save\nnpm install babel-preset-es2015@6.24.1 --save\nnpm audit fix\n\n```\n>未完待续......","source":"_posts/14-hexo-安装-插件.md","raw":"---\ntitle: 「14」hexo-安装&插件\ndate: '2020/09/30 19:24:32'\nupdated: '2021/02/05 19:27:28'\ntags:\n  - hexo\nabbrlink: ae4aba0d\n---\n\nhexo安装及其第三方插件包下载总结，以便后续CI一次到位。\n<!--more-->\n```go\n npm install -g hexo-cli\n npm install hexo-renderer-sass --save\n npm install hexo-generator-searchdb --save\n npm install hexo-generator-sitemap --save\n npm install hexo-generator-baidu-sitemap --save\n npm install request --save\n npm install xml-parser --save\n npm install yamljs --save\n npm install md5 --save\n npm install request --save\n npm install xml-parser --save\n npm install yamljs --save\n npm install cheerio --save\n npm install blueimp-md5 --save\n npm install hexo-abbrlink --save\n npm audit fix\n\n npm uninstall hexo-generator-index --save\n npm install hexo-generator-index-pin-top --save\n npm audit fix\n \n npm install hexo-neat --save\n npm audit fix\n npm install --save hexo-admin\n npm audit fix\n npm install hexo-deployer-git --save\n npm audit fix\n\n sudo npm install hexo-toc --save\n npm audit fix\n\n//猫咪模型\n sudo npm install --save hexo-helper-live2d \n npm audit fix\n sudo npm install --save live2d-widget-model-z16\n```\n\n\n>update: 2021-02-05 19:25:42\n\nhexo next解析插件更换：\n```go\nnpm un hexo-renderer-marked -S\n\n npm uninstall hexo-renderer-marked --save\n\n再安装下面插件：\n\n\nnpm install --save markdown-it-abbr\nnpm install --save markdown-it-footnote\nnpm install --save markdown-it-ins\nnpm install --save markdown-it-sub\nnpm install --save markdown-it-sup\nnpm install --save markdown-it-anchor\nnpm install --save markdown-it-deflist\nnpm install --save markdown-it-mark\nnpm install --save markdown-it-container\n\nnpm install --save markdown-it-emoji\nnpm install --save markdown-it-attrs\nnpm install --save markdown-it-task-lists\nnpm install --save markdown-it-68tygbv \n\nnpm install markdown-it-mathjax --save\nnpm audit fix\nnpm i markdown-it-latex2img --save\nnpm audit fix\nnpm install markdown-it-texmath\nnpm audit fix\n\n最后更新下hexo更目录下的_config.yaml\n\n# Markdown-it config\n## Docs: https://github.com/celsomiranda/hexo-renderer-markdown-it/wiki\nmarkdown:\n  render:\n    # Enable HTML tags in source\n    html: true\n\n    # Use '/' to close single tags (<br />). This is only for full CommonMark compatibility.\n    xhtmlOut: true        \n\n    # Convert '\\n' in paragraphs into <br> \n    breaks: true      \n\n    # CSS language prefix for fenced blocks. Can be useful for external highlighters.\n    langPrefix: 'language-'  \n\n    # Autoconvert URL-like text to links \n    linkify: true        \n\n    # Enable some language-neutral replacement + quotes beautification\n    typographer: false\n\n    # Double + single quotes replacement pairs, when typographer enabled,\n    # and smartquotes on. Could be either a String or an Array.\n    #\n    # For example, you can use '«»„“' for Russian, '„“‚‘' for German,\n    # and ['«\\xA0', '\\xA0»', '‹\\xA0', '\\xA0›'] for French (including nbsp).\n    quotes: '“”‘’'\n\n  # Plugins\n  plugins:\n    - markdown-it-abbr\n    - markdown-it-footnote\n    - markdown-it-ins\n    - markdown-it-sub\n    - markdown-it-sup\n    - markdown-it-anchor\n    - markdown-it-deflist\n    - markdown-it-mark\n    - markdown-it-container\n\n    - markdown-it-emoji\n    - markdown-it-named-headings\n    - markdown-it-toc\n    - markdown-it-attrs\n    - name: markdown-it-task-lists\n      options:\n        enabled: false\n        label: true\n        labelAfter: false\n  \n  # Automatic Headline ID's\n  anchors:\n    # Minimum level for ID creation. (Ex. h2 to h6)\n    level: 2\n\n    # A suffix that is prepended to the number given if the ID is repeated.\n    collisionSuffix: 'v'           \n\n    # If `true`, creates an anchor tag with a permalink besides the heading.\n    permalink: false              \n\n    # Class used for the permalink anchor tag.\n    permalinkClass: header-anchor \n\n    # The symbol used to make the permalink\n    permalinkSymbol: ¶\n\n```\n\n\nhexo gulp兼容es5:\n```\nnpm install gulp --save\nnpm audit fix\nnpm install gulp-minify-css --save\nnpm audit fix\nnpm install gulp-uglify --save\nnpm audit fix\nnpm install gulp-htmlmin --save\nnpm audit fix\nnpm install gulp-htmlclean --save\nnpm audit fix\nnpm install gulp-imagemin --save\nnpm audit fix\n\nnpm install babel-core@6.26.3 --save\nnpm install gulp-babel@7.0.1 --save\nnpm install babel-preset-es2015@6.24.1 --save\nnpm audit fix\n\n```\n>未完待续......","slug":"14-hexo-安装-插件","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl1000n3ci723lta8g1","content":"<p>hexo安装及其第三方插件包下载总结，以便后续CI一次到位。</p>\n<a id=\"more\"></a>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> npm install -g hexo-cli</span><br><span class=\"line\"> npm install hexo-renderer-sass --save</span><br><span class=\"line\"> npm install hexo-generator-searchdb --save</span><br><span class=\"line\"> npm install hexo-generator-sitemap --save</span><br><span class=\"line\"> npm install hexo-generator-baidu-sitemap --save</span><br><span class=\"line\"> npm install request --save</span><br><span class=\"line\"> npm install xml-parser --save</span><br><span class=\"line\"> npm install yamljs --save</span><br><span class=\"line\"> npm install md5 --save</span><br><span class=\"line\"> npm install request --save</span><br><span class=\"line\"> npm install xml-parser --save</span><br><span class=\"line\"> npm install yamljs --save</span><br><span class=\"line\"> npm install cheerio --save</span><br><span class=\"line\"> npm install blueimp-md5 --save</span><br><span class=\"line\"> npm install hexo-abbrlink --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\"> npm uninstall hexo-generator-index --save</span><br><span class=\"line\"> npm install hexo-generator-index-pin-top --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> </span><br><span class=\"line\"> npm install hexo-neat --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> npm install --save hexo-admin</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> npm install hexo-deployer-git --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\"> sudo npm install hexo-toc --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//猫咪模型</span></span><br><span class=\"line\"> sudo npm install --save hexo-helper-live2d </span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> sudo npm install --save live2d-widget-model-z16</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>update: 2021-02-05 19:25:42</p>\n</blockquote>\n<p>hexo next解析插件更换：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm un hexo-renderer-marked -S</span><br><span class=\"line\"></span><br><span class=\"line\"> npm uninstall hexo-renderer-marked --save</span><br><span class=\"line\"></span><br><span class=\"line\">再安装下面插件：</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">npm install --save markdown-it-abbr</span><br><span class=\"line\">npm install --save markdown-it-footnote</span><br><span class=\"line\">npm install --save markdown-it-ins</span><br><span class=\"line\">npm install --save markdown-it-sub</span><br><span class=\"line\">npm install --save markdown-it-sup</span><br><span class=\"line\">npm install --save markdown-it-anchor</span><br><span class=\"line\">npm install --save markdown-it-deflist</span><br><span class=\"line\">npm install --save markdown-it-mark</span><br><span class=\"line\">npm install --save markdown-it-container</span><br><span class=\"line\"></span><br><span class=\"line\">npm install --save markdown-it-emoji</span><br><span class=\"line\">npm install --save markdown-it-attrs</span><br><span class=\"line\">npm install --save markdown-it-task-lists</span><br><span class=\"line\">npm install --save markdown-it<span class=\"number\">-68</span>tygbv </span><br><span class=\"line\"></span><br><span class=\"line\">npm install markdown-it-mathjax --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm i markdown-it-latex2img --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install markdown-it-texmath</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\">最后更新下hexo更目录下的_config.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"># Markdown-it config</span><br><span class=\"line\">## Docs: https:<span class=\"comment\">//github.com/celsomiranda/hexo-renderer-markdown-it/wiki</span></span><br><span class=\"line\">markdown:</span><br><span class=\"line\">  render:</span><br><span class=\"line\">    # Enable HTML tags in source</span><br><span class=\"line\">    html: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    # Use <span class=\"string\">&#x27;/&#x27;</span> to <span class=\"built_in\">close</span> single tags (&lt;br /&gt;). This is only <span class=\"keyword\">for</span> full CommonMark compatibility.</span><br><span class=\"line\">    xhtmlOut: <span class=\"literal\">true</span>        </span><br><span class=\"line\"></span><br><span class=\"line\">    # Convert <span class=\"string\">&#x27;\\n&#x27;</span> in paragraphs into &lt;br&gt; </span><br><span class=\"line\">    breaks: <span class=\"literal\">true</span>      </span><br><span class=\"line\"></span><br><span class=\"line\">    # CSS language prefix <span class=\"keyword\">for</span> fenced blocks. Can be useful <span class=\"keyword\">for</span> external highlighters.</span><br><span class=\"line\">    langPrefix: <span class=\"string\">&#x27;language-&#x27;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\">    # Autoconvert URL-like text to links </span><br><span class=\"line\">    linkify: <span class=\"literal\">true</span>        </span><br><span class=\"line\"></span><br><span class=\"line\">    # Enable some language-neutral replacement + quotes beautification</span><br><span class=\"line\">    typographer: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    # Double + single quotes replacement pairs, when typographer enabled,</span><br><span class=\"line\">    # and smartquotes on. Could be either a String or an Array.</span><br><span class=\"line\">    #</span><br><span class=\"line\">    # For example, you can use <span class=\"string\">&#x27;«»„“&#x27;</span> <span class=\"keyword\">for</span> Russian, <span class=\"string\">&#x27;„“‚‘&#x27;</span> <span class=\"keyword\">for</span> German,</span><br><span class=\"line\">    # and [<span class=\"string\">&#x27;«\\xA0&#x27;</span>, <span class=\"string\">&#x27;\\xA0»&#x27;</span>, <span class=\"string\">&#x27;‹\\xA0&#x27;</span>, <span class=\"string\">&#x27;\\xA0›&#x27;</span>] <span class=\"keyword\">for</span> French (including nbsp).</span><br><span class=\"line\">    quotes: <span class=\"string\">&#x27;“”‘’&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  # Plugins</span><br><span class=\"line\">  plugins:</span><br><span class=\"line\">    - markdown-it-abbr</span><br><span class=\"line\">    - markdown-it-footnote</span><br><span class=\"line\">    - markdown-it-ins</span><br><span class=\"line\">    - markdown-it-sub</span><br><span class=\"line\">    - markdown-it-sup</span><br><span class=\"line\">    - markdown-it-anchor</span><br><span class=\"line\">    - markdown-it-deflist</span><br><span class=\"line\">    - markdown-it-mark</span><br><span class=\"line\">    - markdown-it-container</span><br><span class=\"line\"></span><br><span class=\"line\">    - markdown-it-emoji</span><br><span class=\"line\">    - markdown-it-named-headings</span><br><span class=\"line\">    - markdown-it-toc</span><br><span class=\"line\">    - markdown-it-attrs</span><br><span class=\"line\">    - name: markdown-it-task-lists</span><br><span class=\"line\">      options:</span><br><span class=\"line\">        enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">        label: <span class=\"literal\">true</span></span><br><span class=\"line\">        labelAfter: <span class=\"literal\">false</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  # Automatic Headline ID<span class=\"string\">&#x27;s</span></span><br><span class=\"line\"><span class=\"string\">  anchors:</span></span><br><span class=\"line\"><span class=\"string\">    # Minimum level for ID creation. (Ex. h2 to h6)</span></span><br><span class=\"line\"><span class=\"string\">    level: 2</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # A suffix that is prepended to the number given if the ID is repeated.</span></span><br><span class=\"line\"><span class=\"string\">    collisionSuffix: &#x27;</span>v<span class=\"string\">&#x27;           </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # If `true`, creates an anchor tag with a permalink besides the heading.</span></span><br><span class=\"line\"><span class=\"string\">    permalink: false              </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # Class used for the permalink anchor tag.</span></span><br><span class=\"line\"><span class=\"string\">    permalinkClass: header-anchor </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # The symbol used to make the permalink</span></span><br><span class=\"line\"><span class=\"string\">    permalinkSymbol: ¶</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n<p>hexo gulp兼容es5:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install gulp --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-minify-css --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-uglify --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-htmlmin --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-htmlclean --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-imagemin --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\">npm install babel-core@6.26.3 --save</span><br><span class=\"line\">npm install gulp-babel@7.0.1 --save</span><br><span class=\"line\">npm install babel-preset-es2015@6.24.1 --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>未完待续…</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<p>hexo安装及其第三方插件包下载总结，以便后续CI一次到位。</p>","more":"<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> npm install -g hexo-cli</span><br><span class=\"line\"> npm install hexo-renderer-sass --save</span><br><span class=\"line\"> npm install hexo-generator-searchdb --save</span><br><span class=\"line\"> npm install hexo-generator-sitemap --save</span><br><span class=\"line\"> npm install hexo-generator-baidu-sitemap --save</span><br><span class=\"line\"> npm install request --save</span><br><span class=\"line\"> npm install xml-parser --save</span><br><span class=\"line\"> npm install yamljs --save</span><br><span class=\"line\"> npm install md5 --save</span><br><span class=\"line\"> npm install request --save</span><br><span class=\"line\"> npm install xml-parser --save</span><br><span class=\"line\"> npm install yamljs --save</span><br><span class=\"line\"> npm install cheerio --save</span><br><span class=\"line\"> npm install blueimp-md5 --save</span><br><span class=\"line\"> npm install hexo-abbrlink --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\"> npm uninstall hexo-generator-index --save</span><br><span class=\"line\"> npm install hexo-generator-index-pin-top --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> </span><br><span class=\"line\"> npm install hexo-neat --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> npm install --save hexo-admin</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> npm install hexo-deployer-git --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\"> sudo npm install hexo-toc --save</span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//猫咪模型</span></span><br><span class=\"line\"> sudo npm install --save hexo-helper-live2d </span><br><span class=\"line\"> npm audit fix</span><br><span class=\"line\"> sudo npm install --save live2d-widget-model-z16</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>update: 2021-02-05 19:25:42</p>\n</blockquote>\n<p>hexo next解析插件更换：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm un hexo-renderer-marked -S</span><br><span class=\"line\"></span><br><span class=\"line\"> npm uninstall hexo-renderer-marked --save</span><br><span class=\"line\"></span><br><span class=\"line\">再安装下面插件：</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">npm install --save markdown-it-abbr</span><br><span class=\"line\">npm install --save markdown-it-footnote</span><br><span class=\"line\">npm install --save markdown-it-ins</span><br><span class=\"line\">npm install --save markdown-it-sub</span><br><span class=\"line\">npm install --save markdown-it-sup</span><br><span class=\"line\">npm install --save markdown-it-anchor</span><br><span class=\"line\">npm install --save markdown-it-deflist</span><br><span class=\"line\">npm install --save markdown-it-mark</span><br><span class=\"line\">npm install --save markdown-it-container</span><br><span class=\"line\"></span><br><span class=\"line\">npm install --save markdown-it-emoji</span><br><span class=\"line\">npm install --save markdown-it-attrs</span><br><span class=\"line\">npm install --save markdown-it-task-lists</span><br><span class=\"line\">npm install --save markdown-it<span class=\"number\">-68</span>tygbv </span><br><span class=\"line\"></span><br><span class=\"line\">npm install markdown-it-mathjax --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm i markdown-it-latex2img --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install markdown-it-texmath</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\">最后更新下hexo更目录下的_config.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"># Markdown-it config</span><br><span class=\"line\">## Docs: https:<span class=\"comment\">//github.com/celsomiranda/hexo-renderer-markdown-it/wiki</span></span><br><span class=\"line\">markdown:</span><br><span class=\"line\">  render:</span><br><span class=\"line\">    # Enable HTML tags in source</span><br><span class=\"line\">    html: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    # Use <span class=\"string\">&#x27;/&#x27;</span> to <span class=\"built_in\">close</span> single tags (&lt;br /&gt;). This is only <span class=\"keyword\">for</span> full CommonMark compatibility.</span><br><span class=\"line\">    xhtmlOut: <span class=\"literal\">true</span>        </span><br><span class=\"line\"></span><br><span class=\"line\">    # Convert <span class=\"string\">&#x27;\\n&#x27;</span> in paragraphs into &lt;br&gt; </span><br><span class=\"line\">    breaks: <span class=\"literal\">true</span>      </span><br><span class=\"line\"></span><br><span class=\"line\">    # CSS language prefix <span class=\"keyword\">for</span> fenced blocks. Can be useful <span class=\"keyword\">for</span> external highlighters.</span><br><span class=\"line\">    langPrefix: <span class=\"string\">&#x27;language-&#x27;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\">    # Autoconvert URL-like text to links </span><br><span class=\"line\">    linkify: <span class=\"literal\">true</span>        </span><br><span class=\"line\"></span><br><span class=\"line\">    # Enable some language-neutral replacement + quotes beautification</span><br><span class=\"line\">    typographer: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    # Double + single quotes replacement pairs, when typographer enabled,</span><br><span class=\"line\">    # and smartquotes on. Could be either a String or an Array.</span><br><span class=\"line\">    #</span><br><span class=\"line\">    # For example, you can use <span class=\"string\">&#x27;«»„“&#x27;</span> <span class=\"keyword\">for</span> Russian, <span class=\"string\">&#x27;„“‚‘&#x27;</span> <span class=\"keyword\">for</span> German,</span><br><span class=\"line\">    # and [<span class=\"string\">&#x27;«\\xA0&#x27;</span>, <span class=\"string\">&#x27;\\xA0»&#x27;</span>, <span class=\"string\">&#x27;‹\\xA0&#x27;</span>, <span class=\"string\">&#x27;\\xA0›&#x27;</span>] <span class=\"keyword\">for</span> French (including nbsp).</span><br><span class=\"line\">    quotes: <span class=\"string\">&#x27;“”‘’&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  # Plugins</span><br><span class=\"line\">  plugins:</span><br><span class=\"line\">    - markdown-it-abbr</span><br><span class=\"line\">    - markdown-it-footnote</span><br><span class=\"line\">    - markdown-it-ins</span><br><span class=\"line\">    - markdown-it-sub</span><br><span class=\"line\">    - markdown-it-sup</span><br><span class=\"line\">    - markdown-it-anchor</span><br><span class=\"line\">    - markdown-it-deflist</span><br><span class=\"line\">    - markdown-it-mark</span><br><span class=\"line\">    - markdown-it-container</span><br><span class=\"line\"></span><br><span class=\"line\">    - markdown-it-emoji</span><br><span class=\"line\">    - markdown-it-named-headings</span><br><span class=\"line\">    - markdown-it-toc</span><br><span class=\"line\">    - markdown-it-attrs</span><br><span class=\"line\">    - name: markdown-it-task-lists</span><br><span class=\"line\">      options:</span><br><span class=\"line\">        enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">        label: <span class=\"literal\">true</span></span><br><span class=\"line\">        labelAfter: <span class=\"literal\">false</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  # Automatic Headline ID<span class=\"string\">&#x27;s</span></span><br><span class=\"line\"><span class=\"string\">  anchors:</span></span><br><span class=\"line\"><span class=\"string\">    # Minimum level for ID creation. (Ex. h2 to h6)</span></span><br><span class=\"line\"><span class=\"string\">    level: 2</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # A suffix that is prepended to the number given if the ID is repeated.</span></span><br><span class=\"line\"><span class=\"string\">    collisionSuffix: &#x27;</span>v<span class=\"string\">&#x27;           </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # If `true`, creates an anchor tag with a permalink besides the heading.</span></span><br><span class=\"line\"><span class=\"string\">    permalink: false              </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # Class used for the permalink anchor tag.</span></span><br><span class=\"line\"><span class=\"string\">    permalinkClass: header-anchor </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    # The symbol used to make the permalink</span></span><br><span class=\"line\"><span class=\"string\">    permalinkSymbol: ¶</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n<p>hexo gulp兼容es5:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install gulp --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-minify-css --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-uglify --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-htmlmin --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-htmlclean --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\">npm install gulp-imagemin --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\">npm install babel-core@6.26.3 --save</span><br><span class=\"line\">npm install gulp-babel@7.0.1 --save</span><br><span class=\"line\">npm install babel-preset-es2015@6.24.1 --save</span><br><span class=\"line\">npm audit fix</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>未完待续…</p>\n</blockquote>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Fri Feb 05 2021 19:27:28 GMT+0800 (中国标准时间)","title":"「14」hexo-安装&插件","path":"archives/ae4aba0d.html","eyeCatchImage":null,"excerpt":"<p>hexo安装及其第三方插件包下载总结，以便后续CI一次到位。</p>","date":{"_isAMomentObject":true,"_i":"2020-09-30T11:24:32.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-30T11:24:32.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["hexo"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":3664},{"title":"「16」go源码words归纳","date":"2020-11-03T02:45:07.000Z","updated":"2020-11-25T13:45:07.000Z","keywords":"汇编,Go,Plan9","abbrlink":"425d5e80","_content":"### 前序\n\n好久没有更新了，不是不更新，最近感冒严重，一直没好，太影响身体了.....「身体还是很重要的!」\n\n当然了，在生病期间也看了很多东西，更多的思考了许多：人生规划的、如何学习技术、后续的生涯发展之类的。「思考的方式很多种，不建议去生病了才去思考.」\n\n>后续会更新一篇，主要是结合之前的成长和技术的壁垒来说说后续想怎么学，怎么发展，生涯规划吧。\n\n不扯了，这篇主要想记录一些词汇，主要还是在阅读Go源码中的一些词汇，毕竟英文有点差，再不积累就更差了。\n\n### Words\n\n#### 全称\n<!--more-->\n```go\n「11/3」\nPreempt  v 抢占、掠夺                                   --> /proc.go\nretake   v 重新获取「重新分配」                           --> /proc.go\nsyscall  v 系统调用                                     --> /proc.go\ndecrement v 递减                                       --> /proc.go\npretending  v 假装、伪装                                --> /proc.go\ncontended  v 竞争                                      --> /proc.go\nprocresize  v 扩大                                     --> /proc.go \ncorruption  n 腐败，译：损坏\ninfinite  adj 无限的  \nreproduce v  复制\nconsists  v 组成\nreproducer  v 复制\nallocating v 分配\nembed   v 嵌入 \n\n「11/5」\nassembly  n  装配                                      --> /proc.go\namortizes  v  缓冲                                     --> /proc.go\n\n「11/25」\nguard  v. 看守\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t --> /proc.go\nAlternatively  或者\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-->  /runtime/rwmutex.go\n\n「later」\ndemonstrate  v 演示\n\n```\n\n\n#### 简写\n\n```go\n「11/3」\nsysmon -> system monitor 系统监控                                               /proc.go\nincidlelocked  --> increment idle locked   增加空闲锁                           /proc.go\nsysmontick  --> system monitor ticket   系统监控数量                            /proc.go\n```\n\n### 持续更新....\n","source":"_posts/16-go源码words归纳.md","raw":"---\ntitle: 「16」go源码words归纳\ndate: '2020/11/03 10:45:07'\nupdated: '2020/11/25 21:45:07'\nkeywords: '汇编,Go,Plan9'\ntags:\n  - Go\n  - Day\nabbrlink: 425d5e80\n---\n### 前序\n\n好久没有更新了，不是不更新，最近感冒严重，一直没好，太影响身体了.....「身体还是很重要的!」\n\n当然了，在生病期间也看了很多东西，更多的思考了许多：人生规划的、如何学习技术、后续的生涯发展之类的。「思考的方式很多种，不建议去生病了才去思考.」\n\n>后续会更新一篇，主要是结合之前的成长和技术的壁垒来说说后续想怎么学，怎么发展，生涯规划吧。\n\n不扯了，这篇主要想记录一些词汇，主要还是在阅读Go源码中的一些词汇，毕竟英文有点差，再不积累就更差了。\n\n### Words\n\n#### 全称\n<!--more-->\n```go\n「11/3」\nPreempt  v 抢占、掠夺                                   --> /proc.go\nretake   v 重新获取「重新分配」                           --> /proc.go\nsyscall  v 系统调用                                     --> /proc.go\ndecrement v 递减                                       --> /proc.go\npretending  v 假装、伪装                                --> /proc.go\ncontended  v 竞争                                      --> /proc.go\nprocresize  v 扩大                                     --> /proc.go \ncorruption  n 腐败，译：损坏\ninfinite  adj 无限的  \nreproduce v  复制\nconsists  v 组成\nreproducer  v 复制\nallocating v 分配\nembed   v 嵌入 \n\n「11/5」\nassembly  n  装配                                      --> /proc.go\namortizes  v  缓冲                                     --> /proc.go\n\n「11/25」\nguard  v. 看守\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t --> /proc.go\nAlternatively  或者\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-->  /runtime/rwmutex.go\n\n「later」\ndemonstrate  v 演示\n\n```\n\n\n#### 简写\n\n```go\n「11/3」\nsysmon -> system monitor 系统监控                                               /proc.go\nincidlelocked  --> increment idle locked   增加空闲锁                           /proc.go\nsysmontick  --> system monitor ticket   系统监控数量                            /proc.go\n```\n\n### 持续更新....\n","slug":"16-go源码words归纳","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl2000q3ci7h5sm6vix","content":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>好久没有更新了，不是不更新，最近感冒严重，一直没好，太影响身体了…「身体还是很重要的!」</p>\n<p>当然了，在生病期间也看了很多东西，更多的思考了许多：人生规划的、如何学习技术、后续的生涯发展之类的。「思考的方式很多种，不建议去生病了才去思考.」</p>\n<blockquote>\n<p>后续会更新一篇，主要是结合之前的成长和技术的壁垒来说说后续想怎么学，怎么发展，生涯规划吧。</p>\n</blockquote>\n<p>不扯了，这篇主要想记录一些词汇，主要还是在阅读Go源码中的一些词汇，毕竟英文有点差，再不积累就更差了。</p>\n<h3 id=\"Words\"><a class=\"header-anchor\" href=\"#Words\">¶</a>Words</h3>\n<h4 id=\"全称\"><a class=\"header-anchor\" href=\"#全称\">¶</a>全称</h4>\n<a id=\"more\"></a>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">3</span>」</span><br><span class=\"line\">Preempt  v 抢占、掠夺                                   --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">retake   v 重新获取「重新分配」                           --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">syscall  v 系统调用                                     --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">decrement v 递减                                       --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">pretending  v 假装、伪装                                --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">contended  v 竞争                                      --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">procresize  v 扩大                                     --&gt; /proc.<span class=\"keyword\">go</span> </span><br><span class=\"line\">corruption  n 腐败，译：损坏</span><br><span class=\"line\">infinite  adj 无限的  </span><br><span class=\"line\">reproduce v  复制</span><br><span class=\"line\">consists  v 组成</span><br><span class=\"line\">reproducer  v 复制</span><br><span class=\"line\">allocating v 分配</span><br><span class=\"line\">embed   v 嵌入 </span><br><span class=\"line\"></span><br><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">5</span>」</span><br><span class=\"line\">assembly  n  装配                                      --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">amortizes  v  缓冲                                     --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\"></span><br><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">25</span>」</span><br><span class=\"line\">guard  v. 看守\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">Alternatively  或者\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--&gt;  /runtime/rwmutex.<span class=\"keyword\">go</span></span><br><span class=\"line\"></span><br><span class=\"line\">「later」</span><br><span class=\"line\">demonstrate  v 演示</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"简写\"><a class=\"header-anchor\" href=\"#简写\">¶</a>简写</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">3</span>」</span><br><span class=\"line\">sysmon -&gt; system monitor 系统监控                                               /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">incidlelocked  --&gt; increment idle locked   增加空闲锁                           /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">sysmontick  --&gt; system monitor ticket   系统监控数量                            /proc.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h3>\n","site":{"data":{}},"excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>好久没有更新了，不是不更新，最近感冒严重，一直没好，太影响身体了…「身体还是很重要的!」</p>\n<p>当然了，在生病期间也看了很多东西，更多的思考了许多：人生规划的、如何学习技术、后续的生涯发展之类的。「思考的方式很多种，不建议去生病了才去思考.」</p>\n<blockquote>\n<p>后续会更新一篇，主要是结合之前的成长和技术的壁垒来说说后续想怎么学，怎么发展，生涯规划吧。</p>\n</blockquote>\n<p>不扯了，这篇主要想记录一些词汇，主要还是在阅读Go源码中的一些词汇，毕竟英文有点差，再不积累就更差了。</p>\n<h3 id=\"Words\"><a class=\"header-anchor\" href=\"#Words\">¶</a>Words</h3>\n<h4 id=\"全称\"><a class=\"header-anchor\" href=\"#全称\">¶</a>全称</h4>","more":"<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">3</span>」</span><br><span class=\"line\">Preempt  v 抢占、掠夺                                   --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">retake   v 重新获取「重新分配」                           --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">syscall  v 系统调用                                     --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">decrement v 递减                                       --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">pretending  v 假装、伪装                                --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">contended  v 竞争                                      --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">procresize  v 扩大                                     --&gt; /proc.<span class=\"keyword\">go</span> </span><br><span class=\"line\">corruption  n 腐败，译：损坏</span><br><span class=\"line\">infinite  adj 无限的  </span><br><span class=\"line\">reproduce v  复制</span><br><span class=\"line\">consists  v 组成</span><br><span class=\"line\">reproducer  v 复制</span><br><span class=\"line\">allocating v 分配</span><br><span class=\"line\">embed   v 嵌入 </span><br><span class=\"line\"></span><br><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">5</span>」</span><br><span class=\"line\">assembly  n  装配                                      --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">amortizes  v  缓冲                                     --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\"></span><br><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">25</span>」</span><br><span class=\"line\">guard  v. 看守\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t --&gt; /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">Alternatively  或者\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--&gt;  /runtime/rwmutex.<span class=\"keyword\">go</span></span><br><span class=\"line\"></span><br><span class=\"line\">「later」</span><br><span class=\"line\">demonstrate  v 演示</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"简写\"><a class=\"header-anchor\" href=\"#简写\">¶</a>简写</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">「<span class=\"number\">11</span>/<span class=\"number\">3</span>」</span><br><span class=\"line\">sysmon -&gt; system monitor 系统监控                                               /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">incidlelocked  --&gt; increment idle locked   增加空闲锁                           /proc.<span class=\"keyword\">go</span></span><br><span class=\"line\">sysmontick  --&gt; system monitor ticket   系统监控数量                            /proc.<span class=\"keyword\">go</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Wed Nov 25 2020 21:45:07 GMT+0800 (中国标准时间)","title":"「16」go源码words归纳","path":"archives/425d5e80.html","eyeCatchImage":null,"excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>好久没有更新了，不是不更新，最近感冒严重，一直没好，太影响身体了…「身体还是很重要的!」</p>\n<p>当然了，在生病期间也看了很多东西，更多的思考了许多：人生规划的、如何学习技术、后续的生涯发展之类的。「思考的方式很多种，不建议去生病了才去思考.」</p>\n<blockquote>\n<p>后续会更新一篇，主要是结合之前的成长和技术的壁垒来说说后续想怎么学，怎么发展，生涯规划吧。</p>\n</blockquote>\n<p>不扯了，这篇主要想记录一些词汇，主要还是在阅读Go源码中的一些词汇，毕竟英文有点差，再不积累就更差了。</p>\n<h3 id=\"Words\"><a class=\"header-anchor\" href=\"#Words\">¶</a>Words</h3>\n<h4 id=\"全称\"><a class=\"header-anchor\" href=\"#全称\">¶</a>全称</h4>","date":{"_isAMomentObject":true,"_i":"2020-11-03T02:45:07.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-03T02:45:07.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":861},{"title":"「17」chrome headless「截图/PDF/DOM...」","keywords":"chrome,chrome headless","abbrlink":"5544baea","date":"2020-11-10T11:25:32.000Z","updated":"2020-11-10T11:25:32.000Z","_content":"\n>最近在搞一个需求：html「文件」渲染成png/jpg；chrome不能装在服务器中，可以打成docker镜像。\n说到这个，很多人肯定说很容易啊，chrome headless有现成的，直接用，它是不香么。\n然而事情并没有这么简单；\n\n### 难点：\n```go\n    1、服务器中不能装chrome\n    2、chrome必须打在docker里面\n    3、渲染效果要和在本地效果一样：图片不能丢失字体，不能失真。\n    4、不能启动新的服务\n```\n\n<!--more-->\n### 切入点：\n```go \ndocker && chrome\n```\n\n>so先去搜一把有没有现成的可用？\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-193745.png)\n\n分析分析吧：\n\n* [browserless](https://github.com/browserless/chrome)\n* [puppeteer](https://github.com/puppeteer/puppeteer)\n* [prisma-archive](https://github.com/prisma-archive/chromeless)\n..........\n    * 适合启动服务，然后进行测试或者跑服务\n    * 入参数为url\n\n>所以上述的基本不符合需求，再寻找.....\n\n### [Zenika/alpine-chrome](https://github.com/Zenika/alpine-chrome)\n\n>看起来可行：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194452.png)\n\n\n这个经过验证总会有一个错误：\n```\n[1110/031547.366909:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket /var/run/dbus/system_bus_socket: No such file or directory\n[1110/031547.367451:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.\n[1110/031547.437879:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.\n[1110/031549.073431:ERROR:headless_shell.cc(591)] Writing to file code/ss.png was unsuccessful, could not open file: FILE_ERROR_ACCESS_DENIED\n```\n\n文件没权限哦，尴尬了,再修正：\n>发现源码有一段添加了用户，汗，太搞了.\n\n[点击查看](https://github.com/Zenika/alpine-chrome/blob/master/Dockerfile#L38)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194711.png)\n\n\n```\n很郁闷这个chrome用户干嘛的，如果真用这个，那得确定你跑的环境要允许你添加一个user出来，很明显不行,\n这样导致整个alpine-chrome服务权限都是乱的「chrome用户的」,最明显的是无法读写文件，因为你这个add chrome没权限。\n\n最直接的，去掉就好了。\n\n果然去掉后，跑docker就可以了\n```\n\n[docker镜像地址](https://hub.docker.com/r/zenika/alpine-chrome)\n\n这个是可以了，但是有一个新的问题，图像失真了，再去查github源码，坑那，压根没有装全文字库，只简单装了lib***的库。\n\n\n### 再尝试「自己搞个docker images」\n\n>别人都能搞，为何我不可以勒\n\n### 分析：\n* 本地跑这个服务是ok的，那chrome就是依赖macos/linux系统的\n* 那可以搞个linux系统，再装个chrome\n* 最后把字体装完就ok了\n* 最后的最后，想办法直接可以用这个docker，不用启动服务，也就是说docker run之后有了结果，直接rm掉。\n\n\n### 思路：\n* 1、搞个docker debain系统\n* 2、想办法把chrome装上\n* 3、在里面跑一个测试，看能否生成图片\n* 4、安装缺失的字体\n* 5、container跑起来\n* 6、导出container，再导入到本地的images；让container变成images\n* 7、自己搞个Dockerfile，把「RUN」接口留出来，方便可以直接跑起来\n* 8、再把搞好的images导出来用就可以了。\n\n### 步骤：\n#### 1\n```\ndocker pull debian\n```\n\n#### 2/3/4/5\n```\n1、进入系统\ndocker exec -it XXXXX /bin/bash\n2、更新源\napt-get update\n3、下载wget\napt-get install wget\n4、下载chrome linux版本的\nwget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb\n5、安装chrome\n dpkg -i ******.deb\n 解决依赖关系：\n    apt-get -f install\n6、跑一把发现汉字变问好「？」了\n7、安装缺失的字体\napt-get install ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy\n```\n\n#### 6导出container\n```\n1、导出container\ndocker export container_name > chrome.tar\n2、导入到images中\ndocker load < chrome.tar\n```\n\n#### 7自己搞Dockerfile,预留「RUN」接口\n\nDockerfile文件：\n```\n#这个是上一步导入的images\nFROM gogoowang/chrome:v1\nRUN mkdir -p /home\nWORKDIR /home\nENTRYPOINT [\"chrome\",\"--headless\",\"--disable-gpu\"]\n```\n\n>构建成镜像：docker build -t gogoo/chrome:v2 . \n\nPS:「/home」的含义就是这个images的工作目录是/home文件夹下面\n\n#### 8跑一把，收工\n\n### 注意点：\n#### PS-1\n```\n1、错误❌\ndocker container run -it --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot --hide-scrollbars /XXXX/XXXX.html\n2、正确\ndocker container run -i --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot=/home/xx.png --hide-scrollbars /XXXX/XXXX.html\n\n少一个 -t，这个 -t：再搞一个临时的TTy来跑程序，既然是后台跑的，那就没必要了\n```\n\n#### PS-2\n\n```\ndocker container run -i --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot=/home/xx.png --hide-scrollbars /XXXX/XXXX.html\n\n1、关于这个-v的问题,后面就固定了，具体见Dockerfile中\n2、--screenshot路径问题，既然是docker镜像，那就得填个docker镜像中的地址，那就是/home下面了\n```\n\n\n### 优化后一键脚本\nDockerfile文件：\n```\nFROM debian\nRUN apt-get update \nRUN apt-get install -y wget \nRUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb \nRUN dpkg -i google-chrome-stable_current_amd64.deb || true\nRUN apt-get -f -y install\nRUN apt-get install -y ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy\nRUN mkdir -p /home\nWORKDIR /home\nENTRYPOINT [\"/opt/google/chrome/chrome\",\"--headless\",\"--disable-gpu\"]\n```\n构建：\n>docker build -t google-chrome:latest .","source":"_posts/17-chrome headless.md","raw":"---\ntitle: 「17」chrome headless「截图/PDF/DOM...」\nkeywords: 'chrome,chrome headless'\ntags:\n  - chrome\n  - Day\nabbrlink: 5544baea\ndate: 2020-11-10 19:25:32\nupdated: 2020-11-10 19:25:32\n---\n\n>最近在搞一个需求：html「文件」渲染成png/jpg；chrome不能装在服务器中，可以打成docker镜像。\n说到这个，很多人肯定说很容易啊，chrome headless有现成的，直接用，它是不香么。\n然而事情并没有这么简单；\n\n### 难点：\n```go\n    1、服务器中不能装chrome\n    2、chrome必须打在docker里面\n    3、渲染效果要和在本地效果一样：图片不能丢失字体，不能失真。\n    4、不能启动新的服务\n```\n\n<!--more-->\n### 切入点：\n```go \ndocker && chrome\n```\n\n>so先去搜一把有没有现成的可用？\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-193745.png)\n\n分析分析吧：\n\n* [browserless](https://github.com/browserless/chrome)\n* [puppeteer](https://github.com/puppeteer/puppeteer)\n* [prisma-archive](https://github.com/prisma-archive/chromeless)\n..........\n    * 适合启动服务，然后进行测试或者跑服务\n    * 入参数为url\n\n>所以上述的基本不符合需求，再寻找.....\n\n### [Zenika/alpine-chrome](https://github.com/Zenika/alpine-chrome)\n\n>看起来可行：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194452.png)\n\n\n这个经过验证总会有一个错误：\n```\n[1110/031547.366909:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket /var/run/dbus/system_bus_socket: No such file or directory\n[1110/031547.367451:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.\n[1110/031547.437879:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.\n[1110/031549.073431:ERROR:headless_shell.cc(591)] Writing to file code/ss.png was unsuccessful, could not open file: FILE_ERROR_ACCESS_DENIED\n```\n\n文件没权限哦，尴尬了,再修正：\n>发现源码有一段添加了用户，汗，太搞了.\n\n[点击查看](https://github.com/Zenika/alpine-chrome/blob/master/Dockerfile#L38)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194711.png)\n\n\n```\n很郁闷这个chrome用户干嘛的，如果真用这个，那得确定你跑的环境要允许你添加一个user出来，很明显不行,\n这样导致整个alpine-chrome服务权限都是乱的「chrome用户的」,最明显的是无法读写文件，因为你这个add chrome没权限。\n\n最直接的，去掉就好了。\n\n果然去掉后，跑docker就可以了\n```\n\n[docker镜像地址](https://hub.docker.com/r/zenika/alpine-chrome)\n\n这个是可以了，但是有一个新的问题，图像失真了，再去查github源码，坑那，压根没有装全文字库，只简单装了lib***的库。\n\n\n### 再尝试「自己搞个docker images」\n\n>别人都能搞，为何我不可以勒\n\n### 分析：\n* 本地跑这个服务是ok的，那chrome就是依赖macos/linux系统的\n* 那可以搞个linux系统，再装个chrome\n* 最后把字体装完就ok了\n* 最后的最后，想办法直接可以用这个docker，不用启动服务，也就是说docker run之后有了结果，直接rm掉。\n\n\n### 思路：\n* 1、搞个docker debain系统\n* 2、想办法把chrome装上\n* 3、在里面跑一个测试，看能否生成图片\n* 4、安装缺失的字体\n* 5、container跑起来\n* 6、导出container，再导入到本地的images；让container变成images\n* 7、自己搞个Dockerfile，把「RUN」接口留出来，方便可以直接跑起来\n* 8、再把搞好的images导出来用就可以了。\n\n### 步骤：\n#### 1\n```\ndocker pull debian\n```\n\n#### 2/3/4/5\n```\n1、进入系统\ndocker exec -it XXXXX /bin/bash\n2、更新源\napt-get update\n3、下载wget\napt-get install wget\n4、下载chrome linux版本的\nwget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb\n5、安装chrome\n dpkg -i ******.deb\n 解决依赖关系：\n    apt-get -f install\n6、跑一把发现汉字变问好「？」了\n7、安装缺失的字体\napt-get install ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy\n```\n\n#### 6导出container\n```\n1、导出container\ndocker export container_name > chrome.tar\n2、导入到images中\ndocker load < chrome.tar\n```\n\n#### 7自己搞Dockerfile,预留「RUN」接口\n\nDockerfile文件：\n```\n#这个是上一步导入的images\nFROM gogoowang/chrome:v1\nRUN mkdir -p /home\nWORKDIR /home\nENTRYPOINT [\"chrome\",\"--headless\",\"--disable-gpu\"]\n```\n\n>构建成镜像：docker build -t gogoo/chrome:v2 . \n\nPS:「/home」的含义就是这个images的工作目录是/home文件夹下面\n\n#### 8跑一把，收工\n\n### 注意点：\n#### PS-1\n```\n1、错误❌\ndocker container run -it --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot --hide-scrollbars /XXXX/XXXX.html\n2、正确\ndocker container run -i --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot=/home/xx.png --hide-scrollbars /XXXX/XXXX.html\n\n少一个 -t，这个 -t：再搞一个临时的TTy来跑程序，既然是后台跑的，那就没必要了\n```\n\n#### PS-2\n\n```\ndocker container run -i --rm -v /tmp:/home gogoowang/chrome:v1 --no-sandbox --screenshot=/home/xx.png --hide-scrollbars /XXXX/XXXX.html\n\n1、关于这个-v的问题,后面就固定了，具体见Dockerfile中\n2、--screenshot路径问题，既然是docker镜像，那就得填个docker镜像中的地址，那就是/home下面了\n```\n\n\n### 优化后一键脚本\nDockerfile文件：\n```\nFROM debian\nRUN apt-get update \nRUN apt-get install -y wget \nRUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb \nRUN dpkg -i google-chrome-stable_current_amd64.deb || true\nRUN apt-get -f -y install\nRUN apt-get install -y ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy\nRUN mkdir -p /home\nWORKDIR /home\nENTRYPOINT [\"/opt/google/chrome/chrome\",\"--headless\",\"--disable-gpu\"]\n```\n构建：\n>docker build -t google-chrome:latest .","slug":"17-chrome headless","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl3000s3ci73lazb334","content":"<blockquote>\n<p>最近在搞一个需求：html「文件」渲染成png/jpg；chrome不能装在服务器中，可以打成docker镜像。<br>\n说到这个，很多人肯定说很容易啊，chrome headless有现成的，直接用，它是不香么。<br>\n然而事情并没有这么简单；</p>\n</blockquote>\n<h3 id=\"难点：\"><a class=\"header-anchor\" href=\"#难点：\">¶</a>难点：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、服务器中不能装chrome</span><br><span class=\"line\"><span class=\"number\">2</span>、chrome必须打在docker里面</span><br><span class=\"line\"><span class=\"number\">3</span>、渲染效果要和在本地效果一样：图片不能丢失字体，不能失真。</span><br><span class=\"line\"><span class=\"number\">4</span>、不能启动新的服务</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h3 id=\"切入点：\"><a class=\"header-anchor\" href=\"#切入点：\">¶</a>切入点：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker &amp;&amp; chrome</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>so先去搜一把有没有现成的可用？</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-193745.png\" alt=\"\"></p>\n<p>分析分析吧：</p>\n<ul>\n<li><a href=\"https://github.com/browserless/chrome\">browserless</a></li>\n<li><a href=\"https://github.com/puppeteer/puppeteer\">puppeteer</a></li>\n<li><a href=\"https://github.com/prisma-archive/chromeless\">prisma-archive</a><br>\n…\n<ul>\n<li>适合启动服务，然后进行测试或者跑服务</li>\n<li>入参数为url</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>所以上述的基本不符合需求，再寻找…</p>\n</blockquote>\n<h3 id=\"Zenika-alpine-chrome\"><a class=\"header-anchor\" href=\"#Zenika-alpine-chrome\">¶</a><a href=\"https://github.com/Zenika/alpine-chrome\">Zenika/alpine-chrome</a></h3>\n<blockquote>\n<p>看起来可行：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194452.png\" alt=\"\"></p>\n<p>这个经过验证总会有一个错误：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[1110&#x2F;031547.366909:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket &#x2F;var&#x2F;run&#x2F;dbus&#x2F;system_bus_socket: No such file or directory</span><br><span class=\"line\">[1110&#x2F;031547.367451:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class=\"line\">[1110&#x2F;031547.437879:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class=\"line\">[1110&#x2F;031549.073431:ERROR:headless_shell.cc(591)] Writing to file code&#x2F;ss.png was unsuccessful, could not open file: FILE_ERROR_ACCESS_DENIED</span><br></pre></td></tr></table></figure>\n<p>文件没权限哦，尴尬了,再修正：</p>\n<blockquote>\n<p>发现源码有一段添加了用户，汗，太搞了.</p>\n</blockquote>\n<p><a href=\"https://github.com/Zenika/alpine-chrome/blob/master/Dockerfile#L38\">点击查看</a></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194711.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">很郁闷这个chrome用户干嘛的，如果真用这个，那得确定你跑的环境要允许你添加一个user出来，很明显不行,</span><br><span class=\"line\">这样导致整个alpine-chrome服务权限都是乱的「chrome用户的」,最明显的是无法读写文件，因为你这个add chrome没权限。</span><br><span class=\"line\"></span><br><span class=\"line\">最直接的，去掉就好了。</span><br><span class=\"line\"></span><br><span class=\"line\">果然去掉后，跑docker就可以了</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://hub.docker.com/r/zenika/alpine-chrome\">docker镜像地址</a></p>\n<p>这个是可以了，但是有一个新的问题，图像失真了，再去查github源码，坑那，压根没有装全文字库，只简单装了lib***的库。</p>\n<h3 id=\"再尝试「自己搞个docker-images」\"><a class=\"header-anchor\" href=\"#再尝试「自己搞个docker-images」\">¶</a>再尝试「自己搞个docker images」</h3>\n<blockquote>\n<p>别人都能搞，为何我不可以勒</p>\n</blockquote>\n<h3 id=\"分析：\"><a class=\"header-anchor\" href=\"#分析：\">¶</a>分析：</h3>\n<ul>\n<li>本地跑这个服务是ok的，那chrome就是依赖macos/linux系统的</li>\n<li>那可以搞个linux系统，再装个chrome</li>\n<li>最后把字体装完就ok了</li>\n<li>最后的最后，想办法直接可以用这个docker，不用启动服务，也就是说docker run之后有了结果，直接rm掉。</li>\n</ul>\n<h3 id=\"思路：\"><a class=\"header-anchor\" href=\"#思路：\">¶</a>思路：</h3>\n<ul>\n<li>1、搞个docker debain系统</li>\n<li>2、想办法把chrome装上</li>\n<li>3、在里面跑一个测试，看能否生成图片</li>\n<li>4、安装缺失的字体</li>\n<li>5、container跑起来</li>\n<li>6、导出container，再导入到本地的images；让container变成images</li>\n<li>7、自己搞个Dockerfile，把「RUN」接口留出来，方便可以直接跑起来</li>\n<li>8、再把搞好的images导出来用就可以了。</li>\n</ul>\n<h3 id=\"步骤：\"><a class=\"header-anchor\" href=\"#步骤：\">¶</a>步骤：</h3>\n<h4 id=\"1\"><a class=\"header-anchor\" href=\"#1\">¶</a>1</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull debian</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-3-4-5\"><a class=\"header-anchor\" href=\"#2-3-4-5\">¶</a>2/3/4/5</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、进入系统</span><br><span class=\"line\">docker exec -it XXXXX &#x2F;bin&#x2F;bash</span><br><span class=\"line\">2、更新源</span><br><span class=\"line\">apt-get update</span><br><span class=\"line\">3、下载wget</span><br><span class=\"line\">apt-get install wget</span><br><span class=\"line\">4、下载chrome linux版本的</span><br><span class=\"line\">wget https:&#x2F;&#x2F;dl.google.com&#x2F;linux&#x2F;direct&#x2F;google-chrome-stable_current_amd64.deb</span><br><span class=\"line\">5、安装chrome</span><br><span class=\"line\"> dpkg -i ******.deb</span><br><span class=\"line\"> 解决依赖关系：</span><br><span class=\"line\">    apt-get -f install</span><br><span class=\"line\">6、跑一把发现汉字变问好「？」了</span><br><span class=\"line\">7、安装缺失的字体</span><br><span class=\"line\">apt-get install ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br></pre></td></tr></table></figure>\n<h4 id=\"6导出container\"><a class=\"header-anchor\" href=\"#6导出container\">¶</a>6导出container</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、导出container</span><br><span class=\"line\">docker export container_name &gt; chrome.tar</span><br><span class=\"line\">2、导入到images中</span><br><span class=\"line\">docker load &lt; chrome.tar</span><br></pre></td></tr></table></figure>\n<h4 id=\"7自己搞Dockerfile-预留「RUN」接口\"><a class=\"header-anchor\" href=\"#7自己搞Dockerfile-预留「RUN」接口\">¶</a>7自己搞Dockerfile,预留「RUN」接口</h4>\n<p>Dockerfile文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#这个是上一步导入的images</span><br><span class=\"line\">FROM gogoowang&#x2F;chrome:v1</span><br><span class=\"line\">RUN mkdir -p &#x2F;home</span><br><span class=\"line\">WORKDIR &#x2F;home</span><br><span class=\"line\">ENTRYPOINT [&quot;chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>构建成镜像：docker build -t gogoo/chrome:v2 .</p>\n</blockquote>\n<p>PS:「/home」的含义就是这个images的工作目录是/home文件夹下面</p>\n<h4 id=\"8跑一把，收工\"><a class=\"header-anchor\" href=\"#8跑一把，收工\">¶</a>8跑一把，收工</h4>\n<h3 id=\"注意点：\"><a class=\"header-anchor\" href=\"#注意点：\">¶</a>注意点：</h3>\n<h4 id=\"PS-1\"><a class=\"header-anchor\" href=\"#PS-1\">¶</a>PS-1</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、错误❌</span><br><span class=\"line\">docker container run -it --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class=\"line\">2、正确</span><br><span class=\"line\">docker container run -i --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot&#x3D;&#x2F;home&#x2F;xx.png --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class=\"line\"></span><br><span class=\"line\">少一个 -t，这个 -t：再搞一个临时的TTy来跑程序，既然是后台跑的，那就没必要了</span><br></pre></td></tr></table></figure>\n<h4 id=\"PS-2\"><a class=\"header-anchor\" href=\"#PS-2\">¶</a>PS-2</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker container run -i --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot&#x3D;&#x2F;home&#x2F;xx.png --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class=\"line\"></span><br><span class=\"line\">1、关于这个-v的问题,后面就固定了，具体见Dockerfile中</span><br><span class=\"line\">2、--screenshot路径问题，既然是docker镜像，那就得填个docker镜像中的地址，那就是&#x2F;home下面了</span><br></pre></td></tr></table></figure>\n<h3 id=\"优化后一键脚本\"><a class=\"header-anchor\" href=\"#优化后一键脚本\">¶</a>优化后一键脚本</h3>\n<p>Dockerfile文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM debian</span><br><span class=\"line\">RUN apt-get update </span><br><span class=\"line\">RUN apt-get install -y wget </span><br><span class=\"line\">RUN wget https:&#x2F;&#x2F;dl.google.com&#x2F;linux&#x2F;direct&#x2F;google-chrome-stable_current_amd64.deb </span><br><span class=\"line\">RUN dpkg -i google-chrome-stable_current_amd64.deb || true</span><br><span class=\"line\">RUN apt-get -f -y install</span><br><span class=\"line\">RUN apt-get install -y ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br><span class=\"line\">RUN mkdir -p &#x2F;home</span><br><span class=\"line\">WORKDIR &#x2F;home</span><br><span class=\"line\">ENTRYPOINT [&quot;&#x2F;opt&#x2F;google&#x2F;chrome&#x2F;chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>\n<p>构建：</p>\n<blockquote>\n<p>docker build -t google-chrome:latest .</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>最近在搞一个需求：html「文件」渲染成png/jpg；chrome不能装在服务器中，可以打成docker镜像。<br>\n说到这个，很多人肯定说很容易啊，chrome headless有现成的，直接用，它是不香么。<br>\n然而事情并没有这么简单；</p>\n</blockquote>\n<h3 id=\"难点：\"><a class=\"header-anchor\" href=\"#难点：\">¶</a>难点：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、服务器中不能装chrome</span><br><span class=\"line\"><span class=\"number\">2</span>、chrome必须打在docker里面</span><br><span class=\"line\"><span class=\"number\">3</span>、渲染效果要和在本地效果一样：图片不能丢失字体，不能失真。</span><br><span class=\"line\"><span class=\"number\">4</span>、不能启动新的服务</span><br></pre></td></tr></table></figure>","more":"<h3 id=\"切入点：\"><a class=\"header-anchor\" href=\"#切入点：\">¶</a>切入点：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker &amp;&amp; chrome</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>so先去搜一把有没有现成的可用？</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-193745.png\" alt=\"\"></p>\n<p>分析分析吧：</p>\n<ul>\n<li><a href=\"https://github.com/browserless/chrome\">browserless</a></li>\n<li><a href=\"https://github.com/puppeteer/puppeteer\">puppeteer</a></li>\n<li><a href=\"https://github.com/prisma-archive/chromeless\">prisma-archive</a><br>\n…\n<ul>\n<li>适合启动服务，然后进行测试或者跑服务</li>\n<li>入参数为url</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>所以上述的基本不符合需求，再寻找…</p>\n</blockquote>\n<h3 id=\"Zenika-alpine-chrome\"><a class=\"header-anchor\" href=\"#Zenika-alpine-chrome\">¶</a><a href=\"https://github.com/Zenika/alpine-chrome\">Zenika/alpine-chrome</a></h3>\n<blockquote>\n<p>看起来可行：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194452.png\" alt=\"\"></p>\n<p>这个经过验证总会有一个错误：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[1110&#x2F;031547.366909:ERROR:bus.cc(393)] Failed to connect to the bus: Failed to connect to socket &#x2F;var&#x2F;run&#x2F;dbus&#x2F;system_bus_socket: No such file or directory</span><br><span class=\"line\">[1110&#x2F;031547.367451:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class=\"line\">[1110&#x2F;031547.437879:WARNING:dns_config_service_posix.cc(342)] Failed to read DnsConfig.</span><br><span class=\"line\">[1110&#x2F;031549.073431:ERROR:headless_shell.cc(591)] Writing to file code&#x2F;ss.png was unsuccessful, could not open file: FILE_ERROR_ACCESS_DENIED</span><br></pre></td></tr></table></figure>\n<p>文件没权限哦，尴尬了,再修正：</p>\n<blockquote>\n<p>发现源码有一段添加了用户，汗，太搞了.</p>\n</blockquote>\n<p><a href=\"https://github.com/Zenika/alpine-chrome/blob/master/Dockerfile#L38\">点击查看</a></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-194711.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">很郁闷这个chrome用户干嘛的，如果真用这个，那得确定你跑的环境要允许你添加一个user出来，很明显不行,</span><br><span class=\"line\">这样导致整个alpine-chrome服务权限都是乱的「chrome用户的」,最明显的是无法读写文件，因为你这个add chrome没权限。</span><br><span class=\"line\"></span><br><span class=\"line\">最直接的，去掉就好了。</span><br><span class=\"line\"></span><br><span class=\"line\">果然去掉后，跑docker就可以了</span><br></pre></td></tr></table></figure>\n<p><a href=\"https://hub.docker.com/r/zenika/alpine-chrome\">docker镜像地址</a></p>\n<p>这个是可以了，但是有一个新的问题，图像失真了，再去查github源码，坑那，压根没有装全文字库，只简单装了lib***的库。</p>\n<h3 id=\"再尝试「自己搞个docker-images」\"><a class=\"header-anchor\" href=\"#再尝试「自己搞个docker-images」\">¶</a>再尝试「自己搞个docker images」</h3>\n<blockquote>\n<p>别人都能搞，为何我不可以勒</p>\n</blockquote>\n<h3 id=\"分析：\"><a class=\"header-anchor\" href=\"#分析：\">¶</a>分析：</h3>\n<ul>\n<li>本地跑这个服务是ok的，那chrome就是依赖macos/linux系统的</li>\n<li>那可以搞个linux系统，再装个chrome</li>\n<li>最后把字体装完就ok了</li>\n<li>最后的最后，想办法直接可以用这个docker，不用启动服务，也就是说docker run之后有了结果，直接rm掉。</li>\n</ul>\n<h3 id=\"思路：\"><a class=\"header-anchor\" href=\"#思路：\">¶</a>思路：</h3>\n<ul>\n<li>1、搞个docker debain系统</li>\n<li>2、想办法把chrome装上</li>\n<li>3、在里面跑一个测试，看能否生成图片</li>\n<li>4、安装缺失的字体</li>\n<li>5、container跑起来</li>\n<li>6、导出container，再导入到本地的images；让container变成images</li>\n<li>7、自己搞个Dockerfile，把「RUN」接口留出来，方便可以直接跑起来</li>\n<li>8、再把搞好的images导出来用就可以了。</li>\n</ul>\n<h3 id=\"步骤：\"><a class=\"header-anchor\" href=\"#步骤：\">¶</a>步骤：</h3>\n<h4 id=\"1\"><a class=\"header-anchor\" href=\"#1\">¶</a>1</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull debian</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-3-4-5\"><a class=\"header-anchor\" href=\"#2-3-4-5\">¶</a>2/3/4/5</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、进入系统</span><br><span class=\"line\">docker exec -it XXXXX &#x2F;bin&#x2F;bash</span><br><span class=\"line\">2、更新源</span><br><span class=\"line\">apt-get update</span><br><span class=\"line\">3、下载wget</span><br><span class=\"line\">apt-get install wget</span><br><span class=\"line\">4、下载chrome linux版本的</span><br><span class=\"line\">wget https:&#x2F;&#x2F;dl.google.com&#x2F;linux&#x2F;direct&#x2F;google-chrome-stable_current_amd64.deb</span><br><span class=\"line\">5、安装chrome</span><br><span class=\"line\"> dpkg -i ******.deb</span><br><span class=\"line\"> 解决依赖关系：</span><br><span class=\"line\">    apt-get -f install</span><br><span class=\"line\">6、跑一把发现汉字变问好「？」了</span><br><span class=\"line\">7、安装缺失的字体</span><br><span class=\"line\">apt-get install ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br></pre></td></tr></table></figure>\n<h4 id=\"6导出container\"><a class=\"header-anchor\" href=\"#6导出container\">¶</a>6导出container</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、导出container</span><br><span class=\"line\">docker export container_name &gt; chrome.tar</span><br><span class=\"line\">2、导入到images中</span><br><span class=\"line\">docker load &lt; chrome.tar</span><br></pre></td></tr></table></figure>\n<h4 id=\"7自己搞Dockerfile-预留「RUN」接口\"><a class=\"header-anchor\" href=\"#7自己搞Dockerfile-预留「RUN」接口\">¶</a>7自己搞Dockerfile,预留「RUN」接口</h4>\n<p>Dockerfile文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#这个是上一步导入的images</span><br><span class=\"line\">FROM gogoowang&#x2F;chrome:v1</span><br><span class=\"line\">RUN mkdir -p &#x2F;home</span><br><span class=\"line\">WORKDIR &#x2F;home</span><br><span class=\"line\">ENTRYPOINT [&quot;chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>构建成镜像：docker build -t gogoo/chrome:v2 .</p>\n</blockquote>\n<p>PS:「/home」的含义就是这个images的工作目录是/home文件夹下面</p>\n<h4 id=\"8跑一把，收工\"><a class=\"header-anchor\" href=\"#8跑一把，收工\">¶</a>8跑一把，收工</h4>\n<h3 id=\"注意点：\"><a class=\"header-anchor\" href=\"#注意点：\">¶</a>注意点：</h3>\n<h4 id=\"PS-1\"><a class=\"header-anchor\" href=\"#PS-1\">¶</a>PS-1</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、错误❌</span><br><span class=\"line\">docker container run -it --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class=\"line\">2、正确</span><br><span class=\"line\">docker container run -i --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot&#x3D;&#x2F;home&#x2F;xx.png --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class=\"line\"></span><br><span class=\"line\">少一个 -t，这个 -t：再搞一个临时的TTy来跑程序，既然是后台跑的，那就没必要了</span><br></pre></td></tr></table></figure>\n<h4 id=\"PS-2\"><a class=\"header-anchor\" href=\"#PS-2\">¶</a>PS-2</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker container run -i --rm -v &#x2F;tmp:&#x2F;home gogoowang&#x2F;chrome:v1 --no-sandbox --screenshot&#x3D;&#x2F;home&#x2F;xx.png --hide-scrollbars &#x2F;XXXX&#x2F;XXXX.html</span><br><span class=\"line\"></span><br><span class=\"line\">1、关于这个-v的问题,后面就固定了，具体见Dockerfile中</span><br><span class=\"line\">2、--screenshot路径问题，既然是docker镜像，那就得填个docker镜像中的地址，那就是&#x2F;home下面了</span><br></pre></td></tr></table></figure>\n<h3 id=\"优化后一键脚本\"><a class=\"header-anchor\" href=\"#优化后一键脚本\">¶</a>优化后一键脚本</h3>\n<p>Dockerfile文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM debian</span><br><span class=\"line\">RUN apt-get update </span><br><span class=\"line\">RUN apt-get install -y wget </span><br><span class=\"line\">RUN wget https:&#x2F;&#x2F;dl.google.com&#x2F;linux&#x2F;direct&#x2F;google-chrome-stable_current_amd64.deb </span><br><span class=\"line\">RUN dpkg -i google-chrome-stable_current_amd64.deb || true</span><br><span class=\"line\">RUN apt-get -f -y install</span><br><span class=\"line\">RUN apt-get install -y ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy</span><br><span class=\"line\">RUN mkdir -p &#x2F;home</span><br><span class=\"line\">WORKDIR &#x2F;home</span><br><span class=\"line\">ENTRYPOINT [&quot;&#x2F;opt&#x2F;google&#x2F;chrome&#x2F;chrome&quot;,&quot;--headless&quot;,&quot;--disable-gpu&quot;]</span><br></pre></td></tr></table></figure>\n<p>构建：</p>\n<blockquote>\n<p>docker build -t google-chrome:latest .</p>\n</blockquote>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-193745.png","popularPost_tmp_gaData":{"updated":"Tue Nov 10 2020 19:25:32 GMT+0800 (中国标准时间)","title":"「17」chrome headless「截图/PDF/DOM...」","path":"archives/5544baea.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20201110-193745.png","excerpt":"<blockquote>\n<p>最近在搞一个需求：html「文件」渲染成png/jpg；chrome不能装在服务器中，可以打成docker镜像。<br>\n说到这个，很多人肯定说很容易啊，chrome headless有现成的，直接用，它是不香么。<br>\n然而事情并没有这么简单；</p>\n</blockquote>\n<h3 id=\"难点：\"><a class=\"header-anchor\" href=\"#难点：\">¶</a>难点：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、服务器中不能装chrome</span><br><span class=\"line\"><span class=\"number\">2</span>、chrome必须打在docker里面</span><br><span class=\"line\"><span class=\"number\">3</span>、渲染效果要和在本地效果一样：图片不能丢失字体，不能失真。</span><br><span class=\"line\"><span class=\"number\">4</span>、不能启动新的服务</span><br></pre></td></tr></table></figure>","date":{"_isAMomentObject":true,"_i":"2020-11-10T11:25:32.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-10T11:25:32.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Day","chrome"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":3388},{"title":"「18」GPM 初识/设计","date":"2020-11-14T05:09:17.000Z","updated":"2020-11-14T05:09:17.000Z","keywords":"GPM,Go,Go调度器,Go资源调度器","top":true,"abbrlink":"b885f9f7","_content":"\n### 前序\n\n学go有一段时间了，最近总感觉忙碌无为，也该总结下前段时间读源码的一些心得和体会了。\n\nGPM调度算是在Go中比较经典的了，有必要深入学习下。\n\n>[Go GPM设计文档](https://golang.org/s/go11sched)\n\n### GPM设计的由来\n\n一个好的设计，总会伴随发现现有的问题，在解决的基础上考虑场景并提高扩展性，先来了解下Go为何要重新设计GPM这个模型：\n\n<!--more-->\n\n#### 现有的问题：\n```\n1. Single global mutex (Sched.Lock) and centralized state. The mutex protects all goroutine-related operations (creation, completion, rescheduling, etc).\n2. Goroutine (G) hand-off (G.nextg). Worker threads (M's) frequently hand-off runnable goroutines between each other, this may lead to increased latencies and additional overheads. Every M must be able to execute any runnable G, in particular the M that just created the G.\n3. Per-M memory cache (M.mcache). Memory cache and other caches (stack alloc) are associated with all M's, while they need to be associated only with M's running Go code (an M blocked inside of syscall does not need mcache). A ratio between M's running Go code and all M's can be as high as 1:100. This leads to excessive resource consumption (each MCache can suck up up to 2M) and poor data locality.\n4. Aggressive thread blocking/unblocking. In presence of syscalls worker threads are frequently blocked and unblocked. This adds a lot of overhead.\n\n\n1、单一的全局锁和集中的状态.此锁所有g的操作。\n2、g退出。工作中的M频繁的交出正在running的g，导致延迟增加和额外的负载。每个M执行任何g，尤其是M自身创建的g。\n3、M的内存缓存问题。   内存缓存和其它的缓存关联这所有的M，当他们需要关联M来running code时。比率显示M运行的code和所有M的呈1:100。导致很多资源的浪费和内存的贫瘠。\n4、侵略性的加锁，在系统线程频繁的加锁和解锁。这样会造成很大的负载。\n\n```\n\n\n### 设计改变\n\n>以前的设计：\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-1.png)\n\n>新增Processor\n\n ![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-2.png)\n\n\n ### 实现计划\n\n ```\n1. Introduce the P struct (empty for now); implement allp/idlep containers (idlep is mutex-protected for starters); associate a P with M running Go code. Global mutex and atomic state is still preserved.\n2. Move G freelist to P.\n3. Move mcache to P.\n4. Move stackalloc to P.\n5. Move ncgocall/gcstats to P.\n// work-steal工作窃取模式,仍然在全局锁下。\n6. Decentralize run queue, implement work-stealing. Eliminate G hand off. Still under global mutex.\n\n// 移除全局锁，实现分散的检测。\n7. Remove global mutex, implement distributed termination detection, LockOSThread.\n\n// 实现自旋替代提示锁「普通锁」。\n8. Implement spinning instead of prompt blocking/unblocking.\nThe plan may turn out to not work, there are a lot of unexplored details.\n ```\n\n ### Potential Improvement\n\n```\n# 后进先出计划。提供公平和优雅的处理g。\n1. Try out LIFO scheduling, this will improve locality. However, it still must provide some degree of fairness and gracefully handle yielding goroutines.\n\n# 不分配内存和栈空间，直到g跑起来。对于一个新创建的g，需要下面几个函数。 这将创建to完成伴随着较低内存的负载。\n2. Do not allocate G and stack until the goroutine first runs. For a newly created goroutine we need just callerpc, fn, narg, nret and args, that is, about 6 words. This will allow to create a lot of running-to-completion goroutines with significantly lower memory overhead.\n\n# 更好的G-P。尝试入队未锁定的G到P，从上一次运行。\n4. Better locality of G-to-P. Try to enqueue an unblocked G to a P on which it was last running.\n\n# 更好的P-M。尝试执行p，在同样的M最后一次运行。\n5. Better locality of P-to-M. Try to execute P on the same M it was last running.\n\n# M限流创建。调度器创建上千哥M在毫秒之间，直到OS拒绝创建更多的thread。M必须立刻创建，最多创建k*GOMAXPROCS,后续新的M会通过定时器创建。\n6. Throttling of M creation. The scheduler can be easily forced to create thousands of M's per second until OS refuses to create more threads. M’s must be created promptly up to k*GOMAXPROCS, after that new M’s may added by a timer.\n\n```\n\n\n### 参考：\n\n* [GPM g11设计文档](https://golang.org/s/go11scheds)\n\n* [work steal模式](http://supertech.csail.mit.edu/papers/steal.pdf)","source":"_posts/18-GPM初识.md","raw":"---\ntitle: '「18」GPM 初识/设计'\ndate: '2020/11/14 13:09:17'\nupdated: '2020/11/14 13:09:17'\nkeywords: 'GPM,Go,Go调度器,Go资源调度器'\ntop: true\ntags:\n  - Go\n  - GPM\n  - Go源码\nabbrlink: b885f9f7\n---\n\n### 前序\n\n学go有一段时间了，最近总感觉忙碌无为，也该总结下前段时间读源码的一些心得和体会了。\n\nGPM调度算是在Go中比较经典的了，有必要深入学习下。\n\n>[Go GPM设计文档](https://golang.org/s/go11sched)\n\n### GPM设计的由来\n\n一个好的设计，总会伴随发现现有的问题，在解决的基础上考虑场景并提高扩展性，先来了解下Go为何要重新设计GPM这个模型：\n\n<!--more-->\n\n#### 现有的问题：\n```\n1. Single global mutex (Sched.Lock) and centralized state. The mutex protects all goroutine-related operations (creation, completion, rescheduling, etc).\n2. Goroutine (G) hand-off (G.nextg). Worker threads (M's) frequently hand-off runnable goroutines between each other, this may lead to increased latencies and additional overheads. Every M must be able to execute any runnable G, in particular the M that just created the G.\n3. Per-M memory cache (M.mcache). Memory cache and other caches (stack alloc) are associated with all M's, while they need to be associated only with M's running Go code (an M blocked inside of syscall does not need mcache). A ratio between M's running Go code and all M's can be as high as 1:100. This leads to excessive resource consumption (each MCache can suck up up to 2M) and poor data locality.\n4. Aggressive thread blocking/unblocking. In presence of syscalls worker threads are frequently blocked and unblocked. This adds a lot of overhead.\n\n\n1、单一的全局锁和集中的状态.此锁所有g的操作。\n2、g退出。工作中的M频繁的交出正在running的g，导致延迟增加和额外的负载。每个M执行任何g，尤其是M自身创建的g。\n3、M的内存缓存问题。   内存缓存和其它的缓存关联这所有的M，当他们需要关联M来running code时。比率显示M运行的code和所有M的呈1:100。导致很多资源的浪费和内存的贫瘠。\n4、侵略性的加锁，在系统线程频繁的加锁和解锁。这样会造成很大的负载。\n\n```\n\n\n### 设计改变\n\n>以前的设计：\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-1.png)\n\n>新增Processor\n\n ![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-2.png)\n\n\n ### 实现计划\n\n ```\n1. Introduce the P struct (empty for now); implement allp/idlep containers (idlep is mutex-protected for starters); associate a P with M running Go code. Global mutex and atomic state is still preserved.\n2. Move G freelist to P.\n3. Move mcache to P.\n4. Move stackalloc to P.\n5. Move ncgocall/gcstats to P.\n// work-steal工作窃取模式,仍然在全局锁下。\n6. Decentralize run queue, implement work-stealing. Eliminate G hand off. Still under global mutex.\n\n// 移除全局锁，实现分散的检测。\n7. Remove global mutex, implement distributed termination detection, LockOSThread.\n\n// 实现自旋替代提示锁「普通锁」。\n8. Implement spinning instead of prompt blocking/unblocking.\nThe plan may turn out to not work, there are a lot of unexplored details.\n ```\n\n ### Potential Improvement\n\n```\n# 后进先出计划。提供公平和优雅的处理g。\n1. Try out LIFO scheduling, this will improve locality. However, it still must provide some degree of fairness and gracefully handle yielding goroutines.\n\n# 不分配内存和栈空间，直到g跑起来。对于一个新创建的g，需要下面几个函数。 这将创建to完成伴随着较低内存的负载。\n2. Do not allocate G and stack until the goroutine first runs. For a newly created goroutine we need just callerpc, fn, narg, nret and args, that is, about 6 words. This will allow to create a lot of running-to-completion goroutines with significantly lower memory overhead.\n\n# 更好的G-P。尝试入队未锁定的G到P，从上一次运行。\n4. Better locality of G-to-P. Try to enqueue an unblocked G to a P on which it was last running.\n\n# 更好的P-M。尝试执行p，在同样的M最后一次运行。\n5. Better locality of P-to-M. Try to execute P on the same M it was last running.\n\n# M限流创建。调度器创建上千哥M在毫秒之间，直到OS拒绝创建更多的thread。M必须立刻创建，最多创建k*GOMAXPROCS,后续新的M会通过定时器创建。\n6. Throttling of M creation. The scheduler can be easily forced to create thousands of M's per second until OS refuses to create more threads. M’s must be created promptly up to k*GOMAXPROCS, after that new M’s may added by a timer.\n\n```\n\n\n### 参考：\n\n* [GPM g11设计文档](https://golang.org/s/go11scheds)\n\n* [work steal模式](http://supertech.csail.mit.edu/papers/steal.pdf)","slug":"18-GPM初识","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl4000u3ci74mgze9i8","content":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>学go有一段时间了，最近总感觉忙碌无为，也该总结下前段时间读源码的一些心得和体会了。</p>\n<p>GPM调度算是在Go中比较经典的了，有必要深入学习下。</p>\n<blockquote>\n<p><a href=\"https://golang.org/s/go11sched\">Go GPM设计文档</a></p>\n</blockquote>\n<h3 id=\"GPM设计的由来\"><a class=\"header-anchor\" href=\"#GPM设计的由来\">¶</a>GPM设计的由来</h3>\n<p>一个好的设计，总会伴随发现现有的问题，在解决的基础上考虑场景并提高扩展性，先来了解下Go为何要重新设计GPM这个模型：</p>\n<a id=\"more\"></a>\n<h4 id=\"现有的问题：\"><a class=\"header-anchor\" href=\"#现有的问题：\">¶</a>现有的问题：</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. Single global mutex (Sched.Lock) and centralized state. The mutex protects all goroutine-related operations (creation, completion, rescheduling, etc).</span><br><span class=\"line\">2. Goroutine (G) hand-off (G.nextg). Worker threads (M&#39;s) frequently hand-off runnable goroutines between each other, this may lead to increased latencies and additional overheads. Every M must be able to execute any runnable G, in particular the M that just created the G.</span><br><span class=\"line\">3. Per-M memory cache (M.mcache). Memory cache and other caches (stack alloc) are associated with all M&#39;s, while they need to be associated only with M&#39;s running Go code (an M blocked inside of syscall does not need mcache). A ratio between M&#39;s running Go code and all M&#39;s can be as high as 1:100. This leads to excessive resource consumption (each MCache can suck up up to 2M) and poor data locality.</span><br><span class=\"line\">4. Aggressive thread blocking&#x2F;unblocking. In presence of syscalls worker threads are frequently blocked and unblocked. This adds a lot of overhead.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">1、单一的全局锁和集中的状态.此锁所有g的操作。</span><br><span class=\"line\">2、g退出。工作中的M频繁的交出正在running的g，导致延迟增加和额外的负载。每个M执行任何g，尤其是M自身创建的g。</span><br><span class=\"line\">3、M的内存缓存问题。   内存缓存和其它的缓存关联这所有的M，当他们需要关联M来running code时。比率显示M运行的code和所有M的呈1:100。导致很多资源的浪费和内存的贫瘠。</span><br><span class=\"line\">4、侵略性的加锁，在系统线程频繁的加锁和解锁。这样会造成很大的负载。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"设计改变\"><a class=\"header-anchor\" href=\"#设计改变\">¶</a>设计改变</h3>\n<blockquote>\n<p>以前的设计：<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-1.png\" alt=\"\"></p>\n</blockquote>\n<blockquote>\n<p>新增Processor</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-2.png\" alt=\"\"></p>\n<h3 id=\"实现计划\"><a class=\"header-anchor\" href=\"#实现计划\">¶</a>实现计划</h3>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. Introduce the P struct (empty for now); implement allp&#x2F;idlep containers (idlep is mutex-protected for starters); associate a P with M running Go code. Global mutex and atomic state is still preserved.</span><br><span class=\"line\">2. Move G freelist to P.</span><br><span class=\"line\">3. Move mcache to P.</span><br><span class=\"line\">4. Move stackalloc to P.</span><br><span class=\"line\">5. Move ncgocall&#x2F;gcstats to P.</span><br><span class=\"line\">&#x2F;&#x2F; work-steal工作窃取模式,仍然在全局锁下。</span><br><span class=\"line\">6. Decentralize run queue, implement work-stealing. Eliminate G hand off. Still under global mutex.</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; 移除全局锁，实现分散的检测。</span><br><span class=\"line\">7. Remove global mutex, implement distributed termination detection, LockOSThread.</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; 实现自旋替代提示锁「普通锁」。</span><br><span class=\"line\">8. Implement spinning instead of prompt blocking&#x2F;unblocking.</span><br><span class=\"line\">The plan may turn out to not work, there are a lot of unexplored details.</span><br></pre></td></tr></table></figure>\n<h3 id=\"Potential-Improvement\"><a class=\"header-anchor\" href=\"#Potential-Improvement\">¶</a>Potential Improvement</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 后进先出计划。提供公平和优雅的处理g。</span><br><span class=\"line\">1. Try out LIFO scheduling, this will improve locality. However, it still must provide some degree of fairness and gracefully handle yielding goroutines.</span><br><span class=\"line\"></span><br><span class=\"line\"># 不分配内存和栈空间，直到g跑起来。对于一个新创建的g，需要下面几个函数。 这将创建to完成伴随着较低内存的负载。</span><br><span class=\"line\">2. Do not allocate G and stack until the goroutine first runs. For a newly created goroutine we need just callerpc, fn, narg, nret and args, that is, about 6 words. This will allow to create a lot of running-to-completion goroutines with significantly lower memory overhead.</span><br><span class=\"line\"></span><br><span class=\"line\"># 更好的G-P。尝试入队未锁定的G到P，从上一次运行。</span><br><span class=\"line\">4. Better locality of G-to-P. Try to enqueue an unblocked G to a P on which it was last running.</span><br><span class=\"line\"></span><br><span class=\"line\"># 更好的P-M。尝试执行p，在同样的M最后一次运行。</span><br><span class=\"line\">5. Better locality of P-to-M. Try to execute P on the same M it was last running.</span><br><span class=\"line\"></span><br><span class=\"line\"># M限流创建。调度器创建上千哥M在毫秒之间，直到OS拒绝创建更多的thread。M必须立刻创建，最多创建k*GOMAXPROCS,后续新的M会通过定时器创建。</span><br><span class=\"line\">6. Throttling of M creation. The scheduler can be easily forced to create thousands of M&#39;s per second until OS refuses to create more threads. M’s must be created promptly up to k*GOMAXPROCS, after that new M’s may added by a timer.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"参考：\"><a class=\"header-anchor\" href=\"#参考：\">¶</a>参考：</h3>\n<ul>\n<li>\n<p><a href=\"https://golang.org/s/go11scheds\">GPM g11设计文档</a></p>\n</li>\n<li>\n<p><a href=\"http://supertech.csail.mit.edu/papers/steal.pdf\">work steal模式</a></p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>学go有一段时间了，最近总感觉忙碌无为，也该总结下前段时间读源码的一些心得和体会了。</p>\n<p>GPM调度算是在Go中比较经典的了，有必要深入学习下。</p>\n<blockquote>\n<p><a href=\"https://golang.org/s/go11sched\">Go GPM设计文档</a></p>\n</blockquote>\n<h3 id=\"GPM设计的由来\"><a class=\"header-anchor\" href=\"#GPM设计的由来\">¶</a>GPM设计的由来</h3>\n<p>一个好的设计，总会伴随发现现有的问题，在解决的基础上考虑场景并提高扩展性，先来了解下Go为何要重新设计GPM这个模型：</p>","more":"<h4 id=\"现有的问题：\"><a class=\"header-anchor\" href=\"#现有的问题：\">¶</a>现有的问题：</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. Single global mutex (Sched.Lock) and centralized state. The mutex protects all goroutine-related operations (creation, completion, rescheduling, etc).</span><br><span class=\"line\">2. Goroutine (G) hand-off (G.nextg). Worker threads (M&#39;s) frequently hand-off runnable goroutines between each other, this may lead to increased latencies and additional overheads. Every M must be able to execute any runnable G, in particular the M that just created the G.</span><br><span class=\"line\">3. Per-M memory cache (M.mcache). Memory cache and other caches (stack alloc) are associated with all M&#39;s, while they need to be associated only with M&#39;s running Go code (an M blocked inside of syscall does not need mcache). A ratio between M&#39;s running Go code and all M&#39;s can be as high as 1:100. This leads to excessive resource consumption (each MCache can suck up up to 2M) and poor data locality.</span><br><span class=\"line\">4. Aggressive thread blocking&#x2F;unblocking. In presence of syscalls worker threads are frequently blocked and unblocked. This adds a lot of overhead.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">1、单一的全局锁和集中的状态.此锁所有g的操作。</span><br><span class=\"line\">2、g退出。工作中的M频繁的交出正在running的g，导致延迟增加和额外的负载。每个M执行任何g，尤其是M自身创建的g。</span><br><span class=\"line\">3、M的内存缓存问题。   内存缓存和其它的缓存关联这所有的M，当他们需要关联M来running code时。比率显示M运行的code和所有M的呈1:100。导致很多资源的浪费和内存的贫瘠。</span><br><span class=\"line\">4、侵略性的加锁，在系统线程频繁的加锁和解锁。这样会造成很大的负载。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"设计改变\"><a class=\"header-anchor\" href=\"#设计改变\">¶</a>设计改变</h3>\n<blockquote>\n<p>以前的设计：<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-1.png\" alt=\"\"></p>\n</blockquote>\n<blockquote>\n<p>新增Processor</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-2.png\" alt=\"\"></p>\n<h3 id=\"实现计划\"><a class=\"header-anchor\" href=\"#实现计划\">¶</a>实现计划</h3>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. Introduce the P struct (empty for now); implement allp&#x2F;idlep containers (idlep is mutex-protected for starters); associate a P with M running Go code. Global mutex and atomic state is still preserved.</span><br><span class=\"line\">2. Move G freelist to P.</span><br><span class=\"line\">3. Move mcache to P.</span><br><span class=\"line\">4. Move stackalloc to P.</span><br><span class=\"line\">5. Move ncgocall&#x2F;gcstats to P.</span><br><span class=\"line\">&#x2F;&#x2F; work-steal工作窃取模式,仍然在全局锁下。</span><br><span class=\"line\">6. Decentralize run queue, implement work-stealing. Eliminate G hand off. Still under global mutex.</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; 移除全局锁，实现分散的检测。</span><br><span class=\"line\">7. Remove global mutex, implement distributed termination detection, LockOSThread.</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; 实现自旋替代提示锁「普通锁」。</span><br><span class=\"line\">8. Implement spinning instead of prompt blocking&#x2F;unblocking.</span><br><span class=\"line\">The plan may turn out to not work, there are a lot of unexplored details.</span><br></pre></td></tr></table></figure>\n<h3 id=\"Potential-Improvement\"><a class=\"header-anchor\" href=\"#Potential-Improvement\">¶</a>Potential Improvement</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 后进先出计划。提供公平和优雅的处理g。</span><br><span class=\"line\">1. Try out LIFO scheduling, this will improve locality. However, it still must provide some degree of fairness and gracefully handle yielding goroutines.</span><br><span class=\"line\"></span><br><span class=\"line\"># 不分配内存和栈空间，直到g跑起来。对于一个新创建的g，需要下面几个函数。 这将创建to完成伴随着较低内存的负载。</span><br><span class=\"line\">2. Do not allocate G and stack until the goroutine first runs. For a newly created goroutine we need just callerpc, fn, narg, nret and args, that is, about 6 words. This will allow to create a lot of running-to-completion goroutines with significantly lower memory overhead.</span><br><span class=\"line\"></span><br><span class=\"line\"># 更好的G-P。尝试入队未锁定的G到P，从上一次运行。</span><br><span class=\"line\">4. Better locality of G-to-P. Try to enqueue an unblocked G to a P on which it was last running.</span><br><span class=\"line\"></span><br><span class=\"line\"># 更好的P-M。尝试执行p，在同样的M最后一次运行。</span><br><span class=\"line\">5. Better locality of P-to-M. Try to execute P on the same M it was last running.</span><br><span class=\"line\"></span><br><span class=\"line\"># M限流创建。调度器创建上千哥M在毫秒之间，直到OS拒绝创建更多的thread。M必须立刻创建，最多创建k*GOMAXPROCS,后续新的M会通过定时器创建。</span><br><span class=\"line\">6. Throttling of M creation. The scheduler can be easily forced to create thousands of M&#39;s per second until OS refuses to create more threads. M’s must be created promptly up to k*GOMAXPROCS, after that new M’s may added by a timer.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"参考：\"><a class=\"header-anchor\" href=\"#参考：\">¶</a>参考：</h3>\n<ul>\n<li>\n<p><a href=\"https://golang.org/s/go11scheds\">GPM g11设计文档</a></p>\n</li>\n<li>\n<p><a href=\"http://supertech.csail.mit.edu/papers/steal.pdf\">work steal模式</a></p>\n</li>\n</ul>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-1.png","popularPost_tmp_gaData":{"updated":"Sat Nov 14 2020 13:09:17 GMT+0800 (中国标准时间)","title":"「18」GPM 初识/设计","path":"archives/b885f9f7.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-1.png","excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>学go有一段时间了，最近总感觉忙碌无为，也该总结下前段时间读源码的一些心得和体会了。</p>\n<p>GPM调度算是在Go中比较经典的了，有必要深入学习下。</p>\n<blockquote>\n<p><a href=\"https://golang.org/s/go11sched\">Go GPM设计文档</a></p>\n</blockquote>\n<h3 id=\"GPM设计的由来\"><a class=\"header-anchor\" href=\"#GPM设计的由来\">¶</a>GPM设计的由来</h3>\n<p>一个好的设计，总会伴随发现现有的问题，在解决的基础上考虑场景并提高扩展性，先来了解下Go为何要重新设计GPM这个模型：</p>","date":{"_isAMomentObject":true,"_i":"2020-11-14T05:09:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-14T05:09:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","GPM","Go源码"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":2876},{"title":"「19」GPM 调度流程","date":"2020-11-16T13:09:17.000Z","updated":"2020-11-16T13:09:17.000Z","keywords":"GPM,Go,Go调度器,Go资源调度器","abbrlink":"5c6a362f","_content":"\n工欲善其事，必先知其所以然......\n学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获.\n\n### 函数& 变量初识\n>[challenge]: 以下多少是一看就知道在GPM中作用的?\n\n<!--more-->\n\n>go version: 1.14.3\n\n#### 函数\n\n> /proc.go\n* main\n* sysmon\n* findrunnable\n* gopark「1.1」\n* gosched 「1.2」\n* mstart\n* wakep\n* schedule\n* cpuinit\n* schedinit\n* ready\n* readgstatus\n* startm\n* pollWork\n* injectglist\n* park_m\n* goyield\n* retake\n* globrunqput\n* globrunqputbatch\n* globrunqputhead\n\n#### 变量\n\n> /proc.go\n* m0\n* g0\n* allgs\n* allglock\n\n\n> /runtime2.go\n* g\n* p\n* m\n* allglen\n* allm\n* allp\n* allpLock\n* gomaxprocs\n* sched\n\n\n\n> /runtime2.go 常量\n* _Grunnable/_Grunning/_Gwaiting.....\n\n### 上述这些函数/变量/常量 what？\n\n写这么多，肯定不是简单的从源码仓库里面超出来，这些是一些比较重要的函数，当然还有很多没有罗列，这里主要想记录，也是思考的点：\n\n* GPM为何会有这么多的状态\n* 这些状态之间是如何配合和协调的\n* 著名的工作偷取「P」是怎么操作的\n* 如果让你设计，你应该会怎么设计GPM这个调度的过程「🏁重点」\n\n### 切入点\n* main:入口函数\n* sysmon：监控调度线程\n* schedule：真实的调度器逻辑\n* m0/g0：特殊的存在体\n\n\n### 如何开始？\n\n>简单点，从main开始.\n\n\n### 瞎扯\n\n```\n看了很长时间的go源码了，觉得一个好的设计，从来不是简单的学习别人的源码，\n更多的是学习源码的设计思路和当时设计时是基于哪种场景下的。\n\n考虑更多的场景，有没有其它的设计思路，可能没有现有的设计更出色，但更加适合别的场景。\n```\n\n### 未完待续.","source":"_posts/19-GPM调度流程.md","raw":"---\ntitle: 「19」GPM 调度流程\ndate: '2020/11/16 21:09:17'\nupdated: '2020/11/16 21:09:17'\nkeywords: 'GPM,Go,Go调度器,Go资源调度器'\ntags:\n  - Go\n  - GPM\n  - Go源码\nabbrlink: 5c6a362f\n---\n\n工欲善其事，必先知其所以然......\n学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获.\n\n### 函数& 变量初识\n>[challenge]: 以下多少是一看就知道在GPM中作用的?\n\n<!--more-->\n\n>go version: 1.14.3\n\n#### 函数\n\n> /proc.go\n* main\n* sysmon\n* findrunnable\n* gopark「1.1」\n* gosched 「1.2」\n* mstart\n* wakep\n* schedule\n* cpuinit\n* schedinit\n* ready\n* readgstatus\n* startm\n* pollWork\n* injectglist\n* park_m\n* goyield\n* retake\n* globrunqput\n* globrunqputbatch\n* globrunqputhead\n\n#### 变量\n\n> /proc.go\n* m0\n* g0\n* allgs\n* allglock\n\n\n> /runtime2.go\n* g\n* p\n* m\n* allglen\n* allm\n* allp\n* allpLock\n* gomaxprocs\n* sched\n\n\n\n> /runtime2.go 常量\n* _Grunnable/_Grunning/_Gwaiting.....\n\n### 上述这些函数/变量/常量 what？\n\n写这么多，肯定不是简单的从源码仓库里面超出来，这些是一些比较重要的函数，当然还有很多没有罗列，这里主要想记录，也是思考的点：\n\n* GPM为何会有这么多的状态\n* 这些状态之间是如何配合和协调的\n* 著名的工作偷取「P」是怎么操作的\n* 如果让你设计，你应该会怎么设计GPM这个调度的过程「🏁重点」\n\n### 切入点\n* main:入口函数\n* sysmon：监控调度线程\n* schedule：真实的调度器逻辑\n* m0/g0：特殊的存在体\n\n\n### 如何开始？\n\n>简单点，从main开始.\n\n\n### 瞎扯\n\n```\n看了很长时间的go源码了，觉得一个好的设计，从来不是简单的学习别人的源码，\n更多的是学习源码的设计思路和当时设计时是基于哪种场景下的。\n\n考虑更多的场景，有没有其它的设计思路，可能没有现有的设计更出色，但更加适合别的场景。\n```\n\n### 未完待续.","slug":"19-GPM调度流程","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl4000v3ci7cgoncwk8","content":"<p>工欲善其事，必先知其所以然…<br>\n学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获.</p>\n<h3 id=\"函数-变量初识\"><a class=\"header-anchor\" href=\"#函数-变量初识\">¶</a>函数&amp; 变量初识</h3>\n<blockquote></blockquote>\n<a id=\"more\"></a>\n<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h4 id=\"函数\"><a class=\"header-anchor\" href=\"#函数\">¶</a>函数</h4>\n<blockquote>\n<p>/proc.go</p>\n</blockquote>\n<ul>\n<li>main</li>\n<li>sysmon</li>\n<li>findrunnable</li>\n<li>gopark「1.1」</li>\n<li>gosched 「1.2」</li>\n<li>mstart</li>\n<li>wakep</li>\n<li>schedule</li>\n<li>cpuinit</li>\n<li>schedinit</li>\n<li>ready</li>\n<li>readgstatus</li>\n<li>startm</li>\n<li>pollWork</li>\n<li>injectglist</li>\n<li>park_m</li>\n<li>goyield</li>\n<li>retake</li>\n<li>globrunqput</li>\n<li>globrunqputbatch</li>\n<li>globrunqputhead</li>\n</ul>\n<h4 id=\"变量\"><a class=\"header-anchor\" href=\"#变量\">¶</a>变量</h4>\n<blockquote>\n<p>/proc.go</p>\n</blockquote>\n<ul>\n<li>m0</li>\n<li>g0</li>\n<li>allgs</li>\n<li>allglock</li>\n</ul>\n<blockquote>\n<p>/runtime2.go</p>\n</blockquote>\n<ul>\n<li>g</li>\n<li>p</li>\n<li>m</li>\n<li>allglen</li>\n<li>allm</li>\n<li>allp</li>\n<li>allpLock</li>\n<li>gomaxprocs</li>\n<li>sched</li>\n</ul>\n<blockquote>\n<p>/runtime2.go 常量</p>\n</blockquote>\n<ul>\n<li>_Grunnable/_Grunning/_Gwaiting…</li>\n</ul>\n<h3 id=\"上述这些函数-变量-常量-what？\"><a class=\"header-anchor\" href=\"#上述这些函数-变量-常量-what？\">¶</a>上述这些函数/变量/常量 what？</h3>\n<p>写这么多，肯定不是简单的从源码仓库里面超出来，这些是一些比较重要的函数，当然还有很多没有罗列，这里主要想记录，也是思考的点：</p>\n<ul>\n<li>GPM为何会有这么多的状态</li>\n<li>这些状态之间是如何配合和协调的</li>\n<li>著名的工作偷取「P」是怎么操作的</li>\n<li>如果让你设计，你应该会怎么设计GPM这个调度的过程「🏁重点」</li>\n</ul>\n<h3 id=\"切入点\"><a class=\"header-anchor\" href=\"#切入点\">¶</a>切入点</h3>\n<ul>\n<li>main:入口函数</li>\n<li>sysmon：监控调度线程</li>\n<li>schedule：真实的调度器逻辑</li>\n<li>m0/g0：特殊的存在体</li>\n</ul>\n<h3 id=\"如何开始？\"><a class=\"header-anchor\" href=\"#如何开始？\">¶</a>如何开始？</h3>\n<blockquote>\n<p>简单点，从main开始.</p>\n</blockquote>\n<h3 id=\"瞎扯\"><a class=\"header-anchor\" href=\"#瞎扯\">¶</a>瞎扯</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">看了很长时间的go源码了，觉得一个好的设计，从来不是简单的学习别人的源码，</span><br><span class=\"line\">更多的是学习源码的设计思路和当时设计时是基于哪种场景下的。</span><br><span class=\"line\"></span><br><span class=\"line\">考虑更多的场景，有没有其它的设计思路，可能没有现有的设计更出色，但更加适合别的场景。</span><br></pre></td></tr></table></figure>\n<h3 id=\"未完待续\"><a class=\"header-anchor\" href=\"#未完待续\">¶</a>未完待续.</h3>\n","site":{"data":{}},"excerpt":"<p>工欲善其事，必先知其所以然…<br>\n学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获.</p>\n<h3 id=\"函数-变量初识\"><a class=\"header-anchor\" href=\"#函数-变量初识\">¶</a>函数&amp; 变量初识</h3>\n<blockquote></blockquote>","more":"<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h4 id=\"函数\"><a class=\"header-anchor\" href=\"#函数\">¶</a>函数</h4>\n<blockquote>\n<p>/proc.go</p>\n</blockquote>\n<ul>\n<li>main</li>\n<li>sysmon</li>\n<li>findrunnable</li>\n<li>gopark「1.1」</li>\n<li>gosched 「1.2」</li>\n<li>mstart</li>\n<li>wakep</li>\n<li>schedule</li>\n<li>cpuinit</li>\n<li>schedinit</li>\n<li>ready</li>\n<li>readgstatus</li>\n<li>startm</li>\n<li>pollWork</li>\n<li>injectglist</li>\n<li>park_m</li>\n<li>goyield</li>\n<li>retake</li>\n<li>globrunqput</li>\n<li>globrunqputbatch</li>\n<li>globrunqputhead</li>\n</ul>\n<h4 id=\"变量\"><a class=\"header-anchor\" href=\"#变量\">¶</a>变量</h4>\n<blockquote>\n<p>/proc.go</p>\n</blockquote>\n<ul>\n<li>m0</li>\n<li>g0</li>\n<li>allgs</li>\n<li>allglock</li>\n</ul>\n<blockquote>\n<p>/runtime2.go</p>\n</blockquote>\n<ul>\n<li>g</li>\n<li>p</li>\n<li>m</li>\n<li>allglen</li>\n<li>allm</li>\n<li>allp</li>\n<li>allpLock</li>\n<li>gomaxprocs</li>\n<li>sched</li>\n</ul>\n<blockquote>\n<p>/runtime2.go 常量</p>\n</blockquote>\n<ul>\n<li>_Grunnable/_Grunning/_Gwaiting…</li>\n</ul>\n<h3 id=\"上述这些函数-变量-常量-what？\"><a class=\"header-anchor\" href=\"#上述这些函数-变量-常量-what？\">¶</a>上述这些函数/变量/常量 what？</h3>\n<p>写这么多，肯定不是简单的从源码仓库里面超出来，这些是一些比较重要的函数，当然还有很多没有罗列，这里主要想记录，也是思考的点：</p>\n<ul>\n<li>GPM为何会有这么多的状态</li>\n<li>这些状态之间是如何配合和协调的</li>\n<li>著名的工作偷取「P」是怎么操作的</li>\n<li>如果让你设计，你应该会怎么设计GPM这个调度的过程「🏁重点」</li>\n</ul>\n<h3 id=\"切入点\"><a class=\"header-anchor\" href=\"#切入点\">¶</a>切入点</h3>\n<ul>\n<li>main:入口函数</li>\n<li>sysmon：监控调度线程</li>\n<li>schedule：真实的调度器逻辑</li>\n<li>m0/g0：特殊的存在体</li>\n</ul>\n<h3 id=\"如何开始？\"><a class=\"header-anchor\" href=\"#如何开始？\">¶</a>如何开始？</h3>\n<blockquote>\n<p>简单点，从main开始.</p>\n</blockquote>\n<h3 id=\"瞎扯\"><a class=\"header-anchor\" href=\"#瞎扯\">¶</a>瞎扯</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">看了很长时间的go源码了，觉得一个好的设计，从来不是简单的学习别人的源码，</span><br><span class=\"line\">更多的是学习源码的设计思路和当时设计时是基于哪种场景下的。</span><br><span class=\"line\"></span><br><span class=\"line\">考虑更多的场景，有没有其它的设计思路，可能没有现有的设计更出色，但更加适合别的场景。</span><br></pre></td></tr></table></figure>\n<h3 id=\"未完待续\"><a class=\"header-anchor\" href=\"#未完待续\">¶</a>未完待续.</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Mon Nov 16 2020 21:09:17 GMT+0800 (中国标准时间)","title":"「19」GPM 调度流程","path":"archives/5c6a362f.html","eyeCatchImage":null,"excerpt":"<p>工欲善其事，必先知其所以然…<br>\n学习GPM调度之前，先看下源码部分的准备工作吧，不然一脸茫然的看源码，基本不会有太多的收获.</p>\n<h3 id=\"函数-变量初识\"><a class=\"header-anchor\" href=\"#函数-变量初识\">¶</a>函数&amp; 变量初识</h3>\n<blockquote></blockquote>","date":{"_isAMomentObject":true,"_i":"2020-11-16T13:09:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-16T13:09:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","GPM","Go源码"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":756},{"title":"「2」vscode 常见插件及其使用","date":"2020-08-31T05:09:17.000Z","updated":"2020-08-31T05:09:17.000Z","keywords":"vscode,vscode插件。","abbrlink":"8cf3cbca","_content":"\n>vscode中一些常见的坑点...\n\n### 插件\n\n\n#### 样式方面：\n\n* Indent Rainbo\n* Bracket Pair Colorizer # 括号颜色\n* Chinese Language       # 汉化\n<!-- more -->\n\n#### 功能方面\n\n* Git Blame              # Git提交查看\n* Code Spell Checker     # 拼写检查\n* Reload                 # 重新加载\n* Todo Tree              # 代办事项\n* Settings Sync          # 设置同步","source":"_posts/2-vscode-常见问题.md","raw":"---\ntitle: 「2」vscode 常见插件及其使用\ndate: '2020/08/31 13:09:17'\nupdated: '2020/08/31 13:09:17'\nkeywords: 'vscode,vscode插件。'\ntags:\n  - vscode\n  - 工具\nabbrlink: 8cf3cbca\n---\n\n>vscode中一些常见的坑点...\n\n### 插件\n\n\n#### 样式方面：\n\n* Indent Rainbo\n* Bracket Pair Colorizer # 括号颜色\n* Chinese Language       # 汉化\n<!-- more -->\n\n#### 功能方面\n\n* Git Blame              # Git提交查看\n* Code Spell Checker     # 拼写检查\n* Reload                 # 重新加载\n* Todo Tree              # 代办事项\n* Settings Sync          # 设置同步","slug":"2-vscode-常见问题","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl5000y3ci7abp25btb","content":"<blockquote>\n<p>vscode中一些常见的坑点…</p>\n</blockquote>\n<h3 id=\"插件\"><a class=\"header-anchor\" href=\"#插件\">¶</a>插件</h3>\n<h4 id=\"样式方面：\"><a class=\"header-anchor\" href=\"#样式方面：\">¶</a>样式方面：</h4>\n<ul>\n<li>Indent Rainbo</li>\n<li>Bracket Pair Colorizer # 括号颜色</li>\n<li>Chinese Language       # 汉化</li>\n</ul>\n<a id=\"more\"></a>\n<h4 id=\"功能方面\"><a class=\"header-anchor\" href=\"#功能方面\">¶</a>功能方面</h4>\n<ul>\n<li>Git Blame              # Git提交查看</li>\n<li>Code Spell Checker     # 拼写检查</li>\n<li>Reload                 # 重新加载</li>\n<li>Todo Tree              # 代办事项</li>\n<li>Settings Sync          # 设置同步</li>\n</ul>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>vscode中一些常见的坑点…</p>\n</blockquote>\n<h3 id=\"插件\"><a class=\"header-anchor\" href=\"#插件\">¶</a>插件</h3>\n<h4 id=\"样式方面：\"><a class=\"header-anchor\" href=\"#样式方面：\">¶</a>样式方面：</h4>\n<ul>\n<li>Indent Rainbo</li>\n<li>Bracket Pair Colorizer # 括号颜色</li>\n<li>Chinese Language       # 汉化</li>\n</ul>","more":"<h4 id=\"功能方面\"><a class=\"header-anchor\" href=\"#功能方面\">¶</a>功能方面</h4>\n<ul>\n<li>Git Blame              # Git提交查看</li>\n<li>Code Spell Checker     # 拼写检查</li>\n<li>Reload                 # 重新加载</li>\n<li>Todo Tree              # 代办事项</li>\n<li>Settings Sync          # 设置同步</li>\n</ul>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Mon Aug 31 2020 13:09:17 GMT+0800 (中国标准时间)","title":"「2」vscode 常见插件及其使用","path":"archives/8cf3cbca.html","eyeCatchImage":null,"excerpt":"<blockquote>\n<p>vscode中一些常见的坑点…</p>\n</blockquote>\n<h3 id=\"插件\"><a class=\"header-anchor\" href=\"#插件\">¶</a>插件</h3>\n<h4 id=\"样式方面：\"><a class=\"header-anchor\" href=\"#样式方面：\">¶</a>样式方面：</h4>\n<ul>\n<li>Indent Rainbo</li>\n<li>Bracket Pair Colorizer # 括号颜色</li>\n<li>Chinese Language       # 汉化</li>\n</ul>","date":{"_isAMomentObject":true,"_i":"2020-08-31T05:09:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-08-31T05:09:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["vscode","工具"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":162},{"title":"「20」博客诡异事件","date":"2020-11-16T16:09:17.000Z","updated":"2020-11-16T16:09:17.000Z","keywords":"博客","abbrlink":"5ce14ff5","_content":"\n\n\n### 博客CI CD崩了\n>就在刚才修改了部分的config配置，后打了tag push了上去,\n\n>oh......GG了\n<!--more-->\n\n```\nerr: FATAL Something's wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html\nerr: TypeError: Cannot read property 'enable' of undefined\nerr:     at ***/themes/nextTheme/scripts/filters/comment/disqus.js:11:21\nerr:     at Filter.execSync (/***/node_modules/hexo/lib/extend/filter.js:74:28)\nerr:     at Hexo.execFilterSync (/***/node_modules/hexo/lib/hexo/index.js:432:29)\nerr:     at module.exports (***/themes/nextTheme/scripts/events/lib/injects.js:58:8)\nerr:     at Hexo.<anonymous> (***/themes/nextTheme/scripts/events/index.js:9:27)\nerr:     at Hexo.emit (events.js:314:20)\nerr:     at Hexo._generate (/***/node_modules/hexo/lib/hexo/index.js:399:8)\nerr:     at /***/node_modules/hexo/lib/hexo/index.js:249:***\nerr:     at tryCatcher (/***/node_modules/bluebird/js/release/util.js:16:23)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:547:31)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:604:18)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at PromiseArray._resolve (/***/node_modules/bluebird/js/release/promise_array.js:127:19)\nerr:     at PromiseArray._promiseFulfilled (/***/node_modules/bluebird/js/release/promise_array.js:145:14)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:609:26)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at Promise._resolveCallback (/***/node_modules/bluebird/js/release/promise.js:466:57)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:559:17)\nout: INFO  Start processing\nerr: FATAL Something's wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html\nerr: TypeError: Cannot read property 'enable' of undefined\nerr:     at ***/themes/nextTheme/scripts/filters/comment/disqus.js:11:21\nerr:     at Filter.execSync (/***/node_modules/hexo/lib/extend/filter.js:74:28)\nerr:     at Hexo.execFilterSync (/***/node_modules/hexo/lib/hexo/index.js:432:29)\nerr:     at module.exports (***/themes/nextTheme/scripts/events/lib/injects.js:58:8)\nerr:     at Hexo.<anonymous> (***/themes/nextTheme/scripts/events/index.js:9:27)\nerr:     at Hexo.emit (events.js:314:20)\nerr:     at Hexo._generate (/***/node_modules/hexo/lib/hexo/index.js:399:8)\nerr:     at /***/node_modules/hexo/lib/hexo/index.js:249:***\nerr:     at tryCatcher (/***/node_modules/bluebird/js/release/util.js:16:23)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:547:31)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:604:18)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at PromiseArray._resolve (/***/node_modules/bluebird/js/release/promise_array.js:127:19)\nerr:     at PromiseArray._promiseFulfilled (/***/node_modules/bluebird/js/release/promise_array.js:145:14)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:609:26)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at Promise._resolveCallback (/***/node_modules/bluebird/js/release/promise.js:466:57)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:559:17)\n```\n\n简单点，显示没有enable这个属性，，，，我懵了，这部署了多少次了，没有出现这么个错误啊。\n\n先删了js，本地跑ok了，远端挂了，又提示另一个js错误。\n再删一个错误的js,再跑....又挂了!\n\n\n### 排查...\n\n>初步定位为文件没有更到最新\n\n本地ok,服务器部署不起来.....\n\n查下文件scp copy的工作流\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/企业微信20201117-000817@2x.png)\n\n看起来很简单，也很好用，但是呢，大坑来了..........\n当时没有选择是否选择覆盖文件：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/企业微信20201117-001054@2x.png)\n\n### 问题点\n\n没有覆盖配置文件，导致残留或者修改不彻底，同名的始终不修改，导致的问题。\n\nPS：花了半个小时定位这么个rewrite的问题！ 记着吧，提醒自己....\n\n### 参考：\n[copy workflow Github](https://github.com/appleboy/scp-action/blob/master/action.yml#L44)\n[scp copy workflow](https://github.com/marketplace/actions/scp-files)","source":"_posts/20-博客诡异事件.md","raw":"---\ntitle: 「20」博客诡异事件\ndate: '2020/11/17 00:09:17'\nupdated: '2020/11/17 00:09:17'\nkeywords: 博客\ntags:\n  - 博客\n  - Day\nabbrlink: 5ce14ff5\n---\n\n\n\n### 博客CI CD崩了\n>就在刚才修改了部分的config配置，后打了tag push了上去,\n\n>oh......GG了\n<!--more-->\n\n```\nerr: FATAL Something's wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html\nerr: TypeError: Cannot read property 'enable' of undefined\nerr:     at ***/themes/nextTheme/scripts/filters/comment/disqus.js:11:21\nerr:     at Filter.execSync (/***/node_modules/hexo/lib/extend/filter.js:74:28)\nerr:     at Hexo.execFilterSync (/***/node_modules/hexo/lib/hexo/index.js:432:29)\nerr:     at module.exports (***/themes/nextTheme/scripts/events/lib/injects.js:58:8)\nerr:     at Hexo.<anonymous> (***/themes/nextTheme/scripts/events/index.js:9:27)\nerr:     at Hexo.emit (events.js:314:20)\nerr:     at Hexo._generate (/***/node_modules/hexo/lib/hexo/index.js:399:8)\nerr:     at /***/node_modules/hexo/lib/hexo/index.js:249:***\nerr:     at tryCatcher (/***/node_modules/bluebird/js/release/util.js:16:23)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:547:31)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:604:18)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at PromiseArray._resolve (/***/node_modules/bluebird/js/release/promise_array.js:127:19)\nerr:     at PromiseArray._promiseFulfilled (/***/node_modules/bluebird/js/release/promise_array.js:145:14)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:609:26)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at Promise._resolveCallback (/***/node_modules/bluebird/js/release/promise.js:466:57)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:559:17)\nout: INFO  Start processing\nerr: FATAL Something's wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html\nerr: TypeError: Cannot read property 'enable' of undefined\nerr:     at ***/themes/nextTheme/scripts/filters/comment/disqus.js:11:21\nerr:     at Filter.execSync (/***/node_modules/hexo/lib/extend/filter.js:74:28)\nerr:     at Hexo.execFilterSync (/***/node_modules/hexo/lib/hexo/index.js:432:29)\nerr:     at module.exports (***/themes/nextTheme/scripts/events/lib/injects.js:58:8)\nerr:     at Hexo.<anonymous> (***/themes/nextTheme/scripts/events/index.js:9:27)\nerr:     at Hexo.emit (events.js:314:20)\nerr:     at Hexo._generate (/***/node_modules/hexo/lib/hexo/index.js:399:8)\nerr:     at /***/node_modules/hexo/lib/hexo/index.js:249:***\nerr:     at tryCatcher (/***/node_modules/bluebird/js/release/util.js:16:23)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:547:31)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:604:18)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at PromiseArray._resolve (/***/node_modules/bluebird/js/release/promise_array.js:127:19)\nerr:     at PromiseArray._promiseFulfilled (/***/node_modules/bluebird/js/release/promise_array.js:145:14)\nerr:     at Promise._settlePromise (/***/node_modules/bluebird/js/release/promise.js:609:26)\nerr:     at Promise._settlePromise0 (/***/node_modules/bluebird/js/release/promise.js:649:10)\nerr:     at Promise._settlePromises (/***/node_modules/bluebird/js/release/promise.js:729:18)\nerr:     at Promise._fulfill (/***/node_modules/bluebird/js/release/promise.js:673:18)\nerr:     at Promise._resolveCallback (/***/node_modules/bluebird/js/release/promise.js:466:57)\nerr:     at Promise._settlePromiseFromHandler (/***/node_modules/bluebird/js/release/promise.js:559:17)\n```\n\n简单点，显示没有enable这个属性，，，，我懵了，这部署了多少次了，没有出现这么个错误啊。\n\n先删了js，本地跑ok了，远端挂了，又提示另一个js错误。\n再删一个错误的js,再跑....又挂了!\n\n\n### 排查...\n\n>初步定位为文件没有更到最新\n\n本地ok,服务器部署不起来.....\n\n查下文件scp copy的工作流\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/企业微信20201117-000817@2x.png)\n\n看起来很简单，也很好用，但是呢，大坑来了..........\n当时没有选择是否选择覆盖文件：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/企业微信20201117-001054@2x.png)\n\n### 问题点\n\n没有覆盖配置文件，导致残留或者修改不彻底，同名的始终不修改，导致的问题。\n\nPS：花了半个小时定位这么个rewrite的问题！ 记着吧，提醒自己....\n\n### 参考：\n[copy workflow Github](https://github.com/appleboy/scp-action/blob/master/action.yml#L44)\n[scp copy workflow](https://github.com/marketplace/actions/scp-files)","slug":"20-博客诡异事件","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl600103ci777te9qwe","content":"<h3 id=\"博客CI-CD崩了\"><a class=\"header-anchor\" href=\"#博客CI-CD崩了\">¶</a>博客CI CD崩了</h3>\n<blockquote>\n<p>就在刚才修改了部分的config配置，后打了tag push了上去,</p>\n</blockquote>\n<blockquote>\n<p>oh…GG了</p>\n</blockquote>\n<a id=\"more\"></a>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">err: FATAL Something&#39;s wrong. Maybe you can find the solution here: https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</span><br><span class=\"line\">err: TypeError: Cannot read property &#39;enable&#39; of undefined</span><br><span class=\"line\">err:     at ***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;filters&#x2F;comment&#x2F;disqus.js:11:21</span><br><span class=\"line\">err:     at Filter.execSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;extend&#x2F;filter.js:74:28)</span><br><span class=\"line\">err:     at Hexo.execFilterSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:432:29)</span><br><span class=\"line\">err:     at module.exports (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;lib&#x2F;injects.js:58:8)</span><br><span class=\"line\">err:     at Hexo.&lt;anonymous&gt; (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;index.js:9:27)</span><br><span class=\"line\">err:     at Hexo.emit (events.js:314:20)</span><br><span class=\"line\">err:     at Hexo._generate (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:399:8)</span><br><span class=\"line\">err:     at &#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:249:***</span><br><span class=\"line\">err:     at tryCatcher (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;util.js:16:23)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:547:31)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:604:18)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at PromiseArray._resolve (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:127:19)</span><br><span class=\"line\">err:     at PromiseArray._promiseFulfilled (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:145:14)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:609:26)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at Promise._resolveCallback (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:466:57)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:559:17)</span><br><span class=\"line\">out: INFO  Start processing</span><br><span class=\"line\">err: FATAL Something&#39;s wrong. Maybe you can find the solution here: https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</span><br><span class=\"line\">err: TypeError: Cannot read property &#39;enable&#39; of undefined</span><br><span class=\"line\">err:     at ***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;filters&#x2F;comment&#x2F;disqus.js:11:21</span><br><span class=\"line\">err:     at Filter.execSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;extend&#x2F;filter.js:74:28)</span><br><span class=\"line\">err:     at Hexo.execFilterSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:432:29)</span><br><span class=\"line\">err:     at module.exports (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;lib&#x2F;injects.js:58:8)</span><br><span class=\"line\">err:     at Hexo.&lt;anonymous&gt; (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;index.js:9:27)</span><br><span class=\"line\">err:     at Hexo.emit (events.js:314:20)</span><br><span class=\"line\">err:     at Hexo._generate (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:399:8)</span><br><span class=\"line\">err:     at &#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:249:***</span><br><span class=\"line\">err:     at tryCatcher (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;util.js:16:23)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:547:31)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:604:18)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at PromiseArray._resolve (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:127:19)</span><br><span class=\"line\">err:     at PromiseArray._promiseFulfilled (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:145:14)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:609:26)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at Promise._resolveCallback (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:466:57)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:559:17)</span><br></pre></td></tr></table></figure>\n<p>简单点，显示没有enable这个属性，，，，我懵了，这部署了多少次了，没有出现这么个错误啊。</p>\n<p>先删了js，本地跑ok了，远端挂了，又提示另一个js错误。<br>\n再删一个错误的js,再跑…又挂了!</p>\n<h3 id=\"排查…\"><a class=\"header-anchor\" href=\"#排查…\">¶</a>排查…</h3>\n<blockquote>\n<p>初步定位为文件没有更到最新</p>\n</blockquote>\n<p>本地ok,服务器部署不起来…</p>\n<p>查下文件scp copy的工作流</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-000817@2x.png\" alt=\"\"></p>\n<p>看起来很简单，也很好用，但是呢，大坑来了…<br>\n当时没有选择是否选择覆盖文件：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-001054@2x.png\" alt=\"\"></p>\n<h3 id=\"问题点\"><a class=\"header-anchor\" href=\"#问题点\">¶</a>问题点</h3>\n<p>没有覆盖配置文件，导致残留或者修改不彻底，同名的始终不修改，导致的问题。</p>\n<p>PS：花了半个小时定位这么个rewrite的问题！ 记着吧，提醒自己…</p>\n<h3 id=\"参考：\"><a class=\"header-anchor\" href=\"#参考：\">¶</a>参考：</h3>\n<p><a href=\"https://github.com/appleboy/scp-action/blob/master/action.yml#L44\">copy workflow Github</a><br>\n<a href=\"https://github.com/marketplace/actions/scp-files\">scp copy workflow</a></p>\n","site":{"data":{}},"excerpt":"<h3 id=\"博客CI-CD崩了\"><a class=\"header-anchor\" href=\"#博客CI-CD崩了\">¶</a>博客CI CD崩了</h3>\n<blockquote>\n<p>就在刚才修改了部分的config配置，后打了tag push了上去,</p>\n</blockquote>\n<blockquote>\n<p>oh…GG了</p>\n</blockquote>","more":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">err: FATAL Something&#39;s wrong. Maybe you can find the solution here: https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</span><br><span class=\"line\">err: TypeError: Cannot read property &#39;enable&#39; of undefined</span><br><span class=\"line\">err:     at ***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;filters&#x2F;comment&#x2F;disqus.js:11:21</span><br><span class=\"line\">err:     at Filter.execSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;extend&#x2F;filter.js:74:28)</span><br><span class=\"line\">err:     at Hexo.execFilterSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:432:29)</span><br><span class=\"line\">err:     at module.exports (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;lib&#x2F;injects.js:58:8)</span><br><span class=\"line\">err:     at Hexo.&lt;anonymous&gt; (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;index.js:9:27)</span><br><span class=\"line\">err:     at Hexo.emit (events.js:314:20)</span><br><span class=\"line\">err:     at Hexo._generate (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:399:8)</span><br><span class=\"line\">err:     at &#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:249:***</span><br><span class=\"line\">err:     at tryCatcher (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;util.js:16:23)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:547:31)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:604:18)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at PromiseArray._resolve (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:127:19)</span><br><span class=\"line\">err:     at PromiseArray._promiseFulfilled (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:145:14)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:609:26)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at Promise._resolveCallback (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:466:57)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:559:17)</span><br><span class=\"line\">out: INFO  Start processing</span><br><span class=\"line\">err: FATAL Something&#39;s wrong. Maybe you can find the solution here: https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</span><br><span class=\"line\">err: TypeError: Cannot read property &#39;enable&#39; of undefined</span><br><span class=\"line\">err:     at ***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;filters&#x2F;comment&#x2F;disqus.js:11:21</span><br><span class=\"line\">err:     at Filter.execSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;extend&#x2F;filter.js:74:28)</span><br><span class=\"line\">err:     at Hexo.execFilterSync (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:432:29)</span><br><span class=\"line\">err:     at module.exports (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;lib&#x2F;injects.js:58:8)</span><br><span class=\"line\">err:     at Hexo.&lt;anonymous&gt; (***&#x2F;themes&#x2F;nextTheme&#x2F;scripts&#x2F;events&#x2F;index.js:9:27)</span><br><span class=\"line\">err:     at Hexo.emit (events.js:314:20)</span><br><span class=\"line\">err:     at Hexo._generate (&#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:399:8)</span><br><span class=\"line\">err:     at &#x2F;***&#x2F;node_modules&#x2F;hexo&#x2F;lib&#x2F;hexo&#x2F;index.js:249:***</span><br><span class=\"line\">err:     at tryCatcher (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;util.js:16:23)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:547:31)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:604:18)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at PromiseArray._resolve (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:127:19)</span><br><span class=\"line\">err:     at PromiseArray._promiseFulfilled (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise_array.js:145:14)</span><br><span class=\"line\">err:     at Promise._settlePromise (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:609:26)</span><br><span class=\"line\">err:     at Promise._settlePromise0 (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:649:10)</span><br><span class=\"line\">err:     at Promise._settlePromises (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:729:18)</span><br><span class=\"line\">err:     at Promise._fulfill (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:673:18)</span><br><span class=\"line\">err:     at Promise._resolveCallback (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:466:57)</span><br><span class=\"line\">err:     at Promise._settlePromiseFromHandler (&#x2F;***&#x2F;node_modules&#x2F;bluebird&#x2F;js&#x2F;release&#x2F;promise.js:559:17)</span><br></pre></td></tr></table></figure>\n<p>简单点，显示没有enable这个属性，，，，我懵了，这部署了多少次了，没有出现这么个错误啊。</p>\n<p>先删了js，本地跑ok了，远端挂了，又提示另一个js错误。<br>\n再删一个错误的js,再跑…又挂了!</p>\n<h3 id=\"排查…\"><a class=\"header-anchor\" href=\"#排查…\">¶</a>排查…</h3>\n<blockquote>\n<p>初步定位为文件没有更到最新</p>\n</blockquote>\n<p>本地ok,服务器部署不起来…</p>\n<p>查下文件scp copy的工作流</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-000817@2x.png\" alt=\"\"></p>\n<p>看起来很简单，也很好用，但是呢，大坑来了…<br>\n当时没有选择是否选择覆盖文件：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-001054@2x.png\" alt=\"\"></p>\n<h3 id=\"问题点\"><a class=\"header-anchor\" href=\"#问题点\">¶</a>问题点</h3>\n<p>没有覆盖配置文件，导致残留或者修改不彻底，同名的始终不修改，导致的问题。</p>\n<p>PS：花了半个小时定位这么个rewrite的问题！ 记着吧，提醒自己…</p>\n<h3 id=\"参考：\"><a class=\"header-anchor\" href=\"#参考：\">¶</a>参考：</h3>\n<p><a href=\"https://github.com/appleboy/scp-action/blob/master/action.yml#L44\">copy workflow Github</a><br>\n<a href=\"https://github.com/marketplace/actions/scp-files\">scp copy workflow</a></p>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-000817@2x.png","popularPost_tmp_gaData":{"updated":"Tue Nov 17 2020 00:09:17 GMT+0800 (中国标准时间)","title":"「20」博客诡异事件","path":"archives/5ce14ff5.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A120201117-000817@2x.png","excerpt":"<h3 id=\"博客CI-CD崩了\"><a class=\"header-anchor\" href=\"#博客CI-CD崩了\">¶</a>博客CI CD崩了</h3>\n<blockquote>\n<p>就在刚才修改了部分的config配置，后打了tag push了上去,</p>\n</blockquote>\n<blockquote>\n<p>oh…GG了</p>\n</blockquote>","date":{"_isAMomentObject":true,"_i":"2020-11-16T16:09:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-16T16:09:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Day","博客"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":5521},{"title":"「21」linux select源码","date":"2020-11-17T11:09:17.000Z","updated":"2020-11-18T11:09:17.000Z","abbrlink":"ba7b70bf","keywords":null,"_content":"\n\n> select poll epoll三个老生长谈的问题.这次不是来讲区别的，后续会更新一篇关于三者区别的。\n\n### 前序 \nselect属于linux系列的文件系统「fs」的范畴，每次的系统调用、打开软件、启动程序等等都会涉及到文件的读写，\n这个是在所难免的。\n\n那么I/O事件的基本思路：文件准备ok，开始读写，等函数返回，根据结果继续运行.\n\n如果是自己实现，大体上无非以下思路：\n<!--more-->\n\n* 创建多个进程/线程来监听\n* Non-blocking读写监听的轮询\n* 异步I/O与Unix Signal事件机制\n\n先来学习下linux源码是怎么处理select机制的：\n\n>linux version: 5.10-r5\n\n### 概览图\n\n梳理了下，大概整理成了流程图：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux源码-select-1.png)\n\n\n### select切入点\n\n既然知道了select属于fs系列的，那就很容易找到:[fs/select.c]\n\n查看select命令：\n```shell\nman 2 select\n```\n\n下面按照以下顺序来解读，一起学习：\n\n* 入口 SYSCALL_DEFINE5\n* 核心函数 do_select\n* 设备驱动的操作函数 \n* poll_wait与设备的等待队列\n* fd数量限制「why」\n* select与poll\n\n\n### SYSCALL_DEFINE5\n\n\n```c++\nSYSCALL_DEFINE5(select, int, n, fd_set __user *, inp, fd_set __user *, outp,\n\t\tfd_set __user *, exp, struct __kernel_old_timeval __user *, tvp)\n{\n\treturn kern_select(n, inp, outp, exp, tvp);\n}\n\n\n```\n\n函数：core_sys_select中主要的do_select处理其中的逻辑\n\n### do_select\n\n关键性的结构体\n```c++\ntypedef struct {\n\tunsigned long *in, *out, *ex; //输出 、输入、异常\n\tunsigned long *res_in, *res_out, *res_ex;\n} fd_set_bits;\n```\n\n\n```c++\n\nstatic int do_select(int n, fd_set_bits *fds, struct timespec64 *end_time)\n{\n\tktime_t expire, *to = NULL;\n\tstruct poll_wqueues table;\n\tpoll_table *wait;\n\tint retval, i, timed_out = 0;\n\tu64 slack = 0;\n\t__poll_t busy_flag = net_busy_loop_on() ? POLL_BUSY_LOOP : 0;\n\tunsigned long busy_start = 0;\n\n\trcu_read_lock();\n    //找出文件的最大描述符\n\tretval = max_select_fd(n, fds);\n\trcu_read_unlock();\n\n\tif (retval < 0)\n\t\treturn retval;\n\tn = retval;\n\n    //初始化\n\tpoll_initwait(&table);\n\twait = &table.pt;\n\tif (end_time && !end_time->tv_sec && !end_time->tv_nsec) {\n\t\twait->_qproc = NULL;\n\t\ttimed_out = 1;\n\t}\n\n\tif (end_time && !timed_out)\n\t\tslack = select_estimate_accuracy(end_time);\n\n\tretval = 0;\n\tfor (;;) {\n\t\tunsigned long *rinp, *routp, *rexp, *inp, *outp, *exp;\n\t\tbool can_busy_loop = false;\n\n\t\tinp = fds->in; outp = fds->out; exp = fds->ex;\n\t\trinp = fds->res_in; routp = fds->res_out; rexp = fds->res_ex;\n\n        //遍历所有的fd.......同步等.....\n\t\tfor (i = 0; i < n; ++rinp, ++routp, ++rexp) {\n\t\t\tunsigned long in, out, ex, all_bits, bit = 1, j;\n\t\t\tunsigned long res_in = 0, res_out = 0, res_ex = 0;\n\t\t\t__poll_t mask;\n\n\t\t\tin = *inp++; out = *outp++; ex = *exp++;\n\t\t\tall_bits = in | out | ex;\n            //没有任何注册事件\n\t\t\tif (all_bits == 0) {\n\t\t\t\ti += BITS_PER_LONG;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tfor (j = 0; j < BITS_PER_LONG; ++j, ++i, bit <<= 1) {\n\t\t\t\tstruct fd f;\n\t\t\t\tif (i >= n)\n\t\t\t\t\tbreak;\n                //跳过未注册的\n\t\t\t\tif (!(bit & all_bits))\n\t\t\t\t\tcontinue;\n\t\t\t\tf = fdget(i);\n\t\t\t\tif (f.file) {\n\t\t\t\t\twait_key_set(wait, in, out, bit,\n\t\t\t\t\t\t     busy_flag);\n\n                    //对每一个fd进行检测\n\t\t\t\t\tmask = vfs_poll(f.file, wait);\n\n\t\t\t\t\tfdput(f);\n\t\t\t\t\tif ((mask & POLLIN_SET) && (in & bit)) {\n\t\t\t\t\t\tres_in |= bit;\n\t\t\t\t\t\tretval++;\n\t\t\t\t\t\twait->_qproc = NULL;\n\t\t\t\t\t}\n\t\t\t\t\tif ((mask & POLLOUT_SET) && (out & bit)) {\n\t\t\t\t\t\tres_out |= bit;\n\t\t\t\t\t\tretval++;\n\t\t\t\t\t\twait->_qproc = NULL;\n\t\t\t\t\t}\n\t\t\t\t\tif ((mask & POLLEX_SET) && (ex & bit)) {\n\t\t\t\t\t\tres_ex |= bit;\n\t\t\t\t\t\tretval++;\n\t\t\t\t\t\twait->_qproc = NULL;\n\t\t\t\t\t}\n\t\t\t\t\t/* got something, stop busy polling */\n\t\t\t\t\tif (retval) {\n\t\t\t\t\t\tcan_busy_loop = false;\n\t\t\t\t\t\tbusy_flag = 0;\n\n\t\t\t\t\t/*\n\t\t\t\t\t * only remember a returned\n\t\t\t\t\t * POLL_BUSY_LOOP if we asked for it\n\t\t\t\t\t */\n\t\t\t\t\t} else if (busy_flag & mask)\n\t\t\t\t\t\tcan_busy_loop = true;\n\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (res_in)\n\t\t\t\t*rinp = res_in;\n\t\t\tif (res_out)\n\t\t\t\t*routp = res_out;\n\t\t\tif (res_ex)\n\t\t\t\t*rexp = res_ex;\n\t\t\tcond_resched();\n\t\t}\n\t\twait->_qproc = NULL;\n\n        //退出循环，条件： 事件就绪/超时/收到信号\n\t\tif (retval || timed_out || signal_pending(current))\n\t\t\tbreak;\n\t\tif (table.error) {\n\t\t\tretval = table.error;\n\t\t\tbreak;\n\t\t}\n\n\t\t/* only if found POLL_BUSY_LOOP sockets && not out of time */\n\t\tif (can_busy_loop && !need_resched()) {\n\t\t\tif (!busy_start) {\n\t\t\t\tbusy_start = busy_loop_current_time();\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!busy_loop_timeout(busy_start))\n\t\t\t\tcontinue;\n\t\t}\n\t\tbusy_flag = 0;\n\n\t\t/*\n\t\t * If this is the first loop and we have a timeout\n\t\t * given, then we convert to ktime_t and set the to\n\t\t * pointer to the expiry value.\n\t\t */\n\t\tif (end_time && !to) {\n\t\t\texpire = timespec64_to_ktime(*end_time);\n\t\t\tto = &expire;\n\t\t}\n\n        //超时就休眠一会儿「中断会儿」\n\t\tif (!poll_schedule_timeout(&table, TASK_INTERRUPTIBLE,\n\t\t\t\t\t   to, slack))\n\t\t\ttimed_out = 1;\n\t}\n\n\tpoll_freewait(&table);\n\n\treturn retval;\n}\n```\n\n\n\n```c++\nstatic int poll_schedule_timeout(struct poll_wqueues *pwq, int state,\n\t\t\t  ktime_t *expires, unsigned long slack)\n{\n\tint rc = -EINTR;\n\n\tset_current_state(state);\n\tif (!pwq->triggered)\n\t\trc = schedule_hrtimeout_range(expires, slack, HRTIMER_MODE_ABS);\n\t__set_current_state(TASK_RUNNING);\n\n\t/*\n\t * Prepare for the next iteration.\n\t *\n\t * The following smp_store_mb() serves two purposes.  First, it's\n\t * the counterpart rmb of the wmb in pollwake() such that data\n\t * written before wake up is always visible after wake up.\n\t * Second, the full barrier guarantees that triggered clearing\n\t * doesn't pass event check of the next iteration.  Note that\n\t * this problem doesn't exist for the first iteration as\n\t * add_wait_queue() has full barrier semantics.\n\t */\n\tsmp_store_mb(pwq->triggered, 0);\n\n\treturn rc;\n}\n```\n### poll_wait\n\n```c++\n\n\n/* \n * structures and helpers for f_op->poll implementations\n */\n //类似一个回调函数\ntypedef void (*poll_queue_proc)(struct file *, wait_queue_head_t *, struct poll_table_struct *);\n\n\ntypedef struct poll_table_struct {\n\tpoll_queue_proc _qproc; //callback机制\n\t__poll_t _key;\n} poll_table;\n\n\nstatic inline void poll_wait(struct file * filp, wait_queue_head_t * wait_address, poll_table *p)\n{\n\tif (p && p->_qproc && wait_address)\n\t\tp->_qproc(filp, wait_address, p);\n}\n```\n\n### fd数量问题\n\n>include/uapi/linux/posix_types.h\n\n```c++\n#define __FD_SETSIZE\t1024\n\ntypedef struct {\n  //__FD_SETSIZE当下标使？？？what！\n\tunsigned long fds_bits[__FD_SETSIZE / (8 * sizeof(long))];\n} __kernel_fd_set;\n\nstruct fd {\n\tstruct file *file;\n\tunsigned int flags;\n};\n```\n\n\n>从上面看来文件描述符只是一个整数值，用来操作下标的，主要是每一个进程file数组的下标。理解do_select是核心。\n\n### select 与poll\n\n>poll取消了最大数量的限制,返回结果还是需要轮询来获取就绪的描述符。\n\n```c++\nstruct pollfd {\n\tint fd;\n\tshort events; //request\n\tshort revents; // return\n};\n```\n\n具体见后续更新「poll源码」\n\n### 参考\n\n[Linux Device Drivers, Third Edition](https://www.oreilly.com/openbook/linuxdrive3/book/)\n[How do system calls like select() or poll() work under the hood?](https://stackoverflow.com/questions/11496059/how-do-system-calls-like-select-or-poll-work-under-the-hood)\n\n","source":"_posts/21-linux-select源码.md","raw":"---\ntitle: 「21」linux select源码\ndate: '2020/11/17 19:09:17'\nupdated: '2020/11/18 19:09:17'\ntags:\n  - Linux\n  - Day\nabbrlink: ba7b70bf\nkeywords:\n---\n\n\n> select poll epoll三个老生长谈的问题.这次不是来讲区别的，后续会更新一篇关于三者区别的。\n\n### 前序 \nselect属于linux系列的文件系统「fs」的范畴，每次的系统调用、打开软件、启动程序等等都会涉及到文件的读写，\n这个是在所难免的。\n\n那么I/O事件的基本思路：文件准备ok，开始读写，等函数返回，根据结果继续运行.\n\n如果是自己实现，大体上无非以下思路：\n<!--more-->\n\n* 创建多个进程/线程来监听\n* Non-blocking读写监听的轮询\n* 异步I/O与Unix Signal事件机制\n\n先来学习下linux源码是怎么处理select机制的：\n\n>linux version: 5.10-r5\n\n### 概览图\n\n梳理了下，大概整理成了流程图：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/linux源码-select-1.png)\n\n\n### select切入点\n\n既然知道了select属于fs系列的，那就很容易找到:[fs/select.c]\n\n查看select命令：\n```shell\nman 2 select\n```\n\n下面按照以下顺序来解读，一起学习：\n\n* 入口 SYSCALL_DEFINE5\n* 核心函数 do_select\n* 设备驱动的操作函数 \n* poll_wait与设备的等待队列\n* fd数量限制「why」\n* select与poll\n\n\n### SYSCALL_DEFINE5\n\n\n```c++\nSYSCALL_DEFINE5(select, int, n, fd_set __user *, inp, fd_set __user *, outp,\n\t\tfd_set __user *, exp, struct __kernel_old_timeval __user *, tvp)\n{\n\treturn kern_select(n, inp, outp, exp, tvp);\n}\n\n\n```\n\n函数：core_sys_select中主要的do_select处理其中的逻辑\n\n### do_select\n\n关键性的结构体\n```c++\ntypedef struct {\n\tunsigned long *in, *out, *ex; //输出 、输入、异常\n\tunsigned long *res_in, *res_out, *res_ex;\n} fd_set_bits;\n```\n\n\n```c++\n\nstatic int do_select(int n, fd_set_bits *fds, struct timespec64 *end_time)\n{\n\tktime_t expire, *to = NULL;\n\tstruct poll_wqueues table;\n\tpoll_table *wait;\n\tint retval, i, timed_out = 0;\n\tu64 slack = 0;\n\t__poll_t busy_flag = net_busy_loop_on() ? POLL_BUSY_LOOP : 0;\n\tunsigned long busy_start = 0;\n\n\trcu_read_lock();\n    //找出文件的最大描述符\n\tretval = max_select_fd(n, fds);\n\trcu_read_unlock();\n\n\tif (retval < 0)\n\t\treturn retval;\n\tn = retval;\n\n    //初始化\n\tpoll_initwait(&table);\n\twait = &table.pt;\n\tif (end_time && !end_time->tv_sec && !end_time->tv_nsec) {\n\t\twait->_qproc = NULL;\n\t\ttimed_out = 1;\n\t}\n\n\tif (end_time && !timed_out)\n\t\tslack = select_estimate_accuracy(end_time);\n\n\tretval = 0;\n\tfor (;;) {\n\t\tunsigned long *rinp, *routp, *rexp, *inp, *outp, *exp;\n\t\tbool can_busy_loop = false;\n\n\t\tinp = fds->in; outp = fds->out; exp = fds->ex;\n\t\trinp = fds->res_in; routp = fds->res_out; rexp = fds->res_ex;\n\n        //遍历所有的fd.......同步等.....\n\t\tfor (i = 0; i < n; ++rinp, ++routp, ++rexp) {\n\t\t\tunsigned long in, out, ex, all_bits, bit = 1, j;\n\t\t\tunsigned long res_in = 0, res_out = 0, res_ex = 0;\n\t\t\t__poll_t mask;\n\n\t\t\tin = *inp++; out = *outp++; ex = *exp++;\n\t\t\tall_bits = in | out | ex;\n            //没有任何注册事件\n\t\t\tif (all_bits == 0) {\n\t\t\t\ti += BITS_PER_LONG;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tfor (j = 0; j < BITS_PER_LONG; ++j, ++i, bit <<= 1) {\n\t\t\t\tstruct fd f;\n\t\t\t\tif (i >= n)\n\t\t\t\t\tbreak;\n                //跳过未注册的\n\t\t\t\tif (!(bit & all_bits))\n\t\t\t\t\tcontinue;\n\t\t\t\tf = fdget(i);\n\t\t\t\tif (f.file) {\n\t\t\t\t\twait_key_set(wait, in, out, bit,\n\t\t\t\t\t\t     busy_flag);\n\n                    //对每一个fd进行检测\n\t\t\t\t\tmask = vfs_poll(f.file, wait);\n\n\t\t\t\t\tfdput(f);\n\t\t\t\t\tif ((mask & POLLIN_SET) && (in & bit)) {\n\t\t\t\t\t\tres_in |= bit;\n\t\t\t\t\t\tretval++;\n\t\t\t\t\t\twait->_qproc = NULL;\n\t\t\t\t\t}\n\t\t\t\t\tif ((mask & POLLOUT_SET) && (out & bit)) {\n\t\t\t\t\t\tres_out |= bit;\n\t\t\t\t\t\tretval++;\n\t\t\t\t\t\twait->_qproc = NULL;\n\t\t\t\t\t}\n\t\t\t\t\tif ((mask & POLLEX_SET) && (ex & bit)) {\n\t\t\t\t\t\tres_ex |= bit;\n\t\t\t\t\t\tretval++;\n\t\t\t\t\t\twait->_qproc = NULL;\n\t\t\t\t\t}\n\t\t\t\t\t/* got something, stop busy polling */\n\t\t\t\t\tif (retval) {\n\t\t\t\t\t\tcan_busy_loop = false;\n\t\t\t\t\t\tbusy_flag = 0;\n\n\t\t\t\t\t/*\n\t\t\t\t\t * only remember a returned\n\t\t\t\t\t * POLL_BUSY_LOOP if we asked for it\n\t\t\t\t\t */\n\t\t\t\t\t} else if (busy_flag & mask)\n\t\t\t\t\t\tcan_busy_loop = true;\n\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (res_in)\n\t\t\t\t*rinp = res_in;\n\t\t\tif (res_out)\n\t\t\t\t*routp = res_out;\n\t\t\tif (res_ex)\n\t\t\t\t*rexp = res_ex;\n\t\t\tcond_resched();\n\t\t}\n\t\twait->_qproc = NULL;\n\n        //退出循环，条件： 事件就绪/超时/收到信号\n\t\tif (retval || timed_out || signal_pending(current))\n\t\t\tbreak;\n\t\tif (table.error) {\n\t\t\tretval = table.error;\n\t\t\tbreak;\n\t\t}\n\n\t\t/* only if found POLL_BUSY_LOOP sockets && not out of time */\n\t\tif (can_busy_loop && !need_resched()) {\n\t\t\tif (!busy_start) {\n\t\t\t\tbusy_start = busy_loop_current_time();\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!busy_loop_timeout(busy_start))\n\t\t\t\tcontinue;\n\t\t}\n\t\tbusy_flag = 0;\n\n\t\t/*\n\t\t * If this is the first loop and we have a timeout\n\t\t * given, then we convert to ktime_t and set the to\n\t\t * pointer to the expiry value.\n\t\t */\n\t\tif (end_time && !to) {\n\t\t\texpire = timespec64_to_ktime(*end_time);\n\t\t\tto = &expire;\n\t\t}\n\n        //超时就休眠一会儿「中断会儿」\n\t\tif (!poll_schedule_timeout(&table, TASK_INTERRUPTIBLE,\n\t\t\t\t\t   to, slack))\n\t\t\ttimed_out = 1;\n\t}\n\n\tpoll_freewait(&table);\n\n\treturn retval;\n}\n```\n\n\n\n```c++\nstatic int poll_schedule_timeout(struct poll_wqueues *pwq, int state,\n\t\t\t  ktime_t *expires, unsigned long slack)\n{\n\tint rc = -EINTR;\n\n\tset_current_state(state);\n\tif (!pwq->triggered)\n\t\trc = schedule_hrtimeout_range(expires, slack, HRTIMER_MODE_ABS);\n\t__set_current_state(TASK_RUNNING);\n\n\t/*\n\t * Prepare for the next iteration.\n\t *\n\t * The following smp_store_mb() serves two purposes.  First, it's\n\t * the counterpart rmb of the wmb in pollwake() such that data\n\t * written before wake up is always visible after wake up.\n\t * Second, the full barrier guarantees that triggered clearing\n\t * doesn't pass event check of the next iteration.  Note that\n\t * this problem doesn't exist for the first iteration as\n\t * add_wait_queue() has full barrier semantics.\n\t */\n\tsmp_store_mb(pwq->triggered, 0);\n\n\treturn rc;\n}\n```\n### poll_wait\n\n```c++\n\n\n/* \n * structures and helpers for f_op->poll implementations\n */\n //类似一个回调函数\ntypedef void (*poll_queue_proc)(struct file *, wait_queue_head_t *, struct poll_table_struct *);\n\n\ntypedef struct poll_table_struct {\n\tpoll_queue_proc _qproc; //callback机制\n\t__poll_t _key;\n} poll_table;\n\n\nstatic inline void poll_wait(struct file * filp, wait_queue_head_t * wait_address, poll_table *p)\n{\n\tif (p && p->_qproc && wait_address)\n\t\tp->_qproc(filp, wait_address, p);\n}\n```\n\n### fd数量问题\n\n>include/uapi/linux/posix_types.h\n\n```c++\n#define __FD_SETSIZE\t1024\n\ntypedef struct {\n  //__FD_SETSIZE当下标使？？？what！\n\tunsigned long fds_bits[__FD_SETSIZE / (8 * sizeof(long))];\n} __kernel_fd_set;\n\nstruct fd {\n\tstruct file *file;\n\tunsigned int flags;\n};\n```\n\n\n>从上面看来文件描述符只是一个整数值，用来操作下标的，主要是每一个进程file数组的下标。理解do_select是核心。\n\n### select 与poll\n\n>poll取消了最大数量的限制,返回结果还是需要轮询来获取就绪的描述符。\n\n```c++\nstruct pollfd {\n\tint fd;\n\tshort events; //request\n\tshort revents; // return\n};\n```\n\n具体见后续更新「poll源码」\n\n### 参考\n\n[Linux Device Drivers, Third Edition](https://www.oreilly.com/openbook/linuxdrive3/book/)\n[How do system calls like select() or poll() work under the hood?](https://stackoverflow.com/questions/11496059/how-do-system-calls-like-select-or-poll-work-under-the-hood)\n\n","slug":"21-linux-select源码","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl800133ci7elur5eaf","content":"<blockquote>\n<p>select poll epoll三个老生长谈的问题.这次不是来讲区别的，后续会更新一篇关于三者区别的。</p>\n</blockquote>\n<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>select属于linux系列的文件系统「fs」的范畴，每次的系统调用、打开软件、启动程序等等都会涉及到文件的读写，<br>\n这个是在所难免的。</p>\n<p>那么I/O事件的基本思路：文件准备ok，开始读写，等函数返回，根据结果继续运行.</p>\n<p>如果是自己实现，大体上无非以下思路：</p>\n<a id=\"more\"></a>\n<ul>\n<li>创建多个进程/线程来监听</li>\n<li>Non-blocking读写监听的轮询</li>\n<li>异步I/O与Unix Signal事件机制</li>\n</ul>\n<p>先来学习下linux源码是怎么处理select机制的：</p>\n<blockquote>\n<p>linux version: 5.10-r5</p>\n</blockquote>\n<h3 id=\"概览图\"><a class=\"header-anchor\" href=\"#概览图\">¶</a>概览图</h3>\n<p>梳理了下，大概整理成了流程图：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux%E6%BA%90%E7%A0%81-select-1.png\" alt=\"\"></p>\n<h3 id=\"select切入点\"><a class=\"header-anchor\" href=\"#select切入点\">¶</a>select切入点</h3>\n<p>既然知道了select属于fs系列的，那就很容易找到:[fs/select.c]</p>\n<p>查看select命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">man 2 select</span><br></pre></td></tr></table></figure>\n<p>下面按照以下顺序来解读，一起学习：</p>\n<ul>\n<li>入口 SYSCALL_DEFINE5</li>\n<li>核心函数 do_select</li>\n<li>设备驱动的操作函数</li>\n<li>poll_wait与设备的等待队列</li>\n<li>fd数量限制「why」</li>\n<li>select与poll</li>\n</ul>\n<h3 id=\"SYSCALL-DEFINE5\"><a class=\"header-anchor\" href=\"#SYSCALL-DEFINE5\">¶</a>SYSCALL_DEFINE5</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SYSCALL_DEFINE5(select, <span class=\"keyword\">int</span>, n, fd_set __user *, inp, fd_set __user *, outp,</span><br><span class=\"line\">\t\tfd_set __user *, <span class=\"built_in\">exp</span>, struct __kernel_old_timeval __user *, tvp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> kern_select(n, inp, outp, <span class=\"built_in\">exp</span>, tvp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>函数：core_sys_select中主要的do_select处理其中的逻辑</p>\n<h3 id=\"do-select\"><a class=\"header-anchor\" href=\"#do-select\">¶</a>do_select</h3>\n<p>关键性的结构体</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> *in, *out, *ex; <span class=\"comment\">//输出 、输入、异常</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> *res_in, *res_out, *res_ex;</span><br><span class=\"line\">&#125; fd_set_bits;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">do_select</span><span class=\"params\">(<span class=\"keyword\">int</span> n, fd_set_bits *fds, struct timespec64 *end_time)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">ktime_t</span> expire, *to = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">poll_wqueues</span> <span class=\"title\">table</span>;</span></span><br><span class=\"line\">\tpoll_table *wait;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> retval, i, timed_out = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tu64 slack = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">__poll_t</span> busy_flag = net_busy_loop_on() ? POLL_BUSY_LOOP : <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> busy_start = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\trcu_read_lock();</span><br><span class=\"line\">    <span class=\"comment\">//找出文件的最大描述符</span></span><br><span class=\"line\">\tretval = max_select_fd(n, fds);</span><br><span class=\"line\">\trcu_read_unlock();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (retval &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> retval;</span><br><span class=\"line\">\tn = retval;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//初始化</span></span><br><span class=\"line\">\tpoll_initwait(&amp;table);</span><br><span class=\"line\">\twait = &amp;table.pt;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_time &amp;&amp; !end_time-&gt;tv_sec &amp;&amp; !end_time-&gt;tv_nsec) &#123;</span><br><span class=\"line\">\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\ttimed_out = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_time &amp;&amp; !timed_out)</span><br><span class=\"line\">\t\tslack = select_estimate_accuracy(end_time);</span><br><span class=\"line\"></span><br><span class=\"line\">\tretval = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> *rinp, *routp, *rexp, *inp, *outp, *<span class=\"built_in\">exp</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">bool</span> can_busy_loop = <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tinp = fds-&gt;in; outp = fds-&gt;out; <span class=\"built_in\">exp</span> = fds-&gt;ex;</span><br><span class=\"line\">\t\trinp = fds-&gt;res_in; routp = fds-&gt;res_out; rexp = fds-&gt;res_ex;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//遍历所有的fd.......同步等.....</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; n; ++rinp, ++routp, ++rexp) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> in, out, ex, all_bits, <span class=\"built_in\">bit</span> = <span class=\"number\">1</span>, j;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> res_in = <span class=\"number\">0</span>, res_out = <span class=\"number\">0</span>, res_ex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">__poll_t</span> mask;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tin = *inp++; out = *outp++; ex = *<span class=\"built_in\">exp</span>++;</span><br><span class=\"line\">\t\t\tall_bits = in | out | ex;</span><br><span class=\"line\">            <span class=\"comment\">//没有任何注册事件</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (all_bits == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t\t\ti += BITS_PER_LONG;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; BITS_PER_LONG; ++j, ++i, <span class=\"built_in\">bit</span> &lt;&lt;= <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">fd</span> <span class=\"title\">f</span>;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (i &gt;= n)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"comment\">//跳过未注册的</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!(<span class=\"built_in\">bit</span> &amp; all_bits))</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t\tf = fdget(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (f.file) &#123;</span><br><span class=\"line\">\t\t\t\t\twait_key_set(wait, in, out, <span class=\"built_in\">bit</span>,</span><br><span class=\"line\">\t\t\t\t\t\t     busy_flag);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//对每一个fd进行检测</span></span><br><span class=\"line\">\t\t\t\t\tmask = vfs_poll(f.file, wait);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\tfdput(f);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ((mask &amp; POLLIN_SET) &amp;&amp; (in &amp; <span class=\"built_in\">bit</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tres_in |= <span class=\"built_in\">bit</span>;</span><br><span class=\"line\">\t\t\t\t\t\tretval++;</span><br><span class=\"line\">\t\t\t\t\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ((mask &amp; POLLOUT_SET) &amp;&amp; (out &amp; <span class=\"built_in\">bit</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tres_out |= <span class=\"built_in\">bit</span>;</span><br><span class=\"line\">\t\t\t\t\t\tretval++;</span><br><span class=\"line\">\t\t\t\t\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ((mask &amp; POLLEX_SET) &amp;&amp; (ex &amp; <span class=\"built_in\">bit</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tres_ex |= <span class=\"built_in\">bit</span>;</span><br><span class=\"line\">\t\t\t\t\t\tretval++;</span><br><span class=\"line\">\t\t\t\t\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">/* got something, stop busy polling */</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (retval) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tcan_busy_loop = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t\t\t\t\tbusy_flag = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t * only remember a returned</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t * POLL_BUSY_LOOP if we asked for it</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t */</span></span><br><span class=\"line\">\t\t\t\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (busy_flag &amp; mask)</span><br><span class=\"line\">\t\t\t\t\t\tcan_busy_loop = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (res_in)</span><br><span class=\"line\">\t\t\t\t*rinp = res_in;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (res_out)</span><br><span class=\"line\">\t\t\t\t*routp = res_out;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (res_ex)</span><br><span class=\"line\">\t\t\t\t*rexp = res_ex;</span><br><span class=\"line\">\t\t\tcond_resched();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//退出循环，条件： 事件就绪/超时/收到信号</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (retval || timed_out || signal_pending(current))</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (table.error) &#123;</span><br><span class=\"line\">\t\t\tretval = table.error;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* only if found POLL_BUSY_LOOP sockets &amp;&amp; not out of time */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (can_busy_loop &amp;&amp; !need_resched()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!busy_start) &#123;</span><br><span class=\"line\">\t\t\t\tbusy_start = busy_loop_current_time();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!busy_loop_timeout(busy_start))</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tbusy_flag = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * If this is the first loop and we have a timeout</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * given, then we convert to ktime_t and set the to</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * pointer to the expiry value.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (end_time &amp;&amp; !to) &#123;</span><br><span class=\"line\">\t\t\texpire = timespec64_to_ktime(*end_time);</span><br><span class=\"line\">\t\t\tto = &amp;expire;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//超时就休眠一会儿「中断会儿」</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!poll_schedule_timeout(&amp;table, TASK_INTERRUPTIBLE,</span><br><span class=\"line\">\t\t\t\t\t   to, slack))</span><br><span class=\"line\">\t\t\ttimed_out = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpoll_freewait(&amp;table);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> retval;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">poll_schedule_timeout</span><span class=\"params\">(struct poll_wqueues *pwq, <span class=\"keyword\">int</span> state,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t  <span class=\"keyword\">ktime_t</span> *expires, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> slack)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> rc = -EINTR;</span><br><span class=\"line\"></span><br><span class=\"line\">\tset_current_state(state);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pwq-&gt;triggered)</span><br><span class=\"line\">\t\trc = schedule_hrtimeout_range(expires, slack, HRTIMER_MODE_ABS);</span><br><span class=\"line\">\t__set_current_state(TASK_RUNNING);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Prepare for the next iteration.</span></span><br><span class=\"line\"><span class=\"comment\">\t *</span></span><br><span class=\"line\"><span class=\"comment\">\t * The following smp_store_mb() serves two purposes.  First, it&#x27;s</span></span><br><span class=\"line\"><span class=\"comment\">\t * the counterpart rmb of the wmb in pollwake() such that data</span></span><br><span class=\"line\"><span class=\"comment\">\t * written before wake up is always visible after wake up.</span></span><br><span class=\"line\"><span class=\"comment\">\t * Second, the full barrier guarantees that triggered clearing</span></span><br><span class=\"line\"><span class=\"comment\">\t * doesn&#x27;t pass event check of the next iteration.  Note that</span></span><br><span class=\"line\"><span class=\"comment\">\t * this problem doesn&#x27;t exist for the first iteration as</span></span><br><span class=\"line\"><span class=\"comment\">\t * add_wait_queue() has full barrier semantics.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\tsmp_store_mb(pwq-&gt;triggered, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> rc;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"poll-wait\"><a class=\"header-anchor\" href=\"#poll-wait\">¶</a>poll_wait</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\"> * structures and helpers for f_op-&gt;poll implementations</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"> <span class=\"comment\">//类似一个回调函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">typedef</span> <span class=\"title\">void</span> <span class=\"params\">(*poll_queue_proc)</span><span class=\"params\">(struct file *, <span class=\"keyword\">wait_queue_head_t</span> *, struct poll_table_struct *)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">poll_table_struct</span> &#123;</span></span><br><span class=\"line\">\tpoll_queue_proc _qproc; <span class=\"comment\">//callback机制</span></span><br><span class=\"line\">\t<span class=\"keyword\">__poll_t</span> _key;</span><br><span class=\"line\">&#125; poll_table;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">inline</span> <span class=\"keyword\">void</span> <span class=\"title\">poll_wait</span><span class=\"params\">(struct file * filp, <span class=\"keyword\">wait_queue_head_t</span> * wait_address, poll_table *p)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p &amp;&amp; p-&gt;_qproc &amp;&amp; wait_address)</span><br><span class=\"line\">\t\tp-&gt;_qproc(filp, wait_address, p);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"fd数量问题\"><a class=\"header-anchor\" href=\"#fd数量问题\">¶</a>fd数量问题</h3>\n<blockquote>\n<p>include/uapi/linux/posix_types.h</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> __FD_SETSIZE\t1024</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">  <span class=\"comment\">//__FD_SETSIZE当下标使？？？what！</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> fds_bits[__FD_SETSIZE / (<span class=\"number\">8</span> * <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">long</span>))];</span><br><span class=\"line\">&#125; __kernel_fd_set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">fd</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> *<span class=\"title\">file</span>;</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> flags;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>从上面看来文件描述符只是一个整数值，用来操作下标的，主要是每一个进程file数组的下标。理解do_select是核心。</p>\n</blockquote>\n<h3 id=\"select-与poll\"><a class=\"header-anchor\" href=\"#select-与poll\">¶</a>select 与poll</h3>\n<blockquote>\n<p>poll取消了最大数量的限制,返回结果还是需要轮询来获取就绪的描述符。</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pollfd</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">int</span> fd;</span><br><span class=\"line\">\t<span class=\"keyword\">short</span> events; <span class=\"comment\">//request</span></span><br><span class=\"line\">\t<span class=\"keyword\">short</span> revents; <span class=\"comment\">// return</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>具体见后续更新「poll源码」</p>\n<h3 id=\"参考\"><a class=\"header-anchor\" href=\"#参考\">¶</a>参考</h3>\n<p><a href=\"https://www.oreilly.com/openbook/linuxdrive3/book/\">Linux Device Drivers, Third Edition</a><br>\n<a href=\"https://stackoverflow.com/questions/11496059/how-do-system-calls-like-select-or-poll-work-under-the-hood\">How do system calls like select() or poll() work under the hood?</a></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>select poll epoll三个老生长谈的问题.这次不是来讲区别的，后续会更新一篇关于三者区别的。</p>\n</blockquote>\n<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>select属于linux系列的文件系统「fs」的范畴，每次的系统调用、打开软件、启动程序等等都会涉及到文件的读写，<br>\n这个是在所难免的。</p>\n<p>那么I/O事件的基本思路：文件准备ok，开始读写，等函数返回，根据结果继续运行.</p>\n<p>如果是自己实现，大体上无非以下思路：</p>","more":"<ul>\n<li>创建多个进程/线程来监听</li>\n<li>Non-blocking读写监听的轮询</li>\n<li>异步I/O与Unix Signal事件机制</li>\n</ul>\n<p>先来学习下linux源码是怎么处理select机制的：</p>\n<blockquote>\n<p>linux version: 5.10-r5</p>\n</blockquote>\n<h3 id=\"概览图\"><a class=\"header-anchor\" href=\"#概览图\">¶</a>概览图</h3>\n<p>梳理了下，大概整理成了流程图：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/linux%E6%BA%90%E7%A0%81-select-1.png\" alt=\"\"></p>\n<h3 id=\"select切入点\"><a class=\"header-anchor\" href=\"#select切入点\">¶</a>select切入点</h3>\n<p>既然知道了select属于fs系列的，那就很容易找到:[fs/select.c]</p>\n<p>查看select命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">man 2 select</span><br></pre></td></tr></table></figure>\n<p>下面按照以下顺序来解读，一起学习：</p>\n<ul>\n<li>入口 SYSCALL_DEFINE5</li>\n<li>核心函数 do_select</li>\n<li>设备驱动的操作函数</li>\n<li>poll_wait与设备的等待队列</li>\n<li>fd数量限制「why」</li>\n<li>select与poll</li>\n</ul>\n<h3 id=\"SYSCALL-DEFINE5\"><a class=\"header-anchor\" href=\"#SYSCALL-DEFINE5\">¶</a>SYSCALL_DEFINE5</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SYSCALL_DEFINE5(select, <span class=\"keyword\">int</span>, n, fd_set __user *, inp, fd_set __user *, outp,</span><br><span class=\"line\">\t\tfd_set __user *, <span class=\"built_in\">exp</span>, struct __kernel_old_timeval __user *, tvp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> kern_select(n, inp, outp, <span class=\"built_in\">exp</span>, tvp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>函数：core_sys_select中主要的do_select处理其中的逻辑</p>\n<h3 id=\"do-select\"><a class=\"header-anchor\" href=\"#do-select\">¶</a>do_select</h3>\n<p>关键性的结构体</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> *in, *out, *ex; <span class=\"comment\">//输出 、输入、异常</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> *res_in, *res_out, *res_ex;</span><br><span class=\"line\">&#125; fd_set_bits;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">do_select</span><span class=\"params\">(<span class=\"keyword\">int</span> n, fd_set_bits *fds, struct timespec64 *end_time)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">ktime_t</span> expire, *to = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">poll_wqueues</span> <span class=\"title\">table</span>;</span></span><br><span class=\"line\">\tpoll_table *wait;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> retval, i, timed_out = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tu64 slack = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">__poll_t</span> busy_flag = net_busy_loop_on() ? POLL_BUSY_LOOP : <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> busy_start = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\trcu_read_lock();</span><br><span class=\"line\">    <span class=\"comment\">//找出文件的最大描述符</span></span><br><span class=\"line\">\tretval = max_select_fd(n, fds);</span><br><span class=\"line\">\trcu_read_unlock();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (retval &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> retval;</span><br><span class=\"line\">\tn = retval;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//初始化</span></span><br><span class=\"line\">\tpoll_initwait(&amp;table);</span><br><span class=\"line\">\twait = &amp;table.pt;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_time &amp;&amp; !end_time-&gt;tv_sec &amp;&amp; !end_time-&gt;tv_nsec) &#123;</span><br><span class=\"line\">\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\ttimed_out = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_time &amp;&amp; !timed_out)</span><br><span class=\"line\">\t\tslack = select_estimate_accuracy(end_time);</span><br><span class=\"line\"></span><br><span class=\"line\">\tretval = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> *rinp, *routp, *rexp, *inp, *outp, *<span class=\"built_in\">exp</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">bool</span> can_busy_loop = <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tinp = fds-&gt;in; outp = fds-&gt;out; <span class=\"built_in\">exp</span> = fds-&gt;ex;</span><br><span class=\"line\">\t\trinp = fds-&gt;res_in; routp = fds-&gt;res_out; rexp = fds-&gt;res_ex;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//遍历所有的fd.......同步等.....</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; n; ++rinp, ++routp, ++rexp) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> in, out, ex, all_bits, <span class=\"built_in\">bit</span> = <span class=\"number\">1</span>, j;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> res_in = <span class=\"number\">0</span>, res_out = <span class=\"number\">0</span>, res_ex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">__poll_t</span> mask;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tin = *inp++; out = *outp++; ex = *<span class=\"built_in\">exp</span>++;</span><br><span class=\"line\">\t\t\tall_bits = in | out | ex;</span><br><span class=\"line\">            <span class=\"comment\">//没有任何注册事件</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (all_bits == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t\t\ti += BITS_PER_LONG;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; BITS_PER_LONG; ++j, ++i, <span class=\"built_in\">bit</span> &lt;&lt;= <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">fd</span> <span class=\"title\">f</span>;</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (i &gt;= n)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"comment\">//跳过未注册的</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (!(<span class=\"built_in\">bit</span> &amp; all_bits))</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t\tf = fdget(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (f.file) &#123;</span><br><span class=\"line\">\t\t\t\t\twait_key_set(wait, in, out, <span class=\"built_in\">bit</span>,</span><br><span class=\"line\">\t\t\t\t\t\t     busy_flag);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"comment\">//对每一个fd进行检测</span></span><br><span class=\"line\">\t\t\t\t\tmask = vfs_poll(f.file, wait);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\tfdput(f);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ((mask &amp; POLLIN_SET) &amp;&amp; (in &amp; <span class=\"built_in\">bit</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tres_in |= <span class=\"built_in\">bit</span>;</span><br><span class=\"line\">\t\t\t\t\t\tretval++;</span><br><span class=\"line\">\t\t\t\t\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ((mask &amp; POLLOUT_SET) &amp;&amp; (out &amp; <span class=\"built_in\">bit</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tres_out |= <span class=\"built_in\">bit</span>;</span><br><span class=\"line\">\t\t\t\t\t\tretval++;</span><br><span class=\"line\">\t\t\t\t\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ((mask &amp; POLLEX_SET) &amp;&amp; (ex &amp; <span class=\"built_in\">bit</span>)) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tres_ex |= <span class=\"built_in\">bit</span>;</span><br><span class=\"line\">\t\t\t\t\t\tretval++;</span><br><span class=\"line\">\t\t\t\t\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">/* got something, stop busy polling */</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> (retval) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tcan_busy_loop = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t\t\t\t\tbusy_flag = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t * only remember a returned</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t * POLL_BUSY_LOOP if we asked for it</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t */</span></span><br><span class=\"line\">\t\t\t\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (busy_flag &amp; mask)</span><br><span class=\"line\">\t\t\t\t\t\tcan_busy_loop = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (res_in)</span><br><span class=\"line\">\t\t\t\t*rinp = res_in;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (res_out)</span><br><span class=\"line\">\t\t\t\t*routp = res_out;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (res_ex)</span><br><span class=\"line\">\t\t\t\t*rexp = res_ex;</span><br><span class=\"line\">\t\t\tcond_resched();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\twait-&gt;_qproc = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//退出循环，条件： 事件就绪/超时/收到信号</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (retval || timed_out || signal_pending(current))</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (table.error) &#123;</span><br><span class=\"line\">\t\t\tretval = table.error;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* only if found POLL_BUSY_LOOP sockets &amp;&amp; not out of time */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (can_busy_loop &amp;&amp; !need_resched()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!busy_start) &#123;</span><br><span class=\"line\">\t\t\t\tbusy_start = busy_loop_current_time();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!busy_loop_timeout(busy_start))</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tbusy_flag = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * If this is the first loop and we have a timeout</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * given, then we convert to ktime_t and set the to</span></span><br><span class=\"line\"><span class=\"comment\">\t\t * pointer to the expiry value.</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (end_time &amp;&amp; !to) &#123;</span><br><span class=\"line\">\t\t\texpire = timespec64_to_ktime(*end_time);</span><br><span class=\"line\">\t\t\tto = &amp;expire;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//超时就休眠一会儿「中断会儿」</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!poll_schedule_timeout(&amp;table, TASK_INTERRUPTIBLE,</span><br><span class=\"line\">\t\t\t\t\t   to, slack))</span><br><span class=\"line\">\t\t\ttimed_out = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpoll_freewait(&amp;table);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> retval;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">poll_schedule_timeout</span><span class=\"params\">(struct poll_wqueues *pwq, <span class=\"keyword\">int</span> state,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">\t\t\t  <span class=\"keyword\">ktime_t</span> *expires, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> slack)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> rc = -EINTR;</span><br><span class=\"line\"></span><br><span class=\"line\">\tset_current_state(state);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pwq-&gt;triggered)</span><br><span class=\"line\">\t\trc = schedule_hrtimeout_range(expires, slack, HRTIMER_MODE_ABS);</span><br><span class=\"line\">\t__set_current_state(TASK_RUNNING);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Prepare for the next iteration.</span></span><br><span class=\"line\"><span class=\"comment\">\t *</span></span><br><span class=\"line\"><span class=\"comment\">\t * The following smp_store_mb() serves two purposes.  First, it&#x27;s</span></span><br><span class=\"line\"><span class=\"comment\">\t * the counterpart rmb of the wmb in pollwake() such that data</span></span><br><span class=\"line\"><span class=\"comment\">\t * written before wake up is always visible after wake up.</span></span><br><span class=\"line\"><span class=\"comment\">\t * Second, the full barrier guarantees that triggered clearing</span></span><br><span class=\"line\"><span class=\"comment\">\t * doesn&#x27;t pass event check of the next iteration.  Note that</span></span><br><span class=\"line\"><span class=\"comment\">\t * this problem doesn&#x27;t exist for the first iteration as</span></span><br><span class=\"line\"><span class=\"comment\">\t * add_wait_queue() has full barrier semantics.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\tsmp_store_mb(pwq-&gt;triggered, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> rc;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"poll-wait\"><a class=\"header-anchor\" href=\"#poll-wait\">¶</a>poll_wait</h3>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\"> * structures and helpers for f_op-&gt;poll implementations</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"> <span class=\"comment\">//类似一个回调函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">typedef</span> <span class=\"title\">void</span> <span class=\"params\">(*poll_queue_proc)</span><span class=\"params\">(struct file *, <span class=\"keyword\">wait_queue_head_t</span> *, struct poll_table_struct *)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">poll_table_struct</span> &#123;</span></span><br><span class=\"line\">\tpoll_queue_proc _qproc; <span class=\"comment\">//callback机制</span></span><br><span class=\"line\">\t<span class=\"keyword\">__poll_t</span> _key;</span><br><span class=\"line\">&#125; poll_table;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">inline</span> <span class=\"keyword\">void</span> <span class=\"title\">poll_wait</span><span class=\"params\">(struct file * filp, <span class=\"keyword\">wait_queue_head_t</span> * wait_address, poll_table *p)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p &amp;&amp; p-&gt;_qproc &amp;&amp; wait_address)</span><br><span class=\"line\">\t\tp-&gt;_qproc(filp, wait_address, p);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"fd数量问题\"><a class=\"header-anchor\" href=\"#fd数量问题\">¶</a>fd数量问题</h3>\n<blockquote>\n<p>include/uapi/linux/posix_types.h</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> __FD_SETSIZE\t1024</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> &#123;</span></span><br><span class=\"line\">  <span class=\"comment\">//__FD_SETSIZE当下标使？？？what！</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> fds_bits[__FD_SETSIZE / (<span class=\"number\">8</span> * <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">long</span>))];</span><br><span class=\"line\">&#125; __kernel_fd_set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">fd</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> *<span class=\"title\">file</span>;</span></span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> flags;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>从上面看来文件描述符只是一个整数值，用来操作下标的，主要是每一个进程file数组的下标。理解do_select是核心。</p>\n</blockquote>\n<h3 id=\"select-与poll\"><a class=\"header-anchor\" href=\"#select-与poll\">¶</a>select 与poll</h3>\n<blockquote>\n<p>poll取消了最大数量的限制,返回结果还是需要轮询来获取就绪的描述符。</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pollfd</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">int</span> fd;</span><br><span class=\"line\">\t<span class=\"keyword\">short</span> events; <span class=\"comment\">//request</span></span><br><span class=\"line\">\t<span class=\"keyword\">short</span> revents; <span class=\"comment\">// return</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>具体见后续更新「poll源码」</p>\n<h3 id=\"参考\"><a class=\"header-anchor\" href=\"#参考\">¶</a>参考</h3>\n<p><a href=\"https://www.oreilly.com/openbook/linuxdrive3/book/\">Linux Device Drivers, Third Edition</a><br>\n<a href=\"https://stackoverflow.com/questions/11496059/how-do-system-calls-like-select-or-poll-work-under-the-hood\">How do system calls like select() or poll() work under the hood?</a></p>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/linux%E6%BA%90%E7%A0%81-select-1.png","popularPost_tmp_gaData":{"updated":"Wed Nov 18 2020 19:09:17 GMT+0800 (中国标准时间)","title":"「21」linux select源码","path":"archives/ba7b70bf.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/linux%E6%BA%90%E7%A0%81-select-1.png","excerpt":"<blockquote>\n<p>select poll epoll三个老生长谈的问题.这次不是来讲区别的，后续会更新一篇关于三者区别的。</p>\n</blockquote>\n<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>select属于linux系列的文件系统「fs」的范畴，每次的系统调用、打开软件、启动程序等等都会涉及到文件的读写，<br>\n这个是在所难免的。</p>\n<p>那么I/O事件的基本思路：文件准备ok，开始读写，等函数返回，根据结果继续运行.</p>\n<p>如果是自己实现，大体上无非以下思路：</p>","date":{"_isAMomentObject":true,"_i":"2020-11-17T11:09:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-17T11:09:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Day","Linux"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":5541},{"title":"「22」GPM g0和m0","date":"2020-11-18T13:09:17.000Z","updated":"2020-11-18T15:09:17.000Z","keywords":"GPM,Go,Go调度器,Go资源调度器","abbrlink":"392d66f0","_content":"\n### 前序\n\nGPM算是经典的调度模型，但是每个程序都需要一个启动的函数或者入口；\nGPM也不例外。\n直接分析源码，显得很枯燥，如果说要你设计GPM中的G和M的执行关系，你应该怎么设计呢？\n<!--more-->\n>go version: 1.14.3\n\n\n### 尝试设计\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182201.png)\n如果只是这样的话，那总体的G和M是否需要管理者，毕竟在1.1版本之前只有GM模型，，，\n那么为了好管理M和G，就需要第一个M和G成为管理者，类似于大总管这样的存在。\n\n### 再次设计\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182219.png)\n\n### 关键点：\n* p先启动\n* g0的创建；用于创建新的G\n* m0的创建；用于创建新的M\n* 启动main调度整个系统\n>上述这样比较合理点。\n\n\n### Go源码的如何实现？\n\n[bootstrap sequence](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L524)\n\n\n```go\n// The bootstrap sequence is:\n//\n//\tcall osinit\n//\tcall schedinit\n//\tmake & queue new G\n//\tcall runtime·mstart\n//\n// The new G calls runtime·main.\n```\n\n>[g0和m0初始化过程](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L194)\n\n```c#\n// set the per-goroutine and per-mach \"registers\"\n\tget_tls(BX)\n\tLEAQ\truntime·g0(SB), CX\n\tMOVQ\tCX, g(BX)\n\tLEAQ\truntime·m0(SB), AX\n\n\t// save m->g0 = g0\n\tMOVQ\tCX, m_g0(AX)\n\t// save m0 to g0->m\n\tMOVQ\tAX, g_m(CX)\n\n\tCLD\t\t\t\t// convention is D is always left cleared\n\tCALL\truntime·check(SB)\n\n\tMOVL\t16(SP), AX\t\t// copy argc\n\tMOVL\tAX, 0(SP)\n\tMOVQ\t24(SP), AX\t\t// copy argv\n\tMOVQ\tAX, 8(SP)\n\tCALL\truntime·args(SB)\n\tCALL\truntime·osinit(SB)\n\tCALL\truntime·schedinit(SB)\n\n\t// create a new goroutine to start program\n\tMOVQ\t$runtime·mainPC(SB), AX\t\t// entry\n\tPUSHQ\tAX\n\tPUSHQ\t$0\t\t\t// arg size\n\tCALL\truntime·newproc(SB)\n\tPOPQ\tAX\n\tPOPQ\tAX\n\n\t// start this M\n\tCALL\truntime·mstart(SB)\n```\n\n\n\n>到这里了，初始化思路基本确定了\n```\n1、initP\n2、m0和g0的绑定\n3、new groutine for main主线程启动\n4、mstart\n```\n\n### m init涉及到的函数\n* mstart\n* mstart1\n* mstartm0\n\n#### mstart\n\n```go\n// mstart is the entry-point for new Ms.\n//\n// This must not split the stack because we may not even have stack\n// bounds set up yet.\n//\n// May run during STW (because it doesn't have a P yet), so write\n// barriers are not allowed.\n//\n//go:nosplit\n//go:nowritebarrierrec\nfunc mstart() {\n\t_g_ := getg()\n\n    //低位判断\n\tosStack := _g_.stack.lo == 0\n\tif osStack {\n\t\t// Initialize stack bounds from system stack.\n\t\t// Cgo may have left stack size in stack.hi.\n\t\t// minit may update the stack bounds.\n\t\tsize := _g_.stack.hi\n\t\tif size == 0 {\n\t\t\tsize = 8192 * sys.StackGuardMultiplier\n        }\n        //g0的stack空间是真的大\n\t\t_g_.stack.hi = uintptr(noescape(unsafe.Pointer(&size)))\n\t\t_g_.stack.lo = _g_.stack.hi - size + 1024\n\t}\n\t// Initialize stack guard so that we can start calling regular\n\t// Go code.\n\t_g_.stackguard0 = _g_.stack.lo + _StackGuard\n\t// This is the g0, so we can also call go:systemstack\n\t// functions, which check stackguard1.\n\t_g_.stackguard1 = _g_.stackguard0\n\tmstart1()\n\n\t// Exit this thread.\n\tswitch GOOS {\n\tcase \"windows\", \"solaris\", \"illumos\", \"plan9\", \"darwin\", \"aix\":\n\t\t// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate\n\t\t// the stack, but put it in _g_.stack before mstart,\n\t\t// so the logic above hasn't set osStack yet.\n\t\tosStack = true\n\t}\n\tmexit(osStack)\n}\n```\n\n#### mstart1\n\n```go\n\nfunc mstart1() {\n\t_g_ := getg()\n\n    //启动非g0就崩盘了\n\tif _g_ != _g_.m.g0 {\n\t\tthrow(\"bad runtime·mstart\")\n\t}\n\n    //初始化\n\t// Record the caller for use as the top of stack in mcall and\n\t// for terminating the thread.\n\t// We're never coming back to mstart1 after we call schedule,\n\t// so other calls can reuse the current frame.\n\tsave(getcallerpc(), getcallersp())\n\tasminit()\n\tminit()\n\n\t// Install signal handlers; after minit so that minit can\n    // prepare the thread to be able to handle the signals.\n    //m0启动\n\tif _g_.m == &m0 {\n\t\tmstartm0()\n\t}\n\n\tif fn := _g_.m.mstartfn; fn != nil {\n\t\tfn()\n\t}\n\n\tif _g_.m != &m0 {\n\t\tacquirep(_g_.m.nextp.ptr())\n\t\t_g_.m.nextp = 0\n    }\n    //开始调度\n\tschedule()\n}\n```\n\n\n#### mstartm0\n\n```go\n// mstart1的具体实现，仅run在m0上\n// mstartm0 implements part of mstart1 that only runs on the m0.\n//\n// Write barriers are allowed here because we know the GC can't be\n// running yet, so they'll be no-ops.\n//\n//go:yeswritebarrierrec\nfunc mstartm0() {\n\t// Create an extra M for callbacks on threads not created by Go.\n\t// An extra M is also needed on Windows for callbacks created by\n    // syscall.NewCallback. See issue #6751 for details.\n    //windows下需要一个额外的M\n\tif (iscgo || GOOS == \"windows\") && !cgoHasExtraM {\n\t\tcgoHasExtraM = true\n\t\tnewextram()\n    }\n    //初始化信号量,用于后续调度\n\tinitsig(false)\n}\n```\n\n#### [后续schedule函数](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L1119)\n\n>管家有了，那么开始调度吧....。\n\n### 下节：\n\n* schedule","source":"_posts/22-GPM g0和m0.md","raw":"---\ntitle: 「22」GPM g0和m0\ndate: '2020/11/18 21:09:17'\nupdated: '2020/11/18 23:09:17'\nkeywords: 'GPM,Go,Go调度器,Go资源调度器'\ntags:\n  - Go\n  - GPM\n  - Go源码\nabbrlink: 392d66f0\n---\n\n### 前序\n\nGPM算是经典的调度模型，但是每个程序都需要一个启动的函数或者入口；\nGPM也不例外。\n直接分析源码，显得很枯燥，如果说要你设计GPM中的G和M的执行关系，你应该怎么设计呢？\n<!--more-->\n>go version: 1.14.3\n\n\n### 尝试设计\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182201.png)\n如果只是这样的话，那总体的G和M是否需要管理者，毕竟在1.1版本之前只有GM模型，，，\n那么为了好管理M和G，就需要第一个M和G成为管理者，类似于大总管这样的存在。\n\n### 再次设计\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182219.png)\n\n### 关键点：\n* p先启动\n* g0的创建；用于创建新的G\n* m0的创建；用于创建新的M\n* 启动main调度整个系统\n>上述这样比较合理点。\n\n\n### Go源码的如何实现？\n\n[bootstrap sequence](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L524)\n\n\n```go\n// The bootstrap sequence is:\n//\n//\tcall osinit\n//\tcall schedinit\n//\tmake & queue new G\n//\tcall runtime·mstart\n//\n// The new G calls runtime·main.\n```\n\n>[g0和m0初始化过程](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L194)\n\n```c#\n// set the per-goroutine and per-mach \"registers\"\n\tget_tls(BX)\n\tLEAQ\truntime·g0(SB), CX\n\tMOVQ\tCX, g(BX)\n\tLEAQ\truntime·m0(SB), AX\n\n\t// save m->g0 = g0\n\tMOVQ\tCX, m_g0(AX)\n\t// save m0 to g0->m\n\tMOVQ\tAX, g_m(CX)\n\n\tCLD\t\t\t\t// convention is D is always left cleared\n\tCALL\truntime·check(SB)\n\n\tMOVL\t16(SP), AX\t\t// copy argc\n\tMOVL\tAX, 0(SP)\n\tMOVQ\t24(SP), AX\t\t// copy argv\n\tMOVQ\tAX, 8(SP)\n\tCALL\truntime·args(SB)\n\tCALL\truntime·osinit(SB)\n\tCALL\truntime·schedinit(SB)\n\n\t// create a new goroutine to start program\n\tMOVQ\t$runtime·mainPC(SB), AX\t\t// entry\n\tPUSHQ\tAX\n\tPUSHQ\t$0\t\t\t// arg size\n\tCALL\truntime·newproc(SB)\n\tPOPQ\tAX\n\tPOPQ\tAX\n\n\t// start this M\n\tCALL\truntime·mstart(SB)\n```\n\n\n\n>到这里了，初始化思路基本确定了\n```\n1、initP\n2、m0和g0的绑定\n3、new groutine for main主线程启动\n4、mstart\n```\n\n### m init涉及到的函数\n* mstart\n* mstart1\n* mstartm0\n\n#### mstart\n\n```go\n// mstart is the entry-point for new Ms.\n//\n// This must not split the stack because we may not even have stack\n// bounds set up yet.\n//\n// May run during STW (because it doesn't have a P yet), so write\n// barriers are not allowed.\n//\n//go:nosplit\n//go:nowritebarrierrec\nfunc mstart() {\n\t_g_ := getg()\n\n    //低位判断\n\tosStack := _g_.stack.lo == 0\n\tif osStack {\n\t\t// Initialize stack bounds from system stack.\n\t\t// Cgo may have left stack size in stack.hi.\n\t\t// minit may update the stack bounds.\n\t\tsize := _g_.stack.hi\n\t\tif size == 0 {\n\t\t\tsize = 8192 * sys.StackGuardMultiplier\n        }\n        //g0的stack空间是真的大\n\t\t_g_.stack.hi = uintptr(noescape(unsafe.Pointer(&size)))\n\t\t_g_.stack.lo = _g_.stack.hi - size + 1024\n\t}\n\t// Initialize stack guard so that we can start calling regular\n\t// Go code.\n\t_g_.stackguard0 = _g_.stack.lo + _StackGuard\n\t// This is the g0, so we can also call go:systemstack\n\t// functions, which check stackguard1.\n\t_g_.stackguard1 = _g_.stackguard0\n\tmstart1()\n\n\t// Exit this thread.\n\tswitch GOOS {\n\tcase \"windows\", \"solaris\", \"illumos\", \"plan9\", \"darwin\", \"aix\":\n\t\t// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate\n\t\t// the stack, but put it in _g_.stack before mstart,\n\t\t// so the logic above hasn't set osStack yet.\n\t\tosStack = true\n\t}\n\tmexit(osStack)\n}\n```\n\n#### mstart1\n\n```go\n\nfunc mstart1() {\n\t_g_ := getg()\n\n    //启动非g0就崩盘了\n\tif _g_ != _g_.m.g0 {\n\t\tthrow(\"bad runtime·mstart\")\n\t}\n\n    //初始化\n\t// Record the caller for use as the top of stack in mcall and\n\t// for terminating the thread.\n\t// We're never coming back to mstart1 after we call schedule,\n\t// so other calls can reuse the current frame.\n\tsave(getcallerpc(), getcallersp())\n\tasminit()\n\tminit()\n\n\t// Install signal handlers; after minit so that minit can\n    // prepare the thread to be able to handle the signals.\n    //m0启动\n\tif _g_.m == &m0 {\n\t\tmstartm0()\n\t}\n\n\tif fn := _g_.m.mstartfn; fn != nil {\n\t\tfn()\n\t}\n\n\tif _g_.m != &m0 {\n\t\tacquirep(_g_.m.nextp.ptr())\n\t\t_g_.m.nextp = 0\n    }\n    //开始调度\n\tschedule()\n}\n```\n\n\n#### mstartm0\n\n```go\n// mstart1的具体实现，仅run在m0上\n// mstartm0 implements part of mstart1 that only runs on the m0.\n//\n// Write barriers are allowed here because we know the GC can't be\n// running yet, so they'll be no-ops.\n//\n//go:yeswritebarrierrec\nfunc mstartm0() {\n\t// Create an extra M for callbacks on threads not created by Go.\n\t// An extra M is also needed on Windows for callbacks created by\n    // syscall.NewCallback. See issue #6751 for details.\n    //windows下需要一个额外的M\n\tif (iscgo || GOOS == \"windows\") && !cgoHasExtraM {\n\t\tcgoHasExtraM = true\n\t\tnewextram()\n    }\n    //初始化信号量,用于后续调度\n\tinitsig(false)\n}\n```\n\n#### [后续schedule函数](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L1119)\n\n>管家有了，那么开始调度吧....。\n\n### 下节：\n\n* schedule","slug":"22-GPM g0和m0","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdl900153ci73ytm29z6","content":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>GPM算是经典的调度模型，但是每个程序都需要一个启动的函数或者入口；<br>\nGPM也不例外。<br>\n直接分析源码，显得很枯燥，如果说要你设计GPM中的G和M的执行关系，你应该怎么设计呢？</p>\n<a id=\"more\"></a>\n<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h3 id=\"尝试设计\"><a class=\"header-anchor\" href=\"#尝试设计\">¶</a>尝试设计</h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182201.png\" alt=\"\"><br>\n如果只是这样的话，那总体的G和M是否需要管理者，毕竟在1.1版本之前只有GM模型，，，<br>\n那么为了好管理M和G，就需要第一个M和G成为管理者，类似于大总管这样的存在。</p>\n<h3 id=\"再次设计\"><a class=\"header-anchor\" href=\"#再次设计\">¶</a>再次设计</h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182219.png\" alt=\"\"></p>\n<h3 id=\"关键点：\"><a class=\"header-anchor\" href=\"#关键点：\">¶</a>关键点：</h3>\n<ul>\n<li>p先启动</li>\n<li>g0的创建；用于创建新的G</li>\n<li>m0的创建；用于创建新的M</li>\n<li>启动main调度整个系统</li>\n</ul>\n<blockquote>\n<p>上述这样比较合理点。</p>\n</blockquote>\n<h3 id=\"Go源码的如何实现？\"><a class=\"header-anchor\" href=\"#Go源码的如何实现？\">¶</a>Go源码的如何实现？</h3>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L524\">bootstrap sequence</a></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// The bootstrap sequence is:</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//\tcall osinit</span></span><br><span class=\"line\"><span class=\"comment\">//\tcall schedinit</span></span><br><span class=\"line\"><span class=\"comment\">//\tmake &amp; queue new G</span></span><br><span class=\"line\"><span class=\"comment\">//\tcall runtime·mstart</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// The new G calls runtime·main.</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L194\">g0和m0初始化过程</a></p>\n</blockquote>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// set the per-goroutine and per-mach &quot;registers&quot;</span></span><br><span class=\"line\">\tget_tls(BX)</span><br><span class=\"line\">\tLEAQ\truntime·g0(SB), CX</span><br><span class=\"line\">\tMOVQ\tCX, g(BX)</span><br><span class=\"line\">\tLEAQ\truntime·m0(SB), AX</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// save m-&gt;g0 = g0</span></span><br><span class=\"line\">\tMOVQ\tCX, m_g0(AX)</span><br><span class=\"line\">\t<span class=\"comment\">// save m0 to g0-&gt;m</span></span><br><span class=\"line\">\tMOVQ\tAX, g_m(CX)</span><br><span class=\"line\"></span><br><span class=\"line\">\tCLD\t\t\t\t<span class=\"comment\">// convention is D is always left cleared</span></span><br><span class=\"line\">\tCALL\truntime·check(SB)</span><br><span class=\"line\"></span><br><span class=\"line\">\tMOVL\t<span class=\"number\">16</span>(SP), AX\t\t<span class=\"comment\">// copy argc</span></span><br><span class=\"line\">\tMOVL\tAX, <span class=\"number\">0</span>(SP)</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">24</span>(SP), AX\t\t<span class=\"comment\">// copy argv</span></span><br><span class=\"line\">\tMOVQ\tAX, <span class=\"number\">8</span>(SP)</span><br><span class=\"line\">\tCALL\truntime·args(SB)</span><br><span class=\"line\">\tCALL\truntime·osinit(SB)</span><br><span class=\"line\">\tCALL\truntime·schedinit(SB)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// create a new goroutine to start program</span></span><br><span class=\"line\">\tMOVQ\t$runtime·mainPC(SB), AX\t\t<span class=\"comment\">// entry</span></span><br><span class=\"line\">\tPUSHQ\tAX</span><br><span class=\"line\">\tPUSHQ\t$<span class=\"number\">0</span>\t\t\t<span class=\"comment\">// arg size</span></span><br><span class=\"line\">\tCALL\truntime·newproc(SB)</span><br><span class=\"line\">\tPOPQ\tAX</span><br><span class=\"line\">\tPOPQ\tAX</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// start this M</span></span><br><span class=\"line\">\tCALL\truntime·mstart(SB)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>到这里了，初始化思路基本确定了</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、initP</span><br><span class=\"line\">2、m0和g0的绑定</span><br><span class=\"line\">3、new groutine for main主线程启动</span><br><span class=\"line\">4、mstart</span><br></pre></td></tr></table></figure>\n<h3 id=\"m-init涉及到的函数\"><a class=\"header-anchor\" href=\"#m-init涉及到的函数\">¶</a>m init涉及到的函数</h3>\n<ul>\n<li>mstart</li>\n<li>mstart1</li>\n<li>mstartm0</li>\n</ul>\n<h4 id=\"mstart\"><a class=\"header-anchor\" href=\"#mstart\">¶</a>mstart</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mstart is the entry-point for new Ms.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// This must not split the stack because we may not even have stack</span></span><br><span class=\"line\"><span class=\"comment\">// bounds set up yet.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// May run during STW (because it doesn&#x27;t have a P yet), so write</span></span><br><span class=\"line\"><span class=\"comment\">// barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:nosplit</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mstart</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//低位判断</span></span><br><span class=\"line\">\tosStack := _g_.stack.lo == <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> osStack &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Initialize stack bounds from system stack.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// Cgo may have left stack size in stack.hi.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// minit may update the stack bounds.</span></span><br><span class=\"line\">\t\tsize := _g_.stack.hi</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> size == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tsize = <span class=\"number\">8192</span> * sys.StackGuardMultiplier</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//g0的stack空间是真的大</span></span><br><span class=\"line\">\t\t_g_.stack.hi = <span class=\"keyword\">uintptr</span>(noescape(unsafe.Pointer(&amp;size)))</span><br><span class=\"line\">\t\t_g_.stack.lo = _g_.stack.hi - size + <span class=\"number\">1024</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Initialize stack guard so that we can start calling regular</span></span><br><span class=\"line\">\t<span class=\"comment\">// Go code.</span></span><br><span class=\"line\">\t_g_.stackguard0 = _g_.stack.lo + _StackGuard</span><br><span class=\"line\">\t<span class=\"comment\">// This is the g0, so we can also call go:systemstack</span></span><br><span class=\"line\">\t<span class=\"comment\">// functions, which check stackguard1.</span></span><br><span class=\"line\">\t_g_.stackguard1 = _g_.stackguard0</span><br><span class=\"line\">\tmstart1()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Exit this thread.</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> GOOS &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"string\">&quot;windows&quot;</span>, <span class=\"string\">&quot;solaris&quot;</span>, <span class=\"string\">&quot;illumos&quot;</span>, <span class=\"string\">&quot;plan9&quot;</span>, <span class=\"string\">&quot;darwin&quot;</span>, <span class=\"string\">&quot;aix&quot;</span>:</span><br><span class=\"line\">\t\t<span class=\"comment\">// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the stack, but put it in _g_.stack before mstart,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// so the logic above hasn&#x27;t set osStack yet.</span></span><br><span class=\"line\">\t\tosStack = <span class=\"literal\">true</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmexit(osStack)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"mstart1\"><a class=\"header-anchor\" href=\"#mstart1\">¶</a>mstart1</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mstart1</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//启动非g0就崩盘了</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _g_ != _g_.m.g0 &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;bad runtime·mstart&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"comment\">// Record the caller for use as the top of stack in mcall and</span></span><br><span class=\"line\">\t<span class=\"comment\">// for terminating the thread.</span></span><br><span class=\"line\">\t<span class=\"comment\">// We&#x27;re never coming back to mstart1 after we call schedule,</span></span><br><span class=\"line\">\t<span class=\"comment\">// so other calls can reuse the current frame.</span></span><br><span class=\"line\">\tsave(getcallerpc(), getcallersp())</span><br><span class=\"line\">\tasminit()</span><br><span class=\"line\">\tminit()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Install signal handlers; after minit so that minit can</span></span><br><span class=\"line\">    <span class=\"comment\">// prepare the thread to be able to handle the signals.</span></span><br><span class=\"line\">    <span class=\"comment\">//m0启动</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _g_.m == &amp;m0 &#123;</span><br><span class=\"line\">\t\tmstartm0()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> fn := _g_.m.mstartfn; fn != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfn()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _g_.m != &amp;m0 &#123;</span><br><span class=\"line\">\t\tacquirep(_g_.m.nextp.ptr())</span><br><span class=\"line\">\t\t_g_.m.nextp = <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//开始调度</span></span><br><span class=\"line\">\tschedule()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"mstartm0\"><a class=\"header-anchor\" href=\"#mstartm0\">¶</a>mstartm0</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mstart1的具体实现，仅run在m0上</span></span><br><span class=\"line\"><span class=\"comment\">// mstartm0 implements part of mstart1 that only runs on the m0.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// Write barriers are allowed here because we know the GC can&#x27;t be</span></span><br><span class=\"line\"><span class=\"comment\">// running yet, so they&#x27;ll be no-ops.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:yeswritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mstartm0</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Create an extra M for callbacks on threads not created by Go.</span></span><br><span class=\"line\">\t<span class=\"comment\">// An extra M is also needed on Windows for callbacks created by</span></span><br><span class=\"line\">    <span class=\"comment\">// syscall.NewCallback. See issue #6751 for details.</span></span><br><span class=\"line\">    <span class=\"comment\">//windows下需要一个额外的M</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (iscgo || GOOS == <span class=\"string\">&quot;windows&quot;</span>) &amp;&amp; !cgoHasExtraM &#123;</span><br><span class=\"line\">\t\tcgoHasExtraM = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\tnewextram()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//初始化信号量,用于后续调度</span></span><br><span class=\"line\">\tinitsig(<span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"后续schedule函数\"><a class=\"header-anchor\" href=\"#后续schedule函数\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L1119\">后续schedule函数</a></h4>\n<blockquote>\n<p>管家有了，那么开始调度吧…。</p>\n</blockquote>\n<h3 id=\"下节：\"><a class=\"header-anchor\" href=\"#下节：\">¶</a>下节：</h3>\n<ul>\n<li>schedule</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>GPM算是经典的调度模型，但是每个程序都需要一个启动的函数或者入口；<br>\nGPM也不例外。<br>\n直接分析源码，显得很枯燥，如果说要你设计GPM中的G和M的执行关系，你应该怎么设计呢？</p>","more":"<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h3 id=\"尝试设计\"><a class=\"header-anchor\" href=\"#尝试设计\">¶</a>尝试设计</h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182201.png\" alt=\"\"><br>\n如果只是这样的话，那总体的G和M是否需要管理者，毕竟在1.1版本之前只有GM模型，，，<br>\n那么为了好管理M和G，就需要第一个M和G成为管理者，类似于大总管这样的存在。</p>\n<h3 id=\"再次设计\"><a class=\"header-anchor\" href=\"#再次设计\">¶</a>再次设计</h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182219.png\" alt=\"\"></p>\n<h3 id=\"关键点：\"><a class=\"header-anchor\" href=\"#关键点：\">¶</a>关键点：</h3>\n<ul>\n<li>p先启动</li>\n<li>g0的创建；用于创建新的G</li>\n<li>m0的创建；用于创建新的M</li>\n<li>启动main调度整个系统</li>\n</ul>\n<blockquote>\n<p>上述这样比较合理点。</p>\n</blockquote>\n<h3 id=\"Go源码的如何实现？\"><a class=\"header-anchor\" href=\"#Go源码的如何实现？\">¶</a>Go源码的如何实现？</h3>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L524\">bootstrap sequence</a></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// The bootstrap sequence is:</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//\tcall osinit</span></span><br><span class=\"line\"><span class=\"comment\">//\tcall schedinit</span></span><br><span class=\"line\"><span class=\"comment\">//\tmake &amp; queue new G</span></span><br><span class=\"line\"><span class=\"comment\">//\tcall runtime·mstart</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// The new G calls runtime·main.</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/asm_amd64.s#L194\">g0和m0初始化过程</a></p>\n</blockquote>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// set the per-goroutine and per-mach &quot;registers&quot;</span></span><br><span class=\"line\">\tget_tls(BX)</span><br><span class=\"line\">\tLEAQ\truntime·g0(SB), CX</span><br><span class=\"line\">\tMOVQ\tCX, g(BX)</span><br><span class=\"line\">\tLEAQ\truntime·m0(SB), AX</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// save m-&gt;g0 = g0</span></span><br><span class=\"line\">\tMOVQ\tCX, m_g0(AX)</span><br><span class=\"line\">\t<span class=\"comment\">// save m0 to g0-&gt;m</span></span><br><span class=\"line\">\tMOVQ\tAX, g_m(CX)</span><br><span class=\"line\"></span><br><span class=\"line\">\tCLD\t\t\t\t<span class=\"comment\">// convention is D is always left cleared</span></span><br><span class=\"line\">\tCALL\truntime·check(SB)</span><br><span class=\"line\"></span><br><span class=\"line\">\tMOVL\t<span class=\"number\">16</span>(SP), AX\t\t<span class=\"comment\">// copy argc</span></span><br><span class=\"line\">\tMOVL\tAX, <span class=\"number\">0</span>(SP)</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">24</span>(SP), AX\t\t<span class=\"comment\">// copy argv</span></span><br><span class=\"line\">\tMOVQ\tAX, <span class=\"number\">8</span>(SP)</span><br><span class=\"line\">\tCALL\truntime·args(SB)</span><br><span class=\"line\">\tCALL\truntime·osinit(SB)</span><br><span class=\"line\">\tCALL\truntime·schedinit(SB)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// create a new goroutine to start program</span></span><br><span class=\"line\">\tMOVQ\t$runtime·mainPC(SB), AX\t\t<span class=\"comment\">// entry</span></span><br><span class=\"line\">\tPUSHQ\tAX</span><br><span class=\"line\">\tPUSHQ\t$<span class=\"number\">0</span>\t\t\t<span class=\"comment\">// arg size</span></span><br><span class=\"line\">\tCALL\truntime·newproc(SB)</span><br><span class=\"line\">\tPOPQ\tAX</span><br><span class=\"line\">\tPOPQ\tAX</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// start this M</span></span><br><span class=\"line\">\tCALL\truntime·mstart(SB)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>到这里了，初始化思路基本确定了</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、initP</span><br><span class=\"line\">2、m0和g0的绑定</span><br><span class=\"line\">3、new groutine for main主线程启动</span><br><span class=\"line\">4、mstart</span><br></pre></td></tr></table></figure>\n<h3 id=\"m-init涉及到的函数\"><a class=\"header-anchor\" href=\"#m-init涉及到的函数\">¶</a>m init涉及到的函数</h3>\n<ul>\n<li>mstart</li>\n<li>mstart1</li>\n<li>mstartm0</li>\n</ul>\n<h4 id=\"mstart\"><a class=\"header-anchor\" href=\"#mstart\">¶</a>mstart</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mstart is the entry-point for new Ms.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// This must not split the stack because we may not even have stack</span></span><br><span class=\"line\"><span class=\"comment\">// bounds set up yet.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// May run during STW (because it doesn&#x27;t have a P yet), so write</span></span><br><span class=\"line\"><span class=\"comment\">// barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:nosplit</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mstart</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//低位判断</span></span><br><span class=\"line\">\tosStack := _g_.stack.lo == <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> osStack &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Initialize stack bounds from system stack.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// Cgo may have left stack size in stack.hi.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// minit may update the stack bounds.</span></span><br><span class=\"line\">\t\tsize := _g_.stack.hi</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> size == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tsize = <span class=\"number\">8192</span> * sys.StackGuardMultiplier</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//g0的stack空间是真的大</span></span><br><span class=\"line\">\t\t_g_.stack.hi = <span class=\"keyword\">uintptr</span>(noescape(unsafe.Pointer(&amp;size)))</span><br><span class=\"line\">\t\t_g_.stack.lo = _g_.stack.hi - size + <span class=\"number\">1024</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Initialize stack guard so that we can start calling regular</span></span><br><span class=\"line\">\t<span class=\"comment\">// Go code.</span></span><br><span class=\"line\">\t_g_.stackguard0 = _g_.stack.lo + _StackGuard</span><br><span class=\"line\">\t<span class=\"comment\">// This is the g0, so we can also call go:systemstack</span></span><br><span class=\"line\">\t<span class=\"comment\">// functions, which check stackguard1.</span></span><br><span class=\"line\">\t_g_.stackguard1 = _g_.stackguard0</span><br><span class=\"line\">\tmstart1()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Exit this thread.</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> GOOS &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"string\">&quot;windows&quot;</span>, <span class=\"string\">&quot;solaris&quot;</span>, <span class=\"string\">&quot;illumos&quot;</span>, <span class=\"string\">&quot;plan9&quot;</span>, <span class=\"string\">&quot;darwin&quot;</span>, <span class=\"string\">&quot;aix&quot;</span>:</span><br><span class=\"line\">\t\t<span class=\"comment\">// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the stack, but put it in _g_.stack before mstart,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// so the logic above hasn&#x27;t set osStack yet.</span></span><br><span class=\"line\">\t\tosStack = <span class=\"literal\">true</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmexit(osStack)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"mstart1\"><a class=\"header-anchor\" href=\"#mstart1\">¶</a>mstart1</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mstart1</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//启动非g0就崩盘了</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _g_ != _g_.m.g0 &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;bad runtime·mstart&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//初始化</span></span><br><span class=\"line\">\t<span class=\"comment\">// Record the caller for use as the top of stack in mcall and</span></span><br><span class=\"line\">\t<span class=\"comment\">// for terminating the thread.</span></span><br><span class=\"line\">\t<span class=\"comment\">// We&#x27;re never coming back to mstart1 after we call schedule,</span></span><br><span class=\"line\">\t<span class=\"comment\">// so other calls can reuse the current frame.</span></span><br><span class=\"line\">\tsave(getcallerpc(), getcallersp())</span><br><span class=\"line\">\tasminit()</span><br><span class=\"line\">\tminit()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Install signal handlers; after minit so that minit can</span></span><br><span class=\"line\">    <span class=\"comment\">// prepare the thread to be able to handle the signals.</span></span><br><span class=\"line\">    <span class=\"comment\">//m0启动</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _g_.m == &amp;m0 &#123;</span><br><span class=\"line\">\t\tmstartm0()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> fn := _g_.m.mstartfn; fn != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tfn()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _g_.m != &amp;m0 &#123;</span><br><span class=\"line\">\t\tacquirep(_g_.m.nextp.ptr())</span><br><span class=\"line\">\t\t_g_.m.nextp = <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//开始调度</span></span><br><span class=\"line\">\tschedule()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"mstartm0\"><a class=\"header-anchor\" href=\"#mstartm0\">¶</a>mstartm0</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mstart1的具体实现，仅run在m0上</span></span><br><span class=\"line\"><span class=\"comment\">// mstartm0 implements part of mstart1 that only runs on the m0.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// Write barriers are allowed here because we know the GC can&#x27;t be</span></span><br><span class=\"line\"><span class=\"comment\">// running yet, so they&#x27;ll be no-ops.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:yeswritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mstartm0</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Create an extra M for callbacks on threads not created by Go.</span></span><br><span class=\"line\">\t<span class=\"comment\">// An extra M is also needed on Windows for callbacks created by</span></span><br><span class=\"line\">    <span class=\"comment\">// syscall.NewCallback. See issue #6751 for details.</span></span><br><span class=\"line\">    <span class=\"comment\">//windows下需要一个额外的M</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (iscgo || GOOS == <span class=\"string\">&quot;windows&quot;</span>) &amp;&amp; !cgoHasExtraM &#123;</span><br><span class=\"line\">\t\tcgoHasExtraM = <span class=\"literal\">true</span></span><br><span class=\"line\">\t\tnewextram()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//初始化信号量,用于后续调度</span></span><br><span class=\"line\">\tinitsig(<span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"后续schedule函数\"><a class=\"header-anchor\" href=\"#后续schedule函数\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L1119\">后续schedule函数</a></h4>\n<blockquote>\n<p>管家有了，那么开始调度吧…。</p>\n</blockquote>\n<h3 id=\"下节：\"><a class=\"header-anchor\" href=\"#下节：\">¶</a>下节：</h3>\n<ul>\n<li>schedule</li>\n</ul>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182201.png","popularPost_tmp_gaData":{"updated":"Wed Nov 18 2020 23:09:17 GMT+0800 (中国标准时间)","title":"「22」GPM g0和m0","path":"archives/392d66f0.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM202011182201.png","excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>GPM算是经典的调度模型，但是每个程序都需要一个启动的函数或者入口；<br>\nGPM也不例外。<br>\n直接分析源码，显得很枯燥，如果说要你设计GPM中的G和M的执行关系，你应该怎么设计呢？</p>","date":{"_isAMomentObject":true,"_i":"2020-11-18T13:09:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-18T13:09:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","GPM","Go源码"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":3616},{"title":"「23」GPM main入口函数","date":"2020-11-21T13:00:17.000Z","updated":"2020-11-21T13:00:17.000Z","keywords":"GPM,Go,Go调度器,Go资源调度器","abbrlink":"9bb71eca","_content":"\n\n前面g0和m0瞎扯了部分的入口和一些关键的点。\n\n本来应该扯扯shedule调度方面的知识，但是这个先往后放一节吧，\n\n先学习下这个「入口函数」，毕竟对于每一个项目都会有一个入口的相关逻辑，那么go源码是怎么处理的？\n\n有没有什么可以借鉴的嘞？！\n\n<!--more-->\n接下来该到main函数的相关处理。\n\n>go version: 1.14.3\n### code分析\n\n[main函数入口](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L113)\n\n```go\n\n// The main goroutine.\nfunc main() {\n\tg := getg()\n\n\t// Racectx of m0->g0 is used only as the parent of the main goroutine.\n\t// It must not be used for anything else.\n\tg.m.g0.racectx = 0\n\n\t// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.\n\t// Using decimal instead of binary GB and MB because\n    // they look nicer in the stack overflow failure message.\n    \n    //最大栈空间限制\n\tif sys.PtrSize == 8 {\n\t\tmaxstacksize = 1000000000\n\t} else {\n\t\tmaxstacksize = 250000000\n\t}\n\n\t// Allow newproc to start new Ms.\n\tmainStarted = true\n\n    //如果是wasm，就不要调度程序了.\n    if GOARCH != \"wasm\" { // no threads on wasm yet, so no sysmon\n\n\t\t//系统栈调用\n\t\tsystemstack(func() {\n            // newm的回调函数，，，一个M一个sysmon P\n\t\t\tnewm(sysmon, nil)\n\t\t})\n\t}\n\n\t// Lock the main goroutine onto this, the main OS thread,\n\t// during initialization. Most programs won't care, but a few\n\t// do require certain calls to be made by the main thread.\n\t// Those can arrange for main.main to run in the main thread\n\t// by calling runtime.LockOSThread during initialization\n\t// to preserve the lock.\n\tlockOSThread()\n\n\tif g.m != &m0 {\n\t\tthrow(\"runtime.main not on m0\")\n\t}\n\n\tdoInit(&runtime_inittask) // must be before defer\n\tif nanotime() == 0 {\n\t\tthrow(\"nanotime returning zero\")\n\t}\n\n\t// Defer unlock so that runtime.Goexit during init does the unlock too.\n\tneedUnlock := true\n\tdefer func() {\n\t\tif needUnlock {\n\t\t\tunlockOSThread()\n\t\t}\n\t}()\n\n\t// Record when the world started.\n\truntimeInitTime = nanotime()\n\n    //启动GC\n\tgcenable()\n\n\tmain_init_done = make(chan bool)\n\tif iscgo {\n\t\tif _cgo_thread_start == nil {\n\t\t\tthrow(\"_cgo_thread_start missing\")\n\t\t}\n\t\tif GOOS != \"windows\" {\n\t\t\tif _cgo_setenv == nil {\n\t\t\t\tthrow(\"_cgo_setenv missing\")\n\t\t\t}\n\t\t\tif _cgo_unsetenv == nil {\n\t\t\t\tthrow(\"_cgo_unsetenv missing\")\n\t\t\t}\n\t\t}\n\t\tif _cgo_notify_runtime_init_done == nil {\n\t\t\tthrow(\"_cgo_notify_runtime_init_done missing\")\n\t\t}\n\t\t// Start the template thread in case we enter Go from\n\t\t// a C-created thread and need to create a new thread.\n\t\tstartTemplateThread()\n\t\tcgocall(_cgo_notify_runtime_init_done, nil)\n\t}\n\n\tdoInit(&main_inittask)\n\n\tclose(main_init_done)\n\n\tneedUnlock = false\n\tunlockOSThread()\n\n\tif isarchive || islibrary {\n\t\t// A program compiled with -buildmode=c-archive or c-shared\n\t\t// has a main, but it is not executed.\n\t\treturn\n    }\n    \n    //对于main函数的回调，也就是用户写的main程序\n\tfn := main_main // make an indirect call, as the linker doesn't know the address of the main package when laying down the runtime\n\tfn()\n\tif raceenabled {\n\t\tracefini()\n\t}\n\n\t// Make racy client program work: if panicking on\n\t// another goroutine at the same time as main returns,\n\t// let the other goroutine finish printing the panic trace.\n    // Once it does, it will exit. See issues 3934 and 20018.\n    //判断panicDefer函数，，，，，，\n\tif atomic.Load(&runningPanicDefers) != 0 {\n\t\t// Running deferred functions should not take long.\n\t\tfor c := 0; c < 1000; c++ {\n\t\t\tif atomic.Load(&runningPanicDefers) == 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tGosched()\n\t\t}\n    }\n    // 判断panic\n\tif atomic.Load(&panicking) != 0 {\n\t\tgopark(nil, nil, waitReasonPanicWait, traceEvGoStop, 1)\n\t}\n    //正常退出了那.....\n\texit(0)\n\tfor {\n\t\tvar x *int32\n\t\t*x = 0\n\t}\n}\n\n```\n\n### systemstack\n\n>这个函数，在整个系统中较为重要，来看看官方说明\n\n\n```go\n// systemstack runs fn on a system stack.\n// If systemstack is called from the per-OS-thread (g0) stack, or\n// if systemstack is called from the signal handling (gsignal) stack,\n// systemstack calls fn directly and returns.\n//g0 stack或者信号处理的，就直接调用并返回。\n\n// Otherwise, systemstack is being called from the limited stack\n// of an ordinary goroutine. In this case, systemstack switches\n// to the per-OS-thread stack, calls fn, and switches back.\n// It is common to use a func literal as the argument, in order\n// to share inputs and outputs with the code around the call\n// to system stack:\n//\n//\t... set up y ...\n//\tsystemstack(func() {\n//\t\tx = bigcall(y)\n//\t})\n//\t... use x ...\n//\n//go:noescape\nfunc systemstack(fn func())\n```\n\n### newm\n\n```go\n// Create a new m. It will start off with a call to fn, or else the scheduler.\n// fn needs to be static and not a heap allocated closure.\n// May run with m.p==nil, so write barriers are not allowed.\n//go:nowritebarrierrec\n\n//用于创建新的M，fn:sysmon函数，类似于事件驱动类型的。\nfunc newm(fn func(), _p_ *p) {\n\t//分配内存\n\tmp := allocm(_p_, fn)\n\tmp.nextp.set(_p_)\n\tmp.sigmask = initSigmask\n\tif gp := getg(); gp != nil && gp.m != nil && (gp.m.lockedExt != 0 || gp.m.incgo) && GOOS != \"plan9\" {\n\t\t// We're on a locked M or a thread that may have been\n\t\t// started by C. The kernel state of this thread may\n\t\t// be strange (the user may have locked it for that\n\t\t// purpose). We don't want to clone that into another\n\t\t// thread. Instead, ask a known-good thread to create\n\t\t// the thread for us.\n\t\t//\n\t\t// This is disabled on Plan 9. See golang.org/issue/22227.\n\t\t//\n\t\t// TODO: This may be unnecessary on Windows, which\n\t\t// doesn't model thread creation off fork.\n\t\tlock(&newmHandoff.lock)\n\t\tif newmHandoff.haveTemplateThread == 0 {\n\t\t\tthrow(\"on a locked thread with no template thread\")\n\t\t}\n\t\tmp.schedlink = newmHandoff.newm\n\t\tnewmHandoff.newm.set(mp)\n\t\tif newmHandoff.waiting {\n\t\t\tnewmHandoff.waiting = false\n\t\t\tnotewakeup(&newmHandoff.wake)\n\t\t}\n\t\tunlock(&newmHandoff.lock)\n\t\treturn\n\t}\n\tnewm1(mp)\n}\n```\n\n>主要是以下几个函数：\n\n* allocm\n* notewakeup\n* newm1\n\n### sysmon\n\n学习系统监控之前，先学下部分函数的使用和其大概含义：\n\n* checkdead\n* usleep\n* timeSleepUntil\n* nanotime\n* netpollinited\n* startm\n* retake\n* gcTrigger\n* injectglist\n\n\n>先看下主体流程\n```go\n\n// Always runs without a P, so write barriers are not allowed.\n//\n//go:nowritebarrierrec\nfunc sysmon() {\n\tlock(&sched.lock)\n\tsched.nmsys++\n\t//基于running中的M，检查死锁，，，，\n\tcheckdead()\n\tunlock(&sched.lock)\n\n\tlasttrace := int64(0)\n\tidle := 0 // how many cycles in succession we had not wokeup somebody\n\tdelay := uint32(0)\n\tfor {\n\t\tif idle == 0 { // start with 20us sleep...\n\t\t\tdelay = 20\n\t\t} else if idle > 50 { // start doubling the sleep after 1ms...\n\t\t\tdelay *= 2\n\t\t}\n\t\tif delay > 10*1000 { // up to 10ms\n\t\t\tdelay = 10 * 1000\n\t\t}\n\t\t//休眠时间\n\t\tusleep(delay)\n\t\t//获取时间\n\t\tnow := nanotime()\n\t\t// 休眠等待唤醒信号\n\t\tnext, _ := timeSleepUntil()\n\t\tif debug.schedtrace <= 0 && (sched.gcwaiting != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs)) {\n\t\t\tlock(&sched.lock)\n\t\t\tif atomic.Load(&sched.gcwaiting) != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs) {\n\t\t\t\tif next > now {\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 1)\n\t\t\t\t\tunlock(&sched.lock)\n\t\t\t\t\t// Make wake-up period small enough\n\t\t\t\t\t// for the sampling to be correct.\n\t\t\t\t\tsleep := forcegcperiod / 2\n\t\t\t\t\tif next-now < sleep {\n\t\t\t\t\t\tsleep = next - now\n\t\t\t\t\t}\n\t\t\t\t\tshouldRelax := sleep >= osRelaxMinNS\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(true)\n\t\t\t\t\t}\n\t\t\t\t\tnotetsleep(&sched.sysmonnote, sleep)\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(false)\n\t\t\t\t\t}\n\t\t\t\t\tnow = nanotime()\n\t\t\t\t\tnext, _ = timeSleepUntil()\n\t\t\t\t\tlock(&sched.lock)\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 0)\n\t\t\t\t\tnoteclear(&sched.sysmonnote)\n\t\t\t\t}\n\t\t\t\tidle = 0\n\t\t\t\tdelay = 20\n\t\t\t}\n\t\t\tunlock(&sched.lock)\n\t\t}\n\t\tlock(&sched.sysmonlock)\n\t\t{\n\t\t\t// If we spent a long time blocked on sysmonlock\n\t\t\t// then we want to update now and next since it's\n\t\t\t// likely stale.\n\t\t\tnow1 := nanotime()\n\t\t\tif now1-now > 50*1000 /* 50µs */ {\n\t\t\t\tnext, _ = timeSleepUntil()\n\t\t\t}\n\t\t\tnow = now1\n\t\t}\n\n\t\t// trigger libc interceptors if needed\n\t\tif *cgo_yield != nil {\n\t\t\tasmcgocall(*cgo_yield, nil)\n\t\t}\n\t\t// poll network if not polled for more than 10ms\n\t\t//在队列中等待调度超过10ms，就给交给global抢渡了\n\t\tlastpoll := int64(atomic.Load64(&sched.lastpoll))\n\t\tif netpollinited() && lastpoll != 0 && lastpoll+10*1000*1000 < now {\n\t\t\tatomic.Cas64(&sched.lastpoll, uint64(lastpoll), uint64(now))\n\t\t\tlist := netpoll(0) // non-blocking - returns list of goroutines\n\t\t\tif !list.empty() {\n\t\t\t\t// Need to decrement number of idle locked M's\n\t\t\t\t// (pretending that one more is running) before injectglist.\n\t\t\t\t// Otherwise it can lead to the following situation:\n\t\t\t\t// injectglist grabs all P's but before it starts M's to run the P's,\n\t\t\t\t// another M returns from syscall, finishes running its G,\n\t\t\t\t// observes that there is no work to do and no other running M's\n\t\t\t\t// and reports deadlock.\n\t\t\t\tincidlelocked(-1)\n\t\t\t\t//注入全局g队列中\n\t\t\t\tinjectglist(&list)\n\t\t\t\tincidlelocked(1)\n\t\t\t}\n\t\t}\n\t\tif next < now {\n\t\t\t// There are timers that should have already run,\n\t\t\t// perhaps because there is an unpreemptible P.\n\t\t\t// Try to start an M to run them.\n\t\t\t//需要一个新的M来跑P上面的G。\n\t\t\tstartm(nil, false)\n\t\t}\n\t\tif atomic.Load(&scavenge.sysmonWake) != 0 {\n\t\t\t// Kick the scavenger awake if someone requested it.\n\t\t\twakeScavenger()\n\t\t}\n\t\t// retake P's blocked in syscalls\n\t\t// and preempt long running G's\n\t\t// 循环所有的allp，进行抢夺。\n\t\tif retake(now) != 0 {\n\t\t\tidle = 0\n\t\t} else {\n\t\t\tidle++\n\t\t}\n\t\t// check if we need to force a GC\n\t\t//强行GC\n\t\tif t := (gcTrigger{kind: gcTriggerTime, now: now}); t.test() && atomic.Load(&forcegc.idle) != 0 {\n\t\t\tlock(&forcegc.lock)\n\t\t\tforcegc.idle = 0\n\t\t\tvar list gList\n\t\t\tlist.push(forcegc.g)\n\t\t\tinjectglist(&list)\n\t\t\tunlock(&forcegc.lock)\n\t\t}\n\t\tif debug.schedtrace > 0 && lasttrace+int64(debug.schedtrace)*1000000 <= now {\n\t\t\tlasttrace = now\n\t\t\tschedtrace(debug.scheddetail > 0)\n\t\t}\n\t\tunlock(&sched.sysmonlock)\n\t}\n}\n```\n\n### doInit\n\n\n>这一部分在源码看来，没有具体的作用，，，，，，，，todo标签吧。\n```go\nfunc doInit(t *initTask) {\n\tswitch t.state {\n\tcase 2: // fully initialized\n\t\treturn\n\tcase 1: // initialization in progress\n\t\tthrow(\"recursive call during initialization - linker skew\")\n\tdefault: // not initialized yet\n\t\tt.state = 1 // initialization in progress\n\t\tfor i := uintptr(0); i < t.ndeps; i++ {\n\t\t\tp := add(unsafe.Pointer(t), (3+i)*sys.PtrSize)\n\t\t\tt2 := *(**initTask)(p)\n\t\t\tdoInit(t2)\n\t\t}\n\t\tfor i := uintptr(0); i < t.nfns; i++ {\n\t\t\tp := add(unsafe.Pointer(t), (3+t.ndeps+i)*sys.PtrSize)\n\t\t\tf := *(*func())(unsafe.Pointer(&p))\n\t\t\tf()\n\t\t}\n\t\tt.state = 2 // initialization done\n\t}\n}\n```\n\n### gcenable\n\n\n```go\n// gcenable is called after the bulk of the runtime initialization,\n// just before we're about to start letting user code run.\n// It kicks off the background sweeper goroutine, the background\n// scavenger goroutine, and enables GC.\nfunc gcenable() {\n\t// Kick off sweeping and scavenging.\n\tc := make(chan int, 2)\n\tgo bgsweep(c)\n\tgo bgscavenge(c)\n\t<-c\n\t<-c\n\tmemstats.enablegc = true // now that runtime is initialized, GC is okay\n}\n```\n\n### Gosched\n\n```go\n// Gosched yields the processor, allowing other goroutines to run. It does not\n// suspend the current goroutine, so execution resumes automatically.\nfunc Gosched() {\n\tcheckTimeouts()\n\tmcall(gosched_m)\n}\n```\n\n### gopark\n\n\n```go\n// Puts the current goroutine into a waiting state and calls unlockf.\n// If unlockf returns false, the goroutine is resumed.\n// unlockf must not access this G's stack, as it may be moved between\n// the call to gopark and the call to unlockf.\n// Reason explains why the goroutine has been parked.\n// It is displayed in stack traces and heap dumps.\n// Reasons should be unique and descriptive.\n// Do not re-use reasons, add new ones.\nfunc gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) {\n\tif reason != waitReasonSleep {\n\t\tcheckTimeouts() // timeouts may expire while two goroutines keep the scheduler busy\n\t}\n\tmp := acquirem()\n\tgp := mp.curg\n\tstatus := readgstatus(gp)\n\tif status != _Grunning && status != _Gscanrunning {\n\t\tthrow(\"gopark: bad g status\")\n\t}\n\tmp.waitlock = lock\n\tmp.waitunlockf = unlockf\n\tgp.waitreason = reason\n\tmp.waittraceev = traceEv\n\tmp.waittraceskip = traceskip\n\t//mp解绑\n\treleasem(mp)\n\t// can't do anything that might move the G between Ms here.\n\tmcall(park_m)\n}\n```\n\n### 后续\n\n>关于里面的重要部分实现细节，不是本次关注的重点，，，，\n\n```html\n这次主要看到的是Go围绕main函数，为了程序的正常启动，所做的工作.\n\n无论是g的启动还是调度监控方面，也就是从整个生命周期来考虑，，，，，，\n\n\n还有一个就是关于panic的处理，采用事件驱动的方式，很好的获取到panic,进行后续的处理。\n\n最后还有一个关于全局locktrhead，，，，，，粒度尽量细小，有利于提高性能。\n\n```\n\n","source":"_posts/23-GPM-main入口函数.md","raw":"---\ntitle: 「23」GPM main入口函数\ndate: '2020/11/21 21:00:17'\nupdated: '2020/11/21 21:00:17'\nkeywords: 'GPM,Go,Go调度器,Go资源调度器'\ntags:\n  - Go\n  - GPM\n  - Go源码\nabbrlink: 9bb71eca\n---\n\n\n前面g0和m0瞎扯了部分的入口和一些关键的点。\n\n本来应该扯扯shedule调度方面的知识，但是这个先往后放一节吧，\n\n先学习下这个「入口函数」，毕竟对于每一个项目都会有一个入口的相关逻辑，那么go源码是怎么处理的？\n\n有没有什么可以借鉴的嘞？！\n\n<!--more-->\n接下来该到main函数的相关处理。\n\n>go version: 1.14.3\n### code分析\n\n[main函数入口](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L113)\n\n```go\n\n// The main goroutine.\nfunc main() {\n\tg := getg()\n\n\t// Racectx of m0->g0 is used only as the parent of the main goroutine.\n\t// It must not be used for anything else.\n\tg.m.g0.racectx = 0\n\n\t// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.\n\t// Using decimal instead of binary GB and MB because\n    // they look nicer in the stack overflow failure message.\n    \n    //最大栈空间限制\n\tif sys.PtrSize == 8 {\n\t\tmaxstacksize = 1000000000\n\t} else {\n\t\tmaxstacksize = 250000000\n\t}\n\n\t// Allow newproc to start new Ms.\n\tmainStarted = true\n\n    //如果是wasm，就不要调度程序了.\n    if GOARCH != \"wasm\" { // no threads on wasm yet, so no sysmon\n\n\t\t//系统栈调用\n\t\tsystemstack(func() {\n            // newm的回调函数，，，一个M一个sysmon P\n\t\t\tnewm(sysmon, nil)\n\t\t})\n\t}\n\n\t// Lock the main goroutine onto this, the main OS thread,\n\t// during initialization. Most programs won't care, but a few\n\t// do require certain calls to be made by the main thread.\n\t// Those can arrange for main.main to run in the main thread\n\t// by calling runtime.LockOSThread during initialization\n\t// to preserve the lock.\n\tlockOSThread()\n\n\tif g.m != &m0 {\n\t\tthrow(\"runtime.main not on m0\")\n\t}\n\n\tdoInit(&runtime_inittask) // must be before defer\n\tif nanotime() == 0 {\n\t\tthrow(\"nanotime returning zero\")\n\t}\n\n\t// Defer unlock so that runtime.Goexit during init does the unlock too.\n\tneedUnlock := true\n\tdefer func() {\n\t\tif needUnlock {\n\t\t\tunlockOSThread()\n\t\t}\n\t}()\n\n\t// Record when the world started.\n\truntimeInitTime = nanotime()\n\n    //启动GC\n\tgcenable()\n\n\tmain_init_done = make(chan bool)\n\tif iscgo {\n\t\tif _cgo_thread_start == nil {\n\t\t\tthrow(\"_cgo_thread_start missing\")\n\t\t}\n\t\tif GOOS != \"windows\" {\n\t\t\tif _cgo_setenv == nil {\n\t\t\t\tthrow(\"_cgo_setenv missing\")\n\t\t\t}\n\t\t\tif _cgo_unsetenv == nil {\n\t\t\t\tthrow(\"_cgo_unsetenv missing\")\n\t\t\t}\n\t\t}\n\t\tif _cgo_notify_runtime_init_done == nil {\n\t\t\tthrow(\"_cgo_notify_runtime_init_done missing\")\n\t\t}\n\t\t// Start the template thread in case we enter Go from\n\t\t// a C-created thread and need to create a new thread.\n\t\tstartTemplateThread()\n\t\tcgocall(_cgo_notify_runtime_init_done, nil)\n\t}\n\n\tdoInit(&main_inittask)\n\n\tclose(main_init_done)\n\n\tneedUnlock = false\n\tunlockOSThread()\n\n\tif isarchive || islibrary {\n\t\t// A program compiled with -buildmode=c-archive or c-shared\n\t\t// has a main, but it is not executed.\n\t\treturn\n    }\n    \n    //对于main函数的回调，也就是用户写的main程序\n\tfn := main_main // make an indirect call, as the linker doesn't know the address of the main package when laying down the runtime\n\tfn()\n\tif raceenabled {\n\t\tracefini()\n\t}\n\n\t// Make racy client program work: if panicking on\n\t// another goroutine at the same time as main returns,\n\t// let the other goroutine finish printing the panic trace.\n    // Once it does, it will exit. See issues 3934 and 20018.\n    //判断panicDefer函数，，，，，，\n\tif atomic.Load(&runningPanicDefers) != 0 {\n\t\t// Running deferred functions should not take long.\n\t\tfor c := 0; c < 1000; c++ {\n\t\t\tif atomic.Load(&runningPanicDefers) == 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tGosched()\n\t\t}\n    }\n    // 判断panic\n\tif atomic.Load(&panicking) != 0 {\n\t\tgopark(nil, nil, waitReasonPanicWait, traceEvGoStop, 1)\n\t}\n    //正常退出了那.....\n\texit(0)\n\tfor {\n\t\tvar x *int32\n\t\t*x = 0\n\t}\n}\n\n```\n\n### systemstack\n\n>这个函数，在整个系统中较为重要，来看看官方说明\n\n\n```go\n// systemstack runs fn on a system stack.\n// If systemstack is called from the per-OS-thread (g0) stack, or\n// if systemstack is called from the signal handling (gsignal) stack,\n// systemstack calls fn directly and returns.\n//g0 stack或者信号处理的，就直接调用并返回。\n\n// Otherwise, systemstack is being called from the limited stack\n// of an ordinary goroutine. In this case, systemstack switches\n// to the per-OS-thread stack, calls fn, and switches back.\n// It is common to use a func literal as the argument, in order\n// to share inputs and outputs with the code around the call\n// to system stack:\n//\n//\t... set up y ...\n//\tsystemstack(func() {\n//\t\tx = bigcall(y)\n//\t})\n//\t... use x ...\n//\n//go:noescape\nfunc systemstack(fn func())\n```\n\n### newm\n\n```go\n// Create a new m. It will start off with a call to fn, or else the scheduler.\n// fn needs to be static and not a heap allocated closure.\n// May run with m.p==nil, so write barriers are not allowed.\n//go:nowritebarrierrec\n\n//用于创建新的M，fn:sysmon函数，类似于事件驱动类型的。\nfunc newm(fn func(), _p_ *p) {\n\t//分配内存\n\tmp := allocm(_p_, fn)\n\tmp.nextp.set(_p_)\n\tmp.sigmask = initSigmask\n\tif gp := getg(); gp != nil && gp.m != nil && (gp.m.lockedExt != 0 || gp.m.incgo) && GOOS != \"plan9\" {\n\t\t// We're on a locked M or a thread that may have been\n\t\t// started by C. The kernel state of this thread may\n\t\t// be strange (the user may have locked it for that\n\t\t// purpose). We don't want to clone that into another\n\t\t// thread. Instead, ask a known-good thread to create\n\t\t// the thread for us.\n\t\t//\n\t\t// This is disabled on Plan 9. See golang.org/issue/22227.\n\t\t//\n\t\t// TODO: This may be unnecessary on Windows, which\n\t\t// doesn't model thread creation off fork.\n\t\tlock(&newmHandoff.lock)\n\t\tif newmHandoff.haveTemplateThread == 0 {\n\t\t\tthrow(\"on a locked thread with no template thread\")\n\t\t}\n\t\tmp.schedlink = newmHandoff.newm\n\t\tnewmHandoff.newm.set(mp)\n\t\tif newmHandoff.waiting {\n\t\t\tnewmHandoff.waiting = false\n\t\t\tnotewakeup(&newmHandoff.wake)\n\t\t}\n\t\tunlock(&newmHandoff.lock)\n\t\treturn\n\t}\n\tnewm1(mp)\n}\n```\n\n>主要是以下几个函数：\n\n* allocm\n* notewakeup\n* newm1\n\n### sysmon\n\n学习系统监控之前，先学下部分函数的使用和其大概含义：\n\n* checkdead\n* usleep\n* timeSleepUntil\n* nanotime\n* netpollinited\n* startm\n* retake\n* gcTrigger\n* injectglist\n\n\n>先看下主体流程\n```go\n\n// Always runs without a P, so write barriers are not allowed.\n//\n//go:nowritebarrierrec\nfunc sysmon() {\n\tlock(&sched.lock)\n\tsched.nmsys++\n\t//基于running中的M，检查死锁，，，，\n\tcheckdead()\n\tunlock(&sched.lock)\n\n\tlasttrace := int64(0)\n\tidle := 0 // how many cycles in succession we had not wokeup somebody\n\tdelay := uint32(0)\n\tfor {\n\t\tif idle == 0 { // start with 20us sleep...\n\t\t\tdelay = 20\n\t\t} else if idle > 50 { // start doubling the sleep after 1ms...\n\t\t\tdelay *= 2\n\t\t}\n\t\tif delay > 10*1000 { // up to 10ms\n\t\t\tdelay = 10 * 1000\n\t\t}\n\t\t//休眠时间\n\t\tusleep(delay)\n\t\t//获取时间\n\t\tnow := nanotime()\n\t\t// 休眠等待唤醒信号\n\t\tnext, _ := timeSleepUntil()\n\t\tif debug.schedtrace <= 0 && (sched.gcwaiting != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs)) {\n\t\t\tlock(&sched.lock)\n\t\t\tif atomic.Load(&sched.gcwaiting) != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs) {\n\t\t\t\tif next > now {\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 1)\n\t\t\t\t\tunlock(&sched.lock)\n\t\t\t\t\t// Make wake-up period small enough\n\t\t\t\t\t// for the sampling to be correct.\n\t\t\t\t\tsleep := forcegcperiod / 2\n\t\t\t\t\tif next-now < sleep {\n\t\t\t\t\t\tsleep = next - now\n\t\t\t\t\t}\n\t\t\t\t\tshouldRelax := sleep >= osRelaxMinNS\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(true)\n\t\t\t\t\t}\n\t\t\t\t\tnotetsleep(&sched.sysmonnote, sleep)\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(false)\n\t\t\t\t\t}\n\t\t\t\t\tnow = nanotime()\n\t\t\t\t\tnext, _ = timeSleepUntil()\n\t\t\t\t\tlock(&sched.lock)\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 0)\n\t\t\t\t\tnoteclear(&sched.sysmonnote)\n\t\t\t\t}\n\t\t\t\tidle = 0\n\t\t\t\tdelay = 20\n\t\t\t}\n\t\t\tunlock(&sched.lock)\n\t\t}\n\t\tlock(&sched.sysmonlock)\n\t\t{\n\t\t\t// If we spent a long time blocked on sysmonlock\n\t\t\t// then we want to update now and next since it's\n\t\t\t// likely stale.\n\t\t\tnow1 := nanotime()\n\t\t\tif now1-now > 50*1000 /* 50µs */ {\n\t\t\t\tnext, _ = timeSleepUntil()\n\t\t\t}\n\t\t\tnow = now1\n\t\t}\n\n\t\t// trigger libc interceptors if needed\n\t\tif *cgo_yield != nil {\n\t\t\tasmcgocall(*cgo_yield, nil)\n\t\t}\n\t\t// poll network if not polled for more than 10ms\n\t\t//在队列中等待调度超过10ms，就给交给global抢渡了\n\t\tlastpoll := int64(atomic.Load64(&sched.lastpoll))\n\t\tif netpollinited() && lastpoll != 0 && lastpoll+10*1000*1000 < now {\n\t\t\tatomic.Cas64(&sched.lastpoll, uint64(lastpoll), uint64(now))\n\t\t\tlist := netpoll(0) // non-blocking - returns list of goroutines\n\t\t\tif !list.empty() {\n\t\t\t\t// Need to decrement number of idle locked M's\n\t\t\t\t// (pretending that one more is running) before injectglist.\n\t\t\t\t// Otherwise it can lead to the following situation:\n\t\t\t\t// injectglist grabs all P's but before it starts M's to run the P's,\n\t\t\t\t// another M returns from syscall, finishes running its G,\n\t\t\t\t// observes that there is no work to do and no other running M's\n\t\t\t\t// and reports deadlock.\n\t\t\t\tincidlelocked(-1)\n\t\t\t\t//注入全局g队列中\n\t\t\t\tinjectglist(&list)\n\t\t\t\tincidlelocked(1)\n\t\t\t}\n\t\t}\n\t\tif next < now {\n\t\t\t// There are timers that should have already run,\n\t\t\t// perhaps because there is an unpreemptible P.\n\t\t\t// Try to start an M to run them.\n\t\t\t//需要一个新的M来跑P上面的G。\n\t\t\tstartm(nil, false)\n\t\t}\n\t\tif atomic.Load(&scavenge.sysmonWake) != 0 {\n\t\t\t// Kick the scavenger awake if someone requested it.\n\t\t\twakeScavenger()\n\t\t}\n\t\t// retake P's blocked in syscalls\n\t\t// and preempt long running G's\n\t\t// 循环所有的allp，进行抢夺。\n\t\tif retake(now) != 0 {\n\t\t\tidle = 0\n\t\t} else {\n\t\t\tidle++\n\t\t}\n\t\t// check if we need to force a GC\n\t\t//强行GC\n\t\tif t := (gcTrigger{kind: gcTriggerTime, now: now}); t.test() && atomic.Load(&forcegc.idle) != 0 {\n\t\t\tlock(&forcegc.lock)\n\t\t\tforcegc.idle = 0\n\t\t\tvar list gList\n\t\t\tlist.push(forcegc.g)\n\t\t\tinjectglist(&list)\n\t\t\tunlock(&forcegc.lock)\n\t\t}\n\t\tif debug.schedtrace > 0 && lasttrace+int64(debug.schedtrace)*1000000 <= now {\n\t\t\tlasttrace = now\n\t\t\tschedtrace(debug.scheddetail > 0)\n\t\t}\n\t\tunlock(&sched.sysmonlock)\n\t}\n}\n```\n\n### doInit\n\n\n>这一部分在源码看来，没有具体的作用，，，，，，，，todo标签吧。\n```go\nfunc doInit(t *initTask) {\n\tswitch t.state {\n\tcase 2: // fully initialized\n\t\treturn\n\tcase 1: // initialization in progress\n\t\tthrow(\"recursive call during initialization - linker skew\")\n\tdefault: // not initialized yet\n\t\tt.state = 1 // initialization in progress\n\t\tfor i := uintptr(0); i < t.ndeps; i++ {\n\t\t\tp := add(unsafe.Pointer(t), (3+i)*sys.PtrSize)\n\t\t\tt2 := *(**initTask)(p)\n\t\t\tdoInit(t2)\n\t\t}\n\t\tfor i := uintptr(0); i < t.nfns; i++ {\n\t\t\tp := add(unsafe.Pointer(t), (3+t.ndeps+i)*sys.PtrSize)\n\t\t\tf := *(*func())(unsafe.Pointer(&p))\n\t\t\tf()\n\t\t}\n\t\tt.state = 2 // initialization done\n\t}\n}\n```\n\n### gcenable\n\n\n```go\n// gcenable is called after the bulk of the runtime initialization,\n// just before we're about to start letting user code run.\n// It kicks off the background sweeper goroutine, the background\n// scavenger goroutine, and enables GC.\nfunc gcenable() {\n\t// Kick off sweeping and scavenging.\n\tc := make(chan int, 2)\n\tgo bgsweep(c)\n\tgo bgscavenge(c)\n\t<-c\n\t<-c\n\tmemstats.enablegc = true // now that runtime is initialized, GC is okay\n}\n```\n\n### Gosched\n\n```go\n// Gosched yields the processor, allowing other goroutines to run. It does not\n// suspend the current goroutine, so execution resumes automatically.\nfunc Gosched() {\n\tcheckTimeouts()\n\tmcall(gosched_m)\n}\n```\n\n### gopark\n\n\n```go\n// Puts the current goroutine into a waiting state and calls unlockf.\n// If unlockf returns false, the goroutine is resumed.\n// unlockf must not access this G's stack, as it may be moved between\n// the call to gopark and the call to unlockf.\n// Reason explains why the goroutine has been parked.\n// It is displayed in stack traces and heap dumps.\n// Reasons should be unique and descriptive.\n// Do not re-use reasons, add new ones.\nfunc gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) {\n\tif reason != waitReasonSleep {\n\t\tcheckTimeouts() // timeouts may expire while two goroutines keep the scheduler busy\n\t}\n\tmp := acquirem()\n\tgp := mp.curg\n\tstatus := readgstatus(gp)\n\tif status != _Grunning && status != _Gscanrunning {\n\t\tthrow(\"gopark: bad g status\")\n\t}\n\tmp.waitlock = lock\n\tmp.waitunlockf = unlockf\n\tgp.waitreason = reason\n\tmp.waittraceev = traceEv\n\tmp.waittraceskip = traceskip\n\t//mp解绑\n\treleasem(mp)\n\t// can't do anything that might move the G between Ms here.\n\tmcall(park_m)\n}\n```\n\n### 后续\n\n>关于里面的重要部分实现细节，不是本次关注的重点，，，，\n\n```html\n这次主要看到的是Go围绕main函数，为了程序的正常启动，所做的工作.\n\n无论是g的启动还是调度监控方面，也就是从整个生命周期来考虑，，，，，，\n\n\n还有一个就是关于panic的处理，采用事件驱动的方式，很好的获取到panic,进行后续的处理。\n\n最后还有一个关于全局locktrhead，，，，，，粒度尽量细小，有利于提高性能。\n\n```\n\n","slug":"23-GPM-main入口函数","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdla00173ci74iciaww8","content":"<p>前面g0和m0瞎扯了部分的入口和一些关键的点。</p>\n<p>本来应该扯扯shedule调度方面的知识，但是这个先往后放一节吧，</p>\n<p>先学习下这个「入口函数」，毕竟对于每一个项目都会有一个入口的相关逻辑，那么go源码是怎么处理的？</p>\n<p>有没有什么可以借鉴的嘞？！</p>\n<a id=\"more\"></a>\n<p>接下来该到main函数的相关处理。</p>\n<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h3 id=\"code分析\"><a class=\"header-anchor\" href=\"#code分析\">¶</a>code分析</h3>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L113\">main函数入口</a></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// The main goroutine.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tg := getg()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.</span></span><br><span class=\"line\">\t<span class=\"comment\">// It must not be used for anything else.</span></span><br><span class=\"line\">\tg.m.g0.racectx = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Using decimal instead of binary GB and MB because</span></span><br><span class=\"line\">    <span class=\"comment\">// they look nicer in the stack overflow failure message.</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//最大栈空间限制</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> sys.PtrSize == <span class=\"number\">8</span> &#123;</span><br><span class=\"line\">\t\tmaxstacksize = <span class=\"number\">1000000000</span></span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tmaxstacksize = <span class=\"number\">250000000</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Allow newproc to start new Ms.</span></span><br><span class=\"line\">\tmainStarted = <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//如果是wasm，就不要调度程序了.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> GOARCH != <span class=\"string\">&quot;wasm&quot;</span> &#123; <span class=\"comment\">// no threads on wasm yet, so no sysmon</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//系统栈调用</span></span><br><span class=\"line\">\t\tsystemstack(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// newm的回调函数，，，一个M一个sysmon P</span></span><br><span class=\"line\">\t\t\tnewm(sysmon, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t&#125;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Lock the main goroutine onto this, the main OS thread,</span></span><br><span class=\"line\">\t<span class=\"comment\">// during initialization. Most programs won&#x27;t care, but a few</span></span><br><span class=\"line\">\t<span class=\"comment\">// do require certain calls to be made by the main thread.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Those can arrange for main.main to run in the main thread</span></span><br><span class=\"line\">\t<span class=\"comment\">// by calling runtime.LockOSThread during initialization</span></span><br><span class=\"line\">\t<span class=\"comment\">// to preserve the lock.</span></span><br><span class=\"line\">\tlockOSThread()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> g.m != &amp;m0 &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;runtime.main not on m0&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdoInit(&amp;runtime_inittask) <span class=\"comment\">// must be before defer</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> nanotime() == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;nanotime returning zero&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Defer unlock so that runtime.Goexit during init does the unlock too.</span></span><br><span class=\"line\">\tneedUnlock := <span class=\"literal\">true</span></span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> needUnlock &#123;</span><br><span class=\"line\">\t\t\tunlockOSThread()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Record when the world started.</span></span><br><span class=\"line\">\truntimeInitTime = nanotime()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//启动GC</span></span><br><span class=\"line\">\tgcenable()</span><br><span class=\"line\"></span><br><span class=\"line\">\tmain_init_done = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">bool</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> iscgo &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> _cgo_thread_start == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> GOOS != <span class=\"string\">&quot;windows&quot;</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> _cgo_setenv == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tthrow(<span class=\"string\">&quot;_cgo_setenv missing&quot;</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> _cgo_unsetenv == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tthrow(<span class=\"string\">&quot;_cgo_unsetenv missing&quot;</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> _cgo_notify_runtime_init_done == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;_cgo_notify_runtime_init_done missing&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Start the template thread in case we enter Go from</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// a C-created thread and need to create a new thread.</span></span><br><span class=\"line\">\t\tstartTemplateThread()</span><br><span class=\"line\">\t\tcgocall(_cgo_notify_runtime_init_done, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdoInit(&amp;main_inittask)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">close</span>(main_init_done)</span><br><span class=\"line\"></span><br><span class=\"line\">\tneedUnlock = <span class=\"literal\">false</span></span><br><span class=\"line\">\tunlockOSThread()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> isarchive || islibrary &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// A program compiled with -buildmode=c-archive or c-shared</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// has a main, but it is not executed.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//对于main函数的回调，也就是用户写的main程序</span></span><br><span class=\"line\">\tfn := main_main <span class=\"comment\">// make an indirect call, as the linker doesn&#x27;t know the address of the main package when laying down the runtime</span></span><br><span class=\"line\">\tfn()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> raceenabled &#123;</span><br><span class=\"line\">\t\tracefini()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Make racy client program work: if panicking on</span></span><br><span class=\"line\">\t<span class=\"comment\">// another goroutine at the same time as main returns,</span></span><br><span class=\"line\">\t<span class=\"comment\">// let the other goroutine finish printing the panic trace.</span></span><br><span class=\"line\">    <span class=\"comment\">// Once it does, it will exit. See issues 3934 and 20018.</span></span><br><span class=\"line\">    <span class=\"comment\">//判断panicDefer函数，，，，，，</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.Load(&amp;runningPanicDefers) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Running deferred functions should not take long.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> c := <span class=\"number\">0</span>; c &lt; <span class=\"number\">1000</span>; c++ &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;runningPanicDefers) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tGosched()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 判断panic</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.Load(&amp;panicking) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tgopark(<span class=\"literal\">nil</span>, <span class=\"literal\">nil</span>, waitReasonPanicWait, traceEvGoStop, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">//正常退出了那.....</span></span><br><span class=\"line\">\texit(<span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> x *<span class=\"keyword\">int32</span></span><br><span class=\"line\">\t\t*x = <span class=\"number\">0</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"systemstack\"><a class=\"header-anchor\" href=\"#systemstack\">¶</a>systemstack</h3>\n<blockquote>\n<p>这个函数，在整个系统中较为重要，来看看官方说明</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// systemstack runs fn on a system stack.</span></span><br><span class=\"line\"><span class=\"comment\">// If systemstack is called from the per-OS-thread (g0) stack, or</span></span><br><span class=\"line\"><span class=\"comment\">// if systemstack is called from the signal handling (gsignal) stack,</span></span><br><span class=\"line\"><span class=\"comment\">// systemstack calls fn directly and returns.</span></span><br><span class=\"line\"><span class=\"comment\">//g0 stack或者信号处理的，就直接调用并返回。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Otherwise, systemstack is being called from the limited stack</span></span><br><span class=\"line\"><span class=\"comment\">// of an ordinary goroutine. In this case, systemstack switches</span></span><br><span class=\"line\"><span class=\"comment\">// to the per-OS-thread stack, calls fn, and switches back.</span></span><br><span class=\"line\"><span class=\"comment\">// It is common to use a func literal as the argument, in order</span></span><br><span class=\"line\"><span class=\"comment\">// to share inputs and outputs with the code around the call</span></span><br><span class=\"line\"><span class=\"comment\">// to system stack:</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//\t... set up y ...</span></span><br><span class=\"line\"><span class=\"comment\">//\tsystemstack(func() &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//\t\tx = bigcall(y)</span></span><br><span class=\"line\"><span class=\"comment\">//\t&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">//\t... use x ...</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:noescape</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">systemstack</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>)</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"newm\"><a class=\"header-anchor\" href=\"#newm\">¶</a>newm</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class=\"line\"><span class=\"comment\">// fn needs to be static and not a heap allocated closure.</span></span><br><span class=\"line\"><span class=\"comment\">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//用于创建新的M，fn:sysmon函数，类似于事件驱动类型的。</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>, _<span class=\"title\">p_</span> *<span class=\"title\">p</span>)</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//分配内存</span></span><br><span class=\"line\">\tmp := allocm(_p_, fn)</span><br><span class=\"line\">\tmp.nextp.set(_p_)</span><br><span class=\"line\">\tmp.sigmask = initSigmask</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> gp := getg(); gp != <span class=\"literal\">nil</span> &amp;&amp; gp.m != <span class=\"literal\">nil</span> &amp;&amp; (gp.m.lockedExt != <span class=\"number\">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class=\"string\">&quot;plan9&quot;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// started by C. The kernel state of this thread may</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// be strange (the user may have locked it for that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// thread. Instead, ask a known-good thread to create</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the thread for us.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// doesn&#x27;t model thread creation off fork.</span></span><br><span class=\"line\">\t\tlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.haveTemplateThread == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tmp.schedlink = newmHandoff.newm</span><br><span class=\"line\">\t\tnewmHandoff.newm.set(mp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.waiting &#123;</span><br><span class=\"line\">\t\t\tnewmHandoff.waiting = <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t\tnotewakeup(&amp;newmHandoff.wake)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnewm1(mp)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>主要是以下几个函数：</p>\n</blockquote>\n<ul>\n<li>allocm</li>\n<li>notewakeup</li>\n<li>newm1</li>\n</ul>\n<h3 id=\"sysmon\"><a class=\"header-anchor\" href=\"#sysmon\">¶</a>sysmon</h3>\n<p>学习系统监控之前，先学下部分函数的使用和其大概含义：</p>\n<ul>\n<li>checkdead</li>\n<li>usleep</li>\n<li>timeSleepUntil</li>\n<li>nanotime</li>\n<li>netpollinited</li>\n<li>startm</li>\n<li>retake</li>\n<li>gcTrigger</li>\n<li>injectglist</li>\n</ul>\n<blockquote>\n<p>先看下主体流程</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Always runs without a P, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">sysmon</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlock(&amp;sched.lock)</span><br><span class=\"line\">\tsched.nmsys++</span><br><span class=\"line\">\t<span class=\"comment\">//基于running中的M，检查死锁，，，，</span></span><br><span class=\"line\">\tcheckdead()</span><br><span class=\"line\">\tunlock(&amp;sched.lock)</span><br><span class=\"line\"></span><br><span class=\"line\">\tlasttrace := <span class=\"keyword\">int64</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tidle := <span class=\"number\">0</span> <span class=\"comment\">// how many cycles in succession we had not wokeup somebody</span></span><br><span class=\"line\">\tdelay := <span class=\"keyword\">uint32</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> idle == <span class=\"number\">0</span> &#123; <span class=\"comment\">// start with 20us sleep...</span></span><br><span class=\"line\">\t\t\tdelay = <span class=\"number\">20</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> idle &gt; <span class=\"number\">50</span> &#123; <span class=\"comment\">// start doubling the sleep after 1ms...</span></span><br><span class=\"line\">\t\t\tdelay *= <span class=\"number\">2</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> delay &gt; <span class=\"number\">10</span>*<span class=\"number\">1000</span> &#123; <span class=\"comment\">// up to 10ms</span></span><br><span class=\"line\">\t\t\tdelay = <span class=\"number\">10</span> * <span class=\"number\">1000</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">//休眠时间</span></span><br><span class=\"line\">\t\tusleep(delay)</span><br><span class=\"line\">\t\t<span class=\"comment\">//获取时间</span></span><br><span class=\"line\">\t\tnow := nanotime()</span><br><span class=\"line\">\t\t<span class=\"comment\">// 休眠等待唤醒信号</span></span><br><span class=\"line\">\t\tnext, _ := timeSleepUntil()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> debug.schedtrace &lt;= <span class=\"number\">0</span> &amp;&amp; (sched.gcwaiting != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs)) &#123;</span><br><span class=\"line\">\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> next &gt; now &#123;</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Make wake-up period small enough</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// for the sampling to be correct.</span></span><br><span class=\"line\">\t\t\t\t\tsleep := forcegcperiod / <span class=\"number\">2</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> next-now &lt; sleep &#123;</span><br><span class=\"line\">\t\t\t\t\t\tsleep = next - now</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tshouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">true</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnotetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">false</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnow = nanotime()</span><br><span class=\"line\">\t\t\t\t\tnext, _ = timeSleepUntil()</span><br><span class=\"line\">\t\t\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t\t\tnoteclear(&amp;sched.sysmonnote)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\tdelay = <span class=\"number\">20</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tlock(&amp;sched.sysmonlock)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// If we spent a long time blocked on sysmonlock</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// then we want to update now and next since it&#x27;s</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// likely stale.</span></span><br><span class=\"line\">\t\t\tnow1 := nanotime()</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> now1-now &gt; <span class=\"number\">50</span>*<span class=\"number\">1000</span> <span class=\"comment\">/* 50µs */</span> &#123;</span><br><span class=\"line\">\t\t\t\tnext, _ = timeSleepUntil()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tnow = now1</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// trigger libc interceptors if needed</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> *cgo_yield != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tasmcgocall(*cgo_yield, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// poll network if not polled for more than 10ms</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//在队列中等待调度超过10ms，就给交给global抢渡了</span></span><br><span class=\"line\">\t\tlastpoll := <span class=\"keyword\">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> netpollinited() &amp;&amp; lastpoll != <span class=\"number\">0</span> &amp;&amp; lastpoll+<span class=\"number\">10</span>*<span class=\"number\">1000</span>*<span class=\"number\">1000</span> &lt; now &#123;</span><br><span class=\"line\">\t\t\tatomic.Cas64(&amp;sched.lastpoll, <span class=\"keyword\">uint64</span>(lastpoll), <span class=\"keyword\">uint64</span>(now))</span><br><span class=\"line\">\t\t\tlist := netpoll(<span class=\"number\">0</span>) <span class=\"comment\">// non-blocking - returns list of goroutines</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !list.empty() &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// (pretending that one more is running) before injectglist.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Otherwise it can lead to the following situation:</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// another M returns from syscall, finishes running its G,</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// and reports deadlock.</span></span><br><span class=\"line\">\t\t\t\tincidlelocked(<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">//注入全局g队列中</span></span><br><span class=\"line\">\t\t\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t\t\t\tincidlelocked(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> next &lt; now &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// There are timers that should have already run,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// perhaps because there is an unpreemptible P.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Try to start an M to run them.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//需要一个新的M来跑P上面的G。</span></span><br><span class=\"line\">\t\t\tstartm(<span class=\"literal\">nil</span>, <span class=\"literal\">false</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Kick the scavenger awake if someone requested it.</span></span><br><span class=\"line\">\t\t\twakeScavenger()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// retake P&#x27;s blocked in syscalls</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// and preempt long running G&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// 循环所有的allp，进行抢夺。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> retake(now) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tidle++</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// check if we need to force a GC</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//强行GC</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tlock(&amp;forcegc.lock)</span><br><span class=\"line\">\t\t\tforcegc.idle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> list gList</span><br><span class=\"line\">\t\t\tlist.push(forcegc.g)</span><br><span class=\"line\">\t\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t\t\tunlock(&amp;forcegc.lock)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> debug.schedtrace &gt; <span class=\"number\">0</span> &amp;&amp; lasttrace+<span class=\"keyword\">int64</span>(debug.schedtrace)*<span class=\"number\">1000000</span> &lt;= now &#123;</span><br><span class=\"line\">\t\t\tlasttrace = now</span><br><span class=\"line\">\t\t\tschedtrace(debug.scheddetail &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;sched.sysmonlock)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"doInit\"><a class=\"header-anchor\" href=\"#doInit\">¶</a>doInit</h3>\n<blockquote>\n<p>这一部分在源码看来，没有具体的作用，，，，，，，，todo标签吧。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">doInit</span><span class=\"params\">(t *initTask)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> t.state &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>: <span class=\"comment\">// fully initialized</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>: <span class=\"comment\">// initialization in progress</span></span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;recursive call during initialization - linker skew&quot;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">default</span>: <span class=\"comment\">// not initialized yet</span></span><br><span class=\"line\">\t\tt.state = <span class=\"number\">1</span> <span class=\"comment\">// initialization in progress</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i := <span class=\"keyword\">uintptr</span>(<span class=\"number\">0</span>); i &lt; t.ndeps; i++ &#123;</span><br><span class=\"line\">\t\t\tp := add(unsafe.Pointer(t), (<span class=\"number\">3</span>+i)*sys.PtrSize)</span><br><span class=\"line\">\t\t\tt2 := *(**initTask)(p)</span><br><span class=\"line\">\t\t\tdoInit(t2)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i := <span class=\"keyword\">uintptr</span>(<span class=\"number\">0</span>); i &lt; t.nfns; i++ &#123;</span><br><span class=\"line\">\t\t\tp := add(unsafe.Pointer(t), (<span class=\"number\">3</span>+t.ndeps+i)*sys.PtrSize)</span><br><span class=\"line\">\t\t\tf := *(*<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span>)<span class=\"params\">(unsafe.Pointer(&amp;p)</span>)</span></span><br><span class=\"line\">\t\t\tf()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tt.state = <span class=\"number\">2</span> <span class=\"comment\">// initialization done</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"gcenable\"><a class=\"header-anchor\" href=\"#gcenable\">¶</a>gcenable</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// gcenable is called after the bulk of the runtime initialization,</span></span><br><span class=\"line\"><span class=\"comment\">// just before we&#x27;re about to start letting user code run.</span></span><br><span class=\"line\"><span class=\"comment\">// It kicks off the background sweeper goroutine, the background</span></span><br><span class=\"line\"><span class=\"comment\">// scavenger goroutine, and enables GC.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">gcenable</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Kick off sweeping and scavenging.</span></span><br><span class=\"line\">\tc := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">2</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> bgsweep(c)</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> bgscavenge(c)</span><br><span class=\"line\">\t&lt;-c</span><br><span class=\"line\">\t&lt;-c</span><br><span class=\"line\">\tmemstats.enablegc = <span class=\"literal\">true</span> <span class=\"comment\">// now that runtime is initialized, GC is okay</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Gosched\"><a class=\"header-anchor\" href=\"#Gosched\">¶</a>Gosched</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Gosched yields the processor, allowing other goroutines to run. It does not</span></span><br><span class=\"line\"><span class=\"comment\">// suspend the current goroutine, so execution resumes automatically.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Gosched</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tcheckTimeouts()</span><br><span class=\"line\">\tmcall(gosched_m)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"gopark\"><a class=\"header-anchor\" href=\"#gopark\">¶</a>gopark</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Puts the current goroutine into a waiting state and calls unlockf.</span></span><br><span class=\"line\"><span class=\"comment\">// If unlockf returns false, the goroutine is resumed.</span></span><br><span class=\"line\"><span class=\"comment\">// unlockf must not access this G&#x27;s stack, as it may be moved between</span></span><br><span class=\"line\"><span class=\"comment\">// the call to gopark and the call to unlockf.</span></span><br><span class=\"line\"><span class=\"comment\">// Reason explains why the goroutine has been parked.</span></span><br><span class=\"line\"><span class=\"comment\">// It is displayed in stack traces and heap dumps.</span></span><br><span class=\"line\"><span class=\"comment\">// Reasons should be unique and descriptive.</span></span><br><span class=\"line\"><span class=\"comment\">// Do not re-use reasons, add new ones.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">gopark</span><span class=\"params\">(unlockf <span class=\"keyword\">func</span>(*g, unsafe.Pointer)</span> <span class=\"title\">bool</span>, <span class=\"title\">lock</span> <span class=\"title\">unsafe</span>.<span class=\"title\">Pointer</span>, <span class=\"title\">reason</span> <span class=\"title\">waitReason</span>, <span class=\"title\">traceEv</span> <span class=\"title\">byte</span>, <span class=\"title\">traceskip</span> <span class=\"title\">int</span>)</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> reason != waitReasonSleep &#123;</span><br><span class=\"line\">\t\tcheckTimeouts() <span class=\"comment\">// timeouts may expire while two goroutines keep the scheduler busy</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmp := acquirem()</span><br><span class=\"line\">\tgp := mp.curg</span><br><span class=\"line\">\tstatus := readgstatus(gp)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;gopark: bad g status&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmp.waitlock = lock</span><br><span class=\"line\">\tmp.waitunlockf = unlockf</span><br><span class=\"line\">\tgp.waitreason = reason</span><br><span class=\"line\">\tmp.waittraceev = traceEv</span><br><span class=\"line\">\tmp.waittraceskip = traceskip</span><br><span class=\"line\">\t<span class=\"comment\">//mp解绑</span></span><br><span class=\"line\">\treleasem(mp)</span><br><span class=\"line\">\t<span class=\"comment\">// can&#x27;t do anything that might move the G between Ms here.</span></span><br><span class=\"line\">\tmcall(park_m)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"后续\"><a class=\"header-anchor\" href=\"#后续\">¶</a>后续</h3>\n<blockquote>\n<p>关于里面的重要部分实现细节，不是本次关注的重点，，，，</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这次主要看到的是Go围绕main函数，为了程序的正常启动，所做的工作.</span><br><span class=\"line\"></span><br><span class=\"line\">无论是g的启动还是调度监控方面，也就是从整个生命周期来考虑，，，，，，</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">还有一个就是关于panic的处理，采用事件驱动的方式，很好的获取到panic,进行后续的处理。</span><br><span class=\"line\"></span><br><span class=\"line\">最后还有一个关于全局locktrhead，，，，，，粒度尽量细小，有利于提高性能。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"<p>前面g0和m0瞎扯了部分的入口和一些关键的点。</p>\n<p>本来应该扯扯shedule调度方面的知识，但是这个先往后放一节吧，</p>\n<p>先学习下这个「入口函数」，毕竟对于每一个项目都会有一个入口的相关逻辑，那么go源码是怎么处理的？</p>\n<p>有没有什么可以借鉴的嘞？！</p>","more":"<p>接下来该到main函数的相关处理。</p>\n<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h3 id=\"code分析\"><a class=\"header-anchor\" href=\"#code分析\">¶</a>code分析</h3>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/proc.go#L113\">main函数入口</a></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// The main goroutine.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tg := getg()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.</span></span><br><span class=\"line\">\t<span class=\"comment\">// It must not be used for anything else.</span></span><br><span class=\"line\">\tg.m.g0.racectx = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Using decimal instead of binary GB and MB because</span></span><br><span class=\"line\">    <span class=\"comment\">// they look nicer in the stack overflow failure message.</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//最大栈空间限制</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> sys.PtrSize == <span class=\"number\">8</span> &#123;</span><br><span class=\"line\">\t\tmaxstacksize = <span class=\"number\">1000000000</span></span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tmaxstacksize = <span class=\"number\">250000000</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Allow newproc to start new Ms.</span></span><br><span class=\"line\">\tmainStarted = <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//如果是wasm，就不要调度程序了.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> GOARCH != <span class=\"string\">&quot;wasm&quot;</span> &#123; <span class=\"comment\">// no threads on wasm yet, so no sysmon</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">//系统栈调用</span></span><br><span class=\"line\">\t\tsystemstack(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// newm的回调函数，，，一个M一个sysmon P</span></span><br><span class=\"line\">\t\t\tnewm(sysmon, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t&#125;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Lock the main goroutine onto this, the main OS thread,</span></span><br><span class=\"line\">\t<span class=\"comment\">// during initialization. Most programs won&#x27;t care, but a few</span></span><br><span class=\"line\">\t<span class=\"comment\">// do require certain calls to be made by the main thread.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Those can arrange for main.main to run in the main thread</span></span><br><span class=\"line\">\t<span class=\"comment\">// by calling runtime.LockOSThread during initialization</span></span><br><span class=\"line\">\t<span class=\"comment\">// to preserve the lock.</span></span><br><span class=\"line\">\tlockOSThread()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> g.m != &amp;m0 &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;runtime.main not on m0&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdoInit(&amp;runtime_inittask) <span class=\"comment\">// must be before defer</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> nanotime() == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;nanotime returning zero&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Defer unlock so that runtime.Goexit during init does the unlock too.</span></span><br><span class=\"line\">\tneedUnlock := <span class=\"literal\">true</span></span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> needUnlock &#123;</span><br><span class=\"line\">\t\t\tunlockOSThread()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Record when the world started.</span></span><br><span class=\"line\">\truntimeInitTime = nanotime()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//启动GC</span></span><br><span class=\"line\">\tgcenable()</span><br><span class=\"line\"></span><br><span class=\"line\">\tmain_init_done = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">bool</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> iscgo &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> _cgo_thread_start == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> GOOS != <span class=\"string\">&quot;windows&quot;</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> _cgo_setenv == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tthrow(<span class=\"string\">&quot;_cgo_setenv missing&quot;</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> _cgo_unsetenv == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tthrow(<span class=\"string\">&quot;_cgo_unsetenv missing&quot;</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> _cgo_notify_runtime_init_done == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;_cgo_notify_runtime_init_done missing&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Start the template thread in case we enter Go from</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// a C-created thread and need to create a new thread.</span></span><br><span class=\"line\">\t\tstartTemplateThread()</span><br><span class=\"line\">\t\tcgocall(_cgo_notify_runtime_init_done, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tdoInit(&amp;main_inittask)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">close</span>(main_init_done)</span><br><span class=\"line\"></span><br><span class=\"line\">\tneedUnlock = <span class=\"literal\">false</span></span><br><span class=\"line\">\tunlockOSThread()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> isarchive || islibrary &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// A program compiled with -buildmode=c-archive or c-shared</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// has a main, but it is not executed.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//对于main函数的回调，也就是用户写的main程序</span></span><br><span class=\"line\">\tfn := main_main <span class=\"comment\">// make an indirect call, as the linker doesn&#x27;t know the address of the main package when laying down the runtime</span></span><br><span class=\"line\">\tfn()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> raceenabled &#123;</span><br><span class=\"line\">\t\tracefini()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Make racy client program work: if panicking on</span></span><br><span class=\"line\">\t<span class=\"comment\">// another goroutine at the same time as main returns,</span></span><br><span class=\"line\">\t<span class=\"comment\">// let the other goroutine finish printing the panic trace.</span></span><br><span class=\"line\">    <span class=\"comment\">// Once it does, it will exit. See issues 3934 and 20018.</span></span><br><span class=\"line\">    <span class=\"comment\">//判断panicDefer函数，，，，，，</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.Load(&amp;runningPanicDefers) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Running deferred functions should not take long.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> c := <span class=\"number\">0</span>; c &lt; <span class=\"number\">1000</span>; c++ &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;runningPanicDefers) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tGosched()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 判断panic</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.Load(&amp;panicking) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tgopark(<span class=\"literal\">nil</span>, <span class=\"literal\">nil</span>, waitReasonPanicWait, traceEvGoStop, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">//正常退出了那.....</span></span><br><span class=\"line\">\texit(<span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> x *<span class=\"keyword\">int32</span></span><br><span class=\"line\">\t\t*x = <span class=\"number\">0</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"systemstack\"><a class=\"header-anchor\" href=\"#systemstack\">¶</a>systemstack</h3>\n<blockquote>\n<p>这个函数，在整个系统中较为重要，来看看官方说明</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// systemstack runs fn on a system stack.</span></span><br><span class=\"line\"><span class=\"comment\">// If systemstack is called from the per-OS-thread (g0) stack, or</span></span><br><span class=\"line\"><span class=\"comment\">// if systemstack is called from the signal handling (gsignal) stack,</span></span><br><span class=\"line\"><span class=\"comment\">// systemstack calls fn directly and returns.</span></span><br><span class=\"line\"><span class=\"comment\">//g0 stack或者信号处理的，就直接调用并返回。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Otherwise, systemstack is being called from the limited stack</span></span><br><span class=\"line\"><span class=\"comment\">// of an ordinary goroutine. In this case, systemstack switches</span></span><br><span class=\"line\"><span class=\"comment\">// to the per-OS-thread stack, calls fn, and switches back.</span></span><br><span class=\"line\"><span class=\"comment\">// It is common to use a func literal as the argument, in order</span></span><br><span class=\"line\"><span class=\"comment\">// to share inputs and outputs with the code around the call</span></span><br><span class=\"line\"><span class=\"comment\">// to system stack:</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//\t... set up y ...</span></span><br><span class=\"line\"><span class=\"comment\">//\tsystemstack(func() &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//\t\tx = bigcall(y)</span></span><br><span class=\"line\"><span class=\"comment\">//\t&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">//\t... use x ...</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:noescape</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">systemstack</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>)</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"newm\"><a class=\"header-anchor\" href=\"#newm\">¶</a>newm</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class=\"line\"><span class=\"comment\">// fn needs to be static and not a heap allocated closure.</span></span><br><span class=\"line\"><span class=\"comment\">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//用于创建新的M，fn:sysmon函数，类似于事件驱动类型的。</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>, _<span class=\"title\">p_</span> *<span class=\"title\">p</span>)</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">//分配内存</span></span><br><span class=\"line\">\tmp := allocm(_p_, fn)</span><br><span class=\"line\">\tmp.nextp.set(_p_)</span><br><span class=\"line\">\tmp.sigmask = initSigmask</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> gp := getg(); gp != <span class=\"literal\">nil</span> &amp;&amp; gp.m != <span class=\"literal\">nil</span> &amp;&amp; (gp.m.lockedExt != <span class=\"number\">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class=\"string\">&quot;plan9&quot;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// started by C. The kernel state of this thread may</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// be strange (the user may have locked it for that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// thread. Instead, ask a known-good thread to create</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the thread for us.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// doesn&#x27;t model thread creation off fork.</span></span><br><span class=\"line\">\t\tlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.haveTemplateThread == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tmp.schedlink = newmHandoff.newm</span><br><span class=\"line\">\t\tnewmHandoff.newm.set(mp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.waiting &#123;</span><br><span class=\"line\">\t\t\tnewmHandoff.waiting = <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t\tnotewakeup(&amp;newmHandoff.wake)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnewm1(mp)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>主要是以下几个函数：</p>\n</blockquote>\n<ul>\n<li>allocm</li>\n<li>notewakeup</li>\n<li>newm1</li>\n</ul>\n<h3 id=\"sysmon\"><a class=\"header-anchor\" href=\"#sysmon\">¶</a>sysmon</h3>\n<p>学习系统监控之前，先学下部分函数的使用和其大概含义：</p>\n<ul>\n<li>checkdead</li>\n<li>usleep</li>\n<li>timeSleepUntil</li>\n<li>nanotime</li>\n<li>netpollinited</li>\n<li>startm</li>\n<li>retake</li>\n<li>gcTrigger</li>\n<li>injectglist</li>\n</ul>\n<blockquote>\n<p>先看下主体流程</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Always runs without a P, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">sysmon</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlock(&amp;sched.lock)</span><br><span class=\"line\">\tsched.nmsys++</span><br><span class=\"line\">\t<span class=\"comment\">//基于running中的M，检查死锁，，，，</span></span><br><span class=\"line\">\tcheckdead()</span><br><span class=\"line\">\tunlock(&amp;sched.lock)</span><br><span class=\"line\"></span><br><span class=\"line\">\tlasttrace := <span class=\"keyword\">int64</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tidle := <span class=\"number\">0</span> <span class=\"comment\">// how many cycles in succession we had not wokeup somebody</span></span><br><span class=\"line\">\tdelay := <span class=\"keyword\">uint32</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> idle == <span class=\"number\">0</span> &#123; <span class=\"comment\">// start with 20us sleep...</span></span><br><span class=\"line\">\t\t\tdelay = <span class=\"number\">20</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> idle &gt; <span class=\"number\">50</span> &#123; <span class=\"comment\">// start doubling the sleep after 1ms...</span></span><br><span class=\"line\">\t\t\tdelay *= <span class=\"number\">2</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> delay &gt; <span class=\"number\">10</span>*<span class=\"number\">1000</span> &#123; <span class=\"comment\">// up to 10ms</span></span><br><span class=\"line\">\t\t\tdelay = <span class=\"number\">10</span> * <span class=\"number\">1000</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">//休眠时间</span></span><br><span class=\"line\">\t\tusleep(delay)</span><br><span class=\"line\">\t\t<span class=\"comment\">//获取时间</span></span><br><span class=\"line\">\t\tnow := nanotime()</span><br><span class=\"line\">\t\t<span class=\"comment\">// 休眠等待唤醒信号</span></span><br><span class=\"line\">\t\tnext, _ := timeSleepUntil()</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> debug.schedtrace &lt;= <span class=\"number\">0</span> &amp;&amp; (sched.gcwaiting != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs)) &#123;</span><br><span class=\"line\">\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> next &gt; now &#123;</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Make wake-up period small enough</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// for the sampling to be correct.</span></span><br><span class=\"line\">\t\t\t\t\tsleep := forcegcperiod / <span class=\"number\">2</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> next-now &lt; sleep &#123;</span><br><span class=\"line\">\t\t\t\t\t\tsleep = next - now</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tshouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">true</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnotetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">false</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnow = nanotime()</span><br><span class=\"line\">\t\t\t\t\tnext, _ = timeSleepUntil()</span><br><span class=\"line\">\t\t\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t\t\tnoteclear(&amp;sched.sysmonnote)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\tdelay = <span class=\"number\">20</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tlock(&amp;sched.sysmonlock)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// If we spent a long time blocked on sysmonlock</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// then we want to update now and next since it&#x27;s</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// likely stale.</span></span><br><span class=\"line\">\t\t\tnow1 := nanotime()</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> now1-now &gt; <span class=\"number\">50</span>*<span class=\"number\">1000</span> <span class=\"comment\">/* 50µs */</span> &#123;</span><br><span class=\"line\">\t\t\t\tnext, _ = timeSleepUntil()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tnow = now1</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// trigger libc interceptors if needed</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> *cgo_yield != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tasmcgocall(*cgo_yield, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// poll network if not polled for more than 10ms</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//在队列中等待调度超过10ms，就给交给global抢渡了</span></span><br><span class=\"line\">\t\tlastpoll := <span class=\"keyword\">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> netpollinited() &amp;&amp; lastpoll != <span class=\"number\">0</span> &amp;&amp; lastpoll+<span class=\"number\">10</span>*<span class=\"number\">1000</span>*<span class=\"number\">1000</span> &lt; now &#123;</span><br><span class=\"line\">\t\t\tatomic.Cas64(&amp;sched.lastpoll, <span class=\"keyword\">uint64</span>(lastpoll), <span class=\"keyword\">uint64</span>(now))</span><br><span class=\"line\">\t\t\tlist := netpoll(<span class=\"number\">0</span>) <span class=\"comment\">// non-blocking - returns list of goroutines</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !list.empty() &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// (pretending that one more is running) before injectglist.</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Otherwise it can lead to the following situation:</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// another M returns from syscall, finishes running its G,</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// and reports deadlock.</span></span><br><span class=\"line\">\t\t\t\tincidlelocked(<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">//注入全局g队列中</span></span><br><span class=\"line\">\t\t\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t\t\t\tincidlelocked(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> next &lt; now &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// There are timers that should have already run,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// perhaps because there is an unpreemptible P.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Try to start an M to run them.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//需要一个新的M来跑P上面的G。</span></span><br><span class=\"line\">\t\t\tstartm(<span class=\"literal\">nil</span>, <span class=\"literal\">false</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Kick the scavenger awake if someone requested it.</span></span><br><span class=\"line\">\t\t\twakeScavenger()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// retake P&#x27;s blocked in syscalls</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// and preempt long running G&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// 循环所有的allp，进行抢夺。</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> retake(now) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tidle++</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"comment\">// check if we need to force a GC</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//强行GC</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tlock(&amp;forcegc.lock)</span><br><span class=\"line\">\t\t\tforcegc.idle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> list gList</span><br><span class=\"line\">\t\t\tlist.push(forcegc.g)</span><br><span class=\"line\">\t\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t\t\tunlock(&amp;forcegc.lock)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> debug.schedtrace &gt; <span class=\"number\">0</span> &amp;&amp; lasttrace+<span class=\"keyword\">int64</span>(debug.schedtrace)*<span class=\"number\">1000000</span> &lt;= now &#123;</span><br><span class=\"line\">\t\t\tlasttrace = now</span><br><span class=\"line\">\t\t\tschedtrace(debug.scheddetail &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;sched.sysmonlock)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"doInit\"><a class=\"header-anchor\" href=\"#doInit\">¶</a>doInit</h3>\n<blockquote>\n<p>这一部分在源码看来，没有具体的作用，，，，，，，，todo标签吧。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">doInit</span><span class=\"params\">(t *initTask)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> t.state &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>: <span class=\"comment\">// fully initialized</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>: <span class=\"comment\">// initialization in progress</span></span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;recursive call during initialization - linker skew&quot;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">default</span>: <span class=\"comment\">// not initialized yet</span></span><br><span class=\"line\">\t\tt.state = <span class=\"number\">1</span> <span class=\"comment\">// initialization in progress</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i := <span class=\"keyword\">uintptr</span>(<span class=\"number\">0</span>); i &lt; t.ndeps; i++ &#123;</span><br><span class=\"line\">\t\t\tp := add(unsafe.Pointer(t), (<span class=\"number\">3</span>+i)*sys.PtrSize)</span><br><span class=\"line\">\t\t\tt2 := *(**initTask)(p)</span><br><span class=\"line\">\t\t\tdoInit(t2)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> i := <span class=\"keyword\">uintptr</span>(<span class=\"number\">0</span>); i &lt; t.nfns; i++ &#123;</span><br><span class=\"line\">\t\t\tp := add(unsafe.Pointer(t), (<span class=\"number\">3</span>+t.ndeps+i)*sys.PtrSize)</span><br><span class=\"line\">\t\t\tf := *(*<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span>)<span class=\"params\">(unsafe.Pointer(&amp;p)</span>)</span></span><br><span class=\"line\">\t\t\tf()</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tt.state = <span class=\"number\">2</span> <span class=\"comment\">// initialization done</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"gcenable\"><a class=\"header-anchor\" href=\"#gcenable\">¶</a>gcenable</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// gcenable is called after the bulk of the runtime initialization,</span></span><br><span class=\"line\"><span class=\"comment\">// just before we&#x27;re about to start letting user code run.</span></span><br><span class=\"line\"><span class=\"comment\">// It kicks off the background sweeper goroutine, the background</span></span><br><span class=\"line\"><span class=\"comment\">// scavenger goroutine, and enables GC.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">gcenable</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Kick off sweeping and scavenging.</span></span><br><span class=\"line\">\tc := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">2</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> bgsweep(c)</span><br><span class=\"line\">\t<span class=\"keyword\">go</span> bgscavenge(c)</span><br><span class=\"line\">\t&lt;-c</span><br><span class=\"line\">\t&lt;-c</span><br><span class=\"line\">\tmemstats.enablegc = <span class=\"literal\">true</span> <span class=\"comment\">// now that runtime is initialized, GC is okay</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Gosched\"><a class=\"header-anchor\" href=\"#Gosched\">¶</a>Gosched</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Gosched yields the processor, allowing other goroutines to run. It does not</span></span><br><span class=\"line\"><span class=\"comment\">// suspend the current goroutine, so execution resumes automatically.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Gosched</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tcheckTimeouts()</span><br><span class=\"line\">\tmcall(gosched_m)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"gopark\"><a class=\"header-anchor\" href=\"#gopark\">¶</a>gopark</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Puts the current goroutine into a waiting state and calls unlockf.</span></span><br><span class=\"line\"><span class=\"comment\">// If unlockf returns false, the goroutine is resumed.</span></span><br><span class=\"line\"><span class=\"comment\">// unlockf must not access this G&#x27;s stack, as it may be moved between</span></span><br><span class=\"line\"><span class=\"comment\">// the call to gopark and the call to unlockf.</span></span><br><span class=\"line\"><span class=\"comment\">// Reason explains why the goroutine has been parked.</span></span><br><span class=\"line\"><span class=\"comment\">// It is displayed in stack traces and heap dumps.</span></span><br><span class=\"line\"><span class=\"comment\">// Reasons should be unique and descriptive.</span></span><br><span class=\"line\"><span class=\"comment\">// Do not re-use reasons, add new ones.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">gopark</span><span class=\"params\">(unlockf <span class=\"keyword\">func</span>(*g, unsafe.Pointer)</span> <span class=\"title\">bool</span>, <span class=\"title\">lock</span> <span class=\"title\">unsafe</span>.<span class=\"title\">Pointer</span>, <span class=\"title\">reason</span> <span class=\"title\">waitReason</span>, <span class=\"title\">traceEv</span> <span class=\"title\">byte</span>, <span class=\"title\">traceskip</span> <span class=\"title\">int</span>)</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> reason != waitReasonSleep &#123;</span><br><span class=\"line\">\t\tcheckTimeouts() <span class=\"comment\">// timeouts may expire while two goroutines keep the scheduler busy</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmp := acquirem()</span><br><span class=\"line\">\tgp := mp.curg</span><br><span class=\"line\">\tstatus := readgstatus(gp)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;gopark: bad g status&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmp.waitlock = lock</span><br><span class=\"line\">\tmp.waitunlockf = unlockf</span><br><span class=\"line\">\tgp.waitreason = reason</span><br><span class=\"line\">\tmp.waittraceev = traceEv</span><br><span class=\"line\">\tmp.waittraceskip = traceskip</span><br><span class=\"line\">\t<span class=\"comment\">//mp解绑</span></span><br><span class=\"line\">\treleasem(mp)</span><br><span class=\"line\">\t<span class=\"comment\">// can&#x27;t do anything that might move the G between Ms here.</span></span><br><span class=\"line\">\tmcall(park_m)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"后续\"><a class=\"header-anchor\" href=\"#后续\">¶</a>后续</h3>\n<blockquote>\n<p>关于里面的重要部分实现细节，不是本次关注的重点，，，，</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这次主要看到的是Go围绕main函数，为了程序的正常启动，所做的工作.</span><br><span class=\"line\"></span><br><span class=\"line\">无论是g的启动还是调度监控方面，也就是从整个生命周期来考虑，，，，，，</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">还有一个就是关于panic的处理，采用事件驱动的方式，很好的获取到panic,进行后续的处理。</span><br><span class=\"line\"></span><br><span class=\"line\">最后还有一个关于全局locktrhead，，，，，，粒度尽量细小，有利于提高性能。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Sat Nov 21 2020 21:00:17 GMT+0800 (中国标准时间)","title":"「23」GPM main入口函数","path":"archives/9bb71eca.html","eyeCatchImage":null,"excerpt":"<p>前面g0和m0瞎扯了部分的入口和一些关键的点。</p>\n<p>本来应该扯扯shedule调度方面的知识，但是这个先往后放一节吧，</p>\n<p>先学习下这个「入口函数」，毕竟对于每一个项目都会有一个入口的相关逻辑，那么go源码是怎么处理的？</p>\n<p>有没有什么可以借鉴的嘞？！</p>","date":{"_isAMomentObject":true,"_i":"2020-11-21T13:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-21T13:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","GPM","Go源码"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":11128},{"title":"「24」GPM newm函数","date":"2020-11-25T12:00:17.000Z","updated":"2020-11-25T12:00:17.000Z","keywords":"GPM,Go,Go调度器,Go资源调度器","abbrlink":"b4edbd7","_content":"\n\n\n上节看了go的入口函数，，，也就是你执行main函数前后所做的准备工作。\n\n\n\n继续深入学习。「newm」第一个M，到底是怎么来的？\n\n\n\n<!--more-->\n\n\n\n> go version: 1.14.3\n\n### 入口\n\n先看下主体，主要在M创建的过程中，干了what，，，，，「PS : 关键看值得学习的点」\n\n```go\n// Create a new m. It will start off with a call to fn, or else the scheduler.\n// fn needs to be static and not a heap allocated closure.\n// May run with m.p==nil, so write barriers are not allowed.\n//go:nowritebarrierrec\nfunc newm(fn func(), _p_ *p) {\n  //分配内存\n\tmp := allocm(_p_, fn)\n  //设置p\n\tmp.nextp.set(_p_)\n  //初始化信号量\n\tmp.sigmask = initSigmask\n  //获取到gp后，判断M&（系统锁定｜｜cgo执行中）；；；plan9的系统跳过下面操作....\n\tif gp := getg(); gp != nil && gp.m != nil && (gp.m.lockedExt != 0 || gp.m.incgo) && GOOS != \"plan9\" {\n\t\t// We're on a locked M or a thread that may have been\n\t\t// started by C. The kernel state of this thread may\n\t\t// be strange (the user may have locked it for that\n\t\t// purpose). We don't want to clone that into another\n\t\t// thread. Instead, ask a known-good thread to create\n\t\t// the thread for us.\n\t\t//\n\t\t// This is disabled on Plan 9. See golang.org/issue/22227.\n\t\t//\n\t\t// TODO: This may be unnecessary on Windows, which\n\t\t// doesn't model thread creation off fork.\n\t\tlock(&newmHandoff.lock)\n\t\tif newmHandoff.haveTemplateThread == 0 {\n\t\t\tthrow(\"on a locked thread with no template thread\")\n\t\t}\n\t\tmp.schedlink = newmHandoff.newm\n\t\tnewmHandoff.newm.set(mp)\n\t\tif newmHandoff.waiting {\n\t\t\tnewmHandoff.waiting = false\n\t\t\tnotewakeup(&newmHandoff.wake)\n\t\t}\n\t\tunlock(&newmHandoff.lock)\n\t\treturn\n\t}\n  //new m1指第一个M的创建过程.\n\tnewm1(mp)\n}\n```\n\n\n\n### newm1\n\n> go to 「newm1」\n\n看起来很简短\n\n```go\nfunc newm1(mp *m) {\n  //cgo程序执行中?\n\tif iscgo {\n\t\tvar ts cgothreadstart\n\t\tif _cgo_thread_start == nil {\n\t\t\tthrow(\"_cgo_thread_start missing\")\n\t\t}\n\t\tts.g.set(mp.g0)\n\t\tts.tls = (*uint64)(unsafe.Pointer(&mp.tls[0]))\n\t\tts.fn = unsafe.Pointer(funcPC(mstart))\n\t\tif msanenabled {\n\t\t\tmsanwrite(unsafe.Pointer(&ts), unsafe.Sizeof(ts))\n\t\t}\n\t\texecLock.rlock() // Prevent process clone.\n\t\tasmcgocall(_cgo_thread_start, unsafe.Pointer(&ts))\n\t\texecLock.runlock()\n\t\treturn\n\t}\n  \n\texecLock.rlock() // Prevent process clone.\n  //涉及到系统进程创建\n\tnewosproc(mp)\n\texecLock.runlock()\n}\n```\n\n\n\n### newosproc\n\n> M创建之前，系统的操作和相关地址的变化\n\n\n\n```go\n// May run with m.p==nil, so write barriers are not allowed.\n//go:nowritebarrierrec\nfunc newosproc(mp *m) {\n//这个stk操作很奇怪，有兴趣的可以研究下....[看起来啥也没干那]\n\tstk := unsafe.Pointer(mp.g0.stack.hi)\n\tif false {\n\t\tprint(\"newosproc stk=\", stk, \" m=\", mp, \" g=\", mp.g0, \" id=\", mp.id, \" ostk=\", &mp, \"\\n\")\n\t}\n\n\t// Initialize an attribute object.\n\tvar attr pthreadattr\n\tvar err int32\n  //汇编，变量初始化\n\terr = pthread_attr_init(&attr)\n\tif err != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n\n\t// Find out OS stack size for our own stack guard.\n\tvar stacksize uintptr\n\tif pthread_attr_getstacksize(&attr, &stacksize) != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n  //M对应的g0的高位空间栈地址\n\tmp.g0.stack.hi = stacksize // for mstart\n\t//mSysStatInc(&memstats.stacks_sys, stacksize) //TODO: do this?\n\n\t// Tell the pthread library we won't join with this thread.\n\tif pthread_attr_setdetachstate(&attr, _PTHREAD_CREATE_DETACHED) != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n\n\t// Finally, create the thread. It starts at mstart_stub, which does some low-level\n\t// setup and then calls mstart.\n\tvar oset sigset\n  //所有的mask初始化\n\tsigprocmask(_SIG_SETMASK, &sigset_all, &oset)\n\terr = pthread_create(&attr, funcPC(mstart_stub), unsafe.Pointer(mp))\n  // oset地址置nil\n\tsigprocmask(_SIG_SETMASK, &oset, nil)\n\tif err != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n}\n```\n\n#### [pthread_attr_init细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L402)\n\n> 汇编代码：\n\n```go\nTEXT runtime·pthread_attr_init_trampoline(SB),NOSPLIT,$0\n\tMOVD\t0(R0), R0\t// arg 1 attr\n\tBL\tlibc_pthread_attr_init(SB)\n\tRET\n```\n\n\n\n#### [pthread_attr_getstacksize细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L407)\n\n```go\nTEXT runtime·pthread_attr_getstacksize_trampoline(SB),NOSPLIT,$0\n\tMOVD\t8(R0), R1\t// arg 2 size\n\tMOVD\t0(R0), R0\t// arg 1 attr\n\tBL\tlibc_pthread_attr_getstacksize(SB)\n\tRET\n```\n\n#### [sigprocmask_trampoline细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L266)\n\n```go\nTEXT runtime·sigprocmask_trampoline(SB),NOSPLIT,$0\n\tMOVD\t8(R0), R1\t// arg 2 new\n\tMOVD\t16(R0), R2\t// arg 3 old\n\tMOVW\t0(R0), R0\t// arg 1 how\n\tBL\tlibc_pthread_sigmask(SB)\n\tCMP\t$0, R0\n\tBEQ\t2(PC)\n\tBL\tnotok<>(SB)\n\tRET\n```\n\n#### [pthread_create细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L342)\n\n```go\n// mstart_stub is the first function executed on a new thread started by pthread_create.\n// It just does some low-level setup and then calls mstart.\n// Note: called with the C calling convention.\nTEXT runtime·mstart_stub(SB),NOSPLIT,$0\n\t// DI points to the m.\n\t// We are already on m's g0 stack.\n\n\t// Save callee-save registers.\n\tSUBQ\t$40, SP\n\tMOVQ\tBX, 0(SP)\n\tMOVQ\tR12, 8(SP)\n\tMOVQ\tR13, 16(SP)\n\tMOVQ\tR14, 24(SP)\n\tMOVQ\tR15, 32(SP)\n\n\tMOVQ\tm_g0(DI), DX // g\n\n\t// Initialize TLS entry.\n\t// See cmd/link/internal/ld/sym.go:computeTLSOffset.\n\tMOVQ\tDX, 0x30(GS)\n\n\t// Someday the convention will be D is always cleared.\n\tCLD\n\n\tCALL\truntime·mstart(SB)\n\n\t// Restore callee-save registers.\n\tMOVQ\t0(SP), BX\n\tMOVQ\t8(SP), R12\n\tMOVQ\t16(SP), R13\n\tMOVQ\t24(SP), R14\n\tMOVQ\t32(SP), R15\n\n\t// Go is all done with this OS thread.\n\t// Tell pthread everything is ok (we never join with this thread, so\n\t// the value here doesn't really matter).\n\tXORL\tAX, AX\n\n\tADDQ\t$40, SP\n\tRET\n\n```\n\n\n\n### execLock.rlock()\n\n\n\n\n\n```go\n\n// rlock locks rw for reading.\nfunc (rw *rwmutex) rlock() {\n\t// The reader must not be allowed to lose its P or else other\n\t// things blocking on the lock may consume all of the Ps and\n\t// deadlock (issue #20903). Alternatively, we could drop the P\n\t// while sleeping.\n\tacquirem()\n\tif int32(atomic.Xadd(&rw.readerCount, 1)) < 0 {\n\t\t// A writer is pending. Park on the reader queue.\n\t\tsystemstack(func() {\n\t\t\tlockWithRank(&rw.rLock, lockRankRwmutexR)\n\t\t\tif rw.readerPass > 0 {\n\t\t\t\t// Writer finished.\n\t\t\t\trw.readerPass -= 1\n\t\t\t\tunlock(&rw.rLock)\n\t\t\t} else {\n\t\t\t\t// Queue this reader to be woken by\n\t\t\t\t// the writer.\n\t\t\t\tm := getg().m\n\t\t\t\tm.schedlink = rw.readers\n\t\t\t\trw.readers.set(m)\n\t\t\t\tunlock(&rw.rLock)\n\t\t\t\tnotesleep(&m.park)\n\t\t\t\tnoteclear(&m.park)\n\t\t\t}\n\t\t})\n\t}\n}\n```\n\n\n\n\n\n#### acquirem()\n\n> 加锁获取M\n\n```go\n//go:nosplit\nfunc acquirem() *m {\n\t_g_ := getg()\n\t_g_.m.locks++\n\treturn _g_.m\n}\n```\n\n#### notesleep()\n\n> 比较有趣的是sleep是用队列实现,前后加锁\n\n```go\nfunc notesleep(n *note) {\n\tgp := getg()\n\t...\n\t// Queued. Sleep.\n\tgp.m.blocked = true\n\tif *cgo_yield == nil {\n\t\tsemasleep(-1)\n\t} else {\n\t\t// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.\n\t\tconst ns = 10e6\n\t\tfor atomic.Loaduintptr(&n.key) == 0 {\n\t\t\tsemasleep(ns)\n\t\t\tasmcgocall(*cgo_yield, nil)\n\t\t}\n\t}\n\tgp.m.blocked = false\n}\n```\n\n\n\n### execLock.runlock()\n\n```go\n\n// runlock undoes a single rlock call on rw.\nfunc (rw *rwmutex) runlock() {\n\tif r := int32(atomic.Xadd(&rw.readerCount, -1)); r < 0 {\n\t\t....\n\t}\n\treleasem(getg().m)\n}\n```\n\n#### releasem\n\n```go\n//go:nosplit\n//lock数量➖1，恢复到preempt的状态.\nfunc releasem(mp *m) {\n\t_g_ := getg()\n\tmp.locks--\n\tif mp.locks == 0 && _g_.preempt {\n\t\t// restore the preemption request in case we've cleared it in newstack\n\t\t_g_.stackguard0 = stackPreempt\n\t}\n}\n```\n\n\n\n先分析到这儿吧........关于这一节的流程图，会整理出来的，，，，\n\n不然就白分析这么多了，及时学习，及时总结。\n\n晚安😴......","source":"_posts/24-GPM-newm函数.md","raw":"---\ntitle: 「24」GPM newm函数\ndate: '2020/11/25 20:00:17'\nupdated: '2020/11/25 20:00:17'\nkeywords: 'GPM,Go,Go调度器,Go资源调度器'\ntags:\n  - Go\n  - GPM\n  - Go源码\nabbrlink: b4edbd7\n---\n\n\n\n上节看了go的入口函数，，，也就是你执行main函数前后所做的准备工作。\n\n\n\n继续深入学习。「newm」第一个M，到底是怎么来的？\n\n\n\n<!--more-->\n\n\n\n> go version: 1.14.3\n\n### 入口\n\n先看下主体，主要在M创建的过程中，干了what，，，，，「PS : 关键看值得学习的点」\n\n```go\n// Create a new m. It will start off with a call to fn, or else the scheduler.\n// fn needs to be static and not a heap allocated closure.\n// May run with m.p==nil, so write barriers are not allowed.\n//go:nowritebarrierrec\nfunc newm(fn func(), _p_ *p) {\n  //分配内存\n\tmp := allocm(_p_, fn)\n  //设置p\n\tmp.nextp.set(_p_)\n  //初始化信号量\n\tmp.sigmask = initSigmask\n  //获取到gp后，判断M&（系统锁定｜｜cgo执行中）；；；plan9的系统跳过下面操作....\n\tif gp := getg(); gp != nil && gp.m != nil && (gp.m.lockedExt != 0 || gp.m.incgo) && GOOS != \"plan9\" {\n\t\t// We're on a locked M or a thread that may have been\n\t\t// started by C. The kernel state of this thread may\n\t\t// be strange (the user may have locked it for that\n\t\t// purpose). We don't want to clone that into another\n\t\t// thread. Instead, ask a known-good thread to create\n\t\t// the thread for us.\n\t\t//\n\t\t// This is disabled on Plan 9. See golang.org/issue/22227.\n\t\t//\n\t\t// TODO: This may be unnecessary on Windows, which\n\t\t// doesn't model thread creation off fork.\n\t\tlock(&newmHandoff.lock)\n\t\tif newmHandoff.haveTemplateThread == 0 {\n\t\t\tthrow(\"on a locked thread with no template thread\")\n\t\t}\n\t\tmp.schedlink = newmHandoff.newm\n\t\tnewmHandoff.newm.set(mp)\n\t\tif newmHandoff.waiting {\n\t\t\tnewmHandoff.waiting = false\n\t\t\tnotewakeup(&newmHandoff.wake)\n\t\t}\n\t\tunlock(&newmHandoff.lock)\n\t\treturn\n\t}\n  //new m1指第一个M的创建过程.\n\tnewm1(mp)\n}\n```\n\n\n\n### newm1\n\n> go to 「newm1」\n\n看起来很简短\n\n```go\nfunc newm1(mp *m) {\n  //cgo程序执行中?\n\tif iscgo {\n\t\tvar ts cgothreadstart\n\t\tif _cgo_thread_start == nil {\n\t\t\tthrow(\"_cgo_thread_start missing\")\n\t\t}\n\t\tts.g.set(mp.g0)\n\t\tts.tls = (*uint64)(unsafe.Pointer(&mp.tls[0]))\n\t\tts.fn = unsafe.Pointer(funcPC(mstart))\n\t\tif msanenabled {\n\t\t\tmsanwrite(unsafe.Pointer(&ts), unsafe.Sizeof(ts))\n\t\t}\n\t\texecLock.rlock() // Prevent process clone.\n\t\tasmcgocall(_cgo_thread_start, unsafe.Pointer(&ts))\n\t\texecLock.runlock()\n\t\treturn\n\t}\n  \n\texecLock.rlock() // Prevent process clone.\n  //涉及到系统进程创建\n\tnewosproc(mp)\n\texecLock.runlock()\n}\n```\n\n\n\n### newosproc\n\n> M创建之前，系统的操作和相关地址的变化\n\n\n\n```go\n// May run with m.p==nil, so write barriers are not allowed.\n//go:nowritebarrierrec\nfunc newosproc(mp *m) {\n//这个stk操作很奇怪，有兴趣的可以研究下....[看起来啥也没干那]\n\tstk := unsafe.Pointer(mp.g0.stack.hi)\n\tif false {\n\t\tprint(\"newosproc stk=\", stk, \" m=\", mp, \" g=\", mp.g0, \" id=\", mp.id, \" ostk=\", &mp, \"\\n\")\n\t}\n\n\t// Initialize an attribute object.\n\tvar attr pthreadattr\n\tvar err int32\n  //汇编，变量初始化\n\terr = pthread_attr_init(&attr)\n\tif err != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n\n\t// Find out OS stack size for our own stack guard.\n\tvar stacksize uintptr\n\tif pthread_attr_getstacksize(&attr, &stacksize) != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n  //M对应的g0的高位空间栈地址\n\tmp.g0.stack.hi = stacksize // for mstart\n\t//mSysStatInc(&memstats.stacks_sys, stacksize) //TODO: do this?\n\n\t// Tell the pthread library we won't join with this thread.\n\tif pthread_attr_setdetachstate(&attr, _PTHREAD_CREATE_DETACHED) != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n\n\t// Finally, create the thread. It starts at mstart_stub, which does some low-level\n\t// setup and then calls mstart.\n\tvar oset sigset\n  //所有的mask初始化\n\tsigprocmask(_SIG_SETMASK, &sigset_all, &oset)\n\terr = pthread_create(&attr, funcPC(mstart_stub), unsafe.Pointer(mp))\n  // oset地址置nil\n\tsigprocmask(_SIG_SETMASK, &oset, nil)\n\tif err != 0 {\n\t\twrite(2, unsafe.Pointer(&failthreadcreate[0]), int32(len(failthreadcreate)))\n\t\texit(1)\n\t}\n}\n```\n\n#### [pthread_attr_init细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L402)\n\n> 汇编代码：\n\n```go\nTEXT runtime·pthread_attr_init_trampoline(SB),NOSPLIT,$0\n\tMOVD\t0(R0), R0\t// arg 1 attr\n\tBL\tlibc_pthread_attr_init(SB)\n\tRET\n```\n\n\n\n#### [pthread_attr_getstacksize细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L407)\n\n```go\nTEXT runtime·pthread_attr_getstacksize_trampoline(SB),NOSPLIT,$0\n\tMOVD\t8(R0), R1\t// arg 2 size\n\tMOVD\t0(R0), R0\t// arg 1 attr\n\tBL\tlibc_pthread_attr_getstacksize(SB)\n\tRET\n```\n\n#### [sigprocmask_trampoline细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L266)\n\n```go\nTEXT runtime·sigprocmask_trampoline(SB),NOSPLIT,$0\n\tMOVD\t8(R0), R1\t// arg 2 new\n\tMOVD\t16(R0), R2\t// arg 3 old\n\tMOVW\t0(R0), R0\t// arg 1 how\n\tBL\tlibc_pthread_sigmask(SB)\n\tCMP\t$0, R0\n\tBEQ\t2(PC)\n\tBL\tnotok<>(SB)\n\tRET\n```\n\n#### [pthread_create细节](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L342)\n\n```go\n// mstart_stub is the first function executed on a new thread started by pthread_create.\n// It just does some low-level setup and then calls mstart.\n// Note: called with the C calling convention.\nTEXT runtime·mstart_stub(SB),NOSPLIT,$0\n\t// DI points to the m.\n\t// We are already on m's g0 stack.\n\n\t// Save callee-save registers.\n\tSUBQ\t$40, SP\n\tMOVQ\tBX, 0(SP)\n\tMOVQ\tR12, 8(SP)\n\tMOVQ\tR13, 16(SP)\n\tMOVQ\tR14, 24(SP)\n\tMOVQ\tR15, 32(SP)\n\n\tMOVQ\tm_g0(DI), DX // g\n\n\t// Initialize TLS entry.\n\t// See cmd/link/internal/ld/sym.go:computeTLSOffset.\n\tMOVQ\tDX, 0x30(GS)\n\n\t// Someday the convention will be D is always cleared.\n\tCLD\n\n\tCALL\truntime·mstart(SB)\n\n\t// Restore callee-save registers.\n\tMOVQ\t0(SP), BX\n\tMOVQ\t8(SP), R12\n\tMOVQ\t16(SP), R13\n\tMOVQ\t24(SP), R14\n\tMOVQ\t32(SP), R15\n\n\t// Go is all done with this OS thread.\n\t// Tell pthread everything is ok (we never join with this thread, so\n\t// the value here doesn't really matter).\n\tXORL\tAX, AX\n\n\tADDQ\t$40, SP\n\tRET\n\n```\n\n\n\n### execLock.rlock()\n\n\n\n\n\n```go\n\n// rlock locks rw for reading.\nfunc (rw *rwmutex) rlock() {\n\t// The reader must not be allowed to lose its P or else other\n\t// things blocking on the lock may consume all of the Ps and\n\t// deadlock (issue #20903). Alternatively, we could drop the P\n\t// while sleeping.\n\tacquirem()\n\tif int32(atomic.Xadd(&rw.readerCount, 1)) < 0 {\n\t\t// A writer is pending. Park on the reader queue.\n\t\tsystemstack(func() {\n\t\t\tlockWithRank(&rw.rLock, lockRankRwmutexR)\n\t\t\tif rw.readerPass > 0 {\n\t\t\t\t// Writer finished.\n\t\t\t\trw.readerPass -= 1\n\t\t\t\tunlock(&rw.rLock)\n\t\t\t} else {\n\t\t\t\t// Queue this reader to be woken by\n\t\t\t\t// the writer.\n\t\t\t\tm := getg().m\n\t\t\t\tm.schedlink = rw.readers\n\t\t\t\trw.readers.set(m)\n\t\t\t\tunlock(&rw.rLock)\n\t\t\t\tnotesleep(&m.park)\n\t\t\t\tnoteclear(&m.park)\n\t\t\t}\n\t\t})\n\t}\n}\n```\n\n\n\n\n\n#### acquirem()\n\n> 加锁获取M\n\n```go\n//go:nosplit\nfunc acquirem() *m {\n\t_g_ := getg()\n\t_g_.m.locks++\n\treturn _g_.m\n}\n```\n\n#### notesleep()\n\n> 比较有趣的是sleep是用队列实现,前后加锁\n\n```go\nfunc notesleep(n *note) {\n\tgp := getg()\n\t...\n\t// Queued. Sleep.\n\tgp.m.blocked = true\n\tif *cgo_yield == nil {\n\t\tsemasleep(-1)\n\t} else {\n\t\t// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.\n\t\tconst ns = 10e6\n\t\tfor atomic.Loaduintptr(&n.key) == 0 {\n\t\t\tsemasleep(ns)\n\t\t\tasmcgocall(*cgo_yield, nil)\n\t\t}\n\t}\n\tgp.m.blocked = false\n}\n```\n\n\n\n### execLock.runlock()\n\n```go\n\n// runlock undoes a single rlock call on rw.\nfunc (rw *rwmutex) runlock() {\n\tif r := int32(atomic.Xadd(&rw.readerCount, -1)); r < 0 {\n\t\t....\n\t}\n\treleasem(getg().m)\n}\n```\n\n#### releasem\n\n```go\n//go:nosplit\n//lock数量➖1，恢复到preempt的状态.\nfunc releasem(mp *m) {\n\t_g_ := getg()\n\tmp.locks--\n\tif mp.locks == 0 && _g_.preempt {\n\t\t// restore the preemption request in case we've cleared it in newstack\n\t\t_g_.stackguard0 = stackPreempt\n\t}\n}\n```\n\n\n\n先分析到这儿吧........关于这一节的流程图，会整理出来的，，，，\n\n不然就白分析这么多了，及时学习，及时总结。\n\n晚安😴......","slug":"24-GPM-newm函数","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlb001a3ci77aad8iwr","content":"<p>上节看了go的入口函数，，，也就是你执行main函数前后所做的准备工作。</p>\n<p>继续深入学习。「newm」第一个M，到底是怎么来的？</p>\n<a id=\"more\"></a>\n<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h3 id=\"入口\"><a class=\"header-anchor\" href=\"#入口\">¶</a>入口</h3>\n<p>先看下主体，主要在M创建的过程中，干了what，，，，，「PS : 关键看值得学习的点」</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class=\"line\"><span class=\"comment\">// fn needs to be static and not a heap allocated closure.</span></span><br><span class=\"line\"><span class=\"comment\">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>, _<span class=\"title\">p_</span> *<span class=\"title\">p</span>)</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//分配内存</span></span><br><span class=\"line\">\tmp := allocm(_p_, fn)</span><br><span class=\"line\">  <span class=\"comment\">//设置p</span></span><br><span class=\"line\">\tmp.nextp.set(_p_)</span><br><span class=\"line\">  <span class=\"comment\">//初始化信号量</span></span><br><span class=\"line\">\tmp.sigmask = initSigmask</span><br><span class=\"line\">  <span class=\"comment\">//获取到gp后，判断M&amp;（系统锁定｜｜cgo执行中）；；；plan9的系统跳过下面操作....</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> gp := getg(); gp != <span class=\"literal\">nil</span> &amp;&amp; gp.m != <span class=\"literal\">nil</span> &amp;&amp; (gp.m.lockedExt != <span class=\"number\">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class=\"string\">&quot;plan9&quot;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// started by C. The kernel state of this thread may</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// be strange (the user may have locked it for that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// thread. Instead, ask a known-good thread to create</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the thread for us.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// doesn&#x27;t model thread creation off fork.</span></span><br><span class=\"line\">\t\tlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.haveTemplateThread == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tmp.schedlink = newmHandoff.newm</span><br><span class=\"line\">\t\tnewmHandoff.newm.set(mp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.waiting &#123;</span><br><span class=\"line\">\t\t\tnewmHandoff.waiting = <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t\tnotewakeup(&amp;newmHandoff.wake)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  <span class=\"comment\">//new m1指第一个M的创建过程.</span></span><br><span class=\"line\">\tnewm1(mp)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"newm1\"><a class=\"header-anchor\" href=\"#newm1\">¶</a>newm1</h3>\n<blockquote>\n<p>go to 「newm1」</p>\n</blockquote>\n<p>看起来很简短</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm1</span><span class=\"params\">(mp *m)</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//cgo程序执行中?</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> iscgo &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> ts cgothreadstart</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> _cgo_thread_start == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tts.g.set(mp.g0)</span><br><span class=\"line\">\t\tts.tls = (*<span class=\"keyword\">uint64</span>)(unsafe.Pointer(&amp;mp.tls[<span class=\"number\">0</span>]))</span><br><span class=\"line\">\t\tts.fn = unsafe.Pointer(funcPC(mstart))</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> msanenabled &#123;</span><br><span class=\"line\">\t\t\tmsanwrite(unsafe.Pointer(&amp;ts), unsafe.Sizeof(ts))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\texecLock.rlock() <span class=\"comment\">// Prevent process clone.</span></span><br><span class=\"line\">\t\tasmcgocall(_cgo_thread_start, unsafe.Pointer(&amp;ts))</span><br><span class=\"line\">\t\texecLock.runlock()</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">\texecLock.rlock() <span class=\"comment\">// Prevent process clone.</span></span><br><span class=\"line\">  <span class=\"comment\">//涉及到系统进程创建</span></span><br><span class=\"line\">\tnewosproc(mp)</span><br><span class=\"line\">\texecLock.runlock()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"newosproc\"><a class=\"header-anchor\" href=\"#newosproc\">¶</a>newosproc</h3>\n<blockquote>\n<p>M创建之前，系统的操作和相关地址的变化</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newosproc</span><span class=\"params\">(mp *m)</span></span> &#123;</span><br><span class=\"line\"><span class=\"comment\">//这个stk操作很奇怪，有兴趣的可以研究下....[看起来啥也没干那]</span></span><br><span class=\"line\">\tstk := unsafe.Pointer(mp.g0.stack.hi)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"literal\">false</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;newosproc stk=&quot;</span>, stk, <span class=\"string\">&quot; m=&quot;</span>, mp, <span class=\"string\">&quot; g=&quot;</span>, mp.g0, <span class=\"string\">&quot; id=&quot;</span>, mp.id, <span class=\"string\">&quot; ostk=&quot;</span>, &amp;mp, <span class=\"string\">&quot;\\n&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Initialize an attribute object.</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> attr pthreadattr</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> err <span class=\"keyword\">int32</span></span><br><span class=\"line\">  <span class=\"comment\">//汇编，变量初始化</span></span><br><span class=\"line\">\terr = pthread_attr_init(&amp;attr)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Find out OS stack size for our own stack guard.</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> stacksize <span class=\"keyword\">uintptr</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> pthread_attr_getstacksize(&amp;attr, &amp;stacksize) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  <span class=\"comment\">//M对应的g0的高位空间栈地址</span></span><br><span class=\"line\">\tmp.g0.stack.hi = stacksize <span class=\"comment\">// for mstart</span></span><br><span class=\"line\">\t<span class=\"comment\">//mSysStatInc(&amp;memstats.stacks_sys, stacksize) //<span class=\"doctag\">TODO:</span> do this?</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Tell the pthread library we won&#x27;t join with this thread.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> pthread_attr_setdetachstate(&amp;attr, _PTHREAD_CREATE_DETACHED) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Finally, create the thread. It starts at mstart_stub, which does some low-level</span></span><br><span class=\"line\">\t<span class=\"comment\">// setup and then calls mstart.</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> oset sigset</span><br><span class=\"line\">  <span class=\"comment\">//所有的mask初始化</span></span><br><span class=\"line\">\tsigprocmask(_SIG_SETMASK, &amp;sigset_all, &amp;oset)</span><br><span class=\"line\">\terr = pthread_create(&amp;attr, funcPC(mstart_stub), unsafe.Pointer(mp))</span><br><span class=\"line\">  <span class=\"comment\">// oset地址置nil</span></span><br><span class=\"line\">\tsigprocmask(_SIG_SETMASK, &amp;oset, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"pthread-attr-init细节\"><a class=\"header-anchor\" href=\"#pthread-attr-init细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L402\">pthread_attr_init细节</a></h4>\n<blockquote>\n<p>汇编代码：</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TEXT runtime·pthread_attr_init_trampoline(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">0</span>(R0), R0\t<span class=\"comment\">// arg 1 attr</span></span><br><span class=\"line\">\tBL\tlibc_pthread_attr_init(SB)</span><br><span class=\"line\">\tRET</span><br></pre></td></tr></table></figure>\n<h4 id=\"pthread-attr-getstacksize细节\"><a class=\"header-anchor\" href=\"#pthread-attr-getstacksize细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L407\">pthread_attr_getstacksize细节</a></h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TEXT runtime·pthread_attr_getstacksize_trampoline(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">8</span>(R0), R1\t<span class=\"comment\">// arg 2 size</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">0</span>(R0), R0\t<span class=\"comment\">// arg 1 attr</span></span><br><span class=\"line\">\tBL\tlibc_pthread_attr_getstacksize(SB)</span><br><span class=\"line\">\tRET</span><br></pre></td></tr></table></figure>\n<h4 id=\"sigprocmask-trampoline细节\"><a class=\"header-anchor\" href=\"#sigprocmask-trampoline细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L266\">sigprocmask_trampoline细节</a></h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TEXT runtime·sigprocmask_trampoline(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">8</span>(R0), R1\t<span class=\"comment\">// arg 2 new</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">16</span>(R0), R2\t<span class=\"comment\">// arg 3 old</span></span><br><span class=\"line\">\tMOVW\t<span class=\"number\">0</span>(R0), R0\t<span class=\"comment\">// arg 1 how</span></span><br><span class=\"line\">\tBL\tlibc_pthread_sigmask(SB)</span><br><span class=\"line\">\tCMP\t$<span class=\"number\">0</span>, R0</span><br><span class=\"line\">\tBEQ\t<span class=\"number\">2</span>(PC)</span><br><span class=\"line\">\tBL\tnotok&lt;&gt;(SB)</span><br><span class=\"line\">\tRET</span><br></pre></td></tr></table></figure>\n<h4 id=\"pthread-create细节\"><a class=\"header-anchor\" href=\"#pthread-create细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L342\">pthread_create细节</a></h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mstart_stub is the first function executed on a new thread started by pthread_create.</span></span><br><span class=\"line\"><span class=\"comment\">// It just does some low-level setup and then calls mstart.</span></span><br><span class=\"line\"><span class=\"comment\">// Note: called with the C calling convention.</span></span><br><span class=\"line\">TEXT runtime·mstart_stub(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"comment\">// DI points to the m.</span></span><br><span class=\"line\">\t<span class=\"comment\">// We are already on m&#x27;s g0 stack.</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Save callee-save registers.</span></span><br><span class=\"line\">\tSUBQ\t$<span class=\"number\">40</span>, SP</span><br><span class=\"line\">\tMOVQ\tBX, <span class=\"number\">0</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR12, <span class=\"number\">8</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR13, <span class=\"number\">16</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR14, <span class=\"number\">24</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR15, <span class=\"number\">32</span>(SP)</span><br><span class=\"line\"></span><br><span class=\"line\">\tMOVQ\tm_g0(DI), DX <span class=\"comment\">// g</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Initialize TLS entry.</span></span><br><span class=\"line\">\t<span class=\"comment\">// See cmd/link/internal/ld/sym.go:computeTLSOffset.</span></span><br><span class=\"line\">\tMOVQ\tDX, <span class=\"number\">0x30</span>(GS)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Someday the convention will be D is always cleared.</span></span><br><span class=\"line\">\tCLD</span><br><span class=\"line\"></span><br><span class=\"line\">\tCALL\truntime·mstart(SB)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Restore callee-save registers.</span></span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">0</span>(SP), BX</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">8</span>(SP), R12</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">16</span>(SP), R13</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">24</span>(SP), R14</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">32</span>(SP), R15</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Go is all done with this OS thread.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Tell pthread everything is ok (we never join with this thread, so</span></span><br><span class=\"line\">\t<span class=\"comment\">// the value here doesn&#x27;t really matter).</span></span><br><span class=\"line\">\tXORL\tAX, AX</span><br><span class=\"line\"></span><br><span class=\"line\">\tADDQ\t$<span class=\"number\">40</span>, SP</span><br><span class=\"line\">\tRET</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"execLock-rlock\"><a class=\"header-anchor\" href=\"#execLock-rlock\">¶</a>execLock.rlock()</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// rlock locks rw for reading.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *rwmutex)</span> <span class=\"title\">rlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// The reader must not be allowed to lose its P or else other</span></span><br><span class=\"line\">\t<span class=\"comment\">// things blocking on the lock may consume all of the Ps and</span></span><br><span class=\"line\">\t<span class=\"comment\">// deadlock (issue #20903). Alternatively, we could drop the P</span></span><br><span class=\"line\">\t<span class=\"comment\">// while sleeping.</span></span><br><span class=\"line\">\tacquirem()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"keyword\">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class=\"number\">1</span>)) &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// A writer is pending. Park on the reader queue.</span></span><br><span class=\"line\">\t\tsystemstack(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t\tlockWithRank(&amp;rw.rLock, lockRankRwmutexR)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> rw.readerPass &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Writer finished.</span></span><br><span class=\"line\">\t\t\t\trw.readerPass -= <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tunlock(&amp;rw.rLock)</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Queue this reader to be woken by</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// the writer.</span></span><br><span class=\"line\">\t\t\t\tm := getg().m</span><br><span class=\"line\">\t\t\t\tm.schedlink = rw.readers</span><br><span class=\"line\">\t\t\t\trw.readers.set(m)</span><br><span class=\"line\">\t\t\t\tunlock(&amp;rw.rLock)</span><br><span class=\"line\">\t\t\t\tnotesleep(&amp;m.park)</span><br><span class=\"line\">\t\t\t\tnoteclear(&amp;m.park)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"acquirem\"><a class=\"header-anchor\" href=\"#acquirem\">¶</a>acquirem()</h4>\n<blockquote>\n<p>加锁获取M</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//go:nosplit</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">acquirem</span><span class=\"params\">()</span> *<span class=\"title\">m</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\">\t_g_.m.locks++</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> _g_.m</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"notesleep\"><a class=\"header-anchor\" href=\"#notesleep\">¶</a>notesleep()</h4>\n<blockquote>\n<p>比较有趣的是sleep是用队列实现,前后加锁</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">notesleep</span><span class=\"params\">(n *note)</span></span> &#123;</span><br><span class=\"line\">\tgp := getg()</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t<span class=\"comment\">// Queued. Sleep.</span></span><br><span class=\"line\">\tgp.m.blocked = <span class=\"literal\">true</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> *cgo_yield == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tsemasleep(<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">const</span> ns = <span class=\"number\">10e6</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> atomic.Loaduintptr(&amp;n.key) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tsemasleep(ns)</span><br><span class=\"line\">\t\t\tasmcgocall(*cgo_yield, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tgp.m.blocked = <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"execLock-runlock\"><a class=\"header-anchor\" href=\"#execLock-runlock\">¶</a>execLock.runlock()</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// runlock undoes a single rlock call on rw.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *rwmutex)</span> <span class=\"title\">runlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r := <span class=\"keyword\">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class=\"number\">-1</span>)); r &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t....</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treleasem(getg().m)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"releasem\"><a class=\"header-anchor\" href=\"#releasem\">¶</a>releasem</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//go:nosplit</span></span><br><span class=\"line\"><span class=\"comment\">//lock数量➖1，恢复到preempt的状态.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">releasem</span><span class=\"params\">(mp *m)</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\">\tmp.locks--</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> mp.locks == <span class=\"number\">0</span> &amp;&amp; _g_.preempt &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// restore the preemption request in case we&#x27;ve cleared it in newstack</span></span><br><span class=\"line\">\t\t_g_.stackguard0 = stackPreempt</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>先分析到这儿吧…关于这一节的流程图，会整理出来的，，，，</p>\n<p>不然就白分析这么多了，及时学习，及时总结。</p>\n<p>晚安😴…</p>\n","site":{"data":{}},"excerpt":"<p>上节看了go的入口函数，，，也就是你执行main函数前后所做的准备工作。</p>\n<p>继续深入学习。「newm」第一个M，到底是怎么来的？</p>","more":"<blockquote>\n<p>go version: 1.14.3</p>\n</blockquote>\n<h3 id=\"入口\"><a class=\"header-anchor\" href=\"#入口\">¶</a>入口</h3>\n<p>先看下主体，主要在M创建的过程中，干了what，，，，，「PS : 关键看值得学习的点」</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Create a new m. It will start off with a call to fn, or else the scheduler.</span></span><br><span class=\"line\"><span class=\"comment\">// fn needs to be static and not a heap allocated closure.</span></span><br><span class=\"line\"><span class=\"comment\">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm</span><span class=\"params\">(fn <span class=\"keyword\">func</span>()</span>, _<span class=\"title\">p_</span> *<span class=\"title\">p</span>)</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//分配内存</span></span><br><span class=\"line\">\tmp := allocm(_p_, fn)</span><br><span class=\"line\">  <span class=\"comment\">//设置p</span></span><br><span class=\"line\">\tmp.nextp.set(_p_)</span><br><span class=\"line\">  <span class=\"comment\">//初始化信号量</span></span><br><span class=\"line\">\tmp.sigmask = initSigmask</span><br><span class=\"line\">  <span class=\"comment\">//获取到gp后，判断M&amp;（系统锁定｜｜cgo执行中）；；；plan9的系统跳过下面操作....</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> gp := getg(); gp != <span class=\"literal\">nil</span> &amp;&amp; gp.m != <span class=\"literal\">nil</span> &amp;&amp; (gp.m.lockedExt != <span class=\"number\">0</span> || gp.m.incgo) &amp;&amp; GOOS != <span class=\"string\">&quot;plan9&quot;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// We&#x27;re on a locked M or a thread that may have been</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// started by C. The kernel state of this thread may</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// be strange (the user may have locked it for that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// purpose). We don&#x27;t want to clone that into another</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// thread. Instead, ask a known-good thread to create</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the thread for us.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// This is disabled on Plan 9. See golang.org/issue/22227.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// <span class=\"doctag\">TODO:</span> This may be unnecessary on Windows, which</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// doesn&#x27;t model thread creation off fork.</span></span><br><span class=\"line\">\t\tlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.haveTemplateThread == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;on a locked thread with no template thread&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tmp.schedlink = newmHandoff.newm</span><br><span class=\"line\">\t\tnewmHandoff.newm.set(mp)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> newmHandoff.waiting &#123;</span><br><span class=\"line\">\t\t\tnewmHandoff.waiting = <span class=\"literal\">false</span></span><br><span class=\"line\">\t\t\tnotewakeup(&amp;newmHandoff.wake)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;newmHandoff.lock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  <span class=\"comment\">//new m1指第一个M的创建过程.</span></span><br><span class=\"line\">\tnewm1(mp)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"newm1\"><a class=\"header-anchor\" href=\"#newm1\">¶</a>newm1</h3>\n<blockquote>\n<p>go to 「newm1」</p>\n</blockquote>\n<p>看起来很简短</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newm1</span><span class=\"params\">(mp *m)</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//cgo程序执行中?</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> iscgo &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> ts cgothreadstart</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> _cgo_thread_start == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;_cgo_thread_start missing&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tts.g.set(mp.g0)</span><br><span class=\"line\">\t\tts.tls = (*<span class=\"keyword\">uint64</span>)(unsafe.Pointer(&amp;mp.tls[<span class=\"number\">0</span>]))</span><br><span class=\"line\">\t\tts.fn = unsafe.Pointer(funcPC(mstart))</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> msanenabled &#123;</span><br><span class=\"line\">\t\t\tmsanwrite(unsafe.Pointer(&amp;ts), unsafe.Sizeof(ts))</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\texecLock.rlock() <span class=\"comment\">// Prevent process clone.</span></span><br><span class=\"line\">\t\tasmcgocall(_cgo_thread_start, unsafe.Pointer(&amp;ts))</span><br><span class=\"line\">\t\texecLock.runlock()</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">\texecLock.rlock() <span class=\"comment\">// Prevent process clone.</span></span><br><span class=\"line\">  <span class=\"comment\">//涉及到系统进程创建</span></span><br><span class=\"line\">\tnewosproc(mp)</span><br><span class=\"line\">\texecLock.runlock()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"newosproc\"><a class=\"header-anchor\" href=\"#newosproc\">¶</a>newosproc</h3>\n<blockquote>\n<p>M创建之前，系统的操作和相关地址的变化</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// May run with m.p==nil, so write barriers are not allowed.</span></span><br><span class=\"line\"><span class=\"comment\">//go:nowritebarrierrec</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newosproc</span><span class=\"params\">(mp *m)</span></span> &#123;</span><br><span class=\"line\"><span class=\"comment\">//这个stk操作很奇怪，有兴趣的可以研究下....[看起来啥也没干那]</span></span><br><span class=\"line\">\tstk := unsafe.Pointer(mp.g0.stack.hi)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"literal\">false</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;newosproc stk=&quot;</span>, stk, <span class=\"string\">&quot; m=&quot;</span>, mp, <span class=\"string\">&quot; g=&quot;</span>, mp.g0, <span class=\"string\">&quot; id=&quot;</span>, mp.id, <span class=\"string\">&quot; ostk=&quot;</span>, &amp;mp, <span class=\"string\">&quot;\\n&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Initialize an attribute object.</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> attr pthreadattr</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> err <span class=\"keyword\">int32</span></span><br><span class=\"line\">  <span class=\"comment\">//汇编，变量初始化</span></span><br><span class=\"line\">\terr = pthread_attr_init(&amp;attr)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Find out OS stack size for our own stack guard.</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> stacksize <span class=\"keyword\">uintptr</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> pthread_attr_getstacksize(&amp;attr, &amp;stacksize) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">  <span class=\"comment\">//M对应的g0的高位空间栈地址</span></span><br><span class=\"line\">\tmp.g0.stack.hi = stacksize <span class=\"comment\">// for mstart</span></span><br><span class=\"line\">\t<span class=\"comment\">//mSysStatInc(&amp;memstats.stacks_sys, stacksize) //<span class=\"doctag\">TODO:</span> do this?</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Tell the pthread library we won&#x27;t join with this thread.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> pthread_attr_setdetachstate(&amp;attr, _PTHREAD_CREATE_DETACHED) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Finally, create the thread. It starts at mstart_stub, which does some low-level</span></span><br><span class=\"line\">\t<span class=\"comment\">// setup and then calls mstart.</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> oset sigset</span><br><span class=\"line\">  <span class=\"comment\">//所有的mask初始化</span></span><br><span class=\"line\">\tsigprocmask(_SIG_SETMASK, &amp;sigset_all, &amp;oset)</span><br><span class=\"line\">\terr = pthread_create(&amp;attr, funcPC(mstart_stub), unsafe.Pointer(mp))</span><br><span class=\"line\">  <span class=\"comment\">// oset地址置nil</span></span><br><span class=\"line\">\tsigprocmask(_SIG_SETMASK, &amp;oset, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\twrite(<span class=\"number\">2</span>, unsafe.Pointer(&amp;failthreadcreate[<span class=\"number\">0</span>]), <span class=\"keyword\">int32</span>(<span class=\"built_in\">len</span>(failthreadcreate)))</span><br><span class=\"line\">\t\texit(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"pthread-attr-init细节\"><a class=\"header-anchor\" href=\"#pthread-attr-init细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L402\">pthread_attr_init细节</a></h4>\n<blockquote>\n<p>汇编代码：</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TEXT runtime·pthread_attr_init_trampoline(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">0</span>(R0), R0\t<span class=\"comment\">// arg 1 attr</span></span><br><span class=\"line\">\tBL\tlibc_pthread_attr_init(SB)</span><br><span class=\"line\">\tRET</span><br></pre></td></tr></table></figure>\n<h4 id=\"pthread-attr-getstacksize细节\"><a class=\"header-anchor\" href=\"#pthread-attr-getstacksize细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L407\">pthread_attr_getstacksize细节</a></h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TEXT runtime·pthread_attr_getstacksize_trampoline(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">8</span>(R0), R1\t<span class=\"comment\">// arg 2 size</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">0</span>(R0), R0\t<span class=\"comment\">// arg 1 attr</span></span><br><span class=\"line\">\tBL\tlibc_pthread_attr_getstacksize(SB)</span><br><span class=\"line\">\tRET</span><br></pre></td></tr></table></figure>\n<h4 id=\"sigprocmask-trampoline细节\"><a class=\"header-anchor\" href=\"#sigprocmask-trampoline细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L266\">sigprocmask_trampoline细节</a></h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TEXT runtime·sigprocmask_trampoline(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">8</span>(R0), R1\t<span class=\"comment\">// arg 2 new</span></span><br><span class=\"line\">\tMOVD\t<span class=\"number\">16</span>(R0), R2\t<span class=\"comment\">// arg 3 old</span></span><br><span class=\"line\">\tMOVW\t<span class=\"number\">0</span>(R0), R0\t<span class=\"comment\">// arg 1 how</span></span><br><span class=\"line\">\tBL\tlibc_pthread_sigmask(SB)</span><br><span class=\"line\">\tCMP\t$<span class=\"number\">0</span>, R0</span><br><span class=\"line\">\tBEQ\t<span class=\"number\">2</span>(PC)</span><br><span class=\"line\">\tBL\tnotok&lt;&gt;(SB)</span><br><span class=\"line\">\tRET</span><br></pre></td></tr></table></figure>\n<h4 id=\"pthread-create细节\"><a class=\"header-anchor\" href=\"#pthread-create细节\">¶</a><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/sys_darwin_arm64.s#L342\">pthread_create细节</a></h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mstart_stub is the first function executed on a new thread started by pthread_create.</span></span><br><span class=\"line\"><span class=\"comment\">// It just does some low-level setup and then calls mstart.</span></span><br><span class=\"line\"><span class=\"comment\">// Note: called with the C calling convention.</span></span><br><span class=\"line\">TEXT runtime·mstart_stub(SB),NOSPLIT,$<span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"comment\">// DI points to the m.</span></span><br><span class=\"line\">\t<span class=\"comment\">// We are already on m&#x27;s g0 stack.</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Save callee-save registers.</span></span><br><span class=\"line\">\tSUBQ\t$<span class=\"number\">40</span>, SP</span><br><span class=\"line\">\tMOVQ\tBX, <span class=\"number\">0</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR12, <span class=\"number\">8</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR13, <span class=\"number\">16</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR14, <span class=\"number\">24</span>(SP)</span><br><span class=\"line\">\tMOVQ\tR15, <span class=\"number\">32</span>(SP)</span><br><span class=\"line\"></span><br><span class=\"line\">\tMOVQ\tm_g0(DI), DX <span class=\"comment\">// g</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Initialize TLS entry.</span></span><br><span class=\"line\">\t<span class=\"comment\">// See cmd/link/internal/ld/sym.go:computeTLSOffset.</span></span><br><span class=\"line\">\tMOVQ\tDX, <span class=\"number\">0x30</span>(GS)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Someday the convention will be D is always cleared.</span></span><br><span class=\"line\">\tCLD</span><br><span class=\"line\"></span><br><span class=\"line\">\tCALL\truntime·mstart(SB)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Restore callee-save registers.</span></span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">0</span>(SP), BX</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">8</span>(SP), R12</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">16</span>(SP), R13</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">24</span>(SP), R14</span><br><span class=\"line\">\tMOVQ\t<span class=\"number\">32</span>(SP), R15</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Go is all done with this OS thread.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Tell pthread everything is ok (we never join with this thread, so</span></span><br><span class=\"line\">\t<span class=\"comment\">// the value here doesn&#x27;t really matter).</span></span><br><span class=\"line\">\tXORL\tAX, AX</span><br><span class=\"line\"></span><br><span class=\"line\">\tADDQ\t$<span class=\"number\">40</span>, SP</span><br><span class=\"line\">\tRET</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"execLock-rlock\"><a class=\"header-anchor\" href=\"#execLock-rlock\">¶</a>execLock.rlock()</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// rlock locks rw for reading.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *rwmutex)</span> <span class=\"title\">rlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// The reader must not be allowed to lose its P or else other</span></span><br><span class=\"line\">\t<span class=\"comment\">// things blocking on the lock may consume all of the Ps and</span></span><br><span class=\"line\">\t<span class=\"comment\">// deadlock (issue #20903). Alternatively, we could drop the P</span></span><br><span class=\"line\">\t<span class=\"comment\">// while sleeping.</span></span><br><span class=\"line\">\tacquirem()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"keyword\">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class=\"number\">1</span>)) &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// A writer is pending. Park on the reader queue.</span></span><br><span class=\"line\">\t\tsystemstack(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t\t\tlockWithRank(&amp;rw.rLock, lockRankRwmutexR)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> rw.readerPass &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Writer finished.</span></span><br><span class=\"line\">\t\t\t\trw.readerPass -= <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t\tunlock(&amp;rw.rLock)</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// Queue this reader to be woken by</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// the writer.</span></span><br><span class=\"line\">\t\t\t\tm := getg().m</span><br><span class=\"line\">\t\t\t\tm.schedlink = rw.readers</span><br><span class=\"line\">\t\t\t\trw.readers.set(m)</span><br><span class=\"line\">\t\t\t\tunlock(&amp;rw.rLock)</span><br><span class=\"line\">\t\t\t\tnotesleep(&amp;m.park)</span><br><span class=\"line\">\t\t\t\tnoteclear(&amp;m.park)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"acquirem\"><a class=\"header-anchor\" href=\"#acquirem\">¶</a>acquirem()</h4>\n<blockquote>\n<p>加锁获取M</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//go:nosplit</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">acquirem</span><span class=\"params\">()</span> *<span class=\"title\">m</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\">\t_g_.m.locks++</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> _g_.m</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"notesleep\"><a class=\"header-anchor\" href=\"#notesleep\">¶</a>notesleep()</h4>\n<blockquote>\n<p>比较有趣的是sleep是用队列实现,前后加锁</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">notesleep</span><span class=\"params\">(n *note)</span></span> &#123;</span><br><span class=\"line\">\tgp := getg()</span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t<span class=\"comment\">// Queued. Sleep.</span></span><br><span class=\"line\">\tgp.m.blocked = <span class=\"literal\">true</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> *cgo_yield == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tsemasleep(<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">const</span> ns = <span class=\"number\">10e6</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> atomic.Loaduintptr(&amp;n.key) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tsemasleep(ns)</span><br><span class=\"line\">\t\t\tasmcgocall(*cgo_yield, <span class=\"literal\">nil</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tgp.m.blocked = <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"execLock-runlock\"><a class=\"header-anchor\" href=\"#execLock-runlock\">¶</a>execLock.runlock()</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// runlock undoes a single rlock call on rw.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *rwmutex)</span> <span class=\"title\">runlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r := <span class=\"keyword\">int32</span>(atomic.Xadd(&amp;rw.readerCount, <span class=\"number\">-1</span>)); r &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t....</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treleasem(getg().m)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"releasem\"><a class=\"header-anchor\" href=\"#releasem\">¶</a>releasem</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//go:nosplit</span></span><br><span class=\"line\"><span class=\"comment\">//lock数量➖1，恢复到preempt的状态.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">releasem</span><span class=\"params\">(mp *m)</span></span> &#123;</span><br><span class=\"line\">\t_g_ := getg()</span><br><span class=\"line\">\tmp.locks--</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> mp.locks == <span class=\"number\">0</span> &amp;&amp; _g_.preempt &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// restore the preemption request in case we&#x27;ve cleared it in newstack</span></span><br><span class=\"line\">\t\t_g_.stackguard0 = stackPreempt</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>先分析到这儿吧…关于这一节的流程图，会整理出来的，，，，</p>\n<p>不然就白分析这么多了，及时学习，及时总结。</p>\n<p>晚安😴…</p>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Wed Nov 25 2020 20:00:17 GMT+0800 (中国标准时间)","title":"「24」GPM newm函数","path":"archives/b4edbd7.html","eyeCatchImage":null,"excerpt":"<p>上节看了go的入口函数，，，也就是你执行main函数前后所做的准备工作。</p>\n<p>继续深入学习。「newm」第一个M，到底是怎么来的？</p>","date":{"_isAMomentObject":true,"_i":"2020-11-25T12:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-11-25T12:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","GPM","Go源码"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":6641},{"title":"「25」GPM sysmon函数","date":"2020-12-06T12:00:17.000Z","updated":"2020-12-06T12:00:17.000Z","keywords":"GPM,Go,Go调度器,Go资源调度器","abbrlink":"c770fe49","_content":"\n\n前面主要是了解newm的全过程和其中难过一些细节逻辑，，，\n如果没了解的，建议先去看下大概的过程，虽然不是非常详细，\n最起码得知道newm过程，主要完成了什么操作，有利于后续理解。\n\n这次主要是来学学这个sysmon，系统监控调度的逻辑。\n<!--more-->\n### 前序\n\n在深入之前呢，先对下面这些变量有个概念，后续提到也就不陌生了。「摘抄自sysmon函数」\n\n```go\nvar (\n\tallglen    uintptr //g\n\tallm       *m      //m\n\tallp       []*p  // p     len(allp) == gomaxprocs; may change at safe points, otherwise immutable\n\tallpLock   mutex // 全局lock。   Protects P-less reads of allp and all writes\n\tgomaxprocs int32 //最大process数量\n\tncpu       int32 //cpu个数\n\tforcegc    forcegcstate //强制GC\n\tsched      schedt //预分配的一些变量值\n\tnewprocs   int32  //新的process\n\n\t// Information about what cpu features are available.\n\t// Packages outside the runtime should not use these\n\t// as they are not an external api.\n\t// Set on startup in asm_{386,amd64}.s\n\tprocessorVersionInfo uint32\n\tisIntel              bool\n\tlfenceBeforeRdtsc    bool\n\n\tgoarm                uint8 // set by cmd/link on arm systems\n\tframepointer_enabled bool  // set by cmd/link\n)\n\n```\n\n### sysmon函数\n\n#### 概览\n```go\n\nfunc sysmon() {\n\tlock(&sched.lock)//加锁\n\tsched.nmsys++ //数量+1\n\tcheckdead() //检查是否dead\n\tunlock(&sched.lock) //释放lock\n\n\tlasttrace := int64(0)\n\tidle := 0 // how many cycles in succession we had not wokeup somebody\n\tdelay := uint32(0)\n\tfor{\n\t\t......\n\t}\n}\n```\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-sysmon-1.png)\n\n\n\n### 循环干什么？\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201206_085755.png)\n\n\n>一个个过吧\n\n#### 获取系统的纳秒时间\n```go\nnow := nanotime()\n```\n\n#### timeSleepUntil\n\n```go\n// timeSleepUntil returns the time when the next timer should fire,\n// and the P that holds the timer heap that that timer is on.\n// This is only called by sysmon and checkdead.\nfunc timeSleepUntil() (int64, *p) {\n\tnext := int64(maxWhen)\n\tvar pret *p\n\n\t// Prevent allp slice changes. This is like retake.\n\tlock(&allpLock)\n\tfor _, pp := range allp {\n\t\tif pp == nil {\n\t\t\t// This can happen if procresize has grown\n\t\t\t// allp but not yet created new Ps.\n\t\t\tcontinue\n\t\t}\n\n\t\tc := atomic.Load(&pp.adjustTimers)\n\t\tif c == 0 {\n\t\t\tw := int64(atomic.Load64(&pp.timer0When))\n\t\t\t//划重点\n\t\t\tif w != 0 && w < next {\n\t\t\t\tnext = w\n\t\t\t\tpret = pp\n\t\t\t}\n\t\t\tcontinue\n\t\t}\n\n\t\tlock(&pp.timersLock)\n\t\tfor _, t := range pp.timers {\n\t\t\t//划重点\n\t\t\tswitch s := atomic.Load(&t.status); s {\n\t\t\tcase timerWaiting:\n\t\t\t\tif t.when < next {\n\t\t\t\t\tnext = t.when\n\t\t\t\t}\n\t\t\tcase timerModifiedEarlier, timerModifiedLater:\n\t\t\t\tif t.nextwhen < next {\n\t\t\t\t\tnext = t.nextwhen\n\t\t\t\t}\n\t\t\t\tif s == timerModifiedEarlier {\n\t\t\t\t\tc--\n\t\t\t\t}\n\t\t\t}\n\t\t\t// The timers are sorted, so we only have to check\n\t\t\t// the first timer for each P, unless there are\n\t\t\t// some timerModifiedEarlier timers. The number\n\t\t\t// of timerModifiedEarlier timers is in the adjustTimers\n\t\t\t// field, used to initialize c, above.\n\t\t\t//\n\t\t\t// We don't worry about cases like timerModifying.\n\t\t\t// New timers can show up at any time,\n\t\t\t// so this function is necessarily imprecise.\n\t\t\t// Do a signed check here since we aren't\n\t\t\t// synchronizing the read of pp.adjustTimers\n\t\t\t// with the check of a timer status.\n\t\t\tif int32(c) <= 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tunlock(&pp.timersLock)\n\t}\n\tunlock(&allpLock)\n\n\treturn next, pret\n}\n```\n\n#### sched和gomaxprocs判断「sleep&wakeup过程」\n```go\n//双层判断，防止在加锁这段时间值发生变化\nif debug.schedtrace <= 0 && (sched.gcwaiting != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs)) {\n\t\t\tlock(&sched.lock)\n\t\t\tif atomic.Load(&sched.gcwaiting) != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs) {\n\t\t\t\tif next > now {\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 1)\n\t\t\t\t\tunlock(&sched.lock)\n\t\t\t\t\t// Make wake-up period small enough\n\t\t\t\t\t// for the sampling to be correct.\n\t\t\t\t\tsleep := forcegcperiod / 2\n\t\t\t\t\tif next-now < sleep {\n\t\t\t\t\t\tsleep = next - now\n\t\t\t\t\t}\n\t\t\t\t\tshouldRelax := sleep >= osRelaxMinNS\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(true)\n\t\t\t\t\t}\n\t\t\t\t\tnotetsleep(&sched.sysmonnote, sleep)\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(false)\n\t\t\t\t\t}\n\t\t\t\t\tnow = nanotime()\n\t\t\t\t\tnext, _ = timeSleepUntil()\n\t\t\t\t\tlock(&sched.lock)\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 0)\n\t\t\t\t\tnoteclear(&sched.sysmonnote)\n\t\t\t\t}\n\t\t\t\tidle = 0\n\t\t\t\tdelay = 20\n\t\t\t}\n\t\t\tunlock(&sched.lock)\n\t\t}\n```\n\n#### poll network\n\n```go\n\t\t// poll network if not polled for more than 10ms\n\t\tlastpoll := int64(atomic.Load64(&sched.lastpoll))\n\t\tif netpollinited() && lastpoll != 0 && lastpoll+10*1000*1000 < now {\n\t\t\tatomic.Cas64(&sched.lastpoll, uint64(lastpoll), uint64(now))\n\t\t\tlist := netpoll(0) // non-blocking - returns list of goroutines\n\t\t\tif !list.empty() {\n\t\t\t\t// Need to decrement number of idle locked M's\n\t\t\t\t// (pretending that one more is running) before injectglist.\n\t\t\t\t// Otherwise it can lead to the following situation:\n\t\t\t\t// injectglist grabs all P's but before it starts M's to run the P's,\n\t\t\t\t// another M returns from syscall, finishes running its G,\n\t\t\t\t// observes that there is no work to do and no other running M's\n\t\t\t\t// and reports deadlock.\n\t\t\t\tincidlelocked(-1)\n\t\t\t\tinjectglist(&list)\n\t\t\t\tincidlelocked(1)\n\t\t\t}\n\t\t}\n\t\tif next < now {\n\t\t\t// There are timers that should have already run,\n\t\t\t// perhaps because there is an unpreemptible P.\n\t\t\t// Try to start an M to run them.\n\t\t\t//划重点\n\t\t\tstartm(nil, false)\n\t\t}\n```\n\n#### wakeScavenger\n\n>判断需要唤醒请求\n```go\n\t\tif atomic.Load(&scavenge.sysmonWake) != 0 {\n\t\t\t// Kick the scavenger awake if someone requested it.\n\t\t\twakeScavenger()\n\t\t}\n```\n\n```go\n// wakeScavenger immediately unparks the scavenger if necessary.\n//\n// May run without a P, but it may allocate, so it must not be called\n// on any allocation path.\n//\n// mheap_.lock, scavenge.lock, and sched.lock must not be held.\nfunc wakeScavenger() {\n\tlock(&scavenge.lock)\n\tif scavenge.parked {\n\t\t// Notify sysmon that it shouldn't bother waking up the scavenger.\n\t\tatomic.Store(&scavenge.sysmonWake, 0)\n\n\t\t// Try to stop the timer but we don't really care if we succeed.\n\t\t// It's possible that either a timer was never started, or that\n\t\t// we're racing with it.\n\t\t// In the case that we're racing with there's the low chance that\n\t\t// we experience a spurious wake-up of the scavenger, but that's\n\t\t// totally safe.\n\t\tstopTimer(scavenge.timer)\n\n\t\t// Unpark the goroutine and tell it that there may have been a pacing\n\t\t// change. Note that we skip the scheduler's runnext slot because we\n\t\t// want to avoid having the scavenger interfere with the fair\n\t\t// scheduling of user goroutines. In effect, this schedules the\n\t\t// scavenger at a \"lower priority\" but that's OK because it'll\n\t\t// catch up on the work it missed when it does get scheduled.\n\t\tscavenge.parked = false\n\n\t\t// Ready the goroutine by injecting it. We use injectglist instead\n\t\t// of ready or goready in order to allow us to run this function\n\t\t// without a P. injectglist also avoids placing the goroutine in\n\t\t// the current P's runnext slot, which is desireable to prevent\n\t\t// the scavenger from interfering with user goroutine scheduling\n\t\t// too much.\n\t\tvar list gList\n\t\tlist.push(scavenge.g)\n\t\tinjectglist(&list)\n\t}\n\tunlock(&scavenge.lock)\n}\n\n```\n\n#### retake夺取\n\n>夺取空闲的P\n```go\n\t\t// retake P's blocked in syscalls\n\t\t// and preempt long running G's\n\t\tif retake(now) != 0 {\n\t\t\tidle = 0\n\t\t} else {\n\t\t\tidle++\n\t\t}\n```\n\n#### GC 判断\n\n```go\n\t\t// check if we need to force a GC\n\t\t//划重点 t.test()\n\t\tif t := (gcTrigger{kind: gcTriggerTime, now: now}); t.test() && atomic.Load(&forcegc.idle) != 0 {\n\t\t\tlock(&forcegc.lock)\n\t\t\tforcegc.idle = 0\n\t\t\tvar list gList\n\t\t\tlist.push(forcegc.g)\n\t\t\tinjectglist(&list)\n\t\t\tunlock(&forcegc.lock)\n\t\t}\n```\n\n### 待续....\n\n","source":"_posts/25-GPM-sysmon函数.md","raw":"---\ntitle: 「25」GPM sysmon函数\ndate: '2020/12/06 20:00:17'\nupdated: '2020/12/06 20:00:17'\nkeywords: 'GPM,Go,Go调度器,Go资源调度器'\ntags:\n  - Go\n  - GPM\n  - Go源码\nabbrlink: c770fe49\n---\n\n\n前面主要是了解newm的全过程和其中难过一些细节逻辑，，，\n如果没了解的，建议先去看下大概的过程，虽然不是非常详细，\n最起码得知道newm过程，主要完成了什么操作，有利于后续理解。\n\n这次主要是来学学这个sysmon，系统监控调度的逻辑。\n<!--more-->\n### 前序\n\n在深入之前呢，先对下面这些变量有个概念，后续提到也就不陌生了。「摘抄自sysmon函数」\n\n```go\nvar (\n\tallglen    uintptr //g\n\tallm       *m      //m\n\tallp       []*p  // p     len(allp) == gomaxprocs; may change at safe points, otherwise immutable\n\tallpLock   mutex // 全局lock。   Protects P-less reads of allp and all writes\n\tgomaxprocs int32 //最大process数量\n\tncpu       int32 //cpu个数\n\tforcegc    forcegcstate //强制GC\n\tsched      schedt //预分配的一些变量值\n\tnewprocs   int32  //新的process\n\n\t// Information about what cpu features are available.\n\t// Packages outside the runtime should not use these\n\t// as they are not an external api.\n\t// Set on startup in asm_{386,amd64}.s\n\tprocessorVersionInfo uint32\n\tisIntel              bool\n\tlfenceBeforeRdtsc    bool\n\n\tgoarm                uint8 // set by cmd/link on arm systems\n\tframepointer_enabled bool  // set by cmd/link\n)\n\n```\n\n### sysmon函数\n\n#### 概览\n```go\n\nfunc sysmon() {\n\tlock(&sched.lock)//加锁\n\tsched.nmsys++ //数量+1\n\tcheckdead() //检查是否dead\n\tunlock(&sched.lock) //释放lock\n\n\tlasttrace := int64(0)\n\tidle := 0 // how many cycles in succession we had not wokeup somebody\n\tdelay := uint32(0)\n\tfor{\n\t\t......\n\t}\n}\n```\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-sysmon-1.png)\n\n\n\n### 循环干什么？\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201206_085755.png)\n\n\n>一个个过吧\n\n#### 获取系统的纳秒时间\n```go\nnow := nanotime()\n```\n\n#### timeSleepUntil\n\n```go\n// timeSleepUntil returns the time when the next timer should fire,\n// and the P that holds the timer heap that that timer is on.\n// This is only called by sysmon and checkdead.\nfunc timeSleepUntil() (int64, *p) {\n\tnext := int64(maxWhen)\n\tvar pret *p\n\n\t// Prevent allp slice changes. This is like retake.\n\tlock(&allpLock)\n\tfor _, pp := range allp {\n\t\tif pp == nil {\n\t\t\t// This can happen if procresize has grown\n\t\t\t// allp but not yet created new Ps.\n\t\t\tcontinue\n\t\t}\n\n\t\tc := atomic.Load(&pp.adjustTimers)\n\t\tif c == 0 {\n\t\t\tw := int64(atomic.Load64(&pp.timer0When))\n\t\t\t//划重点\n\t\t\tif w != 0 && w < next {\n\t\t\t\tnext = w\n\t\t\t\tpret = pp\n\t\t\t}\n\t\t\tcontinue\n\t\t}\n\n\t\tlock(&pp.timersLock)\n\t\tfor _, t := range pp.timers {\n\t\t\t//划重点\n\t\t\tswitch s := atomic.Load(&t.status); s {\n\t\t\tcase timerWaiting:\n\t\t\t\tif t.when < next {\n\t\t\t\t\tnext = t.when\n\t\t\t\t}\n\t\t\tcase timerModifiedEarlier, timerModifiedLater:\n\t\t\t\tif t.nextwhen < next {\n\t\t\t\t\tnext = t.nextwhen\n\t\t\t\t}\n\t\t\t\tif s == timerModifiedEarlier {\n\t\t\t\t\tc--\n\t\t\t\t}\n\t\t\t}\n\t\t\t// The timers are sorted, so we only have to check\n\t\t\t// the first timer for each P, unless there are\n\t\t\t// some timerModifiedEarlier timers. The number\n\t\t\t// of timerModifiedEarlier timers is in the adjustTimers\n\t\t\t// field, used to initialize c, above.\n\t\t\t//\n\t\t\t// We don't worry about cases like timerModifying.\n\t\t\t// New timers can show up at any time,\n\t\t\t// so this function is necessarily imprecise.\n\t\t\t// Do a signed check here since we aren't\n\t\t\t// synchronizing the read of pp.adjustTimers\n\t\t\t// with the check of a timer status.\n\t\t\tif int32(c) <= 0 {\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tunlock(&pp.timersLock)\n\t}\n\tunlock(&allpLock)\n\n\treturn next, pret\n}\n```\n\n#### sched和gomaxprocs判断「sleep&wakeup过程」\n```go\n//双层判断，防止在加锁这段时间值发生变化\nif debug.schedtrace <= 0 && (sched.gcwaiting != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs)) {\n\t\t\tlock(&sched.lock)\n\t\t\tif atomic.Load(&sched.gcwaiting) != 0 || atomic.Load(&sched.npidle) == uint32(gomaxprocs) {\n\t\t\t\tif next > now {\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 1)\n\t\t\t\t\tunlock(&sched.lock)\n\t\t\t\t\t// Make wake-up period small enough\n\t\t\t\t\t// for the sampling to be correct.\n\t\t\t\t\tsleep := forcegcperiod / 2\n\t\t\t\t\tif next-now < sleep {\n\t\t\t\t\t\tsleep = next - now\n\t\t\t\t\t}\n\t\t\t\t\tshouldRelax := sleep >= osRelaxMinNS\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(true)\n\t\t\t\t\t}\n\t\t\t\t\tnotetsleep(&sched.sysmonnote, sleep)\n\t\t\t\t\tif shouldRelax {\n\t\t\t\t\t\tosRelax(false)\n\t\t\t\t\t}\n\t\t\t\t\tnow = nanotime()\n\t\t\t\t\tnext, _ = timeSleepUntil()\n\t\t\t\t\tlock(&sched.lock)\n\t\t\t\t\tatomic.Store(&sched.sysmonwait, 0)\n\t\t\t\t\tnoteclear(&sched.sysmonnote)\n\t\t\t\t}\n\t\t\t\tidle = 0\n\t\t\t\tdelay = 20\n\t\t\t}\n\t\t\tunlock(&sched.lock)\n\t\t}\n```\n\n#### poll network\n\n```go\n\t\t// poll network if not polled for more than 10ms\n\t\tlastpoll := int64(atomic.Load64(&sched.lastpoll))\n\t\tif netpollinited() && lastpoll != 0 && lastpoll+10*1000*1000 < now {\n\t\t\tatomic.Cas64(&sched.lastpoll, uint64(lastpoll), uint64(now))\n\t\t\tlist := netpoll(0) // non-blocking - returns list of goroutines\n\t\t\tif !list.empty() {\n\t\t\t\t// Need to decrement number of idle locked M's\n\t\t\t\t// (pretending that one more is running) before injectglist.\n\t\t\t\t// Otherwise it can lead to the following situation:\n\t\t\t\t// injectglist grabs all P's but before it starts M's to run the P's,\n\t\t\t\t// another M returns from syscall, finishes running its G,\n\t\t\t\t// observes that there is no work to do and no other running M's\n\t\t\t\t// and reports deadlock.\n\t\t\t\tincidlelocked(-1)\n\t\t\t\tinjectglist(&list)\n\t\t\t\tincidlelocked(1)\n\t\t\t}\n\t\t}\n\t\tif next < now {\n\t\t\t// There are timers that should have already run,\n\t\t\t// perhaps because there is an unpreemptible P.\n\t\t\t// Try to start an M to run them.\n\t\t\t//划重点\n\t\t\tstartm(nil, false)\n\t\t}\n```\n\n#### wakeScavenger\n\n>判断需要唤醒请求\n```go\n\t\tif atomic.Load(&scavenge.sysmonWake) != 0 {\n\t\t\t// Kick the scavenger awake if someone requested it.\n\t\t\twakeScavenger()\n\t\t}\n```\n\n```go\n// wakeScavenger immediately unparks the scavenger if necessary.\n//\n// May run without a P, but it may allocate, so it must not be called\n// on any allocation path.\n//\n// mheap_.lock, scavenge.lock, and sched.lock must not be held.\nfunc wakeScavenger() {\n\tlock(&scavenge.lock)\n\tif scavenge.parked {\n\t\t// Notify sysmon that it shouldn't bother waking up the scavenger.\n\t\tatomic.Store(&scavenge.sysmonWake, 0)\n\n\t\t// Try to stop the timer but we don't really care if we succeed.\n\t\t// It's possible that either a timer was never started, or that\n\t\t// we're racing with it.\n\t\t// In the case that we're racing with there's the low chance that\n\t\t// we experience a spurious wake-up of the scavenger, but that's\n\t\t// totally safe.\n\t\tstopTimer(scavenge.timer)\n\n\t\t// Unpark the goroutine and tell it that there may have been a pacing\n\t\t// change. Note that we skip the scheduler's runnext slot because we\n\t\t// want to avoid having the scavenger interfere with the fair\n\t\t// scheduling of user goroutines. In effect, this schedules the\n\t\t// scavenger at a \"lower priority\" but that's OK because it'll\n\t\t// catch up on the work it missed when it does get scheduled.\n\t\tscavenge.parked = false\n\n\t\t// Ready the goroutine by injecting it. We use injectglist instead\n\t\t// of ready or goready in order to allow us to run this function\n\t\t// without a P. injectglist also avoids placing the goroutine in\n\t\t// the current P's runnext slot, which is desireable to prevent\n\t\t// the scavenger from interfering with user goroutine scheduling\n\t\t// too much.\n\t\tvar list gList\n\t\tlist.push(scavenge.g)\n\t\tinjectglist(&list)\n\t}\n\tunlock(&scavenge.lock)\n}\n\n```\n\n#### retake夺取\n\n>夺取空闲的P\n```go\n\t\t// retake P's blocked in syscalls\n\t\t// and preempt long running G's\n\t\tif retake(now) != 0 {\n\t\t\tidle = 0\n\t\t} else {\n\t\t\tidle++\n\t\t}\n```\n\n#### GC 判断\n\n```go\n\t\t// check if we need to force a GC\n\t\t//划重点 t.test()\n\t\tif t := (gcTrigger{kind: gcTriggerTime, now: now}); t.test() && atomic.Load(&forcegc.idle) != 0 {\n\t\t\tlock(&forcegc.lock)\n\t\t\tforcegc.idle = 0\n\t\t\tvar list gList\n\t\t\tlist.push(forcegc.g)\n\t\t\tinjectglist(&list)\n\t\t\tunlock(&forcegc.lock)\n\t\t}\n```\n\n### 待续....\n\n","slug":"25-GPM-sysmon函数","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlb001c3ci7hmct5nd8","content":"<p>前面主要是了解newm的全过程和其中难过一些细节逻辑，，，<br>\n如果没了解的，建议先去看下大概的过程，虽然不是非常详细，<br>\n最起码得知道newm过程，主要完成了什么操作，有利于后续理解。</p>\n<p>这次主要是来学学这个sysmon，系统监控调度的逻辑。</p>\n<a id=\"more\"></a>\n<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>在深入之前呢，先对下面这些变量有个概念，后续提到也就不陌生了。「摘抄自sysmon函数」</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> (</span><br><span class=\"line\">\tallglen    <span class=\"keyword\">uintptr</span> <span class=\"comment\">//g</span></span><br><span class=\"line\">\tallm       *m      <span class=\"comment\">//m</span></span><br><span class=\"line\">\tallp       []*p  <span class=\"comment\">// p     len(allp) == gomaxprocs; may change at safe points, otherwise immutable</span></span><br><span class=\"line\">\tallpLock   mutex <span class=\"comment\">// 全局lock。   Protects P-less reads of allp and all writes</span></span><br><span class=\"line\">\tgomaxprocs <span class=\"keyword\">int32</span> <span class=\"comment\">//最大process数量</span></span><br><span class=\"line\">\tncpu       <span class=\"keyword\">int32</span> <span class=\"comment\">//cpu个数</span></span><br><span class=\"line\">\tforcegc    forcegcstate <span class=\"comment\">//强制GC</span></span><br><span class=\"line\">\tsched      schedt <span class=\"comment\">//预分配的一些变量值</span></span><br><span class=\"line\">\tnewprocs   <span class=\"keyword\">int32</span>  <span class=\"comment\">//新的process</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Information about what cpu features are available.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Packages outside the runtime should not use these</span></span><br><span class=\"line\">\t<span class=\"comment\">// as they are not an external api.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Set on startup in asm_&#123;386,amd64&#125;.s</span></span><br><span class=\"line\">\tprocessorVersionInfo <span class=\"keyword\">uint32</span></span><br><span class=\"line\">\tisIntel              <span class=\"keyword\">bool</span></span><br><span class=\"line\">\tlfenceBeforeRdtsc    <span class=\"keyword\">bool</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tgoarm                <span class=\"keyword\">uint8</span> <span class=\"comment\">// set by cmd/link on arm systems</span></span><br><span class=\"line\">\tframepointer_enabled <span class=\"keyword\">bool</span>  <span class=\"comment\">// set by cmd/link</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"sysmon函数\"><a class=\"header-anchor\" href=\"#sysmon函数\">¶</a>sysmon函数</h3>\n<h4 id=\"概览\"><a class=\"header-anchor\" href=\"#概览\">¶</a>概览</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">sysmon</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlock(&amp;sched.lock)<span class=\"comment\">//加锁</span></span><br><span class=\"line\">\tsched.nmsys++ <span class=\"comment\">//数量+1</span></span><br><span class=\"line\">\tcheckdead() <span class=\"comment\">//检查是否dead</span></span><br><span class=\"line\">\tunlock(&amp;sched.lock) <span class=\"comment\">//释放lock</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tlasttrace := <span class=\"keyword\">int64</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tidle := <span class=\"number\">0</span> <span class=\"comment\">// how many cycles in succession we had not wokeup somebody</span></span><br><span class=\"line\">\tdelay := <span class=\"keyword\">uint32</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>&#123;</span><br><span class=\"line\">\t\t......</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-sysmon-1.png\" alt=\"\"></p>\n<h3 id=\"循环干什么？\"><a class=\"header-anchor\" href=\"#循环干什么？\">¶</a>循环干什么？</h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201206_085755.png\" alt=\"\"></p>\n<blockquote>\n<p>一个个过吧</p>\n</blockquote>\n<h4 id=\"获取系统的纳秒时间\"><a class=\"header-anchor\" href=\"#获取系统的纳秒时间\">¶</a>获取系统的纳秒时间</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">now := nanotime()</span><br></pre></td></tr></table></figure>\n<h4 id=\"timeSleepUntil\"><a class=\"header-anchor\" href=\"#timeSleepUntil\">¶</a>timeSleepUntil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timeSleepUntil returns the time when the next timer should fire,</span></span><br><span class=\"line\"><span class=\"comment\">// and the P that holds the timer heap that that timer is on.</span></span><br><span class=\"line\"><span class=\"comment\">// This is only called by sysmon and checkdead.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">timeSleepUntil</span><span class=\"params\">()</span> <span class=\"params\">(<span class=\"keyword\">int64</span>, *p)</span></span> &#123;</span><br><span class=\"line\">\tnext := <span class=\"keyword\">int64</span>(maxWhen)</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> pret *p</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Prevent allp slice changes. This is like retake.</span></span><br><span class=\"line\">\tlock(&amp;allpLock)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, pp := <span class=\"keyword\">range</span> allp &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> pp == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// This can happen if procresize has grown</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// allp but not yet created new Ps.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tc := atomic.Load(&amp;pp.adjustTimers)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> c == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tw := <span class=\"keyword\">int64</span>(atomic.Load64(&amp;pp.timer0When))</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//划重点</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> w != <span class=\"number\">0</span> &amp;&amp; w &lt; next &#123;</span><br><span class=\"line\">\t\t\t\tnext = w</span><br><span class=\"line\">\t\t\t\tpret = pp</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tlock(&amp;pp.timersLock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> _, t := <span class=\"keyword\">range</span> pp.timers &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//划重点</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span> s := atomic.Load(&amp;t.status); s &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> timerWaiting:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> t.when &lt; next &#123;</span><br><span class=\"line\">\t\t\t\t\tnext = t.when</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> timerModifiedEarlier, timerModifiedLater:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> t.nextwhen &lt; next &#123;</span><br><span class=\"line\">\t\t\t\t\tnext = t.nextwhen</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> s == timerModifiedEarlier &#123;</span><br><span class=\"line\">\t\t\t\t\tc--</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// The timers are sorted, so we only have to check</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// the first timer for each P, unless there are</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// some timerModifiedEarlier timers. The number</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// of timerModifiedEarlier timers is in the adjustTimers</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// field, used to initialize c, above.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// We don&#x27;t worry about cases like timerModifying.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// New timers can show up at any time,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// so this function is necessarily imprecise.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Do a signed check here since we aren&#x27;t</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// synchronizing the read of pp.adjustTimers</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// with the check of a timer status.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"keyword\">int32</span>(c) &lt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;pp.timersLock)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tunlock(&amp;allpLock)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> next, pret</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"sched和gomaxprocs判断「sleep-wakeup过程」\"><a class=\"header-anchor\" href=\"#sched和gomaxprocs判断「sleep-wakeup过程」\">¶</a>sched和gomaxprocs判断「sleep&amp;wakeup过程」</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//双层判断，防止在加锁这段时间值发生变化</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> debug.schedtrace &lt;= <span class=\"number\">0</span> &amp;&amp; (sched.gcwaiting != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs)) &#123;</span><br><span class=\"line\">\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> next &gt; now &#123;</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Make wake-up period small enough</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// for the sampling to be correct.</span></span><br><span class=\"line\">\t\t\t\t\tsleep := forcegcperiod / <span class=\"number\">2</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> next-now &lt; sleep &#123;</span><br><span class=\"line\">\t\t\t\t\t\tsleep = next - now</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tshouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">true</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnotetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">false</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnow = nanotime()</span><br><span class=\"line\">\t\t\t\t\tnext, _ = timeSleepUntil()</span><br><span class=\"line\">\t\t\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t\t\tnoteclear(&amp;sched.sysmonnote)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\tdelay = <span class=\"number\">20</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"poll-network\"><a class=\"header-anchor\" href=\"#poll-network\">¶</a>poll network</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// poll network if not polled for more than 10ms</span></span><br><span class=\"line\">lastpoll := <span class=\"keyword\">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class=\"line\"><span class=\"keyword\">if</span> netpollinited() &amp;&amp; lastpoll != <span class=\"number\">0</span> &amp;&amp; lastpoll+<span class=\"number\">10</span>*<span class=\"number\">1000</span>*<span class=\"number\">1000</span> &lt; now &#123;</span><br><span class=\"line\">\tatomic.Cas64(&amp;sched.lastpoll, <span class=\"keyword\">uint64</span>(lastpoll), <span class=\"keyword\">uint64</span>(now))</span><br><span class=\"line\">\tlist := netpoll(<span class=\"number\">0</span>) <span class=\"comment\">// non-blocking - returns list of goroutines</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !list.empty() &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// (pretending that one more is running) before injectglist.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// Otherwise it can lead to the following situation:</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// another M returns from syscall, finishes running its G,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// and reports deadlock.</span></span><br><span class=\"line\">\t\tincidlelocked(<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t\tincidlelocked(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> next &lt; now &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// There are timers that should have already run,</span></span><br><span class=\"line\">\t<span class=\"comment\">// perhaps because there is an unpreemptible P.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Try to start an M to run them.</span></span><br><span class=\"line\">\t<span class=\"comment\">//划重点</span></span><br><span class=\"line\">\tstartm(<span class=\"literal\">nil</span>, <span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"wakeScavenger\"><a class=\"header-anchor\" href=\"#wakeScavenger\">¶</a>wakeScavenger</h4>\n<blockquote>\n<p>判断需要唤醒请求</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Kick the scavenger awake if someone requested it.</span></span><br><span class=\"line\">\twakeScavenger()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// wakeScavenger immediately unparks the scavenger if necessary.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// May run without a P, but it may allocate, so it must not be called</span></span><br><span class=\"line\"><span class=\"comment\">// on any allocation path.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// mheap_.lock, scavenge.lock, and sched.lock must not be held.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">wakeScavenger</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlock(&amp;scavenge.lock)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> scavenge.parked &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Notify sysmon that it shouldn&#x27;t bother waking up the scavenger.</span></span><br><span class=\"line\">\t\tatomic.Store(&amp;scavenge.sysmonWake, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Try to stop the timer but we don&#x27;t really care if we succeed.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// It&#x27;s possible that either a timer was never started, or that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// we&#x27;re racing with it.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// In the case that we&#x27;re racing with there&#x27;s the low chance that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// we experience a spurious wake-up of the scavenger, but that&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// totally safe.</span></span><br><span class=\"line\">\t\tstopTimer(scavenge.timer)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Unpark the goroutine and tell it that there may have been a pacing</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// change. Note that we skip the scheduler&#x27;s runnext slot because we</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// want to avoid having the scavenger interfere with the fair</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// scheduling of user goroutines. In effect, this schedules the</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// scavenger at a &quot;lower priority&quot; but that&#x27;s OK because it&#x27;ll</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// catch up on the work it missed when it does get scheduled.</span></span><br><span class=\"line\">\t\tscavenge.parked = <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Ready the goroutine by injecting it. We use injectglist instead</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// of ready or goready in order to allow us to run this function</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// without a P. injectglist also avoids placing the goroutine in</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the current P&#x27;s runnext slot, which is desireable to prevent</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the scavenger from interfering with user goroutine scheduling</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// too much.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> list gList</span><br><span class=\"line\">\t\tlist.push(scavenge.g)</span><br><span class=\"line\">\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tunlock(&amp;scavenge.lock)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"retake夺取\"><a class=\"header-anchor\" href=\"#retake夺取\">¶</a>retake夺取</h4>\n<blockquote>\n<p>夺取空闲的P</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// retake P&#x27;s blocked in syscalls</span></span><br><span class=\"line\"><span class=\"comment\">// and preempt long running G&#x27;s</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> retake(now) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\tidle++</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"GC-判断\"><a class=\"header-anchor\" href=\"#GC-判断\">¶</a>GC 判断</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// check if we need to force a GC</span></span><br><span class=\"line\"><span class=\"comment\">//划重点 t.test()</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\tlock(&amp;forcegc.lock)</span><br><span class=\"line\">\tforcegc.idle = <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> list gList</span><br><span class=\"line\">\tlist.push(forcegc.g)</span><br><span class=\"line\">\tinjectglist(&amp;list)</span><br><span class=\"line\">\tunlock(&amp;forcegc.lock)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"待续…\"><a class=\"header-anchor\" href=\"#待续…\">¶</a>待续…</h3>\n","site":{"data":{}},"excerpt":"<p>前面主要是了解newm的全过程和其中难过一些细节逻辑，，，<br>\n如果没了解的，建议先去看下大概的过程，虽然不是非常详细，<br>\n最起码得知道newm过程，主要完成了什么操作，有利于后续理解。</p>\n<p>这次主要是来学学这个sysmon，系统监控调度的逻辑。</p>","more":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>在深入之前呢，先对下面这些变量有个概念，后续提到也就不陌生了。「摘抄自sysmon函数」</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> (</span><br><span class=\"line\">\tallglen    <span class=\"keyword\">uintptr</span> <span class=\"comment\">//g</span></span><br><span class=\"line\">\tallm       *m      <span class=\"comment\">//m</span></span><br><span class=\"line\">\tallp       []*p  <span class=\"comment\">// p     len(allp) == gomaxprocs; may change at safe points, otherwise immutable</span></span><br><span class=\"line\">\tallpLock   mutex <span class=\"comment\">// 全局lock。   Protects P-less reads of allp and all writes</span></span><br><span class=\"line\">\tgomaxprocs <span class=\"keyword\">int32</span> <span class=\"comment\">//最大process数量</span></span><br><span class=\"line\">\tncpu       <span class=\"keyword\">int32</span> <span class=\"comment\">//cpu个数</span></span><br><span class=\"line\">\tforcegc    forcegcstate <span class=\"comment\">//强制GC</span></span><br><span class=\"line\">\tsched      schedt <span class=\"comment\">//预分配的一些变量值</span></span><br><span class=\"line\">\tnewprocs   <span class=\"keyword\">int32</span>  <span class=\"comment\">//新的process</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Information about what cpu features are available.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Packages outside the runtime should not use these</span></span><br><span class=\"line\">\t<span class=\"comment\">// as they are not an external api.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Set on startup in asm_&#123;386,amd64&#125;.s</span></span><br><span class=\"line\">\tprocessorVersionInfo <span class=\"keyword\">uint32</span></span><br><span class=\"line\">\tisIntel              <span class=\"keyword\">bool</span></span><br><span class=\"line\">\tlfenceBeforeRdtsc    <span class=\"keyword\">bool</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tgoarm                <span class=\"keyword\">uint8</span> <span class=\"comment\">// set by cmd/link on arm systems</span></span><br><span class=\"line\">\tframepointer_enabled <span class=\"keyword\">bool</span>  <span class=\"comment\">// set by cmd/link</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"sysmon函数\"><a class=\"header-anchor\" href=\"#sysmon函数\">¶</a>sysmon函数</h3>\n<h4 id=\"概览\"><a class=\"header-anchor\" href=\"#概览\">¶</a>概览</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">sysmon</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlock(&amp;sched.lock)<span class=\"comment\">//加锁</span></span><br><span class=\"line\">\tsched.nmsys++ <span class=\"comment\">//数量+1</span></span><br><span class=\"line\">\tcheckdead() <span class=\"comment\">//检查是否dead</span></span><br><span class=\"line\">\tunlock(&amp;sched.lock) <span class=\"comment\">//释放lock</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tlasttrace := <span class=\"keyword\">int64</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tidle := <span class=\"number\">0</span> <span class=\"comment\">// how many cycles in succession we had not wokeup somebody</span></span><br><span class=\"line\">\tdelay := <span class=\"keyword\">uint32</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>&#123;</span><br><span class=\"line\">\t\t......</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-sysmon-1.png\" alt=\"\"></p>\n<h3 id=\"循环干什么？\"><a class=\"header-anchor\" href=\"#循环干什么？\">¶</a>循环干什么？</h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201206_085755.png\" alt=\"\"></p>\n<blockquote>\n<p>一个个过吧</p>\n</blockquote>\n<h4 id=\"获取系统的纳秒时间\"><a class=\"header-anchor\" href=\"#获取系统的纳秒时间\">¶</a>获取系统的纳秒时间</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">now := nanotime()</span><br></pre></td></tr></table></figure>\n<h4 id=\"timeSleepUntil\"><a class=\"header-anchor\" href=\"#timeSleepUntil\">¶</a>timeSleepUntil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// timeSleepUntil returns the time when the next timer should fire,</span></span><br><span class=\"line\"><span class=\"comment\">// and the P that holds the timer heap that that timer is on.</span></span><br><span class=\"line\"><span class=\"comment\">// This is only called by sysmon and checkdead.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">timeSleepUntil</span><span class=\"params\">()</span> <span class=\"params\">(<span class=\"keyword\">int64</span>, *p)</span></span> &#123;</span><br><span class=\"line\">\tnext := <span class=\"keyword\">int64</span>(maxWhen)</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> pret *p</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Prevent allp slice changes. This is like retake.</span></span><br><span class=\"line\">\tlock(&amp;allpLock)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, pp := <span class=\"keyword\">range</span> allp &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> pp == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// This can happen if procresize has grown</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// allp but not yet created new Ps.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tc := atomic.Load(&amp;pp.adjustTimers)</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> c == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tw := <span class=\"keyword\">int64</span>(atomic.Load64(&amp;pp.timer0When))</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//划重点</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> w != <span class=\"number\">0</span> &amp;&amp; w &lt; next &#123;</span><br><span class=\"line\">\t\t\t\tnext = w</span><br><span class=\"line\">\t\t\t\tpret = pp</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tlock(&amp;pp.timersLock)</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> _, t := <span class=\"keyword\">range</span> pp.timers &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">//划重点</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span> s := atomic.Load(&amp;t.status); s &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> timerWaiting:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> t.when &lt; next &#123;</span><br><span class=\"line\">\t\t\t\t\tnext = t.when</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> timerModifiedEarlier, timerModifiedLater:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> t.nextwhen &lt; next &#123;</span><br><span class=\"line\">\t\t\t\t\tnext = t.nextwhen</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> s == timerModifiedEarlier &#123;</span><br><span class=\"line\">\t\t\t\t\tc--</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// The timers are sorted, so we only have to check</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// the first timer for each P, unless there are</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// some timerModifiedEarlier timers. The number</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// of timerModifiedEarlier timers is in the adjustTimers</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// field, used to initialize c, above.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// We don&#x27;t worry about cases like timerModifying.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// New timers can show up at any time,</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// so this function is necessarily imprecise.</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Do a signed check here since we aren&#x27;t</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// synchronizing the read of pp.adjustTimers</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// with the check of a timer status.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"keyword\">int32</span>(c) &lt;= <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tunlock(&amp;pp.timersLock)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tunlock(&amp;allpLock)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> next, pret</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"sched和gomaxprocs判断「sleep-wakeup过程」\"><a class=\"header-anchor\" href=\"#sched和gomaxprocs判断「sleep-wakeup过程」\">¶</a>sched和gomaxprocs判断「sleep&amp;wakeup过程」</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//双层判断，防止在加锁这段时间值发生变化</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> debug.schedtrace &lt;= <span class=\"number\">0</span> &amp;&amp; (sched.gcwaiting != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs)) &#123;</span><br><span class=\"line\">\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> atomic.Load(&amp;sched.gcwaiting) != <span class=\"number\">0</span> || atomic.Load(&amp;sched.npidle) == <span class=\"keyword\">uint32</span>(gomaxprocs) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> next &gt; now &#123;</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// Make wake-up period small enough</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// for the sampling to be correct.</span></span><br><span class=\"line\">\t\t\t\t\tsleep := forcegcperiod / <span class=\"number\">2</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> next-now &lt; sleep &#123;</span><br><span class=\"line\">\t\t\t\t\t\tsleep = next - now</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tshouldRelax := sleep &gt;= osRelaxMinNS</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">true</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnotetsleep(&amp;sched.sysmonnote, sleep)</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> shouldRelax &#123;</span><br><span class=\"line\">\t\t\t\t\t\tosRelax(<span class=\"literal\">false</span>)</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tnow = nanotime()</span><br><span class=\"line\">\t\t\t\t\tnext, _ = timeSleepUntil()</span><br><span class=\"line\">\t\t\t\t\tlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t\t\t\tatomic.Store(&amp;sched.sysmonwait, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t\t\tnoteclear(&amp;sched.sysmonnote)</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">\t\t\t\tdelay = <span class=\"number\">20</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tunlock(&amp;sched.lock)</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"poll-network\"><a class=\"header-anchor\" href=\"#poll-network\">¶</a>poll network</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// poll network if not polled for more than 10ms</span></span><br><span class=\"line\">lastpoll := <span class=\"keyword\">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class=\"line\"><span class=\"keyword\">if</span> netpollinited() &amp;&amp; lastpoll != <span class=\"number\">0</span> &amp;&amp; lastpoll+<span class=\"number\">10</span>*<span class=\"number\">1000</span>*<span class=\"number\">1000</span> &lt; now &#123;</span><br><span class=\"line\">\tatomic.Cas64(&amp;sched.lastpoll, <span class=\"keyword\">uint64</span>(lastpoll), <span class=\"keyword\">uint64</span>(now))</span><br><span class=\"line\">\tlist := netpoll(<span class=\"number\">0</span>) <span class=\"comment\">// non-blocking - returns list of goroutines</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !list.empty() &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Need to decrement number of idle locked M&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// (pretending that one more is running) before injectglist.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// Otherwise it can lead to the following situation:</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// injectglist grabs all P&#x27;s but before it starts M&#x27;s to run the P&#x27;s,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// another M returns from syscall, finishes running its G,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// observes that there is no work to do and no other running M&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// and reports deadlock.</span></span><br><span class=\"line\">\t\tincidlelocked(<span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t\tincidlelocked(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> next &lt; now &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// There are timers that should have already run,</span></span><br><span class=\"line\">\t<span class=\"comment\">// perhaps because there is an unpreemptible P.</span></span><br><span class=\"line\">\t<span class=\"comment\">// Try to start an M to run them.</span></span><br><span class=\"line\">\t<span class=\"comment\">//划重点</span></span><br><span class=\"line\">\tstartm(<span class=\"literal\">nil</span>, <span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"wakeScavenger\"><a class=\"header-anchor\" href=\"#wakeScavenger\">¶</a>wakeScavenger</h4>\n<blockquote>\n<p>判断需要唤醒请求</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> atomic.Load(&amp;scavenge.sysmonWake) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Kick the scavenger awake if someone requested it.</span></span><br><span class=\"line\">\twakeScavenger()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// wakeScavenger immediately unparks the scavenger if necessary.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// May run without a P, but it may allocate, so it must not be called</span></span><br><span class=\"line\"><span class=\"comment\">// on any allocation path.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// mheap_.lock, scavenge.lock, and sched.lock must not be held.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">wakeScavenger</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tlock(&amp;scavenge.lock)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> scavenge.parked &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Notify sysmon that it shouldn&#x27;t bother waking up the scavenger.</span></span><br><span class=\"line\">\t\tatomic.Store(&amp;scavenge.sysmonWake, <span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Try to stop the timer but we don&#x27;t really care if we succeed.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// It&#x27;s possible that either a timer was never started, or that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// we&#x27;re racing with it.</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// In the case that we&#x27;re racing with there&#x27;s the low chance that</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// we experience a spurious wake-up of the scavenger, but that&#x27;s</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// totally safe.</span></span><br><span class=\"line\">\t\tstopTimer(scavenge.timer)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Unpark the goroutine and tell it that there may have been a pacing</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// change. Note that we skip the scheduler&#x27;s runnext slot because we</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// want to avoid having the scavenger interfere with the fair</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// scheduling of user goroutines. In effect, this schedules the</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// scavenger at a &quot;lower priority&quot; but that&#x27;s OK because it&#x27;ll</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// catch up on the work it missed when it does get scheduled.</span></span><br><span class=\"line\">\t\tscavenge.parked = <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Ready the goroutine by injecting it. We use injectglist instead</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// of ready or goready in order to allow us to run this function</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// without a P. injectglist also avoids placing the goroutine in</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the current P&#x27;s runnext slot, which is desireable to prevent</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// the scavenger from interfering with user goroutine scheduling</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// too much.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> list gList</span><br><span class=\"line\">\t\tlist.push(scavenge.g)</span><br><span class=\"line\">\t\tinjectglist(&amp;list)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tunlock(&amp;scavenge.lock)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"retake夺取\"><a class=\"header-anchor\" href=\"#retake夺取\">¶</a>retake夺取</h4>\n<blockquote>\n<p>夺取空闲的P</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// retake P&#x27;s blocked in syscalls</span></span><br><span class=\"line\"><span class=\"comment\">// and preempt long running G&#x27;s</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> retake(now) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\tidle = <span class=\"number\">0</span></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\tidle++</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"GC-判断\"><a class=\"header-anchor\" href=\"#GC-判断\">¶</a>GC 判断</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// check if we need to force a GC</span></span><br><span class=\"line\"><span class=\"comment\">//划重点 t.test()</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> t := (gcTrigger&#123;kind: gcTriggerTime, now: now&#125;); t.test() &amp;&amp; atomic.Load(&amp;forcegc.idle) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\tlock(&amp;forcegc.lock)</span><br><span class=\"line\">\tforcegc.idle = <span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> list gList</span><br><span class=\"line\">\tlist.push(forcegc.g)</span><br><span class=\"line\">\tinjectglist(&amp;list)</span><br><span class=\"line\">\tunlock(&amp;forcegc.lock)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"待续…\"><a class=\"header-anchor\" href=\"#待续…\">¶</a>待续…</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-sysmon-1.png","popularPost_tmp_gaData":{"updated":"Sun Dec 06 2020 20:00:17 GMT+0800 (中国标准时间)","title":"「25」GPM sysmon函数","path":"archives/c770fe49.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/GPM-sysmon-1.png","excerpt":"<p>前面主要是了解newm的全过程和其中难过一些细节逻辑，，，<br>\n如果没了解的，建议先去看下大概的过程，虽然不是非常详细，<br>\n最起码得知道newm过程，主要完成了什么操作，有利于后续理解。</p>\n<p>这次主要是来学学这个sysmon，系统监控调度的逻辑。</p>","date":{"_isAMomentObject":true,"_i":"2020-12-06T12:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-12-06T12:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","GPM","Go源码"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":6440},{"title":"「26」Go 1.16 特性","date":"2020-12-28T00:00:17.000Z","updated":"2020-12-28T00:00:17.000Z","keywords":"GPM,Go,特性","abbrlink":"4f05d45d","_content":"\n\nGo 1.16特性：\n<!--more -->\n\n## json自定义[「issues 5901」](https://github.com/golang/go/issues/5901)\n### 「Feat」\n### 起源：\n\n```\nFor example, if a user wants to marshal net.IP with custom code, we should provide a way\nto do that, probably a method on *Encoder. Similarly for *Decoder.\n\nSame for encoding/xml\n```\n\n### 变更：\n\n[coding:](https://go-review.googlesource.com/c/go/+/31091)\n\n### [使用教程：](https://github.com/golang/go/issues/5901#issuecomment-566269861)\n\n\n## GMT和MDT时区问题[「issues 43354」](https://github.com/golang/go/issues/43354)\n### 「Fix」\n\n### 问题：\n>主要修复一个时区问题 MDT or GMT ？\n\n[官方reply](https://github.com/golang/go/issues/43354#issuecomment-750490418)\n[go-review](https://go-review.googlesource.com/c/go/+/280072/)\n\n\n\n## go get -d[「issues 43131」](https://github.com/golang/go/issues/43131)\n### 「Feat」\n### 变更：\n```go\ncmd/go新增：「仅下载，不使用此依赖」\n\n  go get -d\n\n```\n## go mod download无法指定版本[「issues 42524」](https://github.com/golang/go/issues/42524)\n\n### 「Fix」\n### 变更：\n```go\n  modify 指定版本可以download\n```\n\n### [review](https://go-review.googlesource.com/c/go/+/270520/)\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_011910.png)\n\n\n\n## ParseDir 指定.go作为后缀的bug[「issues 42951」](https://github.com/golang/go/issues/42951)\n\n### 「Fix」\n### 变更：\n\n```go\n  以.go结尾的文件夹，ParseDir无法转换\n```\n\n### [review](https://github.com/golang/go/commit/48838c35dc7c8e938a83db66faabf3a51f4adc3d)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_013355.png)\n\n\n\n\n## strconv:ParseComplex未处理32位数字[「issues 40706」](https://github.com/golang/go/issues/40706)\n\n### 「Fix」\n### 变更：\n```go\n  处理32bitsize，需要返回error。\n```\n\n### [review](https://go-review.googlesource.com/c/go/+/248219/)\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_051536.png)\n\n\n\n\n## runtime {getMcache} [「issues 42339」](https://github.com/golang/go/issues/42339)\n\n### 「Fix」\n### 变更\n\n```go\nruntime: make getMCache inlineable\n\n```\n\n### review\n* [runtime: decouple consistent stats from mcache and allow P-less update](https://go-review.googlesource.com/c/go/+/267158/)\n\n* [runtime: make getMCache inlineable](https://go-review.googlesource.com/c/go/+/267157/)\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_081048.png)\n### 持续更....\n\n\n","source":"_posts/26-v1-16.md","raw":"---\ntitle: 「26」Go 1.16 特性\ndate: '2020/12/28 08:00:17'\nupdated: '2020/12/28 08:00:17'\nkeywords: 'GPM,Go,特性'\ntags:\n  - Go\n  - v1.16\n  - encoding/json\nabbrlink: 4f05d45d\n---\n\n\nGo 1.16特性：\n<!--more -->\n\n## json自定义[「issues 5901」](https://github.com/golang/go/issues/5901)\n### 「Feat」\n### 起源：\n\n```\nFor example, if a user wants to marshal net.IP with custom code, we should provide a way\nto do that, probably a method on *Encoder. Similarly for *Decoder.\n\nSame for encoding/xml\n```\n\n### 变更：\n\n[coding:](https://go-review.googlesource.com/c/go/+/31091)\n\n### [使用教程：](https://github.com/golang/go/issues/5901#issuecomment-566269861)\n\n\n## GMT和MDT时区问题[「issues 43354」](https://github.com/golang/go/issues/43354)\n### 「Fix」\n\n### 问题：\n>主要修复一个时区问题 MDT or GMT ？\n\n[官方reply](https://github.com/golang/go/issues/43354#issuecomment-750490418)\n[go-review](https://go-review.googlesource.com/c/go/+/280072/)\n\n\n\n## go get -d[「issues 43131」](https://github.com/golang/go/issues/43131)\n### 「Feat」\n### 变更：\n```go\ncmd/go新增：「仅下载，不使用此依赖」\n\n  go get -d\n\n```\n## go mod download无法指定版本[「issues 42524」](https://github.com/golang/go/issues/42524)\n\n### 「Fix」\n### 变更：\n```go\n  modify 指定版本可以download\n```\n\n### [review](https://go-review.googlesource.com/c/go/+/270520/)\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_011910.png)\n\n\n\n## ParseDir 指定.go作为后缀的bug[「issues 42951」](https://github.com/golang/go/issues/42951)\n\n### 「Fix」\n### 变更：\n\n```go\n  以.go结尾的文件夹，ParseDir无法转换\n```\n\n### [review](https://github.com/golang/go/commit/48838c35dc7c8e938a83db66faabf3a51f4adc3d)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_013355.png)\n\n\n\n\n## strconv:ParseComplex未处理32位数字[「issues 40706」](https://github.com/golang/go/issues/40706)\n\n### 「Fix」\n### 变更：\n```go\n  处理32bitsize，需要返回error。\n```\n\n### [review](https://go-review.googlesource.com/c/go/+/248219/)\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_051536.png)\n\n\n\n\n## runtime {getMcache} [「issues 42339」](https://github.com/golang/go/issues/42339)\n\n### 「Fix」\n### 变更\n\n```go\nruntime: make getMCache inlineable\n\n```\n\n### review\n* [runtime: decouple consistent stats from mcache and allow P-less update](https://go-review.googlesource.com/c/go/+/267158/)\n\n* [runtime: make getMCache inlineable](https://go-review.googlesource.com/c/go/+/267157/)\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_081048.png)\n### 持续更....\n\n\n","slug":"26-v1-16","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlc001f3ci7dud6hkwt","content":"<p>Go 1.16特性：</p>\n<a id=\"more\"></a>\n<h2 id=\"json自定义「issues-5901」\"><a class=\"header-anchor\" href=\"#json自定义「issues-5901」\">¶</a>json自定义<a href=\"https://github.com/golang/go/issues/5901\">「issues 5901」</a></h2>\n<h3 id=\"「Feat」\"><a class=\"header-anchor\" href=\"#「Feat」\">¶</a>「Feat」</h3>\n<h3 id=\"起源：\"><a class=\"header-anchor\" href=\"#起源：\">¶</a>起源：</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">For example, if a user wants to marshal net.IP with custom code, we should provide a way</span><br><span class=\"line\">to do that, probably a method on *Encoder. Similarly for *Decoder.</span><br><span class=\"line\"></span><br><span class=\"line\">Same for encoding&#x2F;xml</span><br></pre></td></tr></table></figure>\n<h3 id=\"变更：\"><a class=\"header-anchor\" href=\"#变更：\">¶</a>变更：</h3>\n<p><a href=\"https://go-review.googlesource.com/c/go/+/31091\">coding:</a></p>\n<h3 id=\"使用教程：\"><a class=\"header-anchor\" href=\"#使用教程：\">¶</a><a href=\"https://github.com/golang/go/issues/5901#issuecomment-566269861\">使用教程：</a></h3>\n<h2 id=\"GMT和MDT时区问题「issues-43354」\"><a class=\"header-anchor\" href=\"#GMT和MDT时区问题「issues-43354」\">¶</a>GMT和MDT时区问题<a href=\"https://github.com/golang/go/issues/43354\">「issues 43354」</a></h2>\n<h3 id=\"「Fix」\"><a class=\"header-anchor\" href=\"#「Fix」\">¶</a>「Fix」</h3>\n<h3 id=\"问题：\"><a class=\"header-anchor\" href=\"#问题：\">¶</a>问题：</h3>\n<blockquote>\n<p>主要修复一个时区问题 MDT or GMT ？</p>\n</blockquote>\n<p><a href=\"https://github.com/golang/go/issues/43354#issuecomment-750490418\">官方reply</a><br>\n<a href=\"https://go-review.googlesource.com/c/go/+/280072/\">go-review</a></p>\n<h2 id=\"go-get-d「issues-43131」\"><a class=\"header-anchor\" href=\"#go-get-d「issues-43131」\">¶</a>go get -d<a href=\"https://github.com/golang/go/issues/43131\">「issues 43131」</a></h2>\n<h3 id=\"「Feat」-v2\"><a class=\"header-anchor\" href=\"#「Feat」-v2\">¶</a>「Feat」</h3>\n<h3 id=\"变更：-v2\"><a class=\"header-anchor\" href=\"#变更：-v2\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cmd/<span class=\"keyword\">go</span>新增：「仅下载，不使用此依赖」</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">go</span> get -d</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"go-mod-download无法指定版本「issues-42524」\"><a class=\"header-anchor\" href=\"#go-mod-download无法指定版本「issues-42524」\">¶</a>go mod download无法指定版本<a href=\"https://github.com/golang/go/issues/42524\">「issues 42524」</a></h2>\n<h3 id=\"「Fix」-v2\"><a class=\"header-anchor\" href=\"#「Fix」-v2\">¶</a>「Fix」</h3>\n<h3 id=\"变更：-v3\"><a class=\"header-anchor\" href=\"#变更：-v3\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modify 指定版本可以download</span><br></pre></td></tr></table></figure>\n<h3 id=\"review\"><a class=\"header-anchor\" href=\"#review\">¶</a><a href=\"https://go-review.googlesource.com/c/go/+/270520/\">review</a></h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_011910.png\" alt=\"\"></p>\n<h2 id=\"ParseDir-指定-go作为后缀的bug「issues-42951」\"><a class=\"header-anchor\" href=\"#ParseDir-指定-go作为后缀的bug「issues-42951」\">¶</a>ParseDir 指定.go作为后缀的bug<a href=\"https://github.com/golang/go/issues/42951\">「issues 42951」</a></h2>\n<h3 id=\"「Fix」-v3\"><a class=\"header-anchor\" href=\"#「Fix」-v3\">¶</a>「Fix」</h3>\n<h3 id=\"变更：-v4\"><a class=\"header-anchor\" href=\"#变更：-v4\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">以.<span class=\"keyword\">go</span>结尾的文件夹，ParseDir无法转换</span><br></pre></td></tr></table></figure>\n<h3 id=\"review-v2\"><a class=\"header-anchor\" href=\"#review-v2\">¶</a><a href=\"https://github.com/golang/go/commit/48838c35dc7c8e938a83db66faabf3a51f4adc3d\">review</a></h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_013355.png\" alt=\"\"></p>\n<h2 id=\"strconv-ParseComplex未处理32位数字「issues-40706」\"><a class=\"header-anchor\" href=\"#strconv-ParseComplex未处理32位数字「issues-40706」\">¶</a>strconv:ParseComplex未处理32位数字<a href=\"https://github.com/golang/go/issues/40706\">「issues 40706」</a></h2>\n<h3 id=\"「Fix」-v4\"><a class=\"header-anchor\" href=\"#「Fix」-v4\">¶</a>「Fix」</h3>\n<h3 id=\"变更：-v5\"><a class=\"header-anchor\" href=\"#变更：-v5\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">处理<span class=\"number\">32</span>bitsize，需要返回error。</span><br></pre></td></tr></table></figure>\n<h3 id=\"review-v3\"><a class=\"header-anchor\" href=\"#review-v3\">¶</a><a href=\"https://go-review.googlesource.com/c/go/+/248219/\">review</a></h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_051536.png\" alt=\"\"></p>\n<h2 id=\"runtime-getMcache-「issues-42339」\"><a class=\"header-anchor\" href=\"#runtime-getMcache-「issues-42339」\">¶</a>runtime {getMcache} <a href=\"https://github.com/golang/go/issues/42339\">「issues 42339」</a></h2>\n<h3 id=\"「Fix」-v5\"><a class=\"header-anchor\" href=\"#「Fix」-v5\">¶</a>「Fix」</h3>\n<h3 id=\"变更\"><a class=\"header-anchor\" href=\"#变更\">¶</a>变更</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">runtime: <span class=\"built_in\">make</span> getMCache inlineable</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"review-v4\"><a class=\"header-anchor\" href=\"#review-v4\">¶</a>review</h3>\n<ul>\n<li>\n<p><a href=\"https://go-review.googlesource.com/c/go/+/267158/\">runtime: decouple consistent stats from mcache and allow P-less update</a></p>\n</li>\n<li>\n<p><a href=\"https://go-review.googlesource.com/c/go/+/267157/\">runtime: make getMCache inlineable</a></p>\n</li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_081048.png\" alt=\"\"></p>\n<h3 id=\"持续更…\"><a class=\"header-anchor\" href=\"#持续更…\">¶</a>持续更…</h3>\n","site":{"data":{}},"excerpt":"<p>Go 1.16特性：</p>","more":"<h2 id=\"json自定义「issues-5901」\"><a class=\"header-anchor\" href=\"#json自定义「issues-5901」\">¶</a>json自定义<a href=\"https://github.com/golang/go/issues/5901\">「issues 5901」</a></h2>\n<h3 id=\"「Feat」\"><a class=\"header-anchor\" href=\"#「Feat」\">¶</a>「Feat」</h3>\n<h3 id=\"起源：\"><a class=\"header-anchor\" href=\"#起源：\">¶</a>起源：</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">For example, if a user wants to marshal net.IP with custom code, we should provide a way</span><br><span class=\"line\">to do that, probably a method on *Encoder. Similarly for *Decoder.</span><br><span class=\"line\"></span><br><span class=\"line\">Same for encoding&#x2F;xml</span><br></pre></td></tr></table></figure>\n<h3 id=\"变更：\"><a class=\"header-anchor\" href=\"#变更：\">¶</a>变更：</h3>\n<p><a href=\"https://go-review.googlesource.com/c/go/+/31091\">coding:</a></p>\n<h3 id=\"使用教程：\"><a class=\"header-anchor\" href=\"#使用教程：\">¶</a><a href=\"https://github.com/golang/go/issues/5901#issuecomment-566269861\">使用教程：</a></h3>\n<h2 id=\"GMT和MDT时区问题「issues-43354」\"><a class=\"header-anchor\" href=\"#GMT和MDT时区问题「issues-43354」\">¶</a>GMT和MDT时区问题<a href=\"https://github.com/golang/go/issues/43354\">「issues 43354」</a></h2>\n<h3 id=\"「Fix」\"><a class=\"header-anchor\" href=\"#「Fix」\">¶</a>「Fix」</h3>\n<h3 id=\"问题：\"><a class=\"header-anchor\" href=\"#问题：\">¶</a>问题：</h3>\n<blockquote>\n<p>主要修复一个时区问题 MDT or GMT ？</p>\n</blockquote>\n<p><a href=\"https://github.com/golang/go/issues/43354#issuecomment-750490418\">官方reply</a><br>\n<a href=\"https://go-review.googlesource.com/c/go/+/280072/\">go-review</a></p>\n<h2 id=\"go-get-d「issues-43131」\"><a class=\"header-anchor\" href=\"#go-get-d「issues-43131」\">¶</a>go get -d<a href=\"https://github.com/golang/go/issues/43131\">「issues 43131」</a></h2>\n<h3 id=\"「Feat」-v2\"><a class=\"header-anchor\" href=\"#「Feat」-v2\">¶</a>「Feat」</h3>\n<h3 id=\"变更：-v2\"><a class=\"header-anchor\" href=\"#变更：-v2\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cmd/<span class=\"keyword\">go</span>新增：「仅下载，不使用此依赖」</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">go</span> get -d</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"go-mod-download无法指定版本「issues-42524」\"><a class=\"header-anchor\" href=\"#go-mod-download无法指定版本「issues-42524」\">¶</a>go mod download无法指定版本<a href=\"https://github.com/golang/go/issues/42524\">「issues 42524」</a></h2>\n<h3 id=\"「Fix」-v2\"><a class=\"header-anchor\" href=\"#「Fix」-v2\">¶</a>「Fix」</h3>\n<h3 id=\"变更：-v3\"><a class=\"header-anchor\" href=\"#变更：-v3\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modify 指定版本可以download</span><br></pre></td></tr></table></figure>\n<h3 id=\"review\"><a class=\"header-anchor\" href=\"#review\">¶</a><a href=\"https://go-review.googlesource.com/c/go/+/270520/\">review</a></h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_011910.png\" alt=\"\"></p>\n<h2 id=\"ParseDir-指定-go作为后缀的bug「issues-42951」\"><a class=\"header-anchor\" href=\"#ParseDir-指定-go作为后缀的bug「issues-42951」\">¶</a>ParseDir 指定.go作为后缀的bug<a href=\"https://github.com/golang/go/issues/42951\">「issues 42951」</a></h2>\n<h3 id=\"「Fix」-v3\"><a class=\"header-anchor\" href=\"#「Fix」-v3\">¶</a>「Fix」</h3>\n<h3 id=\"变更：-v4\"><a class=\"header-anchor\" href=\"#变更：-v4\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">以.<span class=\"keyword\">go</span>结尾的文件夹，ParseDir无法转换</span><br></pre></td></tr></table></figure>\n<h3 id=\"review-v2\"><a class=\"header-anchor\" href=\"#review-v2\">¶</a><a href=\"https://github.com/golang/go/commit/48838c35dc7c8e938a83db66faabf3a51f4adc3d\">review</a></h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_013355.png\" alt=\"\"></p>\n<h2 id=\"strconv-ParseComplex未处理32位数字「issues-40706」\"><a class=\"header-anchor\" href=\"#strconv-ParseComplex未处理32位数字「issues-40706」\">¶</a>strconv:ParseComplex未处理32位数字<a href=\"https://github.com/golang/go/issues/40706\">「issues 40706」</a></h2>\n<h3 id=\"「Fix」-v4\"><a class=\"header-anchor\" href=\"#「Fix」-v4\">¶</a>「Fix」</h3>\n<h3 id=\"变更：-v5\"><a class=\"header-anchor\" href=\"#变更：-v5\">¶</a>变更：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">处理<span class=\"number\">32</span>bitsize，需要返回error。</span><br></pre></td></tr></table></figure>\n<h3 id=\"review-v3\"><a class=\"header-anchor\" href=\"#review-v3\">¶</a><a href=\"https://go-review.googlesource.com/c/go/+/248219/\">review</a></h3>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_051536.png\" alt=\"\"></p>\n<h2 id=\"runtime-getMcache-「issues-42339」\"><a class=\"header-anchor\" href=\"#runtime-getMcache-「issues-42339」\">¶</a>runtime {getMcache} <a href=\"https://github.com/golang/go/issues/42339\">「issues 42339」</a></h2>\n<h3 id=\"「Fix」-v5\"><a class=\"header-anchor\" href=\"#「Fix」-v5\">¶</a>「Fix」</h3>\n<h3 id=\"变更\"><a class=\"header-anchor\" href=\"#变更\">¶</a>变更</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">runtime: <span class=\"built_in\">make</span> getMCache inlineable</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"review-v4\"><a class=\"header-anchor\" href=\"#review-v4\">¶</a>review</h3>\n<ul>\n<li>\n<p><a href=\"https://go-review.googlesource.com/c/go/+/267158/\">runtime: decouple consistent stats from mcache and allow P-less update</a></p>\n</li>\n<li>\n<p><a href=\"https://go-review.googlesource.com/c/go/+/267157/\">runtime: make getMCache inlineable</a></p>\n</li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_081048.png\" alt=\"\"></p>\n<h3 id=\"持续更…\"><a class=\"header-anchor\" href=\"#持续更…\">¶</a>持续更…</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_011910.png","popularPost_tmp_gaData":{"updated":"Mon Dec 28 2020 08:00:17 GMT+0800 (中国标准时间)","title":"「26」Go 1.16 特性","path":"archives/4f05d45d.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_011910.png","excerpt":"<p>Go 1.16特性：</p>","date":{"_isAMomentObject":true,"_i":"2020-12-28T00:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-12-28T00:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","v1.16","encoding/json"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":754},{"title":"「27」Time Zone时区详解","date":"2020-12-28T01:00:17.000Z","updated":"2020-12-28T01:00:17.000Z","keywords":"time,zone,Go","abbrlink":"513dbeba","_content":"\n\n时区，无关语言，在任何一个系统中都会用到：\n* time「时间」\n* timeID「时间作为唯一标识」\n* time to unix\n* unix to time string\n* .....\n\n>很多场景都会看到这个时间的重要性，这次看到16的特性中有一个修改项，觉得自己对time和zone了解的太少了，以此记录，以便积累。\n\n<!--more-->\n### Go version:\n\n```go\n7384 ◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 时区 UTC\\GMT\\MDT\\CST\n\n>说到时间，肯定得想到时区问题，咱们国家还好，只有一个Beijing时区，美国本土。。。。四个时区「晕了」\n\nPs: [点击查看四个时区](https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E6%99%82%E5%8D%80)\n\n\n\n\n```markdown\nGMT (Greenwich Mean Time)的缩写，指的是皇家格林威治天文台的标准时间，称作格林威治时间，因为本初子午线通过此地区，因此也称为世界标准时间。然而地球的自转不是完全规律的，而且正逐渐减慢，因此自1924年开始，格林威治时间(GMT)已经不再被视为标准时间，取而代之的是\"世界协调时间\" (UTC: Coordinated Universal Time)\n\nUTC 协调世界时（Coordinated Universal Time）是最主要的世界时间标准，其以原子时秒长为基础，在时刻上尽量接近于格林尼治标准时间。UTC 是一个标准，而不是一个时区\n\nCST\n 北京时间，China Standard Time，中国标准时间，是中国的标准时间。在时区划分上，属东八区，比协调世界时早8小时，记为UTC+8\n```\n\n\n### Go中的时区问题\n\n有一个函数可以说明这个时区问题：\n\n* time.LoadLocation\n\n>如果你查查源码，就会发现这个函数上面写着时区的问题，也跟不用百度时区，有的自然支持，没有的写了就是乱写了。\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112003.png)\n\n```go\n查询的时区一直就在你goroot路径下的一个压缩文件中。\n```\n\n具体的有兴趣可以去看看所有的时区，后续也就有一个全面的了解了：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112408.png)\n\n\n\n### Go 中对于时间的使用\n\n>待更新....","source":"_posts/27-Time-Zone时区详解.md","raw":"---\ntitle: 「27」Time Zone时区详解\ndate: '2020/12/28 09:00:17'\nupdated: '2020/12/28 09:00:17'\nkeywords: 'time,zone,Go'\ntags:\n  - Go\n  - time\n  - Day\nabbrlink: 513dbeba\n---\n\n\n时区，无关语言，在任何一个系统中都会用到：\n* time「时间」\n* timeID「时间作为唯一标识」\n* time to unix\n* unix to time string\n* .....\n\n>很多场景都会看到这个时间的重要性，这次看到16的特性中有一个修改项，觉得自己对time和zone了解的太少了，以此记录，以便积累。\n\n<!--more-->\n### Go version:\n\n```go\n7384 ◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 时区 UTC\\GMT\\MDT\\CST\n\n>说到时间，肯定得想到时区问题，咱们国家还好，只有一个Beijing时区，美国本土。。。。四个时区「晕了」\n\nPs: [点击查看四个时区](https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E6%99%82%E5%8D%80)\n\n\n\n\n```markdown\nGMT (Greenwich Mean Time)的缩写，指的是皇家格林威治天文台的标准时间，称作格林威治时间，因为本初子午线通过此地区，因此也称为世界标准时间。然而地球的自转不是完全规律的，而且正逐渐减慢，因此自1924年开始，格林威治时间(GMT)已经不再被视为标准时间，取而代之的是\"世界协调时间\" (UTC: Coordinated Universal Time)\n\nUTC 协调世界时（Coordinated Universal Time）是最主要的世界时间标准，其以原子时秒长为基础，在时刻上尽量接近于格林尼治标准时间。UTC 是一个标准，而不是一个时区\n\nCST\n 北京时间，China Standard Time，中国标准时间，是中国的标准时间。在时区划分上，属东八区，比协调世界时早8小时，记为UTC+8\n```\n\n\n### Go中的时区问题\n\n有一个函数可以说明这个时区问题：\n\n* time.LoadLocation\n\n>如果你查查源码，就会发现这个函数上面写着时区的问题，也跟不用百度时区，有的自然支持，没有的写了就是乱写了。\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112003.png)\n\n```go\n查询的时区一直就在你goroot路径下的一个压缩文件中。\n```\n\n具体的有兴趣可以去看看所有的时区，后续也就有一个全面的了解了：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112408.png)\n\n\n\n### Go 中对于时间的使用\n\n>待更新....","slug":"27-Time-Zone时区详解","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdld001h3ci74bzg5sx0","content":"<p>时区，无关语言，在任何一个系统中都会用到：</p>\n<ul>\n<li>time「时间」</li>\n<li>timeID「时间作为唯一标识」</li>\n<li>time to unix</li>\n<li>unix to time string</li>\n<li>…</li>\n</ul>\n<blockquote>\n<p>很多场景都会看到这个时间的重要性，这次看到16的特性中有一个修改项，觉得自己对time和zone了解的太少了，以此记录，以便积累。</p>\n</blockquote>\n<a id=\"more\"></a>\n<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"时区-UTC-GMT-MDT-CST\"><a class=\"header-anchor\" href=\"#时区-UTC-GMT-MDT-CST\">¶</a>时区 UTC\\GMT\\MDT\\CST</h3>\n<blockquote>\n<p>说到时间，肯定得想到时区问题，咱们国家还好，只有一个Beijing时区，美国本土。。。。四个时区「晕了」</p>\n</blockquote>\n<p>Ps: <a href=\"https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E6%99%82%E5%8D%80\">点击查看四个时区</a></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GMT (Greenwich Mean Time)的缩写，指的是皇家格林威治天文台的标准时间，称作格林威治时间，因为本初子午线通过此地区，因此也称为世界标准时间。然而地球的自转不是完全规律的，而且正逐渐减慢，因此自1924年开始，格林威治时间(GMT)已经不再被视为标准时间，取而代之的是&quot;世界协调时间&quot; (UTC: Coordinated Universal Time)</span><br><span class=\"line\"></span><br><span class=\"line\">UTC 协调世界时（Coordinated Universal Time）是最主要的世界时间标准，其以原子时秒长为基础，在时刻上尽量接近于格林尼治标准时间。UTC 是一个标准，而不是一个时区</span><br><span class=\"line\"></span><br><span class=\"line\">CST</span><br><span class=\"line\"> 北京时间，China Standard Time，中国标准时间，是中国的标准时间。在时区划分上，属东八区，比协调世界时早8小时，记为UTC+8</span><br></pre></td></tr></table></figure>\n<h3 id=\"Go中的时区问题\"><a class=\"header-anchor\" href=\"#Go中的时区问题\">¶</a>Go中的时区问题</h3>\n<p>有一个函数可以说明这个时区问题：</p>\n<ul>\n<li>time.LoadLocation</li>\n</ul>\n<blockquote>\n<p>如果你查查源码，就会发现这个函数上面写着时区的问题，也跟不用百度时区，有的自然支持，没有的写了就是乱写了。</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112003.png\" alt=\"\"></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查询的时区一直就在你goroot路径下的一个压缩文件中。</span><br></pre></td></tr></table></figure>\n<p>具体的有兴趣可以去看看所有的时区，后续也就有一个全面的了解了：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112408.png\" alt=\"\"></p>\n<h3 id=\"Go-中对于时间的使用\"><a class=\"header-anchor\" href=\"#Go-中对于时间的使用\">¶</a>Go 中对于时间的使用</h3>\n<blockquote>\n<p>待更新…</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<p>时区，无关语言，在任何一个系统中都会用到：</p>\n<ul>\n<li>time「时间」</li>\n<li>timeID「时间作为唯一标识」</li>\n<li>time to unix</li>\n<li>unix to time string</li>\n<li>…</li>\n</ul>\n<blockquote>\n<p>很多场景都会看到这个时间的重要性，这次看到16的特性中有一个修改项，觉得自己对time和zone了解的太少了，以此记录，以便积累。</p>\n</blockquote>","more":"<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"时区-UTC-GMT-MDT-CST\"><a class=\"header-anchor\" href=\"#时区-UTC-GMT-MDT-CST\">¶</a>时区 UTC\\GMT\\MDT\\CST</h3>\n<blockquote>\n<p>说到时间，肯定得想到时区问题，咱们国家还好，只有一个Beijing时区，美国本土。。。。四个时区「晕了」</p>\n</blockquote>\n<p>Ps: <a href=\"https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E6%99%82%E5%8D%80\">点击查看四个时区</a></p>\n<figure class=\"highlight markdown\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GMT (Greenwich Mean Time)的缩写，指的是皇家格林威治天文台的标准时间，称作格林威治时间，因为本初子午线通过此地区，因此也称为世界标准时间。然而地球的自转不是完全规律的，而且正逐渐减慢，因此自1924年开始，格林威治时间(GMT)已经不再被视为标准时间，取而代之的是&quot;世界协调时间&quot; (UTC: Coordinated Universal Time)</span><br><span class=\"line\"></span><br><span class=\"line\">UTC 协调世界时（Coordinated Universal Time）是最主要的世界时间标准，其以原子时秒长为基础，在时刻上尽量接近于格林尼治标准时间。UTC 是一个标准，而不是一个时区</span><br><span class=\"line\"></span><br><span class=\"line\">CST</span><br><span class=\"line\"> 北京时间，China Standard Time，中国标准时间，是中国的标准时间。在时区划分上，属东八区，比协调世界时早8小时，记为UTC+8</span><br></pre></td></tr></table></figure>\n<h3 id=\"Go中的时区问题\"><a class=\"header-anchor\" href=\"#Go中的时区问题\">¶</a>Go中的时区问题</h3>\n<p>有一个函数可以说明这个时区问题：</p>\n<ul>\n<li>time.LoadLocation</li>\n</ul>\n<blockquote>\n<p>如果你查查源码，就会发现这个函数上面写着时区的问题，也跟不用百度时区，有的自然支持，没有的写了就是乱写了。</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112003.png\" alt=\"\"></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查询的时区一直就在你goroot路径下的一个压缩文件中。</span><br></pre></td></tr></table></figure>\n<p>具体的有兴趣可以去看看所有的时区，后续也就有一个全面的了解了：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112408.png\" alt=\"\"></p>\n<h3 id=\"Go-中对于时间的使用\"><a class=\"header-anchor\" href=\"#Go-中对于时间的使用\">¶</a>Go 中对于时间的使用</h3>\n<blockquote>\n<p>待更新…</p>\n</blockquote>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112003.png","popularPost_tmp_gaData":{"updated":"Mon Dec 28 2020 09:00:17 GMT+0800 (中国标准时间)","title":"「27」Time Zone时区详解","path":"archives/513dbeba.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20201228_112003.png","excerpt":"<p>时区，无关语言，在任何一个系统中都会用到：</p>\n<ul>\n<li>time「时间」</li>\n<li>timeID「时间作为唯一标识」</li>\n<li>time to unix</li>\n<li>unix to time string</li>\n<li>…</li>\n</ul>\n<blockquote>\n<p>很多场景都会看到这个时间的重要性，这次看到16的特性中有一个修改项，觉得自己对time和zone了解的太少了，以此记录，以便积累。</p>\n</blockquote>","date":{"_isAMomentObject":true,"_i":"2020-12-28T01:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-12-28T01:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day","time"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":802},{"title":"「28」sync-mutex传参复制问题","date":"2021-01-02T13:00:17.000Z","updated":"2021-01-02T13:00:17.000Z","keywords":"time,zone,Go,sync,Mutex","abbrlink":"a82ae489","_content":"### Go version:\n\n```go\n7384 ◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 起因:\n\n```\nsync.Mutex当参数,值传递后出错.\n\n```\n\n### 现象:\n\n>不废话,上代码:\n\n\n<!--more-->\n\n```go\n\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\nvar wg sync.WaitGroup\nvar age int\n\ntype Person struct {\n\tmux sync.Mutex\n}\n\nfunc (p Person) AddAge() {\n\tdefer wg.Done()\n\tp.mux.Lock()\n\tage++\n\tdefer p.mux.Unlock()\n}\n\nfunc main() {\n\tp1 := Person{\n\t\tmux: sync.Mutex{},\n\t}\n\twg.Add(100)\n\tfor i := 0; i < 100; i++ {\n\t\tgo p1.AddAge()\n\t}\n    wg.Wait()\n    \n\tfmt.Println(age)\n}\n\n```\n#### 这个age的输出应该是多少?\n\n#### 不妨可以多尝试几次,结果:\n\n>100/99/98都有可能.\n\n\n### What? Lock难道不是加锁的么\n\n>Lock加锁难道不是这么用的么,颠覆认知!\n\n#### Lock源码: \n*A Mutex must not be copied after first use*\n\n### 根源:\n\n* Go参数传递属于值传递\n* Mutex复制后中的state属于前一状态,没有改变\n* Mutex中的Lock和Unlock「方法」属于指针类型<sup>图1</sup>\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210102_102753.png)\n**<center>图<sup>1</sup></center>**\n\n### 解决办法\n\n\n* 当然是参考源码,「图1」\n\n```go\n\n缺点:\n    每次使用之前需要初始化,毕竟是指针类型的\n\n优点:\n    设计源于源码,追随Go的设计.\n\n```\n* 加锁的地方尽量是全局的\n\n```go\n这个就不分析了,毕竟不适用所有场景.\n\n不适用的场景:\n    临时的Map需要加锁,如果用全局锁,则效率降低.\n```\n\n### Sync包不可复制性\n\n```go\n使用sync包下的功能,可能得注意了,都是不可复制的.\n```\n\n\n### End\n\n>每次看源码,都会有不一样的收获.「也许是我理解能力差哈」\n","source":"_posts/28-sync-mutex传参复制问题.md","raw":"---\ntitle: 「28」sync-mutex传参复制问题\ndate: '2021/1/2 21:00:17'\nupdated: '2021/1/2 21:00:17'\nkeywords: 'time,zone,Go,sync,Mutex'\ntags:\n  - Go\n  - sync\n  - Day\n  - Mutex\nabbrlink: a82ae489\n---\n### Go version:\n\n```go\n7384 ◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 起因:\n\n```\nsync.Mutex当参数,值传递后出错.\n\n```\n\n### 现象:\n\n>不废话,上代码:\n\n\n<!--more-->\n\n```go\n\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n)\n\nvar wg sync.WaitGroup\nvar age int\n\ntype Person struct {\n\tmux sync.Mutex\n}\n\nfunc (p Person) AddAge() {\n\tdefer wg.Done()\n\tp.mux.Lock()\n\tage++\n\tdefer p.mux.Unlock()\n}\n\nfunc main() {\n\tp1 := Person{\n\t\tmux: sync.Mutex{},\n\t}\n\twg.Add(100)\n\tfor i := 0; i < 100; i++ {\n\t\tgo p1.AddAge()\n\t}\n    wg.Wait()\n    \n\tfmt.Println(age)\n}\n\n```\n#### 这个age的输出应该是多少?\n\n#### 不妨可以多尝试几次,结果:\n\n>100/99/98都有可能.\n\n\n### What? Lock难道不是加锁的么\n\n>Lock加锁难道不是这么用的么,颠覆认知!\n\n#### Lock源码: \n*A Mutex must not be copied after first use*\n\n### 根源:\n\n* Go参数传递属于值传递\n* Mutex复制后中的state属于前一状态,没有改变\n* Mutex中的Lock和Unlock「方法」属于指针类型<sup>图1</sup>\n\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210102_102753.png)\n**<center>图<sup>1</sup></center>**\n\n### 解决办法\n\n\n* 当然是参考源码,「图1」\n\n```go\n\n缺点:\n    每次使用之前需要初始化,毕竟是指针类型的\n\n优点:\n    设计源于源码,追随Go的设计.\n\n```\n* 加锁的地方尽量是全局的\n\n```go\n这个就不分析了,毕竟不适用所有场景.\n\n不适用的场景:\n    临时的Map需要加锁,如果用全局锁,则效率降低.\n```\n\n### Sync包不可复制性\n\n```go\n使用sync包下的功能,可能得注意了,都是不可复制的.\n```\n\n\n### End\n\n>每次看源码,都会有不一样的收获.「也许是我理解能力差哈」\n","slug":"28-sync-mutex传参复制问题","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdle001k3ci7etvc0v8k","content":"<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"起因\"><a class=\"header-anchor\" href=\"#起因\">¶</a>起因:</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sync.Mutex当参数,值传递后出错.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"现象\"><a class=\"header-anchor\" href=\"#现象\">¶</a>现象:</h3>\n<blockquote>\n<p>不废话,上代码:</p>\n</blockquote>\n<a id=\"more\"></a>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sync&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> wg sync.WaitGroup</span><br><span class=\"line\"><span class=\"keyword\">var</span> age <span class=\"keyword\">int</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Person <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tmux sync.Mutex</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(p Person)</span> <span class=\"title\">AddAge</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> wg.Done()</span><br><span class=\"line\">\tp.mux.Lock()</span><br><span class=\"line\">\tage++</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> p.mux.Unlock()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tp1 := Person&#123;</span><br><span class=\"line\">\t\tmux: sync.Mutex&#123;&#125;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\twg.Add(<span class=\"number\">100</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">100</span>; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> p1.AddAge()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    wg.Wait()</span><br><span class=\"line\">    </span><br><span class=\"line\">\tfmt.Println(age)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"这个age的输出应该是多少\"><a class=\"header-anchor\" href=\"#这个age的输出应该是多少\">¶</a>这个age的输出应该是多少?</h4>\n<h4 id=\"不妨可以多尝试几次-结果\"><a class=\"header-anchor\" href=\"#不妨可以多尝试几次-结果\">¶</a>不妨可以多尝试几次,结果:</h4>\n<blockquote>\n<p>100/99/98都有可能.</p>\n</blockquote>\n<h3 id=\"What-Lock难道不是加锁的么\"><a class=\"header-anchor\" href=\"#What-Lock难道不是加锁的么\">¶</a>What? Lock难道不是加锁的么</h3>\n<blockquote>\n<p>Lock加锁难道不是这么用的么,颠覆认知!</p>\n</blockquote>\n<h4 id=\"Lock源码\"><a class=\"header-anchor\" href=\"#Lock源码\">¶</a>Lock源码:</h4>\n<p><em>A Mutex must not be copied after first use</em></p>\n<h3 id=\"根源\"><a class=\"header-anchor\" href=\"#根源\">¶</a>根源:</h3>\n<ul>\n<li>Go参数传递属于值传递</li>\n<li>Mutex复制后中的state属于前一状态,没有改变</li>\n<li>Mutex中的Lock和Unlock「方法」属于指针类型<sup>图1</sup></li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210102_102753.png\" alt=\"\"><br>\n<strong><center>图<sup>1</sup></center></strong></p>\n<h3 id=\"解决办法\"><a class=\"header-anchor\" href=\"#解决办法\">¶</a>解决办法</h3>\n<ul>\n<li>当然是参考源码,「图1」</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">缺点:</span><br><span class=\"line\">    每次使用之前需要初始化,毕竟是指针类型的</span><br><span class=\"line\"></span><br><span class=\"line\">优点:</span><br><span class=\"line\">    设计源于源码,追随Go的设计.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>加锁的地方尽量是全局的</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这个就不分析了,毕竟不适用所有场景.</span><br><span class=\"line\"></span><br><span class=\"line\">不适用的场景:</span><br><span class=\"line\">    临时的Map需要加锁,如果用全局锁,则效率降低.</span><br></pre></td></tr></table></figure>\n<h3 id=\"Sync包不可复制性\"><a class=\"header-anchor\" href=\"#Sync包不可复制性\">¶</a>Sync包不可复制性</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用sync包下的功能,可能得注意了,都是不可复制的.</span><br></pre></td></tr></table></figure>\n<h3 id=\"End\"><a class=\"header-anchor\" href=\"#End\">¶</a>End</h3>\n<blockquote>\n<p>每次看源码,都会有不一样的收获.「也许是我理解能力差哈」</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"起因\"><a class=\"header-anchor\" href=\"#起因\">¶</a>起因:</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sync.Mutex当参数,值传递后出错.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"现象\"><a class=\"header-anchor\" href=\"#现象\">¶</a>现象:</h3>\n<blockquote>\n<p>不废话,上代码:</p>\n</blockquote>","more":"<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sync&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> wg sync.WaitGroup</span><br><span class=\"line\"><span class=\"keyword\">var</span> age <span class=\"keyword\">int</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Person <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tmux sync.Mutex</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(p Person)</span> <span class=\"title\">AddAge</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> wg.Done()</span><br><span class=\"line\">\tp.mux.Lock()</span><br><span class=\"line\">\tage++</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> p.mux.Unlock()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tp1 := Person&#123;</span><br><span class=\"line\">\t\tmux: sync.Mutex&#123;&#125;,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\twg.Add(<span class=\"number\">100</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">100</span>; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> p1.AddAge()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    wg.Wait()</span><br><span class=\"line\">    </span><br><span class=\"line\">\tfmt.Println(age)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"这个age的输出应该是多少\"><a class=\"header-anchor\" href=\"#这个age的输出应该是多少\">¶</a>这个age的输出应该是多少?</h4>\n<h4 id=\"不妨可以多尝试几次-结果\"><a class=\"header-anchor\" href=\"#不妨可以多尝试几次-结果\">¶</a>不妨可以多尝试几次,结果:</h4>\n<blockquote>\n<p>100/99/98都有可能.</p>\n</blockquote>\n<h3 id=\"What-Lock难道不是加锁的么\"><a class=\"header-anchor\" href=\"#What-Lock难道不是加锁的么\">¶</a>What? Lock难道不是加锁的么</h3>\n<blockquote>\n<p>Lock加锁难道不是这么用的么,颠覆认知!</p>\n</blockquote>\n<h4 id=\"Lock源码\"><a class=\"header-anchor\" href=\"#Lock源码\">¶</a>Lock源码:</h4>\n<p><em>A Mutex must not be copied after first use</em></p>\n<h3 id=\"根源\"><a class=\"header-anchor\" href=\"#根源\">¶</a>根源:</h3>\n<ul>\n<li>Go参数传递属于值传递</li>\n<li>Mutex复制后中的state属于前一状态,没有改变</li>\n<li>Mutex中的Lock和Unlock「方法」属于指针类型<sup>图1</sup></li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210102_102753.png\" alt=\"\"><br>\n<strong><center>图<sup>1</sup></center></strong></p>\n<h3 id=\"解决办法\"><a class=\"header-anchor\" href=\"#解决办法\">¶</a>解决办法</h3>\n<ul>\n<li>当然是参考源码,「图1」</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">缺点:</span><br><span class=\"line\">    每次使用之前需要初始化,毕竟是指针类型的</span><br><span class=\"line\"></span><br><span class=\"line\">优点:</span><br><span class=\"line\">    设计源于源码,追随Go的设计.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>加锁的地方尽量是全局的</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这个就不分析了,毕竟不适用所有场景.</span><br><span class=\"line\"></span><br><span class=\"line\">不适用的场景:</span><br><span class=\"line\">    临时的Map需要加锁,如果用全局锁,则效率降低.</span><br></pre></td></tr></table></figure>\n<h3 id=\"Sync包不可复制性\"><a class=\"header-anchor\" href=\"#Sync包不可复制性\">¶</a>Sync包不可复制性</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用sync包下的功能,可能得注意了,都是不可复制的.</span><br></pre></td></tr></table></figure>\n<h3 id=\"End\"><a class=\"header-anchor\" href=\"#End\">¶</a>End</h3>\n<blockquote>\n<p>每次看源码,都会有不一样的收获.「也许是我理解能力差哈」</p>\n</blockquote>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210102_102753.png","popularPost_tmp_gaData":{"updated":"Sat Jan 02 2021 21:00:17 GMT+0800 (中国标准时间)","title":"「28」sync-mutex传参复制问题","path":"archives/a82ae489.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210102_102753.png","excerpt":"<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"起因\"><a class=\"header-anchor\" href=\"#起因\">¶</a>起因:</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sync.Mutex当参数,值传递后出错.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"现象\"><a class=\"header-anchor\" href=\"#现象\">¶</a>现象:</h3>\n<blockquote>\n<p>不废话,上代码:</p>\n</blockquote>","date":{"_isAMomentObject":true,"_i":"2021-01-02T13:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2021-01-02T13:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day","sync","Mutex"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":907},{"title":"「29」map delete Mem不释放问题","date":"2021-01-06T04:00:17.000Z","updated":"2021-01-06T04:00:17.000Z","keywords":"Go,Map,Hash,delete","abbrlink":"2de36dd7","_content":"\n### Go version:\n\n```go\n7384 ◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n###  最近有这么个坑:\n\n>碰到内存泄露问题，大致是这样的：\n\n* 1、定义一个全局map\n* 2、给里面放值\n* 3、用完之后删除Key/value\n\n### 问题：map删除完key后，Mem有没有被释放？\n\n<!--more-->\n\n\n### 观察内存变化：\n\n#### 情景1: 只删除Map的k/v\n```go\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\t//intMap = nil\n\truntime.GC()\n\tprintMemStats()\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n\n```\n\n##### 输出：\n```go\n2021/01/06 16:12:26 Alloc = 162 TotalAlloc = 162 Sys = 69714 NumGC = 0\n2021/01/06 16:12:26 Alloc = 471 TotalAlloc = 487 Sys = 70290 NumGC = 1\n2021/01/06 16:12:26 8192\n2021/01/06 16:12:26 0\n2021/01/06 16:12:26 Alloc = 473 TotalAlloc = 490 Sys = 70610 NumGC = 2\n2021/01/06 16:12:26 Alloc = 475 TotalAlloc = 494 Sys = 70610 NumGC = 3\n```\n\n\n\n#### 情景2: 删除map的k/v,并置map为nil\n\n```go\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\tintMap = nil\n\truntime.GC()\n\tprintMemStats()\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n\n```\n\n##### 输出：\n```go\n2021/01/06 16:15:40 Alloc = 161 TotalAlloc = 161 Sys = 69714 NumGC = 0\n2021/01/06 16:15:40 Alloc = 469 TotalAlloc = 484 Sys = 71696 NumGC = 1\n2021/01/06 16:15:40 8192\n2021/01/06 16:15:40 0\n2021/01/06 16:15:40 Alloc = 471 TotalAlloc = 488 Sys = 71760 NumGC = 2\n2021/01/06 16:15:40 Alloc = 160 TotalAlloc = 492 Sys = 71760 NumGC = 3\n```\n\n\n#### 情景3: map放在函数中，并删除map的k/v,不置nil\n\n```go\n\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tother()\n\truntime.GC()\n\tprintMemStats()\n}\n\nfunc other(){\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\t//intMap = nil\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n\n```\n\n##### 输出：\n\n```go\n2021/01/06 16:18:35 Alloc = 161 TotalAlloc = 161 Sys = 69458 NumGC = 0\n2021/01/06 16:18:35 Alloc = 469 TotalAlloc = 484 Sys = 71440 NumGC = 1\n2021/01/06 16:18:35 8192\n2021/01/06 16:18:35 0\n2021/01/06 16:18:35 Alloc = 471 TotalAlloc = 488 Sys = 71504 NumGC = 2\n2021/01/06 16:18:35 Alloc = 473 TotalAlloc = 492 Sys = 71504 NumGC = 3\n```\n\n#### 情景4: map放在函数中，并删除map的k/v,map置为nil\n\n```go\n\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tother()\n\truntime.GC()\n\tprintMemStats()\n}\n\nfunc other(){\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\tintMap = nil\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n```\n\n##### 输出：\n```go\n2021/01/06 16:20:02 Alloc = 161 TotalAlloc = 161 Sys = 69714 NumGC = 0\n2021/01/06 16:20:02 Alloc = 469 TotalAlloc = 484 Sys = 70034 NumGC = 1\n2021/01/06 16:20:02 8192\n2021/01/06 16:20:02 0\n2021/01/06 16:20:02 Alloc = 471 TotalAlloc = 488 Sys = 70098 NumGC = 2\n2021/01/06 16:20:02 Alloc = 160 TotalAlloc = 492 Sys = 70098 NumGC = 3\n```\n\n#### 情景5: map定义放在局部变量中：\n\n```go\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tother()\n\truntime.GC()\n\tprintMemStats()\n}\n\nfunc other() {\n\tvar intMap map[int]int\n\tintMap = initMap(intMap)\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\t//intMap = nil\n}\nfunc initMap(intMap map[int]int) map[int]int {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n\treturn intMap\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n```\n\n##### 输出：\n\n```go\n2021/01/06 16:29:54 Alloc = 161 TotalAlloc = 161 Sys = 69458 NumGC = 0\n2021/01/06 16:29:54 Alloc = 469 TotalAlloc = 484 Sys = 71440 NumGC = 1\n2021/01/06 16:29:54 8192\n2021/01/06 16:29:54 0\n2021/01/06 16:29:54 Alloc = 158 TotalAlloc = 488 Sys = 71504 NumGC = 2\n2021/01/06 16:29:54 Alloc = 160 TotalAlloc = 491 Sys = 71504 NumGC = 3\n```\n\n##### 汇编输出：\n\n比较有意思的一行：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_051000.png)\n\n```\nXORL 异或运算符 \n\nXORL AX,AX --->将AX置0值\n```\n\n\n#### delete函数：\n\n```go\n0x0125 00293 (../1126/main.go:26)\tCALL\truntime.mapdelete_fast64(SB)\n```\n\n##### mapdelete_fast64函数作用：\n\n\n[点击Github查看](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/map_fast64.go#L272)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_052140.png)\n\n\n>有意思的是：map的设计就是这样，删除key，只是把这个槽位置empty，并没有释放内存.\n\n### Others:\n\n#### 其它场景：\n\n>场景有很多，这里只是逻列最简单的，至于用指针之类的，有兴趣了再研究研究，方法都是一样的。\n\n#### 汇编代码生成\n* 详细见此文：[「15」Plan9 汇编小记](https://blog.imrcrab.com/archives/2ce846ed.html)","source":"_posts/29-map-delete-Mem不释放问题.md","raw":"---\ntitle: 「29」map delete Mem不释放问题\ndate: '2021/1/6 12:00:17'\nupdated: '2021/1/6 12:00:17'\nkeywords: 'Go,Map,Hash,delete'\ntags:\n  - Day\n  - Go\n  - Map\n  - Hash\nabbrlink: 2de36dd7\n---\n\n### Go version:\n\n```go\n7384 ◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n###  最近有这么个坑:\n\n>碰到内存泄露问题，大致是这样的：\n\n* 1、定义一个全局map\n* 2、给里面放值\n* 3、用完之后删除Key/value\n\n### 问题：map删除完key后，Mem有没有被释放？\n\n<!--more-->\n\n\n### 观察内存变化：\n\n#### 情景1: 只删除Map的k/v\n```go\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\t//intMap = nil\n\truntime.GC()\n\tprintMemStats()\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n\n```\n\n##### 输出：\n```go\n2021/01/06 16:12:26 Alloc = 162 TotalAlloc = 162 Sys = 69714 NumGC = 0\n2021/01/06 16:12:26 Alloc = 471 TotalAlloc = 487 Sys = 70290 NumGC = 1\n2021/01/06 16:12:26 8192\n2021/01/06 16:12:26 0\n2021/01/06 16:12:26 Alloc = 473 TotalAlloc = 490 Sys = 70610 NumGC = 2\n2021/01/06 16:12:26 Alloc = 475 TotalAlloc = 494 Sys = 70610 NumGC = 3\n```\n\n\n\n#### 情景2: 删除map的k/v,并置map为nil\n\n```go\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\tintMap = nil\n\truntime.GC()\n\tprintMemStats()\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n\n```\n\n##### 输出：\n```go\n2021/01/06 16:15:40 Alloc = 161 TotalAlloc = 161 Sys = 69714 NumGC = 0\n2021/01/06 16:15:40 Alloc = 469 TotalAlloc = 484 Sys = 71696 NumGC = 1\n2021/01/06 16:15:40 8192\n2021/01/06 16:15:40 0\n2021/01/06 16:15:40 Alloc = 471 TotalAlloc = 488 Sys = 71760 NumGC = 2\n2021/01/06 16:15:40 Alloc = 160 TotalAlloc = 492 Sys = 71760 NumGC = 3\n```\n\n\n#### 情景3: map放在函数中，并删除map的k/v,不置nil\n\n```go\n\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tother()\n\truntime.GC()\n\tprintMemStats()\n}\n\nfunc other(){\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\t//intMap = nil\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n\n```\n\n##### 输出：\n\n```go\n2021/01/06 16:18:35 Alloc = 161 TotalAlloc = 161 Sys = 69458 NumGC = 0\n2021/01/06 16:18:35 Alloc = 469 TotalAlloc = 484 Sys = 71440 NumGC = 1\n2021/01/06 16:18:35 8192\n2021/01/06 16:18:35 0\n2021/01/06 16:18:35 Alloc = 471 TotalAlloc = 488 Sys = 71504 NumGC = 2\n2021/01/06 16:18:35 Alloc = 473 TotalAlloc = 492 Sys = 71504 NumGC = 3\n```\n\n#### 情景4: map放在函数中，并删除map的k/v,map置为nil\n\n```go\n\nvar intMap map[int]int\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tother()\n\truntime.GC()\n\tprintMemStats()\n}\n\nfunc other(){\n\tinitMap()\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\tintMap = nil\n}\nfunc initMap() {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n```\n\n##### 输出：\n```go\n2021/01/06 16:20:02 Alloc = 161 TotalAlloc = 161 Sys = 69714 NumGC = 0\n2021/01/06 16:20:02 Alloc = 469 TotalAlloc = 484 Sys = 70034 NumGC = 1\n2021/01/06 16:20:02 8192\n2021/01/06 16:20:02 0\n2021/01/06 16:20:02 Alloc = 471 TotalAlloc = 488 Sys = 70098 NumGC = 2\n2021/01/06 16:20:02 Alloc = 160 TotalAlloc = 492 Sys = 70098 NumGC = 3\n```\n\n#### 情景5: map定义放在局部变量中：\n\n```go\nvar cnt = 8192\n\nfunc main() {\n\tprintMemStats()\n\tother()\n\truntime.GC()\n\tprintMemStats()\n}\n\nfunc other() {\n\tvar intMap map[int]int\n\tintMap = initMap(intMap)\n\truntime.GC()\n\tprintMemStats()\n\tlog.Println(len(intMap))\n\tfor i := 0; i < cnt; i++ {\n\t\tdelete(intMap, i)\n\t}\n\tlog.Println(len(intMap))\n\truntime.GC()\n\tprintMemStats()\n\t//intMap = nil\n}\nfunc initMap(intMap map[int]int) map[int]int {\n\tintMap = make(map[int]int, cnt)\n\tfor i := 0; i < cnt; i++ {\n\t\tintMap[i] = i\n\t}\n\treturn intMap\n}\nfunc printMemStats() {\n\tvar m runtime.MemStats\n\truntime.ReadMemStats(&m)\n\tlog.Printf(\"Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n\", m.Alloc/1024, m.TotalAlloc/1024, m.Sys/1024, m.NumGC)\n}\n```\n\n##### 输出：\n\n```go\n2021/01/06 16:29:54 Alloc = 161 TotalAlloc = 161 Sys = 69458 NumGC = 0\n2021/01/06 16:29:54 Alloc = 469 TotalAlloc = 484 Sys = 71440 NumGC = 1\n2021/01/06 16:29:54 8192\n2021/01/06 16:29:54 0\n2021/01/06 16:29:54 Alloc = 158 TotalAlloc = 488 Sys = 71504 NumGC = 2\n2021/01/06 16:29:54 Alloc = 160 TotalAlloc = 491 Sys = 71504 NumGC = 3\n```\n\n##### 汇编输出：\n\n比较有意思的一行：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_051000.png)\n\n```\nXORL 异或运算符 \n\nXORL AX,AX --->将AX置0值\n```\n\n\n#### delete函数：\n\n```go\n0x0125 00293 (../1126/main.go:26)\tCALL\truntime.mapdelete_fast64(SB)\n```\n\n##### mapdelete_fast64函数作用：\n\n\n[点击Github查看](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/map_fast64.go#L272)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_052140.png)\n\n\n>有意思的是：map的设计就是这样，删除key，只是把这个槽位置empty，并没有释放内存.\n\n### Others:\n\n#### 其它场景：\n\n>场景有很多，这里只是逻列最简单的，至于用指针之类的，有兴趣了再研究研究，方法都是一样的。\n\n#### 汇编代码生成\n* 详细见此文：[「15」Plan9 汇编小记](https://blog.imrcrab.com/archives/2ce846ed.html)","slug":"29-map-delete-Mem不释放问题","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdle001m3ci778hbgpdu","content":"<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"最近有这么个坑\"><a class=\"header-anchor\" href=\"#最近有这么个坑\">¶</a>最近有这么个坑:</h3>\n<blockquote>\n<p>碰到内存泄露问题，大致是这样的：</p>\n</blockquote>\n<ul>\n<li>1、定义一个全局map</li>\n<li>2、给里面放值</li>\n<li>3、用完之后删除Key/value</li>\n</ul>\n<h3 id=\"问题：map删除完key后，Mem有没有被释放？\"><a class=\"header-anchor\" href=\"#问题：map删除完key后，Mem有没有被释放？\">¶</a>问题：map删除完key后，Mem有没有被释放？</h3>\n<a id=\"more\"></a>\n<h3 id=\"观察内存变化：\"><a class=\"header-anchor\" href=\"#观察内存变化：\">¶</a>观察内存变化：</h3>\n<h4 id=\"情景1-只删除Map的k-v\"><a class=\"header-anchor\" href=\"#情景1-只删除Map的k-v\">¶</a>情景1: 只删除Map的k/v</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\t<span class=\"comment\">//intMap = nil</span></span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：\"><a class=\"header-anchor\" href=\"#输出：\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">162</span> TotalAlloc = <span class=\"number\">162</span> Sys = <span class=\"number\">69714</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">487</span> Sys = <span class=\"number\">70290</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">473</span> TotalAlloc = <span class=\"number\">490</span> Sys = <span class=\"number\">70610</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">475</span> TotalAlloc = <span class=\"number\">494</span> Sys = <span class=\"number\">70610</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景2-删除map的k-v-并置map为nil\"><a class=\"header-anchor\" href=\"#情景2-删除map的k-v-并置map为nil\">¶</a>情景2: 删除map的k/v,并置map为nil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tintMap = <span class=\"literal\">nil</span></span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v2\"><a class=\"header-anchor\" href=\"#输出：-v2\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69714</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">71696</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">71760</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">160</span> TotalAlloc = <span class=\"number\">492</span> Sys = <span class=\"number\">71760</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景3-map放在函数中，并删除map的k-v-不置nil\"><a class=\"header-anchor\" href=\"#情景3-map放在函数中，并删除map的k-v-不置nil\">¶</a>情景3: map放在函数中，并删除map的k/v,不置nil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tother()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">other</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\t<span class=\"comment\">//intMap = nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v3\"><a class=\"header-anchor\" href=\"#输出：-v3\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69458</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">71440</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">473</span> TotalAlloc = <span class=\"number\">492</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景4-map放在函数中，并删除map的k-v-map置为nil\"><a class=\"header-anchor\" href=\"#情景4-map放在函数中，并删除map的k-v-map置为nil\">¶</a>情景4: map放在函数中，并删除map的k/v,map置为nil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tother()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">other</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tintMap = <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v4\"><a class=\"header-anchor\" href=\"#输出：-v4\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69714</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">70034</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">70098</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">160</span> TotalAlloc = <span class=\"number\">492</span> Sys = <span class=\"number\">70098</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景5-map定义放在局部变量中：\"><a class=\"header-anchor\" href=\"#情景5-map定义放在局部变量中：\">¶</a>情景5: map定义放在局部变量中：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tother()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">other</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\">\tintMap = initMap(intMap)</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\t<span class=\"comment\">//intMap = nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">(intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>)</span> <span class=\"title\">map</span>[<span class=\"title\">int</span>]<span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> intMap</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v5\"><a class=\"header-anchor\" href=\"#输出：-v5\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69458</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">71440</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">158</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">160</span> TotalAlloc = <span class=\"number\">491</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"汇编输出：\"><a class=\"header-anchor\" href=\"#汇编输出：\">¶</a>汇编输出：</h5>\n<p>比较有意思的一行：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_051000.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">XORL 异或运算符 </span><br><span class=\"line\"></span><br><span class=\"line\">XORL AX,AX ---&gt;将AX置0值</span><br></pre></td></tr></table></figure>\n<h4 id=\"delete函数：\"><a class=\"header-anchor\" href=\"#delete函数：\">¶</a>delete函数：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x0125</span> <span class=\"number\">00293</span> (../<span class=\"number\">1126</span>/main.<span class=\"keyword\">go</span>:<span class=\"number\">26</span>)\tCALL\truntime.mapdelete_fast64(SB)</span><br></pre></td></tr></table></figure>\n<h5 id=\"mapdelete-fast64函数作用：\"><a class=\"header-anchor\" href=\"#mapdelete-fast64函数作用：\">¶</a>mapdelete_fast64函数作用：</h5>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/map_fast64.go#L272\">点击Github查看</a></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_052140.png\" alt=\"\"></p>\n<blockquote>\n<p>有意思的是：map的设计就是这样，删除key，只是把这个槽位置empty，并没有释放内存.</p>\n</blockquote>\n<h3 id=\"Others\"><a class=\"header-anchor\" href=\"#Others\">¶</a>Others:</h3>\n<h4 id=\"其它场景：\"><a class=\"header-anchor\" href=\"#其它场景：\">¶</a>其它场景：</h4>\n<blockquote>\n<p>场景有很多，这里只是逻列最简单的，至于用指针之类的，有兴趣了再研究研究，方法都是一样的。</p>\n</blockquote>\n<h4 id=\"汇编代码生成\"><a class=\"header-anchor\" href=\"#汇编代码生成\">¶</a>汇编代码生成</h4>\n<ul>\n<li>详细见此文：<a href=\"https://blog.imrcrab.com/archives/2ce846ed.html\">「15」Plan9 汇编小记</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"最近有这么个坑\"><a class=\"header-anchor\" href=\"#最近有这么个坑\">¶</a>最近有这么个坑:</h3>\n<blockquote>\n<p>碰到内存泄露问题，大致是这样的：</p>\n</blockquote>\n<ul>\n<li>1、定义一个全局map</li>\n<li>2、给里面放值</li>\n<li>3、用完之后删除Key/value</li>\n</ul>\n<h3 id=\"问题：map删除完key后，Mem有没有被释放？\"><a class=\"header-anchor\" href=\"#问题：map删除完key后，Mem有没有被释放？\">¶</a>问题：map删除完key后，Mem有没有被释放？</h3>","more":"<h3 id=\"观察内存变化：\"><a class=\"header-anchor\" href=\"#观察内存变化：\">¶</a>观察内存变化：</h3>\n<h4 id=\"情景1-只删除Map的k-v\"><a class=\"header-anchor\" href=\"#情景1-只删除Map的k-v\">¶</a>情景1: 只删除Map的k/v</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\t<span class=\"comment\">//intMap = nil</span></span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：\"><a class=\"header-anchor\" href=\"#输出：\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">162</span> TotalAlloc = <span class=\"number\">162</span> Sys = <span class=\"number\">69714</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">487</span> Sys = <span class=\"number\">70290</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">473</span> TotalAlloc = <span class=\"number\">490</span> Sys = <span class=\"number\">70610</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">12</span>:<span class=\"number\">26</span> Alloc = <span class=\"number\">475</span> TotalAlloc = <span class=\"number\">494</span> Sys = <span class=\"number\">70610</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景2-删除map的k-v-并置map为nil\"><a class=\"header-anchor\" href=\"#情景2-删除map的k-v-并置map为nil\">¶</a>情景2: 删除map的k/v,并置map为nil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tintMap = <span class=\"literal\">nil</span></span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v2\"><a class=\"header-anchor\" href=\"#输出：-v2\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69714</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">71696</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">71760</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">15</span>:<span class=\"number\">40</span> Alloc = <span class=\"number\">160</span> TotalAlloc = <span class=\"number\">492</span> Sys = <span class=\"number\">71760</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景3-map放在函数中，并删除map的k-v-不置nil\"><a class=\"header-anchor\" href=\"#情景3-map放在函数中，并删除map的k-v-不置nil\">¶</a>情景3: map放在函数中，并删除map的k/v,不置nil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tother()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">other</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\t<span class=\"comment\">//intMap = nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v3\"><a class=\"header-anchor\" href=\"#输出：-v3\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69458</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">71440</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">18</span>:<span class=\"number\">35</span> Alloc = <span class=\"number\">473</span> TotalAlloc = <span class=\"number\">492</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景4-map放在函数中，并删除map的k-v-map置为nil\"><a class=\"header-anchor\" href=\"#情景4-map放在函数中，并删除map的k-v-map置为nil\">¶</a>情景4: map放在函数中，并删除map的k/v,map置为nil</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tother()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">other</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\tinitMap()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tintMap = <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v4\"><a class=\"header-anchor\" href=\"#输出：-v4\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69714</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">70034</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">471</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">70098</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">20</span>:<span class=\"number\">02</span> Alloc = <span class=\"number\">160</span> TotalAlloc = <span class=\"number\">492</span> Sys = <span class=\"number\">70098</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"情景5-map定义放在局部变量中：\"><a class=\"header-anchor\" href=\"#情景5-map定义放在局部变量中：\">¶</a>情景5: map定义放在局部变量中：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> cnt = <span class=\"number\">8192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tother()</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">other</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span></span><br><span class=\"line\">\tintMap = initMap(intMap)</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">delete</span>(intMap, i)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlog.Println(<span class=\"built_in\">len</span>(intMap))</span><br><span class=\"line\">\truntime.GC()</span><br><span class=\"line\">\tprintMemStats()</span><br><span class=\"line\">\t<span class=\"comment\">//intMap = nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMap</span><span class=\"params\">(intMap <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>)</span> <span class=\"title\">map</span>[<span class=\"title\">int</span>]<span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\tintMap = <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">int</span>, cnt)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; cnt; i++ &#123;</span><br><span class=\"line\">\t\tintMap[i] = i</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> intMap</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printMemStats</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> m runtime.MemStats</span><br><span class=\"line\">\truntime.ReadMemStats(&amp;m)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">&quot;Alloc = %v TotalAlloc = %v Sys = %v NumGC = %v\\n&quot;</span>, m.Alloc/<span class=\"number\">1024</span>, m.TotalAlloc/<span class=\"number\">1024</span>, m.Sys/<span class=\"number\">1024</span>, m.NumGC)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出：-v5\"><a class=\"header-anchor\" href=\"#输出：-v5\">¶</a>输出：</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">161</span> TotalAlloc = <span class=\"number\">161</span> Sys = <span class=\"number\">69458</span> NumGC = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">469</span> TotalAlloc = <span class=\"number\">484</span> Sys = <span class=\"number\">71440</span> NumGC = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> <span class=\"number\">8192</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">158</span> TotalAlloc = <span class=\"number\">488</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"number\">2021</span>/<span class=\"number\">01</span>/<span class=\"number\">06</span> <span class=\"number\">16</span>:<span class=\"number\">29</span>:<span class=\"number\">54</span> Alloc = <span class=\"number\">160</span> TotalAlloc = <span class=\"number\">491</span> Sys = <span class=\"number\">71504</span> NumGC = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"汇编输出：\"><a class=\"header-anchor\" href=\"#汇编输出：\">¶</a>汇编输出：</h5>\n<p>比较有意思的一行：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_051000.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">XORL 异或运算符 </span><br><span class=\"line\"></span><br><span class=\"line\">XORL AX,AX ---&gt;将AX置0值</span><br></pre></td></tr></table></figure>\n<h4 id=\"delete函数：\"><a class=\"header-anchor\" href=\"#delete函数：\">¶</a>delete函数：</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x0125</span> <span class=\"number\">00293</span> (../<span class=\"number\">1126</span>/main.<span class=\"keyword\">go</span>:<span class=\"number\">26</span>)\tCALL\truntime.mapdelete_fast64(SB)</span><br></pre></td></tr></table></figure>\n<h5 id=\"mapdelete-fast64函数作用：\"><a class=\"header-anchor\" href=\"#mapdelete-fast64函数作用：\">¶</a>mapdelete_fast64函数作用：</h5>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/map_fast64.go#L272\">点击Github查看</a></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_052140.png\" alt=\"\"></p>\n<blockquote>\n<p>有意思的是：map的设计就是这样，删除key，只是把这个槽位置empty，并没有释放内存.</p>\n</blockquote>\n<h3 id=\"Others\"><a class=\"header-anchor\" href=\"#Others\">¶</a>Others:</h3>\n<h4 id=\"其它场景：\"><a class=\"header-anchor\" href=\"#其它场景：\">¶</a>其它场景：</h4>\n<blockquote>\n<p>场景有很多，这里只是逻列最简单的，至于用指针之类的，有兴趣了再研究研究，方法都是一样的。</p>\n</blockquote>\n<h4 id=\"汇编代码生成\"><a class=\"header-anchor\" href=\"#汇编代码生成\">¶</a>汇编代码生成</h4>\n<ul>\n<li>详细见此文：<a href=\"https://blog.imrcrab.com/archives/2ce846ed.html\">「15」Plan9 汇编小记</a></li>\n</ul>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_051000.png","popularPost_tmp_gaData":{"updated":"Wed Jan 06 2021 12:00:17 GMT+0800 (中国标准时间)","title":"「29」map delete Mem不释放问题","path":"archives/2de36dd7.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210106_051000.png","excerpt":"<h3 id=\"Go-version\"><a class=\"header-anchor\" href=\"#Go-version\">¶</a>Go version:</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">7384</span> ◯  <span class=\"keyword\">go</span> version</span><br><span class=\"line\"><span class=\"keyword\">go</span> version go1<span class=\"number\">.14</span><span class=\"number\">.9</span> darwin/amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"最近有这么个坑\"><a class=\"header-anchor\" href=\"#最近有这么个坑\">¶</a>最近有这么个坑:</h3>\n<blockquote>\n<p>碰到内存泄露问题，大致是这样的：</p>\n</blockquote>\n<ul>\n<li>1、定义一个全局map</li>\n<li>2、给里面放值</li>\n<li>3、用完之后删除Key/value</li>\n</ul>\n<h3 id=\"问题：map删除完key后，Mem有没有被释放？\"><a class=\"header-anchor\" href=\"#问题：map删除完key后，Mem有没有被释放？\">¶</a>问题：map删除完key后，Mem有没有被释放？</h3>","date":{"_isAMomentObject":true,"_i":"2021-01-06T04:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2021-01-06T04:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day","Map","Hash"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":5138},{"title":"「3」git cz规范提交","date":"2020-08-31T12:14:33.000Z","updated":"2020-08-31T12:14:33.000Z","keywords":"git,git commit,git提交规范","abbrlink":"458b44c2","_content":"\n### 定义\n\n[官方 specification](https://github.com/commitizen/cz-cli)\n简单的说为了代码提交更加规范\n\n\n### 场景\ngit commit使用\n![](https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png)\n\n### 使用步骤\n* 安装nodejs，版本建议最新.[官网](https://nodejs.org/zh-cn/) \n* 打开你的命令行：\n<!-- more -->\n```\n        输入：npm install -g commitizen\n        windows应该是cmd吧。\n        mac用终端或者iterm2都可以。\n```\n>提示以下信息即成功。\n```\n        -> % sudo npm install -g commitizen\n        Password:\n        npm WARN deprecated resolve-url@0.2.1: https://github.com/lydell/resolve-url#deprecated\n        npm WARN deprecated urix@0.1.0: Please see https://github.com/lydell/urix#deprecated\n        /usr/local/bin/cz -> /usr/local/lib/node_modules/commitizen/bin/git-cz\n        /usr/local/bin/git-cz -> /usr/local/lib/node_modules/commitizen/bin/git-cz\n        /usr/local/bin/commitizen -> /usr/local/lib/node_modules/commitizen/bin/commitizen\n        + commitizen@4.2.1\n        updated 1 package in 8.132s\n```\n3、进入git项目中，执行下面命令初始化环境。\n```commitizen init cz-conventional-changelog --save --save-exact```\n\n4、在提交代码时使用\n>git cz 替换 git commit命令\n\n### 注意事项\n\n* 安装方式可选择全局安装\n```\nnpm install -g commitizen cz-conventional-changelog\necho '{ \"path\": \"cz-conventional-changelog\" }' > ~/.czrc\n\n```","source":"_posts/3-git-cz规范提交.md","raw":"---\ntitle: 「3」git cz规范提交\ndate: '2020/08/31 20:14:33'\nupdated: '2020/08/31 20:14:33'\nkeywords: 'git,git commit,git提交规范'\ntags:\n  - Git\nabbrlink: 458b44c2\n---\n\n### 定义\n\n[官方 specification](https://github.com/commitizen/cz-cli)\n简单的说为了代码提交更加规范\n\n\n### 场景\ngit commit使用\n![](https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png)\n\n### 使用步骤\n* 安装nodejs，版本建议最新.[官网](https://nodejs.org/zh-cn/) \n* 打开你的命令行：\n<!-- more -->\n```\n        输入：npm install -g commitizen\n        windows应该是cmd吧。\n        mac用终端或者iterm2都可以。\n```\n>提示以下信息即成功。\n```\n        -> % sudo npm install -g commitizen\n        Password:\n        npm WARN deprecated resolve-url@0.2.1: https://github.com/lydell/resolve-url#deprecated\n        npm WARN deprecated urix@0.1.0: Please see https://github.com/lydell/urix#deprecated\n        /usr/local/bin/cz -> /usr/local/lib/node_modules/commitizen/bin/git-cz\n        /usr/local/bin/git-cz -> /usr/local/lib/node_modules/commitizen/bin/git-cz\n        /usr/local/bin/commitizen -> /usr/local/lib/node_modules/commitizen/bin/commitizen\n        + commitizen@4.2.1\n        updated 1 package in 8.132s\n```\n3、进入git项目中，执行下面命令初始化环境。\n```commitizen init cz-conventional-changelog --save --save-exact```\n\n4、在提交代码时使用\n>git cz 替换 git commit命令\n\n### 注意事项\n\n* 安装方式可选择全局安装\n```\nnpm install -g commitizen cz-conventional-changelog\necho '{ \"path\": \"cz-conventional-changelog\" }' > ~/.czrc\n\n```","slug":"3-git-cz规范提交","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlf001p3ci7fgrvfw76","content":"<h3 id=\"定义\"><a class=\"header-anchor\" href=\"#定义\">¶</a>定义</h3>\n<p><a href=\"https://github.com/commitizen/cz-cli\">官方 specification</a><br>\n简单的说为了代码提交更加规范</p>\n<h3 id=\"场景\"><a class=\"header-anchor\" href=\"#场景\">¶</a>场景</h3>\n<p>git commit使用<br>\n<img src=\"https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png\" alt=\"\"></p>\n<h3 id=\"使用步骤\"><a class=\"header-anchor\" href=\"#使用步骤\">¶</a>使用步骤</h3>\n<ul>\n<li>安装nodejs，版本建议最新.<a href=\"https://nodejs.org/zh-cn/\">官网</a></li>\n<li>打开你的命令行：</li>\n</ul>\n<a id=\"more\"></a>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">输入：npm install -g commitizen</span><br><span class=\"line\">windows应该是cmd吧。</span><br><span class=\"line\">mac用终端或者iterm2都可以。</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>提示以下信息即成功。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-&gt; % sudo npm install -g commitizen</span><br><span class=\"line\">Password:</span><br><span class=\"line\">npm WARN deprecated resolve-url@0.2.1: https:&#x2F;&#x2F;github.com&#x2F;lydell&#x2F;resolve-url#deprecated</span><br><span class=\"line\">npm WARN deprecated urix@0.1.0: Please see https:&#x2F;&#x2F;github.com&#x2F;lydell&#x2F;urix#deprecated</span><br><span class=\"line\">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;cz -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;git-cz</span><br><span class=\"line\">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;git-cz -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;git-cz</span><br><span class=\"line\">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;commitizen -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;commitizen</span><br><span class=\"line\">+ commitizen@4.2.1</span><br><span class=\"line\">updated 1 package in 8.132s</span><br></pre></td></tr></table></figure>\n<p>3、进入git项目中，执行下面命令初始化环境。<br>\n<code>commitizen init cz-conventional-changelog --save --save-exact</code></p>\n<p>4、在提交代码时使用</p>\n<blockquote>\n<p>git cz 替换 git commit命令</p>\n</blockquote>\n<h3 id=\"注意事项\"><a class=\"header-anchor\" href=\"#注意事项\">¶</a>注意事项</h3>\n<ul>\n<li>安装方式可选择全局安装</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g commitizen cz-conventional-changelog</span><br><span class=\"line\">echo &#39;&#123; &quot;path&quot;: &quot;cz-conventional-changelog&quot; &#125;&#39; &gt; ~&#x2F;.czrc</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<h3 id=\"定义\"><a class=\"header-anchor\" href=\"#定义\">¶</a>定义</h3>\n<p><a href=\"https://github.com/commitizen/cz-cli\">官方 specification</a><br>\n简单的说为了代码提交更加规范</p>\n<h3 id=\"场景\"><a class=\"header-anchor\" href=\"#场景\">¶</a>场景</h3>\n<p>git commit使用<br>\n<img src=\"https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png\" alt=\"\"></p>\n<h3 id=\"使用步骤\"><a class=\"header-anchor\" href=\"#使用步骤\">¶</a>使用步骤</h3>\n<ul>\n<li>安装nodejs，版本建议最新.<a href=\"https://nodejs.org/zh-cn/\">官网</a></li>\n<li>打开你的命令行：</li>\n</ul>","more":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">输入：npm install -g commitizen</span><br><span class=\"line\">windows应该是cmd吧。</span><br><span class=\"line\">mac用终端或者iterm2都可以。</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>提示以下信息即成功。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-&gt; % sudo npm install -g commitizen</span><br><span class=\"line\">Password:</span><br><span class=\"line\">npm WARN deprecated resolve-url@0.2.1: https:&#x2F;&#x2F;github.com&#x2F;lydell&#x2F;resolve-url#deprecated</span><br><span class=\"line\">npm WARN deprecated urix@0.1.0: Please see https:&#x2F;&#x2F;github.com&#x2F;lydell&#x2F;urix#deprecated</span><br><span class=\"line\">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;cz -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;git-cz</span><br><span class=\"line\">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;git-cz -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;git-cz</span><br><span class=\"line\">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;commitizen -&gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;commitizen&#x2F;bin&#x2F;commitizen</span><br><span class=\"line\">+ commitizen@4.2.1</span><br><span class=\"line\">updated 1 package in 8.132s</span><br></pre></td></tr></table></figure>\n<p>3、进入git项目中，执行下面命令初始化环境。<br>\n<code>commitizen init cz-conventional-changelog --save --save-exact</code></p>\n<p>4、在提交代码时使用</p>\n<blockquote>\n<p>git cz 替换 git commit命令</p>\n</blockquote>\n<h3 id=\"注意事项\"><a class=\"header-anchor\" href=\"#注意事项\">¶</a>注意事项</h3>\n<ul>\n<li>安装方式可选择全局安装</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g commitizen cz-conventional-changelog</span><br><span class=\"line\">echo &#39;&#123; &quot;path&quot;: &quot;cz-conventional-changelog&quot; &#125;&#39; &gt; ~&#x2F;.czrc</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png","popularPost_tmp_gaData":{"updated":"Mon Aug 31 2020 20:14:33 GMT+0800 (中国标准时间)","title":"「3」git cz规范提交","path":"archives/458b44c2.html","eyeCatchImage":"https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png","excerpt":"<h3 id=\"定义\"><a class=\"header-anchor\" href=\"#定义\">¶</a>定义</h3>\n<p><a href=\"https://github.com/commitizen/cz-cli\">官方 specification</a><br>\n简单的说为了代码提交更加规范</p>\n<h3 id=\"场景\"><a class=\"header-anchor\" href=\"#场景\">¶</a>场景</h3>\n<p>git commit使用<br>\n<img src=\"https://github.com/commitizen/cz-cli/raw/master/meta/screenshots/add-commit.png\" alt=\"\"></p>\n<h3 id=\"使用步骤\"><a class=\"header-anchor\" href=\"#使用步骤\">¶</a>使用步骤</h3>\n<ul>\n<li>安装nodejs，版本建议最新.<a href=\"https://nodejs.org/zh-cn/\">官网</a></li>\n<li>打开你的命令行：</li>\n</ul>","date":{"_isAMomentObject":true,"_i":"2020-08-31T12:14:33.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-08-31T12:14:33.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Git"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":1103},{"title":"「30」redis rdb源码-1","date":"2021-01-25T14:00:17.000Z","updated":"2021-01-31T14:57:28.000Z","keywords":"redis,RDB","abbrlink":"44b34745","_content":"\n>RDB和AOF常常被提起,好奇RDB这个到底是怎么实现的,这样才能运用的更加灵活和精准.\n### 学完预期的目标:\n* 学习数据异步处理流程 \n* RDB持久化数据的关键过程\n* RDB的缺点\n* RDB适用的场景\n* RDB改进点或bug?\n* 数据持久化,应该是个什么过程?\n<!--more-->\n### 实现流程:\n\n* 这里罗列了几个比较重要的过程:\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/redis-rdb-1.png)\n### rdbSaveKeyValuePair「2021-01-31 22:57:28」\n\n* 错误返回-1,正常返回1,其它返回0\n* 主逻辑只需负责入参和返回值「抽象」\n* 优先级: expire > lru > lfu > [<key,values>]\n\n```c\n/* Save a key-value pair, with expire time, type, key, value.\n * On error -1 is returned.\n * On success if the key was actually saved 1 is returned, otherwise 0\n * is returned (the key was already expired). */\nint rdbSaveKeyValuePair(rio *rdb, robj *key, robj *val, long long expiretime) {\n    int savelru = server.maxmemory_policy & MAXMEMORY_FLAG_LRU;\n    int savelfu = server.maxmemory_policy & MAXMEMORY_FLAG_LFU;\n\n    //  保存过期时间\n    /* Save the expire time */\n    if (expiretime != -1) {\n        if (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) == -1) return -1;\n        if (rdbSaveMillisecondTime(rdb,expiretime) == -1) return -1;\n    }\n\n    // LRU方式保存\n    /* Save the LRU info. */\n    if (savelru) {\n        uint64_t idletime = estimateObjectIdleTime(val);\n        idletime /= 1000; /* Using seconds is enough and requires less space.*/\n        if (rdbSaveType(rdb,RDB_OPCODE_IDLE) == -1) return -1;\n        if (rdbSaveLen(rdb,idletime) == -1) return -1;\n    }\n\n    // LFU方式保存\n    /* Save the LFU info. */\n    if (savelfu) {\n        uint8_t buf[1];\n        buf[0] = LFUDecrAndReturn(val);\n        /* We can encode this in exactly two bytes: the opcode and an 8\n         * bit counter, since the frequency is logarithmic with a 0-255 range.\n         * Note that we do not store the halving time because to reset it\n         * a single time when loading does not affect the frequency much. */\n        if (rdbSaveType(rdb,RDB_OPCODE_FREQ) == -1) return -1;\n        if (rdbWriteRaw(rdb,buf,1) == -1) return -1;\n    }\n\n    // 保存类型、key、value等\n    /* Save type, key, value */\n    if (rdbSaveObjectType(rdb,val) == -1) return -1;\n    if (rdbSaveStringObject(rdb,key) == -1) return -1;\n    if (rdbSaveObject(rdb,val,key) == -1) return -1;\n\n    // 延迟请求\n    /* Delay return if required (for testing) */\n    if (server.rdb_key_save_delay)\n        usleep(server.rdb_key_save_delay);\n\n    return 1;\n}\n\n```\n\n### 待更ing...","source":"_posts/30-redis-rdb数据保存.md","raw":"---\ntitle: 「30」redis rdb源码-1\ndate: '2021/1/25 22:00:17'\nupdated: '2021/01/31 22:57:28'\nkeywords: 'redis,RDB'\ntags:\n  - Day\n  - Redis\n  - RDB\n  - 源码\nabbrlink: 44b34745\n---\n\n>RDB和AOF常常被提起,好奇RDB这个到底是怎么实现的,这样才能运用的更加灵活和精准.\n### 学完预期的目标:\n* 学习数据异步处理流程 \n* RDB持久化数据的关键过程\n* RDB的缺点\n* RDB适用的场景\n* RDB改进点或bug?\n* 数据持久化,应该是个什么过程?\n<!--more-->\n### 实现流程:\n\n* 这里罗列了几个比较重要的过程:\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/redis-rdb-1.png)\n### rdbSaveKeyValuePair「2021-01-31 22:57:28」\n\n* 错误返回-1,正常返回1,其它返回0\n* 主逻辑只需负责入参和返回值「抽象」\n* 优先级: expire > lru > lfu > [<key,values>]\n\n```c\n/* Save a key-value pair, with expire time, type, key, value.\n * On error -1 is returned.\n * On success if the key was actually saved 1 is returned, otherwise 0\n * is returned (the key was already expired). */\nint rdbSaveKeyValuePair(rio *rdb, robj *key, robj *val, long long expiretime) {\n    int savelru = server.maxmemory_policy & MAXMEMORY_FLAG_LRU;\n    int savelfu = server.maxmemory_policy & MAXMEMORY_FLAG_LFU;\n\n    //  保存过期时间\n    /* Save the expire time */\n    if (expiretime != -1) {\n        if (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) == -1) return -1;\n        if (rdbSaveMillisecondTime(rdb,expiretime) == -1) return -1;\n    }\n\n    // LRU方式保存\n    /* Save the LRU info. */\n    if (savelru) {\n        uint64_t idletime = estimateObjectIdleTime(val);\n        idletime /= 1000; /* Using seconds is enough and requires less space.*/\n        if (rdbSaveType(rdb,RDB_OPCODE_IDLE) == -1) return -1;\n        if (rdbSaveLen(rdb,idletime) == -1) return -1;\n    }\n\n    // LFU方式保存\n    /* Save the LFU info. */\n    if (savelfu) {\n        uint8_t buf[1];\n        buf[0] = LFUDecrAndReturn(val);\n        /* We can encode this in exactly two bytes: the opcode and an 8\n         * bit counter, since the frequency is logarithmic with a 0-255 range.\n         * Note that we do not store the halving time because to reset it\n         * a single time when loading does not affect the frequency much. */\n        if (rdbSaveType(rdb,RDB_OPCODE_FREQ) == -1) return -1;\n        if (rdbWriteRaw(rdb,buf,1) == -1) return -1;\n    }\n\n    // 保存类型、key、value等\n    /* Save type, key, value */\n    if (rdbSaveObjectType(rdb,val) == -1) return -1;\n    if (rdbSaveStringObject(rdb,key) == -1) return -1;\n    if (rdbSaveObject(rdb,val,key) == -1) return -1;\n\n    // 延迟请求\n    /* Delay return if required (for testing) */\n    if (server.rdb_key_save_delay)\n        usleep(server.rdb_key_save_delay);\n\n    return 1;\n}\n\n```\n\n### 待更ing...","slug":"30-redis-rdb数据保存","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlg001r3ci7af6t2ddz","content":"<blockquote>\n<p>RDB和AOF常常被提起,好奇RDB这个到底是怎么实现的,这样才能运用的更加灵活和精准.</p>\n</blockquote>\n<h3 id=\"学完预期的目标\"><a class=\"header-anchor\" href=\"#学完预期的目标\">¶</a>学完预期的目标:</h3>\n<ul>\n<li>学习数据异步处理流程</li>\n<li>RDB持久化数据的关键过程</li>\n<li>RDB的缺点</li>\n<li>RDB适用的场景</li>\n<li>RDB改进点或bug?</li>\n<li>数据持久化,应该是个什么过程?</li>\n</ul>\n<a id=\"more\"></a>\n<h3 id=\"实现流程\"><a class=\"header-anchor\" href=\"#实现流程\">¶</a>实现流程:</h3>\n<ul>\n<li>这里罗列了几个比较重要的过程:</li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/redis-rdb-1.png\" alt=\"\"></p>\n<h3 id=\"rdbSaveKeyValuePair「2021-01-31-22-57-28」\"><a class=\"header-anchor\" href=\"#rdbSaveKeyValuePair「2021-01-31-22-57-28」\">¶</a>rdbSaveKeyValuePair「2021-01-31 22:57:28」</h3>\n<ul>\n<li>错误返回-1,正常返回1,其它返回0</li>\n<li>主逻辑只需负责入参和返回值「抽象」</li>\n<li>优先级: expire &gt; lru &gt; lfu &gt; [&lt;key,values&gt;]</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Save a key-value pair, with expire time, type, key, value.</span></span><br><span class=\"line\"><span class=\"comment\"> * On error -1 is returned.</span></span><br><span class=\"line\"><span class=\"comment\"> * On success if the key was actually saved 1 is returned, otherwise 0</span></span><br><span class=\"line\"><span class=\"comment\"> * is returned (the key was already expired). */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">rdbSaveKeyValuePair</span><span class=\"params\">(rio *rdb, robj *key, robj *val, <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> expiretime)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> savelru = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LRU;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> savelfu = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  保存过期时间</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save the expire time */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (expiretime != <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveMillisecondTime(rdb,expiretime) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// LRU方式保存</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save the LRU info. */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (savelru) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint64_t</span> idletime = estimateObjectIdleTime(val);</span><br><span class=\"line\">        idletime /= <span class=\"number\">1000</span>; <span class=\"comment\">/* Using seconds is enough and requires less space.*/</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveType(rdb,RDB_OPCODE_IDLE) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveLen(rdb,idletime) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// LFU方式保存</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save the LFU info. */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (savelfu) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint8_t</span> buf[<span class=\"number\">1</span>];</span><br><span class=\"line\">        buf[<span class=\"number\">0</span>] = LFUDecrAndReturn(val);</span><br><span class=\"line\">        <span class=\"comment\">/* We can encode this in exactly two bytes: the opcode and an 8</span></span><br><span class=\"line\"><span class=\"comment\">         * bit counter, since the frequency is logarithmic with a 0-255 range.</span></span><br><span class=\"line\"><span class=\"comment\">         * Note that we do not store the halving time because to reset it</span></span><br><span class=\"line\"><span class=\"comment\">         * a single time when loading does not affect the frequency much. */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveType(rdb,RDB_OPCODE_FREQ) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbWriteRaw(rdb,buf,<span class=\"number\">1</span>) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 保存类型、key、value等</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save type, key, value */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rdbSaveObjectType(rdb,val) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rdbSaveStringObject(rdb,key) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rdbSaveObject(rdb,val,key) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 延迟请求</span></span><br><span class=\"line\">    <span class=\"comment\">/* Delay return if required (for testing) */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (server.rdb_key_save_delay)</span><br><span class=\"line\">        usleep(server.rdb_key_save_delay);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"待更ing…\"><a class=\"header-anchor\" href=\"#待更ing…\">¶</a>待更ing…</h3>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>RDB和AOF常常被提起,好奇RDB这个到底是怎么实现的,这样才能运用的更加灵活和精准.</p>\n</blockquote>\n<h3 id=\"学完预期的目标\"><a class=\"header-anchor\" href=\"#学完预期的目标\">¶</a>学完预期的目标:</h3>\n<ul>\n<li>学习数据异步处理流程</li>\n<li>RDB持久化数据的关键过程</li>\n<li>RDB的缺点</li>\n<li>RDB适用的场景</li>\n<li>RDB改进点或bug?</li>\n<li>数据持久化,应该是个什么过程?</li>\n</ul>","more":"<h3 id=\"实现流程\"><a class=\"header-anchor\" href=\"#实现流程\">¶</a>实现流程:</h3>\n<ul>\n<li>这里罗列了几个比较重要的过程:</li>\n</ul>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/redis-rdb-1.png\" alt=\"\"></p>\n<h3 id=\"rdbSaveKeyValuePair「2021-01-31-22-57-28」\"><a class=\"header-anchor\" href=\"#rdbSaveKeyValuePair「2021-01-31-22-57-28」\">¶</a>rdbSaveKeyValuePair「2021-01-31 22:57:28」</h3>\n<ul>\n<li>错误返回-1,正常返回1,其它返回0</li>\n<li>主逻辑只需负责入参和返回值「抽象」</li>\n<li>优先级: expire &gt; lru &gt; lfu &gt; [&lt;key,values&gt;]</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Save a key-value pair, with expire time, type, key, value.</span></span><br><span class=\"line\"><span class=\"comment\"> * On error -1 is returned.</span></span><br><span class=\"line\"><span class=\"comment\"> * On success if the key was actually saved 1 is returned, otherwise 0</span></span><br><span class=\"line\"><span class=\"comment\"> * is returned (the key was already expired). */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">rdbSaveKeyValuePair</span><span class=\"params\">(rio *rdb, robj *key, robj *val, <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> expiretime)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> savelru = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LRU;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> savelfu = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//  保存过期时间</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save the expire time */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (expiretime != <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveMillisecondTime(rdb,expiretime) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// LRU方式保存</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save the LRU info. */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (savelru) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint64_t</span> idletime = estimateObjectIdleTime(val);</span><br><span class=\"line\">        idletime /= <span class=\"number\">1000</span>; <span class=\"comment\">/* Using seconds is enough and requires less space.*/</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveType(rdb,RDB_OPCODE_IDLE) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveLen(rdb,idletime) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// LFU方式保存</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save the LFU info. */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (savelfu) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">uint8_t</span> buf[<span class=\"number\">1</span>];</span><br><span class=\"line\">        buf[<span class=\"number\">0</span>] = LFUDecrAndReturn(val);</span><br><span class=\"line\">        <span class=\"comment\">/* We can encode this in exactly two bytes: the opcode and an 8</span></span><br><span class=\"line\"><span class=\"comment\">         * bit counter, since the frequency is logarithmic with a 0-255 range.</span></span><br><span class=\"line\"><span class=\"comment\">         * Note that we do not store the halving time because to reset it</span></span><br><span class=\"line\"><span class=\"comment\">         * a single time when loading does not affect the frequency much. */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbSaveType(rdb,RDB_OPCODE_FREQ) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (rdbWriteRaw(rdb,buf,<span class=\"number\">1</span>) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 保存类型、key、value等</span></span><br><span class=\"line\">    <span class=\"comment\">/* Save type, key, value */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rdbSaveObjectType(rdb,val) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rdbSaveStringObject(rdb,key) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rdbSaveObject(rdb,val,key) == <span class=\"number\">-1</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 延迟请求</span></span><br><span class=\"line\">    <span class=\"comment\">/* Delay return if required (for testing) */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (server.rdb_key_save_delay)</span><br><span class=\"line\">        usleep(server.rdb_key_save_delay);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"待更ing…\"><a class=\"header-anchor\" href=\"#待更ing…\">¶</a>待更ing…</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/redis-rdb-1.png","popularPost_tmp_gaData":{"updated":"Sun Jan 31 2021 22:57:28 GMT+0800 (中国标准时间)","title":"「30」redis rdb源码-1","path":"archives/44b34745.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/redis-rdb-1.png","excerpt":"<blockquote>\n<p>RDB和AOF常常被提起,好奇RDB这个到底是怎么实现的,这样才能运用的更加灵活和精准.</p>\n</blockquote>\n<h3 id=\"学完预期的目标\"><a class=\"header-anchor\" href=\"#学完预期的目标\">¶</a>学完预期的目标:</h3>\n<ul>\n<li>学习数据异步处理流程</li>\n<li>RDB持久化数据的关键过程</li>\n<li>RDB的缺点</li>\n<li>RDB适用的场景</li>\n<li>RDB改进点或bug?</li>\n<li>数据持久化,应该是个什么过程?</li>\n</ul>","date":{"_isAMomentObject":true,"_i":"2021-01-25T14:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2021-01-25T14:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Day","Redis","RDB","源码"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":1821},{"title":"「31」Float类型易踩的坑","date":"2021-02-04T04:00:17.000Z","updated":"2021-02-04T04:57:28.000Z","keywords":"Go,Float","abbrlink":"cb90ed2a","_content":"\n### 前序\n最近快过年了吧，但是有很多需求要搞，，，，\n\n突然来了个锅，被人投诉说数据统计的有问题，打开电脑一看，float类型的统计，「我慌了，float在统计中一直都很头疼。」\n\n### 触发点\n\n#### 先来看问题吧「写了个例子」：\n\n>下面的结果，a应该是什么值？why？\n\n<!--more-->\n\n>go version go1.14.14 darwin/amd64\n\n```go\nfunc main() {\n\tvar floatNumber float64 = 0\n\n\ta := floatNumber / 0\n\tfmt.Println(a)\n}\n```\n\n##### 输出结果：\n\nNAN\n\n##### why?「究其根源」\n\n[官方解释](https://golang.google.cn/ref/spec#Representability)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210204_030335.png)\n\n\n>简单的说就是 0/0 为负无穷大，所以为 NAN.\n\n### 如何规避？\n\n* 提前判断分母，为0，不计算「根源解决」\n* 利用math.IsNaN(xxx)，选择性跳过。 「治标」\n\n### 拓展：\n\n#### 下面这个输出什么？\n\n\n```go\nfunc main() {\n\tvar number int\n\tfmt.Println(number / 0)\n}\n```\n\n##### 输出结果：\n\n> division by zero\n\n##### why?\n\n* 除数不能为0.\n\n#### 关于float类型\n\n```html\n这么简单，估计会被说很菜，，，，\n\n关于float类型的使用和注意事项「和语言无关」，一直都很零散，下来整理下，系统性的学习学习。\n```\n\n### END\n\n快过年了，提前预祝大家新年快乐。。。。\n\n🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨","source":"_posts/31-float类型易踩的坑.md","raw":"---\ntitle: 「31」Float类型易踩的坑\ndate: '2021/02/04 12:00:17'\nupdated: '2021/02/04 12:57:28'\nkeywords: 'Go,Float'\ntags:\n  - Day\n  - Go\n  - Golang\n  - Float\n  - IEEE\nabbrlink: cb90ed2a\n---\n\n### 前序\n最近快过年了吧，但是有很多需求要搞，，，，\n\n突然来了个锅，被人投诉说数据统计的有问题，打开电脑一看，float类型的统计，「我慌了，float在统计中一直都很头疼。」\n\n### 触发点\n\n#### 先来看问题吧「写了个例子」：\n\n>下面的结果，a应该是什么值？why？\n\n<!--more-->\n\n>go version go1.14.14 darwin/amd64\n\n```go\nfunc main() {\n\tvar floatNumber float64 = 0\n\n\ta := floatNumber / 0\n\tfmt.Println(a)\n}\n```\n\n##### 输出结果：\n\nNAN\n\n##### why?「究其根源」\n\n[官方解释](https://golang.google.cn/ref/spec#Representability)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210204_030335.png)\n\n\n>简单的说就是 0/0 为负无穷大，所以为 NAN.\n\n### 如何规避？\n\n* 提前判断分母，为0，不计算「根源解决」\n* 利用math.IsNaN(xxx)，选择性跳过。 「治标」\n\n### 拓展：\n\n#### 下面这个输出什么？\n\n\n```go\nfunc main() {\n\tvar number int\n\tfmt.Println(number / 0)\n}\n```\n\n##### 输出结果：\n\n> division by zero\n\n##### why?\n\n* 除数不能为0.\n\n#### 关于float类型\n\n```html\n这么简单，估计会被说很菜，，，，\n\n关于float类型的使用和注意事项「和语言无关」，一直都很零散，下来整理下，系统性的学习学习。\n```\n\n### END\n\n快过年了，提前预祝大家新年快乐。。。。\n\n🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨","slug":"31-float类型易踩的坑","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlh001t3ci7a98608xl","content":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>最近快过年了吧，但是有很多需求要搞，，，，</p>\n<p>突然来了个锅，被人投诉说数据统计的有问题，打开电脑一看，float类型的统计，「我慌了，float在统计中一直都很头疼。」</p>\n<h3 id=\"触发点\"><a class=\"header-anchor\" href=\"#触发点\">¶</a>触发点</h3>\n<h4 id=\"先来看问题吧「写了个例子」：\"><a class=\"header-anchor\" href=\"#先来看问题吧「写了个例子」：\">¶</a>先来看问题吧「写了个例子」：</h4>\n<blockquote>\n<p>下面的结果，a应该是什么值？why？</p>\n</blockquote>\n<a id=\"more\"></a>\n<blockquote>\n<p>go version go1.14.14 darwin/amd64</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> floatNumber <span class=\"keyword\">float64</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\ta := floatNumber / <span class=\"number\">0</span></span><br><span class=\"line\">\tfmt.Println(a)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出结果：\"><a class=\"header-anchor\" href=\"#输出结果：\">¶</a>输出结果：</h5>\n<p>NAN</p>\n<h5 id=\"why-「究其根源」\"><a class=\"header-anchor\" href=\"#why-「究其根源」\">¶</a>why?「究其根源」</h5>\n<p><a href=\"https://golang.google.cn/ref/spec#Representability\">官方解释</a></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210204_030335.png\" alt=\"\"></p>\n<blockquote>\n<p>简单的说就是 0/0 为负无穷大，所以为 NAN.</p>\n</blockquote>\n<h3 id=\"如何规避？\"><a class=\"header-anchor\" href=\"#如何规避？\">¶</a>如何规避？</h3>\n<ul>\n<li>提前判断分母，为0，不计算「根源解决」</li>\n<li>利用math.IsNaN(xxx)，选择性跳过。 「治标」</li>\n</ul>\n<h3 id=\"拓展：\"><a class=\"header-anchor\" href=\"#拓展：\">¶</a>拓展：</h3>\n<h4 id=\"下面这个输出什么？\"><a class=\"header-anchor\" href=\"#下面这个输出什么？\">¶</a>下面这个输出什么？</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> number <span class=\"keyword\">int</span></span><br><span class=\"line\">\tfmt.Println(number / <span class=\"number\">0</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出结果：-v2\"><a class=\"header-anchor\" href=\"#输出结果：-v2\">¶</a>输出结果：</h5>\n<blockquote>\n<p>division by zero</p>\n</blockquote>\n<h5 id=\"why\"><a class=\"header-anchor\" href=\"#why\">¶</a>why?</h5>\n<ul>\n<li>除数不能为0.</li>\n</ul>\n<h4 id=\"关于float类型\"><a class=\"header-anchor\" href=\"#关于float类型\">¶</a>关于float类型</h4>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这么简单，估计会被说很菜，，，，</span><br><span class=\"line\"></span><br><span class=\"line\">关于float类型的使用和注意事项「和语言无关」，一直都很零散，下来整理下，系统性的学习学习。</span><br></pre></td></tr></table></figure>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n<p>快过年了，提前预祝大家新年快乐。。。。</p>\n<p>🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨</p>\n","site":{"data":{}},"excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>最近快过年了吧，但是有很多需求要搞，，，，</p>\n<p>突然来了个锅，被人投诉说数据统计的有问题，打开电脑一看，float类型的统计，「我慌了，float在统计中一直都很头疼。」</p>\n<h3 id=\"触发点\"><a class=\"header-anchor\" href=\"#触发点\">¶</a>触发点</h3>\n<h4 id=\"先来看问题吧「写了个例子」：\"><a class=\"header-anchor\" href=\"#先来看问题吧「写了个例子」：\">¶</a>先来看问题吧「写了个例子」：</h4>\n<blockquote>\n<p>下面的结果，a应该是什么值？why？</p>\n</blockquote>","more":"<blockquote>\n<p>go version go1.14.14 darwin/amd64</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> floatNumber <span class=\"keyword\">float64</span> = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\ta := floatNumber / <span class=\"number\">0</span></span><br><span class=\"line\">\tfmt.Println(a)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出结果：\"><a class=\"header-anchor\" href=\"#输出结果：\">¶</a>输出结果：</h5>\n<p>NAN</p>\n<h5 id=\"why-「究其根源」\"><a class=\"header-anchor\" href=\"#why-「究其根源」\">¶</a>why?「究其根源」</h5>\n<p><a href=\"https://golang.google.cn/ref/spec#Representability\">官方解释</a></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210204_030335.png\" alt=\"\"></p>\n<blockquote>\n<p>简单的说就是 0/0 为负无穷大，所以为 NAN.</p>\n</blockquote>\n<h3 id=\"如何规避？\"><a class=\"header-anchor\" href=\"#如何规避？\">¶</a>如何规避？</h3>\n<ul>\n<li>提前判断分母，为0，不计算「根源解决」</li>\n<li>利用math.IsNaN(xxx)，选择性跳过。 「治标」</li>\n</ul>\n<h3 id=\"拓展：\"><a class=\"header-anchor\" href=\"#拓展：\">¶</a>拓展：</h3>\n<h4 id=\"下面这个输出什么？\"><a class=\"header-anchor\" href=\"#下面这个输出什么？\">¶</a>下面这个输出什么？</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> number <span class=\"keyword\">int</span></span><br><span class=\"line\">\tfmt.Println(number / <span class=\"number\">0</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"输出结果：-v2\"><a class=\"header-anchor\" href=\"#输出结果：-v2\">¶</a>输出结果：</h5>\n<blockquote>\n<p>division by zero</p>\n</blockquote>\n<h5 id=\"why\"><a class=\"header-anchor\" href=\"#why\">¶</a>why?</h5>\n<ul>\n<li>除数不能为0.</li>\n</ul>\n<h4 id=\"关于float类型\"><a class=\"header-anchor\" href=\"#关于float类型\">¶</a>关于float类型</h4>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这么简单，估计会被说很菜，，，，</span><br><span class=\"line\"></span><br><span class=\"line\">关于float类型的使用和注意事项「和语言无关」，一直都很零散，下来整理下，系统性的学习学习。</span><br></pre></td></tr></table></figure>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n<p>快过年了，提前预祝大家新年快乐。。。。</p>\n<p>🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨🧨</p>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210204_030335.png","popularPost_tmp_gaData":{"updated":"Thu Feb 04 2021 12:57:28 GMT+0800 (中国标准时间)","title":"「31」Float类型易踩的坑","path":"archives/cb90ed2a.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/clipboard_20210204_030335.png","excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>最近快过年了吧，但是有很多需求要搞，，，，</p>\n<p>突然来了个锅，被人投诉说数据统计的有问题，打开电脑一看，float类型的统计，「我慌了，float在统计中一直都很头疼。」</p>\n<h3 id=\"触发点\"><a class=\"header-anchor\" href=\"#触发点\">¶</a>触发点</h3>\n<h4 id=\"先来看问题吧「写了个例子」：\"><a class=\"header-anchor\" href=\"#先来看问题吧「写了个例子」：\">¶</a>先来看问题吧「写了个例子」：</h4>\n<blockquote>\n<p>下面的结果，a应该是什么值？why？</p>\n</blockquote>","date":{"_isAMomentObject":true,"_i":"2021-02-04T04:00:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2021-02-04T04:00:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day","Golang","Float","IEEE"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":566},{"title":"「32」Go  Ticker 内存泄露","date":"2021-02-04T04:01:17.000Z","updated":"2021-02-04T04:01:17.000Z","keywords":"time,zone,Go,ticker,定时器","abbrlink":"53e1932f","_content":"\n### 前序：\n不知道你们有没有经历过这种情况：\n>测试示例图片：\n\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp)\n\n<!--more-->\n\n>说的简单点：内存炸了呗....OOM\n\n\n### 引言\n\n>go version go1.14.14 darwin/amd64\n\n```go\n最近的坑是真的多，当然这种坑在大项目中，一不小心就写出来了,\n\n人多，项目大，各种各样的花式操作都出来了,在所难免，\n能做的就是分析问题，总结，记录，防止下次自己犯错，同时也可以加深理解。\n```\n\n### 起因：\n\n```go\nfunc XXX() {\n    // 业务代码 几十行...\n    for i:=0;i<100000;i++{\n\t    ticker := time.NewTicker(10 * time.Second)\n\t\tdefer func() {\n            //模拟业务代码\n\t\t\tfmt.Println(\"defer close\")\n\t\t}()\n\t\tgo func(){\n            for {\n                select {\n                case <-ticker.C:\n                // 业务代码.....\n                    fmt.Println(\"time 5\")\n                case <-doneChan:\n                    return\n\t\t\t}\n\t\t}\n        }()\n\n        \n    }\n    // 业务代码 几十行...\n    return\n}\n```\n\n#### 发生了什么？\n\n>上面的代码，不晓得看出来什么问题了么.....\n\n### 关键点：\n\nticker没有stop\n\n[官方解释](https://github.com/golang/go/blob/master/src/time/tick.go#L62)\n\n#### Ticker不能被回收导致\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_053201.webp)\n\n\n#### 为何不能被回收？\n\n##### NewTicker实现：\n\n[NewTicker官方实现](https://github.com/golang/go/blob/master/src/time/tick.go#L39)\n\n\n[startTimer底层实现](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203)\n\n###### addtimer\n```go\n// addtimer adds a timer to the current P.\n// This should only be called with a newly created timer.\n// That avoids the risk of changing the when field of a timer in some P's heap,\n// which could cause the heap to become unsorted.\nfunc addtimer(t *timer) {\n\t// when must never be negative; otherwise runtimer will overflow\n\t// during its delta calculation and never expire other runtime timers.\n\tif t.when < 0 {\n\t\tt.when = maxWhen\n\t}\n\tif t.status != timerNoStatus {\n\t\tthrow(\"addtimer called with initialized timer\")\n\t}\n\tt.status = timerWaiting\n\n\twhen := t.when\n\n\tpp := getg().m.p.ptr() // 获取当前的P\n\tlock(&pp.timersLock) // 加锁\n\tcleantimers(pp) // 调整p.timers栈顶元素\n\tdoaddtimer(pp, t) // t绑定下p\n\tunlock(&pp.timersLock) \n\n\twakeNetPoller(when)\n}\n```\n\n###### doaddtimer\n\n```go\n// doaddtimer adds t to the current P's heap.\n// The caller must have locked the timers for pp.\nfunc doaddtimer(pp *p, t *timer) {\n\t// Timers rely on the network poller, so make sure the poller\n\t// has started.\n\tif netpollInited == 0 {\n\t\tnetpollGenericInit()\n\t}\n\n\tif t.pp != 0 {\n\t\tthrow(\"doaddtimer: P already set in timer\")\n\t}\n\tt.pp.set(pp)\n\ti := len(pp.timers)\n\tpp.timers = append(pp.timers, t) // p上添加一个timer\n\tsiftupTimer(pp.timers, i) // 堆调整算法\n\tif t == pp.timers[0] {\n\t\tatomic.Store64(&pp.timer0When, uint64(t.when))\n\t}\n\tatomic.Xadd(&pp.numTimers, 1)\n}\n```\n\n\n### 拓展：\n#### cleantimers过程：\n\n* 判断长度\n* 判断上一个timer状态\n\n```go\n// cleantimers cleans up the head of the timer queue. This speeds up\n// programs that create and delete timers; leaving them in the heap\n// slows down addtimer. Reports whether no timer problems were found.\n// The caller must have locked the timers for pp.\nfunc cleantimers(pp *p) {\n\tfor {\n\t\tif len(pp.timers) == 0 { // 判断长度\n\t\t\treturn\n\t\t}\n\t\tt := pp.timers[0] //取第一个\n\t\tif t.pp.ptr() != pp {\n\t\t\tthrow(\"cleantimers: bad p\")\n\t\t}\n\t\tswitch s := atomic.Load(&t.status); s { //需要判断状态\n\t\tcase timerDeleted:\n\t\t\tif !atomic.Cas(&t.status, s, timerRemoving) { //非删除中\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tdodeltimer0(pp) //移除timer0\n\t\t\tif !atomic.Cas(&t.status, timerRemoving, timerRemoved) {\n\t\t\t\tbadTimer()\n\t\t\t}\n\t\t\tatomic.Xadd(&pp.deletedTimers, -1)\n\t\tcase timerModifiedEarlier, timerModifiedLater: // 修改前或者修改后的状态\n\t\t\tif !atomic.Cas(&t.status, s, timerMoving) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// Now we can change the when field.\n\t\t\tt.when = t.nextwhen // 指针后移\n\t\t\t// Move t to the right position.\n\t\t\tdodeltimer0(pp) // 删除最底下的元素\n\t\t\tdoaddtimer(pp, t) // 重新绑定P和t的关系\n\t\t\tif s == timerModifiedEarlier {\n\t\t\t\tatomic.Xadd(&pp.adjustTimers, -1)\n\t\t\t}\n\t\t\tif !atomic.Cas(&t.status, timerMoving, timerWaiting) {\n\t\t\t\tbadTimer()\n\t\t\t}\n\t\tdefault:\n\t\t\t// Head of timers does not need adjustment.\n\t\t\treturn\n\t\t}\n\t}\n}\n```\n\n##### dodeltimer0\n\n```go\n// dodeltimer0 removes timer 0 from the current P's heap.\n// We are locked on the P when this is called.\n// It reports whether it saw no problems due to races.\n// The caller must have locked the timers for pp.\nfunc dodeltimer0(pp *p) {\n\tif t := pp.timers[0]; t.pp.ptr() != pp {\n\t\tthrow(\"dodeltimer0: wrong P\")\n\t} else {\n\t\tt.pp = 0\n\t}\n\tlast := len(pp.timers) - 1 // 获取第一个timers\n\tif last > 0 {\n\t\tpp.timers[0] = pp.timers[last] // 栈底--->栈顶\n\t}\n\tpp.timers[last] = nil // 置空\n\tpp.timers = pp.timers[:last] //重新赋值\n\tif last > 0 {\n\t\tsiftdownTimer(pp.timers, 0)  // 重新排序\n\t}\n\tupdateTimer0When(pp) // 更新P中的when\n\tatomic.Xadd(&pp.numTimers, -1) // 更新数量\n}\n\n```\n\n### 参考\n* [NewTicker官方实现](https://github.com/golang/go/blob/master/src/time/tick.go#L39)\n\n\n* [StartTimer底层实现](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203)\n* atomic\n    * atomic.Store64\n    * atomic.Xadd","source":"_posts/32-go-ticker-内存泄露.md","raw":"---\ntitle: 「32」Go  Ticker 内存泄露\ndate: '2021/2/4 12:01:17'\nupdated: '2021/2/4 12:01:17'\nkeywords: 'time,zone,Go,ticker,定时器'\ntags:\n  - Go\n  - ticker\n  - Day\n  - defer\nabbrlink: 53e1932f\n---\n\n### 前序：\n不知道你们有没有经历过这种情况：\n>测试示例图片：\n\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp)\n\n<!--more-->\n\n>说的简单点：内存炸了呗....OOM\n\n\n### 引言\n\n>go version go1.14.14 darwin/amd64\n\n```go\n最近的坑是真的多，当然这种坑在大项目中，一不小心就写出来了,\n\n人多，项目大，各种各样的花式操作都出来了,在所难免，\n能做的就是分析问题，总结，记录，防止下次自己犯错，同时也可以加深理解。\n```\n\n### 起因：\n\n```go\nfunc XXX() {\n    // 业务代码 几十行...\n    for i:=0;i<100000;i++{\n\t    ticker := time.NewTicker(10 * time.Second)\n\t\tdefer func() {\n            //模拟业务代码\n\t\t\tfmt.Println(\"defer close\")\n\t\t}()\n\t\tgo func(){\n            for {\n                select {\n                case <-ticker.C:\n                // 业务代码.....\n                    fmt.Println(\"time 5\")\n                case <-doneChan:\n                    return\n\t\t\t}\n\t\t}\n        }()\n\n        \n    }\n    // 业务代码 几十行...\n    return\n}\n```\n\n#### 发生了什么？\n\n>上面的代码，不晓得看出来什么问题了么.....\n\n### 关键点：\n\nticker没有stop\n\n[官方解释](https://github.com/golang/go/blob/master/src/time/tick.go#L62)\n\n#### Ticker不能被回收导致\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_053201.webp)\n\n\n#### 为何不能被回收？\n\n##### NewTicker实现：\n\n[NewTicker官方实现](https://github.com/golang/go/blob/master/src/time/tick.go#L39)\n\n\n[startTimer底层实现](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203)\n\n###### addtimer\n```go\n// addtimer adds a timer to the current P.\n// This should only be called with a newly created timer.\n// That avoids the risk of changing the when field of a timer in some P's heap,\n// which could cause the heap to become unsorted.\nfunc addtimer(t *timer) {\n\t// when must never be negative; otherwise runtimer will overflow\n\t// during its delta calculation and never expire other runtime timers.\n\tif t.when < 0 {\n\t\tt.when = maxWhen\n\t}\n\tif t.status != timerNoStatus {\n\t\tthrow(\"addtimer called with initialized timer\")\n\t}\n\tt.status = timerWaiting\n\n\twhen := t.when\n\n\tpp := getg().m.p.ptr() // 获取当前的P\n\tlock(&pp.timersLock) // 加锁\n\tcleantimers(pp) // 调整p.timers栈顶元素\n\tdoaddtimer(pp, t) // t绑定下p\n\tunlock(&pp.timersLock) \n\n\twakeNetPoller(when)\n}\n```\n\n###### doaddtimer\n\n```go\n// doaddtimer adds t to the current P's heap.\n// The caller must have locked the timers for pp.\nfunc doaddtimer(pp *p, t *timer) {\n\t// Timers rely on the network poller, so make sure the poller\n\t// has started.\n\tif netpollInited == 0 {\n\t\tnetpollGenericInit()\n\t}\n\n\tif t.pp != 0 {\n\t\tthrow(\"doaddtimer: P already set in timer\")\n\t}\n\tt.pp.set(pp)\n\ti := len(pp.timers)\n\tpp.timers = append(pp.timers, t) // p上添加一个timer\n\tsiftupTimer(pp.timers, i) // 堆调整算法\n\tif t == pp.timers[0] {\n\t\tatomic.Store64(&pp.timer0When, uint64(t.when))\n\t}\n\tatomic.Xadd(&pp.numTimers, 1)\n}\n```\n\n\n### 拓展：\n#### cleantimers过程：\n\n* 判断长度\n* 判断上一个timer状态\n\n```go\n// cleantimers cleans up the head of the timer queue. This speeds up\n// programs that create and delete timers; leaving them in the heap\n// slows down addtimer. Reports whether no timer problems were found.\n// The caller must have locked the timers for pp.\nfunc cleantimers(pp *p) {\n\tfor {\n\t\tif len(pp.timers) == 0 { // 判断长度\n\t\t\treturn\n\t\t}\n\t\tt := pp.timers[0] //取第一个\n\t\tif t.pp.ptr() != pp {\n\t\t\tthrow(\"cleantimers: bad p\")\n\t\t}\n\t\tswitch s := atomic.Load(&t.status); s { //需要判断状态\n\t\tcase timerDeleted:\n\t\t\tif !atomic.Cas(&t.status, s, timerRemoving) { //非删除中\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tdodeltimer0(pp) //移除timer0\n\t\t\tif !atomic.Cas(&t.status, timerRemoving, timerRemoved) {\n\t\t\t\tbadTimer()\n\t\t\t}\n\t\t\tatomic.Xadd(&pp.deletedTimers, -1)\n\t\tcase timerModifiedEarlier, timerModifiedLater: // 修改前或者修改后的状态\n\t\t\tif !atomic.Cas(&t.status, s, timerMoving) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// Now we can change the when field.\n\t\t\tt.when = t.nextwhen // 指针后移\n\t\t\t// Move t to the right position.\n\t\t\tdodeltimer0(pp) // 删除最底下的元素\n\t\t\tdoaddtimer(pp, t) // 重新绑定P和t的关系\n\t\t\tif s == timerModifiedEarlier {\n\t\t\t\tatomic.Xadd(&pp.adjustTimers, -1)\n\t\t\t}\n\t\t\tif !atomic.Cas(&t.status, timerMoving, timerWaiting) {\n\t\t\t\tbadTimer()\n\t\t\t}\n\t\tdefault:\n\t\t\t// Head of timers does not need adjustment.\n\t\t\treturn\n\t\t}\n\t}\n}\n```\n\n##### dodeltimer0\n\n```go\n// dodeltimer0 removes timer 0 from the current P's heap.\n// We are locked on the P when this is called.\n// It reports whether it saw no problems due to races.\n// The caller must have locked the timers for pp.\nfunc dodeltimer0(pp *p) {\n\tif t := pp.timers[0]; t.pp.ptr() != pp {\n\t\tthrow(\"dodeltimer0: wrong P\")\n\t} else {\n\t\tt.pp = 0\n\t}\n\tlast := len(pp.timers) - 1 // 获取第一个timers\n\tif last > 0 {\n\t\tpp.timers[0] = pp.timers[last] // 栈底--->栈顶\n\t}\n\tpp.timers[last] = nil // 置空\n\tpp.timers = pp.timers[:last] //重新赋值\n\tif last > 0 {\n\t\tsiftdownTimer(pp.timers, 0)  // 重新排序\n\t}\n\tupdateTimer0When(pp) // 更新P中的when\n\tatomic.Xadd(&pp.numTimers, -1) // 更新数量\n}\n\n```\n\n### 参考\n* [NewTicker官方实现](https://github.com/golang/go/blob/master/src/time/tick.go#L39)\n\n\n* [StartTimer底层实现](https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203)\n* atomic\n    * atomic.Store64\n    * atomic.Xadd","slug":"32-go-ticker-内存泄露","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdli001w3ci7fqlo8xh4","content":"<h3 id=\"前序：\"><a class=\"header-anchor\" href=\"#前序：\">¶</a>前序：</h3>\n<p>不知道你们有没有经历过这种情况：</p>\n<blockquote>\n<p>测试示例图片：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp\" alt=\"\"></p>\n<a id=\"more\"></a>\n<blockquote>\n<p>说的简单点：内存炸了呗…OOM</p>\n</blockquote>\n<h3 id=\"引言\"><a class=\"header-anchor\" href=\"#引言\">¶</a>引言</h3>\n<blockquote>\n<p>go version go1.14.14 darwin/amd64</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">最近的坑是真的多，当然这种坑在大项目中，一不小心就写出来了,</span><br><span class=\"line\"></span><br><span class=\"line\">人多，项目大，各种各样的花式操作都出来了,在所难免，</span><br><span class=\"line\">能做的就是分析问题，总结，记录，防止下次自己犯错，同时也可以加深理解。</span><br></pre></td></tr></table></figure>\n<h3 id=\"起因：\"><a class=\"header-anchor\" href=\"#起因：\">¶</a>起因：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">XXX</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 业务代码 几十行...</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i:=<span class=\"number\">0</span>;i&lt;<span class=\"number\">100000</span>;i++&#123;</span><br><span class=\"line\">\t    ticker := time.NewTicker(<span class=\"number\">10</span> * time.Second)</span><br><span class=\"line\">\t\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//模拟业务代码</span></span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">&quot;defer close&quot;</span>)</span><br><span class=\"line\">\t\t&#125;()</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> &lt;-ticker.C:</span><br><span class=\"line\">                <span class=\"comment\">// 业务代码.....</span></span><br><span class=\"line\">                    fmt.Println(<span class=\"string\">&quot;time 5&quot;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">case</span> &lt;-doneChan:</span><br><span class=\"line\">                    <span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 业务代码 几十行...</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"发生了什么？\"><a class=\"header-anchor\" href=\"#发生了什么？\">¶</a>发生了什么？</h4>\n<blockquote>\n<p>上面的代码，不晓得看出来什么问题了么…</p>\n</blockquote>\n<h3 id=\"关键点：\"><a class=\"header-anchor\" href=\"#关键点：\">¶</a>关键点：</h3>\n<p>ticker没有stop</p>\n<p><a href=\"https://github.com/golang/go/blob/master/src/time/tick.go#L62\">官方解释</a></p>\n<h4 id=\"Ticker不能被回收导致\"><a class=\"header-anchor\" href=\"#Ticker不能被回收导致\">¶</a>Ticker不能被回收导致</h4>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_053201.webp\" alt=\"\"></p>\n<h4 id=\"为何不能被回收？\"><a class=\"header-anchor\" href=\"#为何不能被回收？\">¶</a>为何不能被回收？</h4>\n<h5 id=\"NewTicker实现：\"><a class=\"header-anchor\" href=\"#NewTicker实现：\">¶</a>NewTicker实现：</h5>\n<p><a href=\"https://github.com/golang/go/blob/master/src/time/tick.go#L39\">NewTicker官方实现</a></p>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203\">startTimer底层实现</a></p>\n<h6 id=\"addtimer\"><a class=\"header-anchor\" href=\"#addtimer\">¶</a>addtimer</h6>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// addtimer adds a timer to the current P.</span></span><br><span class=\"line\"><span class=\"comment\">// This should only be called with a newly created timer.</span></span><br><span class=\"line\"><span class=\"comment\">// That avoids the risk of changing the when field of a timer in some P&#x27;s heap,</span></span><br><span class=\"line\"><span class=\"comment\">// which could cause the heap to become unsorted.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">addtimer</span><span class=\"params\">(t *timer)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// when must never be negative; otherwise runtimer will overflow</span></span><br><span class=\"line\">\t<span class=\"comment\">// during its delta calculation and never expire other runtime timers.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t.when &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tt.when = maxWhen</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t.status != timerNoStatus &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;addtimer called with initialized timer&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tt.status = timerWaiting</span><br><span class=\"line\"></span><br><span class=\"line\">\twhen := t.when</span><br><span class=\"line\"></span><br><span class=\"line\">\tpp := getg().m.p.ptr() <span class=\"comment\">// 获取当前的P</span></span><br><span class=\"line\">\tlock(&amp;pp.timersLock) <span class=\"comment\">// 加锁</span></span><br><span class=\"line\">\tcleantimers(pp) <span class=\"comment\">// 调整p.timers栈顶元素</span></span><br><span class=\"line\">\tdoaddtimer(pp, t) <span class=\"comment\">// t绑定下p</span></span><br><span class=\"line\">\tunlock(&amp;pp.timersLock) </span><br><span class=\"line\"></span><br><span class=\"line\">\twakeNetPoller(when)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"doaddtimer\"><a class=\"header-anchor\" href=\"#doaddtimer\">¶</a>doaddtimer</h6>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// doaddtimer adds t to the current P&#x27;s heap.</span></span><br><span class=\"line\"><span class=\"comment\">// The caller must have locked the timers for pp.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">doaddtimer</span><span class=\"params\">(pp *p, t *timer)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Timers rely on the network poller, so make sure the poller</span></span><br><span class=\"line\">\t<span class=\"comment\">// has started.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> netpollInited == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tnetpollGenericInit()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t.pp != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;doaddtimer: P already set in timer&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tt.pp.set(pp)</span><br><span class=\"line\">\ti := <span class=\"built_in\">len</span>(pp.timers)</span><br><span class=\"line\">\tpp.timers = <span class=\"built_in\">append</span>(pp.timers, t) <span class=\"comment\">// p上添加一个timer</span></span><br><span class=\"line\">\tsiftupTimer(pp.timers, i) <span class=\"comment\">// 堆调整算法</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t == pp.timers[<span class=\"number\">0</span>] &#123;</span><br><span class=\"line\">\t\tatomic.Store64(&amp;pp.timer0When, <span class=\"keyword\">uint64</span>(t.when))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tatomic.Xadd(&amp;pp.numTimers, <span class=\"number\">1</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"拓展：\"><a class=\"header-anchor\" href=\"#拓展：\">¶</a>拓展：</h3>\n<h4 id=\"cleantimers过程：\"><a class=\"header-anchor\" href=\"#cleantimers过程：\">¶</a>cleantimers过程：</h4>\n<ul>\n<li>判断长度</li>\n<li>判断上一个timer状态</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// cleantimers cleans up the head of the timer queue. This speeds up</span></span><br><span class=\"line\"><span class=\"comment\">// programs that create and delete timers; leaving them in the heap</span></span><br><span class=\"line\"><span class=\"comment\">// slows down addtimer. Reports whether no timer problems were found.</span></span><br><span class=\"line\"><span class=\"comment\">// The caller must have locked the timers for pp.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">cleantimers</span><span class=\"params\">(pp *p)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(pp.timers) == <span class=\"number\">0</span> &#123; <span class=\"comment\">// 判断长度</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tt := pp.timers[<span class=\"number\">0</span>] <span class=\"comment\">//取第一个</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> t.pp.ptr() != pp &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;cleantimers: bad p&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> s := atomic.Load(&amp;t.status); s &#123; <span class=\"comment\">//需要判断状态</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> timerDeleted:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, s, timerRemoving) &#123; <span class=\"comment\">//非删除中</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tdodeltimer0(pp) <span class=\"comment\">//移除timer0</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, timerRemoving, timerRemoved) &#123;</span><br><span class=\"line\">\t\t\t\tbadTimer()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tatomic.Xadd(&amp;pp.deletedTimers, <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> timerModifiedEarlier, timerModifiedLater: <span class=\"comment\">// 修改前或者修改后的状态</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, s, timerMoving) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Now we can change the when field.</span></span><br><span class=\"line\">\t\t\tt.when = t.nextwhen <span class=\"comment\">// 指针后移</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Move t to the right position.</span></span><br><span class=\"line\">\t\t\tdodeltimer0(pp) <span class=\"comment\">// 删除最底下的元素</span></span><br><span class=\"line\">\t\t\tdoaddtimer(pp, t) <span class=\"comment\">// 重新绑定P和t的关系</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> s == timerModifiedEarlier &#123;</span><br><span class=\"line\">\t\t\t\tatomic.Xadd(&amp;pp.adjustTimers, <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, timerMoving, timerWaiting) &#123;</span><br><span class=\"line\">\t\t\t\tbadTimer()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Head of timers does not need adjustment.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"dodeltimer0\"><a class=\"header-anchor\" href=\"#dodeltimer0\">¶</a>dodeltimer0</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// dodeltimer0 removes timer 0 from the current P&#x27;s heap.</span></span><br><span class=\"line\"><span class=\"comment\">// We are locked on the P when this is called.</span></span><br><span class=\"line\"><span class=\"comment\">// It reports whether it saw no problems due to races.</span></span><br><span class=\"line\"><span class=\"comment\">// The caller must have locked the timers for pp.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">dodeltimer0</span><span class=\"params\">(pp *p)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t := pp.timers[<span class=\"number\">0</span>]; t.pp.ptr() != pp &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;dodeltimer0: wrong P&quot;</span>)</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tt.pp = <span class=\"number\">0</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlast := <span class=\"built_in\">len</span>(pp.timers) - <span class=\"number\">1</span> <span class=\"comment\">// 获取第一个timers</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> last &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tpp.timers[<span class=\"number\">0</span>] = pp.timers[last] <span class=\"comment\">// 栈底---&gt;栈顶</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpp.timers[last] = <span class=\"literal\">nil</span> <span class=\"comment\">// 置空</span></span><br><span class=\"line\">\tpp.timers = pp.timers[:last] <span class=\"comment\">//重新赋值</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> last &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tsiftdownTimer(pp.timers, <span class=\"number\">0</span>)  <span class=\"comment\">// 重新排序</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tupdateTimer0When(pp) <span class=\"comment\">// 更新P中的when</span></span><br><span class=\"line\">\tatomic.Xadd(&amp;pp.numTimers, <span class=\"number\">-1</span>) <span class=\"comment\">// 更新数量</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"参考\"><a class=\"header-anchor\" href=\"#参考\">¶</a>参考</h3>\n<ul>\n<li>\n<p><a href=\"https://github.com/golang/go/blob/master/src/time/tick.go#L39\">NewTicker官方实现</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203\">StartTimer底层实现</a></p>\n</li>\n<li>\n<p>atomic</p>\n<ul>\n<li>atomic.Store64</li>\n<li>atomic.Xadd</li>\n</ul>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"前序：\"><a class=\"header-anchor\" href=\"#前序：\">¶</a>前序：</h3>\n<p>不知道你们有没有经历过这种情况：</p>\n<blockquote>\n<p>测试示例图片：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp\" alt=\"\"></p>","more":"<blockquote>\n<p>说的简单点：内存炸了呗…OOM</p>\n</blockquote>\n<h3 id=\"引言\"><a class=\"header-anchor\" href=\"#引言\">¶</a>引言</h3>\n<blockquote>\n<p>go version go1.14.14 darwin/amd64</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">最近的坑是真的多，当然这种坑在大项目中，一不小心就写出来了,</span><br><span class=\"line\"></span><br><span class=\"line\">人多，项目大，各种各样的花式操作都出来了,在所难免，</span><br><span class=\"line\">能做的就是分析问题，总结，记录，防止下次自己犯错，同时也可以加深理解。</span><br></pre></td></tr></table></figure>\n<h3 id=\"起因：\"><a class=\"header-anchor\" href=\"#起因：\">¶</a>起因：</h3>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">XXX</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 业务代码 几十行...</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i:=<span class=\"number\">0</span>;i&lt;<span class=\"number\">100000</span>;i++&#123;</span><br><span class=\"line\">\t    ticker := time.NewTicker(<span class=\"number\">10</span> * time.Second)</span><br><span class=\"line\">\t\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//模拟业务代码</span></span><br><span class=\"line\">\t\t\tfmt.Println(<span class=\"string\">&quot;defer close&quot;</span>)</span><br><span class=\"line\">\t\t&#125;()</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">case</span> &lt;-ticker.C:</span><br><span class=\"line\">                <span class=\"comment\">// 业务代码.....</span></span><br><span class=\"line\">                    fmt.Println(<span class=\"string\">&quot;time 5&quot;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">case</span> &lt;-doneChan:</span><br><span class=\"line\">                    <span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 业务代码 几十行...</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"发生了什么？\"><a class=\"header-anchor\" href=\"#发生了什么？\">¶</a>发生了什么？</h4>\n<blockquote>\n<p>上面的代码，不晓得看出来什么问题了么…</p>\n</blockquote>\n<h3 id=\"关键点：\"><a class=\"header-anchor\" href=\"#关键点：\">¶</a>关键点：</h3>\n<p>ticker没有stop</p>\n<p><a href=\"https://github.com/golang/go/blob/master/src/time/tick.go#L62\">官方解释</a></p>\n<h4 id=\"Ticker不能被回收导致\"><a class=\"header-anchor\" href=\"#Ticker不能被回收导致\">¶</a>Ticker不能被回收导致</h4>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_053201.webp\" alt=\"\"></p>\n<h4 id=\"为何不能被回收？\"><a class=\"header-anchor\" href=\"#为何不能被回收？\">¶</a>为何不能被回收？</h4>\n<h5 id=\"NewTicker实现：\"><a class=\"header-anchor\" href=\"#NewTicker实现：\">¶</a>NewTicker实现：</h5>\n<p><a href=\"https://github.com/golang/go/blob/master/src/time/tick.go#L39\">NewTicker官方实现</a></p>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203\">startTimer底层实现</a></p>\n<h6 id=\"addtimer\"><a class=\"header-anchor\" href=\"#addtimer\">¶</a>addtimer</h6>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// addtimer adds a timer to the current P.</span></span><br><span class=\"line\"><span class=\"comment\">// This should only be called with a newly created timer.</span></span><br><span class=\"line\"><span class=\"comment\">// That avoids the risk of changing the when field of a timer in some P&#x27;s heap,</span></span><br><span class=\"line\"><span class=\"comment\">// which could cause the heap to become unsorted.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">addtimer</span><span class=\"params\">(t *timer)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// when must never be negative; otherwise runtimer will overflow</span></span><br><span class=\"line\">\t<span class=\"comment\">// during its delta calculation and never expire other runtime timers.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t.when &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tt.when = maxWhen</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t.status != timerNoStatus &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;addtimer called with initialized timer&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tt.status = timerWaiting</span><br><span class=\"line\"></span><br><span class=\"line\">\twhen := t.when</span><br><span class=\"line\"></span><br><span class=\"line\">\tpp := getg().m.p.ptr() <span class=\"comment\">// 获取当前的P</span></span><br><span class=\"line\">\tlock(&amp;pp.timersLock) <span class=\"comment\">// 加锁</span></span><br><span class=\"line\">\tcleantimers(pp) <span class=\"comment\">// 调整p.timers栈顶元素</span></span><br><span class=\"line\">\tdoaddtimer(pp, t) <span class=\"comment\">// t绑定下p</span></span><br><span class=\"line\">\tunlock(&amp;pp.timersLock) </span><br><span class=\"line\"></span><br><span class=\"line\">\twakeNetPoller(when)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h6 id=\"doaddtimer\"><a class=\"header-anchor\" href=\"#doaddtimer\">¶</a>doaddtimer</h6>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// doaddtimer adds t to the current P&#x27;s heap.</span></span><br><span class=\"line\"><span class=\"comment\">// The caller must have locked the timers for pp.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">doaddtimer</span><span class=\"params\">(pp *p, t *timer)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Timers rely on the network poller, so make sure the poller</span></span><br><span class=\"line\">\t<span class=\"comment\">// has started.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> netpollInited == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tnetpollGenericInit()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t.pp != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;doaddtimer: P already set in timer&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tt.pp.set(pp)</span><br><span class=\"line\">\ti := <span class=\"built_in\">len</span>(pp.timers)</span><br><span class=\"line\">\tpp.timers = <span class=\"built_in\">append</span>(pp.timers, t) <span class=\"comment\">// p上添加一个timer</span></span><br><span class=\"line\">\tsiftupTimer(pp.timers, i) <span class=\"comment\">// 堆调整算法</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t == pp.timers[<span class=\"number\">0</span>] &#123;</span><br><span class=\"line\">\t\tatomic.Store64(&amp;pp.timer0When, <span class=\"keyword\">uint64</span>(t.when))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tatomic.Xadd(&amp;pp.numTimers, <span class=\"number\">1</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"拓展：\"><a class=\"header-anchor\" href=\"#拓展：\">¶</a>拓展：</h3>\n<h4 id=\"cleantimers过程：\"><a class=\"header-anchor\" href=\"#cleantimers过程：\">¶</a>cleantimers过程：</h4>\n<ul>\n<li>判断长度</li>\n<li>判断上一个timer状态</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// cleantimers cleans up the head of the timer queue. This speeds up</span></span><br><span class=\"line\"><span class=\"comment\">// programs that create and delete timers; leaving them in the heap</span></span><br><span class=\"line\"><span class=\"comment\">// slows down addtimer. Reports whether no timer problems were found.</span></span><br><span class=\"line\"><span class=\"comment\">// The caller must have locked the timers for pp.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">cleantimers</span><span class=\"params\">(pp *p)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(pp.timers) == <span class=\"number\">0</span> &#123; <span class=\"comment\">// 判断长度</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tt := pp.timers[<span class=\"number\">0</span>] <span class=\"comment\">//取第一个</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> t.pp.ptr() != pp &#123;</span><br><span class=\"line\">\t\t\tthrow(<span class=\"string\">&quot;cleantimers: bad p&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> s := atomic.Load(&amp;t.status); s &#123; <span class=\"comment\">//需要判断状态</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> timerDeleted:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, s, timerRemoving) &#123; <span class=\"comment\">//非删除中</span></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tdodeltimer0(pp) <span class=\"comment\">//移除timer0</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, timerRemoving, timerRemoved) &#123;</span><br><span class=\"line\">\t\t\t\tbadTimer()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tatomic.Xadd(&amp;pp.deletedTimers, <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> timerModifiedEarlier, timerModifiedLater: <span class=\"comment\">// 修改前或者修改后的状态</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, s, timerMoving) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Now we can change the when field.</span></span><br><span class=\"line\">\t\t\tt.when = t.nextwhen <span class=\"comment\">// 指针后移</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Move t to the right position.</span></span><br><span class=\"line\">\t\t\tdodeltimer0(pp) <span class=\"comment\">// 删除最底下的元素</span></span><br><span class=\"line\">\t\t\tdoaddtimer(pp, t) <span class=\"comment\">// 重新绑定P和t的关系</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> s == timerModifiedEarlier &#123;</span><br><span class=\"line\">\t\t\t\tatomic.Xadd(&amp;pp.adjustTimers, <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !atomic.Cas(&amp;t.status, timerMoving, timerWaiting) &#123;</span><br><span class=\"line\">\t\t\t\tbadTimer()</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// Head of timers does not need adjustment.</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h5 id=\"dodeltimer0\"><a class=\"header-anchor\" href=\"#dodeltimer0\">¶</a>dodeltimer0</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// dodeltimer0 removes timer 0 from the current P&#x27;s heap.</span></span><br><span class=\"line\"><span class=\"comment\">// We are locked on the P when this is called.</span></span><br><span class=\"line\"><span class=\"comment\">// It reports whether it saw no problems due to races.</span></span><br><span class=\"line\"><span class=\"comment\">// The caller must have locked the timers for pp.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">dodeltimer0</span><span class=\"params\">(pp *p)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> t := pp.timers[<span class=\"number\">0</span>]; t.pp.ptr() != pp &#123;</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;dodeltimer0: wrong P&quot;</span>)</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tt.pp = <span class=\"number\">0</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tlast := <span class=\"built_in\">len</span>(pp.timers) - <span class=\"number\">1</span> <span class=\"comment\">// 获取第一个timers</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> last &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tpp.timers[<span class=\"number\">0</span>] = pp.timers[last] <span class=\"comment\">// 栈底---&gt;栈顶</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpp.timers[last] = <span class=\"literal\">nil</span> <span class=\"comment\">// 置空</span></span><br><span class=\"line\">\tpp.timers = pp.timers[:last] <span class=\"comment\">//重新赋值</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> last &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tsiftdownTimer(pp.timers, <span class=\"number\">0</span>)  <span class=\"comment\">// 重新排序</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tupdateTimer0When(pp) <span class=\"comment\">// 更新P中的when</span></span><br><span class=\"line\">\tatomic.Xadd(&amp;pp.numTimers, <span class=\"number\">-1</span>) <span class=\"comment\">// 更新数量</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"参考\"><a class=\"header-anchor\" href=\"#参考\">¶</a>参考</h3>\n<ul>\n<li>\n<p><a href=\"https://github.com/golang/go/blob/master/src/time/tick.go#L39\">NewTicker官方实现</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/golang/go/blob/release-branch.go1.14/src/runtime/time.go#L203\">StartTimer底层实现</a></p>\n</li>\n<li>\n<p>atomic</p>\n<ul>\n<li>atomic.Store64</li>\n<li>atomic.Xadd</li>\n</ul>\n</li>\n</ul>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp","popularPost_tmp_gaData":{"updated":"Thu Feb 04 2021 12:01:17 GMT+0800 (中国标准时间)","title":"「32」Go  Ticker 内存泄露","path":"archives/53e1932f.html","eyeCatchImage":"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp","excerpt":"<h3 id=\"前序：\"><a class=\"header-anchor\" href=\"#前序：\">¶</a>前序：</h3>\n<p>不知道你们有没有经历过这种情况：</p>\n<blockquote>\n<p>测试示例图片：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210204_051425.webp\" alt=\"\"></p>","date":{"_isAMomentObject":true,"_i":"2021-02-04T04:01:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2021-02-04T04:01:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day","ticker","defer"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":3849},{"title":"「33」Float IEEE标准","date":"2021-02-06T02:01:17.000Z","updated":"2021-02-06T02:01:17.000Z","keywords":"Go,IEEE,Float","mathjax":true,"abbrlink":"257c4ce2","_content":"\n### 前序\n\n前几天踩坑Float类型的计算问题,今天来系统的总结下float相关的知识点.\n\n### 掌握关键点:\n\n* float的标准是什么?\n* float的位计算规则\n* float场景\n* float计算改进\n\n<!--more-->\n### Float的标准?\n\n#### 国际组织定义\n\n[wiki-->float定义](https://zh.wikipedia.org/wiki/IEEE_754)\n\n\n#### 表示方法\n\n$$ value =  sign * exponent * fraction $$\n\n* value: 实际值\n* sign bit: 符号位\n* exponent bit: 指数便宜位\n* fraction: 分数值\n\n具体表示:\n\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_104959.webp)\n\n#### 单精度和双精度\n\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_110116.png)\n\n\n\n#### 特殊值:\n\n* 无穷: Inf\n* 非数值: NaN\n\n### Float位计算规则\n\n#### 原码\n\n* 高位表示符号位,其余为值; ⚠️:不能直接参与计算\n\n#### 反码\n\n* 正数反码为本身\n* 负数保留符号位,其它位按位取反.\n\n```\n例如 :\n[+7]原 = 00000111 [+7]反 = 00000111 \n[-7]原 = 10000111 [-7]反 = 11111000\n```\n\n#### 补码\n* 正数的补码==原码==补码\n* 负数补码=反码+1\n\n#### 计算形式:\n\n$$ v = (-1)^s * M * 2^E $$\n\n##### 说明:\n\n* $(-1)^s$表示符号位\n* M表示有效数字\n* $2^E$表示指数位\n\n\n```go\neg:\n-0.5 => -0.1[二进制]\n=> -1.0 * 2^-1\n=> (-1)^1 * 1.0 * 2^-1\n=> s=1，M=1.0，E=-1\n```\n\n#### float类型的加法:\n\n* 对阶\n* 尾数\n* 规格化\n* 舍入处理\n* 溢出判断\n\n#### $0.3+1.6=?$\n```\na=(0.3)10=(0011 1110 1001 1001 1001 1001 1001 1010)2    Sa=0    Ea=011 1110 1    Ma=1.001 1001 1001 1001 1001 1010\n\nb=(1.6)10=(0011 1111 1100 1100 1100 1100 1100 1101)2      Sb=0    Eb=011 1111 1     Mb=1.100 1100 1100 1100 1100 1101\n```\n\n##### 对阶\n\n\n>简单的说就是需要阶码对齐,使其尾数可以进行加减运算,即:\n\n$ ⊿E = E_b -E_a $ \n\n\n```go\nEa<Eb   Eb-Ea=2\n\nMa要调整为 0.0 1001 1001 1001 1001 1001 10       10\n\nE=011 1111 1\n```\n\n##### 尾数\n```go\n  0.01001100110011001100110\n+ 1.10011001100110011001101\n----------------------------\n  1.11100110011001100110011\n```\n\n##### 规格化\n尾数的格式 $ 1.M $,尾数可能是非规格化的,所以需要左规和右规操作:\n\n* 左规操作: 尾数左移,阶码减值\n* 右规操作: 尾数右移,阶码+值\n\n\n$ 目的: 1 \\leq M < 2 $\n\n- [x] 1.11100110011001100110011‬ \n \n##### 舍入处理\n\n>四种舍入方式:\n\n* 就近舍入: 四舍五入\n* 朝+∞舍入\n* 朝-∞舍入\n* 朝0舍入\n\n\n```go\n在对阶时，Ma有右移，且第一次最高为1，第二次为0，\n所以按\"0舍1入\"， ==> 精度丢失的关键, \n尾数运算结果调整为 1.11100110011001100110100\n```\n\n##### 溢出判断\n\n> 判断结果标准: 运算结果的阶码\n\n```go\na+b=(0  01111111  11100110011001100110100)2\n=(0011 1111 1111 0011 0011 0011 0011 0100)2=(3FF33334)16\n\n转为10进制\n\na+b=1.90000010\n```\n\n\n### float计算改进\n\n#### 尽量避免使用高精度且重要的数据计算: 如: ¥\n\n#### 统一取舍位数\n* 统一保留\n* 统一取舍算法\n\n\n#### 建议用int/string类型\n\n* 缺点:\n    * 牺牲性能\n    * 转换复杂\n* 优点:\n    * 提高准确度 \n    * 处理可多元化\n\n","source":"_posts/33-IEEE745-Float.md","raw":"---\ntitle: 「33」Float IEEE标准\ndate: '2021/2/6 10:01:17'\nupdated: '2021/2/6 10:01:17'\nkeywords: 'Go,IEEE,Float'\ntags:\n  - Go\n  - IEEE\n  - Day\n  - Float\n  - 位运算\nmathjax: true\nabbrlink: 257c4ce2\n---\n\n### 前序\n\n前几天踩坑Float类型的计算问题,今天来系统的总结下float相关的知识点.\n\n### 掌握关键点:\n\n* float的标准是什么?\n* float的位计算规则\n* float场景\n* float计算改进\n\n<!--more-->\n### Float的标准?\n\n#### 国际组织定义\n\n[wiki-->float定义](https://zh.wikipedia.org/wiki/IEEE_754)\n\n\n#### 表示方法\n\n$$ value =  sign * exponent * fraction $$\n\n* value: 实际值\n* sign bit: 符号位\n* exponent bit: 指数便宜位\n* fraction: 分数值\n\n具体表示:\n\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_104959.webp)\n\n#### 单精度和双精度\n\n![](https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_110116.png)\n\n\n\n#### 特殊值:\n\n* 无穷: Inf\n* 非数值: NaN\n\n### Float位计算规则\n\n#### 原码\n\n* 高位表示符号位,其余为值; ⚠️:不能直接参与计算\n\n#### 反码\n\n* 正数反码为本身\n* 负数保留符号位,其它位按位取反.\n\n```\n例如 :\n[+7]原 = 00000111 [+7]反 = 00000111 \n[-7]原 = 10000111 [-7]反 = 11111000\n```\n\n#### 补码\n* 正数的补码==原码==补码\n* 负数补码=反码+1\n\n#### 计算形式:\n\n$$ v = (-1)^s * M * 2^E $$\n\n##### 说明:\n\n* $(-1)^s$表示符号位\n* M表示有效数字\n* $2^E$表示指数位\n\n\n```go\neg:\n-0.5 => -0.1[二进制]\n=> -1.0 * 2^-1\n=> (-1)^1 * 1.0 * 2^-1\n=> s=1，M=1.0，E=-1\n```\n\n#### float类型的加法:\n\n* 对阶\n* 尾数\n* 规格化\n* 舍入处理\n* 溢出判断\n\n#### $0.3+1.6=?$\n```\na=(0.3)10=(0011 1110 1001 1001 1001 1001 1001 1010)2    Sa=0    Ea=011 1110 1    Ma=1.001 1001 1001 1001 1001 1010\n\nb=(1.6)10=(0011 1111 1100 1100 1100 1100 1100 1101)2      Sb=0    Eb=011 1111 1     Mb=1.100 1100 1100 1100 1100 1101\n```\n\n##### 对阶\n\n\n>简单的说就是需要阶码对齐,使其尾数可以进行加减运算,即:\n\n$ ⊿E = E_b -E_a $ \n\n\n```go\nEa<Eb   Eb-Ea=2\n\nMa要调整为 0.0 1001 1001 1001 1001 1001 10       10\n\nE=011 1111 1\n```\n\n##### 尾数\n```go\n  0.01001100110011001100110\n+ 1.10011001100110011001101\n----------------------------\n  1.11100110011001100110011\n```\n\n##### 规格化\n尾数的格式 $ 1.M $,尾数可能是非规格化的,所以需要左规和右规操作:\n\n* 左规操作: 尾数左移,阶码减值\n* 右规操作: 尾数右移,阶码+值\n\n\n$ 目的: 1 \\leq M < 2 $\n\n- [x] 1.11100110011001100110011‬ \n \n##### 舍入处理\n\n>四种舍入方式:\n\n* 就近舍入: 四舍五入\n* 朝+∞舍入\n* 朝-∞舍入\n* 朝0舍入\n\n\n```go\n在对阶时，Ma有右移，且第一次最高为1，第二次为0，\n所以按\"0舍1入\"， ==> 精度丢失的关键, \n尾数运算结果调整为 1.11100110011001100110100\n```\n\n##### 溢出判断\n\n> 判断结果标准: 运算结果的阶码\n\n```go\na+b=(0  01111111  11100110011001100110100)2\n=(0011 1111 1111 0011 0011 0011 0011 0100)2=(3FF33334)16\n\n转为10进制\n\na+b=1.90000010\n```\n\n\n### float计算改进\n\n#### 尽量避免使用高精度且重要的数据计算: 如: ¥\n\n#### 统一取舍位数\n* 统一保留\n* 统一取舍算法\n\n\n#### 建议用int/string类型\n\n* 缺点:\n    * 牺牲性能\n    * 转换复杂\n* 优点:\n    * 提高准确度 \n    * 处理可多元化\n\n","slug":"33-IEEE745-Float","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlj001y3ci70v8rgzl6","content":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>前几天踩坑Float类型的计算问题,今天来系统的总结下float相关的知识点.</p>\n<h3 id=\"掌握关键点\"><a class=\"header-anchor\" href=\"#掌握关键点\">¶</a>掌握关键点:</h3>\n<ul>\n<li>float的标准是什么?</li>\n<li>float的位计算规则</li>\n<li>float场景</li>\n<li>float计算改进</li>\n</ul>\n<a id=\"more\"></a>\n<h3 id=\"Float的标准\"><a class=\"header-anchor\" href=\"#Float的标准\">¶</a>Float的标准?</h3>\n<h4 id=\"国际组织定义\"><a class=\"header-anchor\" href=\"#国际组织定义\">¶</a>国际组织定义</h4>\n<p><a href=\"https://zh.wikipedia.org/wiki/IEEE_754\">wiki–&gt;float定义</a></p>\n<h4 id=\"表示方法\"><a class=\"header-anchor\" href=\"#表示方法\">¶</a>表示方法</h4>\n<p style=\"\"><img src=\"https://math.now.sh?from=value%20%3D%20%20sign%20*%20exponent%20*%20fraction%20%0A\" /></p><ul>\n<li>value: 实际值</li>\n<li>sign bit: 符号位</li>\n<li>exponent bit: 指数便宜位</li>\n<li>fraction: 分数值</li>\n</ul>\n<p>具体表示:</p>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_104959.webp\" alt=\"\"></p>\n<h4 id=\"单精度和双精度\"><a class=\"header-anchor\" href=\"#单精度和双精度\">¶</a>单精度和双精度</h4>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_110116.png\" alt=\"\"></p>\n<h4 id=\"特殊值\"><a class=\"header-anchor\" href=\"#特殊值\">¶</a>特殊值:</h4>\n<ul>\n<li>无穷: Inf</li>\n<li>非数值: NaN</li>\n</ul>\n<h3 id=\"Float位计算规则\"><a class=\"header-anchor\" href=\"#Float位计算规则\">¶</a>Float位计算规则</h3>\n<h4 id=\"原码\"><a class=\"header-anchor\" href=\"#原码\">¶</a>原码</h4>\n<ul>\n<li>高位表示符号位,其余为值; ⚠️:不能直接参与计算</li>\n</ul>\n<h4 id=\"反码\"><a class=\"header-anchor\" href=\"#反码\">¶</a>反码</h4>\n<ul>\n<li>正数反码为本身</li>\n<li>负数保留符号位,其它位按位取反.</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">例如 :</span><br><span class=\"line\">[+7]原 &#x3D; 00000111 [+7]反 &#x3D; 00000111 </span><br><span class=\"line\">[-7]原 &#x3D; 10000111 [-7]反 &#x3D; 11111000</span><br></pre></td></tr></table></figure>\n<h4 id=\"补码\"><a class=\"header-anchor\" href=\"#补码\">¶</a>补码</h4>\n<ul>\n<li>正数的补码==原码==补码</li>\n<li>负数补码=反码+1</li>\n</ul>\n<h4 id=\"计算形式\"><a class=\"header-anchor\" href=\"#计算形式\">¶</a>计算形式:</h4>\n<p style=\"\"><img src=\"https://math.now.sh?from=v%20%3D%20%28-1%29%5Es%20*%20M%20*%202%5EE%20%0A\" /></p><h5 id=\"说明\"><a class=\"header-anchor\" href=\"#说明\">¶</a>说明:</h5>\n<ul>\n<li><img src=\"https://math.now.sh?inline=%28-1%29%5Es\" style=\"display:inline-block;margin: 0;\"/>表示符号位</li>\n<li>M表示有效数字</li>\n<li><img src=\"https://math.now.sh?inline=2%5EE\" style=\"display:inline-block;margin: 0;\"/>表示指数位</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eg:</span><br><span class=\"line\"><span class=\"number\">-0.5</span> =&gt; <span class=\"number\">-0.1</span>[二进制]</span><br><span class=\"line\">=&gt; <span class=\"number\">-1.0</span> * <span class=\"number\">2</span>^<span class=\"number\">-1</span></span><br><span class=\"line\">=&gt; (<span class=\"number\">-1</span>)^<span class=\"number\">1</span> * <span class=\"number\">1.0</span> * <span class=\"number\">2</span>^<span class=\"number\">-1</span></span><br><span class=\"line\">=&gt; s=<span class=\"number\">1</span>，M=<span class=\"number\">1.0</span>，E=<span class=\"number\">-1</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"float类型的加法\"><a class=\"header-anchor\" href=\"#float类型的加法\">¶</a>float类型的加法:</h4>\n<ul>\n<li>对阶</li>\n<li>尾数</li>\n<li>规格化</li>\n<li>舍入处理</li>\n<li>溢出判断</li>\n</ul>\n<h4 id=\"0-3-1-6\"><a class=\"header-anchor\" href=\"#0-3-1-6\">¶</a><img src=\"https://math.now.sh?inline=0.3%2B1.6%3D%3F\" style=\"display:inline-block;margin: 0;\"/></h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a&#x3D;(0.3)10&#x3D;(0011 1110 1001 1001 1001 1001 1001 1010)2    Sa&#x3D;0    Ea&#x3D;011 1110 1    Ma&#x3D;1.001 1001 1001 1001 1001 1010</span><br><span class=\"line\"></span><br><span class=\"line\">b&#x3D;(1.6)10&#x3D;(0011 1111 1100 1100 1100 1100 1100 1101)2      Sb&#x3D;0    Eb&#x3D;011 1111 1     Mb&#x3D;1.100 1100 1100 1100 1100 1101</span><br></pre></td></tr></table></figure>\n<h5 id=\"对阶\"><a class=\"header-anchor\" href=\"#对阶\">¶</a>对阶</h5>\n<blockquote>\n<p>简单的说就是需要阶码对齐,使其尾数可以进行加减运算,即:</p>\n</blockquote>\n<p>$ ⊿E = E_b -E_a $</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ea&lt;Eb   Eb-Ea=<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">Ma要调整为 <span class=\"number\">0.0</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">10</span>       <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\">E=<span class=\"number\">011</span> <span class=\"number\">1111</span> <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"尾数\"><a class=\"header-anchor\" href=\"#尾数\">¶</a>尾数</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"number\">0.01001100110011001100110</span></span><br><span class=\"line\">+ <span class=\"number\">1.10011001100110011001101</span></span><br><span class=\"line\">----------------------------</span><br><span class=\"line\">  <span class=\"number\">1.11100110011001100110011</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"规格化\"><a class=\"header-anchor\" href=\"#规格化\">¶</a>规格化</h5>\n<p>尾数的格式 $ 1.M $,尾数可能是非规格化的,所以需要左规和右规操作:</p>\n<ul>\n<li>左规操作: 尾数左移,阶码减值</li>\n<li>右规操作: 尾数右移,阶码+值</li>\n</ul>\n<p>$ 目的: 1 \\leq M &lt; 2 $</p>\n<ul>\n<li><input type=\"checkbox\" id=\"checkbox0\" checked=\"true\"><label for=\"checkbox0\">1.11100110011001100110011‬</label></li>\n</ul>\n<h5 id=\"舍入处理\"><a class=\"header-anchor\" href=\"#舍入处理\">¶</a>舍入处理</h5>\n<blockquote>\n<p>四种舍入方式:</p>\n</blockquote>\n<ul>\n<li>就近舍入: 四舍五入</li>\n<li>朝+∞舍入</li>\n<li>朝-∞舍入</li>\n<li>朝0舍入</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在对阶时，Ma有右移，且第一次最高为<span class=\"number\">1</span>，第二次为<span class=\"number\">0</span>，</span><br><span class=\"line\">所以按<span class=\"string\">&quot;0舍1入&quot;</span>， ==&gt; 精度丢失的关键, </span><br><span class=\"line\">尾数运算结果调整为 <span class=\"number\">1.11100110011001100110100</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"溢出判断\"><a class=\"header-anchor\" href=\"#溢出判断\">¶</a>溢出判断</h5>\n<blockquote>\n<p>判断结果标准: 运算结果的阶码</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a+b=(<span class=\"number\">0</span>  <span class=\"number\">01111111</span>  <span class=\"number\">11100110011001100110100</span>)<span class=\"number\">2</span></span><br><span class=\"line\">=(<span class=\"number\">0011</span> <span class=\"number\">1111</span> <span class=\"number\">1111</span> <span class=\"number\">0011</span> <span class=\"number\">0011</span> <span class=\"number\">0011</span> <span class=\"number\">0011</span> <span class=\"number\">0100</span>)<span class=\"number\">2</span>=(<span class=\"number\">3</span>FF33334)<span class=\"number\">16</span></span><br><span class=\"line\"></span><br><span class=\"line\">转为<span class=\"number\">10</span>进制</span><br><span class=\"line\"></span><br><span class=\"line\">a+b=<span class=\"number\">1.90000010</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"float计算改进\"><a class=\"header-anchor\" href=\"#float计算改进\">¶</a>float计算改进</h3>\n<h4 id=\"尽量避免使用高精度且重要的数据计算-如-¥\"><a class=\"header-anchor\" href=\"#尽量避免使用高精度且重要的数据计算-如-¥\">¶</a>尽量避免使用高精度且重要的数据计算: 如: ¥</h4>\n<h4 id=\"统一取舍位数\"><a class=\"header-anchor\" href=\"#统一取舍位数\">¶</a>统一取舍位数</h4>\n<ul>\n<li>统一保留</li>\n<li>统一取舍算法</li>\n</ul>\n<h4 id=\"建议用int-string类型\"><a class=\"header-anchor\" href=\"#建议用int-string类型\">¶</a>建议用int/string类型</h4>\n<ul>\n<li>缺点:\n<ul>\n<li>牺牲性能</li>\n<li>转换复杂</li>\n</ul>\n</li>\n<li>优点:\n<ul>\n<li>提高准确度</li>\n<li>处理可多元化</li>\n</ul>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>前几天踩坑Float类型的计算问题,今天来系统的总结下float相关的知识点.</p>\n<h3 id=\"掌握关键点\"><a class=\"header-anchor\" href=\"#掌握关键点\">¶</a>掌握关键点:</h3>\n<ul>\n<li>float的标准是什么?</li>\n<li>float的位计算规则</li>\n<li>float场景</li>\n<li>float计算改进</li>\n</ul>","more":"<h3 id=\"Float的标准\"><a class=\"header-anchor\" href=\"#Float的标准\">¶</a>Float的标准?</h3>\n<h4 id=\"国际组织定义\"><a class=\"header-anchor\" href=\"#国际组织定义\">¶</a>国际组织定义</h4>\n<p><a href=\"https://zh.wikipedia.org/wiki/IEEE_754\">wiki–&gt;float定义</a></p>\n<h4 id=\"表示方法\"><a class=\"header-anchor\" href=\"#表示方法\">¶</a>表示方法</h4>\n<p style=\"\"><img src=\"https://math.now.sh?from=value%20%3D%20%20sign%20*%20exponent%20*%20fraction%20%0A\" /></p><ul>\n<li>value: 实际值</li>\n<li>sign bit: 符号位</li>\n<li>exponent bit: 指数便宜位</li>\n<li>fraction: 分数值</li>\n</ul>\n<p>具体表示:</p>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_104959.webp\" alt=\"\"></p>\n<h4 id=\"单精度和双精度\"><a class=\"header-anchor\" href=\"#单精度和双精度\">¶</a>单精度和双精度</h4>\n<p><img src=\"https://crab-1251738482.cos.ap-guangzhou.myqcloud.com/clipboard_20210206_110116.png\" alt=\"\"></p>\n<h4 id=\"特殊值\"><a class=\"header-anchor\" href=\"#特殊值\">¶</a>特殊值:</h4>\n<ul>\n<li>无穷: Inf</li>\n<li>非数值: NaN</li>\n</ul>\n<h3 id=\"Float位计算规则\"><a class=\"header-anchor\" href=\"#Float位计算规则\">¶</a>Float位计算规则</h3>\n<h4 id=\"原码\"><a class=\"header-anchor\" href=\"#原码\">¶</a>原码</h4>\n<ul>\n<li>高位表示符号位,其余为值; ⚠️:不能直接参与计算</li>\n</ul>\n<h4 id=\"反码\"><a class=\"header-anchor\" href=\"#反码\">¶</a>反码</h4>\n<ul>\n<li>正数反码为本身</li>\n<li>负数保留符号位,其它位按位取反.</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">例如 :</span><br><span class=\"line\">[+7]原 &#x3D; 00000111 [+7]反 &#x3D; 00000111 </span><br><span class=\"line\">[-7]原 &#x3D; 10000111 [-7]反 &#x3D; 11111000</span><br></pre></td></tr></table></figure>\n<h4 id=\"补码\"><a class=\"header-anchor\" href=\"#补码\">¶</a>补码</h4>\n<ul>\n<li>正数的补码==原码==补码</li>\n<li>负数补码=反码+1</li>\n</ul>\n<h4 id=\"计算形式\"><a class=\"header-anchor\" href=\"#计算形式\">¶</a>计算形式:</h4>\n<p style=\"\"><img src=\"https://math.now.sh?from=v%20%3D%20%28-1%29%5Es%20*%20M%20*%202%5EE%20%0A\" /></p><h5 id=\"说明\"><a class=\"header-anchor\" href=\"#说明\">¶</a>说明:</h5>\n<ul>\n<li><img src=\"https://math.now.sh?inline=%28-1%29%5Es\" style=\"display:inline-block;margin: 0;\"/>表示符号位</li>\n<li>M表示有效数字</li>\n<li><img src=\"https://math.now.sh?inline=2%5EE\" style=\"display:inline-block;margin: 0;\"/>表示指数位</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eg:</span><br><span class=\"line\"><span class=\"number\">-0.5</span> =&gt; <span class=\"number\">-0.1</span>[二进制]</span><br><span class=\"line\">=&gt; <span class=\"number\">-1.0</span> * <span class=\"number\">2</span>^<span class=\"number\">-1</span></span><br><span class=\"line\">=&gt; (<span class=\"number\">-1</span>)^<span class=\"number\">1</span> * <span class=\"number\">1.0</span> * <span class=\"number\">2</span>^<span class=\"number\">-1</span></span><br><span class=\"line\">=&gt; s=<span class=\"number\">1</span>，M=<span class=\"number\">1.0</span>，E=<span class=\"number\">-1</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"float类型的加法\"><a class=\"header-anchor\" href=\"#float类型的加法\">¶</a>float类型的加法:</h4>\n<ul>\n<li>对阶</li>\n<li>尾数</li>\n<li>规格化</li>\n<li>舍入处理</li>\n<li>溢出判断</li>\n</ul>\n<h4 id=\"0-3-1-6\"><a class=\"header-anchor\" href=\"#0-3-1-6\">¶</a><img src=\"https://math.now.sh?inline=0.3%2B1.6%3D%3F\" style=\"display:inline-block;margin: 0;\"/></h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a&#x3D;(0.3)10&#x3D;(0011 1110 1001 1001 1001 1001 1001 1010)2    Sa&#x3D;0    Ea&#x3D;011 1110 1    Ma&#x3D;1.001 1001 1001 1001 1001 1010</span><br><span class=\"line\"></span><br><span class=\"line\">b&#x3D;(1.6)10&#x3D;(0011 1111 1100 1100 1100 1100 1100 1101)2      Sb&#x3D;0    Eb&#x3D;011 1111 1     Mb&#x3D;1.100 1100 1100 1100 1100 1101</span><br></pre></td></tr></table></figure>\n<h5 id=\"对阶\"><a class=\"header-anchor\" href=\"#对阶\">¶</a>对阶</h5>\n<blockquote>\n<p>简单的说就是需要阶码对齐,使其尾数可以进行加减运算,即:</p>\n</blockquote>\n<p>$ ⊿E = E_b -E_a $</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ea&lt;Eb   Eb-Ea=<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">Ma要调整为 <span class=\"number\">0.0</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">1001</span> <span class=\"number\">10</span>       <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\">E=<span class=\"number\">011</span> <span class=\"number\">1111</span> <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"尾数\"><a class=\"header-anchor\" href=\"#尾数\">¶</a>尾数</h5>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"number\">0.01001100110011001100110</span></span><br><span class=\"line\">+ <span class=\"number\">1.10011001100110011001101</span></span><br><span class=\"line\">----------------------------</span><br><span class=\"line\">  <span class=\"number\">1.11100110011001100110011</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"规格化\"><a class=\"header-anchor\" href=\"#规格化\">¶</a>规格化</h5>\n<p>尾数的格式 $ 1.M $,尾数可能是非规格化的,所以需要左规和右规操作:</p>\n<ul>\n<li>左规操作: 尾数左移,阶码减值</li>\n<li>右规操作: 尾数右移,阶码+值</li>\n</ul>\n<p>$ 目的: 1 \\leq M &lt; 2 $</p>\n<ul>\n<li><input type=\"checkbox\" id=\"checkbox0\" checked=\"true\"><label for=\"checkbox0\">1.11100110011001100110011‬</label></li>\n</ul>\n<h5 id=\"舍入处理\"><a class=\"header-anchor\" href=\"#舍入处理\">¶</a>舍入处理</h5>\n<blockquote>\n<p>四种舍入方式:</p>\n</blockquote>\n<ul>\n<li>就近舍入: 四舍五入</li>\n<li>朝+∞舍入</li>\n<li>朝-∞舍入</li>\n<li>朝0舍入</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在对阶时，Ma有右移，且第一次最高为<span class=\"number\">1</span>，第二次为<span class=\"number\">0</span>，</span><br><span class=\"line\">所以按<span class=\"string\">&quot;0舍1入&quot;</span>， ==&gt; 精度丢失的关键, </span><br><span class=\"line\">尾数运算结果调整为 <span class=\"number\">1.11100110011001100110100</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"溢出判断\"><a class=\"header-anchor\" href=\"#溢出判断\">¶</a>溢出判断</h5>\n<blockquote>\n<p>判断结果标准: 运算结果的阶码</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a+b=(<span class=\"number\">0</span>  <span class=\"number\">01111111</span>  <span class=\"number\">11100110011001100110100</span>)<span class=\"number\">2</span></span><br><span class=\"line\">=(<span class=\"number\">0011</span> <span class=\"number\">1111</span> <span class=\"number\">1111</span> <span class=\"number\">0011</span> <span class=\"number\">0011</span> <span class=\"number\">0011</span> <span class=\"number\">0011</span> <span class=\"number\">0100</span>)<span class=\"number\">2</span>=(<span class=\"number\">3</span>FF33334)<span class=\"number\">16</span></span><br><span class=\"line\"></span><br><span class=\"line\">转为<span class=\"number\">10</span>进制</span><br><span class=\"line\"></span><br><span class=\"line\">a+b=<span class=\"number\">1.90000010</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"float计算改进\"><a class=\"header-anchor\" href=\"#float计算改进\">¶</a>float计算改进</h3>\n<h4 id=\"尽量避免使用高精度且重要的数据计算-如-¥\"><a class=\"header-anchor\" href=\"#尽量避免使用高精度且重要的数据计算-如-¥\">¶</a>尽量避免使用高精度且重要的数据计算: 如: ¥</h4>\n<h4 id=\"统一取舍位数\"><a class=\"header-anchor\" href=\"#统一取舍位数\">¶</a>统一取舍位数</h4>\n<ul>\n<li>统一保留</li>\n<li>统一取舍算法</li>\n</ul>\n<h4 id=\"建议用int-string类型\"><a class=\"header-anchor\" href=\"#建议用int-string类型\">¶</a>建议用int/string类型</h4>\n<ul>\n<li>缺点:\n<ul>\n<li>牺牲性能</li>\n<li>转换复杂</li>\n</ul>\n</li>\n<li>优点:\n<ul>\n<li>提高准确度</li>\n<li>处理可多元化</li>\n</ul>\n</li>\n</ul>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://math.now.sh?from=value%20%3D%20%20sign%20*%20exponent%20*%20fraction%20%0A","popularPost_tmp_gaData":{"updated":"Sat Feb 06 2021 10:01:17 GMT+0800 (中国标准时间)","title":"「33」Float IEEE标准","path":"archives/257c4ce2.html","eyeCatchImage":"https://math.now.sh?from=value%20%3D%20%20sign%20*%20exponent%20*%20fraction%20%0A","excerpt":"<h3 id=\"前序\"><a class=\"header-anchor\" href=\"#前序\">¶</a>前序</h3>\n<p>前几天踩坑Float类型的计算问题,今天来系统的总结下float相关的知识点.</p>\n<h3 id=\"掌握关键点\"><a class=\"header-anchor\" href=\"#掌握关键点\">¶</a>掌握关键点:</h3>\n<ul>\n<li>float的标准是什么?</li>\n<li>float的位计算规则</li>\n<li>float场景</li>\n<li>float计算改进</li>\n</ul>","date":{"_isAMomentObject":true,"_i":"2021-02-06T02:01:17.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2021-02-06T02:01:17.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Day","Float","IEEE","位运算"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":1420},{"title":"「4」Git常用技巧","date":"2020-09-01T11:22:02.000Z","updated":"2020-11-10T11:22:02.000Z","keywords":"git,git技巧,git常用技巧","abbrlink":"3c1dd822","_content":"### 学习方式\n多练多得，直接学习[官网](https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6)理解。\n\n以下仅仅是部分用到的场景和部分场景记录，不代表全部情况，如有错误，请及时指正。\n\n### Git版本：\n```\n1944 ± git version \ngit version 2.28.0\n```\n### 先说说Git的常用命令：(可跳过)\n<!-- more -->\n```\n2081 ◯  git \n用法：git [--version] [--help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           <command> [<args>]\n\n这些是各种场合常见的 Git 命令：\n\n开始一个工作区（参见：git help tutorial）\n   clone             克隆仓库到一个新目录\n   init              创建一个空的 Git 仓库或重新初始化一个已存在的仓库\n\n在当前变更上工作（参见：git help everyday）\n   add               添加文件内容至索引\n   mv                移动或重命名一个文件、目录或符号链接\n   restore           恢复工作区文件\n   rm                从工作区和索引中删除文件\n   sparse-checkout   初始化及修改稀疏检出\n\n检查历史和状态（参见：git help revisions）\n   bisect            通过二分查找定位引入 bug 的提交\n   diff              显示提交之间、提交和工作区之间等的差异\n   grep              输出和模式匹配的行\n   log               显示提交日志\n   show              显示各种类型的对象\n   status            显示工作区状态\n\n扩展、标记和调校您的历史记录\n   branch            列出、创建或删除分支\n   commit            记录变更到仓库\n   merge             合并两个或更多开发历史\n   rebase            在另一个分支上重新应用提交\n   reset             重置当前 HEAD 到指定状态\n   switch            切换分支\n   tag               创建、列出、删除或校验一个 GPG 签名的标签对象\n\n协同（参见：git help workflows）\n   fetch             从另外一个仓库下载对象和引用\n   pull              获取并整合另外的仓库或一个本地分支\n   push              更新远程引用和相关的对象\n\n命令 'git help -a' 和 'git help -g' 显示可用的子命令和一些概念帮助。\n查看 'git help <命令>' 或 'git help <概念>' 以获取给定子命令或概念的\n帮助。\n有关系统的概述，查看 'git help git'\n```\n\n### Git使用：\n\n#### 生成密钥\n```\nssh-keygen -t rsa -C \"这里换上你的邮箱\"\n```\n\n最后得到`id_rsa`和`id_rsa.pub`两个文件。\n\n#### Git配置信息\n\n##### 查看配置信息\n```\n查看系统配置信息\n* git config --system --list\n\n当前用户配置\n* git config --global --list\n\n查看当前仓库配置\n* git config --local --list\n```\n\n##### 设置用户信息\n全局设置：\n```\ngit config --global user.name \"crab\"\ngit config --global user.email \"imrcrab@163.com\"\n```\n\n当前仓库生效：\n```\ngit config --local user.name \"crab\"\ngit config --local user.email \"imrcrab@163.com\"\n```\n\n\n\n#### Git Remote\n\n##### 新增remote地址\n\n```\ngit remote add upstream http://github/**remote**/test.git\ngit remote -v 可以查看具体路径\n```\n##### merge/fetch远程代码到XXX分支\n```\n1、git fetch upstream。\n2、切回到master分支。\n3、git merge upstream/master 合并远程upstream分支到本地master。\n4、解决冲突或其他问题。\n```\n\n#### Git 误删除恢复\n\n```\n1、git  fsck --lost -found :查看最近移除的文件.\n2、git show  '误删编号'：查看删除文件内容.\n3、git merge ‘误删编号’： 本地合并误删的文件内容.\n```\n\n#### Git reset撤回操作\n```\n1、git reflog\n2、git reset COMMITID    就可以回到COMMITID那个分支和版本。\n```\n\n#### Git分支\n\n##### 用法 \n>获取用法：Git branch -d --help\n\n```\n用法：git branch [<选项>] [-r | -a] [--merged | --no-merged]\n  或：git branch [<选项>] [-l] [-f] <分支名> [<起始点>]\n  或：git branch [<选项>] [-r] (-d | -D) <分支名>...\n  或：git branch [<选项>] (-m | -M) [<旧分支>] <新分支>\n  或：git branch [<选项>] (-c | -C) [<老分支>] <新分支>\n  或：git branch [<选项>] [-r | -a] [--points-at]\n  或：git branch [<选项>] [-r | -a] [--format]\n\n通用选项\n    -v, --verbose         显示哈希值和主题，若参数出现两次则显示上游分支\n    -q, --quiet           不显示信息\n    -t, --track           设置跟踪模式（参见 git-pull(1)）\n    -u, --set-upstream-to <上游>\n                          改变上游信息\n    --unset-upstream      取消上游信息的设置\n    --color[=<何时>]      使用彩色输出\n    -r, --remotes         作用于远程跟踪分支\n    --contains <提交>     只打印包含该提交的分支\n    --no-contains <提交>  只打印不包含该提交的分支\n    --abbrev[=<n>]        用 <n> 位数字显示 SHA-1 哈希值\n\n具体的 git-branch 动作：\n    -a, --all             列出远程跟踪及本地分支\n    -d, --delete          删除完全合并的分支\n    -D                    删除分支（即使没有合并）\n    -m, --move            移动/重命名一个分支，以及它的引用日志\n    -M                    移动/重命名一个分支，即使目标已存在\n    -c, --copy            拷贝一个分支和它的引用日志\n    -C                    拷贝一个分支，即使目标已存在\n    -l, --list            列出分支名\n    --show-current        显示当前分支名\n    --create-reflog       创建分支的引用日志\n    --edit-description    标记分支的描述\n    -f, --force           强制创建、移动/重命名、删除\n    --merged <提交>       只打印已经合并的分支\n    --no-merged <提交>    只打印尚未合并的分支\n    --column[=<风格>]     以列的方式显示分支\n    --sort <key>          排序的字段名\n    --points-at <对象>    只打印指向该对象的分支\n    -i, --ignore-case     排序和过滤属于大小写不敏感\n    --format <格式>       输出格式\n```\n\n##### 获取所有分支\n```\ngit branch -r | grep -v '\\->' | while read remote; do git branch --track \"${remote#origin/}\" \"$remote\"; done\ngit fetch --all\ngit pull --all\n```\n##### add/remove分支\n新建&切换:\n```\ngit checkout -b iss53\n\n是下面两条的简写：\ngit branch iss53\ngit checkout iss53\n```\n删除分支：\n```\ngit branch -d iss53\n```\n\n#### Git stash\n\n##### 常用：\n```\n（1）git stash save \"save message\"  : 执行存储时，添加备注，方便查找，只有git stash 也要可以的，但查找时不方便识别。\n（2）git stash list  ：查看stash了哪些存储\n（3）git stash show ：显示做了哪些改动，默认show第一个存储,如果要显示其他存贮，后面加stash@{$num}，比如第二个 git stash show stash@{1}\n（4）git stash show -p : 显示第一个存储的改动，如果想显示其他存存储，命令：git stash show  stash@{$num}  -p ，比如第二个：git stash show  stash@{1}  -p\n（5）git stash apply :应用某个存储,但不会把存储从存储列表中删除，默认使用第一个存储,即stash@{0}，如果要使用其他个，git stash apply stash@{$num} ， 比如第二个：git stash apply stash@{1} \n（6）git stash pop ：命令恢复之前缓存的工作目录，将缓存堆栈中的对应stash删除，并将对应修改应用到当前的工作目录下,默认为第一个stash,即stash@{0}，如果要应用并删除其他stash，命令：git stash pop stash@{$num} ，比如应用并删除第二个：git stash pop stash@{1}\n（7）git stash drop stash@{$num} ：丢弃stash@{$num}存储，从列表中删除这个存储\n（8）git stash clear ：删除所有缓存的stash\n```\n\n#### Git Tag\n\n##### 常用：\n```\n2097 ± git tag -a --help\n用法：git tag [-a | -s | -u <key-id>] [-f] [-m <消息> | -F <文件>]\n\t\t<标签名> [<头>]\n  或：git tag -d <标签名>...\n  或：git tag -l [-n[<数字>]] [--contains <提交>] [--no-contains <提交>] [--points-at <对象>]\n\t\t[--format=<格式>] [--[no-]merged [<提交>]] [<模式>...]\n  或：git tag -v [--format=<格式>] <标签名>...\n\n    -l, --list            列出标签名称\n    -n[<n>]               每个标签信息打印 <n> 行\n    -d, --delete          删除标签\n    -v, --verify          验证标签\n\n标签创建选项\n    -a, --annotate        附注标签，需要一个说明\n    -m, --message <说明>  标签说明\n    -F, --file <文件>     从文件中读取提交说明\n    -e, --edit            强制编辑标签说明\n    -s, --sign            附注并附加 GPG 签名的标签\n    --cleanup <模式>      设置如何删除提交说明里的空格和#注释\n    -u, --local-user <key-id>\n                          使用另外的私钥签名该标签\n    -f, --force           如果存在，替换现有的标签\n    --create-reflog       创建引用日志\n\n标签列表选项\n    --column[=<风格>]     以列的方式显示标签列表\n    --contains <提交>     只打印包含该提交的标签\n    --no-contains <提交>  只打印不包含该提交的标签\n    --merged <提交>       只打印已经合并的标签\n    --no-merged <提交>    只打印尚未合并的标签\n    --sort <key>          排序的字段名\n    --points-at <对象>    只打印指向该对象的标签\n    --format <格式>       输出格式\n    --color[=<何时>]      遵照格式中的颜色输出\n    -i, --ignore-case     排序和过滤属于大小写不敏感\n```\n\n```\ngit tag按照version排序：\ngit tag -n\n\ngit tag按照时间排序\ngit tag -n --sort=taggerdate\n```\n\n##### 打Tag\n```\ngit tag -a v0.0.1 -m \"V0.0.1\" \n```\n\n##### 删除Tag\n\n```\ngit tag -d v0.0.1\n```\n\n##### 推送Tag\n\n```\ngit push origin master --tags\n```\n\n#### Git push\n\n##### 用法\n```\n用法：git push [<选项>] [<仓库> [<引用规格>...]]\n\n    -v, --verbose         更加详细\n    -q, --quiet           更加安静\n    --repo <仓库>         仓库\n    --all                 推送所有引用\n    --mirror              镜像所有引用\n    -d, --delete          删除引用\n    --tags                推送标签（不能使用 --all or --mirror）\n    -n, --dry-run         演习\n    --porcelain           机器可读的输出\n    -f, --force           强制更新\n    --force-with-lease[=<引用名>:<期望值>]\n                          要求引用旧的取值为设定值\n    --recurse-submodules (check|on-demand|no)\n                          控制子模组的递归推送\n    --thin                使用精简打包\n    --receive-pack <receive-pack>\n                          接收包程序\n    --exec <receive-pack>\n                          接收包程序\n    -u, --set-upstream    设置 git pull/status 的上游\n    --progress            强制显示进度报告\n    --prune               清除本地删除的引用\n    --no-verify           绕过 pre-push 钩子\n    --follow-tags         推送缺失但有关的标签\n    --signed[=(yes|no|if-asked)]\n                          用 GPG 为推送签名\n    --atomic              需要远端支持原子事务\n    -o, --push-option <server-specific>\n                          传输选项\n    -4, --ipv4            只使用 IPv4 地址\n    -6, --ipv6            只使用 IPv6 地址\n```\n\n#### Git rebase\n\n##### 变基遵守的原则\n\n```\n如果提交存在于你的仓库之外，而别人可能基于这些提交进行开发，那么不要执行变基。---[官网变基](https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)\n\nTODO 后续更新此过程\n```\n\n\n##### 经典用法：\n>git rebase --help\n```\nAssume the following history exists and the current branch is \"topic\":\n\n              A---B---C topic\n             /\n        D---E---F---G master\nFrom this point, the result of either of thefollowing \n\ncommands:\n    git rebase master\n    git rebase master topic\n\n\nwould be:\n                      A'--B'--C' topic\n                     /\n        D---E---F---G master\n```\n\n##### rebase场景：\n\n[官网例子](https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)\n\n\n\n### Git 快速场景：\n其实还是对上述命令的活学活用。\n\n#### Git Reset场景\n```\n1. 本地修改了一堆文件(并没有使用git add到暂存区)，想放弃修改。\n单个文件/文件夹：\n\ngit checkout -- filename\n\n所有文件/文件夹：\n\ngit checkout .\n \n2. 本地新增了一堆文件(并没有git add到暂存区)，想放弃修改。\n单个文件/文件夹：\n\n$ rm filename / rm dir -rf\n\n所有文件/文件夹：\n\n$ git clean -xdf\n\n// 删除新增的文件，如果文件已经已经git add到暂存区，并不会删除！\n\n3. 本地修改/新增了一堆文件，已经git add到暂存区，想放弃修改。\n单个文件/文件夹：\n\ngit reset HEAD filename\n\n所有文件/文件夹：\n\ngit reset HEAD .\n \n4. 本地通过git add & git commit 之后，想要撤销此次commit和代码\n\ngit reset commit_id\n\n这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位\n// 撤销之后，你所做的已经commit的修改还在工作区！\n\ngit reset --hard commit_id\n\n这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位\n// 撤销之后，你所做的已经commit的修改将会清除，仍在工作区/暂存区的代码不会清除！\n\n5. git add & git commit 提交后，只想回滚commit：\n\tgit reset --soft HEAD^\n\t注意这仅仅是回滚了你的commit，代码依旧在的。\n```\n\n### 持续更新......","source":"_posts/4-Git常用技巧.md","raw":"---\ntitle: 「4」Git常用技巧\ndate: '2020/09/01 19:22:02'\nupdated: '2020/11/10 19:22:02'\nkeywords: 'git,git技巧,git常用技巧'\ntags:\n  - Git\nabbrlink: 3c1dd822\n---\n### 学习方式\n多练多得，直接学习[官网](https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6)理解。\n\n以下仅仅是部分用到的场景和部分场景记录，不代表全部情况，如有错误，请及时指正。\n\n### Git版本：\n```\n1944 ± git version \ngit version 2.28.0\n```\n### 先说说Git的常用命令：(可跳过)\n<!-- more -->\n```\n2081 ◯  git \n用法：git [--version] [--help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           <command> [<args>]\n\n这些是各种场合常见的 Git 命令：\n\n开始一个工作区（参见：git help tutorial）\n   clone             克隆仓库到一个新目录\n   init              创建一个空的 Git 仓库或重新初始化一个已存在的仓库\n\n在当前变更上工作（参见：git help everyday）\n   add               添加文件内容至索引\n   mv                移动或重命名一个文件、目录或符号链接\n   restore           恢复工作区文件\n   rm                从工作区和索引中删除文件\n   sparse-checkout   初始化及修改稀疏检出\n\n检查历史和状态（参见：git help revisions）\n   bisect            通过二分查找定位引入 bug 的提交\n   diff              显示提交之间、提交和工作区之间等的差异\n   grep              输出和模式匹配的行\n   log               显示提交日志\n   show              显示各种类型的对象\n   status            显示工作区状态\n\n扩展、标记和调校您的历史记录\n   branch            列出、创建或删除分支\n   commit            记录变更到仓库\n   merge             合并两个或更多开发历史\n   rebase            在另一个分支上重新应用提交\n   reset             重置当前 HEAD 到指定状态\n   switch            切换分支\n   tag               创建、列出、删除或校验一个 GPG 签名的标签对象\n\n协同（参见：git help workflows）\n   fetch             从另外一个仓库下载对象和引用\n   pull              获取并整合另外的仓库或一个本地分支\n   push              更新远程引用和相关的对象\n\n命令 'git help -a' 和 'git help -g' 显示可用的子命令和一些概念帮助。\n查看 'git help <命令>' 或 'git help <概念>' 以获取给定子命令或概念的\n帮助。\n有关系统的概述，查看 'git help git'\n```\n\n### Git使用：\n\n#### 生成密钥\n```\nssh-keygen -t rsa -C \"这里换上你的邮箱\"\n```\n\n最后得到`id_rsa`和`id_rsa.pub`两个文件。\n\n#### Git配置信息\n\n##### 查看配置信息\n```\n查看系统配置信息\n* git config --system --list\n\n当前用户配置\n* git config --global --list\n\n查看当前仓库配置\n* git config --local --list\n```\n\n##### 设置用户信息\n全局设置：\n```\ngit config --global user.name \"crab\"\ngit config --global user.email \"imrcrab@163.com\"\n```\n\n当前仓库生效：\n```\ngit config --local user.name \"crab\"\ngit config --local user.email \"imrcrab@163.com\"\n```\n\n\n\n#### Git Remote\n\n##### 新增remote地址\n\n```\ngit remote add upstream http://github/**remote**/test.git\ngit remote -v 可以查看具体路径\n```\n##### merge/fetch远程代码到XXX分支\n```\n1、git fetch upstream。\n2、切回到master分支。\n3、git merge upstream/master 合并远程upstream分支到本地master。\n4、解决冲突或其他问题。\n```\n\n#### Git 误删除恢复\n\n```\n1、git  fsck --lost -found :查看最近移除的文件.\n2、git show  '误删编号'：查看删除文件内容.\n3、git merge ‘误删编号’： 本地合并误删的文件内容.\n```\n\n#### Git reset撤回操作\n```\n1、git reflog\n2、git reset COMMITID    就可以回到COMMITID那个分支和版本。\n```\n\n#### Git分支\n\n##### 用法 \n>获取用法：Git branch -d --help\n\n```\n用法：git branch [<选项>] [-r | -a] [--merged | --no-merged]\n  或：git branch [<选项>] [-l] [-f] <分支名> [<起始点>]\n  或：git branch [<选项>] [-r] (-d | -D) <分支名>...\n  或：git branch [<选项>] (-m | -M) [<旧分支>] <新分支>\n  或：git branch [<选项>] (-c | -C) [<老分支>] <新分支>\n  或：git branch [<选项>] [-r | -a] [--points-at]\n  或：git branch [<选项>] [-r | -a] [--format]\n\n通用选项\n    -v, --verbose         显示哈希值和主题，若参数出现两次则显示上游分支\n    -q, --quiet           不显示信息\n    -t, --track           设置跟踪模式（参见 git-pull(1)）\n    -u, --set-upstream-to <上游>\n                          改变上游信息\n    --unset-upstream      取消上游信息的设置\n    --color[=<何时>]      使用彩色输出\n    -r, --remotes         作用于远程跟踪分支\n    --contains <提交>     只打印包含该提交的分支\n    --no-contains <提交>  只打印不包含该提交的分支\n    --abbrev[=<n>]        用 <n> 位数字显示 SHA-1 哈希值\n\n具体的 git-branch 动作：\n    -a, --all             列出远程跟踪及本地分支\n    -d, --delete          删除完全合并的分支\n    -D                    删除分支（即使没有合并）\n    -m, --move            移动/重命名一个分支，以及它的引用日志\n    -M                    移动/重命名一个分支，即使目标已存在\n    -c, --copy            拷贝一个分支和它的引用日志\n    -C                    拷贝一个分支，即使目标已存在\n    -l, --list            列出分支名\n    --show-current        显示当前分支名\n    --create-reflog       创建分支的引用日志\n    --edit-description    标记分支的描述\n    -f, --force           强制创建、移动/重命名、删除\n    --merged <提交>       只打印已经合并的分支\n    --no-merged <提交>    只打印尚未合并的分支\n    --column[=<风格>]     以列的方式显示分支\n    --sort <key>          排序的字段名\n    --points-at <对象>    只打印指向该对象的分支\n    -i, --ignore-case     排序和过滤属于大小写不敏感\n    --format <格式>       输出格式\n```\n\n##### 获取所有分支\n```\ngit branch -r | grep -v '\\->' | while read remote; do git branch --track \"${remote#origin/}\" \"$remote\"; done\ngit fetch --all\ngit pull --all\n```\n##### add/remove分支\n新建&切换:\n```\ngit checkout -b iss53\n\n是下面两条的简写：\ngit branch iss53\ngit checkout iss53\n```\n删除分支：\n```\ngit branch -d iss53\n```\n\n#### Git stash\n\n##### 常用：\n```\n（1）git stash save \"save message\"  : 执行存储时，添加备注，方便查找，只有git stash 也要可以的，但查找时不方便识别。\n（2）git stash list  ：查看stash了哪些存储\n（3）git stash show ：显示做了哪些改动，默认show第一个存储,如果要显示其他存贮，后面加stash@{$num}，比如第二个 git stash show stash@{1}\n（4）git stash show -p : 显示第一个存储的改动，如果想显示其他存存储，命令：git stash show  stash@{$num}  -p ，比如第二个：git stash show  stash@{1}  -p\n（5）git stash apply :应用某个存储,但不会把存储从存储列表中删除，默认使用第一个存储,即stash@{0}，如果要使用其他个，git stash apply stash@{$num} ， 比如第二个：git stash apply stash@{1} \n（6）git stash pop ：命令恢复之前缓存的工作目录，将缓存堆栈中的对应stash删除，并将对应修改应用到当前的工作目录下,默认为第一个stash,即stash@{0}，如果要应用并删除其他stash，命令：git stash pop stash@{$num} ，比如应用并删除第二个：git stash pop stash@{1}\n（7）git stash drop stash@{$num} ：丢弃stash@{$num}存储，从列表中删除这个存储\n（8）git stash clear ：删除所有缓存的stash\n```\n\n#### Git Tag\n\n##### 常用：\n```\n2097 ± git tag -a --help\n用法：git tag [-a | -s | -u <key-id>] [-f] [-m <消息> | -F <文件>]\n\t\t<标签名> [<头>]\n  或：git tag -d <标签名>...\n  或：git tag -l [-n[<数字>]] [--contains <提交>] [--no-contains <提交>] [--points-at <对象>]\n\t\t[--format=<格式>] [--[no-]merged [<提交>]] [<模式>...]\n  或：git tag -v [--format=<格式>] <标签名>...\n\n    -l, --list            列出标签名称\n    -n[<n>]               每个标签信息打印 <n> 行\n    -d, --delete          删除标签\n    -v, --verify          验证标签\n\n标签创建选项\n    -a, --annotate        附注标签，需要一个说明\n    -m, --message <说明>  标签说明\n    -F, --file <文件>     从文件中读取提交说明\n    -e, --edit            强制编辑标签说明\n    -s, --sign            附注并附加 GPG 签名的标签\n    --cleanup <模式>      设置如何删除提交说明里的空格和#注释\n    -u, --local-user <key-id>\n                          使用另外的私钥签名该标签\n    -f, --force           如果存在，替换现有的标签\n    --create-reflog       创建引用日志\n\n标签列表选项\n    --column[=<风格>]     以列的方式显示标签列表\n    --contains <提交>     只打印包含该提交的标签\n    --no-contains <提交>  只打印不包含该提交的标签\n    --merged <提交>       只打印已经合并的标签\n    --no-merged <提交>    只打印尚未合并的标签\n    --sort <key>          排序的字段名\n    --points-at <对象>    只打印指向该对象的标签\n    --format <格式>       输出格式\n    --color[=<何时>]      遵照格式中的颜色输出\n    -i, --ignore-case     排序和过滤属于大小写不敏感\n```\n\n```\ngit tag按照version排序：\ngit tag -n\n\ngit tag按照时间排序\ngit tag -n --sort=taggerdate\n```\n\n##### 打Tag\n```\ngit tag -a v0.0.1 -m \"V0.0.1\" \n```\n\n##### 删除Tag\n\n```\ngit tag -d v0.0.1\n```\n\n##### 推送Tag\n\n```\ngit push origin master --tags\n```\n\n#### Git push\n\n##### 用法\n```\n用法：git push [<选项>] [<仓库> [<引用规格>...]]\n\n    -v, --verbose         更加详细\n    -q, --quiet           更加安静\n    --repo <仓库>         仓库\n    --all                 推送所有引用\n    --mirror              镜像所有引用\n    -d, --delete          删除引用\n    --tags                推送标签（不能使用 --all or --mirror）\n    -n, --dry-run         演习\n    --porcelain           机器可读的输出\n    -f, --force           强制更新\n    --force-with-lease[=<引用名>:<期望值>]\n                          要求引用旧的取值为设定值\n    --recurse-submodules (check|on-demand|no)\n                          控制子模组的递归推送\n    --thin                使用精简打包\n    --receive-pack <receive-pack>\n                          接收包程序\n    --exec <receive-pack>\n                          接收包程序\n    -u, --set-upstream    设置 git pull/status 的上游\n    --progress            强制显示进度报告\n    --prune               清除本地删除的引用\n    --no-verify           绕过 pre-push 钩子\n    --follow-tags         推送缺失但有关的标签\n    --signed[=(yes|no|if-asked)]\n                          用 GPG 为推送签名\n    --atomic              需要远端支持原子事务\n    -o, --push-option <server-specific>\n                          传输选项\n    -4, --ipv4            只使用 IPv4 地址\n    -6, --ipv6            只使用 IPv6 地址\n```\n\n#### Git rebase\n\n##### 变基遵守的原则\n\n```\n如果提交存在于你的仓库之外，而别人可能基于这些提交进行开发，那么不要执行变基。---[官网变基](https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)\n\nTODO 后续更新此过程\n```\n\n\n##### 经典用法：\n>git rebase --help\n```\nAssume the following history exists and the current branch is \"topic\":\n\n              A---B---C topic\n             /\n        D---E---F---G master\nFrom this point, the result of either of thefollowing \n\ncommands:\n    git rebase master\n    git rebase master topic\n\n\nwould be:\n                      A'--B'--C' topic\n                     /\n        D---E---F---G master\n```\n\n##### rebase场景：\n\n[官网例子](https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)\n\n\n\n### Git 快速场景：\n其实还是对上述命令的活学活用。\n\n#### Git Reset场景\n```\n1. 本地修改了一堆文件(并没有使用git add到暂存区)，想放弃修改。\n单个文件/文件夹：\n\ngit checkout -- filename\n\n所有文件/文件夹：\n\ngit checkout .\n \n2. 本地新增了一堆文件(并没有git add到暂存区)，想放弃修改。\n单个文件/文件夹：\n\n$ rm filename / rm dir -rf\n\n所有文件/文件夹：\n\n$ git clean -xdf\n\n// 删除新增的文件，如果文件已经已经git add到暂存区，并不会删除！\n\n3. 本地修改/新增了一堆文件，已经git add到暂存区，想放弃修改。\n单个文件/文件夹：\n\ngit reset HEAD filename\n\n所有文件/文件夹：\n\ngit reset HEAD .\n \n4. 本地通过git add & git commit 之后，想要撤销此次commit和代码\n\ngit reset commit_id\n\n这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位\n// 撤销之后，你所做的已经commit的修改还在工作区！\n\ngit reset --hard commit_id\n\n这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位\n// 撤销之后，你所做的已经commit的修改将会清除，仍在工作区/暂存区的代码不会清除！\n\n5. git add & git commit 提交后，只想回滚commit：\n\tgit reset --soft HEAD^\n\t注意这仅仅是回滚了你的commit，代码依旧在的。\n```\n\n### 持续更新......","slug":"4-Git常用技巧","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlk00213ci7hecm7yhx","content":"<h3 id=\"学习方式\"><a class=\"header-anchor\" href=\"#学习方式\">¶</a>学习方式</h3>\n<p>多练多得，直接学习<a href=\"https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6\">官网</a>理解。</p>\n<p>以下仅仅是部分用到的场景和部分场景记录，不代表全部情况，如有错误，请及时指正。</p>\n<h3 id=\"Git版本：\"><a class=\"header-anchor\" href=\"#Git版本：\">¶</a>Git版本：</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1944 ± git version </span><br><span class=\"line\">git version 2.28.0</span><br></pre></td></tr></table></figure>\n<h3 id=\"先说说Git的常用命令：-可跳过\"><a class=\"header-anchor\" href=\"#先说说Git的常用命令：-可跳过\">¶</a>先说说Git的常用命令：(可跳过)</h3>\n<a id=\"more\"></a>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2081 ◯  git </span><br><span class=\"line\">用法：git [--version] [--help] [-C &lt;path&gt;] [-c &lt;name&gt;&#x3D;&lt;value&gt;]</span><br><span class=\"line\">           [--exec-path[&#x3D;&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class=\"line\">           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]</span><br><span class=\"line\">           [--git-dir&#x3D;&lt;path&gt;] [--work-tree&#x3D;&lt;path&gt;] [--namespace&#x3D;&lt;name&gt;]</span><br><span class=\"line\">           &lt;command&gt; [&lt;args&gt;]</span><br><span class=\"line\"></span><br><span class=\"line\">这些是各种场合常见的 Git 命令：</span><br><span class=\"line\"></span><br><span class=\"line\">开始一个工作区（参见：git help tutorial）</span><br><span class=\"line\">   clone             克隆仓库到一个新目录</span><br><span class=\"line\">   init              创建一个空的 Git 仓库或重新初始化一个已存在的仓库</span><br><span class=\"line\"></span><br><span class=\"line\">在当前变更上工作（参见：git help everyday）</span><br><span class=\"line\">   add               添加文件内容至索引</span><br><span class=\"line\">   mv                移动或重命名一个文件、目录或符号链接</span><br><span class=\"line\">   restore           恢复工作区文件</span><br><span class=\"line\">   rm                从工作区和索引中删除文件</span><br><span class=\"line\">   sparse-checkout   初始化及修改稀疏检出</span><br><span class=\"line\"></span><br><span class=\"line\">检查历史和状态（参见：git help revisions）</span><br><span class=\"line\">   bisect            通过二分查找定位引入 bug 的提交</span><br><span class=\"line\">   diff              显示提交之间、提交和工作区之间等的差异</span><br><span class=\"line\">   grep              输出和模式匹配的行</span><br><span class=\"line\">   log               显示提交日志</span><br><span class=\"line\">   show              显示各种类型的对象</span><br><span class=\"line\">   status            显示工作区状态</span><br><span class=\"line\"></span><br><span class=\"line\">扩展、标记和调校您的历史记录</span><br><span class=\"line\">   branch            列出、创建或删除分支</span><br><span class=\"line\">   commit            记录变更到仓库</span><br><span class=\"line\">   merge             合并两个或更多开发历史</span><br><span class=\"line\">   rebase            在另一个分支上重新应用提交</span><br><span class=\"line\">   reset             重置当前 HEAD 到指定状态</span><br><span class=\"line\">   switch            切换分支</span><br><span class=\"line\">   tag               创建、列出、删除或校验一个 GPG 签名的标签对象</span><br><span class=\"line\"></span><br><span class=\"line\">协同（参见：git help workflows）</span><br><span class=\"line\">   fetch             从另外一个仓库下载对象和引用</span><br><span class=\"line\">   pull              获取并整合另外的仓库或一个本地分支</span><br><span class=\"line\">   push              更新远程引用和相关的对象</span><br><span class=\"line\"></span><br><span class=\"line\">命令 &#39;git help -a&#39; 和 &#39;git help -g&#39; 显示可用的子命令和一些概念帮助。</span><br><span class=\"line\">查看 &#39;git help &lt;命令&gt;&#39; 或 &#39;git help &lt;概念&gt;&#39; 以获取给定子命令或概念的</span><br><span class=\"line\">帮助。</span><br><span class=\"line\">有关系统的概述，查看 &#39;git help git&#39;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Git使用：\"><a class=\"header-anchor\" href=\"#Git使用：\">¶</a>Git使用：</h3>\n<h4 id=\"生成密钥\"><a class=\"header-anchor\" href=\"#生成密钥\">¶</a>生成密钥</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -C &quot;这里换上你的邮箱&quot;</span><br></pre></td></tr></table></figure>\n<p>最后得到<code>id_rsa</code>和<code>id_rsa.pub</code>两个文件。</p>\n<h4 id=\"Git配置信息\"><a class=\"header-anchor\" href=\"#Git配置信息\">¶</a>Git配置信息</h4>\n<h5 id=\"查看配置信息\"><a class=\"header-anchor\" href=\"#查看配置信息\">¶</a>查看配置信息</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查看系统配置信息</span><br><span class=\"line\">* git config --system --list</span><br><span class=\"line\"></span><br><span class=\"line\">当前用户配置</span><br><span class=\"line\">* git config --global --list</span><br><span class=\"line\"></span><br><span class=\"line\">查看当前仓库配置</span><br><span class=\"line\">* git config --local --list</span><br></pre></td></tr></table></figure>\n<h5 id=\"设置用户信息\"><a class=\"header-anchor\" href=\"#设置用户信息\">¶</a>设置用户信息</h5>\n<p>全局设置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global user.name &quot;crab&quot;</span><br><span class=\"line\">git config --global user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>\n<p>当前仓库生效：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --local user.name &quot;crab&quot;</span><br><span class=\"line\">git config --local user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-Remote\"><a class=\"header-anchor\" href=\"#Git-Remote\">¶</a>Git Remote</h4>\n<h5 id=\"新增remote地址\"><a class=\"header-anchor\" href=\"#新增remote地址\">¶</a>新增remote地址</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git remote add upstream http:&#x2F;&#x2F;github&#x2F;**remote**&#x2F;test.git</span><br><span class=\"line\">git remote -v 可以查看具体路径</span><br></pre></td></tr></table></figure>\n<h5 id=\"merge-fetch远程代码到XXX分支\"><a class=\"header-anchor\" href=\"#merge-fetch远程代码到XXX分支\">¶</a>merge/fetch远程代码到XXX分支</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git fetch upstream。</span><br><span class=\"line\">2、切回到master分支。</span><br><span class=\"line\">3、git merge upstream&#x2F;master 合并远程upstream分支到本地master。</span><br><span class=\"line\">4、解决冲突或其他问题。</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-误删除恢复\"><a class=\"header-anchor\" href=\"#Git-误删除恢复\">¶</a>Git 误删除恢复</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git  fsck --lost -found :查看最近移除的文件.</span><br><span class=\"line\">2、git show  &#39;误删编号&#39;：查看删除文件内容.</span><br><span class=\"line\">3、git merge ‘误删编号’： 本地合并误删的文件内容.</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-reset撤回操作\"><a class=\"header-anchor\" href=\"#Git-reset撤回操作\">¶</a>Git reset撤回操作</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git reflog</span><br><span class=\"line\">2、git reset COMMITID    就可以回到COMMITID那个分支和版本。</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git分支\"><a class=\"header-anchor\" href=\"#Git分支\">¶</a>Git分支</h4>\n<h5 id=\"用法\"><a class=\"header-anchor\" href=\"#用法\">¶</a>用法</h5>\n<blockquote>\n<p>获取用法：Git branch -d --help</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">用法：git branch [&lt;选项&gt;] [-r | -a] [--merged | --no-merged]</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-l] [-f] &lt;分支名&gt; [&lt;起始点&gt;]</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-r] (-d | -D) &lt;分支名&gt;...</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] (-m | -M) [&lt;旧分支&gt;] &lt;新分支&gt;</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] (-c | -C) [&lt;老分支&gt;] &lt;新分支&gt;</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-r | -a] [--points-at]</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-r | -a] [--format]</span><br><span class=\"line\"></span><br><span class=\"line\">通用选项</span><br><span class=\"line\">    -v, --verbose         显示哈希值和主题，若参数出现两次则显示上游分支</span><br><span class=\"line\">    -q, --quiet           不显示信息</span><br><span class=\"line\">    -t, --track           设置跟踪模式（参见 git-pull(1)）</span><br><span class=\"line\">    -u, --set-upstream-to &lt;上游&gt;</span><br><span class=\"line\">                          改变上游信息</span><br><span class=\"line\">    --unset-upstream      取消上游信息的设置</span><br><span class=\"line\">    --color[&#x3D;&lt;何时&gt;]      使用彩色输出</span><br><span class=\"line\">    -r, --remotes         作用于远程跟踪分支</span><br><span class=\"line\">    --contains &lt;提交&gt;     只打印包含该提交的分支</span><br><span class=\"line\">    --no-contains &lt;提交&gt;  只打印不包含该提交的分支</span><br><span class=\"line\">    --abbrev[&#x3D;&lt;n&gt;]        用 &lt;n&gt; 位数字显示 SHA-1 哈希值</span><br><span class=\"line\"></span><br><span class=\"line\">具体的 git-branch 动作：</span><br><span class=\"line\">    -a, --all             列出远程跟踪及本地分支</span><br><span class=\"line\">    -d, --delete          删除完全合并的分支</span><br><span class=\"line\">    -D                    删除分支（即使没有合并）</span><br><span class=\"line\">    -m, --move            移动&#x2F;重命名一个分支，以及它的引用日志</span><br><span class=\"line\">    -M                    移动&#x2F;重命名一个分支，即使目标已存在</span><br><span class=\"line\">    -c, --copy            拷贝一个分支和它的引用日志</span><br><span class=\"line\">    -C                    拷贝一个分支，即使目标已存在</span><br><span class=\"line\">    -l, --list            列出分支名</span><br><span class=\"line\">    --show-current        显示当前分支名</span><br><span class=\"line\">    --create-reflog       创建分支的引用日志</span><br><span class=\"line\">    --edit-description    标记分支的描述</span><br><span class=\"line\">    -f, --force           强制创建、移动&#x2F;重命名、删除</span><br><span class=\"line\">    --merged &lt;提交&gt;       只打印已经合并的分支</span><br><span class=\"line\">    --no-merged &lt;提交&gt;    只打印尚未合并的分支</span><br><span class=\"line\">    --column[&#x3D;&lt;风格&gt;]     以列的方式显示分支</span><br><span class=\"line\">    --sort &lt;key&gt;          排序的字段名</span><br><span class=\"line\">    --points-at &lt;对象&gt;    只打印指向该对象的分支</span><br><span class=\"line\">    -i, --ignore-case     排序和过滤属于大小写不敏感</span><br><span class=\"line\">    --format &lt;格式&gt;       输出格式</span><br></pre></td></tr></table></figure>\n<h5 id=\"获取所有分支\"><a class=\"header-anchor\" href=\"#获取所有分支\">¶</a>获取所有分支</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git branch -r | grep -v &#39;\\-&gt;&#39; | while read remote; do git branch --track &quot;$&#123;remote#origin&#x2F;&#125;&quot; &quot;$remote&quot;; done</span><br><span class=\"line\">git fetch --all</span><br><span class=\"line\">git pull --all</span><br></pre></td></tr></table></figure>\n<h5 id=\"add-remove分支\"><a class=\"header-anchor\" href=\"#add-remove分支\">¶</a>add/remove分支</h5>\n<p>新建&amp;切换:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git checkout -b iss53</span><br><span class=\"line\"></span><br><span class=\"line\">是下面两条的简写：</span><br><span class=\"line\">git branch iss53</span><br><span class=\"line\">git checkout iss53</span><br></pre></td></tr></table></figure>\n<p>删除分支：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git branch -d iss53</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-stash\"><a class=\"header-anchor\" href=\"#Git-stash\">¶</a>Git stash</h4>\n<h5 id=\"常用：\"><a class=\"header-anchor\" href=\"#常用：\">¶</a>常用：</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）git stash save &quot;save message&quot;  : 执行存储时，添加备注，方便查找，只有git stash 也要可以的，但查找时不方便识别。</span><br><span class=\"line\">（2）git stash list  ：查看stash了哪些存储</span><br><span class=\"line\">（3）git stash show ：显示做了哪些改动，默认show第一个存储,如果要显示其他存贮，后面加stash@&#123;$num&#125;，比如第二个 git stash show stash@&#123;1&#125;</span><br><span class=\"line\">（4）git stash show -p : 显示第一个存储的改动，如果想显示其他存存储，命令：git stash show  stash@&#123;$num&#125;  -p ，比如第二个：git stash show  stash@&#123;1&#125;  -p</span><br><span class=\"line\">（5）git stash apply :应用某个存储,但不会把存储从存储列表中删除，默认使用第一个存储,即stash@&#123;0&#125;，如果要使用其他个，git stash apply stash@&#123;$num&#125; ， 比如第二个：git stash apply stash@&#123;1&#125; </span><br><span class=\"line\">（6）git stash pop ：命令恢复之前缓存的工作目录，将缓存堆栈中的对应stash删除，并将对应修改应用到当前的工作目录下,默认为第一个stash,即stash@&#123;0&#125;，如果要应用并删除其他stash，命令：git stash pop stash@&#123;$num&#125; ，比如应用并删除第二个：git stash pop stash@&#123;1&#125;</span><br><span class=\"line\">（7）git stash drop stash@&#123;$num&#125; ：丢弃stash@&#123;$num&#125;存储，从列表中删除这个存储</span><br><span class=\"line\">（8）git stash clear ：删除所有缓存的stash</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-Tag\"><a class=\"header-anchor\" href=\"#Git-Tag\">¶</a>Git Tag</h4>\n<h5 id=\"常用：-v2\"><a class=\"header-anchor\" href=\"#常用：-v2\">¶</a>常用：</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2097 ± git tag -a --help</span><br><span class=\"line\">用法：git tag [-a | -s | -u &lt;key-id&gt;] [-f] [-m &lt;消息&gt; | -F &lt;文件&gt;]</span><br><span class=\"line\">\t\t&lt;标签名&gt; [&lt;头&gt;]</span><br><span class=\"line\">  或：git tag -d &lt;标签名&gt;...</span><br><span class=\"line\">  或：git tag -l [-n[&lt;数字&gt;]] [--contains &lt;提交&gt;] [--no-contains &lt;提交&gt;] [--points-at &lt;对象&gt;]</span><br><span class=\"line\">\t\t[--format&#x3D;&lt;格式&gt;] [--[no-]merged [&lt;提交&gt;]] [&lt;模式&gt;...]</span><br><span class=\"line\">  或：git tag -v [--format&#x3D;&lt;格式&gt;] &lt;标签名&gt;...</span><br><span class=\"line\"></span><br><span class=\"line\">    -l, --list            列出标签名称</span><br><span class=\"line\">    -n[&lt;n&gt;]               每个标签信息打印 &lt;n&gt; 行</span><br><span class=\"line\">    -d, --delete          删除标签</span><br><span class=\"line\">    -v, --verify          验证标签</span><br><span class=\"line\"></span><br><span class=\"line\">标签创建选项</span><br><span class=\"line\">    -a, --annotate        附注标签，需要一个说明</span><br><span class=\"line\">    -m, --message &lt;说明&gt;  标签说明</span><br><span class=\"line\">    -F, --file &lt;文件&gt;     从文件中读取提交说明</span><br><span class=\"line\">    -e, --edit            强制编辑标签说明</span><br><span class=\"line\">    -s, --sign            附注并附加 GPG 签名的标签</span><br><span class=\"line\">    --cleanup &lt;模式&gt;      设置如何删除提交说明里的空格和#注释</span><br><span class=\"line\">    -u, --local-user &lt;key-id&gt;</span><br><span class=\"line\">                          使用另外的私钥签名该标签</span><br><span class=\"line\">    -f, --force           如果存在，替换现有的标签</span><br><span class=\"line\">    --create-reflog       创建引用日志</span><br><span class=\"line\"></span><br><span class=\"line\">标签列表选项</span><br><span class=\"line\">    --column[&#x3D;&lt;风格&gt;]     以列的方式显示标签列表</span><br><span class=\"line\">    --contains &lt;提交&gt;     只打印包含该提交的标签</span><br><span class=\"line\">    --no-contains &lt;提交&gt;  只打印不包含该提交的标签</span><br><span class=\"line\">    --merged &lt;提交&gt;       只打印已经合并的标签</span><br><span class=\"line\">    --no-merged &lt;提交&gt;    只打印尚未合并的标签</span><br><span class=\"line\">    --sort &lt;key&gt;          排序的字段名</span><br><span class=\"line\">    --points-at &lt;对象&gt;    只打印指向该对象的标签</span><br><span class=\"line\">    --format &lt;格式&gt;       输出格式</span><br><span class=\"line\">    --color[&#x3D;&lt;何时&gt;]      遵照格式中的颜色输出</span><br><span class=\"line\">    -i, --ignore-case     排序和过滤属于大小写不敏感</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag按照version排序：</span><br><span class=\"line\">git tag -n</span><br><span class=\"line\"></span><br><span class=\"line\">git tag按照时间排序</span><br><span class=\"line\">git tag -n --sort&#x3D;taggerdate</span><br></pre></td></tr></table></figure>\n<h5 id=\"打Tag\"><a class=\"header-anchor\" href=\"#打Tag\">¶</a>打Tag</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag -a v0.0.1 -m &quot;V0.0.1&quot; </span><br></pre></td></tr></table></figure>\n<h5 id=\"删除Tag\"><a class=\"header-anchor\" href=\"#删除Tag\">¶</a>删除Tag</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag -d v0.0.1</span><br></pre></td></tr></table></figure>\n<h5 id=\"推送Tag\"><a class=\"header-anchor\" href=\"#推送Tag\">¶</a>推送Tag</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git push origin master --tags</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-push\"><a class=\"header-anchor\" href=\"#Git-push\">¶</a>Git push</h4>\n<h5 id=\"用法-v2\"><a class=\"header-anchor\" href=\"#用法-v2\">¶</a>用法</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">用法：git push [&lt;选项&gt;] [&lt;仓库&gt; [&lt;引用规格&gt;...]]</span><br><span class=\"line\"></span><br><span class=\"line\">    -v, --verbose         更加详细</span><br><span class=\"line\">    -q, --quiet           更加安静</span><br><span class=\"line\">    --repo &lt;仓库&gt;         仓库</span><br><span class=\"line\">    --all                 推送所有引用</span><br><span class=\"line\">    --mirror              镜像所有引用</span><br><span class=\"line\">    -d, --delete          删除引用</span><br><span class=\"line\">    --tags                推送标签（不能使用 --all or --mirror）</span><br><span class=\"line\">    -n, --dry-run         演习</span><br><span class=\"line\">    --porcelain           机器可读的输出</span><br><span class=\"line\">    -f, --force           强制更新</span><br><span class=\"line\">    --force-with-lease[&#x3D;&lt;引用名&gt;:&lt;期望值&gt;]</span><br><span class=\"line\">                          要求引用旧的取值为设定值</span><br><span class=\"line\">    --recurse-submodules (check|on-demand|no)</span><br><span class=\"line\">                          控制子模组的递归推送</span><br><span class=\"line\">    --thin                使用精简打包</span><br><span class=\"line\">    --receive-pack &lt;receive-pack&gt;</span><br><span class=\"line\">                          接收包程序</span><br><span class=\"line\">    --exec &lt;receive-pack&gt;</span><br><span class=\"line\">                          接收包程序</span><br><span class=\"line\">    -u, --set-upstream    设置 git pull&#x2F;status 的上游</span><br><span class=\"line\">    --progress            强制显示进度报告</span><br><span class=\"line\">    --prune               清除本地删除的引用</span><br><span class=\"line\">    --no-verify           绕过 pre-push 钩子</span><br><span class=\"line\">    --follow-tags         推送缺失但有关的标签</span><br><span class=\"line\">    --signed[&#x3D;(yes|no|if-asked)]</span><br><span class=\"line\">                          用 GPG 为推送签名</span><br><span class=\"line\">    --atomic              需要远端支持原子事务</span><br><span class=\"line\">    -o, --push-option &lt;server-specific&gt;</span><br><span class=\"line\">                          传输选项</span><br><span class=\"line\">    -4, --ipv4            只使用 IPv4 地址</span><br><span class=\"line\">    -6, --ipv6            只使用 IPv6 地址</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-rebase\"><a class=\"header-anchor\" href=\"#Git-rebase\">¶</a>Git rebase</h4>\n<h5 id=\"变基遵守的原则\"><a class=\"header-anchor\" href=\"#变基遵守的原则\">¶</a>变基遵守的原则</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果提交存在于你的仓库之外，而别人可能基于这些提交进行开发，那么不要执行变基。---[官网变基](https:&#x2F;&#x2F;git-scm.com&#x2F;book&#x2F;zh&#x2F;v2&#x2F;Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)</span><br><span class=\"line\"></span><br><span class=\"line\">TODO 后续更新此过程</span><br></pre></td></tr></table></figure>\n<h5 id=\"经典用法：\"><a class=\"header-anchor\" href=\"#经典用法：\">¶</a>经典用法：</h5>\n<blockquote>\n<p>git rebase --help</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Assume the following history exists and the current branch is &quot;topic&quot;:</span><br><span class=\"line\"></span><br><span class=\"line\">              A---B---C topic</span><br><span class=\"line\">             &#x2F;</span><br><span class=\"line\">        D---E---F---G master</span><br><span class=\"line\">From this point, the result of either of thefollowing </span><br><span class=\"line\"></span><br><span class=\"line\">commands:</span><br><span class=\"line\">    git rebase master</span><br><span class=\"line\">    git rebase master topic</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">would be:</span><br><span class=\"line\">                      A&#39;--B&#39;--C&#39; topic</span><br><span class=\"line\">                     &#x2F;</span><br><span class=\"line\">        D---E---F---G master</span><br></pre></td></tr></table></figure>\n<h5 id=\"rebase场景：\"><a class=\"header-anchor\" href=\"#rebase场景：\">¶</a>rebase场景：</h5>\n<p><a href=\"https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA\">官网例子</a></p>\n<h3 id=\"Git-快速场景：\"><a class=\"header-anchor\" href=\"#Git-快速场景：\">¶</a>Git 快速场景：</h3>\n<p>其实还是对上述命令的活学活用。</p>\n<h4 id=\"Git-Reset场景\"><a class=\"header-anchor\" href=\"#Git-Reset场景\">¶</a>Git Reset场景</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 本地修改了一堆文件(并没有使用git add到暂存区)，想放弃修改。</span><br><span class=\"line\">单个文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git checkout -- filename</span><br><span class=\"line\"></span><br><span class=\"line\">所有文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git checkout .</span><br><span class=\"line\"> </span><br><span class=\"line\">2. 本地新增了一堆文件(并没有git add到暂存区)，想放弃修改。</span><br><span class=\"line\">单个文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">$ rm filename &#x2F; rm dir -rf</span><br><span class=\"line\"></span><br><span class=\"line\">所有文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">$ git clean -xdf</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; 删除新增的文件，如果文件已经已经git add到暂存区，并不会删除！</span><br><span class=\"line\"></span><br><span class=\"line\">3. 本地修改&#x2F;新增了一堆文件，已经git add到暂存区，想放弃修改。</span><br><span class=\"line\">单个文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git reset HEAD filename</span><br><span class=\"line\"></span><br><span class=\"line\">所有文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git reset HEAD .</span><br><span class=\"line\"> </span><br><span class=\"line\">4. 本地通过git add &amp; git commit 之后，想要撤销此次commit和代码</span><br><span class=\"line\"></span><br><span class=\"line\">git reset commit_id</span><br><span class=\"line\"></span><br><span class=\"line\">这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位</span><br><span class=\"line\">&#x2F;&#x2F; 撤销之后，你所做的已经commit的修改还在工作区！</span><br><span class=\"line\"></span><br><span class=\"line\">git reset --hard commit_id</span><br><span class=\"line\"></span><br><span class=\"line\">这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位</span><br><span class=\"line\">&#x2F;&#x2F; 撤销之后，你所做的已经commit的修改将会清除，仍在工作区&#x2F;暂存区的代码不会清除！</span><br><span class=\"line\"></span><br><span class=\"line\">5. git add &amp; git commit 提交后，只想回滚commit：</span><br><span class=\"line\">\tgit reset --soft HEAD^</span><br><span class=\"line\">\t注意这仅仅是回滚了你的commit，代码依旧在的。</span><br></pre></td></tr></table></figure>\n<h3 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h3>\n","site":{"data":{}},"excerpt":"<h3 id=\"学习方式\"><a class=\"header-anchor\" href=\"#学习方式\">¶</a>学习方式</h3>\n<p>多练多得，直接学习<a href=\"https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6\">官网</a>理解。</p>\n<p>以下仅仅是部分用到的场景和部分场景记录，不代表全部情况，如有错误，请及时指正。</p>\n<h3 id=\"Git版本：\"><a class=\"header-anchor\" href=\"#Git版本：\">¶</a>Git版本：</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1944 ± git version </span><br><span class=\"line\">git version 2.28.0</span><br></pre></td></tr></table></figure>\n<h3 id=\"先说说Git的常用命令：-可跳过\"><a class=\"header-anchor\" href=\"#先说说Git的常用命令：-可跳过\">¶</a>先说说Git的常用命令：(可跳过)</h3>","more":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2081 ◯  git </span><br><span class=\"line\">用法：git [--version] [--help] [-C &lt;path&gt;] [-c &lt;name&gt;&#x3D;&lt;value&gt;]</span><br><span class=\"line\">           [--exec-path[&#x3D;&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class=\"line\">           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]</span><br><span class=\"line\">           [--git-dir&#x3D;&lt;path&gt;] [--work-tree&#x3D;&lt;path&gt;] [--namespace&#x3D;&lt;name&gt;]</span><br><span class=\"line\">           &lt;command&gt; [&lt;args&gt;]</span><br><span class=\"line\"></span><br><span class=\"line\">这些是各种场合常见的 Git 命令：</span><br><span class=\"line\"></span><br><span class=\"line\">开始一个工作区（参见：git help tutorial）</span><br><span class=\"line\">   clone             克隆仓库到一个新目录</span><br><span class=\"line\">   init              创建一个空的 Git 仓库或重新初始化一个已存在的仓库</span><br><span class=\"line\"></span><br><span class=\"line\">在当前变更上工作（参见：git help everyday）</span><br><span class=\"line\">   add               添加文件内容至索引</span><br><span class=\"line\">   mv                移动或重命名一个文件、目录或符号链接</span><br><span class=\"line\">   restore           恢复工作区文件</span><br><span class=\"line\">   rm                从工作区和索引中删除文件</span><br><span class=\"line\">   sparse-checkout   初始化及修改稀疏检出</span><br><span class=\"line\"></span><br><span class=\"line\">检查历史和状态（参见：git help revisions）</span><br><span class=\"line\">   bisect            通过二分查找定位引入 bug 的提交</span><br><span class=\"line\">   diff              显示提交之间、提交和工作区之间等的差异</span><br><span class=\"line\">   grep              输出和模式匹配的行</span><br><span class=\"line\">   log               显示提交日志</span><br><span class=\"line\">   show              显示各种类型的对象</span><br><span class=\"line\">   status            显示工作区状态</span><br><span class=\"line\"></span><br><span class=\"line\">扩展、标记和调校您的历史记录</span><br><span class=\"line\">   branch            列出、创建或删除分支</span><br><span class=\"line\">   commit            记录变更到仓库</span><br><span class=\"line\">   merge             合并两个或更多开发历史</span><br><span class=\"line\">   rebase            在另一个分支上重新应用提交</span><br><span class=\"line\">   reset             重置当前 HEAD 到指定状态</span><br><span class=\"line\">   switch            切换分支</span><br><span class=\"line\">   tag               创建、列出、删除或校验一个 GPG 签名的标签对象</span><br><span class=\"line\"></span><br><span class=\"line\">协同（参见：git help workflows）</span><br><span class=\"line\">   fetch             从另外一个仓库下载对象和引用</span><br><span class=\"line\">   pull              获取并整合另外的仓库或一个本地分支</span><br><span class=\"line\">   push              更新远程引用和相关的对象</span><br><span class=\"line\"></span><br><span class=\"line\">命令 &#39;git help -a&#39; 和 &#39;git help -g&#39; 显示可用的子命令和一些概念帮助。</span><br><span class=\"line\">查看 &#39;git help &lt;命令&gt;&#39; 或 &#39;git help &lt;概念&gt;&#39; 以获取给定子命令或概念的</span><br><span class=\"line\">帮助。</span><br><span class=\"line\">有关系统的概述，查看 &#39;git help git&#39;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Git使用：\"><a class=\"header-anchor\" href=\"#Git使用：\">¶</a>Git使用：</h3>\n<h4 id=\"生成密钥\"><a class=\"header-anchor\" href=\"#生成密钥\">¶</a>生成密钥</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -C &quot;这里换上你的邮箱&quot;</span><br></pre></td></tr></table></figure>\n<p>最后得到<code>id_rsa</code>和<code>id_rsa.pub</code>两个文件。</p>\n<h4 id=\"Git配置信息\"><a class=\"header-anchor\" href=\"#Git配置信息\">¶</a>Git配置信息</h4>\n<h5 id=\"查看配置信息\"><a class=\"header-anchor\" href=\"#查看配置信息\">¶</a>查看配置信息</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查看系统配置信息</span><br><span class=\"line\">* git config --system --list</span><br><span class=\"line\"></span><br><span class=\"line\">当前用户配置</span><br><span class=\"line\">* git config --global --list</span><br><span class=\"line\"></span><br><span class=\"line\">查看当前仓库配置</span><br><span class=\"line\">* git config --local --list</span><br></pre></td></tr></table></figure>\n<h5 id=\"设置用户信息\"><a class=\"header-anchor\" href=\"#设置用户信息\">¶</a>设置用户信息</h5>\n<p>全局设置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --global user.name &quot;crab&quot;</span><br><span class=\"line\">git config --global user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>\n<p>当前仓库生效：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --local user.name &quot;crab&quot;</span><br><span class=\"line\">git config --local user.email &quot;imrcrab@163.com&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-Remote\"><a class=\"header-anchor\" href=\"#Git-Remote\">¶</a>Git Remote</h4>\n<h5 id=\"新增remote地址\"><a class=\"header-anchor\" href=\"#新增remote地址\">¶</a>新增remote地址</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git remote add upstream http:&#x2F;&#x2F;github&#x2F;**remote**&#x2F;test.git</span><br><span class=\"line\">git remote -v 可以查看具体路径</span><br></pre></td></tr></table></figure>\n<h5 id=\"merge-fetch远程代码到XXX分支\"><a class=\"header-anchor\" href=\"#merge-fetch远程代码到XXX分支\">¶</a>merge/fetch远程代码到XXX分支</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git fetch upstream。</span><br><span class=\"line\">2、切回到master分支。</span><br><span class=\"line\">3、git merge upstream&#x2F;master 合并远程upstream分支到本地master。</span><br><span class=\"line\">4、解决冲突或其他问题。</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-误删除恢复\"><a class=\"header-anchor\" href=\"#Git-误删除恢复\">¶</a>Git 误删除恢复</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git  fsck --lost -found :查看最近移除的文件.</span><br><span class=\"line\">2、git show  &#39;误删编号&#39;：查看删除文件内容.</span><br><span class=\"line\">3、git merge ‘误删编号’： 本地合并误删的文件内容.</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-reset撤回操作\"><a class=\"header-anchor\" href=\"#Git-reset撤回操作\">¶</a>Git reset撤回操作</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git reflog</span><br><span class=\"line\">2、git reset COMMITID    就可以回到COMMITID那个分支和版本。</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git分支\"><a class=\"header-anchor\" href=\"#Git分支\">¶</a>Git分支</h4>\n<h5 id=\"用法\"><a class=\"header-anchor\" href=\"#用法\">¶</a>用法</h5>\n<blockquote>\n<p>获取用法：Git branch -d --help</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">用法：git branch [&lt;选项&gt;] [-r | -a] [--merged | --no-merged]</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-l] [-f] &lt;分支名&gt; [&lt;起始点&gt;]</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-r] (-d | -D) &lt;分支名&gt;...</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] (-m | -M) [&lt;旧分支&gt;] &lt;新分支&gt;</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] (-c | -C) [&lt;老分支&gt;] &lt;新分支&gt;</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-r | -a] [--points-at]</span><br><span class=\"line\">  或：git branch [&lt;选项&gt;] [-r | -a] [--format]</span><br><span class=\"line\"></span><br><span class=\"line\">通用选项</span><br><span class=\"line\">    -v, --verbose         显示哈希值和主题，若参数出现两次则显示上游分支</span><br><span class=\"line\">    -q, --quiet           不显示信息</span><br><span class=\"line\">    -t, --track           设置跟踪模式（参见 git-pull(1)）</span><br><span class=\"line\">    -u, --set-upstream-to &lt;上游&gt;</span><br><span class=\"line\">                          改变上游信息</span><br><span class=\"line\">    --unset-upstream      取消上游信息的设置</span><br><span class=\"line\">    --color[&#x3D;&lt;何时&gt;]      使用彩色输出</span><br><span class=\"line\">    -r, --remotes         作用于远程跟踪分支</span><br><span class=\"line\">    --contains &lt;提交&gt;     只打印包含该提交的分支</span><br><span class=\"line\">    --no-contains &lt;提交&gt;  只打印不包含该提交的分支</span><br><span class=\"line\">    --abbrev[&#x3D;&lt;n&gt;]        用 &lt;n&gt; 位数字显示 SHA-1 哈希值</span><br><span class=\"line\"></span><br><span class=\"line\">具体的 git-branch 动作：</span><br><span class=\"line\">    -a, --all             列出远程跟踪及本地分支</span><br><span class=\"line\">    -d, --delete          删除完全合并的分支</span><br><span class=\"line\">    -D                    删除分支（即使没有合并）</span><br><span class=\"line\">    -m, --move            移动&#x2F;重命名一个分支，以及它的引用日志</span><br><span class=\"line\">    -M                    移动&#x2F;重命名一个分支，即使目标已存在</span><br><span class=\"line\">    -c, --copy            拷贝一个分支和它的引用日志</span><br><span class=\"line\">    -C                    拷贝一个分支，即使目标已存在</span><br><span class=\"line\">    -l, --list            列出分支名</span><br><span class=\"line\">    --show-current        显示当前分支名</span><br><span class=\"line\">    --create-reflog       创建分支的引用日志</span><br><span class=\"line\">    --edit-description    标记分支的描述</span><br><span class=\"line\">    -f, --force           强制创建、移动&#x2F;重命名、删除</span><br><span class=\"line\">    --merged &lt;提交&gt;       只打印已经合并的分支</span><br><span class=\"line\">    --no-merged &lt;提交&gt;    只打印尚未合并的分支</span><br><span class=\"line\">    --column[&#x3D;&lt;风格&gt;]     以列的方式显示分支</span><br><span class=\"line\">    --sort &lt;key&gt;          排序的字段名</span><br><span class=\"line\">    --points-at &lt;对象&gt;    只打印指向该对象的分支</span><br><span class=\"line\">    -i, --ignore-case     排序和过滤属于大小写不敏感</span><br><span class=\"line\">    --format &lt;格式&gt;       输出格式</span><br></pre></td></tr></table></figure>\n<h5 id=\"获取所有分支\"><a class=\"header-anchor\" href=\"#获取所有分支\">¶</a>获取所有分支</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git branch -r | grep -v &#39;\\-&gt;&#39; | while read remote; do git branch --track &quot;$&#123;remote#origin&#x2F;&#125;&quot; &quot;$remote&quot;; done</span><br><span class=\"line\">git fetch --all</span><br><span class=\"line\">git pull --all</span><br></pre></td></tr></table></figure>\n<h5 id=\"add-remove分支\"><a class=\"header-anchor\" href=\"#add-remove分支\">¶</a>add/remove分支</h5>\n<p>新建&amp;切换:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git checkout -b iss53</span><br><span class=\"line\"></span><br><span class=\"line\">是下面两条的简写：</span><br><span class=\"line\">git branch iss53</span><br><span class=\"line\">git checkout iss53</span><br></pre></td></tr></table></figure>\n<p>删除分支：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git branch -d iss53</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-stash\"><a class=\"header-anchor\" href=\"#Git-stash\">¶</a>Git stash</h4>\n<h5 id=\"常用：\"><a class=\"header-anchor\" href=\"#常用：\">¶</a>常用：</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）git stash save &quot;save message&quot;  : 执行存储时，添加备注，方便查找，只有git stash 也要可以的，但查找时不方便识别。</span><br><span class=\"line\">（2）git stash list  ：查看stash了哪些存储</span><br><span class=\"line\">（3）git stash show ：显示做了哪些改动，默认show第一个存储,如果要显示其他存贮，后面加stash@&#123;$num&#125;，比如第二个 git stash show stash@&#123;1&#125;</span><br><span class=\"line\">（4）git stash show -p : 显示第一个存储的改动，如果想显示其他存存储，命令：git stash show  stash@&#123;$num&#125;  -p ，比如第二个：git stash show  stash@&#123;1&#125;  -p</span><br><span class=\"line\">（5）git stash apply :应用某个存储,但不会把存储从存储列表中删除，默认使用第一个存储,即stash@&#123;0&#125;，如果要使用其他个，git stash apply stash@&#123;$num&#125; ， 比如第二个：git stash apply stash@&#123;1&#125; </span><br><span class=\"line\">（6）git stash pop ：命令恢复之前缓存的工作目录，将缓存堆栈中的对应stash删除，并将对应修改应用到当前的工作目录下,默认为第一个stash,即stash@&#123;0&#125;，如果要应用并删除其他stash，命令：git stash pop stash@&#123;$num&#125; ，比如应用并删除第二个：git stash pop stash@&#123;1&#125;</span><br><span class=\"line\">（7）git stash drop stash@&#123;$num&#125; ：丢弃stash@&#123;$num&#125;存储，从列表中删除这个存储</span><br><span class=\"line\">（8）git stash clear ：删除所有缓存的stash</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-Tag\"><a class=\"header-anchor\" href=\"#Git-Tag\">¶</a>Git Tag</h4>\n<h5 id=\"常用：-v2\"><a class=\"header-anchor\" href=\"#常用：-v2\">¶</a>常用：</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2097 ± git tag -a --help</span><br><span class=\"line\">用法：git tag [-a | -s | -u &lt;key-id&gt;] [-f] [-m &lt;消息&gt; | -F &lt;文件&gt;]</span><br><span class=\"line\">\t\t&lt;标签名&gt; [&lt;头&gt;]</span><br><span class=\"line\">  或：git tag -d &lt;标签名&gt;...</span><br><span class=\"line\">  或：git tag -l [-n[&lt;数字&gt;]] [--contains &lt;提交&gt;] [--no-contains &lt;提交&gt;] [--points-at &lt;对象&gt;]</span><br><span class=\"line\">\t\t[--format&#x3D;&lt;格式&gt;] [--[no-]merged [&lt;提交&gt;]] [&lt;模式&gt;...]</span><br><span class=\"line\">  或：git tag -v [--format&#x3D;&lt;格式&gt;] &lt;标签名&gt;...</span><br><span class=\"line\"></span><br><span class=\"line\">    -l, --list            列出标签名称</span><br><span class=\"line\">    -n[&lt;n&gt;]               每个标签信息打印 &lt;n&gt; 行</span><br><span class=\"line\">    -d, --delete          删除标签</span><br><span class=\"line\">    -v, --verify          验证标签</span><br><span class=\"line\"></span><br><span class=\"line\">标签创建选项</span><br><span class=\"line\">    -a, --annotate        附注标签，需要一个说明</span><br><span class=\"line\">    -m, --message &lt;说明&gt;  标签说明</span><br><span class=\"line\">    -F, --file &lt;文件&gt;     从文件中读取提交说明</span><br><span class=\"line\">    -e, --edit            强制编辑标签说明</span><br><span class=\"line\">    -s, --sign            附注并附加 GPG 签名的标签</span><br><span class=\"line\">    --cleanup &lt;模式&gt;      设置如何删除提交说明里的空格和#注释</span><br><span class=\"line\">    -u, --local-user &lt;key-id&gt;</span><br><span class=\"line\">                          使用另外的私钥签名该标签</span><br><span class=\"line\">    -f, --force           如果存在，替换现有的标签</span><br><span class=\"line\">    --create-reflog       创建引用日志</span><br><span class=\"line\"></span><br><span class=\"line\">标签列表选项</span><br><span class=\"line\">    --column[&#x3D;&lt;风格&gt;]     以列的方式显示标签列表</span><br><span class=\"line\">    --contains &lt;提交&gt;     只打印包含该提交的标签</span><br><span class=\"line\">    --no-contains &lt;提交&gt;  只打印不包含该提交的标签</span><br><span class=\"line\">    --merged &lt;提交&gt;       只打印已经合并的标签</span><br><span class=\"line\">    --no-merged &lt;提交&gt;    只打印尚未合并的标签</span><br><span class=\"line\">    --sort &lt;key&gt;          排序的字段名</span><br><span class=\"line\">    --points-at &lt;对象&gt;    只打印指向该对象的标签</span><br><span class=\"line\">    --format &lt;格式&gt;       输出格式</span><br><span class=\"line\">    --color[&#x3D;&lt;何时&gt;]      遵照格式中的颜色输出</span><br><span class=\"line\">    -i, --ignore-case     排序和过滤属于大小写不敏感</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag按照version排序：</span><br><span class=\"line\">git tag -n</span><br><span class=\"line\"></span><br><span class=\"line\">git tag按照时间排序</span><br><span class=\"line\">git tag -n --sort&#x3D;taggerdate</span><br></pre></td></tr></table></figure>\n<h5 id=\"打Tag\"><a class=\"header-anchor\" href=\"#打Tag\">¶</a>打Tag</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag -a v0.0.1 -m &quot;V0.0.1&quot; </span><br></pre></td></tr></table></figure>\n<h5 id=\"删除Tag\"><a class=\"header-anchor\" href=\"#删除Tag\">¶</a>删除Tag</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git tag -d v0.0.1</span><br></pre></td></tr></table></figure>\n<h5 id=\"推送Tag\"><a class=\"header-anchor\" href=\"#推送Tag\">¶</a>推送Tag</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git push origin master --tags</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-push\"><a class=\"header-anchor\" href=\"#Git-push\">¶</a>Git push</h4>\n<h5 id=\"用法-v2\"><a class=\"header-anchor\" href=\"#用法-v2\">¶</a>用法</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">用法：git push [&lt;选项&gt;] [&lt;仓库&gt; [&lt;引用规格&gt;...]]</span><br><span class=\"line\"></span><br><span class=\"line\">    -v, --verbose         更加详细</span><br><span class=\"line\">    -q, --quiet           更加安静</span><br><span class=\"line\">    --repo &lt;仓库&gt;         仓库</span><br><span class=\"line\">    --all                 推送所有引用</span><br><span class=\"line\">    --mirror              镜像所有引用</span><br><span class=\"line\">    -d, --delete          删除引用</span><br><span class=\"line\">    --tags                推送标签（不能使用 --all or --mirror）</span><br><span class=\"line\">    -n, --dry-run         演习</span><br><span class=\"line\">    --porcelain           机器可读的输出</span><br><span class=\"line\">    -f, --force           强制更新</span><br><span class=\"line\">    --force-with-lease[&#x3D;&lt;引用名&gt;:&lt;期望值&gt;]</span><br><span class=\"line\">                          要求引用旧的取值为设定值</span><br><span class=\"line\">    --recurse-submodules (check|on-demand|no)</span><br><span class=\"line\">                          控制子模组的递归推送</span><br><span class=\"line\">    --thin                使用精简打包</span><br><span class=\"line\">    --receive-pack &lt;receive-pack&gt;</span><br><span class=\"line\">                          接收包程序</span><br><span class=\"line\">    --exec &lt;receive-pack&gt;</span><br><span class=\"line\">                          接收包程序</span><br><span class=\"line\">    -u, --set-upstream    设置 git pull&#x2F;status 的上游</span><br><span class=\"line\">    --progress            强制显示进度报告</span><br><span class=\"line\">    --prune               清除本地删除的引用</span><br><span class=\"line\">    --no-verify           绕过 pre-push 钩子</span><br><span class=\"line\">    --follow-tags         推送缺失但有关的标签</span><br><span class=\"line\">    --signed[&#x3D;(yes|no|if-asked)]</span><br><span class=\"line\">                          用 GPG 为推送签名</span><br><span class=\"line\">    --atomic              需要远端支持原子事务</span><br><span class=\"line\">    -o, --push-option &lt;server-specific&gt;</span><br><span class=\"line\">                          传输选项</span><br><span class=\"line\">    -4, --ipv4            只使用 IPv4 地址</span><br><span class=\"line\">    -6, --ipv6            只使用 IPv6 地址</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-rebase\"><a class=\"header-anchor\" href=\"#Git-rebase\">¶</a>Git rebase</h4>\n<h5 id=\"变基遵守的原则\"><a class=\"header-anchor\" href=\"#变基遵守的原则\">¶</a>变基遵守的原则</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果提交存在于你的仓库之外，而别人可能基于这些提交进行开发，那么不要执行变基。---[官网变基](https:&#x2F;&#x2F;git-scm.com&#x2F;book&#x2F;zh&#x2F;v2&#x2F;Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA)</span><br><span class=\"line\"></span><br><span class=\"line\">TODO 后续更新此过程</span><br></pre></td></tr></table></figure>\n<h5 id=\"经典用法：\"><a class=\"header-anchor\" href=\"#经典用法：\">¶</a>经典用法：</h5>\n<blockquote>\n<p>git rebase --help</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Assume the following history exists and the current branch is &quot;topic&quot;:</span><br><span class=\"line\"></span><br><span class=\"line\">              A---B---C topic</span><br><span class=\"line\">             &#x2F;</span><br><span class=\"line\">        D---E---F---G master</span><br><span class=\"line\">From this point, the result of either of thefollowing </span><br><span class=\"line\"></span><br><span class=\"line\">commands:</span><br><span class=\"line\">    git rebase master</span><br><span class=\"line\">    git rebase master topic</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">would be:</span><br><span class=\"line\">                      A&#39;--B&#39;--C&#39; topic</span><br><span class=\"line\">                     &#x2F;</span><br><span class=\"line\">        D---E---F---G master</span><br></pre></td></tr></table></figure>\n<h5 id=\"rebase场景：\"><a class=\"header-anchor\" href=\"#rebase场景：\">¶</a>rebase场景：</h5>\n<p><a href=\"https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA\">官网例子</a></p>\n<h3 id=\"Git-快速场景：\"><a class=\"header-anchor\" href=\"#Git-快速场景：\">¶</a>Git 快速场景：</h3>\n<p>其实还是对上述命令的活学活用。</p>\n<h4 id=\"Git-Reset场景\"><a class=\"header-anchor\" href=\"#Git-Reset场景\">¶</a>Git Reset场景</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 本地修改了一堆文件(并没有使用git add到暂存区)，想放弃修改。</span><br><span class=\"line\">单个文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git checkout -- filename</span><br><span class=\"line\"></span><br><span class=\"line\">所有文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git checkout .</span><br><span class=\"line\"> </span><br><span class=\"line\">2. 本地新增了一堆文件(并没有git add到暂存区)，想放弃修改。</span><br><span class=\"line\">单个文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">$ rm filename &#x2F; rm dir -rf</span><br><span class=\"line\"></span><br><span class=\"line\">所有文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">$ git clean -xdf</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F; 删除新增的文件，如果文件已经已经git add到暂存区，并不会删除！</span><br><span class=\"line\"></span><br><span class=\"line\">3. 本地修改&#x2F;新增了一堆文件，已经git add到暂存区，想放弃修改。</span><br><span class=\"line\">单个文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git reset HEAD filename</span><br><span class=\"line\"></span><br><span class=\"line\">所有文件&#x2F;文件夹：</span><br><span class=\"line\"></span><br><span class=\"line\">git reset HEAD .</span><br><span class=\"line\"> </span><br><span class=\"line\">4. 本地通过git add &amp; git commit 之后，想要撤销此次commit和代码</span><br><span class=\"line\"></span><br><span class=\"line\">git reset commit_id</span><br><span class=\"line\"></span><br><span class=\"line\">这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位</span><br><span class=\"line\">&#x2F;&#x2F; 撤销之后，你所做的已经commit的修改还在工作区！</span><br><span class=\"line\"></span><br><span class=\"line\">git reset --hard commit_id</span><br><span class=\"line\"></span><br><span class=\"line\">这个id是你想要回到的那个节点，可以通过git log查看，可以只选前6位</span><br><span class=\"line\">&#x2F;&#x2F; 撤销之后，你所做的已经commit的修改将会清除，仍在工作区&#x2F;暂存区的代码不会清除！</span><br><span class=\"line\"></span><br><span class=\"line\">5. git add &amp; git commit 提交后，只想回滚commit：</span><br><span class=\"line\">\tgit reset --soft HEAD^</span><br><span class=\"line\">\t注意这仅仅是回滚了你的commit，代码依旧在的。</span><br></pre></td></tr></table></figure>\n<h3 id=\"持续更新…\"><a class=\"header-anchor\" href=\"#持续更新…\">¶</a>持续更新…</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Tue Nov 10 2020 19:22:02 GMT+0800 (中国标准时间)","title":"「4」Git常用技巧","path":"archives/3c1dd822.html","eyeCatchImage":null,"excerpt":"<h3 id=\"学习方式\"><a class=\"header-anchor\" href=\"#学习方式\">¶</a>学习方式</h3>\n<p>多练多得，直接学习<a href=\"https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6\">官网</a>理解。</p>\n<p>以下仅仅是部分用到的场景和部分场景记录，不代表全部情况，如有错误，请及时指正。</p>\n<h3 id=\"Git版本：\"><a class=\"header-anchor\" href=\"#Git版本：\">¶</a>Git版本：</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1944 ± git version </span><br><span class=\"line\">git version 2.28.0</span><br></pre></td></tr></table></figure>\n<h3 id=\"先说说Git的常用命令：-可跳过\"><a class=\"header-anchor\" href=\"#先说说Git的常用命令：-可跳过\">¶</a>先说说Git的常用命令：(可跳过)</h3>","date":{"_isAMomentObject":true,"_i":"2020-09-01T11:22:02.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-01T11:22:02.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Git"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":7610},{"title":"「5」Git GPG签署工作","date":"2020-09-02T14:29:40.000Z","updated":"2020-09-02T14:29:40.000Z","keywords":"git,git签署证书,git常用","abbrlink":"580377d0","_content":"\n### GPG场景\n\n Git 虽然是密码级安全的，但它不是万无一失的。 如果你从因特网上的其他人那里拿取工作，并且想要验证提交是不是真正地来自于可信来源， Git 提供了几种通过 GPG 来签署和验证工作的方式。\n\n 最终效果：如下图所示\n\n ![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png)\n\n### 安装过程\n\nwindows安装地址： [点击下载](https://www.gnupg.org/)\n\nmac os为例：\n<!-- more -->\n#### 安装GPG\n```\nbrew install gpg\n\n查看结果：\n± gpg --version                                                                                                                                                                                                                                     ⏎\n\ngpg (GnuPG) 2.2.22\nlibgcrypt 1.8.6\nCopyright (C) 2020 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\n\nHome: /Users/gogoowang/.gnupg\n支持的算法：\n公钥： RSA, ELG, DSA, ECDH, ECDSA, EDDSA\n密文： IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,\n    CAMELLIA128, CAMELLIA192, CAMELLIA256\n散列： SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224\n压缩：  不压缩, ZIP, ZLIB, BZIP2\n\n```\n\n#### 生成密钥\n```\ngpg --full-generate-key\n```\n\n需要填写的地方：\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123803.png)\n\n\n#### 查看密钥完整信息\n\n```\ngpg --list-secret-keys --keyid-format LONG\n```\n\n>secret keys（红圈地方后续用到，留意下）：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124016.png)\n\n#### 根据secret keys生成PGP\n\n```\ngpg --armor --export  7BB8CF3593CA174C\n```\n\n生成的PGP结果，后续需要将此结果导入到Github账号的配置信息中\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124305.png)\n\n#### Github账号中设置\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124443.png)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124527.png)\n\n\n>将上述生成的PGP填入，点击[Add GPG Key]即可\n\n\n#### 配置本地GPG签名信息\n依次执行下面命令\n```\n1、git config --global user.signingkey 7BB8CF3593CA174C  #此处的7BB8CF3593CA174C为生成的secret keys\n2、git config commit.gpgsign true\n3、git config --global commit.gpgsign true\n```\n\n#### Git PGP生效\n\n>再次提交commit即可生效。产生如下图的签名效果：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png)\n\n#### End","source":"_posts/5-Git-GPG签署工作.md","raw":"---\ntitle: 「5」Git GPG签署工作\ndate: '2020/09/02 22:29:40'\nupdated: '2020/09/02 22:29:40'\nkeywords: 'git,git签署证书,git常用'\ntags:\n  - Git\nabbrlink: 580377d0\n---\n\n### GPG场景\n\n Git 虽然是密码级安全的，但它不是万无一失的。 如果你从因特网上的其他人那里拿取工作，并且想要验证提交是不是真正地来自于可信来源， Git 提供了几种通过 GPG 来签署和验证工作的方式。\n\n 最终效果：如下图所示\n\n ![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png)\n\n### 安装过程\n\nwindows安装地址： [点击下载](https://www.gnupg.org/)\n\nmac os为例：\n<!-- more -->\n#### 安装GPG\n```\nbrew install gpg\n\n查看结果：\n± gpg --version                                                                                                                                                                                                                                     ⏎\n\ngpg (GnuPG) 2.2.22\nlibgcrypt 1.8.6\nCopyright (C) 2020 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\n\nHome: /Users/gogoowang/.gnupg\n支持的算法：\n公钥： RSA, ELG, DSA, ECDH, ECDSA, EDDSA\n密文： IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,\n    CAMELLIA128, CAMELLIA192, CAMELLIA256\n散列： SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224\n压缩：  不压缩, ZIP, ZLIB, BZIP2\n\n```\n\n#### 生成密钥\n```\ngpg --full-generate-key\n```\n\n需要填写的地方：\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123803.png)\n\n\n#### 查看密钥完整信息\n\n```\ngpg --list-secret-keys --keyid-format LONG\n```\n\n>secret keys（红圈地方后续用到，留意下）：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124016.png)\n\n#### 根据secret keys生成PGP\n\n```\ngpg --armor --export  7BB8CF3593CA174C\n```\n\n生成的PGP结果，后续需要将此结果导入到Github账号的配置信息中\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124305.png)\n\n#### Github账号中设置\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124443.png)\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124527.png)\n\n\n>将上述生成的PGP填入，点击[Add GPG Key]即可\n\n\n#### 配置本地GPG签名信息\n依次执行下面命令\n```\n1、git config --global user.signingkey 7BB8CF3593CA174C  #此处的7BB8CF3593CA174C为生成的secret keys\n2、git config commit.gpgsign true\n3、git config --global commit.gpgsign true\n```\n\n#### Git PGP生效\n\n>再次提交commit即可生效。产生如下图的签名效果：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png)\n\n#### End","slug":"5-Git-GPG签署工作","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlk00233ci76ex7a0vq","content":"<h3 id=\"GPG场景\"><a class=\"header-anchor\" href=\"#GPG场景\">¶</a>GPG场景</h3>\n<p>Git 虽然是密码级安全的，但它不是万无一失的。 如果你从因特网上的其他人那里拿取工作，并且想要验证提交是不是真正地来自于可信来源， Git 提供了几种通过 GPG 来签署和验证工作的方式。</p>\n<p>最终效果：如下图所示</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png\" alt=\"\"></p>\n<h3 id=\"安装过程\"><a class=\"header-anchor\" href=\"#安装过程\">¶</a>安装过程</h3>\n<p>windows安装地址： <a href=\"https://www.gnupg.org/\">点击下载</a></p>\n<p>mac os为例：</p>\n<a id=\"more\"></a>\n<h4 id=\"安装GPG\"><a class=\"header-anchor\" href=\"#安装GPG\">¶</a>安装GPG</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install gpg</span><br><span class=\"line\"></span><br><span class=\"line\">查看结果：</span><br><span class=\"line\">± gpg --version                                                                                                                                                                                                                                     ⏎</span><br><span class=\"line\"></span><br><span class=\"line\">gpg (GnuPG) 2.2.22</span><br><span class=\"line\">libgcrypt 1.8.6</span><br><span class=\"line\">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class=\"line\">License GPLv3+: GNU GPL version 3 or later &lt;https:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;</span><br><span class=\"line\">This is free software: you are free to change and redistribute it.</span><br><span class=\"line\">There is NO WARRANTY, to the extent permitted by law.</span><br><span class=\"line\"></span><br><span class=\"line\">Home: &#x2F;Users&#x2F;gogoowang&#x2F;.gnupg</span><br><span class=\"line\">支持的算法：</span><br><span class=\"line\">公钥： RSA, ELG, DSA, ECDH, ECDSA, EDDSA</span><br><span class=\"line\">密文： IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,</span><br><span class=\"line\">    CAMELLIA128, CAMELLIA192, CAMELLIA256</span><br><span class=\"line\">散列： SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224</span><br><span class=\"line\">压缩：  不压缩, ZIP, ZLIB, BZIP2</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"生成密钥\"><a class=\"header-anchor\" href=\"#生成密钥\">¶</a>生成密钥</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gpg --full-generate-key</span><br></pre></td></tr></table></figure>\n<p>需要填写的地方：<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123803.png\" alt=\"\"></p>\n<h4 id=\"查看密钥完整信息\"><a class=\"header-anchor\" href=\"#查看密钥完整信息\">¶</a>查看密钥完整信息</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gpg --list-secret-keys --keyid-format LONG</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>secret keys（红圈地方后续用到，留意下）：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124016.png\" alt=\"\"></p>\n<h4 id=\"根据secret-keys生成PGP\"><a class=\"header-anchor\" href=\"#根据secret-keys生成PGP\">¶</a>根据secret keys生成PGP</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gpg --armor --export  7BB8CF3593CA174C</span><br></pre></td></tr></table></figure>\n<p>生成的PGP结果，后续需要将此结果导入到Github账号的配置信息中<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124305.png\" alt=\"\"></p>\n<h4 id=\"Github账号中设置\"><a class=\"header-anchor\" href=\"#Github账号中设置\">¶</a>Github账号中设置</h4>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124443.png\" alt=\"\"></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124527.png\" alt=\"\"></p>\n<blockquote>\n<p>将上述生成的PGP填入，点击[Add GPG Key]即可</p>\n</blockquote>\n<h4 id=\"配置本地GPG签名信息\"><a class=\"header-anchor\" href=\"#配置本地GPG签名信息\">¶</a>配置本地GPG签名信息</h4>\n<p>依次执行下面命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git config --global user.signingkey 7BB8CF3593CA174C  #此处的7BB8CF3593CA174C为生成的secret keys</span><br><span class=\"line\">2、git config commit.gpgsign true</span><br><span class=\"line\">3、git config --global commit.gpgsign true</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-PGP生效\"><a class=\"header-anchor\" href=\"#Git-PGP生效\">¶</a>Git PGP生效</h4>\n<blockquote>\n<p>再次提交commit即可生效。产生如下图的签名效果：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png\" alt=\"\"></p>\n<h4 id=\"End\"><a class=\"header-anchor\" href=\"#End\">¶</a>End</h4>\n","site":{"data":{}},"excerpt":"<h3 id=\"GPG场景\"><a class=\"header-anchor\" href=\"#GPG场景\">¶</a>GPG场景</h3>\n<p>Git 虽然是密码级安全的，但它不是万无一失的。 如果你从因特网上的其他人那里拿取工作，并且想要验证提交是不是真正地来自于可信来源， Git 提供了几种通过 GPG 来签署和验证工作的方式。</p>\n<p>最终效果：如下图所示</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png\" alt=\"\"></p>\n<h3 id=\"安装过程\"><a class=\"header-anchor\" href=\"#安装过程\">¶</a>安装过程</h3>\n<p>windows安装地址： <a href=\"https://www.gnupg.org/\">点击下载</a></p>\n<p>mac os为例：</p>","more":"<h4 id=\"安装GPG\"><a class=\"header-anchor\" href=\"#安装GPG\">¶</a>安装GPG</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install gpg</span><br><span class=\"line\"></span><br><span class=\"line\">查看结果：</span><br><span class=\"line\">± gpg --version                                                                                                                                                                                                                                     ⏎</span><br><span class=\"line\"></span><br><span class=\"line\">gpg (GnuPG) 2.2.22</span><br><span class=\"line\">libgcrypt 1.8.6</span><br><span class=\"line\">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class=\"line\">License GPLv3+: GNU GPL version 3 or later &lt;https:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;</span><br><span class=\"line\">This is free software: you are free to change and redistribute it.</span><br><span class=\"line\">There is NO WARRANTY, to the extent permitted by law.</span><br><span class=\"line\"></span><br><span class=\"line\">Home: &#x2F;Users&#x2F;gogoowang&#x2F;.gnupg</span><br><span class=\"line\">支持的算法：</span><br><span class=\"line\">公钥： RSA, ELG, DSA, ECDH, ECDSA, EDDSA</span><br><span class=\"line\">密文： IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,</span><br><span class=\"line\">    CAMELLIA128, CAMELLIA192, CAMELLIA256</span><br><span class=\"line\">散列： SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224</span><br><span class=\"line\">压缩：  不压缩, ZIP, ZLIB, BZIP2</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"生成密钥\"><a class=\"header-anchor\" href=\"#生成密钥\">¶</a>生成密钥</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gpg --full-generate-key</span><br></pre></td></tr></table></figure>\n<p>需要填写的地方：<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123803.png\" alt=\"\"></p>\n<h4 id=\"查看密钥完整信息\"><a class=\"header-anchor\" href=\"#查看密钥完整信息\">¶</a>查看密钥完整信息</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gpg --list-secret-keys --keyid-format LONG</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>secret keys（红圈地方后续用到，留意下）：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124016.png\" alt=\"\"></p>\n<h4 id=\"根据secret-keys生成PGP\"><a class=\"header-anchor\" href=\"#根据secret-keys生成PGP\">¶</a>根据secret keys生成PGP</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gpg --armor --export  7BB8CF3593CA174C</span><br></pre></td></tr></table></figure>\n<p>生成的PGP结果，后续需要将此结果导入到Github账号的配置信息中<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124305.png\" alt=\"\"></p>\n<h4 id=\"Github账号中设置\"><a class=\"header-anchor\" href=\"#Github账号中设置\">¶</a>Github账号中设置</h4>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124443.png\" alt=\"\"></p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902124527.png\" alt=\"\"></p>\n<blockquote>\n<p>将上述生成的PGP填入，点击[Add GPG Key]即可</p>\n</blockquote>\n<h4 id=\"配置本地GPG签名信息\"><a class=\"header-anchor\" href=\"#配置本地GPG签名信息\">¶</a>配置本地GPG签名信息</h4>\n<p>依次执行下面命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、git config --global user.signingkey 7BB8CF3593CA174C  #此处的7BB8CF3593CA174C为生成的secret keys</span><br><span class=\"line\">2、git config commit.gpgsign true</span><br><span class=\"line\">3、git config --global commit.gpgsign true</span><br></pre></td></tr></table></figure>\n<h4 id=\"Git-PGP生效\"><a class=\"header-anchor\" href=\"#Git-PGP生效\">¶</a>Git PGP生效</h4>\n<blockquote>\n<p>再次提交commit即可生效。产生如下图的签名效果：</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png\" alt=\"\"></p>\n<h4 id=\"End\"><a class=\"header-anchor\" href=\"#End\">¶</a>End</h4>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png","popularPost_tmp_gaData":{"updated":"Wed Sep 02 2020 22:29:40 GMT+0800 (中国标准时间)","title":"「5」Git GPG签署工作","path":"archives/580377d0.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png","excerpt":"<h3 id=\"GPG场景\"><a class=\"header-anchor\" href=\"#GPG场景\">¶</a>GPG场景</h3>\n<p>Git 虽然是密码级安全的，但它不是万无一失的。 如果你从因特网上的其他人那里拿取工作，并且想要验证提交是不是真正地来自于可信来源， Git 提供了几种通过 GPG 来签署和验证工作的方式。</p>\n<p>最终效果：如下图所示</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902123343.png\" alt=\"\"></p>\n<h3 id=\"安装过程\"><a class=\"header-anchor\" href=\"#安装过程\">¶</a>安装过程</h3>\n<p>windows安装地址： <a href=\"https://www.gnupg.org/\">点击下载</a></p>\n<p>mac os为例：</p>","date":{"_isAMomentObject":true,"_i":"2020-09-02T14:29:40.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-02T14:29:40.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Git"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":1155},{"title":"「6」git 初阶:安装配置 ～1","date":"2020-09-02T14:38:44.000Z","updated":"2020-09-02T14:38:44.000Z","keywords":"git,git使用,git常用","abbrlink":"bddc30f6","_content":"\n\n>自盘古开天辟地～～～～\n>扯远了......\n>完整的分享下Git的使用和学习的知识点，之前章节中的[Git常用技巧](http://blog.imrcrab.com/2020/09/01/Git%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/)是我之前部分快速使用的场景，适合于有经验的开发者，现在来系统的分享下对于Git的理解，也算是自己学习的记录。\n\n\n## 前景\n\nSVN估计是家喻户晓了，一直被用作`'版本管理'`和`代码仓库`。（ps:不算是完整的`版本管理`.）\nGit的出现，是linus之父休假时产出的“作品”,`版本管理` & `代码仓库`的作用。总而言之，用熟练Git了，就再也回不去了。\n<!-- more -->\n\n## 目标：\n\n>最终可以顺利的提交代码即可。\n\n## 此篇只分享两个知识点：\n\n>安装Git和Git基本配置\n\n### Git安装\n\n说安装其实就是去官网下载软件，安装到你选定地方即可。\n\n在此附上官网的下载链接： [点击进入](https://git-scm.com/download/)\n\n选择对应平台windows?linux?macos?  \n\nps:别选错了，那就very尴尬了。\n\n### 基本配置\n\n说到基本配置，大多数都会有，更何况是如此强大的版本控制软件。\n\n#### 前期基本配置\n主要分三个地方：\n```\n1、/etc/gitconfig 文件: 系统上每一个用户及其他们的仓库配置文件。\n2、~/.gitconfig 或 ~/.config/git/config 文件： 只针对当前用户生效。 [global配置]\n3、当前使用仓库的Git配置： .git/config文件，仅仅对当前仓库配置生效。    [local配置]\n```\n\n\n>ps: 优先机制：3 > 2 > 1  [.git/config覆盖~/.gitconfig、  ~/.gitconfig覆盖/etc/gitconfig]\n\n##### 注意：\n```\nwindows下的~/.gitconfig路径为：C:\\Users\\$USER下；$USER指当前电脑用户名称\n```\n\n##### 查看所有配置命令\n```\ngit config --list --show-origin\n```\n\n#### 生成密钥&关联Github/Gitlab\n\n##### 生成密钥\n>根据邮箱，会要求输入密码，连续3个回车即可。\n```\nssh-keygen -t rsa -C \"这里换上你的邮箱\"\n```\n\n最后得到id_rsa和id_rsa.pub两个文件。\n\n这里用到的是你的 公钥`id_rsa.pub`文件，复制文件里面的内容到github密钥的界面：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902075825.png)\n\n添加SSH完了之后，就绑定了你本机器和github的关联关系，相当于授权成功。\n\n##### 拓展\n>上述生成密钥时也可以自定义文件名称.此种情况针对你有多个github账号时，提交公钥文件时，找出自定义名称的文件即可。（下图自定义生成文件名称pywang112,则公钥为pywang112.pub，看好你生成的路径哦）\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902080130.png)\n\n#### global配置（全局配置）或 local配置（当前仓库配置）\n\n##### global配置（针对你只有一个git账户的情况）\n```\n查看命令：\ngit config --global --list\n\n全局配置：\n\ngit config --global user.name \"crab\"\ngit config --global user.email \"imrcrab@163.com\"\n\n代理配置（按需可选）\n# http\ngit config --global https.proxy http://127.0.0.1:1080 \n# sock\ngit config --global http.proxy 'socks5://127.0.0.1:1080' \n\n取消代理：\ngit config --global --unset http.proxy\n```\n\n##### local配置 (建议本地仓库配置，这样比较灵活)\n\n```\n查看命令：\ngit config --local --list\n\n全局配置：\n\ngit config --local user.name \"crab\"\ngit config --local user.email \"imrcrab@163.com\"\n\n代理配置（按需可选）\n# http\ngit config --local https.proxy http://127.0.0.1:1080 \n# sock\ngit config --local http.proxy 'socks5://127.0.0.1:1080' \n\n取消代理：\ngit config --local --unset http.proxy\n```\n\n#### 配置完成，clone/commit代码\n\n##### clone仓库代码\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902081306.png)\n\n```\ngit clone https://github.com/crab21/blog.git\n```\n##### commit代码\n>按照如上配置完成后，就可以完成基本的push和pull仓库代码了。\n\n### END","source":"_posts/6-git 初阶:安装配置 ～1.md","raw":"---\ntitle: '「6」git 初阶:安装配置 ～1'\ndate: '2020/09/02 22:38:44'\nupdated: '2020/09/02 22:38:44'\nkeywords: 'git,git使用,git常用'\ntags:\n  - Git\nabbrlink: bddc30f6\n---\n\n\n>自盘古开天辟地～～～～\n>扯远了......\n>完整的分享下Git的使用和学习的知识点，之前章节中的[Git常用技巧](http://blog.imrcrab.com/2020/09/01/Git%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/)是我之前部分快速使用的场景，适合于有经验的开发者，现在来系统的分享下对于Git的理解，也算是自己学习的记录。\n\n\n## 前景\n\nSVN估计是家喻户晓了，一直被用作`'版本管理'`和`代码仓库`。（ps:不算是完整的`版本管理`.）\nGit的出现，是linus之父休假时产出的“作品”,`版本管理` & `代码仓库`的作用。总而言之，用熟练Git了，就再也回不去了。\n<!-- more -->\n\n## 目标：\n\n>最终可以顺利的提交代码即可。\n\n## 此篇只分享两个知识点：\n\n>安装Git和Git基本配置\n\n### Git安装\n\n说安装其实就是去官网下载软件，安装到你选定地方即可。\n\n在此附上官网的下载链接： [点击进入](https://git-scm.com/download/)\n\n选择对应平台windows?linux?macos?  \n\nps:别选错了，那就very尴尬了。\n\n### 基本配置\n\n说到基本配置，大多数都会有，更何况是如此强大的版本控制软件。\n\n#### 前期基本配置\n主要分三个地方：\n```\n1、/etc/gitconfig 文件: 系统上每一个用户及其他们的仓库配置文件。\n2、~/.gitconfig 或 ~/.config/git/config 文件： 只针对当前用户生效。 [global配置]\n3、当前使用仓库的Git配置： .git/config文件，仅仅对当前仓库配置生效。    [local配置]\n```\n\n\n>ps: 优先机制：3 > 2 > 1  [.git/config覆盖~/.gitconfig、  ~/.gitconfig覆盖/etc/gitconfig]\n\n##### 注意：\n```\nwindows下的~/.gitconfig路径为：C:\\Users\\$USER下；$USER指当前电脑用户名称\n```\n\n##### 查看所有配置命令\n```\ngit config --list --show-origin\n```\n\n#### 生成密钥&关联Github/Gitlab\n\n##### 生成密钥\n>根据邮箱，会要求输入密码，连续3个回车即可。\n```\nssh-keygen -t rsa -C \"这里换上你的邮箱\"\n```\n\n最后得到id_rsa和id_rsa.pub两个文件。\n\n这里用到的是你的 公钥`id_rsa.pub`文件，复制文件里面的内容到github密钥的界面：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902075825.png)\n\n添加SSH完了之后，就绑定了你本机器和github的关联关系，相当于授权成功。\n\n##### 拓展\n>上述生成密钥时也可以自定义文件名称.此种情况针对你有多个github账号时，提交公钥文件时，找出自定义名称的文件即可。（下图自定义生成文件名称pywang112,则公钥为pywang112.pub，看好你生成的路径哦）\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902080130.png)\n\n#### global配置（全局配置）或 local配置（当前仓库配置）\n\n##### global配置（针对你只有一个git账户的情况）\n```\n查看命令：\ngit config --global --list\n\n全局配置：\n\ngit config --global user.name \"crab\"\ngit config --global user.email \"imrcrab@163.com\"\n\n代理配置（按需可选）\n# http\ngit config --global https.proxy http://127.0.0.1:1080 \n# sock\ngit config --global http.proxy 'socks5://127.0.0.1:1080' \n\n取消代理：\ngit config --global --unset http.proxy\n```\n\n##### local配置 (建议本地仓库配置，这样比较灵活)\n\n```\n查看命令：\ngit config --local --list\n\n全局配置：\n\ngit config --local user.name \"crab\"\ngit config --local user.email \"imrcrab@163.com\"\n\n代理配置（按需可选）\n# http\ngit config --local https.proxy http://127.0.0.1:1080 \n# sock\ngit config --local http.proxy 'socks5://127.0.0.1:1080' \n\n取消代理：\ngit config --local --unset http.proxy\n```\n\n#### 配置完成，clone/commit代码\n\n##### clone仓库代码\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200902081306.png)\n\n```\ngit clone https://github.com/crab21/blog.git\n```\n##### commit代码\n>按照如上配置完成后，就可以完成基本的push和pull仓库代码了。\n\n### END","slug":"6-git 初阶:安装配置 ～1","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdll00263ci7c20cgqx6","content":"<blockquote>\n<p>自盘古开天辟地～～～～<br>\n扯远了…<br>\n完整的分享下Git的使用和学习的知识点，之前章节中的<a href=\"http://blog.imrcrab.com/2020/09/01/Git%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/\">Git常用技巧</a>是我之前部分快速使用的场景，适合于有经验的开发者，现在来系统的分享下对于Git的理解，也算是自己学习的记录。</p>\n</blockquote>\n<h2 id=\"前景\"><a class=\"header-anchor\" href=\"#前景\">¶</a>前景</h2>\n<p>SVN估计是家喻户晓了，一直被用作<code>'版本管理'</code>和<code>代码仓库</code>。（ps:不算是完整的<code>版本管理</code>.）<br>\nGit的出现，是linus之父休假时产出的“作品”,<code>版本管理</code> &amp; <code>代码仓库</code>的作用。总而言之，用熟练Git了，就再也回不去了。</p>\n<a id=\"more\"></a>\n<h2 id=\"目标：\"><a class=\"header-anchor\" href=\"#目标：\">¶</a>目标：</h2>\n<blockquote>\n<p>最终可以顺利的提交代码即可。</p>\n</blockquote>\n<h2 id=\"此篇只分享两个知识点：\"><a class=\"header-anchor\" href=\"#此篇只分享两个知识点：\">¶</a>此篇只分享两个知识点：</h2>\n<blockquote>\n<p>安装Git和Git基本配置</p>\n</blockquote>\n<h3 id=\"Git安装\"><a class=\"header-anchor\" href=\"#Git安装\">¶</a>Git安装</h3>\n<p>说安装其实就是去官网下载软件，安装到你选定地方即可。</p>\n<p>在此附上官网的下载链接： <a href=\"https://git-scm.com/download/\">点击进入</a></p>\n<p>选择对应平台windows?linux?macos?</p>\n<p>ps:别选错了，那就very尴尬了。</p>\n<h3 id=\"基本配置\"><a class=\"header-anchor\" href=\"#基本配置\">¶</a>基本配置</h3>\n<p>说到基本配置，大多数都会有，更何况是如此强大的版本控制软件。</p>\n<h4 id=\"前期基本配置\"><a class=\"header-anchor\" href=\"#前期基本配置\">¶</a>前期基本配置</h4>\n<p>主要分三个地方：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、&#x2F;etc&#x2F;gitconfig 文件: 系统上每一个用户及其他们的仓库配置文件。</span><br><span class=\"line\">2、~&#x2F;.gitconfig 或 ~&#x2F;.config&#x2F;git&#x2F;config 文件： 只针对当前用户生效。 [global配置]</span><br><span class=\"line\">3、当前使用仓库的Git配置： .git&#x2F;config文件，仅仅对当前仓库配置生效。    [local配置]</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ps: 优先机制：3 &gt; 2 &gt; 1  [.git/config覆盖~/.gitconfig、  ~/.gitconfig覆盖/etc/gitconfig]</p>\n</blockquote>\n<h5 id=\"注意：\"><a class=\"header-anchor\" href=\"#注意：\">¶</a>注意：</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">windows下的~&#x2F;.gitconfig路径为：C:\\Users\\$USER下；$USER指当前电脑用户名称</span><br></pre></td></tr></table></figure>\n<h5 id=\"查看所有配置命令\"><a class=\"header-anchor\" href=\"#查看所有配置命令\">¶</a>查看所有配置命令</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --list --show-origin</span><br></pre></td></tr></table></figure>\n<h4 id=\"生成密钥-关联Github-Gitlab\"><a class=\"header-anchor\" href=\"#生成密钥-关联Github-Gitlab\">¶</a>生成密钥&amp;关联Github/Gitlab</h4>\n<h5 id=\"生成密钥\"><a class=\"header-anchor\" href=\"#生成密钥\">¶</a>生成密钥</h5>\n<blockquote>\n<p>根据邮箱，会要求输入密码，连续3个回车即可。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -C &quot;这里换上你的邮箱&quot;</span><br></pre></td></tr></table></figure>\n<p>最后得到id_rsa和id_rsa.pub两个文件。</p>\n<p>这里用到的是你的 公钥<code>id_rsa.pub</code>文件，复制文件里面的内容到github密钥的界面：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902075825.png\" alt=\"\"></p>\n<p>添加SSH完了之后，就绑定了你本机器和github的关联关系，相当于授权成功。</p>\n<h5 id=\"拓展\"><a class=\"header-anchor\" href=\"#拓展\">¶</a>拓展</h5>\n<blockquote>\n<p>上述生成密钥时也可以自定义文件名称.此种情况针对你有多个github账号时，提交公钥文件时，找出自定义名称的文件即可。（下图自定义生成文件名称pywang112,则公钥为pywang112.pub，看好你生成的路径哦）</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902080130.png\" alt=\"\"></p>\n<h4 id=\"global配置（全局配置）或-local配置（当前仓库配置）\"><a class=\"header-anchor\" href=\"#global配置（全局配置）或-local配置（当前仓库配置）\">¶</a>global配置（全局配置）或 local配置（当前仓库配置）</h4>\n<h5 id=\"global配置（针对你只有一个git账户的情况）\"><a class=\"header-anchor\" href=\"#global配置（针对你只有一个git账户的情况）\">¶</a>global配置（针对你只有一个git账户的情况）</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查看命令：</span><br><span class=\"line\">git config --global --list</span><br><span class=\"line\"></span><br><span class=\"line\">全局配置：</span><br><span class=\"line\"></span><br><span class=\"line\">git config --global user.name &quot;crab&quot;</span><br><span class=\"line\">git config --global user.email &quot;imrcrab@163.com&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">代理配置（按需可选）</span><br><span class=\"line\"># http</span><br><span class=\"line\">git config --global https.proxy http:&#x2F;&#x2F;127.0.0.1:1080 </span><br><span class=\"line\"># sock</span><br><span class=\"line\">git config --global http.proxy &#39;socks5:&#x2F;&#x2F;127.0.0.1:1080&#39; </span><br><span class=\"line\"></span><br><span class=\"line\">取消代理：</span><br><span class=\"line\">git config --global --unset http.proxy</span><br></pre></td></tr></table></figure>\n<h5 id=\"local配置-建议本地仓库配置，这样比较灵活\"><a class=\"header-anchor\" href=\"#local配置-建议本地仓库配置，这样比较灵活\">¶</a>local配置 (建议本地仓库配置，这样比较灵活)</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查看命令：</span><br><span class=\"line\">git config --local --list</span><br><span class=\"line\"></span><br><span class=\"line\">全局配置：</span><br><span class=\"line\"></span><br><span class=\"line\">git config --local user.name &quot;crab&quot;</span><br><span class=\"line\">git config --local user.email &quot;imrcrab@163.com&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">代理配置（按需可选）</span><br><span class=\"line\"># http</span><br><span class=\"line\">git config --local https.proxy http:&#x2F;&#x2F;127.0.0.1:1080 </span><br><span class=\"line\"># sock</span><br><span class=\"line\">git config --local http.proxy &#39;socks5:&#x2F;&#x2F;127.0.0.1:1080&#39; </span><br><span class=\"line\"></span><br><span class=\"line\">取消代理：</span><br><span class=\"line\">git config --local --unset http.proxy</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置完成，clone-commit代码\"><a class=\"header-anchor\" href=\"#配置完成，clone-commit代码\">¶</a>配置完成，clone/commit代码</h4>\n<h5 id=\"clone仓库代码\"><a class=\"header-anchor\" href=\"#clone仓库代码\">¶</a>clone仓库代码</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902081306.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https:&#x2F;&#x2F;github.com&#x2F;crab21&#x2F;blog.git</span><br></pre></td></tr></table></figure>\n<h5 id=\"commit代码\"><a class=\"header-anchor\" href=\"#commit代码\">¶</a>commit代码</h5>\n<blockquote>\n<p>按照如上配置完成后，就可以完成基本的push和pull仓库代码了。</p>\n</blockquote>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>自盘古开天辟地～～～～<br>\n扯远了…<br>\n完整的分享下Git的使用和学习的知识点，之前章节中的<a href=\"http://blog.imrcrab.com/2020/09/01/Git%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/\">Git常用技巧</a>是我之前部分快速使用的场景，适合于有经验的开发者，现在来系统的分享下对于Git的理解，也算是自己学习的记录。</p>\n</blockquote>\n<h2 id=\"前景\"><a class=\"header-anchor\" href=\"#前景\">¶</a>前景</h2>\n<p>SVN估计是家喻户晓了，一直被用作<code>'版本管理'</code>和<code>代码仓库</code>。（ps:不算是完整的<code>版本管理</code>.）<br>\nGit的出现，是linus之父休假时产出的“作品”,<code>版本管理</code> &amp; <code>代码仓库</code>的作用。总而言之，用熟练Git了，就再也回不去了。</p>","more":"<h2 id=\"目标：\"><a class=\"header-anchor\" href=\"#目标：\">¶</a>目标：</h2>\n<blockquote>\n<p>最终可以顺利的提交代码即可。</p>\n</blockquote>\n<h2 id=\"此篇只分享两个知识点：\"><a class=\"header-anchor\" href=\"#此篇只分享两个知识点：\">¶</a>此篇只分享两个知识点：</h2>\n<blockquote>\n<p>安装Git和Git基本配置</p>\n</blockquote>\n<h3 id=\"Git安装\"><a class=\"header-anchor\" href=\"#Git安装\">¶</a>Git安装</h3>\n<p>说安装其实就是去官网下载软件，安装到你选定地方即可。</p>\n<p>在此附上官网的下载链接： <a href=\"https://git-scm.com/download/\">点击进入</a></p>\n<p>选择对应平台windows?linux?macos?</p>\n<p>ps:别选错了，那就very尴尬了。</p>\n<h3 id=\"基本配置\"><a class=\"header-anchor\" href=\"#基本配置\">¶</a>基本配置</h3>\n<p>说到基本配置，大多数都会有，更何况是如此强大的版本控制软件。</p>\n<h4 id=\"前期基本配置\"><a class=\"header-anchor\" href=\"#前期基本配置\">¶</a>前期基本配置</h4>\n<p>主要分三个地方：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、&#x2F;etc&#x2F;gitconfig 文件: 系统上每一个用户及其他们的仓库配置文件。</span><br><span class=\"line\">2、~&#x2F;.gitconfig 或 ~&#x2F;.config&#x2F;git&#x2F;config 文件： 只针对当前用户生效。 [global配置]</span><br><span class=\"line\">3、当前使用仓库的Git配置： .git&#x2F;config文件，仅仅对当前仓库配置生效。    [local配置]</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ps: 优先机制：3 &gt; 2 &gt; 1  [.git/config覆盖~/.gitconfig、  ~/.gitconfig覆盖/etc/gitconfig]</p>\n</blockquote>\n<h5 id=\"注意：\"><a class=\"header-anchor\" href=\"#注意：\">¶</a>注意：</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">windows下的~&#x2F;.gitconfig路径为：C:\\Users\\$USER下；$USER指当前电脑用户名称</span><br></pre></td></tr></table></figure>\n<h5 id=\"查看所有配置命令\"><a class=\"header-anchor\" href=\"#查看所有配置命令\">¶</a>查看所有配置命令</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git config --list --show-origin</span><br></pre></td></tr></table></figure>\n<h4 id=\"生成密钥-关联Github-Gitlab\"><a class=\"header-anchor\" href=\"#生成密钥-关联Github-Gitlab\">¶</a>生成密钥&amp;关联Github/Gitlab</h4>\n<h5 id=\"生成密钥\"><a class=\"header-anchor\" href=\"#生成密钥\">¶</a>生成密钥</h5>\n<blockquote>\n<p>根据邮箱，会要求输入密码，连续3个回车即可。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -C &quot;这里换上你的邮箱&quot;</span><br></pre></td></tr></table></figure>\n<p>最后得到id_rsa和id_rsa.pub两个文件。</p>\n<p>这里用到的是你的 公钥<code>id_rsa.pub</code>文件，复制文件里面的内容到github密钥的界面：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902075825.png\" alt=\"\"></p>\n<p>添加SSH完了之后，就绑定了你本机器和github的关联关系，相当于授权成功。</p>\n<h5 id=\"拓展\"><a class=\"header-anchor\" href=\"#拓展\">¶</a>拓展</h5>\n<blockquote>\n<p>上述生成密钥时也可以自定义文件名称.此种情况针对你有多个github账号时，提交公钥文件时，找出自定义名称的文件即可。（下图自定义生成文件名称pywang112,则公钥为pywang112.pub，看好你生成的路径哦）</p>\n</blockquote>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902080130.png\" alt=\"\"></p>\n<h4 id=\"global配置（全局配置）或-local配置（当前仓库配置）\"><a class=\"header-anchor\" href=\"#global配置（全局配置）或-local配置（当前仓库配置）\">¶</a>global配置（全局配置）或 local配置（当前仓库配置）</h4>\n<h5 id=\"global配置（针对你只有一个git账户的情况）\"><a class=\"header-anchor\" href=\"#global配置（针对你只有一个git账户的情况）\">¶</a>global配置（针对你只有一个git账户的情况）</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查看命令：</span><br><span class=\"line\">git config --global --list</span><br><span class=\"line\"></span><br><span class=\"line\">全局配置：</span><br><span class=\"line\"></span><br><span class=\"line\">git config --global user.name &quot;crab&quot;</span><br><span class=\"line\">git config --global user.email &quot;imrcrab@163.com&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">代理配置（按需可选）</span><br><span class=\"line\"># http</span><br><span class=\"line\">git config --global https.proxy http:&#x2F;&#x2F;127.0.0.1:1080 </span><br><span class=\"line\"># sock</span><br><span class=\"line\">git config --global http.proxy &#39;socks5:&#x2F;&#x2F;127.0.0.1:1080&#39; </span><br><span class=\"line\"></span><br><span class=\"line\">取消代理：</span><br><span class=\"line\">git config --global --unset http.proxy</span><br></pre></td></tr></table></figure>\n<h5 id=\"local配置-建议本地仓库配置，这样比较灵活\"><a class=\"header-anchor\" href=\"#local配置-建议本地仓库配置，这样比较灵活\">¶</a>local配置 (建议本地仓库配置，这样比较灵活)</h5>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查看命令：</span><br><span class=\"line\">git config --local --list</span><br><span class=\"line\"></span><br><span class=\"line\">全局配置：</span><br><span class=\"line\"></span><br><span class=\"line\">git config --local user.name &quot;crab&quot;</span><br><span class=\"line\">git config --local user.email &quot;imrcrab@163.com&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">代理配置（按需可选）</span><br><span class=\"line\"># http</span><br><span class=\"line\">git config --local https.proxy http:&#x2F;&#x2F;127.0.0.1:1080 </span><br><span class=\"line\"># sock</span><br><span class=\"line\">git config --local http.proxy &#39;socks5:&#x2F;&#x2F;127.0.0.1:1080&#39; </span><br><span class=\"line\"></span><br><span class=\"line\">取消代理：</span><br><span class=\"line\">git config --local --unset http.proxy</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置完成，clone-commit代码\"><a class=\"header-anchor\" href=\"#配置完成，clone-commit代码\">¶</a>配置完成，clone/commit代码</h4>\n<h5 id=\"clone仓库代码\"><a class=\"header-anchor\" href=\"#clone仓库代码\">¶</a>clone仓库代码</h5>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902081306.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https:&#x2F;&#x2F;github.com&#x2F;crab21&#x2F;blog.git</span><br></pre></td></tr></table></figure>\n<h5 id=\"commit代码\"><a class=\"header-anchor\" href=\"#commit代码\">¶</a>commit代码</h5>\n<blockquote>\n<p>按照如上配置完成后，就可以完成基本的push和pull仓库代码了。</p>\n</blockquote>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902075825.png","popularPost_tmp_gaData":{"updated":"Wed Sep 02 2020 22:38:44 GMT+0800 (中国标准时间)","title":"「6」git 初阶:安装配置 ～1","path":"archives/bddc30f6.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200902075825.png","excerpt":"<blockquote>\n<p>自盘古开天辟地～～～～<br>\n扯远了…<br>\n完整的分享下Git的使用和学习的知识点，之前章节中的<a href=\"http://blog.imrcrab.com/2020/09/01/Git%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/\">Git常用技巧</a>是我之前部分快速使用的场景，适合于有经验的开发者，现在来系统的分享下对于Git的理解，也算是自己学习的记录。</p>\n</blockquote>\n<h2 id=\"前景\"><a class=\"header-anchor\" href=\"#前景\">¶</a>前景</h2>\n<p>SVN估计是家喻户晓了，一直被用作<code>'版本管理'</code>和<code>代码仓库</code>。（ps:不算是完整的<code>版本管理</code>.）<br>\nGit的出现，是linus之父休假时产出的“作品”,<code>版本管理</code> &amp; <code>代码仓库</code>的作用。总而言之，用熟练Git了，就再也回不去了。</p>","date":{"_isAMomentObject":true,"_i":"2020-09-02T14:38:44.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-02T14:38:44.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Git"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":1969},{"title":"「7」Go Context包使用","date":"2020-09-07T14:21:52.000Z","updated":"2020-09-07T14:21:52.000Z","keywords":"golang,go context包,golang context WithCancel,golang context WithDeadline,go WithTimeout.","abbrlink":"410dfaec","_content":"\n### 版本\n```\n◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 用Go的都离不开Context，引用官网的一句话来描述Context包：\n\n>Package context defines the Context type, which carries deadlines, cancellation signals, and other request-scoped values across API boundaries and between processes.\n\n主要掌握四个方法的使用\n```\nWithCancel\nWithDeadline\nWithTimeout\nWithValue\n```\n### 前期ready\n\n要用下面的方法，先了解下部分结构和逻辑：\n\n>既然context全部都是和取消相关的，最起码Go在设计时会有这么一个结构。\n<!-- more -->\n\n>具体的取消设计结构\n```\ntype cancelCtx struct {\n\tContext\n\n\tmu       sync.Mutex            // protects following fields  加锁用\n\tdone     chan struct{}         // created lazily, closed by first cancel call   控制channel\n\tchildren map[canceler]struct{} // set to nil by the first cancel call  cancel函数调用后，释放子类\n\terr      error                 // set to non-nil by the first cancel call\n}\n```\n\n>timer控制死锁时间结构：\n```\n// A timerCtx carries a timer and a deadline. It embeds a cancelCtx to\n// implement Done and Err. It implements cancel by stopping its timer then\n// delegating to cancelCtx.cancel.\n\ntype timerCtx struct {\n\tcancelCtx  \n\ttimer *time.Timer // Under cancelCtx.mu.\n\n\tdeadline time.Time\n}\n```\n\n### WithCancel\n\n```\nfunc WithCancel(parent Context) (ctx Context, cancel CancelFunc) {\n    if parent == nil {  //日常判空\n\t\tpanic(\"cannot create context from nil parent\")\n\t}\n\tc := newCancelCtx(parent) //cancelCtx new\n\tpropagateCancel(parent, &c)  //循环传播取消函数for ctx\n\treturn &c, func() { c.cancel(true, Canceled) }\n}\n```\n>看似很简单，四行解决，但是更重要的是学会看注释说明和相关的设计思路： \nTODO \n\n引用官方的语言：\n```\n// WithCancel returns a copy of parent with a new Done channel. The returned\n// context's Done channel is closed when the returned cancel function is called\n// or when the parent context's Done channel is closed, whichever happens first.\n//\n// Canceling this context releases resources associated with it, so code should\n// call cancel as soon as the operations running in this Context complete.\n\n\nWithcancel 返回的是一个parent的镜像/复制，伴随一个Done channel通道。\nDone关闭状态取决于\n1、返回的cancel函数。\n2、parent的Done Channel关闭。\n这两个哪个先符合条件了。\n```\n\n### WithDeadline/WithTimeout\n\n自己梳理的逻辑执行顺序：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200907-152032.png)\n\n```\nDeadline/WithTimeout区别：\n\n* deadline:的入参是一个具体的截止时间：Time.time\n* withTimeout:入参是一个多少时间后超时：Time.Duration\n```\n\n### WithValue\n\n>Withvalue和value是成对出现的:\n\n```\n1、给ctx设置k,v：withvalue(ctx,k,v)\n2、获取ctx中k的值value(ctx,k)\n```\n### TODO\n#### timerCtx详细的设计思路和结构文档\n#### 框架图整理\n\n\n### END","source":"_posts/7-Go-Context包使用.md","raw":"---\ntitle: 「7」Go Context包使用\ndate: '2020/09/07 22:21:52'\nupdated: '2020/09/07 22:21:52'\nkeywords: golang,go context包,golang context WithCancel,golang context WithDeadline,go\n  WithTimeout.\ntags:\n  - Go\n  - Go Package\nabbrlink: 410dfaec\n---\n\n### 版本\n```\n◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 用Go的都离不开Context，引用官网的一句话来描述Context包：\n\n>Package context defines the Context type, which carries deadlines, cancellation signals, and other request-scoped values across API boundaries and between processes.\n\n主要掌握四个方法的使用\n```\nWithCancel\nWithDeadline\nWithTimeout\nWithValue\n```\n### 前期ready\n\n要用下面的方法，先了解下部分结构和逻辑：\n\n>既然context全部都是和取消相关的，最起码Go在设计时会有这么一个结构。\n<!-- more -->\n\n>具体的取消设计结构\n```\ntype cancelCtx struct {\n\tContext\n\n\tmu       sync.Mutex            // protects following fields  加锁用\n\tdone     chan struct{}         // created lazily, closed by first cancel call   控制channel\n\tchildren map[canceler]struct{} // set to nil by the first cancel call  cancel函数调用后，释放子类\n\terr      error                 // set to non-nil by the first cancel call\n}\n```\n\n>timer控制死锁时间结构：\n```\n// A timerCtx carries a timer and a deadline. It embeds a cancelCtx to\n// implement Done and Err. It implements cancel by stopping its timer then\n// delegating to cancelCtx.cancel.\n\ntype timerCtx struct {\n\tcancelCtx  \n\ttimer *time.Timer // Under cancelCtx.mu.\n\n\tdeadline time.Time\n}\n```\n\n### WithCancel\n\n```\nfunc WithCancel(parent Context) (ctx Context, cancel CancelFunc) {\n    if parent == nil {  //日常判空\n\t\tpanic(\"cannot create context from nil parent\")\n\t}\n\tc := newCancelCtx(parent) //cancelCtx new\n\tpropagateCancel(parent, &c)  //循环传播取消函数for ctx\n\treturn &c, func() { c.cancel(true, Canceled) }\n}\n```\n>看似很简单，四行解决，但是更重要的是学会看注释说明和相关的设计思路： \nTODO \n\n引用官方的语言：\n```\n// WithCancel returns a copy of parent with a new Done channel. The returned\n// context's Done channel is closed when the returned cancel function is called\n// or when the parent context's Done channel is closed, whichever happens first.\n//\n// Canceling this context releases resources associated with it, so code should\n// call cancel as soon as the operations running in this Context complete.\n\n\nWithcancel 返回的是一个parent的镜像/复制，伴随一个Done channel通道。\nDone关闭状态取决于\n1、返回的cancel函数。\n2、parent的Done Channel关闭。\n这两个哪个先符合条件了。\n```\n\n### WithDeadline/WithTimeout\n\n自己梳理的逻辑执行顺序：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200907-152032.png)\n\n```\nDeadline/WithTimeout区别：\n\n* deadline:的入参是一个具体的截止时间：Time.time\n* withTimeout:入参是一个多少时间后超时：Time.Duration\n```\n\n### WithValue\n\n>Withvalue和value是成对出现的:\n\n```\n1、给ctx设置k,v：withvalue(ctx,k,v)\n2、获取ctx中k的值value(ctx,k)\n```\n### TODO\n#### timerCtx详细的设计思路和结构文档\n#### 框架图整理\n\n\n### END","slug":"7-Go-Context包使用","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlm00283ci7bxytekpb","content":"<h3 id=\"版本\"><a class=\"header-anchor\" href=\"#版本\">¶</a>版本</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">◯  go version</span><br><span class=\"line\">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"用Go的都离不开Context，引用官网的一句话来描述Context包：\"><a class=\"header-anchor\" href=\"#用Go的都离不开Context，引用官网的一句话来描述Context包：\">¶</a>用Go的都离不开Context，引用官网的一句话来描述Context包：</h3>\n<blockquote>\n<p>Package context defines the Context type, which carries deadlines, cancellation signals, and other request-scoped values across API boundaries and between processes.</p>\n</blockquote>\n<p>主要掌握四个方法的使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WithCancel</span><br><span class=\"line\">WithDeadline</span><br><span class=\"line\">WithTimeout</span><br><span class=\"line\">WithValue</span><br></pre></td></tr></table></figure>\n<h3 id=\"前期ready\"><a class=\"header-anchor\" href=\"#前期ready\">¶</a>前期ready</h3>\n<p>要用下面的方法，先了解下部分结构和逻辑：</p>\n<blockquote>\n<p>既然context全部都是和取消相关的，最起码Go在设计时会有这么一个结构。</p>\n</blockquote>\n<a id=\"more\"></a>\n<blockquote>\n<p>具体的取消设计结构</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type cancelCtx struct &#123;</span><br><span class=\"line\">\tContext</span><br><span class=\"line\"></span><br><span class=\"line\">\tmu       sync.Mutex            &#x2F;&#x2F; protects following fields  加锁用</span><br><span class=\"line\">\tdone     chan struct&#123;&#125;         &#x2F;&#x2F; created lazily, closed by first cancel call   控制channel</span><br><span class=\"line\">\tchildren map[canceler]struct&#123;&#125; &#x2F;&#x2F; set to nil by the first cancel call  cancel函数调用后，释放子类</span><br><span class=\"line\">\terr      error                 &#x2F;&#x2F; set to non-nil by the first cancel call</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>timer控制死锁时间结构：</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; A timerCtx carries a timer and a deadline. It embeds a cancelCtx to</span><br><span class=\"line\">&#x2F;&#x2F; implement Done and Err. It implements cancel by stopping its timer then</span><br><span class=\"line\">&#x2F;&#x2F; delegating to cancelCtx.cancel.</span><br><span class=\"line\"></span><br><span class=\"line\">type timerCtx struct &#123;</span><br><span class=\"line\">\tcancelCtx  </span><br><span class=\"line\">\ttimer *time.Timer &#x2F;&#x2F; Under cancelCtx.mu.</span><br><span class=\"line\"></span><br><span class=\"line\">\tdeadline time.Time</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"WithCancel\"><a class=\"header-anchor\" href=\"#WithCancel\">¶</a>WithCancel</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func WithCancel(parent Context) (ctx Context, cancel CancelFunc) &#123;</span><br><span class=\"line\">    if parent &#x3D;&#x3D; nil &#123;  &#x2F;&#x2F;日常判空</span><br><span class=\"line\">\t\tpanic(&quot;cannot create context from nil parent&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tc :&#x3D; newCancelCtx(parent) &#x2F;&#x2F;cancelCtx new</span><br><span class=\"line\">\tpropagateCancel(parent, &amp;c)  &#x2F;&#x2F;循环传播取消函数for ctx</span><br><span class=\"line\">\treturn &amp;c, func() &#123; c.cancel(true, Canceled) &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>看似很简单，四行解决，但是更重要的是学会看注释说明和相关的设计思路：<br>\nTODO</p>\n</blockquote>\n<p>引用官方的语言：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; WithCancel returns a copy of parent with a new Done channel. The returned</span><br><span class=\"line\">&#x2F;&#x2F; context&#39;s Done channel is closed when the returned cancel function is called</span><br><span class=\"line\">&#x2F;&#x2F; or when the parent context&#39;s Done channel is closed, whichever happens first.</span><br><span class=\"line\">&#x2F;&#x2F;</span><br><span class=\"line\">&#x2F;&#x2F; Canceling this context releases resources associated with it, so code should</span><br><span class=\"line\">&#x2F;&#x2F; call cancel as soon as the operations running in this Context complete.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Withcancel 返回的是一个parent的镜像&#x2F;复制，伴随一个Done channel通道。</span><br><span class=\"line\">Done关闭状态取决于</span><br><span class=\"line\">1、返回的cancel函数。</span><br><span class=\"line\">2、parent的Done Channel关闭。</span><br><span class=\"line\">这两个哪个先符合条件了。</span><br></pre></td></tr></table></figure>\n<h3 id=\"WithDeadline-WithTimeout\"><a class=\"header-anchor\" href=\"#WithDeadline-WithTimeout\">¶</a>WithDeadline/WithTimeout</h3>\n<p>自己梳理的逻辑执行顺序：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200907-152032.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Deadline&#x2F;WithTimeout区别：</span><br><span class=\"line\"></span><br><span class=\"line\">* deadline:的入参是一个具体的截止时间：Time.time</span><br><span class=\"line\">* withTimeout:入参是一个多少时间后超时：Time.Duration</span><br></pre></td></tr></table></figure>\n<h3 id=\"WithValue\"><a class=\"header-anchor\" href=\"#WithValue\">¶</a>WithValue</h3>\n<blockquote>\n<p>Withvalue和value是成对出现的:</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、给ctx设置k,v：withvalue(ctx,k,v)</span><br><span class=\"line\">2、获取ctx中k的值value(ctx,k)</span><br></pre></td></tr></table></figure>\n<h3 id=\"TODO\"><a class=\"header-anchor\" href=\"#TODO\">¶</a>TODO</h3>\n<h4 id=\"timerCtx详细的设计思路和结构文档\"><a class=\"header-anchor\" href=\"#timerCtx详细的设计思路和结构文档\">¶</a>timerCtx详细的设计思路和结构文档</h4>\n<h4 id=\"框架图整理\"><a class=\"header-anchor\" href=\"#框架图整理\">¶</a>框架图整理</h4>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<h3 id=\"版本\"><a class=\"header-anchor\" href=\"#版本\">¶</a>版本</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">◯  go version</span><br><span class=\"line\">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"用Go的都离不开Context，引用官网的一句话来描述Context包：\"><a class=\"header-anchor\" href=\"#用Go的都离不开Context，引用官网的一句话来描述Context包：\">¶</a>用Go的都离不开Context，引用官网的一句话来描述Context包：</h3>\n<blockquote>\n<p>Package context defines the Context type, which carries deadlines, cancellation signals, and other request-scoped values across API boundaries and between processes.</p>\n</blockquote>\n<p>主要掌握四个方法的使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WithCancel</span><br><span class=\"line\">WithDeadline</span><br><span class=\"line\">WithTimeout</span><br><span class=\"line\">WithValue</span><br></pre></td></tr></table></figure>\n<h3 id=\"前期ready\"><a class=\"header-anchor\" href=\"#前期ready\">¶</a>前期ready</h3>\n<p>要用下面的方法，先了解下部分结构和逻辑：</p>\n<blockquote>\n<p>既然context全部都是和取消相关的，最起码Go在设计时会有这么一个结构。</p>\n</blockquote>","more":"<blockquote>\n<p>具体的取消设计结构</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type cancelCtx struct &#123;</span><br><span class=\"line\">\tContext</span><br><span class=\"line\"></span><br><span class=\"line\">\tmu       sync.Mutex            &#x2F;&#x2F; protects following fields  加锁用</span><br><span class=\"line\">\tdone     chan struct&#123;&#125;         &#x2F;&#x2F; created lazily, closed by first cancel call   控制channel</span><br><span class=\"line\">\tchildren map[canceler]struct&#123;&#125; &#x2F;&#x2F; set to nil by the first cancel call  cancel函数调用后，释放子类</span><br><span class=\"line\">\terr      error                 &#x2F;&#x2F; set to non-nil by the first cancel call</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>timer控制死锁时间结构：</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; A timerCtx carries a timer and a deadline. It embeds a cancelCtx to</span><br><span class=\"line\">&#x2F;&#x2F; implement Done and Err. It implements cancel by stopping its timer then</span><br><span class=\"line\">&#x2F;&#x2F; delegating to cancelCtx.cancel.</span><br><span class=\"line\"></span><br><span class=\"line\">type timerCtx struct &#123;</span><br><span class=\"line\">\tcancelCtx  </span><br><span class=\"line\">\ttimer *time.Timer &#x2F;&#x2F; Under cancelCtx.mu.</span><br><span class=\"line\"></span><br><span class=\"line\">\tdeadline time.Time</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"WithCancel\"><a class=\"header-anchor\" href=\"#WithCancel\">¶</a>WithCancel</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func WithCancel(parent Context) (ctx Context, cancel CancelFunc) &#123;</span><br><span class=\"line\">    if parent &#x3D;&#x3D; nil &#123;  &#x2F;&#x2F;日常判空</span><br><span class=\"line\">\t\tpanic(&quot;cannot create context from nil parent&quot;)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tc :&#x3D; newCancelCtx(parent) &#x2F;&#x2F;cancelCtx new</span><br><span class=\"line\">\tpropagateCancel(parent, &amp;c)  &#x2F;&#x2F;循环传播取消函数for ctx</span><br><span class=\"line\">\treturn &amp;c, func() &#123; c.cancel(true, Canceled) &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>看似很简单，四行解决，但是更重要的是学会看注释说明和相关的设计思路：<br>\nTODO</p>\n</blockquote>\n<p>引用官方的语言：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;&#x2F; WithCancel returns a copy of parent with a new Done channel. The returned</span><br><span class=\"line\">&#x2F;&#x2F; context&#39;s Done channel is closed when the returned cancel function is called</span><br><span class=\"line\">&#x2F;&#x2F; or when the parent context&#39;s Done channel is closed, whichever happens first.</span><br><span class=\"line\">&#x2F;&#x2F;</span><br><span class=\"line\">&#x2F;&#x2F; Canceling this context releases resources associated with it, so code should</span><br><span class=\"line\">&#x2F;&#x2F; call cancel as soon as the operations running in this Context complete.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Withcancel 返回的是一个parent的镜像&#x2F;复制，伴随一个Done channel通道。</span><br><span class=\"line\">Done关闭状态取决于</span><br><span class=\"line\">1、返回的cancel函数。</span><br><span class=\"line\">2、parent的Done Channel关闭。</span><br><span class=\"line\">这两个哪个先符合条件了。</span><br></pre></td></tr></table></figure>\n<h3 id=\"WithDeadline-WithTimeout\"><a class=\"header-anchor\" href=\"#WithDeadline-WithTimeout\">¶</a>WithDeadline/WithTimeout</h3>\n<p>自己梳理的逻辑执行顺序：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200907-152032.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Deadline&#x2F;WithTimeout区别：</span><br><span class=\"line\"></span><br><span class=\"line\">* deadline:的入参是一个具体的截止时间：Time.time</span><br><span class=\"line\">* withTimeout:入参是一个多少时间后超时：Time.Duration</span><br></pre></td></tr></table></figure>\n<h3 id=\"WithValue\"><a class=\"header-anchor\" href=\"#WithValue\">¶</a>WithValue</h3>\n<blockquote>\n<p>Withvalue和value是成对出现的:</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、给ctx设置k,v：withvalue(ctx,k,v)</span><br><span class=\"line\">2、获取ctx中k的值value(ctx,k)</span><br></pre></td></tr></table></figure>\n<h3 id=\"TODO\"><a class=\"header-anchor\" href=\"#TODO\">¶</a>TODO</h3>\n<h4 id=\"timerCtx详细的设计思路和结构文档\"><a class=\"header-anchor\" href=\"#timerCtx详细的设计思路和结构文档\">¶</a>timerCtx详细的设计思路和结构文档</h4>\n<h4 id=\"框架图整理\"><a class=\"header-anchor\" href=\"#框架图整理\">¶</a>框架图整理</h4>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200907-152032.png","popularPost_tmp_gaData":{"updated":"Mon Sep 07 2020 22:21:52 GMT+0800 (中国标准时间)","title":"「7」Go Context包使用","path":"archives/410dfaec.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200907-152032.png","excerpt":"<h3 id=\"版本\"><a class=\"header-anchor\" href=\"#版本\">¶</a>版本</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">◯  go version</span><br><span class=\"line\">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"用Go的都离不开Context，引用官网的一句话来描述Context包：\"><a class=\"header-anchor\" href=\"#用Go的都离不开Context，引用官网的一句话来描述Context包：\">¶</a>用Go的都离不开Context，引用官网的一句话来描述Context包：</h3>\n<blockquote>\n<p>Package context defines the Context type, which carries deadlines, cancellation signals, and other request-scoped values across API boundaries and between processes.</p>\n</blockquote>\n<p>主要掌握四个方法的使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">WithCancel</span><br><span class=\"line\">WithDeadline</span><br><span class=\"line\">WithTimeout</span><br><span class=\"line\">WithValue</span><br></pre></td></tr></table></figure>\n<h3 id=\"前期ready\"><a class=\"header-anchor\" href=\"#前期ready\">¶</a>前期ready</h3>\n<p>要用下面的方法，先了解下部分结构和逻辑：</p>\n<blockquote>\n<p>既然context全部都是和取消相关的，最起码Go在设计时会有这么一个结构。</p>\n</blockquote>","date":{"_isAMomentObject":true,"_i":"2020-09-07T14:21:52.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-07T14:21:52.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Go Package"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":2187},{"title":"「8」go rwmutex解读","date":"2020-09-16T17:24:32.000Z","updated":"2020-09-21T13:24:32.000Z","keywords":"golang,go 源码,go 读写锁, rwmutex 解读","abbrlink":"3038b6c3","_content":"    好久没有更新文章了，表达能力生疏了许多😄....\n    今天扯扯:rwmutex 被称为读写锁。一说到【锁】最直接的联想可能就是lock()、Rlock()、unlock()、Runlock()之类的，但是作为程序猿，还是要了解下底层的设计和相关的逻辑实现，以便于把这种锁的设计思想应用到其它场景中，好了，不废话了，开题吧。\n    从锁的结构设计-->加锁的过程--->加锁的粒度---->解锁释放，整个生命周期来看rwmutex的具体实现。\n<!-- more -->\n### 版本\n```\n◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 同向对比rwmutex锁的设计\n    java实现：AQS(AbstractQueuedSynchronizer)\n\n### 结构设计\n>原则：读写互斥，优先写。\n\n```go\ntype RWMutex struct {\n\tw           Mutex  // held if there are pending writers\n\twriterSem   uint32 // semaphore for writers to wait for completing readers  写信号量\n\treaderSem   uint32 // semaphore for readers to wait for completing writers  读信号量\n\treaderCount int32  // number of pending readers 读计数\n\treaderWait  int32  // number of departing readers   读等待（write进行）\n}\n\nconst rwmutexMaxReaders = 1 << 30   //最大读锁的个数\n```\n\n其它再分类就是四个主要的函数：\n\n```\nRLock\nRUnLock\nLock\nUnLock\n```\n### 加锁过程\n\n#### RLock过程\n\n```go\nfunc (rw *RWMutex) RLock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.Disable()\n    }\n    //如果写锁被获取的，则readerCount<0的，阻塞状态\n    //如果写锁没有被获取，则readerCount >0的，获取读锁，不阻塞\n\tif atomic.AddInt32(&rw.readerCount, 1) < 0 {\n        // A writer is pending, wait for it. \n        //写锁被获取了，加到G队列后面，挂起。\n\t\truntime_SemacquireMutex(&rw.readerSem, false, 0)\n\t}\n\tif race.Enabled {\n\t\trace.Enable()\n\t\trace.Acquire(unsafe.Pointer(&rw.readerSem))\n\t}\n}\n```\n\n#### Lock过程\n\n```go\n// Lock locks rw for writing.\n// If the lock is already locked for reading or writing,\n// Lock blocks until the lock is available.\nfunc (rw *RWMutex) Lock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.Disable()\n\t}\n    // First, resolve competition with other writers.\n    //使用mutex锁\n\trw.w.Lock()\n\t// Announce to readers there is a pending writer.\n\tr := atomic.AddInt32(&rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders\n\t// Wait for active readers.\n\tif r != 0 && atomic.AddInt32(&rw.readerWait, r) != 0 {\n        //等待活跃的reader结束后，再给一个写的信号量，保证此刻之后的reader挂起。\n\t\truntime_SemacquireMutex(&rw.writerSem, false, 0)\n\t}\n\tif race.Enabled {\n\t\trace.Enable()\n\t\trace.Acquire(unsafe.Pointer(&rw.readerSem))\n\t\trace.Acquire(unsafe.Pointer(&rw.writerSem))\n\t}\n}\n```\n\n### 加锁的粒度\n> 读 & 写 互不干扰.\n\n### 解锁释放\n\n#### RUnLock\n\n```go\nfunc (rw *RWMutex) RUnlock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.ReleaseMerge(unsafe.Pointer(&rw.writerSem))\n\t\trace.Disable()\n    }\n    // 写锁等待状态，检查当前是否可以进行获取\n\tif r := atomic.AddInt32(&rw.readerCount, -1); r < 0 {\n\t\t// Outlined slow-path to allow the fast-path to be inlined\n\t\trw.rUnlockSlow(r)\n\t}\n\tif race.Enabled {\n\t\trace.Enable()\n\t}\n}\n\nfunc (rw *RWMutex) rUnlockSlow(r int32) {\n    // r + 1 == 0表示直接执行RUnlock()\n\t// r + 1 == -rwmutexMaxReaders表示执行Lock()再执行RUnlock()\n\tif r+1 == 0 || r+1 == -rwmutexMaxReaders {\n\t\trace.Enable()\n\t\tthrow(\"sync: RUnlock of unlocked RWMutex\")\n\t}\n    // A writer is pending.\n    // 当读锁释放完毕后，通知写锁\n\tif atomic.AddInt32(&rw.readerWait, -1) == 0 {\n\t\t// The last reader unblocks the writer.\n\t\truntime_Semrelease(&rw.writerSem, false, 1)\n\t}\n}\n```\n\n#### UnLock\n\n```go\nfunc (rw *RWMutex) Unlock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.Release(unsafe.Pointer(&rw.readerSem))\n\t\trace.Disable()\n\t}\n\n\t// Announce to readers there is no active writer.\n    r := atomic.AddInt32(&rw.readerCount, rwmutexMaxReaders)\n    //说明这个没有枷锁，没法再次释放\n\tif r >= rwmutexMaxReaders {\n\t\trace.Enable()\n\t\tthrow(\"sync: Unlock of unlocked RWMutex\")\n\t}\n    // Unblock blocked readers, if any.\n    //释放所有的锁。\n\tfor i := 0; i < int(r); i++ {\n\t\truntime_Semrelease(&rw.readerSem, false, 0)\n\t}\n\t// Allow other writers to proceed.\n\trw.w.Unlock()\n\tif race.Enabled {\n\t\trace.Enable()\n\t}\n}\n```\n### 总结\n\n>读&写，互不干扰。\n\n* 读锁不能阻塞读锁，引入readerCount.\n\n* 读锁需要阻塞写锁，直到所以读锁都释放，引入readerSem.\n\n* 写锁需要阻塞读锁，直到所以写锁都释放，引入wirterSem.\n\n* 写锁需要阻塞写锁，引入Metux.\n\n### END","source":"_posts/8-go-rwmutex解读.md","raw":"---\ntitle: 「8」go rwmutex解读\ndate: '2020/09/17 01:24:32'\nupdated: '2020/09/21 21:24:32'\nkeywords: 'golang,go 源码,go 读写锁, rwmutex 解读'\ntags:\n  - Go\n  - Go源码\n  - Go Package\n  - 锁\nabbrlink: 3038b6c3\n---\n    好久没有更新文章了，表达能力生疏了许多😄....\n    今天扯扯:rwmutex 被称为读写锁。一说到【锁】最直接的联想可能就是lock()、Rlock()、unlock()、Runlock()之类的，但是作为程序猿，还是要了解下底层的设计和相关的逻辑实现，以便于把这种锁的设计思想应用到其它场景中，好了，不废话了，开题吧。\n    从锁的结构设计-->加锁的过程--->加锁的粒度---->解锁释放，整个生命周期来看rwmutex的具体实现。\n<!-- more -->\n### 版本\n```\n◯  go version\ngo version go1.14.9 darwin/amd64\n```\n\n### 同向对比rwmutex锁的设计\n    java实现：AQS(AbstractQueuedSynchronizer)\n\n### 结构设计\n>原则：读写互斥，优先写。\n\n```go\ntype RWMutex struct {\n\tw           Mutex  // held if there are pending writers\n\twriterSem   uint32 // semaphore for writers to wait for completing readers  写信号量\n\treaderSem   uint32 // semaphore for readers to wait for completing writers  读信号量\n\treaderCount int32  // number of pending readers 读计数\n\treaderWait  int32  // number of departing readers   读等待（write进行）\n}\n\nconst rwmutexMaxReaders = 1 << 30   //最大读锁的个数\n```\n\n其它再分类就是四个主要的函数：\n\n```\nRLock\nRUnLock\nLock\nUnLock\n```\n### 加锁过程\n\n#### RLock过程\n\n```go\nfunc (rw *RWMutex) RLock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.Disable()\n    }\n    //如果写锁被获取的，则readerCount<0的，阻塞状态\n    //如果写锁没有被获取，则readerCount >0的，获取读锁，不阻塞\n\tif atomic.AddInt32(&rw.readerCount, 1) < 0 {\n        // A writer is pending, wait for it. \n        //写锁被获取了，加到G队列后面，挂起。\n\t\truntime_SemacquireMutex(&rw.readerSem, false, 0)\n\t}\n\tif race.Enabled {\n\t\trace.Enable()\n\t\trace.Acquire(unsafe.Pointer(&rw.readerSem))\n\t}\n}\n```\n\n#### Lock过程\n\n```go\n// Lock locks rw for writing.\n// If the lock is already locked for reading or writing,\n// Lock blocks until the lock is available.\nfunc (rw *RWMutex) Lock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.Disable()\n\t}\n    // First, resolve competition with other writers.\n    //使用mutex锁\n\trw.w.Lock()\n\t// Announce to readers there is a pending writer.\n\tr := atomic.AddInt32(&rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders\n\t// Wait for active readers.\n\tif r != 0 && atomic.AddInt32(&rw.readerWait, r) != 0 {\n        //等待活跃的reader结束后，再给一个写的信号量，保证此刻之后的reader挂起。\n\t\truntime_SemacquireMutex(&rw.writerSem, false, 0)\n\t}\n\tif race.Enabled {\n\t\trace.Enable()\n\t\trace.Acquire(unsafe.Pointer(&rw.readerSem))\n\t\trace.Acquire(unsafe.Pointer(&rw.writerSem))\n\t}\n}\n```\n\n### 加锁的粒度\n> 读 & 写 互不干扰.\n\n### 解锁释放\n\n#### RUnLock\n\n```go\nfunc (rw *RWMutex) RUnlock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.ReleaseMerge(unsafe.Pointer(&rw.writerSem))\n\t\trace.Disable()\n    }\n    // 写锁等待状态，检查当前是否可以进行获取\n\tif r := atomic.AddInt32(&rw.readerCount, -1); r < 0 {\n\t\t// Outlined slow-path to allow the fast-path to be inlined\n\t\trw.rUnlockSlow(r)\n\t}\n\tif race.Enabled {\n\t\trace.Enable()\n\t}\n}\n\nfunc (rw *RWMutex) rUnlockSlow(r int32) {\n    // r + 1 == 0表示直接执行RUnlock()\n\t// r + 1 == -rwmutexMaxReaders表示执行Lock()再执行RUnlock()\n\tif r+1 == 0 || r+1 == -rwmutexMaxReaders {\n\t\trace.Enable()\n\t\tthrow(\"sync: RUnlock of unlocked RWMutex\")\n\t}\n    // A writer is pending.\n    // 当读锁释放完毕后，通知写锁\n\tif atomic.AddInt32(&rw.readerWait, -1) == 0 {\n\t\t// The last reader unblocks the writer.\n\t\truntime_Semrelease(&rw.writerSem, false, 1)\n\t}\n}\n```\n\n#### UnLock\n\n```go\nfunc (rw *RWMutex) Unlock() {\n\tif race.Enabled {\n\t\t_ = rw.w.state\n\t\trace.Release(unsafe.Pointer(&rw.readerSem))\n\t\trace.Disable()\n\t}\n\n\t// Announce to readers there is no active writer.\n    r := atomic.AddInt32(&rw.readerCount, rwmutexMaxReaders)\n    //说明这个没有枷锁，没法再次释放\n\tif r >= rwmutexMaxReaders {\n\t\trace.Enable()\n\t\tthrow(\"sync: Unlock of unlocked RWMutex\")\n\t}\n    // Unblock blocked readers, if any.\n    //释放所有的锁。\n\tfor i := 0; i < int(r); i++ {\n\t\truntime_Semrelease(&rw.readerSem, false, 0)\n\t}\n\t// Allow other writers to proceed.\n\trw.w.Unlock()\n\tif race.Enabled {\n\t\trace.Enable()\n\t}\n}\n```\n### 总结\n\n>读&写，互不干扰。\n\n* 读锁不能阻塞读锁，引入readerCount.\n\n* 读锁需要阻塞写锁，直到所以读锁都释放，引入readerSem.\n\n* 写锁需要阻塞读锁，直到所以写锁都释放，引入wirterSem.\n\n* 写锁需要阻塞写锁，引入Metux.\n\n### END","slug":"8-go-rwmutex解读","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdln002b3ci78kci10gj","content":"<pre><code>好久没有更新文章了，表达能力生疏了许多😄....\n今天扯扯:rwmutex 被称为读写锁。一说到【锁】最直接的联想可能就是lock()、Rlock()、unlock()、Runlock()之类的，但是作为程序猿，还是要了解下底层的设计和相关的逻辑实现，以便于把这种锁的设计思想应用到其它场景中，好了，不废话了，开题吧。\n从锁的结构设计--&gt;加锁的过程---&gt;加锁的粒度----&gt;解锁释放，整个生命周期来看rwmutex的具体实现。\n</code></pre>\n<a id=\"more\"></a>\n<h3 id=\"版本\"><a class=\"header-anchor\" href=\"#版本\">¶</a>版本</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">◯  go version</span><br><span class=\"line\">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"同向对比rwmutex锁的设计\"><a class=\"header-anchor\" href=\"#同向对比rwmutex锁的设计\">¶</a>同向对比rwmutex锁的设计</h3>\n<pre><code>java实现：AQS(AbstractQueuedSynchronizer)\n</code></pre>\n<h3 id=\"结构设计\"><a class=\"header-anchor\" href=\"#结构设计\">¶</a>结构设计</h3>\n<blockquote>\n<p>原则：读写互斥，优先写。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> RWMutex <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tw           Mutex  <span class=\"comment\">// held if there are pending writers</span></span><br><span class=\"line\">\twriterSem   <span class=\"keyword\">uint32</span> <span class=\"comment\">// semaphore for writers to wait for completing readers  写信号量</span></span><br><span class=\"line\">\treaderSem   <span class=\"keyword\">uint32</span> <span class=\"comment\">// semaphore for readers to wait for completing writers  读信号量</span></span><br><span class=\"line\">\treaderCount <span class=\"keyword\">int32</span>  <span class=\"comment\">// number of pending readers 读计数</span></span><br><span class=\"line\">\treaderWait  <span class=\"keyword\">int32</span>  <span class=\"comment\">// number of departing readers   读等待（write进行）</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> rwmutexMaxReaders = <span class=\"number\">1</span> &lt;&lt; <span class=\"number\">30</span>   <span class=\"comment\">//最大读锁的个数</span></span><br></pre></td></tr></table></figure>\n<p>其它再分类就是四个主要的函数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RLock</span><br><span class=\"line\">RUnLock</span><br><span class=\"line\">Lock</span><br><span class=\"line\">UnLock</span><br></pre></td></tr></table></figure>\n<h3 id=\"加锁过程\"><a class=\"header-anchor\" href=\"#加锁过程\">¶</a>加锁过程</h3>\n<h4 id=\"RLock过程\"><a class=\"header-anchor\" href=\"#RLock过程\">¶</a>RLock过程</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">RLock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//如果写锁被获取的，则readerCount&lt;0的，阻塞状态</span></span><br><span class=\"line\">    <span class=\"comment\">//如果写锁没有被获取，则readerCount &gt;0的，获取读锁，不阻塞</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// A writer is pending, wait for it. </span></span><br><span class=\"line\">        <span class=\"comment\">//写锁被获取了，加到G队列后面，挂起。</span></span><br><span class=\"line\">\t\truntime_SemacquireMutex(&amp;rw.readerSem, <span class=\"literal\">false</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Lock过程\"><a class=\"header-anchor\" href=\"#Lock过程\">¶</a>Lock过程</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Lock locks rw for writing.</span></span><br><span class=\"line\"><span class=\"comment\">// If the lock is already locked for reading or writing,</span></span><br><span class=\"line\"><span class=\"comment\">// Lock blocks until the lock is available.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">Lock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">// First, resolve competition with other writers.</span></span><br><span class=\"line\">    <span class=\"comment\">//使用mutex锁</span></span><br><span class=\"line\">\trw.w.Lock()</span><br><span class=\"line\">\t<span class=\"comment\">// Announce to readers there is a pending writer.</span></span><br><span class=\"line\">\tr := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</span><br><span class=\"line\">\t<span class=\"comment\">// Wait for active readers.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r != <span class=\"number\">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//等待活跃的reader结束后，再给一个写的信号量，保证此刻之后的reader挂起。</span></span><br><span class=\"line\">\t\truntime_SemacquireMutex(&amp;rw.writerSem, <span class=\"literal\">false</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"加锁的粒度\"><a class=\"header-anchor\" href=\"#加锁的粒度\">¶</a>加锁的粒度</h3>\n<blockquote>\n<p>读 &amp; 写 互不干扰.</p>\n</blockquote>\n<h3 id=\"解锁释放\"><a class=\"header-anchor\" href=\"#解锁释放\">¶</a>解锁释放</h3>\n<h4 id=\"RUnLock\"><a class=\"header-anchor\" href=\"#RUnLock\">¶</a>RUnLock</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">RUnlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.ReleaseMerge(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 写锁等待状态，检查当前是否可以进行获取</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class=\"number\">-1</span>); r &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Outlined slow-path to allow the fast-path to be inlined</span></span><br><span class=\"line\">\t\trw.rUnlockSlow(r)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">rUnlockSlow</span><span class=\"params\">(r <span class=\"keyword\">int32</span>)</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// r + 1 == 0表示直接执行RUnlock()</span></span><br><span class=\"line\">\t<span class=\"comment\">// r + 1 == -rwmutexMaxReaders表示执行Lock()再执行RUnlock()</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r+<span class=\"number\">1</span> == <span class=\"number\">0</span> || r+<span class=\"number\">1</span> == -rwmutexMaxReaders &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;sync: RUnlock of unlocked RWMutex&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">// A writer is pending.</span></span><br><span class=\"line\">    <span class=\"comment\">// 当读锁释放完毕后，通知写锁</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class=\"number\">-1</span>) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The last reader unblocks the writer.</span></span><br><span class=\"line\">\t\truntime_Semrelease(&amp;rw.writerSem, <span class=\"literal\">false</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"UnLock\"><a class=\"header-anchor\" href=\"#UnLock\">¶</a>UnLock</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">Unlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.Release(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Announce to readers there is no active writer.</span></span><br><span class=\"line\">    r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</span><br><span class=\"line\">    <span class=\"comment\">//说明这个没有枷锁，没法再次释放</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r &gt;= rwmutexMaxReaders &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;sync: Unlock of unlocked RWMutex&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">// Unblock blocked readers, if any.</span></span><br><span class=\"line\">    <span class=\"comment\">//释放所有的锁。</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"keyword\">int</span>(r); i++ &#123;</span><br><span class=\"line\">\t\truntime_Semrelease(&amp;rw.readerSem, <span class=\"literal\">false</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Allow other writers to proceed.</span></span><br><span class=\"line\">\trw.w.Unlock()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"总结\"><a class=\"header-anchor\" href=\"#总结\">¶</a>总结</h3>\n<blockquote>\n<p>读&amp;写，互不干扰。</p>\n</blockquote>\n<ul>\n<li>\n<p>读锁不能阻塞读锁，引入readerCount.</p>\n</li>\n<li>\n<p>读锁需要阻塞写锁，直到所以读锁都释放，引入readerSem.</p>\n</li>\n<li>\n<p>写锁需要阻塞读锁，直到所以写锁都释放，引入wirterSem.</p>\n</li>\n<li>\n<p>写锁需要阻塞写锁，引入Metux.</p>\n</li>\n</ul>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<pre><code>好久没有更新文章了，表达能力生疏了许多😄....\n今天扯扯:rwmutex 被称为读写锁。一说到【锁】最直接的联想可能就是lock()、Rlock()、unlock()、Runlock()之类的，但是作为程序猿，还是要了解下底层的设计和相关的逻辑实现，以便于把这种锁的设计思想应用到其它场景中，好了，不废话了，开题吧。\n从锁的结构设计--&gt;加锁的过程---&gt;加锁的粒度----&gt;解锁释放，整个生命周期来看rwmutex的具体实现。\n</code></pre>","more":"<h3 id=\"版本\"><a class=\"header-anchor\" href=\"#版本\">¶</a>版本</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">◯  go version</span><br><span class=\"line\">go version go1.14.9 darwin&#x2F;amd64</span><br></pre></td></tr></table></figure>\n<h3 id=\"同向对比rwmutex锁的设计\"><a class=\"header-anchor\" href=\"#同向对比rwmutex锁的设计\">¶</a>同向对比rwmutex锁的设计</h3>\n<pre><code>java实现：AQS(AbstractQueuedSynchronizer)\n</code></pre>\n<h3 id=\"结构设计\"><a class=\"header-anchor\" href=\"#结构设计\">¶</a>结构设计</h3>\n<blockquote>\n<p>原则：读写互斥，优先写。</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> RWMutex <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tw           Mutex  <span class=\"comment\">// held if there are pending writers</span></span><br><span class=\"line\">\twriterSem   <span class=\"keyword\">uint32</span> <span class=\"comment\">// semaphore for writers to wait for completing readers  写信号量</span></span><br><span class=\"line\">\treaderSem   <span class=\"keyword\">uint32</span> <span class=\"comment\">// semaphore for readers to wait for completing writers  读信号量</span></span><br><span class=\"line\">\treaderCount <span class=\"keyword\">int32</span>  <span class=\"comment\">// number of pending readers 读计数</span></span><br><span class=\"line\">\treaderWait  <span class=\"keyword\">int32</span>  <span class=\"comment\">// number of departing readers   读等待（write进行）</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> rwmutexMaxReaders = <span class=\"number\">1</span> &lt;&lt; <span class=\"number\">30</span>   <span class=\"comment\">//最大读锁的个数</span></span><br></pre></td></tr></table></figure>\n<p>其它再分类就是四个主要的函数：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RLock</span><br><span class=\"line\">RUnLock</span><br><span class=\"line\">Lock</span><br><span class=\"line\">UnLock</span><br></pre></td></tr></table></figure>\n<h3 id=\"加锁过程\"><a class=\"header-anchor\" href=\"#加锁过程\">¶</a>加锁过程</h3>\n<h4 id=\"RLock过程\"><a class=\"header-anchor\" href=\"#RLock过程\">¶</a>RLock过程</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">RLock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//如果写锁被获取的，则readerCount&lt;0的，阻塞状态</span></span><br><span class=\"line\">    <span class=\"comment\">//如果写锁没有被获取，则readerCount &gt;0的，获取读锁，不阻塞</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// A writer is pending, wait for it. </span></span><br><span class=\"line\">        <span class=\"comment\">//写锁被获取了，加到G队列后面，挂起。</span></span><br><span class=\"line\">\t\truntime_SemacquireMutex(&amp;rw.readerSem, <span class=\"literal\">false</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Lock过程\"><a class=\"header-anchor\" href=\"#Lock过程\">¶</a>Lock过程</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Lock locks rw for writing.</span></span><br><span class=\"line\"><span class=\"comment\">// If the lock is already locked for reading or writing,</span></span><br><span class=\"line\"><span class=\"comment\">// Lock blocks until the lock is available.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">Lock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">// First, resolve competition with other writers.</span></span><br><span class=\"line\">    <span class=\"comment\">//使用mutex锁</span></span><br><span class=\"line\">\trw.w.Lock()</span><br><span class=\"line\">\t<span class=\"comment\">// Announce to readers there is a pending writer.</span></span><br><span class=\"line\">\tr := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</span><br><span class=\"line\">\t<span class=\"comment\">// Wait for active readers.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r != <span class=\"number\">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//等待活跃的reader结束后，再给一个写的信号量，保证此刻之后的reader挂起。</span></span><br><span class=\"line\">\t\truntime_SemacquireMutex(&amp;rw.writerSem, <span class=\"literal\">false</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class=\"line\">\t\trace.Acquire(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"加锁的粒度\"><a class=\"header-anchor\" href=\"#加锁的粒度\">¶</a>加锁的粒度</h3>\n<blockquote>\n<p>读 &amp; 写 互不干扰.</p>\n</blockquote>\n<h3 id=\"解锁释放\"><a class=\"header-anchor\" href=\"#解锁释放\">¶</a>解锁释放</h3>\n<h4 id=\"RUnLock\"><a class=\"header-anchor\" href=\"#RUnLock\">¶</a>RUnLock</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">RUnlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.ReleaseMerge(unsafe.Pointer(&amp;rw.writerSem))</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 写锁等待状态，检查当前是否可以进行获取</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class=\"number\">-1</span>); r &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Outlined slow-path to allow the fast-path to be inlined</span></span><br><span class=\"line\">\t\trw.rUnlockSlow(r)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">rUnlockSlow</span><span class=\"params\">(r <span class=\"keyword\">int32</span>)</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// r + 1 == 0表示直接执行RUnlock()</span></span><br><span class=\"line\">\t<span class=\"comment\">// r + 1 == -rwmutexMaxReaders表示执行Lock()再执行RUnlock()</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r+<span class=\"number\">1</span> == <span class=\"number\">0</span> || r+<span class=\"number\">1</span> == -rwmutexMaxReaders &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;sync: RUnlock of unlocked RWMutex&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">// A writer is pending.</span></span><br><span class=\"line\">    <span class=\"comment\">// 当读锁释放完毕后，通知写锁</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class=\"number\">-1</span>) == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The last reader unblocks the writer.</span></span><br><span class=\"line\">\t\truntime_Semrelease(&amp;rw.writerSem, <span class=\"literal\">false</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"UnLock\"><a class=\"header-anchor\" href=\"#UnLock\">¶</a>UnLock</h4>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(rw *RWMutex)</span> <span class=\"title\">Unlock</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\t_ = rw.w.state</span><br><span class=\"line\">\t\trace.Release(unsafe.Pointer(&amp;rw.readerSem))</span><br><span class=\"line\">\t\trace.Disable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// Announce to readers there is no active writer.</span></span><br><span class=\"line\">    r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</span><br><span class=\"line\">    <span class=\"comment\">//说明这个没有枷锁，没法再次释放</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> r &gt;= rwmutexMaxReaders &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t\tthrow(<span class=\"string\">&quot;sync: Unlock of unlocked RWMutex&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"comment\">// Unblock blocked readers, if any.</span></span><br><span class=\"line\">    <span class=\"comment\">//释放所有的锁。</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"keyword\">int</span>(r); i++ &#123;</span><br><span class=\"line\">\t\truntime_Semrelease(&amp;rw.readerSem, <span class=\"literal\">false</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// Allow other writers to proceed.</span></span><br><span class=\"line\">\trw.w.Unlock()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> race.Enabled &#123;</span><br><span class=\"line\">\t\trace.Enable()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"总结\"><a class=\"header-anchor\" href=\"#总结\">¶</a>总结</h3>\n<blockquote>\n<p>读&amp;写，互不干扰。</p>\n</blockquote>\n<ul>\n<li>\n<p>读锁不能阻塞读锁，引入readerCount.</p>\n</li>\n<li>\n<p>读锁需要阻塞写锁，直到所以读锁都释放，引入readerSem.</p>\n</li>\n<li>\n<p>写锁需要阻塞读锁，直到所以写锁都释放，引入wirterSem.</p>\n</li>\n<li>\n<p>写锁需要阻塞写锁，引入Metux.</p>\n</li>\n</ul>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":null,"popularPost_tmp_gaData":{"updated":"Mon Sep 21 2020 21:24:32 GMT+0800 (中国标准时间)","title":"「8」go rwmutex解读","path":"archives/3038b6c3.html","eyeCatchImage":null,"excerpt":"<pre><code>好久没有更新文章了，表达能力生疏了许多😄....\n今天扯扯:rwmutex 被称为读写锁。一说到【锁】最直接的联想可能就是lock()、Rlock()、unlock()、Runlock()之类的，但是作为程序猿，还是要了解下底层的设计和相关的逻辑实现，以便于把这种锁的设计思想应用到其它场景中，好了，不废话了，开题吧。\n从锁的结构设计--&gt;加锁的过程---&gt;加锁的粒度----&gt;解锁释放，整个生命周期来看rwmutex的具体实现。\n</code></pre>","date":{"_isAMomentObject":true,"_i":"2020-09-16T17:24:32.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-16T17:24:32.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Go源码","Go Package","锁"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":3423},{"title":"「9」Go reflect ~ DeepEqual","date":"2020-09-18T04:35:03.000Z","updated":"2020-09-20T08:16:52.000Z","abbrlink":"e2e7cc4e","_content":"\n今天无意中看到Go101发了一个推特:\n``` go\npackage main\n\nimport (\n  \"fmt\"\n  \"reflect\"\n)\n\nfunc p(a, b interface{}) {\n  fmt.Print(\":\", reflect.DeepEqual(a, b))\n}\n\nfunc main() {\n  a := [1]func(){func(){}}\n  p(a, a)\n  p(a[:], a[:])\n  b := a\n  p(a[:], b[:])\n}\n```\n\n>输出结果？？ :true:true:false\n\n<!-- more -->\n\n>正确答案 :false:true:false\n\n### 错误来源\n\n```\n第一个为啥想着为true,第一眼看过去，比较两个a的函数，那两个函数肯定是相等的，这是第一直觉(狗屁直觉).\n第二个两个都为nil了，这个是没有什么问题，两个nil肯定是deep相等的。\n第三个虽然是重新初始化了，所以两个肯定不是deep相等的。\n```\n\n### 思路比对（错在哪里）\n\n查阅文档之后，发现理解错了：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200918-124746.png)\n\n\n\n### DeepEqual正确理解\n>源码也很简洁：\n\n```go\nfunc DeepEqual(x, y interface{}) bool {\n  //同nil\n\tif x == nil || y == nil {\n\t\treturn x == y\n\t}\n\tv1 := ValueOf(x)\n  v2 := ValueOf(y)\n  //属于同一类型\n\tif v1.Type() != v2.Type() {\n\t\treturn false\n\t}\n\treturn deepValueEqual(v1, v2, make(map[visit]bool), 0)\n}\n```\n\n除了上面看源码，主要还是要看官方的文档和说明性的，这个算是理解源码的前提把：\n\n```go\n// DeepEqual reports whether x and y are ``deeply equal,'' defined as follows.\n// Two values of identical type are deeply equal if one of the following cases applies.\n// Values of distinct types are never deeply equal.\n//  条件：数组深度相等，相应的元素都是相等的。\n// Array values are deeply equal when their corresponding elements are deeply equal.\n//  条件：结构体相对应的字段都是相等的。\n// Struct values are deeply equal if their corresponding fields,\n// both exported and unexported, are deeply equal.\n// 条件：函数都是nil，则为深度相等，其它情况下都是不相等的。\n// Func values are deeply equal if both are nil; otherwise they are not deeply equal.\n// \n// 条件：两个interface持有深度相同的值。\n// Interface values are deeply equal if they hold deeply equal concrete values.\n//\n    条件：下面条件为true，则深度相等：\n    两个全是nil，或者全non-nil，有相同的长度并且有相同的对象/key对应的值是相等的。\n// Map values are deeply equal when all of the following are true:\n// they are both nil or both non-nil, they have the same length,\n// and either they are the same map object or their corresponding keys\n// (matched using Go equality) map to deeply equal values.\n    条件：用 == 比较或者 point的\n// Pointer values are deeply equal if they are equal using Go's == operator\n// or if they point to deeply equal values.\n    条件：下面条件为true，则深度相等：\n    两个全是nil，或者全non-nil，有相同的长度，指向相同的初始化节点（即：相同的数组）或相同的元素深度相等。\n    注意：empty和nil slice不是深度相等的。\n// Slice values are deeply equal when all of the following are true:\n// they are both nil or both non-nil, they have the same length,\n// and either they point to the same initial entry of the same underlying array\n// (that is, &x[0] == &y[0]) or their corresponding elements (up to length) are deeply equal.\n// Note that a non-nil empty slice and a nil slice (for example, []byte{} and []byte(nil))\n// are not deeply equal.\n//\n// Other values - numbers, bools, strings, and channels - are deeply equal\n// if they are equal using Go's == operator.\n//\n// In general DeepEqual is a recursive relaxation of Go's == operator.\n// However, this idea is impossible to implement without some inconsistency.\n// Specifically, it is possible for a value to be unequal to itself,\n// either because it is of func type (uncomparable in general)\n// or because it is a floating-point NaN value (not equal to itself in floating-point comparison),\n// or because it is an array, struct, or interface containing\n// such a value.\n// On the other hand, pointer values are always equal to themselves,\n// even if they point at or contain such problematic values,\n// because they compare equal using Go's == operator, and that\n// is a sufficient condition to be deeply equal, regardless of content.\n// DeepEqual has been defined so that the same short-cut applies\n// to slices and maps: if x and y are the same slice or the same map,\n// they are deeply equal regardless of content.\n//\n// As DeepEqual traverses the data values it may find a cycle. The\n// second and subsequent times that DeepEqual compares two pointer\n// values that have been compared before, it treats the values as\n// equal rather than examining the values to which they point.\n// This ensures that DeepEqual terminates.\n```\n\n再看看详细的deepValueEqual,大致的过程：\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200920-103516@2x.png)\n\n\n>大致分为三个过程：\n```\n1、判断类型和值\n2、hard回调\n3、按照kind分类处理\n```\n\n#### 数组：\n比较每一个元素\n```go\n    for i := 0; i < v1.Len(); i++ {\n\t\t\tif !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n#### Slice\n* 比较为nil\n* 比较长度\n* 比较地址\n* 比较每一个元素\n```go\n    if v1.IsNil() != v2.IsNil() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Len() != v2.Len() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Pointer() == v2.Pointer() {\n\t\t\treturn true\n\t\t}\n\t\tfor i := 0; i < v1.Len(); i++ {\n\t\t\tif !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n\n#### Interface\n* 比较nil\n* 递归比较\n```go\n    if v1.IsNil() || v2.IsNil() {\n\t\t\treturn v1.IsNil() == v2.IsNil()\n\t\t}\n\t\treturn deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+1)\n```\n#### Ptr\n* 地址\n* 递归比较\n```go\n    if v1.Pointer() == v2.Pointer() {\n\t\t\treturn true\n\t\t}\n\t\treturn deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+1)\n```\n\n#### struct\n* 比较每一个元素\n```go\n    for i, n := 0, v1.NumField(); i < n; i++ {\n\t\t\tif !deepValueEqual(v1.Field(i), v2.Field(i), visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n\n#### Map\n* 比较Nil\n* 比较长度\n* 地址比较\n* 每一个key对应的value\n\n```go\n    if v1.IsNil() != v2.IsNil() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Len() != v2.Len() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Pointer() == v2.Pointer() {\n\t\t\treturn true\n\t\t}\n\t\tfor _, k := range v1.MapKeys() {\n\t\t\tval1 := v1.MapIndex(k)\n\t\t\tval2 := v2.MapIndex(k)\n\t\t\tif !val1.IsValid() || !val2.IsValid() || !deepValueEqual(val1, val2, visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n\n#### Func\n* 非nil，为不等。\n```go\n    if v1.IsNil() && v2.IsNil() {\n\t\t\treturn true\n\t\t}\n\t\t// Can't do better than this:\n\t\treturn false\n```\n\n### painc注意点：\n deepValueEqual函数：\n```go\n  .....\n  ....\n  ...\n  ..\n  .\n  递归次数超过10次则会painc....\n  // if depth > 10 { panic(\"deepValueEqual\") }\t// for debugging\n\n\t// We want to avoid putting more in the visited map than we need to.\n\t// For any possible reference cycle that might be encountered,\n\t// hard(v1, v2) needs to return true for at least one of the types in the cycle,\n\t// and it's safe and valid to get Value's internal pointer.\n\thard := func(v1, v2 Value) bool {\n\t\tswitch v1.Kind() {\n\t\tcase Map, Slice, Ptr, Interface:\n\t\t\t// Nil pointers cannot be cyclic. Avoid putting them in the visited map.\n\t\t\treturn !v1.IsNil() && !v2.IsNil()\n\t\t}\n\t\treturn false\n  }\n  .\n  ..\n  ...\n  ....\n  .....\n  ......\n```\n### END","source":"_posts/9-Go-reflect-DeepEqual.md","raw":"---\ntitle: 「9」Go reflect ~ DeepEqual\ndate: '2020/09/18 12:35:03'\nupdated: '2020/09/20 16:16:52'\ntags:\n  - Go\n  - Go reflect\n  - Go Package\n  - Day\nabbrlink: e2e7cc4e\n---\n\n今天无意中看到Go101发了一个推特:\n``` go\npackage main\n\nimport (\n  \"fmt\"\n  \"reflect\"\n)\n\nfunc p(a, b interface{}) {\n  fmt.Print(\":\", reflect.DeepEqual(a, b))\n}\n\nfunc main() {\n  a := [1]func(){func(){}}\n  p(a, a)\n  p(a[:], a[:])\n  b := a\n  p(a[:], b[:])\n}\n```\n\n>输出结果？？ :true:true:false\n\n<!-- more -->\n\n>正确答案 :false:true:false\n\n### 错误来源\n\n```\n第一个为啥想着为true,第一眼看过去，比较两个a的函数，那两个函数肯定是相等的，这是第一直觉(狗屁直觉).\n第二个两个都为nil了，这个是没有什么问题，两个nil肯定是deep相等的。\n第三个虽然是重新初始化了，所以两个肯定不是deep相等的。\n```\n\n### 思路比对（错在哪里）\n\n查阅文档之后，发现理解错了：\n\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200918-124746.png)\n\n\n\n### DeepEqual正确理解\n>源码也很简洁：\n\n```go\nfunc DeepEqual(x, y interface{}) bool {\n  //同nil\n\tif x == nil || y == nil {\n\t\treturn x == y\n\t}\n\tv1 := ValueOf(x)\n  v2 := ValueOf(y)\n  //属于同一类型\n\tif v1.Type() != v2.Type() {\n\t\treturn false\n\t}\n\treturn deepValueEqual(v1, v2, make(map[visit]bool), 0)\n}\n```\n\n除了上面看源码，主要还是要看官方的文档和说明性的，这个算是理解源码的前提把：\n\n```go\n// DeepEqual reports whether x and y are ``deeply equal,'' defined as follows.\n// Two values of identical type are deeply equal if one of the following cases applies.\n// Values of distinct types are never deeply equal.\n//  条件：数组深度相等，相应的元素都是相等的。\n// Array values are deeply equal when their corresponding elements are deeply equal.\n//  条件：结构体相对应的字段都是相等的。\n// Struct values are deeply equal if their corresponding fields,\n// both exported and unexported, are deeply equal.\n// 条件：函数都是nil，则为深度相等，其它情况下都是不相等的。\n// Func values are deeply equal if both are nil; otherwise they are not deeply equal.\n// \n// 条件：两个interface持有深度相同的值。\n// Interface values are deeply equal if they hold deeply equal concrete values.\n//\n    条件：下面条件为true，则深度相等：\n    两个全是nil，或者全non-nil，有相同的长度并且有相同的对象/key对应的值是相等的。\n// Map values are deeply equal when all of the following are true:\n// they are both nil or both non-nil, they have the same length,\n// and either they are the same map object or their corresponding keys\n// (matched using Go equality) map to deeply equal values.\n    条件：用 == 比较或者 point的\n// Pointer values are deeply equal if they are equal using Go's == operator\n// or if they point to deeply equal values.\n    条件：下面条件为true，则深度相等：\n    两个全是nil，或者全non-nil，有相同的长度，指向相同的初始化节点（即：相同的数组）或相同的元素深度相等。\n    注意：empty和nil slice不是深度相等的。\n// Slice values are deeply equal when all of the following are true:\n// they are both nil or both non-nil, they have the same length,\n// and either they point to the same initial entry of the same underlying array\n// (that is, &x[0] == &y[0]) or their corresponding elements (up to length) are deeply equal.\n// Note that a non-nil empty slice and a nil slice (for example, []byte{} and []byte(nil))\n// are not deeply equal.\n//\n// Other values - numbers, bools, strings, and channels - are deeply equal\n// if they are equal using Go's == operator.\n//\n// In general DeepEqual is a recursive relaxation of Go's == operator.\n// However, this idea is impossible to implement without some inconsistency.\n// Specifically, it is possible for a value to be unequal to itself,\n// either because it is of func type (uncomparable in general)\n// or because it is a floating-point NaN value (not equal to itself in floating-point comparison),\n// or because it is an array, struct, or interface containing\n// such a value.\n// On the other hand, pointer values are always equal to themselves,\n// even if they point at or contain such problematic values,\n// because they compare equal using Go's == operator, and that\n// is a sufficient condition to be deeply equal, regardless of content.\n// DeepEqual has been defined so that the same short-cut applies\n// to slices and maps: if x and y are the same slice or the same map,\n// they are deeply equal regardless of content.\n//\n// As DeepEqual traverses the data values it may find a cycle. The\n// second and subsequent times that DeepEqual compares two pointer\n// values that have been compared before, it treats the values as\n// equal rather than examining the values to which they point.\n// This ensures that DeepEqual terminates.\n```\n\n再看看详细的deepValueEqual,大致的过程：\n![](https://crab-1251738482.cos.accelerate.myqcloud.com/20200920-103516@2x.png)\n\n\n>大致分为三个过程：\n```\n1、判断类型和值\n2、hard回调\n3、按照kind分类处理\n```\n\n#### 数组：\n比较每一个元素\n```go\n    for i := 0; i < v1.Len(); i++ {\n\t\t\tif !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n#### Slice\n* 比较为nil\n* 比较长度\n* 比较地址\n* 比较每一个元素\n```go\n    if v1.IsNil() != v2.IsNil() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Len() != v2.Len() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Pointer() == v2.Pointer() {\n\t\t\treturn true\n\t\t}\n\t\tfor i := 0; i < v1.Len(); i++ {\n\t\t\tif !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n\n#### Interface\n* 比较nil\n* 递归比较\n```go\n    if v1.IsNil() || v2.IsNil() {\n\t\t\treturn v1.IsNil() == v2.IsNil()\n\t\t}\n\t\treturn deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+1)\n```\n#### Ptr\n* 地址\n* 递归比较\n```go\n    if v1.Pointer() == v2.Pointer() {\n\t\t\treturn true\n\t\t}\n\t\treturn deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+1)\n```\n\n#### struct\n* 比较每一个元素\n```go\n    for i, n := 0, v1.NumField(); i < n; i++ {\n\t\t\tif !deepValueEqual(v1.Field(i), v2.Field(i), visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n\n#### Map\n* 比较Nil\n* 比较长度\n* 地址比较\n* 每一个key对应的value\n\n```go\n    if v1.IsNil() != v2.IsNil() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Len() != v2.Len() {\n\t\t\treturn false\n\t\t}\n\t\tif v1.Pointer() == v2.Pointer() {\n\t\t\treturn true\n\t\t}\n\t\tfor _, k := range v1.MapKeys() {\n\t\t\tval1 := v1.MapIndex(k)\n\t\t\tval2 := v2.MapIndex(k)\n\t\t\tif !val1.IsValid() || !val2.IsValid() || !deepValueEqual(val1, val2, visited, depth+1) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn true\n```\n\n#### Func\n* 非nil，为不等。\n```go\n    if v1.IsNil() && v2.IsNil() {\n\t\t\treturn true\n\t\t}\n\t\t// Can't do better than this:\n\t\treturn false\n```\n\n### painc注意点：\n deepValueEqual函数：\n```go\n  .....\n  ....\n  ...\n  ..\n  .\n  递归次数超过10次则会painc....\n  // if depth > 10 { panic(\"deepValueEqual\") }\t// for debugging\n\n\t// We want to avoid putting more in the visited map than we need to.\n\t// For any possible reference cycle that might be encountered,\n\t// hard(v1, v2) needs to return true for at least one of the types in the cycle,\n\t// and it's safe and valid to get Value's internal pointer.\n\thard := func(v1, v2 Value) bool {\n\t\tswitch v1.Kind() {\n\t\tcase Map, Slice, Ptr, Interface:\n\t\t\t// Nil pointers cannot be cyclic. Avoid putting them in the visited map.\n\t\t\treturn !v1.IsNil() && !v2.IsNil()\n\t\t}\n\t\treturn false\n  }\n  .\n  ..\n  ...\n  ....\n  .....\n  ......\n```\n### END","slug":"9-Go-reflect-DeepEqual","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"ckktibdlo002d3ci7fss9580e","content":"<p>今天无意中看到Go101发了一个推特:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">  <span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;reflect&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">p</span><span class=\"params\">(a, b <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">  fmt.Print(<span class=\"string\">&quot;:&quot;</span>, reflect.DeepEqual(a, b))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  a := [<span class=\"number\">1</span>]<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;&#125;&#125;</span><br><span class=\"line\">  p(a, a)</span><br><span class=\"line\">  p(a[:], a[:])</span><br><span class=\"line\">  b := a</span><br><span class=\"line\">  p(a[:], b[:])</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>输出结果？？ :true:true:false</p>\n</blockquote>\n<a id=\"more\"></a>\n<blockquote>\n<p>正确答案 :false:true:false</p>\n</blockquote>\n<h3 id=\"错误来源\"><a class=\"header-anchor\" href=\"#错误来源\">¶</a>错误来源</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">第一个为啥想着为true,第一眼看过去，比较两个a的函数，那两个函数肯定是相等的，这是第一直觉(狗屁直觉).</span><br><span class=\"line\">第二个两个都为nil了，这个是没有什么问题，两个nil肯定是deep相等的。</span><br><span class=\"line\">第三个虽然是重新初始化了，所以两个肯定不是deep相等的。</span><br></pre></td></tr></table></figure>\n<h3 id=\"思路比对（错在哪里）\"><a class=\"header-anchor\" href=\"#思路比对（错在哪里）\">¶</a>思路比对（错在哪里）</h3>\n<p>查阅文档之后，发现理解错了：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200918-124746.png\" alt=\"\"></p>\n<h3 id=\"DeepEqual正确理解\"><a class=\"header-anchor\" href=\"#DeepEqual正确理解\">¶</a>DeepEqual正确理解</h3>\n<blockquote>\n<p>源码也很简洁：</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">DeepEqual</span><span class=\"params\">(x, y <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//同nil</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> x == <span class=\"literal\">nil</span> || y == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> x == y</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tv1 := ValueOf(x)</span><br><span class=\"line\">  v2 := ValueOf(y)</span><br><span class=\"line\">  <span class=\"comment\">//属于同一类型</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> v1.Type() != v2.Type() &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> deepValueEqual(v1, v2, <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[visit]<span class=\"keyword\">bool</span>), <span class=\"number\">0</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>除了上面看源码，主要还是要看官方的文档和说明性的，这个算是理解源码的前提把：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// DeepEqual reports whether x and y are ``deeply equal,&#x27;&#x27; defined as follows.</span></span><br><span class=\"line\"><span class=\"comment\">// Two values of identical type are deeply equal if one of the following cases applies.</span></span><br><span class=\"line\"><span class=\"comment\">// Values of distinct types are never deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">//  条件：数组深度相等，相应的元素都是相等的。</span></span><br><span class=\"line\"><span class=\"comment\">// Array values are deeply equal when their corresponding elements are deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">//  条件：结构体相对应的字段都是相等的。</span></span><br><span class=\"line\"><span class=\"comment\">// Struct values are deeply equal if their corresponding fields,</span></span><br><span class=\"line\"><span class=\"comment\">// both exported and unexported, are deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">// 条件：函数都是nil，则为深度相等，其它情况下都是不相等的。</span></span><br><span class=\"line\"><span class=\"comment\">// Func values are deeply equal if both are nil; otherwise they are not deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"comment\">// 条件：两个interface持有深度相同的值。</span></span><br><span class=\"line\"><span class=\"comment\">// Interface values are deeply equal if they hold deeply equal concrete values.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\">    条件：下面条件为<span class=\"literal\">true</span>，则深度相等：</span><br><span class=\"line\">    两个全是<span class=\"literal\">nil</span>，或者全non-<span class=\"literal\">nil</span>，有相同的长度并且有相同的对象/key对应的值是相等的。</span><br><span class=\"line\"><span class=\"comment\">// Map values are deeply equal when all of the following are true:</span></span><br><span class=\"line\"><span class=\"comment\">// they are both nil or both non-nil, they have the same length,</span></span><br><span class=\"line\"><span class=\"comment\">// and either they are the same map object or their corresponding keys</span></span><br><span class=\"line\"><span class=\"comment\">// (matched using Go equality) map to deeply equal values.</span></span><br><span class=\"line\">    条件：用 == 比较或者 point的</span><br><span class=\"line\"><span class=\"comment\">// Pointer values are deeply equal if they are equal using Go&#x27;s == operator</span></span><br><span class=\"line\"><span class=\"comment\">// or if they point to deeply equal values.</span></span><br><span class=\"line\">    条件：下面条件为<span class=\"literal\">true</span>，则深度相等：</span><br><span class=\"line\">    两个全是<span class=\"literal\">nil</span>，或者全non-<span class=\"literal\">nil</span>，有相同的长度，指向相同的初始化节点（即：相同的数组）或相同的元素深度相等。</span><br><span class=\"line\">    注意：empty和<span class=\"literal\">nil</span> slice不是深度相等的。</span><br><span class=\"line\"><span class=\"comment\">// Slice values are deeply equal when all of the following are true:</span></span><br><span class=\"line\"><span class=\"comment\">// they are both nil or both non-nil, they have the same length,</span></span><br><span class=\"line\"><span class=\"comment\">// and either they point to the same initial entry of the same underlying array</span></span><br><span class=\"line\"><span class=\"comment\">// (that is, &amp;x[0] == &amp;y[0]) or their corresponding elements (up to length) are deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">// Note that a non-nil empty slice and a nil slice (for example, []byte&#123;&#125; and []byte(nil))</span></span><br><span class=\"line\"><span class=\"comment\">// are not deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// Other values - numbers, bools, strings, and channels - are deeply equal</span></span><br><span class=\"line\"><span class=\"comment\">// if they are equal using Go&#x27;s == operator.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// In general DeepEqual is a recursive relaxation of Go&#x27;s == operator.</span></span><br><span class=\"line\"><span class=\"comment\">// However, this idea is impossible to implement without some inconsistency.</span></span><br><span class=\"line\"><span class=\"comment\">// Specifically, it is possible for a value to be unequal to itself,</span></span><br><span class=\"line\"><span class=\"comment\">// either because it is of func type (uncomparable in general)</span></span><br><span class=\"line\"><span class=\"comment\">// or because it is a floating-point NaN value (not equal to itself in floating-point comparison),</span></span><br><span class=\"line\"><span class=\"comment\">// or because it is an array, struct, or interface containing</span></span><br><span class=\"line\"><span class=\"comment\">// such a value.</span></span><br><span class=\"line\"><span class=\"comment\">// On the other hand, pointer values are always equal to themselves,</span></span><br><span class=\"line\"><span class=\"comment\">// even if they point at or contain such problematic values,</span></span><br><span class=\"line\"><span class=\"comment\">// because they compare equal using Go&#x27;s == operator, and that</span></span><br><span class=\"line\"><span class=\"comment\">// is a sufficient condition to be deeply equal, regardless of content.</span></span><br><span class=\"line\"><span class=\"comment\">// DeepEqual has been defined so that the same short-cut applies</span></span><br><span class=\"line\"><span class=\"comment\">// to slices and maps: if x and y are the same slice or the same map,</span></span><br><span class=\"line\"><span class=\"comment\">// they are deeply equal regardless of content.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// As DeepEqual traverses the data values it may find a cycle. The</span></span><br><span class=\"line\"><span class=\"comment\">// second and subsequent times that DeepEqual compares two pointer</span></span><br><span class=\"line\"><span class=\"comment\">// values that have been compared before, it treats the values as</span></span><br><span class=\"line\"><span class=\"comment\">// equal rather than examining the values to which they point.</span></span><br><span class=\"line\"><span class=\"comment\">// This ensures that DeepEqual terminates.</span></span><br></pre></td></tr></table></figure>\n<p>再看看详细的deepValueEqual,大致的过程：<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200920-103516@2x.png\" alt=\"\"></p>\n<blockquote>\n<p>大致分为三个过程：</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、判断类型和值</span><br><span class=\"line\">2、hard回调</span><br><span class=\"line\">3、按照kind分类处理</span><br></pre></td></tr></table></figure>\n<h4 id=\"数组：\"><a class=\"header-anchor\" href=\"#数组：\">¶</a>数组：</h4>\n<p>比较每一个元素</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Slice\"><a class=\"header-anchor\" href=\"#Slice\">¶</a>Slice</h4>\n<ul>\n<li>比较为nil</li>\n<li>比较长度</li>\n<li>比较地址</li>\n<li>比较每一个元素</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Len() != v2.Len() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Interface\"><a class=\"header-anchor\" href=\"#Interface\">¶</a>Interface</h4>\n<ul>\n<li>比较nil</li>\n<li>递归比较</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() || v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> v1.IsNil() == v2.IsNil()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<h4 id=\"Ptr\"><a class=\"header-anchor\" href=\"#Ptr\">¶</a>Ptr</h4>\n<ul>\n<li>地址</li>\n<li>递归比较</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<h4 id=\"struct\"><a class=\"header-anchor\" href=\"#struct\">¶</a>struct</h4>\n<ul>\n<li>比较每一个元素</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">for</span> i, n := <span class=\"number\">0</span>, v1.NumField(); i &lt; n; i++ &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !deepValueEqual(v1.Field(i), v2.Field(i), visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Map\"><a class=\"header-anchor\" href=\"#Map\">¶</a>Map</h4>\n<ul>\n<li>比较Nil</li>\n<li>比较长度</li>\n<li>地址比较</li>\n<li>每一个key对应的value</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Len() != v2.Len() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> _, k := <span class=\"keyword\">range</span> v1.MapKeys() &#123;</span><br><span class=\"line\">\tval1 := v1.MapIndex(k)</span><br><span class=\"line\">\tval2 := v2.MapIndex(k)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !val1.IsValid() || !val2.IsValid() || !deepValueEqual(val1, val2, visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Func\"><a class=\"header-anchor\" href=\"#Func\">¶</a>Func</h4>\n<ul>\n<li>非nil，为不等。</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() &amp;&amp; v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Can&#x27;t do better than this:</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"painc注意点：\"><a class=\"header-anchor\" href=\"#painc注意点：\">¶</a>painc注意点：</h3>\n<p>deepValueEqual函数：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> .....</span><br><span class=\"line\"> ....</span><br><span class=\"line\"> ...</span><br><span class=\"line\"> ..</span><br><span class=\"line\"> .</span><br><span class=\"line\"> 递归次数超过<span class=\"number\">10</span>次则会painc....</span><br><span class=\"line\"> <span class=\"comment\">// if depth &gt; 10 &#123; panic(&quot;deepValueEqual&quot;) &#125;\t// for debugging</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// We want to avoid putting more in the visited map than we need to.</span></span><br><span class=\"line\"><span class=\"comment\">// For any possible reference cycle that might be encountered,</span></span><br><span class=\"line\"><span class=\"comment\">// hard(v1, v2) needs to return true for at least one of the types in the cycle,</span></span><br><span class=\"line\"><span class=\"comment\">// and it&#x27;s safe and valid to get Value&#x27;s internal pointer.</span></span><br><span class=\"line\">hard := <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(v1, v2 Value)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> v1.Kind() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> Map, Slice, Ptr, Interface:</span><br><span class=\"line\">\t\t<span class=\"comment\">// Nil pointers cannot be cyclic. Avoid putting them in the visited map.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> !v1.IsNil() &amp;&amp; !v2.IsNil()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> .</span><br><span class=\"line\"> ..</span><br><span class=\"line\"> ...</span><br><span class=\"line\"> ....</span><br><span class=\"line\"> .....</span><br><span class=\"line\"> ......</span><br></pre></td></tr></table></figure>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>\n","site":{"data":{}},"excerpt":"<p>今天无意中看到Go101发了一个推特:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">  <span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;reflect&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">p</span><span class=\"params\">(a, b <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">  fmt.Print(<span class=\"string\">&quot;:&quot;</span>, reflect.DeepEqual(a, b))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  a := [<span class=\"number\">1</span>]<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;&#125;&#125;</span><br><span class=\"line\">  p(a, a)</span><br><span class=\"line\">  p(a[:], a[:])</span><br><span class=\"line\">  b := a</span><br><span class=\"line\">  p(a[:], b[:])</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>输出结果？？ :true:true:false</p>\n</blockquote>","more":"<blockquote>\n<p>正确答案 :false:true:false</p>\n</blockquote>\n<h3 id=\"错误来源\"><a class=\"header-anchor\" href=\"#错误来源\">¶</a>错误来源</h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">第一个为啥想着为true,第一眼看过去，比较两个a的函数，那两个函数肯定是相等的，这是第一直觉(狗屁直觉).</span><br><span class=\"line\">第二个两个都为nil了，这个是没有什么问题，两个nil肯定是deep相等的。</span><br><span class=\"line\">第三个虽然是重新初始化了，所以两个肯定不是deep相等的。</span><br></pre></td></tr></table></figure>\n<h3 id=\"思路比对（错在哪里）\"><a class=\"header-anchor\" href=\"#思路比对（错在哪里）\">¶</a>思路比对（错在哪里）</h3>\n<p>查阅文档之后，发现理解错了：</p>\n<p><img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200918-124746.png\" alt=\"\"></p>\n<h3 id=\"DeepEqual正确理解\"><a class=\"header-anchor\" href=\"#DeepEqual正确理解\">¶</a>DeepEqual正确理解</h3>\n<blockquote>\n<p>源码也很简洁：</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">DeepEqual</span><span class=\"params\">(x, y <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">//同nil</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> x == <span class=\"literal\">nil</span> || y == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> x == y</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tv1 := ValueOf(x)</span><br><span class=\"line\">  v2 := ValueOf(y)</span><br><span class=\"line\">  <span class=\"comment\">//属于同一类型</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> v1.Type() != v2.Type() &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> deepValueEqual(v1, v2, <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[visit]<span class=\"keyword\">bool</span>), <span class=\"number\">0</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>除了上面看源码，主要还是要看官方的文档和说明性的，这个算是理解源码的前提把：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// DeepEqual reports whether x and y are ``deeply equal,&#x27;&#x27; defined as follows.</span></span><br><span class=\"line\"><span class=\"comment\">// Two values of identical type are deeply equal if one of the following cases applies.</span></span><br><span class=\"line\"><span class=\"comment\">// Values of distinct types are never deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">//  条件：数组深度相等，相应的元素都是相等的。</span></span><br><span class=\"line\"><span class=\"comment\">// Array values are deeply equal when their corresponding elements are deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">//  条件：结构体相对应的字段都是相等的。</span></span><br><span class=\"line\"><span class=\"comment\">// Struct values are deeply equal if their corresponding fields,</span></span><br><span class=\"line\"><span class=\"comment\">// both exported and unexported, are deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">// 条件：函数都是nil，则为深度相等，其它情况下都是不相等的。</span></span><br><span class=\"line\"><span class=\"comment\">// Func values are deeply equal if both are nil; otherwise they are not deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"comment\">// 条件：两个interface持有深度相同的值。</span></span><br><span class=\"line\"><span class=\"comment\">// Interface values are deeply equal if they hold deeply equal concrete values.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\">    条件：下面条件为<span class=\"literal\">true</span>，则深度相等：</span><br><span class=\"line\">    两个全是<span class=\"literal\">nil</span>，或者全non-<span class=\"literal\">nil</span>，有相同的长度并且有相同的对象/key对应的值是相等的。</span><br><span class=\"line\"><span class=\"comment\">// Map values are deeply equal when all of the following are true:</span></span><br><span class=\"line\"><span class=\"comment\">// they are both nil or both non-nil, they have the same length,</span></span><br><span class=\"line\"><span class=\"comment\">// and either they are the same map object or their corresponding keys</span></span><br><span class=\"line\"><span class=\"comment\">// (matched using Go equality) map to deeply equal values.</span></span><br><span class=\"line\">    条件：用 == 比较或者 point的</span><br><span class=\"line\"><span class=\"comment\">// Pointer values are deeply equal if they are equal using Go&#x27;s == operator</span></span><br><span class=\"line\"><span class=\"comment\">// or if they point to deeply equal values.</span></span><br><span class=\"line\">    条件：下面条件为<span class=\"literal\">true</span>，则深度相等：</span><br><span class=\"line\">    两个全是<span class=\"literal\">nil</span>，或者全non-<span class=\"literal\">nil</span>，有相同的长度，指向相同的初始化节点（即：相同的数组）或相同的元素深度相等。</span><br><span class=\"line\">    注意：empty和<span class=\"literal\">nil</span> slice不是深度相等的。</span><br><span class=\"line\"><span class=\"comment\">// Slice values are deeply equal when all of the following are true:</span></span><br><span class=\"line\"><span class=\"comment\">// they are both nil or both non-nil, they have the same length,</span></span><br><span class=\"line\"><span class=\"comment\">// and either they point to the same initial entry of the same underlying array</span></span><br><span class=\"line\"><span class=\"comment\">// (that is, &amp;x[0] == &amp;y[0]) or their corresponding elements (up to length) are deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">// Note that a non-nil empty slice and a nil slice (for example, []byte&#123;&#125; and []byte(nil))</span></span><br><span class=\"line\"><span class=\"comment\">// are not deeply equal.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// Other values - numbers, bools, strings, and channels - are deeply equal</span></span><br><span class=\"line\"><span class=\"comment\">// if they are equal using Go&#x27;s == operator.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// In general DeepEqual is a recursive relaxation of Go&#x27;s == operator.</span></span><br><span class=\"line\"><span class=\"comment\">// However, this idea is impossible to implement without some inconsistency.</span></span><br><span class=\"line\"><span class=\"comment\">// Specifically, it is possible for a value to be unequal to itself,</span></span><br><span class=\"line\"><span class=\"comment\">// either because it is of func type (uncomparable in general)</span></span><br><span class=\"line\"><span class=\"comment\">// or because it is a floating-point NaN value (not equal to itself in floating-point comparison),</span></span><br><span class=\"line\"><span class=\"comment\">// or because it is an array, struct, or interface containing</span></span><br><span class=\"line\"><span class=\"comment\">// such a value.</span></span><br><span class=\"line\"><span class=\"comment\">// On the other hand, pointer values are always equal to themselves,</span></span><br><span class=\"line\"><span class=\"comment\">// even if they point at or contain such problematic values,</span></span><br><span class=\"line\"><span class=\"comment\">// because they compare equal using Go&#x27;s == operator, and that</span></span><br><span class=\"line\"><span class=\"comment\">// is a sufficient condition to be deeply equal, regardless of content.</span></span><br><span class=\"line\"><span class=\"comment\">// DeepEqual has been defined so that the same short-cut applies</span></span><br><span class=\"line\"><span class=\"comment\">// to slices and maps: if x and y are the same slice or the same map,</span></span><br><span class=\"line\"><span class=\"comment\">// they are deeply equal regardless of content.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// As DeepEqual traverses the data values it may find a cycle. The</span></span><br><span class=\"line\"><span class=\"comment\">// second and subsequent times that DeepEqual compares two pointer</span></span><br><span class=\"line\"><span class=\"comment\">// values that have been compared before, it treats the values as</span></span><br><span class=\"line\"><span class=\"comment\">// equal rather than examining the values to which they point.</span></span><br><span class=\"line\"><span class=\"comment\">// This ensures that DeepEqual terminates.</span></span><br></pre></td></tr></table></figure>\n<p>再看看详细的deepValueEqual,大致的过程：<br>\n<img src=\"https://crab-1251738482.cos.accelerate.myqcloud.com/20200920-103516@2x.png\" alt=\"\"></p>\n<blockquote>\n<p>大致分为三个过程：</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、判断类型和值</span><br><span class=\"line\">2、hard回调</span><br><span class=\"line\">3、按照kind分类处理</span><br></pre></td></tr></table></figure>\n<h4 id=\"数组：\"><a class=\"header-anchor\" href=\"#数组：\">¶</a>数组：</h4>\n<p>比较每一个元素</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Slice\"><a class=\"header-anchor\" href=\"#Slice\">¶</a>Slice</h4>\n<ul>\n<li>比较为nil</li>\n<li>比较长度</li>\n<li>比较地址</li>\n<li>比较每一个元素</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Len() != v2.Len() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; v1.Len(); i++ &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !deepValueEqual(v1.Index(i), v2.Index(i), visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Interface\"><a class=\"header-anchor\" href=\"#Interface\">¶</a>Interface</h4>\n<ul>\n<li>比较nil</li>\n<li>递归比较</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() || v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> v1.IsNil() == v2.IsNil()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<h4 id=\"Ptr\"><a class=\"header-anchor\" href=\"#Ptr\">¶</a>Ptr</h4>\n<ul>\n<li>地址</li>\n<li>递归比较</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> deepValueEqual(v1.Elem(), v2.Elem(), visited, depth+<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<h4 id=\"struct\"><a class=\"header-anchor\" href=\"#struct\">¶</a>struct</h4>\n<ul>\n<li>比较每一个元素</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">for</span> i, n := <span class=\"number\">0</span>, v1.NumField(); i &lt; n; i++ &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !deepValueEqual(v1.Field(i), v2.Field(i), visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Map\"><a class=\"header-anchor\" href=\"#Map\">¶</a>Map</h4>\n<ul>\n<li>比较Nil</li>\n<li>比较长度</li>\n<li>地址比较</li>\n<li>每一个key对应的value</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() != v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Len() != v2.Len() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> v1.Pointer() == v2.Pointer() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> _, k := <span class=\"keyword\">range</span> v1.MapKeys() &#123;</span><br><span class=\"line\">\tval1 := v1.MapIndex(k)</span><br><span class=\"line\">\tval2 := v2.MapIndex(k)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !val1.IsValid() || !val2.IsValid() || !deepValueEqual(val1, val2, visited, depth+<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"Func\"><a class=\"header-anchor\" href=\"#Func\">¶</a>Func</h4>\n<ul>\n<li>非nil，为不等。</li>\n</ul>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> v1.IsNil() &amp;&amp; v2.IsNil() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Can&#x27;t do better than this:</span></span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"painc注意点：\"><a class=\"header-anchor\" href=\"#painc注意点：\">¶</a>painc注意点：</h3>\n<p>deepValueEqual函数：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> .....</span><br><span class=\"line\"> ....</span><br><span class=\"line\"> ...</span><br><span class=\"line\"> ..</span><br><span class=\"line\"> .</span><br><span class=\"line\"> 递归次数超过<span class=\"number\">10</span>次则会painc....</span><br><span class=\"line\"> <span class=\"comment\">// if depth &gt; 10 &#123; panic(&quot;deepValueEqual&quot;) &#125;\t// for debugging</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// We want to avoid putting more in the visited map than we need to.</span></span><br><span class=\"line\"><span class=\"comment\">// For any possible reference cycle that might be encountered,</span></span><br><span class=\"line\"><span class=\"comment\">// hard(v1, v2) needs to return true for at least one of the types in the cycle,</span></span><br><span class=\"line\"><span class=\"comment\">// and it&#x27;s safe and valid to get Value&#x27;s internal pointer.</span></span><br><span class=\"line\">hard := <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(v1, v2 Value)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> v1.Kind() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">case</span> Map, Slice, Ptr, Interface:</span><br><span class=\"line\">\t\t<span class=\"comment\">// Nil pointers cannot be cyclic. Avoid putting them in the visited map.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> !v1.IsNil() &amp;&amp; !v2.IsNil()</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> .</span><br><span class=\"line\"> ..</span><br><span class=\"line\"> ...</span><br><span class=\"line\"> ....</span><br><span class=\"line\"> .....</span><br><span class=\"line\"> ......</span><br></pre></td></tr></table></figure>\n<h3 id=\"END\"><a class=\"header-anchor\" href=\"#END\">¶</a>END</h3>","popularPost_tmp_postPath":true,"eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200918-124746.png","popularPost_tmp_gaData":{"updated":"Sun Sep 20 2020 16:16:52 GMT+0800 (中国标准时间)","title":"「9」Go reflect ~ DeepEqual","path":"archives/e2e7cc4e.html","eyeCatchImage":"https://crab-1251738482.cos.accelerate.myqcloud.com/20200918-124746.png","excerpt":"<p>今天无意中看到Go101发了一个推特:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">  <span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;reflect&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">p</span><span class=\"params\">(a, b <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">  fmt.Print(<span class=\"string\">&quot;:&quot;</span>, reflect.DeepEqual(a, b))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  a := [<span class=\"number\">1</span>]<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;&#125;&#125;</span><br><span class=\"line\">  p(a, a)</span><br><span class=\"line\">  p(a[:], a[:])</span><br><span class=\"line\">  b := a</span><br><span class=\"line\">  p(a[:], b[:])</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>输出结果？？ :true:true:false</p>\n</blockquote>","date":{"_isAMomentObject":true,"_i":"2020-09-18T04:35:03.000Z","_isUTC":false,"_pf":{"empty":false,"unusedTokens":[],"unusedInput":[],"overflow":-2,"charsLeftOver":0,"nullInput":false,"invalidEra":null,"invalidMonth":null,"invalidFormat":false,"userInvalidated":false,"iso":false,"parsedDateParts":[],"era":null,"meridiem":null,"rfc2822":false,"weekdayMismatch":false},"_locale":{"_calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"_longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"_invalidDate":"Invalid date","_dayOfMonthOrdinalParse":{},"_relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"_months":["January","February","March","April","May","June","July","August","September","October","November","December"],"_monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"_week":{"dow":0,"doy":6},"_weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"_weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"_weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"_meridiemParse":{},"_eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"_abbr":"en","_config":{"calendar":{"sameDay":"[Today at] LT","nextDay":"[Tomorrow at] LT","nextWeek":"dddd [at] LT","lastDay":"[Yesterday at] LT","lastWeek":"[Last] dddd [at] LT","sameElse":"L"},"longDateFormat":{"LTS":"h:mm:ss A","LT":"h:mm A","L":"MM/DD/YYYY","LL":"MMMM D, YYYY","LLL":"MMMM D, YYYY h:mm A","LLLL":"dddd, MMMM D, YYYY h:mm A"},"invalidDate":"Invalid date","dayOfMonthOrdinalParse":{},"relativeTime":{"future":"in %s","past":"%s ago","s":"a few seconds","ss":"%d seconds","m":"a minute","mm":"%d minutes","h":"an hour","hh":"%d hours","d":"a day","dd":"%d days","w":"a week","ww":"%d weeks","M":"a month","MM":"%d months","y":"a year","yy":"%d years"},"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"week":{"dow":0,"doy":6},"weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"weekdaysMin":["Su","Mo","Tu","We","Th","Fr","Sa"],"weekdaysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"meridiemParse":{},"eras":[{"since":"0001-01-01","until":null,"offset":1,"name":"Anno Domini","narrow":"AD","abbr":"AD"},{"since":"0000-12-31","until":null,"offset":1,"name":"Before Christ","narrow":"BC","abbr":"BC"}],"abbr":"en"},"_dayOfMonthOrdinalParseLenient":{}},"_d":"2020-09-18T04:35:03.000Z","_isValid":true,"_z":null},"pv":0,"totalPV":0,"categories":"","tags":["Go","Go Package","Day","Go reflect"],"internalLinks":[],"keywords":[],"keywordsLength":0},"length":5557}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"ckktibdkn00013ci74oqodzky","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdky000g3ci78a7o0u65"},{"post_id":"ckktibdkn00013ci74oqodzky","tag_id":"ckktibdku00083ci71yz4ayr0","_id":"ckktibdkz000i3ci7ebqteowe"},{"post_id":"ckktibdkn00013ci74oqodzky","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdl0000l3ci7ee4xcq4b"},{"post_id":"ckktibdkq00033ci79ut67pu1","tag_id":"ckktibdkx000e3ci7b5c85x7f","_id":"ckktibdl2000p3ci7972fcj10"},{"post_id":"ckktibdkq00033ci79ut67pu1","tag_id":"ckktibdkz000j3ci7gmcga0kf","_id":"ckktibdl3000r3ci7deunas2q"},{"post_id":"ckktibdl4000u3ci74mgze9i8","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdl5000x3ci789qbbma1"},{"post_id":"ckktibdl4000u3ci74mgze9i8","tag_id":"ckktibdku00083ci71yz4ayr0","_id":"ckktibdl6000z3ci79pde0opt"},{"post_id":"ckktibdl4000u3ci74mgze9i8","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdl600113ci7bso10e57"},{"post_id":"ckktibdks00053ci791b855c1","tag_id":"ckktibdl2000o3ci7ds416p8w","_id":"ckktibdl900143ci79nl3aywa"},{"post_id":"ckktibdks00053ci791b855c1","tag_id":"ckktibdl3000t3ci715eg9kko","_id":"ckktibdl900163ci78ssfablq"},{"post_id":"ckktibdl4000v3ci7cgoncwk8","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdla00193ci74r8a0zrl"},{"post_id":"ckktibdl4000v3ci7cgoncwk8","tag_id":"ckktibdku00083ci71yz4ayr0","_id":"ckktibdlb001b3ci7fofxdtqy"},{"post_id":"ckktibdl4000v3ci7cgoncwk8","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdlc001e3ci7579772td"},{"post_id":"ckktibdl900153ci73ytm29z6","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdld001g3ci71zrxhzbm"},{"post_id":"ckktibdl900153ci73ytm29z6","tag_id":"ckktibdku00083ci71yz4ayr0","_id":"ckktibdle001j3ci795mydfzy"},{"post_id":"ckktibdl900153ci73ytm29z6","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdle001l3ci782291n96"},{"post_id":"ckktibdkt00063ci7b946d15u","tag_id":"ckktibdl5000w3ci7cjkfelhw","_id":"ckktibdlf001n3ci72t0c5trn"},{"post_id":"ckktibdkt00063ci7b946d15u","tag_id":"ckktibdl600123ci7dnq62sza","_id":"ckktibdlg001q3ci77772byxf"},{"post_id":"ckktibdla00173ci74iciaww8","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlh001s3ci7bxf0culf"},{"post_id":"ckktibdla00173ci74iciaww8","tag_id":"ckktibdku00083ci71yz4ayr0","_id":"ckktibdli001v3ci75ktzbjup"},{"post_id":"ckktibdla00173ci74iciaww8","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdlj001x3ci7e0h8h7tg"},{"post_id":"ckktibdlb001a3ci77aad8iwr","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlj00203ci7aa53agvu"},{"post_id":"ckktibdlb001a3ci77aad8iwr","tag_id":"ckktibdku00083ci71yz4ayr0","_id":"ckktibdlk00223ci7335p30y0"},{"post_id":"ckktibdlb001a3ci77aad8iwr","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdll00253ci79s52hlpe"},{"post_id":"ckktibdku00093ci75ww5hnol","tag_id":"ckktibdla00183ci79jmu6f9g","_id":"ckktibdlm00273ci76k9u7eb1"},{"post_id":"ckktibdlb001c3ci7hmct5nd8","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlm00293ci76l85gur8"},{"post_id":"ckktibdlb001c3ci7hmct5nd8","tag_id":"ckktibdku00083ci71yz4ayr0","_id":"ckktibdlo002c3ci734lmf6t2"},{"post_id":"ckktibdlb001c3ci7hmct5nd8","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdlp002e3ci75afnbl3z"},{"post_id":"ckktibdkv000a3ci7fflbd40n","tag_id":"ckktibdlc001d3ci75i5m4w67","_id":"ckktibdlq002g3ci7ease98sm"},{"post_id":"ckktibdkw000c3ci75hxnhpmb","tag_id":"ckktibdld001i3ci71zybb0ne","_id":"ckktibdlq002h3ci74q1f7fue"},{"post_id":"ckktibdlf001p3ci7fgrvfw76","tag_id":"ckktibdla00183ci79jmu6f9g","_id":"ckktibdlq002j3ci73pyv5e4w"},{"post_id":"ckktibdkw000d3ci7fnzthl8s","tag_id":"ckktibdlf001o3ci731ezajno","_id":"ckktibdlq002k3ci7bzu19149"},{"post_id":"ckktibdkw000d3ci7fnzthl8s","tag_id":"ckktibdlh001u3ci7fd733s9w","_id":"ckktibdlq002m3ci75vvp5ml7"},{"post_id":"ckktibdlk00213ci7hecm7yhx","tag_id":"ckktibdla00183ci79jmu6f9g","_id":"ckktibdlr002n3ci76o7s5zj6"},{"post_id":"ckktibdlk00233ci76ex7a0vq","tag_id":"ckktibdla00183ci79jmu6f9g","_id":"ckktibdlr002p3ci7gfxefel2"},{"post_id":"ckktibdll00263ci7c20cgqx6","tag_id":"ckktibdla00183ci79jmu6f9g","_id":"ckktibdlr002q3ci75i652vph"},{"post_id":"ckktibdkx000f3ci7fyz80nu9","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlr002r3ci7fied8qce"},{"post_id":"ckktibdkx000f3ci7fyz80nu9","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdlr002t3ci78z5habj8"},{"post_id":"ckktibdkx000f3ci7fyz80nu9","tag_id":"ckktibdlj001z3ci7dokbgr4v","_id":"ckktibdls002u3ci76agigg6v"},{"post_id":"ckktibdkx000f3ci7fyz80nu9","tag_id":"ckktibdll00243ci76j8if6b4","_id":"ckktibdls002w3ci74m1y7kh8"},{"post_id":"ckktibdlm00283ci7bxytekpb","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdls002x3ci7ewy082f3"},{"post_id":"ckktibdlm00283ci7bxytekpb","tag_id":"ckktibdlj001z3ci7dokbgr4v","_id":"ckktibdlt002z3ci7cmdb5auj"},{"post_id":"ckktibdln002b3ci78kci10gj","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlt00303ci7gmbq9ife"},{"post_id":"ckktibdln002b3ci78kci10gj","tag_id":"ckktibdkv000b3ci7aagy9mvr","_id":"ckktibdlt00323ci7cz2t7gxn"},{"post_id":"ckktibdln002b3ci78kci10gj","tag_id":"ckktibdlj001z3ci7dokbgr4v","_id":"ckktibdlt00333ci7foj8fbsn"},{"post_id":"ckktibdln002b3ci78kci10gj","tag_id":"ckktibdll00243ci76j8if6b4","_id":"ckktibdlt00353ci75q7v3yug"},{"post_id":"ckktibdkz000h3ci70lto3wbt","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlt00363ci73do07gpi"},{"post_id":"ckktibdkz000h3ci70lto3wbt","tag_id":"ckktibdlj001z3ci7dokbgr4v","_id":"ckktibdlu00383ci71f914omw"},{"post_id":"ckktibdkz000h3ci70lto3wbt","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdlu00393ci7gnp18awo"},{"post_id":"ckktibdl0000k3ci757rj7a98","tag_id":"ckktibdlq002i3ci7gc1igzpk","_id":"ckktibdlu003b3ci74ti5b2dm"},{"post_id":"ckktibdl0000k3ci757rj7a98","tag_id":"ckktibdlq002l3ci7gjf5cxjh","_id":"ckktibdlu003c3ci7c05k0ekc"},{"post_id":"ckktibdl0000m3ci73s2pevcf","tag_id":"ckktibdlr002o3ci70mndfxip","_id":"ckktibdlv003e3ci79fqf9grt"},{"post_id":"ckktibdl0000m3ci73s2pevcf","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlv003f3ci713t7c626"},{"post_id":"ckktibdl0000m3ci73s2pevcf","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdlv003g3ci78jj4ha84"},{"post_id":"ckktibdl1000n3ci723lta8g1","tag_id":"ckktibdlf001o3ci731ezajno","_id":"ckktibdlv003i3ci73xvzdbla"},{"post_id":"ckktibdl2000q3ci7h5sm6vix","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlv003j3ci77emwaysa"},{"post_id":"ckktibdl2000q3ci7h5sm6vix","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdlw003l3ci7am7009h5"},{"post_id":"ckktibdl3000s3ci73lazb334","tag_id":"ckktibdlt00313ci712z2etlf","_id":"ckktibdlw003m3ci76nhn8wc2"},{"post_id":"ckktibdl3000s3ci73lazb334","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdlw003o3ci712f5btrz"},{"post_id":"ckktibdl5000y3ci7abp25btb","tag_id":"ckktibdlu00373ci7fxhugky2","_id":"ckktibdlx003p3ci78eadfl1o"},{"post_id":"ckktibdl5000y3ci7abp25btb","tag_id":"ckktibdlu003a3ci71qwkbvod","_id":"ckktibdly003r3ci77dv6ed8u"},{"post_id":"ckktibdl600103ci777te9qwe","tag_id":"ckktibdlu003d3ci77jm7b5u2","_id":"ckktibdly003s3ci7a2uk7r7r"},{"post_id":"ckktibdl600103ci777te9qwe","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdly003u3ci7bey867d7"},{"post_id":"ckktibdl800133ci7elur5eaf","tag_id":"ckktibdlq002i3ci7gc1igzpk","_id":"ckktibdly003v3ci7affg1wlo"},{"post_id":"ckktibdl800133ci7elur5eaf","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdlz003x3ci74i5v51e2"},{"post_id":"ckktibdlc001f3ci7dud6hkwt","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdlz003y3ci76gw34bcm"},{"post_id":"ckktibdlc001f3ci7dud6hkwt","tag_id":"ckktibdlx003q3ci791m20tep","_id":"ckktibdlz00403ci7fuuk2h07"},{"post_id":"ckktibdlc001f3ci7dud6hkwt","tag_id":"ckktibdly003t3ci73svc7zxb","_id":"ckktibdlz00413ci7dpmwga7a"},{"post_id":"ckktibdld001h3ci74bzg5sx0","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdm000433ci75ul4f2z5"},{"post_id":"ckktibdld001h3ci74bzg5sx0","tag_id":"ckktibdly003w3ci7bjsg3wjm","_id":"ckktibdm000443ci73cfpb41v"},{"post_id":"ckktibdld001h3ci74bzg5sx0","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdm000463ci71otsc9zl"},{"post_id":"ckktibdle001k3ci7etvc0v8k","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdm100493ci7fdvm50ll"},{"post_id":"ckktibdle001k3ci7etvc0v8k","tag_id":"ckktibdlz00423ci76vod9ifv","_id":"ckktibdm1004a3ci719jj6hek"},{"post_id":"ckktibdle001k3ci7etvc0v8k","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdm1004c3ci78q70fn3y"},{"post_id":"ckktibdle001k3ci7etvc0v8k","tag_id":"ckktibdm000473ci78a3y3kpf","_id":"ckktibdm2004d3ci7246j2oks"},{"post_id":"ckktibdle001m3ci778hbgpdu","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdm2004g3ci78nlz0pqq"},{"post_id":"ckktibdle001m3ci778hbgpdu","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdm2004h3ci7b7w61dfx"},{"post_id":"ckktibdle001m3ci778hbgpdu","tag_id":"ckktibdm1004b3ci799tx2tuo","_id":"ckktibdm3004j3ci7b0unhd63"},{"post_id":"ckktibdle001m3ci778hbgpdu","tag_id":"ckktibdm2004e3ci7g7yhg72j","_id":"ckktibdm3004k3ci78b65awe0"},{"post_id":"ckktibdlg001r3ci7af6t2ddz","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdm4004o3ci77ubz6wec"},{"post_id":"ckktibdlg001r3ci7af6t2ddz","tag_id":"ckktibdm2004i3ci7c36p5w7m","_id":"ckktibdm4004p3ci784lm437u"},{"post_id":"ckktibdlg001r3ci7af6t2ddz","tag_id":"ckktibdm3004l3ci71jxpbisv","_id":"ckktibdm4004r3ci783ssfqwq"},{"post_id":"ckktibdlg001r3ci7af6t2ddz","tag_id":"ckktibdm3004m3ci7agw39pj8","_id":"ckktibdm4004s3ci7bmyqbd71"},{"post_id":"ckktibdlh001t3ci7a98608xl","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdm6004w3ci70co83lh6"},{"post_id":"ckktibdlh001t3ci7a98608xl","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdm6004x3ci7e97h4khz"},{"post_id":"ckktibdlh001t3ci7a98608xl","tag_id":"ckktibdm4004q3ci787aqfu2w","_id":"ckktibdm6004z3ci76vlz70kt"},{"post_id":"ckktibdlh001t3ci7a98608xl","tag_id":"ckktibdm5004t3ci70jax1s4s","_id":"ckktibdm600503ci70m5ofk6f"},{"post_id":"ckktibdlh001t3ci7a98608xl","tag_id":"ckktibdm5004u3ci7doj91gro","_id":"ckktibdm600523ci7hhwe47ax"},{"post_id":"ckktibdli001w3ci7fqlo8xh4","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdm700543ci7gy9w95jm"},{"post_id":"ckktibdli001w3ci7fqlo8xh4","tag_id":"ckktibdm5004v3ci7c4mp9vdf","_id":"ckktibdm700553ci7gwv4b6t9"},{"post_id":"ckktibdli001w3ci7fqlo8xh4","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdm800573ci78gf65axt"},{"post_id":"ckktibdli001w3ci7fqlo8xh4","tag_id":"ckktibdm600513ci7etc81ilh","_id":"ckktibdm800583ci78awq9j3z"},{"post_id":"ckktibdlj001y3ci70v8rgzl6","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdma005c3ci7c12z2ymw"},{"post_id":"ckktibdlj001y3ci70v8rgzl6","tag_id":"ckktibdm5004u3ci7doj91gro","_id":"ckktibdma005d3ci75pada3pu"},{"post_id":"ckktibdlj001y3ci70v8rgzl6","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdma005f3ci76qc23jz4"},{"post_id":"ckktibdlj001y3ci70v8rgzl6","tag_id":"ckktibdm5004t3ci70jax1s4s","_id":"ckktibdma005g3ci7a7ek6ebo"},{"post_id":"ckktibdlj001y3ci70v8rgzl6","tag_id":"ckktibdm9005a3ci779u50lmq","_id":"ckktibdmb005h3ci78grd5bqy"},{"post_id":"ckktibdlo002d3ci7fss9580e","tag_id":"ckktibdkr00043ci7hxj5etzg","_id":"ckktibdmb005i3ci7ey988pwl"},{"post_id":"ckktibdlo002d3ci7fss9580e","tag_id":"ckktibdm9005b3ci77fjp88qj","_id":"ckktibdmb005j3ci7cw0gbdmz"},{"post_id":"ckktibdlo002d3ci7fss9580e","tag_id":"ckktibdlj001z3ci7dokbgr4v","_id":"ckktibdmb005k3ci74f559d99"},{"post_id":"ckktibdlo002d3ci7fss9580e","tag_id":"ckktibdlp002f3ci73j5kgy9t","_id":"ckktibdmb005l3ci7d0ut9oja"}],"Tag":[{"name":"Go","_id":"ckktibdkr00043ci7hxj5etzg"},{"name":"GPM","_id":"ckktibdku00083ci71yz4ayr0"},{"name":"Go源码","_id":"ckktibdkv000b3ci7aagy9mvr"},{"name":"RabbitMQ","_id":"ckktibdkx000e3ci7b5c85x7f"},{"name":"消息中间件","_id":"ckktibdkz000j3ci7gmcga0kf"},{"name":"N个问题","_id":"ckktibdl2000o3ci7ds416p8w"},{"name":"正态规划","_id":"ckktibdl3000t3ci715eg9kko"},{"name":"TLS","_id":"ckktibdl5000w3ci7cjkfelhw"},{"name":"HTTPS","_id":"ckktibdl600123ci7dnq62sza"},{"name":"Git","_id":"ckktibdla00183ci79jmu6f9g"},{"name":"Todo","_id":"ckktibdlc001d3ci75i5m4w67"},{"name":"life","_id":"ckktibdld001i3ci71zybb0ne"},{"name":"hexo","_id":"ckktibdlf001o3ci731ezajno"},{"name":"hexo插件","_id":"ckktibdlh001u3ci7fd733s9w"},{"name":"Go Package","_id":"ckktibdlj001z3ci7dokbgr4v"},{"name":"锁","_id":"ckktibdll00243ci76j8if6b4"},{"name":"Day","_id":"ckktibdlp002f3ci73j5kgy9t"},{"name":"Linux","_id":"ckktibdlq002i3ci7gc1igzpk"},{"name":"进程","_id":"ckktibdlq002l3ci7gjf5cxjh"},{"name":"Plan9","_id":"ckktibdlr002o3ci70mndfxip"},{"name":"chrome","_id":"ckktibdlt00313ci712z2etlf"},{"name":"vscode","_id":"ckktibdlu00373ci7fxhugky2"},{"name":"工具","_id":"ckktibdlu003a3ci71qwkbvod"},{"name":"博客","_id":"ckktibdlu003d3ci77jm7b5u2"},{"name":"v1.16","_id":"ckktibdlx003q3ci791m20tep"},{"name":"encoding/json","_id":"ckktibdly003t3ci73svc7zxb"},{"name":"time","_id":"ckktibdly003w3ci7bjsg3wjm"},{"name":"sync","_id":"ckktibdlz00423ci76vod9ifv"},{"name":"Mutex","_id":"ckktibdm000473ci78a3y3kpf"},{"name":"Map","_id":"ckktibdm1004b3ci799tx2tuo"},{"name":"Hash","_id":"ckktibdm2004e3ci7g7yhg72j"},{"name":"Redis","_id":"ckktibdm2004i3ci7c36p5w7m"},{"name":"RDB","_id":"ckktibdm3004l3ci71jxpbisv"},{"name":"源码","_id":"ckktibdm3004m3ci7agw39pj8"},{"name":"Golang","_id":"ckktibdm4004q3ci787aqfu2w"},{"name":"Float","_id":"ckktibdm5004t3ci70jax1s4s"},{"name":"IEEE","_id":"ckktibdm5004u3ci7doj91gro"},{"name":"ticker","_id":"ckktibdm5004v3ci7c4mp9vdf"},{"name":"defer","_id":"ckktibdm600513ci7etc81ilh"},{"name":"位运算","_id":"ckktibdm9005a3ci779u50lmq"},{"name":"Go reflect","_id":"ckktibdm9005b3ci77fjp88qj"}]}}